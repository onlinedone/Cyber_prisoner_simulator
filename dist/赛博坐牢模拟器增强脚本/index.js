var e={439(){const e={updateInterval:500,animationDuration:300,trendWindow:5,slowChangeThreshold:1,regressionRate:.005,healthBaseline:70,mentalBaseline:65,parseRetryAttempts:3,parseRetryDelay:100,debugMode:!0},t={up:'â†‘',down:'â†“',stable:'â—'};let n={name:'',age:0,crime:'',health:75,mental:70,strength:65,intelligence:70,appearance:{height:0,weight:0,hair:'',condition:''},clothing:{top:'',bottom:'',underwear:'',underpants:'',socks:'',shoes:'',restraints:'æ— ',cleanliness:'æ•´æ´'},currentTask:'',currentThought:'',biggestWorry:'',days:0,stage:'åˆ‘äº‹æ‹˜ç•™',cellType:'è¿‡æ¸¡ç›‘å®¤',changes:{health:[],mental:[],strength:[],intelligence:[]},accumulated:{health:0,mental:0,strength:0,intelligence:0},lastUpdate:Date.now(),stats:{totalUpdates:0,successfulParses:0,failedParses:0,lastParseTime:0}},a=!1,s=null,i=null;function o(...t){e.debugMode&&console.log('[çŠ¶æ€æ ]',...t)}function r(e){const t=Math.floor(e/1e3),n=Math.floor(t/60),a=Math.floor(n/60),s=Math.floor(a/24);return s>0?`${s}å¤©${a%24}å°æ—¶`:a>0?`${a}å°æ—¶${n%60}åˆ†é’Ÿ`:n>0?`${n}åˆ†é’Ÿ${t%60}ç§’`:`${t}ç§’`}function l(t,a){n.changes[t]||(n.changes[t]=[]),n.changes[t].push({value:a,timestamp:Date.now()}),n.changes[t].length>e.trendWindow&&n.changes[t].shift(),o(`è®°å½•å˜åŒ–: ${t} ${a>0?'+':''}${a}`)}function c(e){if(!n.changes[e]||0===n.changes[e].length)return'stable';const t=n.changes[e].reduce((e,t)=>e+t.value,0);return t>2?'up':t<-2?'down':'stable'}function d(t){if(a)console.warn('[çŠ¶æ€æ ] æ£€æµ‹åˆ°å¹¶å‘æ›´æ–°ï¼Œå·²å¿½ç•¥');else{a=!0;try{if(o('å¼€å§‹æ›´æ–°çŠ¶æ€:',t),n.stats.totalUpdates++,void 0!==t.name&&(n.name=t.name),void 0!==t.age&&(n.age=t.age),void 0!==t.crime&&(n.crime=t.crime),void 0!==t.health){const a=t.health-n.health;if(Math.abs(a)>=e.slowChangeThreshold)n.health=t.health,l('health',a),o(`å¥åº·ç›´æ¥æ›´æ–°: ${n.health} (å˜åŒ–: ${a})`);else if(n.accumulated.health+=a,o(`å¥åº·ç´¯ç§¯å˜åŒ–: ${n.accumulated.health}`),Math.abs(n.accumulated.health)>=e.slowChangeThreshold){const e=Math.floor(n.accumulated.health);n.health+=e,n.accumulated.health-=e,l('health',e),o(`å¥åº·ç´¯ç§¯è§¦å‘: ${n.health} (å˜åŒ–: ${e})`)}}if(void 0!==t.mental){const a=t.mental-n.mental;if(Math.abs(a)>=e.slowChangeThreshold)n.mental=t.mental,l('mental',a),o(`ç²¾ç¥ç›´æ¥æ›´æ–°: ${n.mental} (å˜åŒ–: ${a})`);else if(n.accumulated.mental+=a,o(`ç²¾ç¥ç´¯ç§¯å˜åŒ–: ${n.accumulated.mental}`),Math.abs(n.accumulated.mental)>=e.slowChangeThreshold){const e=Math.floor(n.accumulated.mental);n.mental+=e,n.accumulated.mental-=e,l('mental',e),o(`ç²¾ç¥ç´¯ç§¯è§¦å‘: ${n.mental} (å˜åŒ–: ${e})`)}}if(void 0!==t.strength){const a=t.strength-n.strength;if(Math.abs(a)>=e.slowChangeThreshold)n.strength=t.strength,l('strength',a),o(`åŠ›é‡ç›´æ¥æ›´æ–°: ${n.strength} (å˜åŒ–: ${a})`);else if(n.accumulated.strength+=a,o(`åŠ›é‡ç´¯ç§¯å˜åŒ–: ${n.accumulated.strength}`),Math.abs(n.accumulated.strength)>=e.slowChangeThreshold){const e=Math.floor(n.accumulated.strength);n.strength+=e,n.accumulated.strength-=e,l('strength',e),o(`åŠ›é‡ç´¯ç§¯è§¦å‘: ${n.strength} (å˜åŒ–: ${e})`)}}if(void 0!==t.intelligence){const a=t.intelligence-n.intelligence;if(Math.abs(a)>=e.slowChangeThreshold)n.intelligence=t.intelligence,l('intelligence',a),o(`æ™ºåŠ›ç›´æ¥æ›´æ–°: ${n.intelligence} (å˜åŒ–: ${a})`);else if(n.accumulated.intelligence+=a,o(`æ™ºåŠ›ç´¯ç§¯å˜åŒ–: ${n.accumulated.intelligence}`),Math.abs(n.accumulated.intelligence)>=e.slowChangeThreshold){const e=Math.floor(n.accumulated.intelligence);n.intelligence+=e,n.accumulated.intelligence-=e,l('intelligence',e),o(`æ™ºåŠ›ç´¯ç§¯è§¦å‘: ${n.intelligence} (å˜åŒ–: ${e})`)}}t.appearance&&(void 0!==t.appearance.height&&(n.appearance.height=t.appearance.height),void 0!==t.appearance.weight&&(n.appearance.weight=t.appearance.weight),void 0!==t.appearance.hair&&(n.appearance.hair=t.appearance.hair),void 0!==t.appearance.condition&&(n.appearance.condition=t.appearance.condition)),t.clothing&&(void 0!==t.clothing.top&&(n.clothing.top=t.clothing.top),void 0!==t.clothing.bottom&&(n.clothing.bottom=t.clothing.bottom),void 0!==t.clothing.underwear&&(n.clothing.underwear=t.clothing.underwear),void 0!==t.clothing.underpants&&(n.clothing.underpants=t.clothing.underpants),void 0!==t.clothing.socks&&(n.clothing.socks=t.clothing.socks),void 0!==t.clothing.shoes&&(n.clothing.shoes=t.clothing.shoes),void 0!==t.clothing.restraints&&(n.clothing.restraints=t.clothing.restraints),void 0!==t.clothing.cleanliness&&(n.clothing.cleanliness=t.clothing.cleanliness)),void 0!==t.currentTask&&(n.currentTask=t.currentTask),void 0!==t.currentThought&&(n.currentThought=t.currentThought),void 0!==t.biggestWorry&&(n.biggestWorry=t.biggestWorry),void 0!==t.days&&(n.days=t.days),void 0!==t.stage&&(n.stage=t.stage),void 0!==t.cellType&&(n.cellType=t.cellType),n.lastUpdate=Date.now(),o('çŠ¶æ€æ›´æ–°å®Œæˆ'),y()}catch(e){console.error('[çŠ¶æ€æ ] æ›´æ–°çŠ¶æ€å¤±è´¥:',e)}finally{a=!1}}}function h(e){if(e&&e.nodeType===Node.COMMENT_NODE)try{let t=e.nodeValue||e.textContent||'';if(t=t.trim(),!t)return;if(o('æ£€æµ‹åˆ°æ³¨é‡ŠèŠ‚ç‚¹:',t.substring(0,100)+(t.length>100?'...':'')),t.startsWith('STATUS_UPDATE:')){const e=t.substring(14).trim();o('æå–JSONå­—ç¬¦ä¸²:',e.substring(0,100)+(e.length>100?'...':'')),g(e)}}catch(e){console.error('[çŠ¶æ€æ ] è§£ææ³¨é‡ŠèŠ‚ç‚¹å¤±è´¥:',e)}}function g(t,a=1){try{t=(t=(t=t.trim()).replace(/,(\s*[}\]])/g,'$1')).replace(/[\n\r\t]/g,''),o(`å°è¯•è§£æJSON (ç¬¬${a}æ¬¡):`,t.substring(0,200)+(t.length>200?'...':''));const e=JSON.parse(t);console.log('[çŠ¶æ€æ ] âœ… æˆåŠŸè§£æçŠ¶æ€æ›´æ–°:',e),n.stats.successfulParses++,n.stats.lastParseTime=Date.now(),d(e);const s=window.detentionSystem;return s&&s.events&&s.events.emit('statusUpdated',e),!0}catch(s){const i=s instanceof Error?s.message:String(s);if(console.error(`[çŠ¶æ€æ ] âŒ è§£æå¤±è´¥ (å°è¯• ${a}/${e.parseRetryAttempts}):`,i),console.error('[çŠ¶æ€æ ] åŸå§‹JSON:',t),n.stats.failedParses++,a<e.parseRetryAttempts)return console.log(`[çŠ¶æ€æ ] å°†åœ¨ ${e.parseRetryDelay}ms åé‡è¯•...`),setTimeout(()=>{g(t,a+1)},e.parseRetryDelay),!1;{console.error('[çŠ¶æ€æ ] âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒè§£æ');const e=window.detentionSystem;return e&&e.events&&e.events.emit('parseError',{jsonStr:t,error:i,attempts:a}),!1}}}function u(e){if(e&&e.nodeType===Node.ELEMENT_NODE)try{const t=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT,null,!1);let n,a=0;for(;n=t.nextNode();)a++,h(n);a>0&&o(`TreeWalker æ‰«æå®Œæˆï¼Œæ‰¾åˆ° ${a} ä¸ªæ³¨é‡ŠèŠ‚ç‚¹`)}catch(e){console.error('[çŠ¶æ€æ ] TreeWalker æ‰«æå¤±è´¥:',e)}}function p(e,t){const n=document.getElementById(e);n&&n.textContent!==t&&(n.textContent=t,n.classList.remove('updated'),setTimeout(()=>{n.classList.add('updated')},10),setTimeout(()=>{n.classList.remove('updated')},500))}function m(e,n){n=Math.max(0,Math.min(100,n));const a=document.getElementById(`${e}-value`);a&&(a.textContent=Math.round(n).toString());const s=document.getElementById(`${e}-bar`);if(s){s.style.width=`${n}%`;const e=s.closest('.stat-bar');e&&(e.classList.remove('changed'),setTimeout(()=>{e.classList.add('changed')},10),setTimeout(()=>{e.classList.remove('changed')},500))}const i=c(e),o=document.getElementById(`${e}-trend`);o&&(o.textContent=t[i],o.style.color='up'===i?'#43e97b':'down'===i?'#f5576c':'#999')}function y(){try{p('status-name',n.name||'æœªè®¾å®š'),p('status-age',n.age?`${n.age}å²`:'æœªè®¾å®š'),p('status-crime',n.crime||'æœªè®¾å®š'),p('status-days',`${n.days}å¤©`),p('status-stage',n.stage),p('status-cell',n.cellType),m('health',n.health),m('mental',n.mental),m('strength',n.strength),m('intelligence',n.intelligence),p('status-height',n.appearance.height?`${n.appearance.height}cm`:'æœªè®¾å®š'),p('status-weight',n.appearance.weight?`${n.appearance.weight}kg`:'æœªè®¾å®š'),p('status-hair',n.appearance.hair||'æœªè®¾å®š'),p('status-condition',n.appearance.condition||'æœªè®¾å®š'),p('status-top',n.clothing.top||'æœªè®¾å®š'),p('status-bottom',n.clothing.bottom||'æœªè®¾å®š'),p('status-underwear',n.clothing.underwear||'æœªè®¾å®š'),p('status-underpants',n.clothing.underpants||'æœªè®¾å®š'),p('status-socks',n.clothing.socks||'æœªè®¾å®š'),p('status-shoes',n.clothing.shoes||'æœªè®¾å®š'),p('status-restraints',n.clothing.restraints||'æ— '),p('status-cleanliness',n.clothing.cleanliness||'æ•´æ´'),p('status-task',n.currentTask||'æ— '),p('status-thought',n.currentThought||'æ— '),p('status-worry',n.biggestWorry||'æ— ')}catch(e){console.error('[çŠ¶æ€æ ] æ›´æ–°æ˜¾ç¤ºå¤±è´¥:',e)}}function f(){if(document.getElementById('detention-status-panel'))return void console.log('[çŠ¶æ€æ ] çŠ¶æ€æ å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');const e=document.createElement('div');e.id='detention-status-panel',e.innerHTML='\n    <div class="status-header">\n      <h3>ğŸ“‹ åœ¨æŠ¼äººå‘˜çŠ¶æ€</h3>\n      <div class="status-header-buttons">\n        <button class="status-debug-btn" title="è°ƒè¯•ä¿¡æ¯">ğŸ”§</button>\n        <button class="status-toggle" title="æŠ˜å /å±•å¼€">âˆ’</button>\n      </div>\n    </div>\n    <div class="status-content">\n      <div class="status-section basic-info">\n        <h4>åŸºæœ¬ä¿¡æ¯</h4>\n        <div class="status-item">\n          <span class="label">å§“å:</span>\n          <span class="value" id="status-name">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">å¹´é¾„:</span>\n          <span class="value" id="status-age">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">ç½ªå:</span>\n          <span class="value" id="status-crime">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">åœ¨æŠ¼å¤©æ•°:</span>\n          <span class="value" id="status-days">0å¤©</span>\n        </div>\n        <div class="status-item">\n          <span class="label">å½“å‰é˜¶æ®µ:</span>\n          <span class="value" id="status-stage">åˆ‘äº‹æ‹˜ç•™</span>\n        </div>\n        <div class="status-item">\n          <span class="label">ç›‘å®¤ç±»å‹:</span>\n          <span class="value" id="status-cell">è¿‡æ¸¡ç›‘å®¤</span>\n        </div>\n      </div>\n\n      <div class="status-section core-stats">\n        <h4>æ ¸å¿ƒçŠ¶æ€</h4>\n        <div class="stat-bar">\n          <div class="stat-label">\n            <span>å¥åº·</span>\n            <span class="stat-value" id="health-value">75</span>\n            <span class="stat-trend" id="health-trend">â—</span>\n          </div>\n          <div class="stat-progress">\n            <div class="stat-fill health" id="health-bar" style="width: 75%"></div>\n          </div>\n        </div>\n        <div class="stat-bar">\n          <div class="stat-label">\n            <span>ç²¾ç¥</span>\n            <span class="stat-value" id="mental-value">70</span>\n            <span class="stat-trend" id="mental-trend">â—</span>\n          </div>\n          <div class="stat-progress">\n            <div class="stat-fill mental" id="mental-bar" style="width: 70%"></div>\n          </div>\n        </div>\n        <div class="stat-bar">\n          <div class="stat-label">\n            <span>åŠ›é‡</span>\n            <span class="stat-value" id="strength-value">65</span>\n            <span class="stat-trend" id="strength-trend">â—</span>\n          </div>\n          <div class="stat-progress">\n            <div class="stat-fill strength" id="strength-bar" style="width: 65%"></div>\n          </div>\n        </div>\n        <div class="stat-bar">\n          <div class="stat-label">\n            <span>æ™ºåŠ›</span>\n            <span class="stat-value" id="intelligence-value">70</span>\n            <span class="stat-trend" id="intelligence-trend">â—</span>\n          </div>\n          <div class="stat-progress">\n            <div class="stat-fill intelligence" id="intelligence-bar" style="width: 70%"></div>\n          </div>\n        </div>\n      </div>\n\n      <div class="status-section appearance-info">\n        <h4>å¤–è²Œä¿¡æ¯</h4>\n        <div class="status-item">\n          <span class="label">èº«é«˜:</span>\n          <span class="value" id="status-height">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">ä½“é‡:</span>\n          <span class="value" id="status-weight">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">å‘å‹:</span>\n          <span class="value" id="status-hair">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item full-width">\n          <span class="label">èº«ä½“çŠ¶å†µ:</span>\n          <span class="value" id="status-condition">æœªè®¾å®š</span>\n        </div>\n      </div>\n\n      <div class="status-section clothing-info">\n        <h4>ç©¿ç€ä¿¡æ¯</h4>\n        <div class="status-item">\n          <span class="label">ä¸Šè¡£:</span>\n          <span class="value" id="status-top">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">è£¤å­:</span>\n          <span class="value" id="status-bottom">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">å†…è¡£:</span>\n          <span class="value" id="status-underwear">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">å†…è£¤:</span>\n          <span class="value" id="status-underpants">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">è¢œå­:</span>\n          <span class="value" id="status-socks">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">é‹å­:</span>\n          <span class="value" id="status-shoes">æœªè®¾å®š</span>\n        </div>\n        <div class="status-item">\n          <span class="label">æˆ’å…·:</span>\n          <span class="value" id="status-restraints">æ— </span>\n        </div>\n        <div class="status-item">\n          <span class="label">æ´å‡€åº¦:</span>\n          <span class="value" id="status-cleanliness">æ•´æ´</span>\n        </div>\n      </div>\n\n      <div class="status-section psychological-info">\n        <h4>å¿ƒç†çŠ¶æ€</h4>\n        <div class="status-item full-width">\n          <span class="label">å½“å‰ä»»åŠ¡:</span>\n          <span class="value" id="status-task">æ— </span>\n        </div>\n        <div class="status-item full-width">\n          <span class="label">å†…å¿ƒæƒ³æ³•:</span>\n          <span class="value" id="status-thought">æ— </span>\n        </div>\n        <div class="status-item full-width">\n          <span class="label">æœ€å¤§æ‹…å¿§:</span>\n          <span class="value" id="status-worry">æ— </span>\n        </div>\n      </div>\n\n      <div class="status-section debug-info" style="display: none;">\n        <h4>è°ƒè¯•ä¿¡æ¯</h4>\n        <div class="status-item">\n          <span class="label">æ€»æ›´æ–°æ¬¡æ•°:</span>\n          <span class="value" id="debug-total-updates">0</span>\n        </div>\n        <div class="status-item">\n          <span class="label">æˆåŠŸè§£æ:</span>\n          <span class="value" id="debug-success-parses">0</span>\n        </div>\n        <div class="status-item">\n          <span class="label">å¤±è´¥è§£æ:</span>\n          <span class="value" id="debug-failed-parses">0</span>\n        </div>\n        <div class="status-item">\n          <span class="label">æœ€åæ›´æ–°:</span>\n          <span class="value" id="debug-last-update">ä»æœª</span>\n        </div>\n        <div class="status-item">\n          <span class="label">è§‚å¯Ÿå™¨çŠ¶æ€:</span>\n          <span class="value" id="debug-observer-status">æœªçŸ¥</span>\n        </div>\n        <div class="debug-buttons">\n          <button class="debug-btn" onclick="window.detentionSystem?.statusPanel?.debug?.scanAllComments()">æ‰«ææ³¨é‡Š</button>\n          <button class="debug-btn" onclick="console.log(window.detentionSystem?.statusPanel?.debug?.getDiagnostics())">è¯Šæ–­ä¿¡æ¯</button>\n          <button class="debug-btn" onclick="window.detentionSystem?.statusPanel?.reset()">é‡ç½®çŠ¶æ€</button>\n        </div>\n      </div>\n    </div>\n  ',function(){if(document.getElementById('detention-status-styles'))return;const e=document.createElement('style');e.id='detention-status-styles',e.textContent='\n    #detention-status-panel {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      width: 320px;\n      max-height: 90vh;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n      z-index: 10000;\n      font-family: \'Microsoft YaHei\', \'SimHei\', sans-serif;\n      overflow: hidden;\n      backdrop-filter: blur(10px);\n    }\n\n    .status-header {\n      background: rgba(0, 0, 0, 0.2);\n      padding: 12px 16px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n    }\n\n    .status-header h3 {\n      margin: 0;\n      color: #fff;\n      font-size: 16px;\n      font-weight: 600;\n    }\n\n    .status-header-buttons {\n      display: flex;\n      gap: 8px;\n    }\n\n    .status-toggle, .status-debug-btn {\n      background: rgba(255, 255, 255, 0.2);\n      border: none;\n      color: #fff;\n      width: 28px;\n      height: 28px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 16px;\n      line-height: 1;\n      transition: all 0.3s;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .status-toggle:hover, .status-debug-btn:hover {\n      background: rgba(255, 255, 255, 0.3);\n      transform: scale(1.1);\n    }\n\n    .status-content {\n      max-height: calc(90vh - 60px);\n      overflow-y: auto;\n      padding: 16px;\n    }\n\n    .status-content::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    .status-content::-webkit-scrollbar-track {\n      background: rgba(0, 0, 0, 0.1);\n      border-radius: 3px;\n    }\n\n    .status-content::-webkit-scrollbar-thumb {\n      background: rgba(255, 255, 255, 0.3);\n      border-radius: 3px;\n    }\n\n    .status-content::-webkit-scrollbar-thumb:hover {\n      background: rgba(255, 255, 255, 0.5);\n    }\n\n    .status-section {\n      background: rgba(255, 255, 255, 0.95);\n      border-radius: 8px;\n      padding: 12px;\n      margin-bottom: 12px;\n    }\n\n    .status-section:last-child {\n      margin-bottom: 0;\n    }\n\n    .status-section h4 {\n      margin: 0 0 10px 0;\n      color: #667eea;\n      font-size: 14px;\n      font-weight: 600;\n      border-bottom: 2px solid #667eea;\n      padding-bottom: 6px;\n    }\n\n    .status-item {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 6px 0;\n      border-bottom: 1px solid rgba(0, 0, 0, 0.05);\n    }\n\n    .status-item:last-child {\n      border-bottom: none;\n    }\n\n    .status-item.full-width {\n      flex-direction: column;\n      align-items: flex-start;\n    }\n\n    .status-item.full-width .value {\n      width: 100%;\n      margin-top: 4px;\n      padding: 6px;\n      background: rgba(102, 126, 234, 0.1);\n      border-radius: 4px;\n    }\n\n    .status-item .label {\n      color: #666;\n      font-size: 13px;\n      font-weight: 500;\n    }\n\n    .status-item .value {\n      color: #333;\n      font-size: 13px;\n      font-weight: 600;\n      text-align: right;\n    }\n\n    .stat-bar {\n      margin-bottom: 12px;\n    }\n\n    .stat-bar:last-child {\n      margin-bottom: 0;\n    }\n\n    .stat-label {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 6px;\n      font-size: 13px;\n      font-weight: 600;\n      color: #333;\n    }\n\n    .stat-value {\n      color: #667eea;\n      font-size: 14px;\n    }\n\n    .stat-trend {\n      font-size: 16px;\n      margin-left: 4px;\n    }\n\n    .stat-progress {\n      height: 8px;\n      background: rgba(0, 0, 0, 0.1);\n      border-radius: 4px;\n      overflow: hidden;\n    }\n\n    .stat-fill {\n      height: 100%;\n      transition: width 0.3s ease, background-color 0.3s ease;\n      border-radius: 4px;\n    }\n\n    .stat-fill.health {\n      background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);\n    }\n\n    .stat-fill.mental {\n      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);\n    }\n\n    .stat-fill.strength {\n      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);\n    }\n\n    .stat-fill.intelligence {\n      background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);\n    }\n\n    .debug-buttons {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n      margin-top: 12px;\n    }\n\n    .debug-btn {\n      background: #667eea;\n      color: white;\n      border: none;\n      padding: 8px 12px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 12px;\n      font-weight: 600;\n      transition: all 0.3s;\n    }\n\n    .debug-btn:hover {\n      background: #764ba2;\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n    }\n\n    @keyframes pulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.05); }\n    }\n\n    .stat-bar.changed {\n      animation: pulse 0.5s ease;\n    }\n\n    @keyframes fadeIn {\n      from { opacity: 0; transform: translateY(-10px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n\n    .status-item.updated {\n      animation: fadeIn 0.3s ease;\n    }\n\n    @media (max-width: 768px) {\n      #detention-status-panel {\n        width: 280px;\n        top: 10px;\n        right: 10px;\n      }\n    }\n  ',document.head.appendChild(e)}(),document.body.appendChild(e);const t=e.querySelector('.status-toggle'),a=e.querySelector('.status-content');t&&a&&t.addEventListener('click',()=>{const e='none'===a.style.display;a.style.display=e?'block':'none',t.textContent=e?'âˆ’':'+'});const i=e.querySelector('.status-debug-btn'),o=e.querySelector('.debug-info');i&&o&&i.addEventListener('click',()=>{const e='none'===o.style.display;o.style.display=e?'block':'none',function(){p('debug-total-updates',n.stats.totalUpdates.toString()),p('debug-success-parses',n.stats.successfulParses.toString()),p('debug-failed-parses',n.stats.failedParses.toString());p('debug-last-update',n.stats.lastParseTime>0?new Date(n.stats.lastParseTime).toLocaleTimeString('zh-CN'):'ä»æœª');p('debug-observer-status',s?'è¿è¡Œä¸­':'å·²åœæ­¢')}()}),console.log('[çŠ¶æ€æ ] UIåˆ›å»ºå®Œæˆ')}function b(){s&&(s.disconnect(),s=null,console.log('[çŠ¶æ€æ ] HTMLæ³¨é‡Šç›‘å¬å·²åœæ­¢'))}function v(){i&&clearInterval(i),i=setInterval(()=>{y(),function(){const t=(e.healthBaseline-n.health)*e.regressionRate;if(Math.abs(t)>.01&&(n.accumulated.health+=t,Math.abs(n.accumulated.health)>=e.slowChangeThreshold)){const e=Math.floor(n.accumulated.health);n.health+=e,n.accumulated.health-=e,l('health',e),o(`å¥åº·å›å½’: ${e}`)}const a=(e.mentalBaseline-n.mental)*e.regressionRate;if(Math.abs(a)>.01&&(n.accumulated.mental+=a,Math.abs(n.accumulated.mental)>=e.slowChangeThreshold)){const e=Math.floor(n.accumulated.mental);n.mental+=e,n.accumulated.mental-=e,l('mental',e),o(`ç²¾ç¥å›å½’: ${e}`)}}()},e.updateInterval),o('æ›´æ–°å¾ªç¯å·²å¯åŠ¨')}function w(){i&&(clearInterval(i),i=null,o('æ›´æ–°å¾ªç¯å·²åœæ­¢'))}const M={version:'3.5.2',state:n,initialize(){console.log('[çŠ¶æ€æ ] åˆå§‹åŒ–çŠ¶æ€æ ç³»ç»Ÿ v3.5.2'),f(),v(),s&&s.disconnect(),console.log('[çŠ¶æ€æ ] å¯åŠ¨HTMLæ³¨é‡Šç›‘å¬...'),s=new MutationObserver(e=>{for(const t of e){if('childList'===t.type)for(const e of t.addedNodes)e.nodeType===Node.COMMENT_NODE?h(e):e.nodeType===Node.ELEMENT_NODE&&u(e);'characterData'===t.type&&t.target.nodeType===Node.COMMENT_NODE&&h(t.target)}}),s.observe(document.body,{childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!1}),console.log('[çŠ¶æ€æ ] æ‰§è¡Œåˆå§‹æ‰«æ...'),setTimeout(()=>{u(document.body)},1e3),console.log('[çŠ¶æ€æ ] HTMLæ³¨é‡Šç›‘å¬å·²å¯åŠ¨');const t=window.detentionSystem;t&&t.events&&(t.events.on('stateChanged',e=>{o('çŠ¶æ€å˜åŒ–äº‹ä»¶:',e),e&&'object'==typeof e&&d(e)}),t.events.on('dayAdvanced',e=>{if(o('æ—¥æœŸæ¨è¿›äº‹ä»¶:',e),e&&'object'==typeof e){const t=e;void 0!==t.days&&(n.days=t.days),void 0!==t.stage&&(n.stage=t.stage),void 0!==t.cellType&&(n.cellType=t.cellType),y()}})),console.log('[çŠ¶æ€æ ] åˆå§‹åŒ–å®Œæˆ'),console.log('[çŠ¶æ€æ ] è°ƒè¯•æ¨¡å¼:',e.debugMode?'å¼€å¯':'å…³é—­')},destroy(){console.log('[çŠ¶æ€æ ] å¼€å§‹é”€æ¯...'),b(),w();const e=document.getElementById('detention-status-panel');e&&(e.remove(),console.log('[çŠ¶æ€æ ] UIå·²ç§»é™¤'));const t=document.getElementById('detention-status-styles');t&&(t.remove(),console.log('[çŠ¶æ€æ ] æ ·å¼å·²ç§»é™¤'));const n=window.detentionSystem;n&&n.events&&(n.events.off('stateChanged',()=>{}),n.events.off('dayAdvanced',()=>{})),console.log('[çŠ¶æ€æ ] é”€æ¯å®Œæˆ')},getState:()=>({name:n.name,age:n.age,crime:n.crime,health:n.health,mental:n.mental,strength:n.strength,intelligence:n.intelligence,appearance:{...n.appearance},clothing:{...n.clothing},currentTask:n.currentTask,currentThought:n.currentThought,biggestWorry:n.biggestWorry,days:n.days,stage:n.stage,cellType:n.cellType}),modifyValue(e,t,a=''){if(void 0===n[e])return void console.error(`[çŠ¶æ€æ ] æœªçŸ¥çš„çŠ¶æ€é”®: ${e}`);const s=n[e],i=Math.max(0,Math.min(100,s+t));if(i!==s){n[e]=i,l(e,t),console.log(`[çŠ¶æ€æ ] ${e} å˜åŒ–: ${s} â†’ ${i} (${t>0?'+':''}${t}) ${a?`åŸå› : ${a}`:''}`);const o=window.detentionSystem;o&&o.events&&o.events.emit('valueChanged',{key:e,oldValue:s,newValue:i,delta:t,reason:a}),y()}},getTrendAnalysis:()=>({health:{value:n.health,trend:c('health'),changes:n.changes.health||[]},mental:{value:n.mental,trend:c('mental'),changes:n.changes.mental||[]},strength:{value:n.strength,trend:c('strength'),changes:n.changes.strength||[]},intelligence:{value:n.intelligence,trend:c('intelligence'),changes:n.changes.intelligence||[]}}),getCurrentStage:()=>({days:n.days,stage:n.stage,cellType:n.cellType}),parseStatusUpdate:g,reset(){n={name:'',age:0,crime:'',health:75,mental:70,strength:65,intelligence:70,appearance:{height:0,weight:0,hair:'',condition:''},clothing:{top:'',bottom:'',underwear:'',underpants:'',socks:'',shoes:'',restraints:'æ— ',cleanliness:'æ•´æ´'},currentTask:'',currentThought:'',biggestWorry:'',days:0,stage:'åˆ‘äº‹æ‹˜ç•™',cellType:'è¿‡æ¸¡ç›‘å®¤',changes:{health:[],mental:[],strength:[],intelligence:[]},accumulated:{health:0,mental:0,strength:0,intelligence:0},lastUpdate:Date.now(),stats:{totalUpdates:0,successfulParses:0,failedParses:0,lastParseTime:0}},y(),console.log('[çŠ¶æ€æ ] çŠ¶æ€å·²é‡ç½®')},exportData:()=>({version:'3.5.2',timestamp:Date.now(),state:JSON.parse(JSON.stringify(n))}),importData(e){if(!e||!e.state)return console.error('[çŠ¶æ€æ ] æ— æ•ˆçš„å¯¼å…¥æ•°æ®'),!1;try{return e.version&&'3.5.2'!==e.version&&console.warn(`[çŠ¶æ€æ ] æ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…: ${e.version} vs 3.5.2`),n=e.state,n.changes||(n.changes={health:[],mental:[],strength:[],intelligence:[]}),n.accumulated||(n.accumulated={health:0,mental:0,strength:0,intelligence:0}),n.stats||(n.stats={totalUpdates:0,successfulParses:0,failedParses:0,lastParseTime:0}),n.lastUpdate=Date.now(),y(),console.log('[çŠ¶æ€æ ] æ•°æ®å¯¼å…¥æˆåŠŸ'),!0}catch(e){return console.error('[çŠ¶æ€æ ] å¯¼å…¥æ•°æ®å¤±è´¥:',e),!1}}};M.debug={scanAllComments:function(){console.log('[çŠ¶æ€æ ] å¼€å§‹æ‰«æé¡µé¢ä¸­çš„æ‰€æœ‰æ³¨é‡Š...');const e=document.createTreeWalker(document.body,NodeFilter.SHOW_COMMENT,null,!1),t=[];let n;for(;n=e.nextNode();){const e=(n.nodeValue||n.textContent||'').trim();t.push({content:e.substring(0,100)+(e.length>100?'...':''),fullContent:e,isStatusUpdate:e.startsWith('STATUS_UPDATE:'),length:e.length}),e.startsWith('STATUS_UPDATE:')&&(console.log('[çŠ¶æ€æ ] âœ… æ‰¾åˆ°çŠ¶æ€æ›´æ–°æ³¨é‡Š:',e.substring(0,100)),h(n))}return console.log(`[çŠ¶æ€æ ] æ‰«æå®Œæˆï¼Œå…±æ‰¾åˆ° ${t.length} ä¸ªæ³¨é‡Š`),console.log('[çŠ¶æ€æ ] å…¶ä¸­çŠ¶æ€æ›´æ–°æ³¨é‡Š:',t.filter(e=>e.isStatusUpdate).length),console.table(t),t},getDiagnostics:function(){const t={version:'3.5.2',timestamp:(new Date).toLocaleString('zh-CN'),observer:{active:null!==s,status:s?'è¿è¡Œä¸­':'å·²åœæ­¢'},state:{lastUpdate:new Date(n.lastUpdate).toLocaleString('zh-CN'),timeSinceUpdate:Date.now()-n.lastUpdate,timeSinceUpdateFormatted:r(Date.now()-n.lastUpdate)},stats:{totalUpdates:n.stats.totalUpdates,successfulParses:n.stats.successfulParses,failedParses:n.stats.failedParses,successRate:n.stats.totalUpdates>0?`${(n.stats.successfulParses/n.stats.totalUpdates*100).toFixed(2)}%`:'N/A',lastParseTime:n.stats.lastParseTime>0?new Date(n.stats.lastParseTime).toLocaleString('zh-CN'):'ä»æœª'},currentState:M.getState(),config:e};return console.log('=== çŠ¶æ€æ è¯Šæ–­ä¿¡æ¯ ==='),console.log('ç‰ˆæœ¬:',t.version),console.log('æ—¶é—´:',t.timestamp),console.log('è§‚å¯Ÿå™¨çŠ¶æ€:',t.observer.status),console.log('æœ€åæ›´æ–°:',t.state.lastUpdate),console.log('è·ç¦»ä¸Šæ¬¡æ›´æ–°:',t.state.timeSinceUpdateFormatted),console.log('ç»Ÿè®¡ä¿¡æ¯:',t.stats),console.log('å½“å‰çŠ¶æ€:',t.currentState),console.log('======================'),t},parseCommentNode:h,checkForStatusUpdate:u},$(()=>{console.info('[çŠ¶æ€æ ] è„šæœ¬å¼€å§‹åŠ è½½ v3.5.2');const e=window.detentionSystem;e?(e.getState=()=>M.getState(),e.modifyValue=(e,t,n)=>M.modifyValue(e,t,n),e.getTrendAnalysis=()=>M.getTrendAnalysis(),e.getCurrentStage=()=>M.getCurrentStage(),e.parseStatusUpdate=e=>M.parseStatusUpdate(e),e.registerModule('statusPanel',M),window.detentionSystem.statusPanel=M,e.events.on('initialized',()=>{console.info('[çŠ¶æ€æ ] æ ¸å¿ƒç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œå¼€å§‹åˆå§‹åŒ–çŠ¶æ€æ '),setTimeout(()=>{try{M.initialize(),console.info('[çŠ¶æ€æ ] âœ“ çŠ¶æ€æ åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('[çŠ¶æ€æ ] âœ— çŠ¶æ€æ åˆå§‹åŒ–å¤±è´¥:',e)}},500)}),e.initialized&&setTimeout(()=>{try{M.initialize(),console.info('[çŠ¶æ€æ ] âœ“ çŠ¶æ€æ åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('[çŠ¶æ€æ ] âœ— çŠ¶æ€æ åˆå§‹åŒ–å¤±è´¥:',e)}},500),console.info('[çŠ¶æ€æ ] è„šæœ¬åŠ è½½å®Œæˆ v3.5.2')):console.error('[çŠ¶æ€æ ] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½')}),$(window).on('pagehide',()=>{console.log('[çŠ¶æ€æ ] é¡µé¢å³å°†å¸è½½ï¼Œæ‰§è¡Œæ¸…ç†...'),b(),w()})}},t={};console.info('[æ ¸å¿ƒç³»ç»Ÿ] å¼€å§‹åŠ è½½...');class n{events=new Map;on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}off(e,t){const n=this.events.get(e);if(!n)return;const a=n.indexOf(t);a>-1&&n.splice(a,1)}emit(e,t){const n=this.events.get(e);n&&n.forEach(n=>{try{n(t)}catch(t){console.error(`[äº‹ä»¶ç³»ç»Ÿ] äº‹ä»¶ ${e} å›è°ƒé”™è¯¯:`,t)}})}once(e,t){const n=a=>{t(a),this.off(e,n)};this.on(e,n)}}const a=new Map;let s;function i(){const e={version:'3.2.0',initialized:!1,modules:{},config:{tokenBudget:1e5,fallbackBudget:4e4,compressionQuality:.8,cacheExpiry:6e5,healthCheckInterval:500,healthCheckTimeout:3e3},state:{mode:'detecting',tokenUsed:0,lastHealthCheck:0,errors:[]},events:new n,CacheManager:{set(e,t,n){const s=n?Date.now()+1e3*n:null;a.set(e,{value:t,expiry:s})},get(e){const t=a.get(e);return t?null!==t.expiry&&Date.now()>t.expiry?(a.delete(e),null):t.value:null},has(e){return null!==this.get(e)},delete(e){a.delete(e)},clear(){a.clear()},cleanup(){const e=Date.now();for(const[t,n]of a.entries())null!==n.expiry&&e>n.expiry&&a.delete(t)}},EventEmitter:n,ping:()=>(e.state.lastHealthCheck=Date.now(),!0),checkTokenBudget(){const t='external'===e.state.mode?e.config.tokenBudget:e.config.fallbackBudget,n=e.state.tokenUsed,a=n/t*100,s=a>95?'critical':a>85?'warning':'normal';return{used:n,total:t,percentage:a.toFixed(2),remaining:t-n,status:s}},updateTokenUsage(t){e.state.tokenUsed+=t;const n=e.checkTokenBudget();return'warning'===n.status?(console.warn(`[Tokené¢„ç®—] è­¦å‘Š: å·²ä½¿ç”¨ ${n.percentage}%`),e.events.emit('token_warning',n)):'critical'===n.status&&(console.error(`[Tokené¢„ç®—] ä¸¥é‡: å·²ä½¿ç”¨ ${n.percentage}%`),e.events.emit('token_critical',n)),n},compressContent(t,n=null){const a='string'==typeof t?t:JSON.stringify(t),s=n??e.config.compressionQuality;let i=a.replace(/\s+/g,' ').replace(/\n\s*\n/g,'\n').trim();s<.9&&(i=i.replace(/ï¼Œ/g,',').replace(/ã€‚/g,'.').replace(/ï¼›/g,';').replace(/ï¼š/g,':'));const o=a.length,r=i.length,l=(100*(1-r/o)).toFixed(2);return console.info(`[å†…å®¹å‹ç¼©] åŸå§‹: ${o} -> å‹ç¼©: ${r} (èŠ‚çœ ${l}%)`),i},registerModule(t,n){e.modules[t]&&console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] æ¨¡å— ${t} å·²å­˜åœ¨ï¼Œå°†è¢«è¦†ç›–`),e.modules[t]=n,console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æ¨¡å— ${t} å·²æ³¨å†Œ`),e.events.emit('module_registered',{name:t,module:n})},getModule:t=>e.modules[t],handleError(t,n='unknown'){const a=function(e){return e instanceof Error?e:new Error('string'==typeof e?e:JSON.stringify(e))}(t),s={message:a.message,context:n,timestamp:Date.now(),stack:a.stack};e.state.errors.push(s),console.error(`[æ ¸å¿ƒç³»ç»Ÿ] é”™è¯¯ [${n}]:`,a),e.events.emit('error',s),e.state.errors.length>100&&e.state.errors.shift()},detectEnvironment(){const e={isSillyTavern:!1,version:null,hasHelper:!1,helperVersion:null,hasDataTable:!1};('undefined'!=typeof SillyTavern||$('#send_textarea').length>0)&&(e.isSillyTavern=!0,'function'==typeof getTavernVersion&&(e.version=getTavernVersion()??null)),'function'==typeof getTavernHelperVersion&&(e.hasHelper=!0,e.helperVersion=getTavernHelperVersion()??null);const t=window;return'function'==typeof t.insertRow&&'function'==typeof t.updateRow&&(e.hasDataTable=!0),e},initialize(){if(e.initialized)return void console.warn('[æ ¸å¿ƒç³»ç»Ÿ] å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡');console.info('[æ ¸å¿ƒç³»ç»Ÿ] å¼€å§‹åˆå§‹åŒ–...');const t=e.detectEnvironment();console.info('[æ ¸å¿ƒç³»ç»Ÿ] ç¯å¢ƒæ£€æµ‹:',t),t.isSillyTavern||console.warn('[æ ¸å¿ƒç³»ç»Ÿ] æœªæ£€æµ‹åˆ°SillyTavernç¯å¢ƒ'),e.state.mode='external',e.initialized=!0,console.info('[æ ¸å¿ƒç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆ'),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] ç‰ˆæœ¬: ${e.version}`),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æ¨¡å¼: ${e.state.mode}`),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] Tokené¢„ç®—: ${e.config.tokenBudget}`),e.events.emit('initialized',{env:t,state:e.state})}};return e}window.detentionSystem||(window.detentionSystem=i(),console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ ¸å¿ƒç³»ç»Ÿå¯¹è±¡å·²åˆ›å»ºï¼ˆè„šæœ¬åŠ è½½æ—¶ï¼‰'),console.info('[æ ¸å¿ƒç³»ç»Ÿ] window.detentionSystem ç±»å‹:',typeof window.detentionSystem),console.info('[æ ¸å¿ƒç³»ç»Ÿ] window.detentionSystem å€¼:',window.detentionSystem)),$(()=>{console.info('[æ ¸å¿ƒç³»ç»Ÿ] é…’é¦†é¡µé¢å·²åŠ è½½ï¼ˆjQuery readyï¼‰'),window.detentionSystem||(console.warn('[æ ¸å¿ƒç³»ç»Ÿ] è­¦å‘Šï¼šåœ¨ jQuery ready æ—¶æœªæ‰¾åˆ°æ ¸å¿ƒç³»ç»Ÿï¼Œé‡æ–°åˆ›å»º'),window.detentionSystem=i(),console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ ¸å¿ƒç³»ç»Ÿå¯¹è±¡å·²åˆ›å»ºï¼ˆjQuery ready æ—¶ï¼‰'));const e=window.detentionSystem;console.info('[æ ¸å¿ƒç³»ç»Ÿ] å½“å‰æ ¸å¿ƒç³»ç»ŸçŠ¶æ€:',{exists:!!e,version:e.version,initialized:e.initialized}),function(e){s||(s=setInterval(()=>e.CacheManager.cleanup(),6e4))}(e),console.info('[æ ¸å¿ƒç³»ç»Ÿ] å‡†å¤‡åœ¨ 1 ç§’ååˆå§‹åŒ–...'),setTimeout(()=>{console.info('[æ ¸å¿ƒç³»ç»Ÿ] setTimeout å›è°ƒæ‰§è¡Œï¼Œå¼€å§‹åˆå§‹åŒ–...');try{e.initialize(),console.info('[æ ¸å¿ƒç³»ç»Ÿ] initialize() è°ƒç”¨å®Œæˆ')}catch(t){console.error('[æ ¸å¿ƒç³»ç»Ÿ] initialize() è°ƒç”¨å‡ºé”™:',t),e.handleError(t,'initialize')}},1e3)}),$(window).on('pagehide',()=>{s&&(clearInterval(s),s=void 0)}),console.info('[æ ¸å¿ƒç³»ç»Ÿ] è„šæœ¬åŠ è½½å®Œæˆ'),console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ£€æŸ¥ window.detentionSystem:',{exists:void 0!==window.detentionSystem,type:typeof window.detentionSystem,value:window.detentionSystem?'object':'undefined'}),console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ£€æŸ¥ window.detentionSystem:',{exists:void 0!==window.detentionSystem,type:typeof window.detentionSystem,value:window.detentionSystem?'object':'undefined'});(function n(a){var s=t[a];if(void 0!==s)return s.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,n),i.exports})(439);console.info('[äº‹ä»¶ç³»ç»Ÿ] å¼€å§‹åŠ è½½...');const o=window.detentionSystem;if(!o){console.error('[äº‹ä»¶ç³»ç»Ÿ] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½');const e={currentDay:0,lastEventDay:0,eventHistory:[],legalTimeline:{arrestDay:0,approvalDay:null,prosecutionDay:null,firstTrialDay:null,firstVerdictDay:null,secondTrialDay:null,finalVerdictDay:null,transferDay:null,executionDay:null},currentStage:'detention',cellType:'transition',caseComplexity:'normal',complexityMultiplier:1,eventCounters:{interrogation:0,lawyerVisit:0,familyVisit:0,medicalVisit:0,sceneIdentification:0},isDeathPenalty:!1,lastStageChangeDay:0,PRIORITY:{LEGAL:1,CONDITION:2,RANDOM:3,DAILY:4},legalEvents:{approval:{name:'æ‰¹å‡†é€®æ•',minDay:30,maxDay:37,stage:'approval',description:'æ£€å¯Ÿé™¢æ‰¹å‡†é€®æ•å†³å®š',nextStage:'investigation'},investigation:{name:'ä¾¦æŸ¥ç¾æŠ¼',duration:[60,210],stage:'investigation',description:'å…¬å®‰æœºå…³ä¾¦æŸ¥é˜¶æ®µ',nextStage:'prosecution'},prosecution:{name:'å®¡æŸ¥èµ·è¯‰',duration:[30,45],stage:'prosecution',description:'æ£€å¯Ÿé™¢å®¡æŸ¥èµ·è¯‰',nextStage:'trial1'},firstTrial:{name:'ä¸€å®¡å¼€åº­',duration:[30,45],stage:'trial1',description:'æ³•é™¢ä¸€å®¡å®¡ç†',nextStage:'firstVerdict'},firstVerdict:{name:'ä¸€å®¡åˆ¤å†³',duration:[7,30],stage:'firstVerdict',description:'ä¸€å®¡åˆ¤å†³å®£å‘Š',nextStage:'appeal'},appeal:{name:'ä¸Šè¯‰æœŸ',duration:[10,10],stage:'appeal',description:'10å¤©ä¸Šè¯‰æœŸ',nextStage:'trial2'},secondTrial:{name:'äºŒå®¡å®¡ç†',duration:[60,90],stage:'trial2',description:'äºŒå®¡æ³•é™¢å®¡ç†',nextStage:'finalVerdict'},finalVerdict:{name:'ç»ˆå®¡åˆ¤å†³',duration:[7,14],stage:'finalVerdict',description:'äºŒå®¡åˆ¤å†³å®£å‘Š',nextStage:'transfer'},transfer:{name:'ç§»é€ç›‘ç‹±',duration:[30,90],stage:'transfer',description:'ç§»é€ç›‘ç‹±æ‰§è¡Œ',nextStage:'end'},deathReview:{name:'æ­»åˆ‘å¤æ ¸',duration:[180,720],stage:'deathReview',description:'æœ€é«˜æ³•é™¢æ­»åˆ‘å¤æ ¸',nextStage:'execution'},execution:{name:'æ‰§è¡Œæ­»åˆ‘',duration:[1,7],stage:'execution',description:'æ­»åˆ‘æ‰§è¡Œ',nextStage:'end'}},conditionEvents:[{id:'mental_breakdown',name:'ç²¾ç¥å´©æºƒ',condition:e=>e.mental<20,weight:100,description:'ç²¾ç¥çŠ¶æ€æåº¦æ¶åŒ–ï¼Œå‡ºç°è‡ªæ€å€¾å‘',checkAlways:!0},{id:'health_crisis',name:'å¥åº·å±æœº',condition:e=>e.health<30,weight:100,description:'å¥åº·çŠ¶å†µä¸¥é‡æ¶åŒ–ï¼Œéœ€è¦ç´§æ€¥åŒ»ç–—',checkAlways:!0},{id:'major_twist',name:'é‡å¤§è½¬æŠ˜',condition:(e,t)=>t.currentDay===t.lastStageChangeDay&&Math.random()<.15,weight:100,description:'æ¡ˆä»¶å‡ºç°é‡å¤§è½¬æŠ˜',stageChangeOnly:!0},{id:'evidence_reversal',name:'è¯æ®åè½¬',condition:(e,t)=>t.currentDay===t.lastStageChangeDay&&Math.random()<.1,weight:100,description:'æ–°è¯æ®å‡ºç°ï¼Œæ¡ˆæƒ…åè½¬',stageChangeOnly:!0},{id:'interrogation',name:'æå®¡',condition:(e,t)=>{if('investigation'!==t.currentStage)return!1;const n=t.legalTimeline.approvalDay?t.currentDay-t.legalTimeline.approvalDay:0;let a=.15;a=n<30?.25:n<60?.15:.08;const s=a*Math.pow(.7,t.eventCounters.interrogation);return Math.random()<s},weight:100,description:'å…¬å®‰æœºå…³æå®¡è®¯é—®',category:'procedural'},{id:'lawyer_visit',name:'å¾‹å¸ˆä¼šè§',condition:(e,t)=>{let n=.03;if(t.currentDay-t.legalTimeline.arrestDay<=14&&(n=.15),t.legalTimeline.firstTrialDay){const e=t.legalTimeline.firstTrialDay-t.currentDay;e>0&&e<=7&&(n=.3)}if(t.legalTimeline.secondTrialDay){const e=t.legalTimeline.secondTrialDay-t.currentDay;e>0&&e<=7&&(n=.25)}return Math.random()<n},weight:90,description:'å¾‹å¸ˆå‰æ¥ä¼šè§',category:'procedural'},{id:'family_visit',name:'å®¶å±æ¢è§†',condition:(e,t)=>{if(!t.legalTimeline.firstVerdictDay)return!1;let n=.05;t.isDeathPenalty&&(n=.1);const a=t.eventHistory.filter(e=>'family_visit'===e.id).sort((e,t)=>(t.day??0)-(e.day??0))[0];return!(a&&t.currentDay-(a.day??0)<30)&&Math.random()<n},weight:85,description:'å®¶å±å‰æ¥æ¢è§†',category:'procedural'},{id:'medical_visit',name:'å¤–å‡ºå°±åŒ»',condition:(e,t)=>{if(e.health>=25)return!1;let n=0;n=e.health<10?.4:e.health<15?.25:e.health<20?.15:.08;const a=t.eventHistory.filter(e=>'medical_visit'===e.id).sort((e,t)=>(t.day??0)-(e.day??0))[0];return!(a&&t.currentDay-(a.day??0)<7)&&Math.random()<n},weight:95,description:'å¥åº·çŠ¶å†µä¸¥é‡ï¼Œéœ€å¤–å‡ºå°±åŒ»',category:'procedural'},{id:'scene_identification',name:'æŒ‡è®¤ç°åœº',condition:(e,t)=>{if('investigation'!==t.currentStage)return!1;if(t.eventCounters.sceneIdentification>0)return!1;const n=t.legalTimeline.approvalDay?t.currentDay-t.legalTimeline.approvalDay:0;if(n<15||n>120)return!1;const a=t.getRecentContext?t.getRecentContext():'',s=['ç°åœº','æ¡ˆå‘åœ°','æŒ‡è®¤','å¸¦å›','å‹˜æŸ¥'].some(e=>a.includes(e))?.24:.08;return Math.random()<s},weight:80,description:'å…¬å®‰æœºå…³å¸¦å¾€æ¡ˆå‘ç°åœºæŒ‡è®¤',category:'procedural',aiControlled:!0}],randomEvents:{violence:[{id:'newcomer_bullying',name:'æ–°äººæ¬ºå‡Œ',weight:30},{id:'bed_dispute',name:'åºŠä½äº‰å¤º',weight:25},{id:'food_robbery',name:'é£Ÿç‰©æŠ¢å¤º',weight:20},{id:'faction_conflict',name:'æ´¾ç³»å†²çª',weight:15},{id:'revenge',name:'æŠ¥å¤è¡ŒåŠ¨',weight:10}],medical:[{id:'epidemic',name:'ä¼ æŸ“ç—…çˆ†å‘',weight:15},{id:'mental_illness',name:'ç²¾ç¥ç–¾ç—…å‘ä½œ',weight:25},{id:'chronic_disease',name:'æ…¢æ€§ç—…æ¶åŒ–',weight:20},{id:'injury',name:'æ„å¤–å—ä¼¤',weight:20},{id:'gynecological',name:'å¦‡ç§‘é—®é¢˜',weight:10},{id:'malnutrition',name:'è¥å…»ä¸è‰¯',weight:10}],emotional:[{id:'deep_friendship',name:'æ·±åº¦å‹è°Šå»ºç«‹',weight:20},{id:'betrayal',name:'é—ºèœœåç›®',weight:15},{id:'motherly_bond',name:'æ¯å¥³èˆ¬å…³ç³»',weight:15},{id:'jealousy',name:'å«‰å¦’ä¸æ’æŒ¤',weight:20},{id:'secret_sharing',name:'ç§˜å¯†åˆ†äº«',weight:15},{id:'collective_exclusion',name:'é›†ä½“æ’æ–¥',weight:10},{id:'romance',name:'æ‹æƒ…èŒèŠ½',weight:5}],accident:[{id:'facility_failure',name:'è®¾æ–½æ•…éšœ',weight:25},{id:'safety_incident',name:'å®‰å…¨äº‹æ•…',weight:20},{id:'external_news',name:'å¤–éƒ¨æ¶ˆæ¯',weight:30},{id:'extreme_weather',name:'æç«¯å¤©æ°”',weight:15},{id:'management_change',name:'ç®¡ç†å˜åŒ–',weight:10}]},innerMonologues:[{id:'worry_about_family',text:'ä¸çŸ¥é“å®¶é‡Œäººç°åœ¨æ€ä¹ˆæ ·äº†...',weight:20},{id:'regret_past',text:'å¦‚æœå½“åˆæ²¡æœ‰åšé‚£ä»¶äº‹å°±å¥½äº†...',weight:20},{id:'fear_future',text:'ä¸çŸ¥é“åˆ¤å†³ä¼šæ˜¯ä»€ä¹ˆç»“æœ...',weight:18},{id:'miss_freedom',text:'å¥½æƒ³å¿µå¤–é¢çš„é˜³å…‰å’Œè‡ªç”±...',weight:15},{id:'self_reflection',text:'æˆ‘åˆ°åº•æ˜¯æ€ä¹ˆèµ°åˆ°è¿™ä¸€æ­¥çš„...',weight:12},{id:'hope_for_leniency',text:'å¸Œæœ›æ³•å®˜èƒ½ä»è½»åˆ¤å†³...',weight:10},{id:'worry_about_children',text:'å­©å­ä»¬ç°åœ¨è¿˜å¥½å—...',weight:15},{id:'fear_of_inmates',text:'è¿™é‡Œçš„äººçœ‹èµ·æ¥éƒ½å¾ˆå¯æ€•...',weight:12},{id:'loneliness',text:'ä»æ¥æ²¡æœ‰æ„Ÿè§‰è¿™ä¹ˆå­¤ç‹¬è¿‡...',weight:15},{id:'time_perception',text:'åœ¨è¿™é‡Œï¼Œæ—¶é—´è¿‡å¾—å¥½æ…¢...',weight:10},{id:'dream_of_past',text:'æ˜¨æ™šåˆæ¢¦åˆ°äº†ä»¥å‰çš„ç”Ÿæ´»...',weight:12},{id:'worry_about_health',text:'èº«ä½“è¶Šæ¥è¶Šå·®äº†ï¼Œä¸çŸ¥é“èƒ½ä¸èƒ½æ’‘ä¸‹å»...',weight:10},{id:'guilt',text:'å¯¹ä¸èµ·é‚£äº›è¢«æˆ‘ä¼¤å®³çš„äºº...',weight:8},{id:'anger',text:'ä¸ºä»€ä¹ˆåªæœ‰æˆ‘è¢«æŠ“ï¼Œå…¶ä»–äººéƒ½æ²¡äº‹...',weight:8},{id:'acceptance',text:'ä¹Ÿè®¸è¿™å°±æ˜¯æˆ‘åº”å¾—çš„æƒ©ç½š...',weight:7},{id:'hope_for_appeal',text:'ä¸Šè¯‰è¿˜æœ‰å¸Œæœ›å—...',weight:8},{id:'fear_of_death',text:'å¦‚æœè¢«åˆ¤æ­»åˆ‘æ€ä¹ˆåŠ...',weight:5},{id:'nostalgia',text:'å¥½æƒ³åƒä¸€é¡¿å®¶é‡Œåšçš„é¥­...',weight:10}],initialize(e=0){this.currentDay=e,this.legalTimeline.arrestDay=e,this.currentStage='detention',this.cellType='transition',this.caseComplexity='normal',this.complexityMultiplier=1,this.isDeathPenalty=!1,this.lastStageChangeDay=e,this.lastEventDay=e;for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0;console.info('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆ'),console.info(`[äº‹ä»¶ç³»ç»Ÿ] èµ·å§‹æ—¥æœŸ: ç¬¬${e}å¤©`),o.events.emit('event_system_initialized',{day:this.currentDay,stage:this.currentStage})},setCaseComplexity(e){const t={simple:.8,normal:1,complex:1.3,very_complex:1.6};e in t?(this.caseComplexity=e,this.complexityMultiplier=t[e],console.info(`[äº‹ä»¶ç³»ç»Ÿ] æ¡ˆä»¶å¤æ‚åº¦è®¾ç½®ä¸º: ${e} (æ—¶é™å€æ•°: ${this.complexityMultiplier})`),o.events.emit('complexity_changed',{complexity:this.caseComplexity,multiplier:this.complexityMultiplier})):console.warn(`[äº‹ä»¶ç³»ç»Ÿ] æ— æ•ˆçš„å¤æ‚åº¦: ${e}`)},checkComplexityAdjustment(){this.currentDay%30==0&&o.events.emit('request_complexity_assessment',{day:this.currentDay,stage:this.currentStage,eventHistory:this.eventHistory})},rollbackToStage(e,t='ç‰¹æ®Šæƒ…å†µ'){console.info(`[äº‹ä»¶ç³»ç»Ÿ] æ³•å¾‹ç¨‹åºå›é€€: ${this.currentStage} -> ${e}`),console.info(`[äº‹ä»¶ç³»ç»Ÿ] å›é€€åŸå› : ${t}`);const n=['detention','approval','investigation','prosecution','trial1','firstVerdict','appeal','trial2','finalVerdict','transfer','execution'],a=n.indexOf(e),s=n.indexOf(this.currentStage);if(-1===a||a>=s)return console.warn('[äº‹ä»¶ç³»ç»Ÿ] æ— æ•ˆçš„å›é€€ç›®æ ‡æˆ–æ— éœ€å›é€€'),!1;const i={approval:'approvalDay',investigation:'approvalDay',prosecution:'prosecutionDay',trial1:'firstTrialDay',firstVerdict:'firstVerdictDay',appeal:'firstVerdictDay',trial2:'secondTrialDay',finalVerdict:'finalVerdictDay',transfer:'transferDay',execution:'executionDay'};for(let e=a+1;e<n.length;e++){const t=i[n[e]];t&&this.legalTimeline[t]&&(this.legalTimeline[t]=null)}return this.currentStage=e,a<=n.indexOf('investigation')&&(this.cellType='pretrial'),this.eventHistory.push({id:'procedure_rollback',name:'ç¨‹åºå›é€€',type:'legal',day:this.currentDay,from:n[s],to:e,reason:t}),o.events.emit('procedure_rollback',{from:n[s],to:e,reason:t,day:this.currentDay}),!0},handleUserRollback(e){const t=[{pattern:/å›é€€.*?åˆ°.*?(ä¾¦æŸ¥|å®¡æŸ¥èµ·è¯‰|ä¸€å®¡|äºŒå®¡)/,stage:null},{pattern:/æ’¤å›.*?(èµ·è¯‰|åˆ¤å†³)/,stage:null},{pattern:/é‡æ–°.*?(ä¾¦æŸ¥|å®¡ç†)/,stage:null}];for(const n of t){const t=e.match(n.pattern);if(t){let e=null;if(t[1].includes('ä¾¦æŸ¥')?e='investigation':t[1].includes('å®¡æŸ¥èµ·è¯‰')?e='prosecution':t[1].includes('ä¸€å®¡')?e='trial1':t[1].includes('äºŒå®¡')&&(e='trial2'),e)return this.rollbackToStage(e,'ç”¨æˆ·è¯·æ±‚')}}return!1},advanceDay(e=1){const t=[];for(let n=0;n<e;n++){this.currentDay++,this.lastEventDay=this.currentDay,this.checkComplexityAdjustment();const e=this.checkDayEvents();if(e&&(t.push(e),this.eventHistory.push({...e,day:this.currentDay}),Object.prototype.hasOwnProperty.call(this.eventCounters,e.id)&&(this.eventCounters[e.id]=(this.eventCounters[e.id]||0)+1),(e.priority??this.PRIORITY.DAILY)<=this.PRIORITY.RANDOM))return console.info(`[äº‹ä»¶ç³»ç»Ÿ] ç¬¬${this.currentDay}å¤©è§¦å‘äº‹ä»¶: ${e.name}`),o.events.emit('event_triggered',e),{interrupted:!0,currentDay:this.currentDay,event:e,accumulatedEvents:t}}return{interrupted:!1,currentDay:this.currentDay,accumulatedEvents:t}},checkDayEvents(){const e=this.checkLegalEvent();if(e)return{...e,priority:this.PRIORITY.LEGAL,day:this.currentDay};const t=this.checkConditionEvent();if(t)return{...t,priority:this.PRIORITY.CONDITION,day:this.currentDay};if(Math.random()<.1){const e=this.generateRandomEvent();if(e)return{...e,priority:this.PRIORITY.RANDOM,day:this.currentDay}}if(Math.random()<.15){const e=this.generateInnerMonologue();if(e)return{...e,priority:this.PRIORITY.DAILY,day:this.currentDay}}return{id:'daily_routine',name:'æ—¥å¸¸ç”Ÿæ´»',type:'daily',priority:this.PRIORITY.DAILY,day:this.currentDay,description:'å¹³é™çš„ä¸€å¤©'}},checkLegalEvent(){const e=this.currentDay-this.legalTimeline.arrestDay,t=this.currentStage;if(!this.legalTimeline.approvalDay){const n=Math.floor(30*this.complexityMultiplier),a=Math.floor(37*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.3)return this.legalTimeline.approvalDay=this.currentDay,this.currentStage='investigation',this.lastStageChangeDay=this.currentDay,{id:'approval',name:'æ‰¹å‡†é€®æ•',type:'legal',stage:'approval',description:'æ£€å¯Ÿé™¢æ‰¹å‡†é€®æ•å†³å®šä¸‹è¾¾',from:t,to:'investigation'}}if(this.legalTimeline.approvalDay&&!this.legalTimeline.prosecutionDay){const e=this.currentDay-this.legalTimeline.approvalDay,n=Math.floor(60*this.complexityMultiplier),a=Math.floor(210*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.02)return this.legalTimeline.prosecutionDay=this.currentDay,this.currentStage='prosecution',this.lastStageChangeDay=this.currentDay,{id:'prosecution',name:'æ£€å¯Ÿé™¢èµ·è¯‰',type:'legal',stage:'prosecution',description:'æ£€å¯Ÿé™¢å‘æ³•é™¢æèµ·å…¬è¯‰',from:t,to:'prosecution'}}if(this.legalTimeline.prosecutionDay&&!this.legalTimeline.firstTrialDay){const e=this.currentDay-this.legalTimeline.prosecutionDay,n=Math.floor(30*this.complexityMultiplier),a=Math.floor(45*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.05)return this.legalTimeline.firstTrialDay=this.currentDay,this.currentStage='trial1',this.lastStageChangeDay=this.currentDay,'transition'===this.cellType&&(this.cellType='pretrial',o.events.emit('cell_transfer',{from:'transition',to:'pretrial',reason:'ç­‰å¾…å¼€åº­'})),{id:'first_trial',name:'ä¸€å®¡å¼€åº­',type:'legal',stage:'trial1',description:'æ³•é™¢ä¸€å®¡å¼€åº­å®¡ç†',from:t,to:'trial1'}}if(this.legalTimeline.firstTrialDay&&!this.legalTimeline.firstVerdictDay){const e=this.currentDay-this.legalTimeline.firstTrialDay,n=Math.floor(7*this.complexityMultiplier),a=Math.floor(30*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.1)return this.legalTimeline.firstVerdictDay=this.currentDay,this.currentStage='appeal',this.lastStageChangeDay=this.currentDay,this.cellType='convicted',o.events.emit('cell_transfer',{from:'pretrial',to:'convicted',reason:'ä¸€å®¡åˆ¤å†³å®£å‘Š'}),{id:'first_verdict',name:'ä¸€å®¡åˆ¤å†³',type:'legal',stage:'firstVerdict',description:'æ³•é™¢å®£å‘Šä¸€å®¡åˆ¤å†³',from:t,to:'appeal'}}if(this.legalTimeline.firstVerdictDay&&!this.legalTimeline.secondTrialDay&&!this.legalTimeline.finalVerdictDay){if(10===this.currentDay-this.legalTimeline.firstVerdictDay)return Math.random()<.7?(this.legalTimeline.secondTrialDay=this.currentDay,this.currentStage='trial2',this.lastStageChangeDay=this.currentDay,{id:'appeal_filed',name:'æèµ·ä¸Šè¯‰',type:'legal',stage:'appeal',description:'å‘ä¸Šçº§æ³•é™¢æèµ·ä¸Šè¯‰',from:t,to:'trial2'}):(this.legalTimeline.finalVerdictDay=this.currentDay,this.currentStage='transfer',this.lastStageChangeDay=this.currentDay,{id:'verdict_final',name:'åˆ¤å†³ç”Ÿæ•ˆ',type:'legal',stage:'finalVerdict',description:'æœªä¸Šè¯‰ï¼Œä¸€å®¡åˆ¤å†³ç”Ÿæ•ˆ',from:t,to:'transfer'})}if(this.legalTimeline.secondTrialDay&&!this.legalTimeline.finalVerdictDay){const e=this.currentDay-this.legalTimeline.secondTrialDay,n=Math.floor(60*this.complexityMultiplier),a=Math.floor(90*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.03)return this.legalTimeline.finalVerdictDay=this.currentDay,this.currentStage='transfer',this.lastStageChangeDay=this.currentDay,{id:'final_verdict',name:'äºŒå®¡åˆ¤å†³',type:'legal',stage:'finalVerdict',description:'äºŒå®¡æ³•é™¢å®£å‘Šç»ˆå®¡åˆ¤å†³',from:t,to:'transfer'}}if(this.legalTimeline.finalVerdictDay&&!this.legalTimeline.transferDay&&!this.isDeathPenalty){const e=this.currentDay-this.legalTimeline.finalVerdictDay,n=Math.floor(30*this.complexityMultiplier),a=Math.floor(90*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.02)return this.legalTimeline.transferDay=this.currentDay,this.currentStage='end',this.lastStageChangeDay=this.currentDay,{id:'transfer_prison',name:'ç§»é€ç›‘ç‹±',type:'legal',stage:'transfer',description:'ç§»é€ç›‘ç‹±æ‰§è¡Œåˆ‘ç½š',isEnding:!0,endingType:'prison',from:t,to:'end'}}if(this.legalTimeline.finalVerdictDay&&this.isDeathPenalty&&!this.legalTimeline.executionDay){const e=this.currentDay-this.legalTimeline.finalVerdictDay;if(e>=180&&e<=720&&Math.random()<.005)return this.legalTimeline.executionDay=this.currentDay+7,this.currentStage='execution',this.lastStageChangeDay=this.currentDay,{id:'death_review_approved',name:'æ­»åˆ‘å¤æ ¸æ ¸å‡†',type:'legal',stage:'deathReview',description:'æœ€é«˜æ³•é™¢æ ¸å‡†æ­»åˆ‘ï¼Œ7æ—¥å†…æ‰§è¡Œ',from:t,to:'execution'}}return this.legalTimeline.executionDay&&this.currentDay>=this.legalTimeline.executionDay?(this.currentStage='end',this.lastStageChangeDay=this.currentDay,{id:'execution',name:'æ‰§è¡Œæ­»åˆ‘',type:'legal',stage:'execution',description:'æ­»åˆ‘æ‰§è¡Œ',isEnding:!0,endingType:'death',from:t,to:'end'}):null},checkConditionEvent(){const e=this.getProtagonistState();for(const t of this.conditionEvents)if((!t.stageChangeOnly||this.currentDay===this.lastStageChangeDay)&&(t.checkAlways||!t.stageChangeOnly)&&t.condition(e,this)&&100*Math.random()<t.weight)return{id:t.id,name:t.name,type:t.category||'condition',description:t.description,aiControlled:t.aiControlled||!1};return null},generateRandomEvent(){const e=['violence','medical','emotional','accident'],t=e[this.weightedRandom(e.length,[25,30,30,15])],n=this.randomEvents[t],a=n.map(e=>e.weight),s=n[this.weightedRandom(n.length,a)];return{id:s.id,name:s.name,type:t,category:'random',description:`éšæœºäº‹ä»¶: ${s.name}`}},generateInnerMonologue(){const e=this.innerMonologues.map(e=>e.weight),t=this.weightedRandom(this.innerMonologues.length,e),n=this.innerMonologues[t];return{id:n.id,name:'å¿ƒç†ç‹¬ç™½',type:'monologue',category:'daily',description:n.text,text:n.text}},weightedRandom(e,t){const n=t.reduce((e,t)=>e+t,0);let a=Math.random()*n;for(let n=0;n<e;n++)if(a-=t[n],a<=0)return n;return e-1},getProtagonistState(){const e=o.getModule('statusPanel');return e&&e.getState?e.getState():{health:80,mental:70,strength:60,intelligence:70}},getRecentContext(){if(Array.isArray(window.chat)){return window.chat.slice(-5).map(e=>e.mes||'').join(' ')}return''},checkCellTransfer(){const e=this.currentDay-this.legalTimeline.arrestDay;return'transition'===this.cellType&&e>=7&&e<=14&&Math.random()<.2&&(this.cellType='pretrial',o.events.emit('cell_transfer',{from:'transition',to:'pretrial',reason:'è¿‡æ¸¡æœŸç»“æŸ',day:this.currentDay}),!0)},setDeathPenalty(e){this.isDeathPenalty=e,console.info(`[äº‹ä»¶ç³»ç»Ÿ] æ­»åˆ‘æ ‡è®°è®¾ç½®ä¸º: ${e}`),o.events.emit('death_penalty_status_changed',{isDeathPenalty:this.isDeathPenalty,day:this.currentDay})},getCurrentStageInfo(){return{day:this.currentDay,stage:this.currentStage,cellType:this.cellType,daysInCustody:this.currentDay-this.legalTimeline.arrestDay,timeline:{...this.legalTimeline},complexity:this.caseComplexity,complexityMultiplier:this.complexityMultiplier,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters}}},getEventStatistics(){const e={totalEvents:this.eventHistory.length,byType:{},byPriority:{},recentEvents:this.eventHistory.slice(-10)};return this.eventHistory.forEach(t=>{const n=t.type||'unknown';e.byType[n]=(e.byType[n]||0)+1;const a=t.priority||4;e.byPriority[a]=(e.byPriority[a]||0)+1}),e},exportTimeline(){return{currentDay:this.currentDay,currentStage:this.currentStage,cellType:this.cellType,timeline:{...this.legalTimeline},complexity:this.caseComplexity,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters},eventHistory:[...this.eventHistory],lastStageChangeDay:this.lastStageChangeDay}},importTimeline(e){if(!e)return!1;try{return this.currentDay=e.currentDay||0,this.currentStage=e.currentStage||'detention',this.cellType=e.cellType||'transition',this.legalTimeline=e.timeline||{},this.caseComplexity=e.complexity||'normal',this.isDeathPenalty=Boolean(e.isDeathPenalty),this.eventCounters=e.eventCounters||{},this.eventHistory=e.eventHistory||[],this.lastStageChangeDay=e.lastStageChangeDay||0,console.info('[äº‹ä»¶ç³»ç»Ÿ] æ—¶é—´çº¿å¯¼å…¥æˆåŠŸ'),!0}catch(e){return console.error('[äº‹ä»¶ç³»ç»Ÿ] æ—¶é—´çº¿å¯¼å…¥å¤±è´¥:',e),!1}}};o.generateRandomEvent=t=>e.generateRandomEvent(),o.advanceDay=t=>e.advanceDay(t),o.getCurrentStage=()=>e.getCurrentStageInfo(),o.checkCellTransfer=()=>e.checkCellTransfer(),o.setCaseComplexity=t=>e.setCaseComplexity(t),o.rollbackToStage=(t,n)=>e.rollbackToStage(t,n),o.setDeathPenalty=t=>e.setDeathPenalty(t),o.getEventStatistics=()=>e.getEventStatistics(),o.exportTimeline=()=>e.exportTimeline(),o.importTimeline=t=>e.importTimeline(t),o.registerModule('eventSystem',e),o.events.on('user_input',t=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1236',message:'æ”¶åˆ°ç”¨æˆ·è¾“å…¥äº‹ä»¶',data:{hasData:!!t,dataType:typeof t,textLength:'string'==typeof t?.text?t.text?.length:0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});const n='string'==typeof t?.text?t.text:void 0;n&&(fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1242',message:'å¤„ç†ç”¨æˆ·å›é€€',data:{text:n.substring(0,50)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{}),e.handleUserRollback(n))}),o.events.on('initialized',()=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1246',message:'æ”¶åˆ°æ ¸å¿ƒç³»ç»Ÿåˆå§‹åŒ–äº‹ä»¶',data:{currentDay:e.currentDay,currentStage:e.currentStage},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});try{e.initialize(0),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1250',message:'äº‹ä»¶ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ',data:{currentDay:e.currentDay,currentStage:e.currentStage},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{})}catch(e){fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1254',message:'äº‹ä»¶ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥',data:{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{}),console.error('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–å¤±è´¥:',e)}}),console.info('[äº‹ä»¶ç³»ç»Ÿ] è„šæœ¬åŠ è½½å®Œæˆ v3.4.0')}const r=window.detentionSystem;if(r){console.info('[NPCç³»ç»Ÿ] å¼€å§‹åŠ è½½...');const e={surnames:{tier1:{names:['ç‹','æ','å¼ ','åˆ˜','é™ˆ','æ¨','é»„','èµµ','å´','å‘¨'],weight:35},tier2:{names:['å¾','å­™','é©¬','æœ±','èƒ¡','éƒ­','ä½•','æ—','é«˜','ç½—','éƒ‘','æ¢','è°¢','å®‹','å”','è®¸','éŸ©','å†¯','é‚“','æ›¹'],weight:30},tier3:{names:['å½­','æ›¾','è‚–','ç”°','è‘£','è¢','æ½˜','äº','è’‹','è”¡','ä½™','æœ','å¶','ç¨‹','è‹','é­','å•','ä¸','ä»»','æ²ˆ','å§š','å¢','å§œ','å´”','é’Ÿ','è°­','é™†','æ±ª','èŒƒ','é‡‘'],weight:20},tier4:{names:['çŸ³','å»–','è´¾','å¤','éŸ¦','ä»˜','æ–¹','ç™½','é‚¹','å­Ÿ','ç†Š','ç§¦','é‚±','æ±Ÿ','å°¹','è–›','é—«','æ®µ','é›·','ä¾¯','é¾™','å²','é™¶','é»','è´º','é¡¾','æ¯›','éƒ','é¾š','é‚µ'],weight:10},tier5:{names:['ä¸‡','è¦ƒ','æ­¦','ä¹”','ä¸¥','èµ–','æ–‡','æ´ª','å­£','è«','æ¬§é˜³','å¸é©¬','ä¸Šå®˜','è¯¸è‘›','ä¸œæ–¹'],weight:5}},givenNames:{vintage:{single:['èŠ³','ä¸½','å¨Ÿ','è‹±','å','ç‰','ç§€','ç','çº¢','æ¢…','å…°','éœ','ç‡•','è','é™'],double:[['ç§€','è‹±'],['ç§€','å…°'],['ç§€','ç'],['ç§€','èŠ³'],['ä¸½','å'],['ä¸½','å¨Ÿ'],['ä¸½','è'],['ä¸½','èŠ³'],['ç‰','å…°'],['ç‰','æ¢…'],['ç‰','å'],['ç‰','ç'],['æ˜¥','æ¢…'],['æ˜¥','å…°'],['æ˜¥','å'],['æ˜¥','ç‡•'],['å°','çº¢'],['å°','èŠ³'],['å°','ä¸½'],['å°','ç‡•']],weight:25},classic:{single:['å©·','æ´','è‰','æ•','è‰³','å¨œ','å€©','é›ª','ç³','é¢–','æ™¶','æ¬£','æ…§','ä½³','è–‡'],double:[['é›…','å©·'],['é›…','æ´'],['é›…','ç³'],['é›…','æ¬£'],['æ™“','ç‡•'],['æ™“','ä¸½'],['æ™“','çº¢'],['æ™“','éœ'],['æ–‡','é™'],['æ–‡','æ…§'],['æ–‡','å¨Ÿ'],['æ–‡','å©·'],['å¿—','çº¢'],['å¿—','å'],['å¿—','è‹±'],['å¿—','èŠ³'],['æµ·','ç‡•'],['æµ·','éœ'],['æµ·','è‹±'],['æµ·','ä¸½']],weight:35},modern:{single:['å©·','æ´','è‰','æ•','è‰³','å¨œ','å€©','é›ª','ç³','é¢–','æ™¶','æ¬£','æ…§','ä½³','è–‡','æ¶µ','è±','çª','ç‘¶','è¯—'],double:[['é›¨','å©·'],['é›¨','æ¬£'],['é›¨','æ¶µ'],['é›¨','è±'],['æ€','çª'],['æ€','æ¶µ'],['æ€','é›¨'],['æ€','é¢–'],['æ¢¦','çª'],['æ¢¦','ç‘¶'],['æ¢¦','æ¶µ'],['æ¢¦','è±'],['è¯—','æ¶µ'],['è¯—','çª'],['è¯—','é›¨'],['è¯—','å©·'],['æ¬£','æ€¡'],['æ¬£','æ‚¦'],['æ¬£','ç„¶'],['æ¬£','å¦']],weight:30},contemporary:{single:['æ¶µ','è±','çª','ç‘¶','è¯—','è¯­','é¦¨','å¦','å½¤','æ‚¦','ç„¶','æ€¡','å¯','ä¾','æ¢“'],double:[['æ¢“','æ¶µ'],['æ¢“','è±'],['æ¢“','çª'],['æ¢“','ç‘¶'],['å­','æ¶µ'],['å­','è±'],['å­','çª'],['å­','ç‘¶'],['é›¨','æ¡'],['é›¨','å½¤'],['é›¨','é¦¨'],['é›¨','è¯º'],['è¯—','è¯­'],['è¯—','æ¶µ'],['è¯—','é›¨'],['è¯—','çª'],['å¯','æ¬£'],['å¯','é¦¨'],['å¯','å¿ƒ'],['å¯','å„¿']],weight:10}},badNames:['å²çé¦™','èŒƒç»Ÿ','æœå­è…¾','èŒƒå‰‘','æœ±é€¸ç¾¤','ç§¦å¯¿ç”Ÿ','æœç¦ç‡•','é­ç”Ÿæ´¥','è´¹å½¦','æ®·é™','èŒƒå©‰','èƒ¡ä¸½æ™¶'],badChars:['å±','å°¿','ç²ª','æ­»','ä¸§','ç—…','æ®‹','åºŸ','è´±','å¥´','å¦“','å¨¼'],generate(e){let t=0;for(;t<50;){t++;const n=this.selectSurname()+this.selectGivenName(e);if(this.isValidName(n))return n}return'å¼ '+this.givenNames.classic.single[0]},selectSurname(){const e=Object.values(this.surnames),t=e.reduce((e,t)=>e+t.weight,0);let n=Math.random()*t;for(const t of e)if(n-=t.weight,n<=0)return t.names[Math.floor(Math.random()*t.names.length)];return this.surnames.tier1.names[0]},selectGivenName(e){const t=(new Date).getFullYear()-e,n=t>=50?'vintage':t>=35?'classic':t>=20?'modern':'contemporary',a=this.givenNames[n];if(Math.random()<.6&&a.double.length>0){const e=a.double[Math.floor(Math.random()*a.double.length)];return e[0]+e[1]}return a.single[Math.floor(Math.random()*a.single.length)]},isValidName(e){return!this.badNames.includes(e)&&!this.badChars.some(t=>e.includes(t))}},t={characterBookCrimes:['å±é™©é©¾é©¶ç½ª','ç›—çªƒç½ª','è¯ˆéª—ç½ª','æ•…æ„ä¼¤å®³ç½ª','èµ°ç§æ¯’å“ç½ª','è´©å–æ¯’å“ç½ª','è¿è¾“æ¯’å“ç½ª','åˆ¶é€ æ¯’å“ç½ª','äº¤é€šè‚‡äº‹ç½ª','å¯»è¡…æ»‹äº‹ç½ª','æŠ¢åŠ«ç½ª','æ•…æ„æ€äººç½ª','å¼€è®¾èµŒåœºç½ª','æ•²è¯ˆå‹’ç´¢ç½ª','è´ªæ±¡ç½ª','å—è´¿ç½ª','èšä¼—æ–—æ®´ç½ª','éæ³•æ‹˜ç¦ç½ª','å®¹ç•™ä»–äººå¸æ¯’ç½ª','æ©é¥°éšç’çŠ¯ç½ªæ‰€å¾—ç½ª','å¸®åŠ©ä¿¡æ¯ç½‘ç»œçŠ¯ç½ªæ´»åŠ¨ç½ª','èŒåŠ¡ä¾µå ç½ª'],crimes:{violent:{names:['æ•…æ„æ€äººç½ª','æ•…æ„ä¼¤å®³ç½ª','æŠ¢åŠ«ç½ª','ç»‘æ¶ç½ª','éæ³•æ‹˜ç¦ç½ª','èšä¼—æ–—æ®´ç½ª'],weight:12,sentenceRange:[3,20]},property:{names:['ç›—çªƒç½ª','è¯ˆéª—ç½ª','æŠ¢å¤ºç½ª','æ•²è¯ˆå‹’ç´¢ç½ª','èŒåŠ¡ä¾µå ç½ª','æŒªç”¨èµ„é‡‘ç½ª','è´ªæ±¡ç½ª','å—è´¿ç½ª','æ©é¥°éšç’çŠ¯ç½ªæ‰€å¾—ç½ª'],weight:35,sentenceRange:[1,15]},drug:{names:['è´©å–æ¯’å“ç½ª','è¿è¾“æ¯’å“ç½ª','åˆ¶é€ æ¯’å“ç½ª','èµ°ç§æ¯’å“ç½ª','éæ³•æŒæœ‰æ¯’å“ç½ª','å®¹ç•™ä»–äººå¸æ¯’ç½ª','å¼•è¯±ä»–äººå¸æ¯’ç½ª'],weight:20,sentenceRange:[3,15]},economic:{names:['éæ³•å¸æ”¶å…¬ä¼—å­˜æ¬¾ç½ª','é›†èµ„è¯ˆéª—ç½ª','åˆåŒè¯ˆéª—ç½ª','ä¿¡ç”¨å¡è¯ˆéª—ç½ª','æ´—é’±ç½ª','è™šå¼€å‘ç¥¨ç½ª','é€ƒç¨ç½ª'],weight:15,sentenceRange:[2,10]},social:{names:['å¯»è¡…æ»‹äº‹ç½ª','èšä¼—æ–—æ®´ç½ª','å¼€è®¾èµŒåœºç½ª','ç»„ç»‡å–æ·«ç½ª','ä¼ æ’­æ·«ç§½ç‰©å“ç½ª','å¦¨å®³å…¬åŠ¡ç½ª','å¸®åŠ©ä¿¡æ¯ç½‘ç»œçŠ¯ç½ªæ´»åŠ¨ç½ª'],weight:13,sentenceRange:[1,7]},other:{names:['äº¤é€šè‚‡äº‹ç½ª','å±é™©é©¾é©¶ç½ª','ç”Ÿäº§é”€å”®ä¼ªåŠ£äº§å“ç½ª','éæ³•ç»è¥ç½ª','æ±¡æŸ“ç¯å¢ƒç½ª','èµ°ç§ç½ª'],weight:5,sentenceRange:[1,5]}},generate(){if(Math.random()<.3){const e=this.characterBookCrimes[Math.floor(Math.random()*this.characterBookCrimes.length)],t=this.findCategoryByCrime(e);return{crime:e,sentence:this.generateSentence(t?t.sentenceRange:[1,10]),category:t||this.crimes.property}}const e=Object.values(this.crimes),t=e.reduce((e,t)=>e+t.weight,0);let n=Math.random()*t;for(const t of e)if(n-=t.weight,n<=0){return{crime:t.names[Math.floor(Math.random()*t.names.length)],sentence:this.generateSentence(t.sentenceRange),category:t}}return{crime:'ç›—çªƒç½ª',sentence:3,category:this.crimes.property}},findCategoryByCrime(e){for(const t of Object.keys(this.crimes)){const n=this.crimes[t];if(n.names.includes(e))return n}return null},generateSentence(e){const[t,n]=e;return Math.floor(Math.random()*(n-t+1))+t}},n={npcDatabase:[],currentCellNPCs:[],generate(e=1,t={}){const n=[];for(let a=0;a<e;a++){const e=this.generateSingle(t);n.push(e),this.npcDatabase.push(e)}return n},generateSingle(n={}){const a=r.getModule('eventSystem'),s=a?.getCurrentStageInfo?a.getCurrentStageInfo():{},i=this.generateAge(),o=(new Date).getFullYear()-i,l=e.generate(o),c=t.generate(),d=this.generateAppearance(i),h=this.generatePersonality(),g=this.generateBackground(i,c),u=this.generateRelationship(),p='string'==typeof s?.cellType?s.cellType:n.cellType||'transition';this.adjustByCellType(h,u,p);return{id:this.generateId(),name:l,gender:'female',age:i,crime:c.crime,sentence:c.sentence,appearance:d,personality:h,background:g,relationship:u,cellType:p,daysInCustody:Math.floor(365*Math.random())+30,status:'active',createdAt:Date.now()}},generateAge(){const e=Math.random();return e<.05?Math.floor(3*Math.random())+18:e<.25?Math.floor(10*Math.random())+21:e<.55?Math.floor(10*Math.random())+31:e<.8?Math.floor(10*Math.random())+41:e<.95?Math.floor(10*Math.random())+51:Math.floor(15*Math.random())+61},generateAppearance(e){const t=[150,155,160,165,170,175],n=[45,50,55,60,65,70,75],a=e>50?['çŸ­å‘','èŠ±ç™½çŸ­å‘','ç°ç™½çŸ­å‘','ç¨€ç–çŸ­å‘']:['é•¿å‘','çŸ­å‘','é©¬å°¾','é½è‚©å‘','æ³¢æµªå·','ç›´å‘','å·å‘'],s=['ç™½çš™','åç™½','è‡ªç„¶','åé»‘','é»é»‘'],i=['æ¸…ç§€','æ™®é€š','æ†”æ‚´','ç²¾è‡´','æ²§æ¡‘','å§£å¥½','ç«¯åº„'];return{height:t[Math.floor(Math.random()*t.length)],weight:n[Math.floor(Math.random()*n.length)],hair:a[Math.floor(Math.random()*a.length)],eyes:'é»‘è‰²',skin:s[Math.floor(Math.random()*s.length)],features:i[Math.floor(Math.random()*i.length)]}},generatePersonality(){const e={aggression:Math.floor(100*Math.random()),sociability:Math.floor(100*Math.random()),intelligence:Math.floor(100*Math.random()),emotional:Math.floor(100*Math.random()),dominance:Math.floor(100*Math.random()),kindness:Math.floor(100*Math.random())},t=[];return e.aggression>70&&t.push('æš´åŠ›å€¾å‘'),e.sociability>70&&t.push('å–„äºäº¤é™…'),e.intelligence>70&&t.push('èªæ˜'),e.emotional>70&&t.push('æƒ…ç»ªåŒ–'),e.dominance>70&&t.push('å¼ºåŠ¿'),e.kindness>70&&t.push('å–„è‰¯'),e.aggression<30&&t.push('æ¸©å’Œ'),e.sociability<30&&t.push('å­¤åƒ»'),e.emotional<30&&t.push('å†·é™'),e.dominance<30&&t.push('é¡ºä»'),{traits:e,tags:t}},generateBackground(e,t){const n=['å°å­¦','åˆä¸­','é«˜ä¸­','ä¸­ä¸“','å¤§ä¸“','æœ¬ç§‘','ç ”ç©¶ç”Ÿ'],a=this.weightedRandom(n.length,[10,25,30,15,10,8,2]),s=['æœªå©š','å·²å©š','ç¦»å¼‚','ä¸§å¶'],i=e<25?[80,15,5,0]:e<40?[20,60,15,5]:[10,50,30,10],o=this.weightedRandom(s.length,i),r='æœªå©š'!==s[o]&&Math.random()<.7,l=r?Math.floor(3*Math.random())+1:0;return{education:n[a],maritalStatus:s[o],hasChildren:r,childrenCount:l,hometown:this.generateHometown(),priorConvictions:Math.random()<.3?Math.floor(3*Math.random())+1:0}},generateHometown(){const e=['æ²³å—','å±±ä¸œ','å››å·','å¹¿ä¸œ','æ±Ÿè‹','æ²³åŒ—','æ¹–å—','å®‰å¾½','æ¹–åŒ—','æµ™æ±Ÿ','å¹¿è¥¿','äº‘å—','æ±Ÿè¥¿','è¾½å®','é»‘é¾™æ±Ÿ','é™•è¥¿','ç¦å»º','å±±è¥¿','è´µå·','é‡åº†'];return e[Math.floor(Math.random()*e.length)]},generateRelationship:()=>({toProtagonist:50,faction:null,allies:[],enemies:[],influence:Math.floor(100*Math.random())}),adjustByCellType(e,t,n){'transition'===n?(e.traits.emotional+=10,t.influence-=20):'pretrial'===n?(e.traits.emotional+=15,e.traits.aggression+=5):'convicted'===n&&(e.traits.emotional-=10,e.traits.aggression+=10,t.influence+=10),Object.keys(e.traits).forEach(t=>{e.traits[t]=Math.max(0,Math.min(100,e.traits[t]))}),t.influence=Math.max(0,Math.min(100,t.influence))},weightedRandom(e,t){const n=t.reduce((e,t)=>e+t,0);let a=Math.random()*n;for(let n=0;n<e;n++)if(a-=t[n],a<=0)return n;return e-1},generateId:()=>'npc_'+Date.now()+'_'+Math.random().toString(36).slice(2,11),generateForEvent(e){return'interrogation'===e?this.generatePolice():'lawyer_visit'===e?this.generateLawyer():'family_visit'===e?this.generateFamily():'medical_visit'===e?this.generateDoctor():'scene_identification'===e?{police:this.generatePolice(),witnesses:this.generate(2,{type:'witness'})}:this.generateSingle({eventType:e})},generatePolice(){const t=Math.floor(20*Math.random())+25,n=(new Date).getFullYear()-t,a=e.generate(n),s=['æ°‘è­¦','è­¦é•¿','å‰¯é˜Ÿé•¿','é˜Ÿé•¿'],i=s[Math.floor(Math.random()*s.length)];return{id:this.generateId(),name:a,gender:'female',age:t,role:'police',rank:i,appearance:this.generateAppearance(t),personality:{traits:{aggression:Math.floor(30*Math.random())+40,sociability:Math.floor(40*Math.random())+30,intelligence:Math.floor(30*Math.random())+50,emotional:Math.floor(40*Math.random())+20,dominance:Math.floor(30*Math.random())+60,kindness:Math.floor(60*Math.random())+20},tags:['ä¸¥è‚ƒ','ä¸“ä¸š']},attitude:Math.floor(40*Math.random())+30,crime:'â€”â€”',sentence:0,background:this.generateBackground(t,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'staff',daysInCustody:0,status:'active',createdAt:Date.now()}},generateLawyer(){const t=Math.floor(25*Math.random())+28,n=(new Date).getFullYear()-t,a=Math.random()<.8,s=e.generate(n),i=['æ³•å¾‹æ´åŠ©å¾‹å¸ˆ','ç§äººå¾‹å¸ˆ','çŸ¥åå¾‹å¸ˆ'],o=this.weightedRandom(i.length,[50,40,10]);return{id:this.generateId(),name:s,gender:a?'female':'male',age:t,role:'lawyer',type:i[o],appearance:this.generateAppearance(t),personality:{traits:{aggression:Math.floor(20*Math.random())+20,sociability:Math.floor(30*Math.random())+60,intelligence:Math.floor(20*Math.random())+70,emotional:Math.floor(40*Math.random())+30,dominance:Math.floor(40*Math.random())+40,kindness:Math.floor(40*Math.random())+40},tags:['ä¸“ä¸š','ç†æ€§']},experience:Math.floor(20*Math.random())+5,successRate:Math.floor(40*Math.random())+40,crime:'â€”â€”',sentence:0,background:this.generateBackground(t,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},generateFamily(){const t=['æ¯äº²','çˆ¶äº²','ä¸ˆå¤«','å¦»å­','å§å§','å¦¹å¦¹','å¥³å„¿','å„¿å­'],n=t[this.weightedRandom(t.length,[30,20,15,10,10,10,3,2])];let a=40,s=!0;'æ¯äº²'===n?(a=Math.floor(20*Math.random())+45,s=!0):'çˆ¶äº²'===n?(a=Math.floor(20*Math.random())+45,s=!1):'ä¸ˆå¤«'===n?(a=Math.floor(30*Math.random())+25,s=!1):'å¦»å­'===n?(a=Math.floor(30*Math.random())+25,s=!0):'å§å§'===n||'å¦¹å¦¹'===n?(a=Math.floor(30*Math.random())+20,s=!0):'å¥³å„¿'===n?(a=Math.floor(15*Math.random())+5,s=!0):'å„¿å­'===n&&(a=Math.floor(15*Math.random())+5,s=!1);const i=(new Date).getFullYear()-a,o=e.generate(i);return{id:this.generateId(),name:o,gender:s?'female':'male',age:a,role:'family',relation:n,appearance:this.generateAppearance(a),personality:{traits:{aggression:Math.floor(30*Math.random())+10,sociability:Math.floor(50*Math.random())+30,intelligence:Math.floor(60*Math.random())+30,emotional:Math.floor(50*Math.random())+40,dominance:Math.floor(50*Math.random())+20,kindness:Math.floor(30*Math.random())+60},tags:['å…³å¿ƒ','æ‹…å¿§']},supportLevel:Math.floor(40*Math.random())+60,crime:'â€”â€”',sentence:0,background:this.generateBackground(a,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},generateDoctor(){const t=Math.floor(25*Math.random())+30,n=(new Date).getFullYear()-t,a=e.generate(n),s=['å†…ç§‘','å¤–ç§‘','ç²¾ç¥ç§‘','å¦‡ç§‘','æ€¥è¯Šç§‘'],i=s[Math.floor(Math.random()*s.length)];return{id:this.generateId(),name:a,gender:'female',age:t,role:'doctor',specialty:i,appearance:this.generateAppearance(t),personality:{traits:{aggression:Math.floor(20*Math.random())+10,sociability:Math.floor(40*Math.random())+40,intelligence:Math.floor(20*Math.random())+70,emotional:Math.floor(40*Math.random())+30,dominance:Math.floor(40*Math.random())+40,kindness:Math.floor(30*Math.random())+60},tags:['ä¸“ä¸š','å†·é™']},experience:Math.floor(25*Math.random())+5,crime:'â€”â€”',sentence:0,background:this.generateBackground(t,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},getCurrentCellNPCs(){return this.currentCellNPCs},setCurrentCellNPCs(e){this.currentCellNPCs=e,r.events.emit('cell_npcs_changed',{npcs:e})},addNPCToCell(e){this.currentCellNPCs.push(e),r.events.emit('npc_joined_cell',{npc:e})},removeNPCFromCell(e){const t=this.currentCellNPCs.findIndex(t=>t.id===e);if(-1!==t){const e=this.currentCellNPCs.splice(t,1)[0];return r.events.emit('npc_left_cell',{npc:e}),e}return null},findNPCById(e){return this.npcDatabase.find(t=>t.id===e)||this.currentCellNPCs.find(t=>t.id===e)},updateRelationship(e,t){const n=this.findNPCById(e);n&&n.relationship&&(n.relationship.toProtagonist=Math.max(0,Math.min(100,n.relationship.toProtagonist+t)),r.events.emit('relationship_changed',{npcId:e,npcName:n.name,value:n.relationship.toProtagonist,delta:t}))},exportData(){return{database:this.npcDatabase,currentCell:this.currentCellNPCs}},importData(e){if(!e)return!1;try{return this.npcDatabase=e.database||[],this.currentCellNPCs=e.currentCell||[],console.info('[NPCç³»ç»Ÿ] æ•°æ®å¯¼å…¥æˆåŠŸ'),!0}catch(e){return console.error('[NPCç³»ç»Ÿ] æ•°æ®å¯¼å…¥å¤±è´¥:',e),!1}},clearData(){this.npcDatabase=[],this.currentCellNPCs=[],console.info('[NPCç³»ç»Ÿ] æ•°æ®å·²æ¸…ç©º')}};r.generateNPC=(e,t)=>n.generate(e,t??{}),r.generateNPCForEvent=e=>n.generateForEvent(e),r.getCurrentCellNPCs=()=>n.getCurrentCellNPCs(),r.setCurrentCellNPCs=e=>n.setCurrentCellNPCs(e),r.addNPCToCell=e=>n.addNPCToCell(e),r.removeNPCFromCell=e=>n.removeNPCFromCell(e),r.findNPC=e=>n.findNPCById(e),r.updateNPCRelationship=(e,t)=>n.updateRelationship(e,t),r.exportNPCData=()=>n.exportData(),r.importNPCData=e=>n.importData(e),r.registerModule('npcSystem',n),r.events.on('event_triggered',e=>{const t='string'==typeof e?.id?e.id:void 0;if(t&&['interrogation','lawyer_visit','family_visit','medical_visit','scene_identification'].includes(t)){const a=n.generateForEvent(t);r.events.emit('event_npc_generated',{event:e,npc:a})}}),r.events.on('cell_transfer',e=>{const t=e?.to,a='string'==typeof t?t:'transition',s=Math.floor(5*Math.random())+3,i=n.generate(s,{cellType:a});n.setCurrentCellNPCs(i),console.info(`[NPCç³»ç»Ÿ] ç›‘å®¤è½¬ç§»ï¼Œç”Ÿæˆ${s}ä¸ªæ–°å¥³æ€§å›šçŠ¯NPC`)}),console.info('[NPCç³»ç»Ÿ] è„šæœ¬åŠ è½½å®Œæˆ - å¥³æ€§çœ‹å®ˆæ‰€ç‰ˆæœ¬')}else console.error('[NPCç³»ç»Ÿ] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½');const l={detention_rules:{name:'detention_rules',displayName:'æ ¸å¿ƒè§„åˆ™åº“',description:'çœ‹å®ˆæ‰€åŸºæœ¬è§„èŒƒã€ç®¡ç†åˆ¶åº¦ã€è¿è§„å¤„ç½šæœºåˆ¶ç­‰æ ¸å¿ƒè§„åˆ™',priority:10,keywords:['ç›‘è§„','å¤„ç½š','çºªå¾‹','è§„å®š','è¿è§„','ç®¡æ•™','æŠ¥å‘Š','ç®¡ç†åˆ¶åº¦','åŸºæœ¬è§„èŒƒ','è¿è§„å¤„ç½š','çœ‹å®ˆæ‰€è§„åˆ™','ç›‘ç®¡åˆ¶åº¦','è¿å','å¤„åˆ†','è­¦å‘Š','ç¦é—­','æ‰£åˆ†','è€ƒæ ¸'],autoLoad:!0,position:'before_char',depth:4,fallbackEntries:[]},internal_basic_procedures:{name:'internal_basic_procedures',displayName:'ç”Ÿæ´»ç»†èŠ‚åº“',description:'å…¥æ‰€æœèº«ã€åƒé¥­ã€æ´—æ¾¡ã€å®¡è®¯ç­‰æ—¥å¸¸ç”Ÿæ´»æµç¨‹çš„è¯¦ç»†æè¿°',priority:9,keywords:['åƒé¥­','æ´—æ¾¡','ç¡è§‰','å¦‚å•','å®¡è®¯','ä¼šè§','æ”¾é£','ç‚¹å','åŠ³åŠ¨','å…¥æ‰€','æœèº«','æ—¥å¸¸ç”Ÿæ´»','ç”Ÿæ´»æµç¨‹','æ—¥å¸¸æµç¨‹','ç”Ÿæ´»ç»†èŠ‚','èµ·åºŠ','æ´—æ¼±','ç”¨é¤','å°±å¯','ä½“æ£€','ç™»è®°','åˆ†é…'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]},internal_basic_legal:{name:'internal_basic_legal',displayName:'æ³•å¾‹ç»†èŠ‚åº“',description:'è¯¦ç»†çš„å¸æ³•æµç¨‹ï¼ŒåŒ…æ‹¬é€®æ•ã€èµ·è¯‰ã€ä¸€å®¡ã€äºŒå®¡ã€æ­»åˆ‘å¤æ ¸ã€æ­»åˆ‘æ‰§è¡Œï¼ˆæªå†³/æ³¨å°„/ç»åˆ‘ï¼‰ç­‰ï¼Œè¿˜åŒ…æ‹¬æ³•å¾‹æ–‡ä¹¦æ ·æœ¬ã€ç¨‹åºæ€§è¯è¯­æ¨¡æ¿',priority:8,keywords:['æ‰¹æ•','èµ·è¯‰','å¼€åº­','åˆ¤å†³','æ‰§è¡Œ','å¾‹å¸ˆ','å–ä¿','ä¿é‡Š','é€®æ•','ä¸€å®¡','äºŒå®¡','æ­»åˆ‘å¤æ ¸','æ­»åˆ‘æ‰§è¡Œ','æªå†³','æ³¨å°„','ç»åˆ‘','å¸æ³•æµç¨‹','æ³•å¾‹æ–‡ä¹¦','ç¨‹åºæ€§è¯è¯­','ç¨‹åºæ€§','å¸æ³•ç¨‹åº','æ£€å¯Ÿé™¢','æ³•é™¢','æ³•å®˜','æ£€å¯Ÿå®˜','è¾©æŠ¤','ä¸Šè¯‰','ç»ˆå®¡'],autoLoad:!1,position:'before_char',depth:4,fallbackEntries:[]},legal_knowledge:{name:'legal_knowledge',displayName:'ä¸“ä¸šçŸ¥è¯†åº“',description:'è¯¦ç»†æ³•å¾‹æ¡æ–‡ã€é‡åˆ‘æ ‡å‡†ã€å¸æ³•ç¨‹åº',priority:7,keywords:['ç½ªå','é‡åˆ‘','æ³•å¾‹','åˆ‘æ³•','åˆ‘æœŸ','ç¼“åˆ‘','å‡é‡Š','æ³•å¾‹æ¡æ–‡','é‡åˆ‘æ ‡å‡†','å¸æ³•ç¨‹åº','åˆ‘æ³•æ¡æ–‡','æ³•å¾‹ä¾æ®','ä»è½»','ä»é‡','å‡è½»','åŠ é‡','ç´¯çŠ¯','è‡ªé¦–','ç«‹åŠŸ','è®¤ç½ªè®¤ç½š'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]},environment_descriptions:{name:'environment_descriptions',displayName:'ç¯å¢ƒæå†™åº“',description:'å„åœºæ‰€çš„è¯¦ç»†ç¯å¢ƒæå†™æ¨¡æ¿ï¼ŒåŒ…å«æªå†³ã€æ³¨å°„ã€ç»åˆ‘ä¸‰ç§æ‰§è¡Œæ–¹å¼çš„ä¸åŒåˆ‘åœºç¯å¢ƒ',priority:6,keywords:['ç›‘å®¤','å®¡è®¯å®¤','ä¼šè§å®¤','ç¦é—­å®¤','æ³•é™¢','åˆ‘åœº','èµ°å»Š','é“é—¨','ç¯å¢ƒæå†™','åœºæ‰€','åˆ‘åœºç¯å¢ƒ','æ‰§è¡Œæ–¹å¼','æªå†³','æ³¨å°„','ç»åˆ‘','çœ‹å®ˆæ‰€','ç›‘ç‹±','æ³•åº­','ç¾æŠ¼å®¤','æå®¡å®¤','åŒ»åŠ¡å®¤','é£Ÿå ‚','æ“åœº'],autoLoad:!1,position:'before_char',depth:4,fallbackEntries:[]},narrative_enhancements:{name:'narrative_enhancements',displayName:'å™äº‹å¢å¼ºåº“',description:'è½¬æŠ˜ã€å›å¿†ã€æ¢¦å¢ƒã€åè½¬ç­‰å™äº‹å¢å¼ºåŠŸèƒ½',priority:5,keywords:['è½¬æŠ˜','å›å¿†','æ¢¦å¢ƒ','åè½¬','é«˜æ½®','å¿ƒç†','æƒ…ç»ª','å™äº‹å¢å¼º','å™äº‹','å›å¿†æ€','æ¢¦å¢ƒ','å¹»è§‰','é—ªå›','å†…å¿ƒ','æ€ç»ª','æƒ…æ„Ÿ','æ„Ÿå—','æƒ³æ³•','æ€è€ƒ','åæ€'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]}};console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] v5.1.0 å¯åŠ¨...'),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:190',message:'çŸ¥è¯†åº“åŠ è½½å™¨å¼€å§‹åŠ è½½',data:{hasDetentionSystem:!!window.detentionSystem,detentionSystemType:typeof window.detentionSystem},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});const c=window.detentionSystem;if(c){fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:199',message:'æ ¸å¿ƒç³»ç»Ÿå·²æ‰¾åˆ°',data:{version:c.version,initialized:c.initialized,hasEvents:!!c.events,moduleCount:Object.keys(c.modules||{}).length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{}),c.characterId='detention_center',console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²è®¾ç½®è§’è‰²æ ‡è¯†');const e={loaded:new Map,loading:new Map,initialized:!1,fallbackMode:!1,characterWorldbookId:null,async findCharacterWorldbook(){console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æŸ¥æ‰¾è§’è‰²ä¸“å±ä¸–ç•Œä¹¦...');try{const e=getCharWorldbookNames('current');return e.primary?(console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰¾åˆ°è§’è‰²ä¸»ä¸–ç•Œä¹¦: ${e.primary}`),this.characterWorldbookId=e.primary,e.primary):e.additional.length>0?(console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰¾åˆ°è§’è‰²é™„åŠ ä¸–ç•Œä¹¦: ${e.additional[0]}`),this.characterWorldbookId=e.additional[0],e.additional[0]):(console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  æœªæ‰¾åˆ°è§’è‰²ä¸“å±ä¸–ç•Œä¹¦'),null)}catch(e){return console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] æŸ¥æ‰¾è§’è‰²ä¸–ç•Œä¹¦å¤±è´¥:',e),null}},async loadWorldbook(e){const t=l[e];if(!t)throw new Error(`æœªçŸ¥çš„çŸ¥è¯†åº“: ${e}`);if(this.loaded.has(e))return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] ${t.displayName} å·²åŠ è½½ï¼Œè·³è¿‡`),this.loaded.get(e);if(this.loading.has(e))return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] ${t.displayName} æ­£åœ¨åŠ è½½ï¼Œç­‰å¾…...`),await this.loading.get(e);const n=this._loadWorldbookInternal(e,t);this.loading.set(e,n);try{const t=await n;return this.loaded.set(e,t),t}finally{this.loading.delete(e)}},async _loadWorldbookInternal(e,t){console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] å¼€å§‹åŠ è½½: ${t.displayName} (${e})`),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:274',message:'å¼€å§‹åŠ è½½ä¸–ç•Œä¹¦',data:{bookName:e,displayName:t.displayName,priority:t.priority},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});try{const n=getWorldbookNames();fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:279',message:'è·å–ä¸–ç•Œä¹¦åç§°åˆ—è¡¨',data:{count:n.length,names:n.slice(0,10),targetDisplayName:t.displayName,targetName:t.name},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});let a=null;const s=n.find(e=>e===t.displayName);if(s)a=s,console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ç²¾ç¡®åŒ¹é…ä¸­æ–‡åç§°: "${t.displayName}"`);else if(n.includes(t.name))a=t.name,console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ç²¾ç¡®åŒ¹é…è‹±æ–‡æ ‡è¯†: "${t.name}"`);else{const e=n.find(e=>e.includes(t.displayName)||t.displayName.includes(e)||e.includes(t.name)||t.name.includes(e));e&&(a=e,console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ¨¡ç³ŠåŒ¹é…: "${e}"`))}if(!a){const a=n.join(', ');throw fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:309',message:'ä¸–ç•Œä¹¦åŒ¹é…å¤±è´¥',data:{bookName:e,displayName:t.displayName,availableCount:n.length,availableNames:n},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{}),new Error(`æœªæ‰¾åˆ°ä¸–ç•Œä¹¦: ${t.displayName} (${e})\nå¯ç”¨çš„ä¸–ç•Œä¹¦: ${a}\næç¤º: è¯·ç¡®ä¿çŸ¥è¯†åº“åç§°ä¸é…ç½®ä¸­çš„ displayName æˆ– name åŒ¹é…`)}fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:318',message:'ä¸–ç•Œä¹¦åŒ¹é…æˆåŠŸ',data:{bookName:e,targetWorldbookName:a,displayName:t.displayName},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});const i=await getWorldbook(a);if(0===i.length)throw new Error('ä¸–ç•Œä¹¦ä¸ºç©º');const o=getCharWorldbookNames('current');return o.additional.includes(a)||(await rebindCharWorldbooks('current',{primary:o.primary,additional:[...o.additional,a]}),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²ç»‘å®šåˆ°è§’è‰²å¡: ${a}`)),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ${t.displayName} åŠ è½½æˆåŠŸ (${i.length} æ¡ç›®)`),{name:e,displayName:t.displayName,entries:i,fallback:!1,loadedAt:Date.now()}}catch(n){const a=n instanceof Error?n.message:String(n);if(console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  ${t.displayName} åŠ è½½å¤±è´¥:`,a),t.fallbackEntries&&t.fallbackEntries.length>0)return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  ${t.displayName} ä½¿ç”¨é™çº§ç‰ˆæœ¬ (${t.fallbackEntries.length} æ¡ç›®)`),this.fallbackMode=!0,{name:e,displayName:t.displayName,entries:t.fallbackEntries,fallback:!0,error:a,loadedAt:Date.now()};throw n}},async predictiveCache(e){if(!e||'string'!=typeof e)return;console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰§è¡Œé¢„æµ‹æ€§ç¼“å­˜...');const t=[];for(const n in l){const a=l[n];if(this.loaded.has(n))continue;let s=0,i=0;for(const t of a.keywords)if(e.includes(t)){s++;i+=t.length>=3?2:1,a.description&&a.description.includes(t)&&(i+=1)}if(a.description){const t=a.description.match(/[\u4e00-\u9fa5]{2,}/g)||[];for(const n of t)e.includes(n)&&n.length>=2&&(i+=.5)}if(s>0){const e=10*a.priority+i;t.push({bookName:n,score:s,priority:a.priority,weightedScore:e})}}t.sort((e,t)=>Math.abs(t.weightedScore-e.weightedScore)>1?t.weightedScore-e.weightedScore:t.priority!==e.priority?t.priority-e.priority:t.score-e.score),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹éœ€è¦åŠ è½½ ${t.length} ä¸ªçŸ¥è¯†åº“`);const n=t.filter(e=>e.weightedScore>10).slice(0,3);if(0!==n.length)for(const e of n){console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹æ€§åŠ è½½: ${l[e.bookName].displayName} (åŒ¹é…å…³é”®è¯: ${e.score}, ç»¼åˆè¯„åˆ†: ${e.weightedScore.toFixed(1)})`);try{await this.loadWorldbook(e.bookName)}catch(t){console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹æ€§åŠ è½½å¤±è´¥: ${e.bookName}`,t)}}else console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æœªæ‰¾åˆ°è¶³å¤ŸåŒ¹é…çš„çŸ¥è¯†åº“ï¼Œè·³è¿‡é¢„æµ‹æ€§åŠ è½½')},getRelevantEntries(e,t=5){if(!e||'string'!=typeof e)return[];const n=[];this.loaded.forEach((e,t)=>{if(e.entries&&Array.isArray(e.entries))for(const a of e.entries)n.push({entry:a,bookName:t,bookDisplayName:e.displayName,priority:l[t]?.priority||0})});const a=n.map(t=>{let n=0;const a=t.entry,s=a.keys||a.key||[];for(const t of s)if(e.includes(t)){n+=t.length>=3?15:10,a.name&&a.name.includes(t)&&(n+=5)}if(a.name&&e.includes(a.name)&&(n+=20),a.content){const t=a.content.substring(0,100);e.includes(t.substring(0,10))&&(n+=3)}return n+=t.priority||0,a.constant&&(n+=30),{entry:t.entry,score:n,bookName:t.bookName,bookDisplayName:t.bookDisplayName}});a.sort((e,t)=>{if(Math.abs(t.score-e.score)>5)return t.score-e.score;const n=l[e.bookName]?.priority||0;return(l[t.bookName]?.priority||0)-n});const s=a.filter(e=>e.score>0).slice(0,t).map(e=>e.entry);return s.length>0&&console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰¾åˆ° ${s.length} ä¸ªç›¸å…³æ¡ç›® (æœ€é«˜åˆ†: ${a[0]?.score||0}, æ¥æº: ${a[0]?.bookDisplayName||'æœªçŸ¥'})`),s},async dynamicLoad(e){if(!e||'string'!=typeof e||e.length<3)return;console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰§è¡ŒåŠ¨æ€åŠ è½½...');const t=[];for(const n in l){const a=l[n];if(this.loaded.has(n))continue;let s=0,i='',o=0;for(const t of a.keywords)e.includes(t)&&(s++,t.length>o&&(o=t.length,i=t));if(s>0){const e=10*a.priority+2*s+o;t.push({bookName:n,keyword:i,priority:a.priority,matchCount:s,score:e})}}if(0===t.length)return void console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æœªè§¦å‘åŠ¨æ€åŠ è½½');t.sort((e,t)=>Math.abs(t.score-e.score)>2?t.score-e.score:t.priority-e.priority),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] è§¦å‘ ${t.length} ä¸ªçŸ¥è¯†åº“çš„åŠ¨æ€åŠ è½½`);const n=t.slice(0,3);for(const e of n){console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] åŠ¨æ€åŠ è½½: ${l[e.bookName].displayName} (è§¦å‘è¯: ${e.keyword}, åŒ¹é…æ•°: ${e.matchCount}, è¯„åˆ†: ${e.score})`);try{await this.loadWorldbook(e.bookName)}catch(t){console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] åŠ¨æ€åŠ è½½å¤±è´¥: ${e.bookName}`,t)}}},getStatus(){const e={initialized:this.initialized,fallbackMode:this.fallbackMode,characterWorldbook:this.characterWorldbookId,loaded:[],loading:[],available:[]};this.loaded.forEach((t,n)=>{e.loaded.push({name:n,displayName:t.displayName,entries:t.entries.length,fallback:t.fallback,error:t.error,loadedAt:new Date(t.loadedAt).toLocaleTimeString()})}),this.loading.forEach((t,n)=>{e.loading.push({name:n,displayName:l[n]?.displayName||n})});for(const t in l)this.loaded.has(t)||this.loading.has(t)||e.available.push({name:t,displayName:l[t].displayName,autoLoad:l[t].autoLoad});return e},async unloadWorldbook(e){if(!this.loaded.has(e))return void console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] ${e} æœªåŠ è½½`);console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] å¸è½½: ${l[e]?.displayName||e}`);const t=getCharWorldbookNames('current');if(this.loaded.get(e)){const n=getWorldbookNames().find(t=>t===e||t.includes(e));if(n){const e=t.additional.filter(e=>e!==n);await rebindCharWorldbooks('current',{primary:t.primary,additional:e})}}this.loaded.delete(e)},async reloadWorldbook(e){return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] é‡æ–°åŠ è½½: ${l[e]?.displayName||e}`),await this.unloadWorldbook(e),await this.loadWorldbook(e)},async initialize(){if(fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:738',message:'å¼€å§‹åˆå§‹åŒ–',data:{alreadyInitialized:this.initialized,fallbackMode:this.fallbackMode},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{}),this.initialized)return void console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] åˆå§‹åŒ–...'),await this.findCharacterWorldbook();let e=0,t=[];for(;e<40;){try{if(t=getWorldbookNames(),t.length>0){console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ä¸–ç•Œä¹¦åˆ—è¡¨å·²å°±ç»ª (${t.length} ä¸ª)`),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] å¯ç”¨ä¸–ç•Œä¹¦: ${t.join(', ')}`);break}}catch(e){}console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] ç­‰å¾…ä¸–ç•Œä¹¦åˆ—è¡¨... (${e+1}/40)`),await new Promise(e=>setTimeout(e,500)),e++}console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å·²é…ç½®çš„çŸ¥è¯†åº“:');for(const e in l){const n=l[e],a=t.some(e=>e===n.displayName||e===n.name||e.includes(n.displayName));console.info(`  - ${n.displayName} (${e}): ä¼˜å…ˆçº§=${n.priority}, è‡ªåŠ¨åŠ è½½=${n.autoLoad?'æ˜¯':'å¦'}, å¯ç”¨=`+(a?'âœ“':'âœ—'))}const n=[];for(const e in l)l[e].autoLoad&&n.push(e);console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] éœ€è¦è‡ªåŠ¨åŠ è½½ ${n.length} ä¸ªçŸ¥è¯†åº“`);for(const e of n)try{await this.loadWorldbook(e)}catch(t){console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] è‡ªåŠ¨åŠ è½½å¤±è´¥: ${e}`,t)}this.initialized=!0;const a=this.getStatus();if(console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ åˆå§‹åŒ–å®Œæˆ'),console.table(a.loaded),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:801',message:'åˆå§‹åŒ–å®Œæˆ',data:{loadedCount:a.loaded.length,loadingCount:a.loading.length,availableCount:a.available.length,fallbackMode:this.fallbackMode},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{}),this.fallbackMode){console.warn('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'),console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  å·²è¿›å…¥é™çº§æ¨¡å¼'),console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  éƒ¨åˆ†çŸ¥è¯†åº“ä½¿ç”¨äº†å†…ç½®é™çº§æ•°æ®'),console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  è„šæœ¬å°†è‡ªåŠ¨é€€å‡ºï¼Œäº¤ç”±è§’è‰²å¡å¤„ç†'),console.warn('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');const e=a.loaded.filter(e=>e.fallback);console.table(e),setTimeout(()=>{console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] é™çº§æ¨¡å¼ï¼šå¼€å§‹è‡ªåŠ¨å¸è½½...'),this.shutdown()},3e3)}else console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰€æœ‰çŸ¥è¯†åº“æ­£å¸¸åŠ è½½ï¼Œè„šæœ¬ä¿æŒè¿è¡Œ')},shutdown(){console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰§è¡Œå…³é—­æµç¨‹...'),this.loaded.clear(),this.loading.clear(),c&&(delete c.loadWorldbook,delete c.unloadWorldbook,delete c.reloadWorldbook,delete c.predictiveCache,delete c.getRelevantEntries,delete c.getWorldbookStatus,delete c.dynamicLoad),this.initialized=!1,this.fallbackMode=!1,console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²å®Œå…¨å¸è½½ï¼Œäº¤ç”±è§’è‰²å¡å¤„ç†'),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] è„šæœ¬ç”Ÿå‘½å‘¨æœŸç»“æŸ')}};c.loadWorldbook=t=>e.loadWorldbook(t),c.unloadWorldbook=t=>e.unloadWorldbook(t),c.reloadWorldbook=t=>e.reloadWorldbook(t),c.predictiveCache=t=>e.predictiveCache(t),c.dynamicLoad=t=>e.dynamicLoad(t),c.getRelevantEntries=(t,n)=>e.getRelevantEntries(t,n),c.getWorldbookStatus=()=>e.getStatus(),c.registerModule('worldbook',e),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²æ³¨å†Œåˆ°æ ¸å¿ƒç³»ç»Ÿ'),c.events.on('event_triggered',t=>{const n=t;n?.description&&e.predictiveCache(n.description).catch(e=>{console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹æ€§ç¼“å­˜å¤±è´¥:',e)})}),c.events.on('user_input',t=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:899',message:'æ”¶åˆ°ç”¨æˆ·è¾“å…¥äº‹ä»¶',data:{hasData:!!t,dataType:typeof t,textLength:'string'==typeof t?.text?t.text?.length:0,initialized:e.initialized},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});const n=t;n?.text&&n.text.length>5&&(fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:905',message:'è§¦å‘åŠ¨æ€åŠ è½½',data:{textLength:n.text.length,textPreview:n.text.substring(0,50)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{}),e.dynamicLoad(n.text).catch(e=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:908',message:'åŠ¨æ€åŠ è½½å¤±è´¥',data:{error:e instanceof Error?e.message:String(e)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{}),console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] åŠ¨æ€åŠ è½½å¤±è´¥:',e)}))}),$(()=>{console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å‡†å¤‡åˆå§‹åŒ–...'),setTimeout(async()=>{console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å¼€å§‹è‡ªåŠ¨åˆå§‹åŒ–...');try{await e.initialize(),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ è‡ªåŠ¨åˆå§‹åŒ–å®Œæˆ')}catch(e){console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ— è‡ªåŠ¨åˆå§‹åŒ–å¤±è´¥:',e),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] ğŸ’¡ è¯·æ‰‹åŠ¨æ‰§è¡Œ: window.initWorldbookLoader()')}},2e3)}),window.initWorldbookLoader=async function(){if(console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰‹åŠ¨åˆå§‹åŒ–...'),e.initialized)return console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å·²ç»åˆå§‹åŒ–è¿‡äº†'),e.getStatus();try{return await e.initialize(),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰‹åŠ¨åˆå§‹åŒ–å®Œæˆ'),e.getStatus()}catch(e){throw console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ— æ‰‹åŠ¨åˆå§‹åŒ–å¤±è´¥:',e),e}},console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ è„šæœ¬åŠ è½½å®Œæˆ'),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] ğŸ’¡ å¦‚éœ€æ‰‹åŠ¨åˆå§‹åŒ–ï¼Œè¯·æ‰§è¡Œ: window.initWorldbookLoader()')}else console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½'),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:195',message:'æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½é”™è¯¯',data:{windowKeys:Object.keys(window).filter(e=>e.includes('detention')||e.includes('Detention'))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});console.info('[çœ‹å®ˆæ‰€æ¨¡æ‹Ÿå™¨] è„šæœ¬æ–‡ä»¶å·²åŠ è½½ï¼Œå¼€å§‹æ‰§è¡Œ...'),console.info('[çœ‹å®ˆæ‰€æ¨¡æ‹Ÿå™¨] æ‰€æœ‰æ¨¡å—å·²åŠ è½½å®Œæˆ');
//# sourceMappingURL=index.js.map