console.info('[核心系统] 开始加载...');class e{events=new Map;on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}off(e,t){const n=this.events.get(e);if(!n)return;const a=n.indexOf(t);a>-1&&n.splice(a,1)}emit(e,t){const n=this.events.get(e);n&&n.forEach(n=>{try{n(t)}catch(t){console.error(`[事件系统] 事件 ${e} 回调错误:`,t)}})}once(e,t){const n=a=>{t(a),this.off(e,n)};this.on(e,n)}}const t=new Map;let n;function a(){const n={version:'3.2.0',initialized:!1,modules:{},config:{tokenBudget:1e5,fallbackBudget:4e4,compressionQuality:.8,cacheExpiry:6e5,healthCheckInterval:500,healthCheckTimeout:3e3},state:{mode:'detecting',tokenUsed:0,lastHealthCheck:0,errors:[]},events:new e,CacheManager:{set(e,n,a){const i=a?Date.now()+1e3*a:null;t.set(e,{value:n,expiry:i})},get(e){const n=t.get(e);return n?null!==n.expiry&&Date.now()>n.expiry?(t.delete(e),null):n.value:null},has(e){return null!==this.get(e)},delete(e){t.delete(e)},clear(){t.clear()},cleanup(){const e=Date.now();for(const[n,a]of t.entries())null!==a.expiry&&e>a.expiry&&t.delete(n)}},EventEmitter:e,ping:()=>(n.state.lastHealthCheck=Date.now(),!0),checkTokenBudget(){const e='external'===n.state.mode?n.config.tokenBudget:n.config.fallbackBudget,t=n.state.tokenUsed,a=t/e*100,i=a>95?'critical':a>85?'warning':'normal';return{used:t,total:e,percentage:a.toFixed(2),remaining:e-t,status:i}},updateTokenUsage(e){n.state.tokenUsed+=e;const t=n.checkTokenBudget();return'warning'===t.status?(console.warn(`[Token预算] 警告: 已使用 ${t.percentage}%`),n.events.emit('token_warning',t)):'critical'===t.status&&(console.error(`[Token预算] 严重: 已使用 ${t.percentage}%`),n.events.emit('token_critical',t)),t},compressContent(e,t=null){const a='string'==typeof e?e:JSON.stringify(e),i=t??n.config.compressionQuality;let o=a.replace(/\s+/g,' ').replace(/\n\s*\n/g,'\n').trim();i<.9&&(o=o.replace(/，/g,',').replace(/。/g,'.').replace(/；/g,';').replace(/：/g,':'));const r=a.length,s=o.length,l=(100*(1-s/r)).toFixed(2);return console.info(`[内容压缩] 原始: ${r} -> 压缩: ${s} (节省 ${l}%)`),o},registerModule(e,t){n.modules[e]&&console.warn(`[核心系统] 模块 ${e} 已存在，将被覆盖`),n.modules[e]=t,console.info(`[核心系统] 模块 ${e} 已注册`),n.events.emit('module_registered',{name:e,module:t})},getModule:e=>n.modules[e],handleError(e,t='unknown'){const a=function(e){return e instanceof Error?e:new Error('string'==typeof e?e:JSON.stringify(e))}(e),i={message:a.message,context:t,timestamp:Date.now(),stack:a.stack};n.state.errors.push(i),console.error(`[核心系统] 错误 [${t}]:`,a),n.events.emit('error',i),n.state.errors.length>100&&n.state.errors.shift()},detectEnvironment(){const e={isSillyTavern:!1,version:null,hasHelper:!1,helperVersion:null,hasDataTable:!1};('undefined'!=typeof SillyTavern||$('#send_textarea').length>0)&&(e.isSillyTavern=!0,'function'==typeof getTavernVersion&&(e.version=getTavernVersion()??null)),'function'==typeof getTavernHelperVersion&&(e.hasHelper=!0,e.helperVersion=getTavernHelperVersion()??null);const t=window;return'function'==typeof t.insertRow&&'function'==typeof t.updateRow&&(e.hasDataTable=!0),e},initialize(){if(n.initialized)return void console.warn('[核心系统] 已经初始化，跳过');console.info('[核心系统] 开始初始化...');const e=n.detectEnvironment();console.info('[核心系统] 环境检测:',e),e.isSillyTavern||console.warn('[核心系统] 未检测到SillyTavern环境'),n.state.mode='external',n.initialized=!0,console.info('[核心系统] 初始化完成'),console.info(`[核心系统] 版本: ${n.version}`),console.info(`[核心系统] 模式: ${n.state.mode}`),console.info(`[核心系统] Token预算: ${n.config.tokenBudget}`),n.events.emit('initialized',{env:e,state:n.state})}};return n}$(()=>{console.info('[核心系统] 酒馆页面已加载');const e=window.detentionSystem??a();window.detentionSystem=e,function(e){n||(n=setInterval(()=>e.CacheManager.cleanup(),6e4))}(e),setTimeout(()=>{try{e.initialize()}catch(t){e.handleError(t,'initialize')}},1e3)}),$(window).on('pagehide',()=>{n&&(clearInterval(n),n=void 0)}),console.info('[核心系统] 脚本加载完成'),console.info('[事件系统] 开始加载...'),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:151',message:'事件系统开始加载',data:{hasDetentionSystem:!!window.detentionSystem,detentionSystemType:typeof window.detentionSystem},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});const i=window.detentionSystem;if(i){fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:160',message:'核心系统已找到',data:{version:i.version,initialized:i.initialized,hasEvents:!!i.events,moduleCount:Object.keys(i.modules||{}).length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});const e={currentDay:0,lastEventDay:0,eventHistory:[],legalTimeline:{arrestDay:0,approvalDay:null,prosecutionDay:null,firstTrialDay:null,firstVerdictDay:null,secondTrialDay:null,finalVerdictDay:null,transferDay:null,executionDay:null},currentStage:'detention',cellType:'transition',caseComplexity:'normal',complexityMultiplier:1,eventCounters:{interrogation:0,lawyerVisit:0,familyVisit:0,medicalVisit:0,sceneIdentification:0},isDeathPenalty:!1,lastStageChangeDay:0,PRIORITY:{LEGAL:1,CONDITION:2,RANDOM:3,DAILY:4},legalEvents:{approval:{name:'批准逮捕',minDay:30,maxDay:37,stage:'approval',description:'检察院批准逮捕决定',nextStage:'investigation'},investigation:{name:'侦查羁押',duration:[60,210],stage:'investigation',description:'公安机关侦查阶段',nextStage:'prosecution'},prosecution:{name:'审查起诉',duration:[30,45],stage:'prosecution',description:'检察院审查起诉',nextStage:'trial1'},firstTrial:{name:'一审开庭',duration:[30,45],stage:'trial1',description:'法院一审审理',nextStage:'firstVerdict'},firstVerdict:{name:'一审判决',duration:[7,30],stage:'firstVerdict',description:'一审判决宣告',nextStage:'appeal'},appeal:{name:'上诉期',duration:[10,10],stage:'appeal',description:'10天上诉期',nextStage:'trial2'},secondTrial:{name:'二审审理',duration:[60,90],stage:'trial2',description:'二审法院审理',nextStage:'finalVerdict'},finalVerdict:{name:'终审判决',duration:[7,14],stage:'finalVerdict',description:'二审判决宣告',nextStage:'transfer'},transfer:{name:'移送监狱',duration:[30,90],stage:'transfer',description:'移送监狱执行',nextStage:'end'},deathReview:{name:'死刑复核',duration:[180,720],stage:'deathReview',description:'最高法院死刑复核',nextStage:'execution'},execution:{name:'执行死刑',duration:[1,7],stage:'execution',description:'死刑执行',nextStage:'end'}},conditionEvents:[{id:'mental_breakdown',name:'精神崩溃',condition:e=>e.mental<20,weight:100,description:'精神状态极度恶化，出现自杀倾向',checkAlways:!0},{id:'health_crisis',name:'健康危机',condition:e=>e.health<30,weight:100,description:'健康状况严重恶化，需要紧急医疗',checkAlways:!0},{id:'major_twist',name:'重大转折',condition:(e,t)=>t.currentDay===t.lastStageChangeDay&&Math.random()<.15,weight:100,description:'案件出现重大转折',stageChangeOnly:!0},{id:'evidence_reversal',name:'证据反转',condition:(e,t)=>t.currentDay===t.lastStageChangeDay&&Math.random()<.1,weight:100,description:'新证据出现，案情反转',stageChangeOnly:!0},{id:'interrogation',name:'提审',condition:(e,t)=>{if('investigation'!==t.currentStage)return!1;const n=t.legalTimeline.approvalDay?t.currentDay-t.legalTimeline.approvalDay:0;let a=.15;a=n<30?.25:n<60?.15:.08;const i=a*Math.pow(.7,t.eventCounters.interrogation);return Math.random()<i},weight:100,description:'公安机关提审讯问',category:'procedural'},{id:'lawyer_visit',name:'律师会见',condition:(e,t)=>{let n=.03;if(t.currentDay-t.legalTimeline.arrestDay<=14&&(n=.15),t.legalTimeline.firstTrialDay){const e=t.legalTimeline.firstTrialDay-t.currentDay;e>0&&e<=7&&(n=.3)}if(t.legalTimeline.secondTrialDay){const e=t.legalTimeline.secondTrialDay-t.currentDay;e>0&&e<=7&&(n=.25)}return Math.random()<n},weight:90,description:'律师前来会见',category:'procedural'},{id:'family_visit',name:'家属探视',condition:(e,t)=>{if(!t.legalTimeline.firstVerdictDay)return!1;let n=.05;t.isDeathPenalty&&(n=.1);const a=t.eventHistory.filter(e=>'family_visit'===e.id).sort((e,t)=>(t.day??0)-(e.day??0))[0];return!(a&&t.currentDay-(a.day??0)<30)&&Math.random()<n},weight:85,description:'家属前来探视',category:'procedural'},{id:'medical_visit',name:'外出就医',condition:(e,t)=>{if(e.health>=25)return!1;let n=0;n=e.health<10?.4:e.health<15?.25:e.health<20?.15:.08;const a=t.eventHistory.filter(e=>'medical_visit'===e.id).sort((e,t)=>(t.day??0)-(e.day??0))[0];return!(a&&t.currentDay-(a.day??0)<7)&&Math.random()<n},weight:95,description:'健康状况严重，需外出就医',category:'procedural'},{id:'scene_identification',name:'指认现场',condition:(e,t)=>{if('investigation'!==t.currentStage)return!1;if(t.eventCounters.sceneIdentification>0)return!1;const n=t.legalTimeline.approvalDay?t.currentDay-t.legalTimeline.approvalDay:0;if(n<15||n>120)return!1;const a=t.getRecentContext?t.getRecentContext():'',i=['现场','案发地','指认','带回','勘查'].some(e=>a.includes(e))?.24:.08;return Math.random()<i},weight:80,description:'公安机关带往案发现场指认',category:'procedural',aiControlled:!0}],randomEvents:{violence:[{id:'newcomer_bullying',name:'新人欺凌',weight:30},{id:'bed_dispute',name:'床位争夺',weight:25},{id:'food_robbery',name:'食物抢夺',weight:20},{id:'faction_conflict',name:'派系冲突',weight:15},{id:'revenge',name:'报复行动',weight:10}],medical:[{id:'epidemic',name:'传染病爆发',weight:15},{id:'mental_illness',name:'精神疾病发作',weight:25},{id:'chronic_disease',name:'慢性病恶化',weight:20},{id:'injury',name:'意外受伤',weight:20},{id:'gynecological',name:'妇科问题',weight:10},{id:'malnutrition',name:'营养不良',weight:10}],emotional:[{id:'deep_friendship',name:'深度友谊建立',weight:20},{id:'betrayal',name:'闺蜜反目',weight:15},{id:'motherly_bond',name:'母女般关系',weight:15},{id:'jealousy',name:'嫉妒与排挤',weight:20},{id:'secret_sharing',name:'秘密分享',weight:15},{id:'collective_exclusion',name:'集体排斥',weight:10},{id:'romance',name:'恋情萌芽',weight:5}],accident:[{id:'facility_failure',name:'设施故障',weight:25},{id:'safety_incident',name:'安全事故',weight:20},{id:'external_news',name:'外部消息',weight:30},{id:'extreme_weather',name:'极端天气',weight:15},{id:'management_change',name:'管理变化',weight:10}]},innerMonologues:[{id:'worry_about_family',text:'不知道家里人现在怎么样了...',weight:20},{id:'regret_past',text:'如果当初没有做那件事就好了...',weight:20},{id:'fear_future',text:'不知道判决会是什么结果...',weight:18},{id:'miss_freedom',text:'好想念外面的阳光和自由...',weight:15},{id:'self_reflection',text:'我到底是怎么走到这一步的...',weight:12},{id:'hope_for_leniency',text:'希望法官能从轻判决...',weight:10},{id:'worry_about_children',text:'孩子们现在还好吗...',weight:15},{id:'fear_of_inmates',text:'这里的人看起来都很可怕...',weight:12},{id:'loneliness',text:'从来没有感觉这么孤独过...',weight:15},{id:'time_perception',text:'在这里，时间过得好慢...',weight:10},{id:'dream_of_past',text:'昨晚又梦到了以前的生活...',weight:12},{id:'worry_about_health',text:'身体越来越差了，不知道能不能撑下去...',weight:10},{id:'guilt',text:'对不起那些被我伤害的人...',weight:8},{id:'anger',text:'为什么只有我被抓，其他人都没事...',weight:8},{id:'acceptance',text:'也许这就是我应得的惩罚...',weight:7},{id:'hope_for_appeal',text:'上诉还有希望吗...',weight:8},{id:'fear_of_death',text:'如果被判死刑怎么办...',weight:5},{id:'nostalgia',text:'好想吃一顿家里做的饭...',weight:10}],initialize(e=0){this.currentDay=e,this.legalTimeline.arrestDay=e,this.currentStage='detention',this.cellType='transition',this.caseComplexity='normal',this.complexityMultiplier=1,this.isDeathPenalty=!1,this.lastStageChangeDay=e,this.lastEventDay=e;for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0;console.info('[事件系统] 初始化完成'),console.info(`[事件系统] 起始日期: 第${e}天`),i.events.emit('event_system_initialized',{day:this.currentDay,stage:this.currentStage})},setCaseComplexity(e){const t={simple:.8,normal:1,complex:1.3,very_complex:1.6};e in t?(this.caseComplexity=e,this.complexityMultiplier=t[e],console.info(`[事件系统] 案件复杂度设置为: ${e} (时限倍数: ${this.complexityMultiplier})`),i.events.emit('complexity_changed',{complexity:this.caseComplexity,multiplier:this.complexityMultiplier})):console.warn(`[事件系统] 无效的复杂度: ${e}`)},checkComplexityAdjustment(){this.currentDay%30==0&&i.events.emit('request_complexity_assessment',{day:this.currentDay,stage:this.currentStage,eventHistory:this.eventHistory})},rollbackToStage(e,t='特殊情况'){console.info(`[事件系统] 法律程序回退: ${this.currentStage} -> ${e}`),console.info(`[事件系统] 回退原因: ${t}`);const n=['detention','approval','investigation','prosecution','trial1','firstVerdict','appeal','trial2','finalVerdict','transfer','execution'],a=n.indexOf(e),o=n.indexOf(this.currentStage);if(-1===a||a>=o)return console.warn('[事件系统] 无效的回退目标或无需回退'),!1;const r={approval:'approvalDay',investigation:'approvalDay',prosecution:'prosecutionDay',trial1:'firstTrialDay',firstVerdict:'firstVerdictDay',appeal:'firstVerdictDay',trial2:'secondTrialDay',finalVerdict:'finalVerdictDay',transfer:'transferDay',execution:'executionDay'};for(let e=a+1;e<n.length;e++){const t=r[n[e]];t&&this.legalTimeline[t]&&(this.legalTimeline[t]=null)}return this.currentStage=e,a<=n.indexOf('investigation')&&(this.cellType='pretrial'),this.eventHistory.push({id:'procedure_rollback',name:'程序回退',type:'legal',day:this.currentDay,from:n[o],to:e,reason:t}),i.events.emit('procedure_rollback',{from:n[o],to:e,reason:t,day:this.currentDay}),!0},handleUserRollback(e){const t=[{pattern:/回退.*?到.*?(侦查|审查起诉|一审|二审)/,stage:null},{pattern:/撤回.*?(起诉|判决)/,stage:null},{pattern:/重新.*?(侦查|审理)/,stage:null}];for(const n of t){const t=e.match(n.pattern);if(t){let e=null;if(t[1].includes('侦查')?e='investigation':t[1].includes('审查起诉')?e='prosecution':t[1].includes('一审')?e='trial1':t[1].includes('二审')&&(e='trial2'),e)return this.rollbackToStage(e,'用户请求')}}return!1},advanceDay(e=1){const t=[];for(let n=0;n<e;n++){this.currentDay++,this.lastEventDay=this.currentDay,this.checkComplexityAdjustment();const e=this.checkDayEvents();if(e&&(t.push(e),this.eventHistory.push({...e,day:this.currentDay}),Object.prototype.hasOwnProperty.call(this.eventCounters,e.id)&&(this.eventCounters[e.id]=(this.eventCounters[e.id]||0)+1),(e.priority??this.PRIORITY.DAILY)<=this.PRIORITY.RANDOM))return console.info(`[事件系统] 第${this.currentDay}天触发事件: ${e.name}`),i.events.emit('event_triggered',e),{interrupted:!0,currentDay:this.currentDay,event:e,accumulatedEvents:t}}return{interrupted:!1,currentDay:this.currentDay,accumulatedEvents:t}},checkDayEvents(){const e=this.checkLegalEvent();if(e)return{...e,priority:this.PRIORITY.LEGAL,day:this.currentDay};const t=this.checkConditionEvent();if(t)return{...t,priority:this.PRIORITY.CONDITION,day:this.currentDay};if(Math.random()<.1){const e=this.generateRandomEvent();if(e)return{...e,priority:this.PRIORITY.RANDOM,day:this.currentDay}}if(Math.random()<.15){const e=this.generateInnerMonologue();if(e)return{...e,priority:this.PRIORITY.DAILY,day:this.currentDay}}return{id:'daily_routine',name:'日常生活',type:'daily',priority:this.PRIORITY.DAILY,day:this.currentDay,description:'平静的一天'}},checkLegalEvent(){const e=this.currentDay-this.legalTimeline.arrestDay,t=this.currentStage;if(!this.legalTimeline.approvalDay){const n=Math.floor(30*this.complexityMultiplier),a=Math.floor(37*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.3)return this.legalTimeline.approvalDay=this.currentDay,this.currentStage='investigation',this.lastStageChangeDay=this.currentDay,{id:'approval',name:'批准逮捕',type:'legal',stage:'approval',description:'检察院批准逮捕决定下达',from:t,to:'investigation'}}if(this.legalTimeline.approvalDay&&!this.legalTimeline.prosecutionDay){const e=this.currentDay-this.legalTimeline.approvalDay,n=Math.floor(60*this.complexityMultiplier),a=Math.floor(210*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.02)return this.legalTimeline.prosecutionDay=this.currentDay,this.currentStage='prosecution',this.lastStageChangeDay=this.currentDay,{id:'prosecution',name:'检察院起诉',type:'legal',stage:'prosecution',description:'检察院向法院提起公诉',from:t,to:'prosecution'}}if(this.legalTimeline.prosecutionDay&&!this.legalTimeline.firstTrialDay){const e=this.currentDay-this.legalTimeline.prosecutionDay,n=Math.floor(30*this.complexityMultiplier),a=Math.floor(45*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.05)return this.legalTimeline.firstTrialDay=this.currentDay,this.currentStage='trial1',this.lastStageChangeDay=this.currentDay,'transition'===this.cellType&&(this.cellType='pretrial',i.events.emit('cell_transfer',{from:'transition',to:'pretrial',reason:'等待开庭'})),{id:'first_trial',name:'一审开庭',type:'legal',stage:'trial1',description:'法院一审开庭审理',from:t,to:'trial1'}}if(this.legalTimeline.firstTrialDay&&!this.legalTimeline.firstVerdictDay){const e=this.currentDay-this.legalTimeline.firstTrialDay,n=Math.floor(7*this.complexityMultiplier),a=Math.floor(30*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.1)return this.legalTimeline.firstVerdictDay=this.currentDay,this.currentStage='appeal',this.lastStageChangeDay=this.currentDay,this.cellType='convicted',i.events.emit('cell_transfer',{from:'pretrial',to:'convicted',reason:'一审判决宣告'}),{id:'first_verdict',name:'一审判决',type:'legal',stage:'firstVerdict',description:'法院宣告一审判决',from:t,to:'appeal'}}if(this.legalTimeline.firstVerdictDay&&!this.legalTimeline.secondTrialDay&&!this.legalTimeline.finalVerdictDay){if(10===this.currentDay-this.legalTimeline.firstVerdictDay)return Math.random()<.7?(this.legalTimeline.secondTrialDay=this.currentDay,this.currentStage='trial2',this.lastStageChangeDay=this.currentDay,{id:'appeal_filed',name:'提起上诉',type:'legal',stage:'appeal',description:'向上级法院提起上诉',from:t,to:'trial2'}):(this.legalTimeline.finalVerdictDay=this.currentDay,this.currentStage='transfer',this.lastStageChangeDay=this.currentDay,{id:'verdict_final',name:'判决生效',type:'legal',stage:'finalVerdict',description:'未上诉，一审判决生效',from:t,to:'transfer'})}if(this.legalTimeline.secondTrialDay&&!this.legalTimeline.finalVerdictDay){const e=this.currentDay-this.legalTimeline.secondTrialDay,n=Math.floor(60*this.complexityMultiplier),a=Math.floor(90*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.03)return this.legalTimeline.finalVerdictDay=this.currentDay,this.currentStage='transfer',this.lastStageChangeDay=this.currentDay,{id:'final_verdict',name:'二审判决',type:'legal',stage:'finalVerdict',description:'二审法院宣告终审判决',from:t,to:'transfer'}}if(this.legalTimeline.finalVerdictDay&&!this.legalTimeline.transferDay&&!this.isDeathPenalty){const e=this.currentDay-this.legalTimeline.finalVerdictDay,n=Math.floor(30*this.complexityMultiplier),a=Math.floor(90*this.complexityMultiplier);if(e>=n&&e<=a&&Math.random()<.02)return this.legalTimeline.transferDay=this.currentDay,this.currentStage='end',this.lastStageChangeDay=this.currentDay,{id:'transfer_prison',name:'移送监狱',type:'legal',stage:'transfer',description:'移送监狱执行刑罚',isEnding:!0,endingType:'prison',from:t,to:'end'}}if(this.legalTimeline.finalVerdictDay&&this.isDeathPenalty&&!this.legalTimeline.executionDay){const e=this.currentDay-this.legalTimeline.finalVerdictDay;if(e>=180&&e<=720&&Math.random()<.005)return this.legalTimeline.executionDay=this.currentDay+7,this.currentStage='execution',this.lastStageChangeDay=this.currentDay,{id:'death_review_approved',name:'死刑复核核准',type:'legal',stage:'deathReview',description:'最高法院核准死刑，7日内执行',from:t,to:'execution'}}return this.legalTimeline.executionDay&&this.currentDay>=this.legalTimeline.executionDay?(this.currentStage='end',this.lastStageChangeDay=this.currentDay,{id:'execution',name:'执行死刑',type:'legal',stage:'execution',description:'死刑执行',isEnding:!0,endingType:'death',from:t,to:'end'}):null},checkConditionEvent(){const e=this.getProtagonistState();for(const t of this.conditionEvents)if((!t.stageChangeOnly||this.currentDay===this.lastStageChangeDay)&&(t.checkAlways||!t.stageChangeOnly)&&t.condition(e,this)&&100*Math.random()<t.weight)return{id:t.id,name:t.name,type:t.category||'condition',description:t.description,aiControlled:t.aiControlled||!1};return null},generateRandomEvent(){const e=['violence','medical','emotional','accident'],t=e[this.weightedRandom(e.length,[25,30,30,15])],n=this.randomEvents[t],a=n.map(e=>e.weight),i=n[this.weightedRandom(n.length,a)];return{id:i.id,name:i.name,type:t,category:'random',description:`随机事件: ${i.name}`}},generateInnerMonologue(){const e=this.innerMonologues.map(e=>e.weight),t=this.weightedRandom(this.innerMonologues.length,e),n=this.innerMonologues[t];return{id:n.id,name:'心理独白',type:'monologue',category:'daily',description:n.text,text:n.text}},weightedRandom(e,t){const n=t.reduce((e,t)=>e+t,0);let a=Math.random()*n;for(let n=0;n<e;n++)if(a-=t[n],a<=0)return n;return e-1},getProtagonistState(){const e=i.getModule('statusPanel');return e&&e.state?e.state:{health:80,mental:70,strength:60,intelligence:70}},getRecentContext(){if(Array.isArray(window.chat)){return window.chat.slice(-5).map(e=>e.mes||'').join(' ')}return''},checkCellTransfer(){const e=this.currentDay-this.legalTimeline.arrestDay;return'transition'===this.cellType&&e>=7&&e<=14&&Math.random()<.2&&(this.cellType='pretrial',i.events.emit('cell_transfer',{from:'transition',to:'pretrial',reason:'过渡期结束',day:this.currentDay}),!0)},setDeathPenalty(e){this.isDeathPenalty=e,console.info(`[事件系统] 死刑标记设置为: ${e}`),i.events.emit('death_penalty_status_changed',{isDeathPenalty:this.isDeathPenalty,day:this.currentDay})},getCurrentStageInfo(){return{day:this.currentDay,stage:this.currentStage,cellType:this.cellType,daysInCustody:this.currentDay-this.legalTimeline.arrestDay,timeline:{...this.legalTimeline},complexity:this.caseComplexity,complexityMultiplier:this.complexityMultiplier,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters}}},getEventStatistics(){const e={totalEvents:this.eventHistory.length,byType:{},byPriority:{},recentEvents:this.eventHistory.slice(-10)};return this.eventHistory.forEach(t=>{const n=t.type||'unknown';e.byType[n]=(e.byType[n]||0)+1;const a=t.priority||4;e.byPriority[a]=(e.byPriority[a]||0)+1}),e},exportTimeline(){return{currentDay:this.currentDay,currentStage:this.currentStage,cellType:this.cellType,timeline:{...this.legalTimeline},complexity:this.caseComplexity,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters},eventHistory:[...this.eventHistory],lastStageChangeDay:this.lastStageChangeDay}},importTimeline(e){if(!e)return!1;try{return this.currentDay=e.currentDay||0,this.currentStage=e.currentStage||'detention',this.cellType=e.cellType||'transition',this.legalTimeline=e.timeline||{},this.caseComplexity=e.complexity||'normal',this.isDeathPenalty=Boolean(e.isDeathPenalty),this.eventCounters=e.eventCounters||{},this.eventHistory=e.eventHistory||[],this.lastStageChangeDay=e.lastStageChangeDay||0,console.info('[事件系统] 时间线导入成功'),!0}catch(e){return console.error('[事件系统] 时间线导入失败:',e),!1}}};i.generateRandomEvent=t=>e.generateRandomEvent(),i.advanceDay=t=>e.advanceDay(t),i.getCurrentStage=()=>e.getCurrentStageInfo(),i.checkCellTransfer=()=>e.checkCellTransfer(),i.setCaseComplexity=t=>e.setCaseComplexity(t),i.rollbackToStage=(t,n)=>e.rollbackToStage(t,n),i.setDeathPenalty=t=>e.setDeathPenalty(t),i.getEventStatistics=()=>e.getEventStatistics(),i.exportTimeline=()=>e.exportTimeline(),i.importTimeline=t=>e.importTimeline(t),i.registerModule('eventSystem',e),i.events.on('user_input',t=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1236',message:'收到用户输入事件',data:{hasData:!!t,dataType:typeof t,textLength:'string'==typeof t?.text?t.text?.length:0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});const n='string'==typeof t?.text?t.text:void 0;n&&(fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1242',message:'处理用户回退',data:{text:n.substring(0,50)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{}),e.handleUserRollback(n))}),i.events.on('initialized',()=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1246',message:'收到核心系统初始化事件',data:{currentDay:e.currentDay,currentStage:e.currentStage},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});try{e.initialize(0),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1250',message:'事件系统初始化成功',data:{currentDay:e.currentDay,currentStage:e.currentStage},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{})}catch(e){fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:1254',message:'事件系统初始化失败',data:{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{}),console.error('[事件系统] 初始化失败:',e)}}),console.info('[事件系统] 脚本加载完成 v3.4.0')}else console.error('[事件系统] 核心系统未加载'),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'event_system.ts:156',message:'核心系统未加载错误',data:{windowKeys:Object.keys(window).filter(e=>e.includes('detention')||e.includes('Detention'))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});const o=window.detentionSystem;if(o){console.info('[NPC系统] 开始加载...');const e={surnames:{tier1:{names:['王','李','张','刘','陈','杨','黄','赵','吴','周'],weight:35},tier2:{names:['徐','孙','马','朱','胡','郭','何','林','高','罗','郑','梁','谢','宋','唐','许','韩','冯','邓','曹'],weight:30},tier3:{names:['彭','曾','肖','田','董','袁','潘','于','蒋','蔡','余','杜','叶','程','苏','魏','吕','丁','任','沈','姚','卢','姜','崔','钟','谭','陆','汪','范','金'],weight:20},tier4:{names:['石','廖','贾','夏','韦','付','方','白','邹','孟','熊','秦','邱','江','尹','薛','闫','段','雷','侯','龙','史','陶','黎','贺','顾','毛','郝','龚','邵'],weight:10},tier5:{names:['万','覃','武','乔','严','赖','文','洪','季','莫','欧阳','司马','上官','诸葛','东方'],weight:5}},givenNames:{vintage:{single:['芳','丽','娟','英','华','玉','秀','珍','红','梅','兰','霞','燕','萍','静'],double:[['秀','英'],['秀','兰'],['秀','珍'],['秀','芳'],['丽','华'],['丽','娟'],['丽','萍'],['丽','芳'],['玉','兰'],['玉','梅'],['玉','华'],['玉','珍'],['春','梅'],['春','兰'],['春','华'],['春','燕'],['小','红'],['小','芳'],['小','丽'],['小','燕']],weight:25},classic:{single:['婷','洁','莉','敏','艳','娜','倩','雪','琳','颖','晶','欣','慧','佳','薇'],double:[['雅','婷'],['雅','洁'],['雅','琳'],['雅','欣'],['晓','燕'],['晓','丽'],['晓','红'],['晓','霞'],['文','静'],['文','慧'],['文','娟'],['文','婷'],['志','红'],['志','华'],['志','英'],['志','芳'],['海','燕'],['海','霞'],['海','英'],['海','丽']],weight:35},modern:{single:['婷','洁','莉','敏','艳','娜','倩','雪','琳','颖','晶','欣','慧','佳','薇','涵','萱','琪','瑶','诗'],double:[['雨','婷'],['雨','欣'],['雨','涵'],['雨','萱'],['思','琪'],['思','涵'],['思','雨'],['思','颖'],['梦','琪'],['梦','瑶'],['梦','涵'],['梦','萱'],['诗','涵'],['诗','琪'],['诗','雨'],['诗','婷'],['欣','怡'],['欣','悦'],['欣','然'],['欣','妍']],weight:30},contemporary:{single:['涵','萱','琪','瑶','诗','语','馨','妍','彤','悦','然','怡','可','依','梓'],double:[['梓','涵'],['梓','萱'],['梓','琪'],['梓','瑶'],['子','涵'],['子','萱'],['子','琪'],['子','瑶'],['雨','桐'],['雨','彤'],['雨','馨'],['雨','诺'],['诗','语'],['诗','涵'],['诗','雨'],['诗','琪'],['可','欣'],['可','馨'],['可','心'],['可','儿']],weight:10}},badNames:['史珍香','范统','杜子腾','范剑','朱逸群','秦寿生','杜琦燕','魏生津','费彦','殷静','范婉','胡丽晶'],badChars:['屎','尿','粪','死','丧','病','残','废','贱','奴','妓','娼'],generate(e){let t=0;for(;t<50;){t++;const n=this.selectSurname()+this.selectGivenName(e);if(this.isValidName(n))return n}return'张'+this.givenNames.classic.single[0]},selectSurname(){const e=Object.values(this.surnames),t=e.reduce((e,t)=>e+t.weight,0);let n=Math.random()*t;for(const t of e)if(n-=t.weight,n<=0)return t.names[Math.floor(Math.random()*t.names.length)];return this.surnames.tier1.names[0]},selectGivenName(e){const t=(new Date).getFullYear()-e,n=t>=50?'vintage':t>=35?'classic':t>=20?'modern':'contemporary',a=this.givenNames[n];if(Math.random()<.6&&a.double.length>0){const e=a.double[Math.floor(Math.random()*a.double.length)];return e[0]+e[1]}return a.single[Math.floor(Math.random()*a.single.length)]},isValidName(e){return!this.badNames.includes(e)&&!this.badChars.some(t=>e.includes(t))}},t={characterBookCrimes:['危险驾驶罪','盗窃罪','诈骗罪','故意伤害罪','走私毒品罪','贩卖毒品罪','运输毒品罪','制造毒品罪','交通肇事罪','寻衅滋事罪','抢劫罪','故意杀人罪','开设赌场罪','敲诈勒索罪','贪污罪','受贿罪','聚众斗殴罪','非法拘禁罪','容留他人吸毒罪','掩饰隐瞒犯罪所得罪','帮助信息网络犯罪活动罪','职务侵占罪'],crimes:{violent:{names:['故意杀人罪','故意伤害罪','抢劫罪','绑架罪','非法拘禁罪','聚众斗殴罪'],weight:12,sentenceRange:[3,20]},property:{names:['盗窃罪','诈骗罪','抢夺罪','敲诈勒索罪','职务侵占罪','挪用资金罪','贪污罪','受贿罪','掩饰隐瞒犯罪所得罪'],weight:35,sentenceRange:[1,15]},drug:{names:['贩卖毒品罪','运输毒品罪','制造毒品罪','走私毒品罪','非法持有毒品罪','容留他人吸毒罪','引诱他人吸毒罪'],weight:20,sentenceRange:[3,15]},economic:{names:['非法吸收公众存款罪','集资诈骗罪','合同诈骗罪','信用卡诈骗罪','洗钱罪','虚开发票罪','逃税罪'],weight:15,sentenceRange:[2,10]},social:{names:['寻衅滋事罪','聚众斗殴罪','开设赌场罪','组织卖淫罪','传播淫秽物品罪','妨害公务罪','帮助信息网络犯罪活动罪'],weight:13,sentenceRange:[1,7]},other:{names:['交通肇事罪','危险驾驶罪','生产销售伪劣产品罪','非法经营罪','污染环境罪','走私罪'],weight:5,sentenceRange:[1,5]}},generate(){if(Math.random()<.3){const e=this.characterBookCrimes[Math.floor(Math.random()*this.characterBookCrimes.length)],t=this.findCategoryByCrime(e);return{crime:e,sentence:this.generateSentence(t?t.sentenceRange:[1,10]),category:t||this.crimes.property}}const e=Object.values(this.crimes),t=e.reduce((e,t)=>e+t.weight,0);let n=Math.random()*t;for(const t of e)if(n-=t.weight,n<=0){return{crime:t.names[Math.floor(Math.random()*t.names.length)],sentence:this.generateSentence(t.sentenceRange),category:t}}return{crime:'盗窃罪',sentence:3,category:this.crimes.property}},findCategoryByCrime(e){for(const t of Object.keys(this.crimes)){const n=this.crimes[t];if(n.names.includes(e))return n}return null},generateSentence(e){const[t,n]=e;return Math.floor(Math.random()*(n-t+1))+t}},n={npcDatabase:[],currentCellNPCs:[],generate(e=1,t={}){const n=[];for(let a=0;a<e;a++){const e=this.generateSingle(t);n.push(e),this.npcDatabase.push(e)}return n},generateSingle(n={}){const a=o.getModule('eventSystem'),i=a?.getCurrentStageInfo?a.getCurrentStageInfo():{},r=this.generateAge(),s=(new Date).getFullYear()-r,l=e.generate(s),c=t.generate(),d=this.generateAppearance(r),h=this.generatePersonality(),g=this.generateBackground(r,c),m=this.generateRelationship(),y='string'==typeof i?.cellType?i.cellType:n.cellType||'transition';this.adjustByCellType(h,m,y);return{id:this.generateId(),name:l,gender:'female',age:r,crime:c.crime,sentence:c.sentence,appearance:d,personality:h,background:g,relationship:m,cellType:y,daysInCustody:Math.floor(365*Math.random())+30,status:'active',createdAt:Date.now()}},generateAge(){const e=Math.random();return e<.05?Math.floor(3*Math.random())+18:e<.25?Math.floor(10*Math.random())+21:e<.55?Math.floor(10*Math.random())+31:e<.8?Math.floor(10*Math.random())+41:e<.95?Math.floor(10*Math.random())+51:Math.floor(15*Math.random())+61},generateAppearance(e){const t=[150,155,160,165,170,175],n=[45,50,55,60,65,70,75],a=e>50?['短发','花白短发','灰白短发','稀疏短发']:['长发','短发','马尾','齐肩发','波浪卷','直发','卷发'],i=['白皙','偏白','自然','偏黑','黝黑'],o=['清秀','普通','憔悴','精致','沧桑','姣好','端庄'];return{height:t[Math.floor(Math.random()*t.length)],weight:n[Math.floor(Math.random()*n.length)],hair:a[Math.floor(Math.random()*a.length)],eyes:'黑色',skin:i[Math.floor(Math.random()*i.length)],features:o[Math.floor(Math.random()*o.length)]}},generatePersonality(){const e={aggression:Math.floor(100*Math.random()),sociability:Math.floor(100*Math.random()),intelligence:Math.floor(100*Math.random()),emotional:Math.floor(100*Math.random()),dominance:Math.floor(100*Math.random()),kindness:Math.floor(100*Math.random())},t=[];return e.aggression>70&&t.push('暴力倾向'),e.sociability>70&&t.push('善于交际'),e.intelligence>70&&t.push('聪明'),e.emotional>70&&t.push('情绪化'),e.dominance>70&&t.push('强势'),e.kindness>70&&t.push('善良'),e.aggression<30&&t.push('温和'),e.sociability<30&&t.push('孤僻'),e.emotional<30&&t.push('冷静'),e.dominance<30&&t.push('顺从'),{traits:e,tags:t}},generateBackground(e,t){const n=['小学','初中','高中','中专','大专','本科','研究生'],a=this.weightedRandom(n.length,[10,25,30,15,10,8,2]),i=['未婚','已婚','离异','丧偶'],o=e<25?[80,15,5,0]:e<40?[20,60,15,5]:[10,50,30,10],r=this.weightedRandom(i.length,o),s='未婚'!==i[r]&&Math.random()<.7,l=s?Math.floor(3*Math.random())+1:0;return{education:n[a],maritalStatus:i[r],hasChildren:s,childrenCount:l,hometown:this.generateHometown(),priorConvictions:Math.random()<.3?Math.floor(3*Math.random())+1:0}},generateHometown(){const e=['河南','山东','四川','广东','江苏','河北','湖南','安徽','湖北','浙江','广西','云南','江西','辽宁','黑龙江','陕西','福建','山西','贵州','重庆'];return e[Math.floor(Math.random()*e.length)]},generateRelationship:()=>({toProtagonist:50,faction:null,allies:[],enemies:[],influence:Math.floor(100*Math.random())}),adjustByCellType(e,t,n){'transition'===n?(e.traits.emotional+=10,t.influence-=20):'pretrial'===n?(e.traits.emotional+=15,e.traits.aggression+=5):'convicted'===n&&(e.traits.emotional-=10,e.traits.aggression+=10,t.influence+=10),Object.keys(e.traits).forEach(t=>{e.traits[t]=Math.max(0,Math.min(100,e.traits[t]))}),t.influence=Math.max(0,Math.min(100,t.influence))},weightedRandom(e,t){const n=t.reduce((e,t)=>e+t,0);let a=Math.random()*n;for(let n=0;n<e;n++)if(a-=t[n],a<=0)return n;return e-1},generateId:()=>'npc_'+Date.now()+'_'+Math.random().toString(36).slice(2,11),generateForEvent(e){return'interrogation'===e?this.generatePolice():'lawyer_visit'===e?this.generateLawyer():'family_visit'===e?this.generateFamily():'medical_visit'===e?this.generateDoctor():'scene_identification'===e?{police:this.generatePolice(),witnesses:this.generate(2,{type:'witness'})}:this.generateSingle({eventType:e})},generatePolice(){const t=Math.floor(20*Math.random())+25,n=(new Date).getFullYear()-t,a=e.generate(n),i=['民警','警长','副队长','队长'],o=i[Math.floor(Math.random()*i.length)];return{id:this.generateId(),name:a,gender:'female',age:t,role:'police',rank:o,appearance:this.generateAppearance(t),personality:{traits:{aggression:Math.floor(30*Math.random())+40,sociability:Math.floor(40*Math.random())+30,intelligence:Math.floor(30*Math.random())+50,emotional:Math.floor(40*Math.random())+20,dominance:Math.floor(30*Math.random())+60,kindness:Math.floor(60*Math.random())+20},tags:['严肃','专业']},attitude:Math.floor(40*Math.random())+30,crime:'——',sentence:0,background:this.generateBackground(t,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'staff',daysInCustody:0,status:'active',createdAt:Date.now()}},generateLawyer(){const t=Math.floor(25*Math.random())+28,n=(new Date).getFullYear()-t,a=Math.random()<.8,i=e.generate(n),o=['法律援助律师','私人律师','知名律师'],r=this.weightedRandom(o.length,[50,40,10]);return{id:this.generateId(),name:i,gender:a?'female':'male',age:t,role:'lawyer',type:o[r],appearance:this.generateAppearance(t),personality:{traits:{aggression:Math.floor(20*Math.random())+20,sociability:Math.floor(30*Math.random())+60,intelligence:Math.floor(20*Math.random())+70,emotional:Math.floor(40*Math.random())+30,dominance:Math.floor(40*Math.random())+40,kindness:Math.floor(40*Math.random())+40},tags:['专业','理性']},experience:Math.floor(20*Math.random())+5,successRate:Math.floor(40*Math.random())+40,crime:'——',sentence:0,background:this.generateBackground(t,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},generateFamily(){const t=['母亲','父亲','丈夫','妻子','姐姐','妹妹','女儿','儿子'],n=t[this.weightedRandom(t.length,[30,20,15,10,10,10,3,2])];let a=40,i=!0;'母亲'===n?(a=Math.floor(20*Math.random())+45,i=!0):'父亲'===n?(a=Math.floor(20*Math.random())+45,i=!1):'丈夫'===n?(a=Math.floor(30*Math.random())+25,i=!1):'妻子'===n?(a=Math.floor(30*Math.random())+25,i=!0):'姐姐'===n||'妹妹'===n?(a=Math.floor(30*Math.random())+20,i=!0):'女儿'===n?(a=Math.floor(15*Math.random())+5,i=!0):'儿子'===n&&(a=Math.floor(15*Math.random())+5,i=!1);const o=(new Date).getFullYear()-a,r=e.generate(o);return{id:this.generateId(),name:r,gender:i?'female':'male',age:a,role:'family',relation:n,appearance:this.generateAppearance(a),personality:{traits:{aggression:Math.floor(30*Math.random())+10,sociability:Math.floor(50*Math.random())+30,intelligence:Math.floor(60*Math.random())+30,emotional:Math.floor(50*Math.random())+40,dominance:Math.floor(50*Math.random())+20,kindness:Math.floor(30*Math.random())+60},tags:['关心','担忧']},supportLevel:Math.floor(40*Math.random())+60,crime:'——',sentence:0,background:this.generateBackground(a,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},generateDoctor(){const t=Math.floor(25*Math.random())+30,n=(new Date).getFullYear()-t,a=e.generate(n),i=['内科','外科','精神科','妇科','急诊科'],o=i[Math.floor(Math.random()*i.length)];return{id:this.generateId(),name:a,gender:'female',age:t,role:'doctor',specialty:o,appearance:this.generateAppearance(t),personality:{traits:{aggression:Math.floor(20*Math.random())+10,sociability:Math.floor(40*Math.random())+40,intelligence:Math.floor(20*Math.random())+70,emotional:Math.floor(40*Math.random())+30,dominance:Math.floor(40*Math.random())+40,kindness:Math.floor(30*Math.random())+60},tags:['专业','冷静']},experience:Math.floor(25*Math.random())+5,crime:'——',sentence:0,background:this.generateBackground(t,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},getCurrentCellNPCs(){return this.currentCellNPCs},setCurrentCellNPCs(e){this.currentCellNPCs=e,o.events.emit('cell_npcs_changed',{npcs:e})},addNPCToCell(e){this.currentCellNPCs.push(e),o.events.emit('npc_joined_cell',{npc:e})},removeNPCFromCell(e){const t=this.currentCellNPCs.findIndex(t=>t.id===e);if(-1!==t){const e=this.currentCellNPCs.splice(t,1)[0];return o.events.emit('npc_left_cell',{npc:e}),e}return null},findNPCById(e){return this.npcDatabase.find(t=>t.id===e)||this.currentCellNPCs.find(t=>t.id===e)},updateRelationship(e,t){const n=this.findNPCById(e);n&&n.relationship&&(n.relationship.toProtagonist=Math.max(0,Math.min(100,n.relationship.toProtagonist+t)),o.events.emit('relationship_changed',{npcId:e,npcName:n.name,value:n.relationship.toProtagonist,delta:t}))},exportData(){return{database:this.npcDatabase,currentCell:this.currentCellNPCs}},importData(e){if(!e)return!1;try{return this.npcDatabase=e.database||[],this.currentCellNPCs=e.currentCell||[],console.info('[NPC系统] 数据导入成功'),!0}catch(e){return console.error('[NPC系统] 数据导入失败:',e),!1}},clearData(){this.npcDatabase=[],this.currentCellNPCs=[],console.info('[NPC系统] 数据已清空')}};o.generateNPC=(e,t)=>n.generate(e,t??{}),o.generateNPCForEvent=e=>n.generateForEvent(e),o.getCurrentCellNPCs=()=>n.getCurrentCellNPCs(),o.setCurrentCellNPCs=e=>n.setCurrentCellNPCs(e),o.addNPCToCell=e=>n.addNPCToCell(e),o.removeNPCFromCell=e=>n.removeNPCFromCell(e),o.findNPC=e=>n.findNPCById(e),o.updateNPCRelationship=(e,t)=>n.updateRelationship(e,t),o.exportNPCData=()=>n.exportData(),o.importNPCData=e=>n.importData(e),o.registerModule('npcSystem',n),o.events.on('event_triggered',e=>{const t='string'==typeof e?.id?e.id:void 0;if(t&&['interrogation','lawyer_visit','family_visit','medical_visit','scene_identification'].includes(t)){const a=n.generateForEvent(t);o.events.emit('event_npc_generated',{event:e,npc:a})}}),o.events.on('cell_transfer',e=>{const t=e?.to,a='string'==typeof t?t:'transition',i=Math.floor(5*Math.random())+3,o=n.generate(i,{cellType:a});n.setCurrentCellNPCs(o),console.info(`[NPC系统] 监室转移，生成${i}个新女性囚犯NPC`)}),console.info('[NPC系统] 脚本加载完成 - 女性看守所版本')}else console.error('[NPC系统] 核心系统未加载');const r={detention_rules:{name:'detention_rules',displayName:'核心规则库',description:'看守所基本规范、管理制度、违规处罚机制等核心规则',priority:10,keywords:['监规','处罚','纪律','规定','违规','管教','报告','管理制度','基本规范','违规处罚','看守所规则','监管制度','违反','处分','警告','禁闭','扣分','考核'],autoLoad:!0,position:'before_char',depth:4,fallbackEntries:[]},internal_basic_procedures:{name:'internal_basic_procedures',displayName:'生活细节库',description:'入所搜身、吃饭、洗澡、审讯等日常生活流程的详细描述',priority:9,keywords:['吃饭','洗澡','睡觉','如厕','审讯','会见','放风','点名','劳动','入所','搜身','日常生活','生活流程','日常流程','生活细节','起床','洗漱','用餐','就寝','体检','登记','分配'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]},internal_basic_legal:{name:'internal_basic_legal',displayName:'法律细节库',description:'详细的司法流程，包括逮捕、起诉、一审、二审、死刑复核、死刑执行（枪决/注射/绞刑）等，还包括法律文书样本、程序性话语模板',priority:8,keywords:['批捕','起诉','开庭','判决','执行','律师','取保','保释','逮捕','一审','二审','死刑复核','死刑执行','枪决','注射','绞刑','司法流程','法律文书','程序性话语','程序性','司法程序','检察院','法院','法官','检察官','辩护','上诉','终审'],autoLoad:!1,position:'before_char',depth:4,fallbackEntries:[]},legal_knowledge:{name:'legal_knowledge',displayName:'专业知识库',description:'详细法律条文、量刑标准、司法程序',priority:7,keywords:['罪名','量刑','法律','刑法','刑期','缓刑','假释','法律条文','量刑标准','司法程序','刑法条文','法律依据','从轻','从重','减轻','加重','累犯','自首','立功','认罪认罚'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]},environment_descriptions:{name:'environment_descriptions',displayName:'环境描写库',description:'各场所的详细环境描写模板，包含枪决、注射、绞刑三种执行方式的不同刑场环境',priority:6,keywords:['监室','审讯室','会见室','禁闭室','法院','刑场','走廊','铁门','环境描写','场所','刑场环境','执行方式','枪决','注射','绞刑','看守所','监狱','法庭','羁押室','提审室','医务室','食堂','操场'],autoLoad:!1,position:'before_char',depth:4,fallbackEntries:[]},narrative_enhancements:{name:'narrative_enhancements',displayName:'叙事增强库',description:'转折、回忆、梦境、反转等叙事增强功能',priority:5,keywords:['转折','回忆','梦境','反转','高潮','心理','情绪','叙事增强','叙事','回忆杀','梦境','幻觉','闪回','内心','思绪','情感','感受','想法','思考','反思'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]}};console.info('[知识库加载器] v5.1.0 启动...'),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:190',message:'知识库加载器开始加载',data:{hasDetentionSystem:!!window.detentionSystem,detentionSystemType:typeof window.detentionSystem},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});const s=window.detentionSystem;if(s){fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:199',message:'核心系统已找到',data:{version:s.version,initialized:s.initialized,hasEvents:!!s.events,moduleCount:Object.keys(s.modules||{}).length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{}),s.characterId='detention_center',console.info('[知识库加载器] ✓ 已设置角色标识');const e={loaded:new Map,loading:new Map,initialized:!1,fallbackMode:!1,characterWorldbookId:null,async findCharacterWorldbook(){console.info('[知识库加载器] 查找角色专属世界书...');try{const e=getCharWorldbookNames('current');return e.primary?(console.info(`[知识库加载器] ✓ 找到角色主世界书: ${e.primary}`),this.characterWorldbookId=e.primary,e.primary):e.additional.length>0?(console.info(`[知识库加载器] ✓ 找到角色附加世界书: ${e.additional[0]}`),this.characterWorldbookId=e.additional[0],e.additional[0]):(console.warn('[知识库加载器] ⚠ 未找到角色专属世界书'),null)}catch(e){return console.error('[知识库加载器] 查找角色世界书失败:',e),null}},async loadWorldbook(e){const t=r[e];if(!t)throw new Error(`未知的知识库: ${e}`);if(this.loaded.has(e))return console.info(`[知识库加载器] ${t.displayName} 已加载，跳过`),this.loaded.get(e);if(this.loading.has(e))return console.info(`[知识库加载器] ${t.displayName} 正在加载，等待...`),await this.loading.get(e);const n=this._loadWorldbookInternal(e,t);this.loading.set(e,n);try{const t=await n;return this.loaded.set(e,t),t}finally{this.loading.delete(e)}},async _loadWorldbookInternal(e,t){console.info(`[知识库加载器] 开始加载: ${t.displayName} (${e})`),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:274',message:'开始加载世界书',data:{bookName:e,displayName:t.displayName,priority:t.priority},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});try{const n=getWorldbookNames();fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:279',message:'获取世界书名称列表',data:{count:n.length,names:n.slice(0,10),targetDisplayName:t.displayName,targetName:t.name},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});let a=null;const i=n.find(e=>e===t.displayName);if(i)a=i,console.info(`[知识库加载器] ✓ 精确匹配中文名称: "${t.displayName}"`);else if(n.includes(t.name))a=t.name,console.info(`[知识库加载器] ✓ 精确匹配英文标识: "${t.name}"`);else{const e=n.find(e=>e.includes(t.displayName)||t.displayName.includes(e)||e.includes(t.name)||t.name.includes(e));e&&(a=e,console.info(`[知识库加载器] ✓ 模糊匹配: "${e}"`))}if(!a){const a=n.join(', ');throw fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:309',message:'世界书匹配失败',data:{bookName:e,displayName:t.displayName,availableCount:n.length,availableNames:n},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{}),new Error(`未找到世界书: ${t.displayName} (${e})\n可用的世界书: ${a}\n提示: 请确保知识库名称与配置中的 displayName 或 name 匹配`)}fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:318',message:'世界书匹配成功',data:{bookName:e,targetWorldbookName:a,displayName:t.displayName},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});const o=await getWorldbook(a);if(0===o.length)throw new Error('世界书为空');const r=getCharWorldbookNames('current');return r.additional.includes(a)||(await rebindCharWorldbooks('current',{primary:r.primary,additional:[...r.additional,a]}),console.info(`[知识库加载器] ✓ 已绑定到角色卡: ${a}`)),console.info(`[知识库加载器] ✓ ${t.displayName} 加载成功 (${o.length} 条目)`),{name:e,displayName:t.displayName,entries:o,fallback:!1,loadedAt:Date.now()}}catch(n){const a=n instanceof Error?n.message:String(n);if(console.warn(`[知识库加载器] ⚠ ${t.displayName} 加载失败:`,a),t.fallbackEntries&&t.fallbackEntries.length>0)return console.info(`[知识库加载器] ⚠ ${t.displayName} 使用降级版本 (${t.fallbackEntries.length} 条目)`),this.fallbackMode=!0,{name:e,displayName:t.displayName,entries:t.fallbackEntries,fallback:!0,error:a,loadedAt:Date.now()};throw n}},async predictiveCache(e){if(!e||'string'!=typeof e)return;console.info('[知识库加载器] 执行预测性缓存...');const t=[];for(const n in r){const a=r[n];if(this.loaded.has(n))continue;let i=0,o=0;for(const t of a.keywords)if(e.includes(t)){i++;o+=t.length>=3?2:1,a.description&&a.description.includes(t)&&(o+=1)}if(a.description){const t=a.description.match(/[\u4e00-\u9fa5]{2,}/g)||[];for(const n of t)e.includes(n)&&n.length>=2&&(o+=.5)}if(i>0){const e=10*a.priority+o;t.push({bookName:n,score:i,priority:a.priority,weightedScore:e})}}t.sort((e,t)=>Math.abs(t.weightedScore-e.weightedScore)>1?t.weightedScore-e.weightedScore:t.priority!==e.priority?t.priority-e.priority:t.score-e.score),console.info(`[知识库加载器] 预测需要加载 ${t.length} 个知识库`);const n=t.filter(e=>e.weightedScore>10).slice(0,3);if(0!==n.length)for(const e of n){console.info(`[知识库加载器] 预测性加载: ${r[e.bookName].displayName} (匹配关键词: ${e.score}, 综合评分: ${e.weightedScore.toFixed(1)})`);try{await this.loadWorldbook(e.bookName)}catch(t){console.warn(`[知识库加载器] 预测性加载失败: ${e.bookName}`,t)}}else console.info('[知识库加载器] 未找到足够匹配的知识库，跳过预测性加载')},getRelevantEntries(e,t=5){if(!e||'string'!=typeof e)return[];const n=[];this.loaded.forEach((e,t)=>{if(e.entries&&Array.isArray(e.entries))for(const a of e.entries)n.push({entry:a,bookName:t,bookDisplayName:e.displayName,priority:r[t]?.priority||0})});const a=n.map(t=>{let n=0;const a=t.entry,i=a.keys||a.key||[];for(const t of i)if(e.includes(t)){n+=t.length>=3?15:10,a.name&&a.name.includes(t)&&(n+=5)}if(a.name&&e.includes(a.name)&&(n+=20),a.content){const t=a.content.substring(0,100);e.includes(t.substring(0,10))&&(n+=3)}return n+=t.priority||0,a.constant&&(n+=30),{entry:t.entry,score:n,bookName:t.bookName,bookDisplayName:t.bookDisplayName}});a.sort((e,t)=>{if(Math.abs(t.score-e.score)>5)return t.score-e.score;const n=r[e.bookName]?.priority||0;return(r[t.bookName]?.priority||0)-n});const i=a.filter(e=>e.score>0).slice(0,t).map(e=>e.entry);return i.length>0&&console.info(`[知识库加载器] 找到 ${i.length} 个相关条目 (最高分: ${a[0]?.score||0}, 来源: ${a[0]?.bookDisplayName||'未知'})`),i},async dynamicLoad(e){if(!e||'string'!=typeof e||e.length<3)return;console.info('[知识库加载器] 执行动态加载...');const t=[];for(const n in r){const a=r[n];if(this.loaded.has(n))continue;let i=0,o='',s=0;for(const t of a.keywords)e.includes(t)&&(i++,t.length>s&&(s=t.length,o=t));if(i>0){const e=10*a.priority+2*i+s;t.push({bookName:n,keyword:o,priority:a.priority,matchCount:i,score:e})}}if(0===t.length)return void console.info('[知识库加载器] 未触发动态加载');t.sort((e,t)=>Math.abs(t.score-e.score)>2?t.score-e.score:t.priority-e.priority),console.info(`[知识库加载器] 触发 ${t.length} 个知识库的动态加载`);const n=t.slice(0,3);for(const e of n){console.info(`[知识库加载器] 动态加载: ${r[e.bookName].displayName} (触发词: ${e.keyword}, 匹配数: ${e.matchCount}, 评分: ${e.score})`);try{await this.loadWorldbook(e.bookName)}catch(t){console.warn(`[知识库加载器] 动态加载失败: ${e.bookName}`,t)}}},getStatus(){const e={initialized:this.initialized,fallbackMode:this.fallbackMode,characterWorldbook:this.characterWorldbookId,loaded:[],loading:[],available:[]};this.loaded.forEach((t,n)=>{e.loaded.push({name:n,displayName:t.displayName,entries:t.entries.length,fallback:t.fallback,error:t.error,loadedAt:new Date(t.loadedAt).toLocaleTimeString()})}),this.loading.forEach((t,n)=>{e.loading.push({name:n,displayName:r[n]?.displayName||n})});for(const t in r)this.loaded.has(t)||this.loading.has(t)||e.available.push({name:t,displayName:r[t].displayName,autoLoad:r[t].autoLoad});return e},async unloadWorldbook(e){if(!this.loaded.has(e))return void console.warn(`[知识库加载器] ${e} 未加载`);console.info(`[知识库加载器] 卸载: ${r[e]?.displayName||e}`);const t=getCharWorldbookNames('current');if(this.loaded.get(e)){const n=getWorldbookNames().find(t=>t===e||t.includes(e));if(n){const e=t.additional.filter(e=>e!==n);await rebindCharWorldbooks('current',{primary:t.primary,additional:e})}}this.loaded.delete(e)},async reloadWorldbook(e){return console.info(`[知识库加载器] 重新加载: ${r[e]?.displayName||e}`),await this.unloadWorldbook(e),await this.loadWorldbook(e)},async initialize(){if(fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:738',message:'开始初始化',data:{alreadyInitialized:this.initialized,fallbackMode:this.fallbackMode},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{}),this.initialized)return void console.info('[知识库加载器] 已初始化，跳过');console.info('[知识库加载器] 初始化...'),await this.findCharacterWorldbook();let e=0,t=[];for(;e<40;){try{if(t=getWorldbookNames(),t.length>0){console.info(`[知识库加载器] ✓ 世界书列表已就绪 (${t.length} 个)`),console.info(`[知识库加载器] 可用世界书: ${t.join(', ')}`);break}}catch(e){}console.info(`[知识库加载器] 等待世界书列表... (${e+1}/40)`),await new Promise(e=>setTimeout(e,500)),e++}console.info('[知识库加载器] 已配置的知识库:');for(const e in r){const n=r[e],a=t.some(e=>e===n.displayName||e===n.name||e.includes(n.displayName));console.info(`  - ${n.displayName} (${e}): 优先级=${n.priority}, 自动加载=${n.autoLoad?'是':'否'}, 可用=`+(a?'✓':'✗'))}const n=[];for(const e in r)r[e].autoLoad&&n.push(e);console.info(`[知识库加载器] 需要自动加载 ${n.length} 个知识库`);for(const e of n)try{await this.loadWorldbook(e)}catch(t){console.warn(`[知识库加载器] 自动加载失败: ${e}`,t)}this.initialized=!0;const a=this.getStatus();if(console.info('[知识库加载器] ✓ 初始化完成'),console.table(a.loaded),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:801',message:'初始化完成',data:{loadedCount:a.loaded.length,loadingCount:a.loading.length,availableCount:a.available.length,fallbackMode:this.fallbackMode},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{}),this.fallbackMode){console.warn('═══════════════════════════════════════════════════'),console.warn('[知识库加载器] ⚠ 已进入降级模式'),console.warn('[知识库加载器] ⚠ 部分知识库使用了内置降级数据'),console.warn('[知识库加载器] ⚠ 脚本将自动退出，交由角色卡处理'),console.warn('═══════════════════════════════════════════════════');const e=a.loaded.filter(e=>e.fallback);console.table(e),setTimeout(()=>{console.info('[知识库加载器] 降级模式：开始自动卸载...'),this.shutdown()},3e3)}else console.info('[知识库加载器] ✓ 所有知识库正常加载，脚本保持运行')},shutdown(){console.info('[知识库加载器] 执行关闭流程...'),this.loaded.clear(),this.loading.clear(),s&&(delete s.loadWorldbook,delete s.unloadWorldbook,delete s.reloadWorldbook,delete s.predictiveCache,delete s.getRelevantEntries,delete s.getWorldbookStatus,delete s.dynamicLoad),this.initialized=!1,this.fallbackMode=!1,console.info('[知识库加载器] ✓ 已完全卸载，交由角色卡处理'),console.info('[知识库加载器] 脚本生命周期结束')}};s.loadWorldbook=t=>e.loadWorldbook(t),s.unloadWorldbook=t=>e.unloadWorldbook(t),s.reloadWorldbook=t=>e.reloadWorldbook(t),s.predictiveCache=t=>e.predictiveCache(t),s.dynamicLoad=t=>e.dynamicLoad(t),s.getRelevantEntries=(t,n)=>e.getRelevantEntries(t,n),s.getWorldbookStatus=()=>e.getStatus(),s.registerModule('worldbook',e),console.info('[知识库加载器] ✓ 已注册到核心系统'),s.events.on('event_triggered',t=>{const n=t;n?.description&&e.predictiveCache(n.description).catch(e=>{console.warn('[知识库加载器] 预测性缓存失败:',e)})}),s.events.on('user_input',t=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:899',message:'收到用户输入事件',data:{hasData:!!t,dataType:typeof t,textLength:'string'==typeof t?.text?t.text?.length:0,initialized:e.initialized},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});const n=t;n?.text&&n.text.length>5&&(fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:905',message:'触发动态加载',data:{textLength:n.text.length,textPreview:n.text.substring(0,50)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{}),e.dynamicLoad(n.text).catch(e=>{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:908',message:'动态加载失败',data:{error:e instanceof Error?e.message:String(e)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{}),console.warn('[知识库加载器] 动态加载失败:',e)}))}),$(()=>{console.info('[知识库加载器] 准备初始化...'),setTimeout(async()=>{console.info('[知识库加载器] 开始自动初始化...');try{await e.initialize(),console.info('[知识库加载器] ✓ 自动初始化完成')}catch(e){console.error('[知识库加载器] ✗ 自动初始化失败:',e),console.info('[知识库加载器] 💡 请手动执行: window.initWorldbookLoader()')}},2e3)}),window.initWorldbookLoader=async function(){if(console.info('[知识库加载器] 手动初始化...'),e.initialized)return console.info('[知识库加载器] 已经初始化过了'),e.getStatus();try{return await e.initialize(),console.info('[知识库加载器] ✓ 手动初始化完成'),e.getStatus()}catch(e){throw console.error('[知识库加载器] ✗ 手动初始化失败:',e),e}},console.info('[知识库加载器] ✓ 脚本加载完成'),console.info('[知识库加载器] 💡 如需手动初始化，请执行: window.initWorldbookLoader()')}else console.error('[知识库加载器] 核心系统未加载'),fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:195',message:'核心系统未加载错误',data:{windowKeys:Object.keys(window).filter(e=>e.includes('detention')||e.includes('Detention'))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});console.info('[看守所模拟器] 所有模块已加载完成');
//# sourceMappingURL=index.js.map