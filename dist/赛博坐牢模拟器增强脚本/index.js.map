{"version":3,"file":"index.js","mappings":"AAKAA,QAAQC,KAAK,kBAyDb,MAAMC,EACaC,OAAS,IAAIC,IAE9B,EAAAC,CAAGC,EAAeC,GACXC,KAAKL,OAAOM,IAAIH,IACnBE,KAAKL,OAAOO,IAAIJ,EAAO,IAEzBE,KAAKL,OAAOQ,IAAIL,GAAQM,KAAKL,EAC/B,CAEA,GAAAM,CAAIP,EAAeC,GACjB,MAAMO,EAAYN,KAAKL,OAAOQ,IAAIL,GAClC,IAAKQ,EAAW,OAChB,MAAMC,EAAQD,EAAUE,QAAQT,GAC5BQ,GAAS,GAAGD,EAAUG,OAAOF,EAAO,EAC1C,CAEA,IAAAG,CAAKZ,EAAea,GAClB,MAAML,EAAYN,KAAKL,OAAOQ,IAAIL,GAC7BQ,GACLA,EAAUM,QAAQC,IAChB,IACEA,EAAGF,EACL,CAAE,MAAOG,GACPtB,QAAQsB,MAAM,aAAahB,UAAegB,EAC5C,GAEJ,CAEA,IAAAC,CAAKjB,EAAeC,GAClB,MAAMiB,EAAWL,IACfZ,EAASY,GACTX,KAAKK,IAAIP,EAAOkB,IAElBhB,KAAKH,GAAGC,EAAOkB,EACjB,EA6BF,MAAMC,EAA+C,IAAIrB,IACzD,IAAIsB,EA0CJ,SAASC,IACP,MAGMC,EAA0B,CAC9BC,QAAS,QACTC,aAAa,EACbC,QAAS,CAAC,EACVC,OAAQ,CACNC,YAAa,IACbC,eAAgB,IAChBC,mBAAoB,GACpBC,YAAa,IACbC,oBAAqB,IACrBC,mBAAoB,KAEtBC,MAAO,CACLC,KAAM,YACNC,UAAW,EACXC,gBAAiB,EACjBC,OAAQ,IAEVxC,OArBa,IAAID,EAsBjB0C,aA9DK,CACL,GAAAlC,CAAOmC,EAAaC,EAAUC,GAC5B,MAAMC,EAASD,EAAME,KAAKC,MAAc,IAANH,EAAa,KAC/CtB,EAAWf,IAAImC,EAAK,CAAEC,QAAOE,UAC/B,EACA,GAAArC,CAAOkC,GACL,MAAMM,EAAO1B,EAAWd,IAAIkC,GAC5B,OAAKM,EACe,OAAhBA,EAAKH,QAAmBC,KAAKC,MAAQC,EAAKH,QAC5CvB,EAAW2B,OAAOP,GACX,MAEFM,EAAKL,MALM,IAMpB,EACA,GAAArC,CAAIoC,GACF,OAAyB,OAAlBrC,KAAKG,IAAIkC,EAClB,EACA,OAAOA,GACLpB,EAAW2B,OAAOP,EACpB,EACA,KAAAQ,GACE5B,EAAW4B,OACb,EACA,OAAAC,GACE,MAAMJ,EAAMD,KAAKC,MACjB,IAAK,MAAOL,EAAKM,KAAS1B,EAAW8B,UACf,OAAhBJ,EAAKH,QAAmBE,EAAMC,EAAKH,QACrCvB,EAAW2B,OAAOP,EAGxB,GAiCA3C,eAEAsD,KAAI,KACF5B,EAAOW,MAAMG,gBAAkBO,KAAKC,OAC7B,GAGT,gBAAAO,GACE,MAAMC,EAA8B,aAAtB9B,EAAOW,MAAMC,KACvBZ,EAAOI,OAAOC,YACdL,EAAOI,OAAOE,eACZyB,EAAO/B,EAAOW,MAAME,UACpBmB,EAAcD,EAAOD,EAAS,IAE9BG,EACJD,EAAa,GAAK,WAAaA,EAAa,GAAK,UAAY,SAE/D,MAAO,CACLD,OACAD,QACAE,WAAYA,EAAWE,QAAQ,GAC/BC,UAAWL,EAAQC,EACnBE,SAEJ,EAEA,gBAAAG,CAAiBC,GACfrC,EAAOW,MAAME,WAAawB,EAC1B,MAAMC,EAAStC,EAAO6B,mBAUtB,MARsB,YAAlBS,EAAOL,QACT7D,QAAQmE,KAAK,qBAAqBD,EAAON,eACzChC,EAAOzB,OAAOe,KAAK,gBAAiBgD,IACT,aAAlBA,EAAOL,SAChB7D,QAAQsB,MAAM,qBAAqB4C,EAAON,eAC1ChC,EAAOzB,OAAOe,KAAK,iBAAkBgD,IAGhCA,CACT,EAEA,eAAAE,CAAgBC,EAAkBC,EAAyB,MACzD,MAAMC,EAA0B,iBAAZF,EAAuBA,EAAUG,KAAKC,UAAUJ,GAC9DK,EAAgBJ,GAAW1C,EAAOI,OAAOG,mBAE/C,IAAIwC,EAAaJ,EACdK,QAAQ,OAAQ,KAChBA,QAAQ,WAAY,MACpBC,OAECH,EAAgB,KAClBC,EAAaA,EACVC,QAAQ,KAAM,KACdA,QAAQ,KAAM,KACdA,QAAQ,KAAM,KACdA,QAAQ,KAAM,MAGnB,MAAME,EAAeP,EAAKQ,OACpBC,EAAiBL,EAAWI,OAC5BE,GAA+C,KAArC,EAAID,EAAiBF,IAAqBhB,QAAQ,GAIlE,OAFA9D,QAAQC,KAAK,cAAc6E,YAAuBE,SAAsBC,OAEjEN,CACT,EAEA,cAAAO,CAAeC,EAAcC,GACvBxD,EAAOG,QAAQoD,IACjBnF,QAAQmE,KAAK,aAAagB,cAE5BvD,EAAOG,QAAQoD,GAAQC,EACvBpF,QAAQC,KAAK,aAAakF,SAC1BvD,EAAOzB,OAAOe,KAAK,oBAAqB,CAAEiE,OAAMC,UAClD,EAEAC,UAAuBF,GACdvD,EAAOG,QAAQoD,GAGxB,WAAAG,CAAYhE,EAAgBiE,EAAkB,WAC5C,MAAMC,EA9GZ,SAAwBlE,GACtB,OAAIA,aAAiBmE,MAAcnE,EAC5B,IAAImE,MAAuB,iBAAVnE,EAAqBA,EAAQkD,KAAKC,UAAUnD,GACtE,CA2GyBoE,CAAepE,GAC5BqE,EAAgC,CACpCC,QAASJ,EAAWI,QACpBL,UACAM,UAAW5C,KAAKC,MAChB4C,MAAON,EAAWM,OAGpBlE,EAAOW,MAAMI,OAAO/B,KAAK+E,GACzB3F,QAAQsB,MAAM,cAAciE,MAAaC,GACzC5D,EAAOzB,OAAOe,KAAK,QAASyE,GAExB/D,EAAOW,MAAMI,OAAOoC,OAAS,KAC/BnD,EAAOW,MAAMI,OAAOoD,OAExB,EAEA,iBAAAC,GACE,MAAMC,EAAuB,CAC3BC,eAAe,EACfrE,QAAS,KACTsE,WAAW,EACXC,cAAe,KACfC,cAAc,IAGsC,oBAAhBC,aACRC,EAAE,kBAAkBxB,OAAS,KACzDkB,EAAIC,eAAgB,EACY,mBAArBM,mBACTP,EAAIpE,QAAU2E,oBAAsB,OAIF,mBAA3BC,yBACTR,EAAIE,WAAY,EAChBF,EAAIG,cAAgBK,0BAA4B,MAGlD,MAAMC,EAAkBC,OAQxB,MAJyC,mBAA9BD,EAAgBE,WAAiE,mBAA9BF,EAAgBG,YAC5EZ,EAAII,cAAe,GAGdJ,CACT,EAEA,UAAAa,GACE,GAAIlF,EAAOE,YAET,YADA9B,QAAQmE,KAAK,mBAIfnE,QAAQC,KAAK,mBAEb,MAAMgG,EAAMrE,EAAOoE,oBACnBhG,QAAQC,KAAK,eAAgBgG,GAExBA,EAAIC,eACPlG,QAAQmE,KAAK,4BAGfvC,EAAOW,MAAMC,KAAO,WACpBZ,EAAOE,aAAc,EAErB9B,QAAQC,KAAK,gBACbD,QAAQC,KAAK,cAAc2B,EAAOC,WAClC7B,QAAQC,KAAK,cAAc2B,EAAOW,MAAMC,QACxCxC,QAAQC,KAAK,mBAAmB2B,EAAOI,OAAOC,eAE9CL,EAAOzB,OAAOe,KAAK,cAAe,CAAE+E,MAAK1D,MAAOX,EAAOW,OACzD,GAGF,OAAOX,CACT,CAeA2E,EAAE,KACAvG,QAAQC,KAAK,kBACb,MAAM2B,EAAS+E,OAAOI,iBAAmBpF,IACzCgF,OAAOI,gBAAkBnF,EAhB3B,SAA4BA,GACrBF,IACHA,EAAoBsF,YAAY,IAAMpF,EAAOgB,aAAaU,UAAW,KAEzE,CAcE2D,CAAmBrF,GAEnBsF,WAAW,KACT,IACEtF,EAAOkF,YACT,CAAE,MAAOxF,GACPM,EAAO0D,YAAYhE,EAAO,aAC5B,GACC,OAGLiF,EAAEI,QAAQtG,GAAG,WAAY,KAtBnBqB,IACFyF,cAAczF,GACdA,OAAoB0F,KAwBxBpH,QAAQC,KAAK,iBC3ObD,QAAQC,KAAK,kBAGboH,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,sBACV7B,QAAS,WACTzE,KAAM,CAAEuG,qBAAsBf,OAAOI,gBAAiBY,2BAA4BhB,OAAOI,iBACzFlB,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAGT,MAAMC,EAAKrB,OAAOI,gBAClB,GAAKiB,EAiBE,CAELX,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,sBACV7B,QAAS,UACTzE,KAAM,CACJU,QAASmG,EAAGnG,QACZC,YAAakG,EAAGlG,YAChBmG,YAAaD,EAAG7H,OAChB+H,YAAaC,OAAOC,KAAKJ,EAAGjG,SAAW,CAAC,GAAGgD,QAE7Cc,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAGT,MAAMM,EAA+B,CACnCC,WAAY,EACZC,aAAc,EACdC,aAAc,GACdC,cAAe,CACbC,UAAW,EACXC,YAAa,KACbC,eAAgB,KAChBC,cAAe,KACfC,gBAAiB,KACjBC,eAAgB,KAChBC,gBAAiB,KACjBC,YAAa,KACbC,aAAc,MAEhBC,aAAc,YACdC,SAAU,aAGVC,eAAgB,SAChBC,qBAAsB,EAGtBC,cAAe,CACbC,cAAe,EACfC,YAAa,EACbC,YAAa,EACbC,aAAc,EACdC,oBAAqB,GAIvBC,gBAAgB,EAGhBC,mBAAoB,EAGpBC,SAAU,CACRC,MAAO,EACPC,UAAW,EACXC,OAAQ,EACRC,MAAO,GAITC,YAAa,CACXC,SAAU,CACRlF,KAAM,OACNmF,OAAQ,GACRC,OAAQ,GACRC,MAAO,WACPC,YAAa,YACbC,UAAW,iBAEbC,cAAe,CACbxF,KAAM,OACNyF,SAAU,CAAC,GAAI,KACfJ,MAAO,gBACPC,YAAa,WACbC,UAAW,eAEbG,YAAa,CACX1F,KAAM,OACNyF,SAAU,CAAC,GAAI,IACfJ,MAAO,cACPC,YAAa,UACbC,UAAW,UAEbI,WAAY,CACV3F,KAAM,OACNyF,SAAU,CAAC,GAAI,IACfJ,MAAO,SACPC,YAAa,SACbC,UAAW,gBAEbK,aAAc,CACZ5F,KAAM,OACNyF,SAAU,CAAC,EAAG,IACdJ,MAAO,eACPC,YAAa,SACbC,UAAW,UAEbM,OAAQ,CACN7F,KAAM,MACNyF,SAAU,CAAC,GAAI,IACfJ,MAAO,SACPC,YAAa,SACbC,UAAW,UAEbO,YAAa,CACX9F,KAAM,OACNyF,SAAU,CAAC,GAAI,IACfJ,MAAO,SACPC,YAAa,SACbC,UAAW,gBAEbQ,aAAc,CACZ/F,KAAM,OACNyF,SAAU,CAAC,EAAG,IACdJ,MAAO,eACPC,YAAa,SACbC,UAAW,YAEbS,SAAU,CACRhG,KAAM,OACNyF,SAAU,CAAC,GAAI,IACfJ,MAAO,WACPC,YAAa,SACbC,UAAW,OAEbU,YAAa,CACXjG,KAAM,OACNyF,SAAU,CAAC,IAAK,KAChBJ,MAAO,cACPC,YAAa,WACbC,UAAW,aAEbW,UAAW,CACTlG,KAAM,OACNyF,SAAU,CAAC,EAAG,GACdJ,MAAO,YACPC,YAAa,OACbC,UAAW,QAKfY,gBAAiB,CACf,CACEC,GAAI,mBACJpG,KAAM,OACNqG,UAAYjJ,GAA4BA,EAAMkJ,OAAS,GACvDC,OAAQ,IACRjB,YAAa,kBACbkB,aAAa,GAEf,CACEJ,GAAI,gBACJpG,KAAM,OACNqG,UAAYjJ,GAA4BA,EAAMqJ,OAAS,GACvDF,OAAQ,IACRjB,YAAa,kBACbkB,aAAa,GAEf,CACEJ,GAAI,cACJpG,KAAM,OACNqG,UAAW,CAACK,EAA0BjK,IAChCA,EAAO0G,aAAe1G,EAAOkI,oBAC1BgC,KAAKC,SAAW,IAEzBL,OAAQ,IACRjB,YAAa,WACbuB,iBAAiB,GAEnB,CACET,GAAI,oBACJpG,KAAM,OACNqG,UAAW,CAACK,EAA0BjK,IAChCA,EAAO0G,aAAe1G,EAAOkI,oBAC1BgC,KAAKC,SAAW,GAEzBL,OAAQ,IACRjB,YAAa,aACbuB,iBAAiB,GAEnB,CACET,GAAI,gBACJpG,KAAM,KACNqG,UAAW,CAACK,EAA0BjK,KACpC,GAA4B,kBAAxBA,EAAOuH,aAAkC,OAAO,EAEpD,MAAM8C,EAAoBrK,EAAO6G,cAAcE,YAC3C/G,EAAO0G,WAAa1G,EAAO6G,cAAcE,YACzC,EAEJ,IAAIuD,EAAkB,IAGpBA,EADED,EAAoB,GACJ,IACTA,EAAoB,GACX,IAEA,IAGpB,MACME,EAAmBD,EADLJ,KAAKM,IAAI,GAAKxK,EAAO2H,cAAcC,eAGvD,OAAOsC,KAAKC,SAAWI,GAEzBT,OAAQ,IACRjB,YAAa,WACb4B,SAAU,cAEZ,CACEd,GAAI,eACJpG,KAAM,OACNqG,UAAW,CAACK,EAA0BjK,KACpC,IAAIsK,EAAkB,IAOtB,GALsBtK,EAAO0G,WAAa1G,EAAO6G,cAAcC,WAC1C,KACnBwD,EAAkB,KAGhBtK,EAAO6G,cAAcI,cAAe,CACtC,MAAMyD,EAAc1K,EAAO6G,cAAcI,cAAgBjH,EAAO0G,WAC5DgE,EAAc,GAAKA,GAAe,IACpCJ,EAAkB,GAEtB,CAEA,GAAItK,EAAO6G,cAAcM,eAAgB,CACvC,MAAMwD,EAAe3K,EAAO6G,cAAcM,eAAiBnH,EAAO0G,WAC9DiE,EAAe,GAAKA,GAAgB,IACtCL,EAAkB,IAEtB,CAEA,OAAOJ,KAAKC,SAAWG,GAEzBR,OAAQ,GACRjB,YAAa,SACb4B,SAAU,cAEZ,CACEd,GAAI,eACJpG,KAAM,OACNqG,UAAW,CAACK,EAA0BjK,KACpC,IAAKA,EAAO6G,cAAcK,gBAAiB,OAAO,EAElD,IAAIoD,EAAkB,IAElBtK,EAAOiI,iBACTqC,EAAkB,IAGpB,MAAMM,EAAY5K,EAAO4G,aACtBiE,OAAOC,GAAc,iBAATA,EAAEnB,IACdoB,KAAK,CAACC,EAAGC,KAAOA,EAAEC,KAAO,IAAMF,EAAEE,KAAO,IAAI,GAE/C,QAAIN,GAAa5K,EAAO0G,YAAckE,EAAUM,KAAO,GAAK,KAIrDhB,KAAKC,SAAWG,GAEzBR,OAAQ,GACRjB,YAAa,SACb4B,SAAU,cAEZ,CACEd,GAAI,gBACJpG,KAAM,OACNqG,UAAW,CAACjJ,EAAyBX,KACnC,GAAIW,EAAMqJ,QAAU,GAAI,OAAO,EAE/B,IAAImB,EAAc,EAEhBA,EADExK,EAAMqJ,OAAS,GACH,GACLrJ,EAAMqJ,OAAS,GACV,IACLrJ,EAAMqJ,OAAS,GACV,IAEA,IAGhB,MAAMoB,EAAcpL,EAAO4G,aACxBiE,OAAOC,GAAc,kBAATA,EAAEnB,IACdoB,KAAK,CAACC,EAAGC,KAAOA,EAAEC,KAAO,IAAMF,EAAEE,KAAO,IAAI,GAE/C,QAAIE,GAAepL,EAAO0G,YAAc0E,EAAYF,KAAO,GAAK,IAIzDhB,KAAKC,SAAWgB,GAEzBrB,OAAQ,GACRjB,YAAa,eACb4B,SAAU,cAEZ,CACEd,GAAI,uBACJpG,KAAM,OACNqG,UAAW,CAACK,EAA0BjK,KACpC,GAA4B,kBAAxBA,EAAOuH,aAAkC,OAAO,EACpD,GAAIvH,EAAO2H,cAAcK,oBAAsB,EAAG,OAAO,EAEzD,MAAMqC,EAAoBrK,EAAO6G,cAAcE,YAC3C/G,EAAO0G,WAAa1G,EAAO6G,cAAcE,YACzC,EAEJ,GAAIsD,EAAoB,IAAMA,EAAoB,IAChD,OAAO,EAGT,MAEMgB,EAAgBrL,EAAOsL,iBAAmBtL,EAAOsL,mBAAqB,GAItEf,EAHW,CAAC,KAAM,MAAO,KAAM,KAAM,MACfgB,KAAKC,GAAMH,EAAcI,SAASD,IAExBlB,IANd,IAQxB,OAAOJ,KAAKC,SAAWI,GAEzBT,OAAQ,GACRjB,YAAa,eACb4B,SAAU,aACViB,cAAc,IAKlBC,aAAc,CACZC,SAAU,CACR,CAAEjC,GAAI,oBAAqBpG,KAAM,OAAQuG,OAAQ,IACjD,CAAEH,GAAI,cAAepG,KAAM,OAAQuG,OAAQ,IAC3C,CAAEH,GAAI,eAAgBpG,KAAM,OAAQuG,OAAQ,IAC5C,CAAEH,GAAI,mBAAoBpG,KAAM,OAAQuG,OAAQ,IAChD,CAAEH,GAAI,UAAWpG,KAAM,OAAQuG,OAAQ,KAEzC+B,QAAS,CACP,CAAElC,GAAI,WAAYpG,KAAM,QAASuG,OAAQ,IACzC,CAAEH,GAAI,iBAAkBpG,KAAM,SAAUuG,OAAQ,IAChD,CAAEH,GAAI,kBAAmBpG,KAAM,QAASuG,OAAQ,IAChD,CAAEH,GAAI,SAAUpG,KAAM,OAAQuG,OAAQ,IACtC,CAAEH,GAAI,gBAAiBpG,KAAM,OAAQuG,OAAQ,IAC7C,CAAEH,GAAI,eAAgBpG,KAAM,OAAQuG,OAAQ,KAE9CgC,UAAW,CACT,CAAEnC,GAAI,kBAAmBpG,KAAM,SAAUuG,OAAQ,IACjD,CAAEH,GAAI,WAAYpG,KAAM,OAAQuG,OAAQ,IACxC,CAAEH,GAAI,gBAAiBpG,KAAM,QAASuG,OAAQ,IAC9C,CAAEH,GAAI,WAAYpG,KAAM,QAASuG,OAAQ,IACzC,CAAEH,GAAI,iBAAkBpG,KAAM,OAAQuG,OAAQ,IAC9C,CAAEH,GAAI,uBAAwBpG,KAAM,OAAQuG,OAAQ,IACpD,CAAEH,GAAI,UAAWpG,KAAM,OAAQuG,OAAQ,IAEzCiC,SAAU,CACR,CAAEpC,GAAI,mBAAoBpG,KAAM,OAAQuG,OAAQ,IAChD,CAAEH,GAAI,kBAAmBpG,KAAM,OAAQuG,OAAQ,IAC/C,CAAEH,GAAI,gBAAiBpG,KAAM,OAAQuG,OAAQ,IAC7C,CAAEH,GAAI,kBAAmBpG,KAAM,OAAQuG,OAAQ,IAC/C,CAAEH,GAAI,oBAAqBpG,KAAM,OAAQuG,OAAQ,MAKrDkC,gBAAiB,CACf,CAAErC,GAAI,qBAAsBhH,KAAM,kBAAmBmH,OAAQ,IAC7D,CAAEH,GAAI,cAAehH,KAAM,mBAAoBmH,OAAQ,IACvD,CAAEH,GAAI,cAAehH,KAAM,iBAAkBmH,OAAQ,IACrD,CAAEH,GAAI,eAAgBhH,KAAM,iBAAkBmH,OAAQ,IACtD,CAAEH,GAAI,kBAAmBhH,KAAM,kBAAmBmH,OAAQ,IAC1D,CAAEH,GAAI,oBAAqBhH,KAAM,eAAgBmH,OAAQ,IACzD,CAAEH,GAAI,uBAAwBhH,KAAM,cAAemH,OAAQ,IAC3D,CAAEH,GAAI,kBAAmBhH,KAAM,iBAAkBmH,OAAQ,IACzD,CAAEH,GAAI,aAAchH,KAAM,iBAAkBmH,OAAQ,IACpD,CAAEH,GAAI,kBAAmBhH,KAAM,gBAAiBmH,OAAQ,IACxD,CAAEH,GAAI,gBAAiBhH,KAAM,iBAAkBmH,OAAQ,IACvD,CAAEH,GAAI,qBAAsBhH,KAAM,uBAAwBmH,OAAQ,IAClE,CAAEH,GAAI,QAAShH,KAAM,iBAAkBmH,OAAQ,GAC/C,CAAEH,GAAI,QAAShH,KAAM,qBAAsBmH,OAAQ,GACnD,CAAEH,GAAI,aAAchH,KAAM,iBAAkBmH,OAAQ,GACpD,CAAEH,GAAI,kBAAmBhH,KAAM,aAAcmH,OAAQ,GACrD,CAAEH,GAAI,gBAAiBhH,KAAM,eAAgBmH,OAAQ,GACrD,CAAEH,GAAI,YAAahH,KAAM,gBAAiBmH,OAAQ,KAIpD,UAAA5E,CAAW+G,EAAW,GACpBrN,KAAK8H,WAAauF,EAClBrN,KAAKiI,cAAcC,UAAYmF,EAC/BrN,KAAK2I,aAAe,YACpB3I,KAAK4I,SAAW,aAChB5I,KAAK6I,eAAiB,SACtB7I,KAAK8I,qBAAuB,EAC5B9I,KAAKqJ,gBAAiB,EACtBrJ,KAAKsJ,mBAAqB+D,EAC1BrN,KAAK+H,aAAesF,EAEpB,IAAK,MAAMhL,KAAOsF,OAAOC,KAAK5H,KAAK+I,eACjC/I,KAAK+I,cAAc1G,GAAO,EAG5B7C,QAAQC,KAAK,gBACbD,QAAQC,KAAK,iBAAiB4N,MAE9B7F,EAAG7H,OAAOe,KAAK,2BAA4B,CACzC4L,IAAKtM,KAAK8H,WACVkC,MAAOhK,KAAK2I,cAEhB,EAEA,iBAAA2E,CAAkBC,GAChB,MAAMC,EAA4C,CAChDC,OAAQ,GACRC,OAAQ,EACRC,QAAS,IACTC,aAAc,KAGZL,KAAcC,GAChBxN,KAAK6I,eAAiB0E,EACtBvN,KAAK8I,qBAAuB0E,EAAkBD,GAE9C/N,QAAQC,KAAK,oBAAoB8N,YAAqBvN,KAAK8I,yBAE3DtB,EAAG7H,OAAOe,KAAK,qBAAsB,CACnC6M,WAAYvN,KAAK6I,eACjBgF,WAAY7N,KAAK8I,wBAGnBtJ,QAAQmE,KAAK,kBAAkB4J,IAEnC,EAEA,yBAAAO,GACM9N,KAAK8H,WAAa,IAAO,GAE7BN,EAAG7H,OAAOe,KAAK,gCAAiC,CAC9C4L,IAAKtM,KAAK8H,WACVkC,MAAOhK,KAAK2I,aACZX,aAAchI,KAAKgI,cAEvB,EAEA,eAAA+F,CAAgBC,EAAoBC,EAAS,QAC3CzO,QAAQC,KAAK,kBAAkBO,KAAK2I,mBAAmBqF,KACvDxO,QAAQC,KAAK,gBAAgBwO,KAE7B,MAAMC,EAAsB,CAC1B,YACA,WACA,gBACA,cACA,SACA,eACA,SACA,SACA,eACA,WACA,aAGIC,EAAcD,EAAW1N,QAAQwN,GACjCI,EAAeF,EAAW1N,QAAQR,KAAK2I,cAE7C,IAAqB,IAAjBwF,GAAsBA,GAAeC,EAEvC,OADA5O,QAAQmE,KAAK,wBACN,EAGT,MAAM0K,EAAuD,CAC3DxE,SAAU,cACVM,cAAe,cACfE,YAAa,iBACbiE,OAAQ,gBACR/D,aAAc,kBACdC,OAAQ,kBACR+D,OAAQ,iBACR7D,aAAc,kBACdC,SAAU,cACVE,UAAW,gBAGb,IAAK,IAAI2D,EAAIL,EAAc,EAAGK,EAAIN,EAAW3J,OAAQiK,IAAK,CACxD,MACMnM,EAAMgM,EADEH,EAAWM,IAErBnM,GAAOrC,KAAKiI,cAAc5F,KAC5BrC,KAAKiI,cAAc5F,GAAO,KAE9B,CAyBA,OAvBArC,KAAK2I,aAAeqF,EAEhBG,GAAeD,EAAW1N,QAAQ,mBACpCR,KAAK4I,SAAW,YAGlB5I,KAAKgI,aAAa5H,KAAK,CACrB2K,GAAI,qBACJpG,KAAM,OACN8J,KAAM,QACNnC,IAAKtM,KAAK8H,WACV4G,KAAMR,EAAWE,GACjBO,GAAIX,EACJC,WAGFzG,EAAG7H,OAAOe,KAAK,qBAAsB,CACnCgO,KAAMR,EAAWE,GACjBO,GAAIX,EACJC,SACA3B,IAAKtM,KAAK8H,cAGL,CACT,EAEA,kBAAA8G,CAAmBC,GACjB,MAAMC,EAAmB,CACvB,CAAEC,QAAS,2BAA4B/E,MAAO,MAC9C,CAAE+E,QAAS,eAAgB/E,MAAO,MAClC,CAAE+E,QAAS,eAAgB/E,MAAO,OAGpC,IAAK,MAAMgF,KAAQF,EAAkB,CACnC,MAAMG,EAAQJ,EAAMI,MAAMD,EAAKD,SAC/B,GAAIE,EAAO,CACT,IAAIjB,EAA4B,KAYhC,GAVIiB,EAAM,GAAGpC,SAAS,MACpBmB,EAAc,gBACLiB,EAAM,GAAGpC,SAAS,QAC3BmB,EAAc,cACLiB,EAAM,GAAGpC,SAAS,MAC3BmB,EAAc,SACLiB,EAAM,GAAGpC,SAAS,QAC3BmB,EAAc,UAGZA,EACF,OAAOhO,KAAK+N,gBAAgBC,EAAa,OAE7C,CACF,CAEA,OAAO,CACT,EAEA,UAAAkB,CAAWC,EAAO,GAChB,MAAMxP,EAAwB,GAE9B,IAAK,IAAI6O,EAAI,EAAGA,EAAIW,EAAMX,IAAK,CAC7BxO,KAAK8H,aACL9H,KAAK+H,aAAe/H,KAAK8H,WAEzB9H,KAAK8N,4BAEL,MAAMsB,EAAWpP,KAAKqP,iBAEtB,GAAID,IACFzP,EAAOS,KAAKgP,GAEZpP,KAAKgI,aAAa5H,KAAK,IAClBgP,EACH9C,IAAKtM,KAAK8H,aAGRH,OAAO2H,UAAUC,eAAeC,KAAKxP,KAAK+I,cAAeqG,EAASrE,MACpE/K,KAAK+I,cAAcqG,EAASrE,KAAO/K,KAAK+I,cAAcqG,EAASrE,KAAO,GAAK,IAGxEqE,EAASK,UAAYzP,KAAKuJ,SAASI,QAAU3J,KAAKuJ,SAASG,QAG9D,OAFAlK,QAAQC,KAAK,WAAWO,KAAK8H,oBAAoBsH,EAASzK,QAC1D6C,EAAG7H,OAAOe,KAAK,kBAAmB0O,GAC3B,CACLM,aAAa,EACb5H,WAAY9H,KAAK8H,WACjBhI,MAAOsP,EACPO,kBAAmBhQ,EAI3B,CAEA,MAAO,CACL+P,aAAa,EACb5H,WAAY9H,KAAK8H,WACjB6H,kBAAmBhQ,EAEvB,EAEA,cAAA0P,GACE,MAAMO,EAAa5P,KAAK6P,kBACxB,GAAID,EACF,MAAO,IACFA,EACHH,SAAUzP,KAAKuJ,SAASC,MACxB8C,IAAKtM,KAAK8H,YAId,MAAMgI,EAAiB9P,KAAK+P,sBAC5B,GAAID,EACF,MAAO,IACFA,EACHL,SAAUzP,KAAKuJ,SAASE,UACxB6C,IAAKtM,KAAK8H,YAId,GAAIwD,KAAKC,SAAW,GAAK,CACvB,MAAMyE,EAAchQ,KAAKiQ,sBACzB,GAAID,EACF,MAAO,IACFA,EACHP,SAAUzP,KAAKuJ,SAASG,OACxB4C,IAAKtM,KAAK8H,WAGhB,CAEA,GAAIwD,KAAKC,SAAW,IAAM,CACxB,MAAM2E,EAAYlQ,KAAKmQ,yBACvB,GAAID,EACF,MAAO,IACFA,EACHT,SAAUzP,KAAKuJ,SAASI,MACxB2C,IAAKtM,KAAK8H,WAGhB,CAEA,MAAO,CACLiD,GAAI,gBACJpG,KAAM,OACN8J,KAAM,QACNgB,SAAUzP,KAAKuJ,SAASI,MACxB2C,IAAKtM,KAAK8H,WACVmC,YAAa,QAEjB,EAEA,eAAA4F,GACE,MAAMO,EAAgBpQ,KAAK8H,WAAa9H,KAAKiI,cAAcC,UACrDmI,EAAcrQ,KAAK2I,aAEzB,IAAK3I,KAAKiI,cAAcE,YAAa,CACnC,MAAMmI,EAAUhF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAC/B0H,EAAUlF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAErC,GAAIsH,GAAiBE,GAAWF,GAAiBI,GAC3ClF,KAAKC,SAAW,GAIlB,OAHAvL,KAAKiI,cAAcE,YAAcnI,KAAK8H,WACtC9H,KAAK2I,aAAe,gBACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WACxB,CACLiD,GAAI,WACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,WACPC,YAAa,cACbyE,KAAM2B,EACN1B,GAAI,gBAIZ,CAEA,GAAI3O,KAAKiI,cAAcE,cAAgBnI,KAAKiI,cAAcG,eAAgB,CACxE,MAAMqD,EAAoBzL,KAAK8H,WAAa9H,KAAKiI,cAAcE,YACzDmI,EAAUhF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAC/B0H,EAAUlF,KAAKiF,MAAM,IAAMvQ,KAAK8I,sBAEtC,GAAI2C,GAAqB6E,GAAW7E,GAAqB+E,GAAWlF,KAAKC,SAAW,IAIlF,OAHAvL,KAAKiI,cAAcG,eAAiBpI,KAAK8H,WACzC9H,KAAK2I,aAAe,cACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WACxB,CACLiD,GAAI,cACJpG,KAAM,QACN8J,KAAM,QACNzE,MAAO,cACPC,YAAa,aACbyE,KAAM2B,EACN1B,GAAI,cAGV,CAEA,GAAI3O,KAAKiI,cAAcG,iBAAmBpI,KAAKiI,cAAcI,cAAe,CAC1E,MAAMoI,EAAuBzQ,KAAK8H,WAAa9H,KAAKiI,cAAcG,eAC5DkI,EAAUhF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAC/B0H,EAAUlF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAErC,GAAI2H,GAAwBH,GAAWG,GAAwBD,GAAWlF,KAAKC,SAAW,IAcxF,OAbAvL,KAAKiI,cAAcI,cAAgBrI,KAAK8H,WACxC9H,KAAK2I,aAAe,SACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAET,eAAlB9H,KAAK4I,WACP5I,KAAK4I,SAAW,WAChBpB,EAAG7H,OAAOe,KAAK,gBAAiB,CAC9BgO,KAAM,aACNC,GAAI,WACJV,OAAQ,UAIL,CACLlD,GAAI,cACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,SACPC,YAAa,WACbyE,KAAM2B,EACN1B,GAAI,SAGV,CAEA,GAAI3O,KAAKiI,cAAcI,gBAAkBrI,KAAKiI,cAAcK,gBAAiB,CAC3E,MAAMoI,EAAiB1Q,KAAK8H,WAAa9H,KAAKiI,cAAcI,cACtDiI,EAAUhF,KAAKiF,MAAM,EAAIvQ,KAAK8I,sBAC9B0H,EAAUlF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAErC,GAAI4H,GAAkBJ,GAAWI,GAAkBF,GAAWlF,KAAKC,SAAW,GAY5E,OAXAvL,KAAKiI,cAAcK,gBAAkBtI,KAAK8H,WAC1C9H,KAAK2I,aAAe,SACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAE/B9H,KAAK4I,SAAW,YAChBpB,EAAG7H,OAAOe,KAAK,gBAAiB,CAC9BgO,KAAM,WACNC,GAAI,YACJV,OAAQ,WAGH,CACLlD,GAAI,gBACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,eACPC,YAAa,WACbyE,KAAM2B,EACN1B,GAAI,SAGV,CAEA,GACE3O,KAAKiI,cAAcK,kBAClBtI,KAAKiI,cAAcM,iBACnBvI,KAAKiI,cAAcO,gBACpB,CAGA,GAAyB,KAFAxI,KAAK8H,WAAa9H,KAAKiI,cAAcK,gBAG5D,OAAIgD,KAAKC,SAAW,IAClBvL,KAAKiI,cAAcM,eAAiBvI,KAAK8H,WACzC9H,KAAK2I,aAAe,SACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAExB,CACLiD,GAAI,eACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,SACPC,YAAa,YACbyE,KAAM2B,EACN1B,GAAI,YAGN3O,KAAKiI,cAAcO,gBAAkBxI,KAAK8H,WAC1C9H,KAAK2I,aAAe,WACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAExB,CACLiD,GAAI,gBACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,eACPC,YAAa,aACbyE,KAAM2B,EACN1B,GAAI,YAIZ,CAEA,GAAI3O,KAAKiI,cAAcM,iBAAmBvI,KAAKiI,cAAcO,gBAAiB,CAC5E,MAAMmI,EAAkB3Q,KAAK8H,WAAa9H,KAAKiI,cAAcM,eACvD+H,EAAUhF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAC/B0H,EAAUlF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAErC,GAAI6H,GAAmBL,GAAWK,GAAmBH,GAAWlF,KAAKC,SAAW,IAK9E,OAJAvL,KAAKiI,cAAcO,gBAAkBxI,KAAK8H,WAC1C9H,KAAK2I,aAAe,WACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAExB,CACLiD,GAAI,gBACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,eACPC,YAAa,aACbyE,KAAM2B,EACN1B,GAAI,WAGV,CAEA,GAAI3O,KAAKiI,cAAcO,kBAAoBxI,KAAKiI,cAAcQ,cAAgBzI,KAAKqJ,eAAgB,CACjG,MAAMuH,EAAmB5Q,KAAK8H,WAAa9H,KAAKiI,cAAcO,gBACxD8H,EAAUhF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAC/B0H,EAAUlF,KAAKiF,MAAM,GAAKvQ,KAAK8I,sBAErC,GAAI8H,GAAoBN,GAAWM,GAAoBJ,GAAWlF,KAAKC,SAAW,IAKhF,OAJAvL,KAAKiI,cAAcQ,YAAczI,KAAK8H,WACtC9H,KAAK2I,aAAe,MACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAExB,CACLiD,GAAI,kBACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,WACPC,YAAa,WACb4G,UAAU,EACVC,WAAY,SACZpC,KAAM2B,EACN1B,GAAI,MAGV,CAEA,GAAI3O,KAAKiI,cAAcO,iBAAmBxI,KAAKqJ,iBAAmBrJ,KAAKiI,cAAcS,aAAc,CACjG,MAAMkI,EAAmB5Q,KAAK8H,WAAa9H,KAAKiI,cAAcO,gBAI9D,GAAIoI,GAHY,KAGmBA,GAFnB,KAEkDtF,KAAKC,SAAW,KAKhF,OAJAvL,KAAKiI,cAAcS,aAAe1I,KAAK8H,WAAa,EACpD9H,KAAK2I,aAAe,YACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAExB,CACLiD,GAAI,wBACJpG,KAAM,SACN8J,KAAM,QACNzE,MAAO,cACPC,YAAa,iBACbyE,KAAM2B,EACN1B,GAAI,YAGV,CAEA,OAAI3O,KAAKiI,cAAcS,cAAgB1I,KAAK8H,YAAc9H,KAAKiI,cAAcS,cAC3E1I,KAAK2I,aAAe,MACpB3I,KAAKsJ,mBAAqBtJ,KAAK8H,WAExB,CACLiD,GAAI,YACJpG,KAAM,OACN8J,KAAM,QACNzE,MAAO,YACPC,YAAa,OACb4G,UAAU,EACVC,WAAY,QACZpC,KAAM2B,EACN1B,GAAI,QAID,IACT,EAEA,mBAAAoB,GACE,MAAMhO,EAAQ/B,KAAK+Q,sBAEnB,IAAK,MAAMjR,KAASE,KAAK8K,gBACvB,KAAIhL,EAAM0L,iBAAmBxL,KAAK8H,aAAe9H,KAAKsJ,sBAIlDxJ,EAAMqL,cAAgBrL,EAAM0L,kBAC1B1L,EAAMkL,UAAUjJ,EAAO/B,OACL,IAAhBsL,KAAKC,SAAiBzL,EAAMoL,OAC9B,MAAO,CACLH,GAAIjL,EAAMiL,GACVpG,KAAM7E,EAAM6E,KACZ8J,KAAM3O,EAAM+L,UAAY,YACxB5B,YAAanK,EAAMmK,YACnB6C,aAAchN,EAAMgN,eAAgB,GAO9C,OAAO,IACT,EAEA,mBAAAmD,GACE,MAAMe,EAAQ,CAAC,WAAY,UAAW,YAAa,YAI7CC,EAAYD,EADAhR,KAAKkR,eAAeF,EAAMzM,OAF5B,CAAC,GAAI,GAAI,GAAI,MAIvB4M,EAAYnR,KAAK+M,aAAakE,GAE9BG,EAAeD,EAAUE,IAAInF,GAAKA,EAAEhB,QAEpCpL,EAAQqR,EADKnR,KAAKkR,eAAeC,EAAU5M,OAAQ6M,IAGzD,MAAO,CACLrG,GAAIjL,EAAMiL,GACVpG,KAAM7E,EAAM6E,KACZ8J,KAAMwC,EACNpF,SAAU,SACV5B,YAAa,SAASnK,EAAM6E,OAEhC,EAEA,sBAAAwL,GACE,MAAMmB,EAAUtR,KAAKoN,gBAAgBiE,IAAIE,GAAKA,EAAErG,QAC1C3K,EAAQP,KAAKkR,eAAelR,KAAKoN,gBAAgB7I,OAAQ+M,GACzDpB,EAAYlQ,KAAKoN,gBAAgB7M,GAEvC,MAAO,CACLwK,GAAImF,EAAUnF,GACdpG,KAAM,OACN8J,KAAM,YACN5C,SAAU,QACV5B,YAAaiG,EAAUnM,KACvBA,KAAMmM,EAAUnM,KAEpB,EAEA,cAAAmN,CAAeM,EAAeF,GAC5B,MAAMG,EAAcH,EAAQI,OAAO,CAACC,EAAKC,IAAMD,EAAMC,EAAG,GACxD,IAAIrG,EAASD,KAAKC,SAAWkG,EAE7B,IAAK,IAAIjD,EAAI,EAAGA,EAAIgD,EAAOhD,IAEzB,GADAjD,GAAU+F,EAAQ9C,GACdjD,GAAU,EACZ,OAAOiD,EAIX,OAAOgD,EAAQ,CACjB,EAEA,mBAAAT,GACE,MAAMc,EAAcrK,EAAG3C,UAAwC,eAC/D,OAAIgN,GAAeA,EAAY9P,MACtB8P,EAAY9P,MAGd,CACLqJ,OAAQ,GACRH,OAAQ,GACR6G,SAAU,GACVC,aAAc,GAElB,EAEA,gBAAArF,GACE,GAAIsF,MAAMC,QAAQ9L,OAAO+L,MAAO,CAE9B,OADuB/L,OAAO+L,KAAKC,OAAO,GACpBd,IAAIE,GAAKA,EAAEa,KAAO,IAAIC,KAAK,IACnD,CACA,MAAO,EACT,EAEA,iBAAAC,GACE,MAAMlC,EAAgBpQ,KAAK8H,WAAa9H,KAAKiI,cAAcC,UAE3D,MAAsB,eAAlBlI,KAAK4I,UAA6BwH,GAAiB,GAAKA,GAAiB,IACvE9E,KAAKC,SAAW,KAClBvL,KAAK4I,SAAW,WAChBpB,EAAG7H,OAAOe,KAAK,gBAAiB,CAC9BgO,KAAM,aACNC,GAAI,WACJV,OAAQ,QACR3B,IAAKtM,KAAK8H,cAEL,EAKb,EAEA,eAAAyK,CAAgBlJ,GACdrJ,KAAKqJ,eAAiBA,EACtB7J,QAAQC,KAAK,mBAAmB4J,KAEhC7B,EAAG7H,OAAOe,KAAK,+BAAgC,CAC7C2I,eAAgBrJ,KAAKqJ,eACrBiD,IAAKtM,KAAK8H,YAEd,EAEA,mBAAA0K,GACE,MAAO,CACLlG,IAAKtM,KAAK8H,WACVkC,MAAOhK,KAAK2I,aACZC,SAAU5I,KAAK4I,SACfwH,cAAepQ,KAAK8H,WAAa9H,KAAKiI,cAAcC,UACpDuK,SAAU,IAAKzS,KAAKiI,eACpBsF,WAAYvN,KAAK6I,eACjBC,qBAAsB9I,KAAK8I,qBAC3BO,eAAgBrJ,KAAKqJ,eACrBN,cAAe,IAAK/I,KAAK+I,eAE7B,EAEA,kBAAA2J,GACE,MAAMC,EAKF,CACFC,YAAa5S,KAAKgI,aAAazD,OAC/BsO,OAAQ,CAAC,EACTC,WAAY,CAAC,EACbC,aAAc/S,KAAKgI,aAAamK,OAAO,KAWzC,OARAnS,KAAKgI,aAAapH,QAASd,IACzB,MAAM2O,EAAO3O,EAAM2O,MAAQ,UAC3BkE,EAAME,OAAOpE,IAASkE,EAAME,OAAOpE,IAAS,GAAK,EAEjD,MAAMgB,EAAW3P,EAAM2P,UAAY,EACnCkD,EAAMG,WAAWrD,IAAakD,EAAMG,WAAWrD,IAAa,GAAK,IAG5DkD,CACT,EAEA,cAAAK,GACE,MAAO,CACLlL,WAAY9H,KAAK8H,WACjBa,aAAc3I,KAAK2I,aACnBC,SAAU5I,KAAK4I,SACf6J,SAAU,IAAKzS,KAAKiI,eACpBsF,WAAYvN,KAAK6I,eACjBQ,eAAgBrJ,KAAKqJ,eACrBN,cAAe,IAAK/I,KAAK+I,eACzBf,aAAc,IAAIhI,KAAKgI,cACvBsB,mBAAoBtJ,KAAKsJ,mBAE7B,EAEA,cAAA2J,CAAetS,GACb,IAAKA,EAAM,OAAO,EAElB,IAYE,OAXAX,KAAK8H,WAAanH,EAAKmH,YAAc,EACrC9H,KAAK2I,aAAgBhI,EAAKgI,cAA0B,YACpD3I,KAAK4I,SAAWjI,EAAKiI,UAAY,aACjC5I,KAAKiI,cAAiBtH,EAAK8R,UAA0B,CAAC,EACtDzS,KAAK6I,eAAiBlI,EAAK4M,YAAc,SACzCvN,KAAKqJ,eAAiB6J,QAAQvS,EAAK0I,gBACnCrJ,KAAK+I,cAAgBpI,EAAKoI,eAAiB,CAAC,EAC5C/I,KAAKgI,aAAerH,EAAKqH,cAAgB,GACzChI,KAAKsJ,mBAAqB3I,EAAK2I,oBAAsB,EAErD9J,QAAQC,KAAK,mBACN,CACT,CAAE,MAAOqB,GAEP,OADAtB,QAAQsB,MAAM,kBAAmBA,IAC1B,CACT,CACF,GAIF0G,EAAGyI,oBAAuBkD,GAAuBtL,EAAYoI,sBAC7DzI,EAAG0H,WAAcC,GAAkBtH,EAAYqH,WAAWC,GAC1D3H,EAAG4L,gBAAkB,IAAMvL,EAAY2K,sBACvChL,EAAG8K,kBAAoB,IAAMzK,EAAYyK,oBACzC9K,EAAG8F,kBAAqBC,GACtB1F,EAAYyF,kBAAkBC,GAChC/F,EAAGuG,gBAAkB,CAAC/D,EAAciE,IAAoBpG,EAAYkG,gBAAgB/D,EAAOiE,GAC3FzG,EAAG+K,gBAAmBlJ,GAA4BxB,EAAY0K,gBAAgBlJ,GAC9E7B,EAAGkL,mBAAqB,IAAM7K,EAAY6K,qBAC1ClL,EAAGwL,eAAiB,IAAMnL,EAAYmL,iBACtCxL,EAAGyL,eAAkBtS,GAAkBkH,EAAYoL,eAAetS,GAElE6G,EAAG9C,eAAe,cAAemD,GAGjCL,EAAG7H,OAAOE,GAAG,aAAec,IAE1BkG,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,uBACV7B,QAAS,WACTzE,KAAM,CACJ0S,UAAW1S,EACX2S,gBAAiB3S,EACjB4S,WAC4D,iBAAlD5S,GAAyCoD,KAC5CpD,EAA2BoD,MAAMQ,OAClC,GAERc,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAET,MAAMxD,EACsD,iBAAlDpD,GAAyCoD,KAAqBpD,EAA2BoD,UAAO6C,EACtG7C,IAEF8C,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,uBACV7B,QAAS,SACTzE,KAAM,CAAEoD,KAAMA,EAAKyP,UAAU,EAAG,KAChCnO,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAETM,EAAY+G,mBAAmB7K,MAKnCyD,EAAG7H,OAAOE,GAAG,cAAe,KAE1BgH,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,uBACV7B,QAAS,cACTzE,KAAM,CAAEmH,WAAYD,EAAYC,WAAYa,aAAcd,EAAYc,cACtEtD,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAET,IACEM,EAAYvB,WAAW,GAEvBO,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,uBACV7B,QAAS,YACTzE,KAAM,CAAEmH,WAAYD,EAAYC,WAAYa,aAAcd,EAAYc,cACtEtD,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,OAEX,CAAE,MAAOzG,GAEP+F,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,uBACV7B,QAAS,YACTzE,KAAM,CACJG,MAAOA,aAAiBmE,MAAQnE,EAAMsE,QAAUqO,OAAO3S,GACvDwE,MAAOxE,aAAiBmE,MAAQnE,EAAMwE,WAAQsB,GAEhDvB,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAET/H,QAAQsB,MAAM,gBAAiBA,EACjC,IAGFtB,QAAQC,KAAK,uBACf,MAvsCED,QAAQsB,MAAM,kBAEd+F,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,sBACV7B,QAAS,YACTzE,KAAM,CAAE+S,WAAY/L,OAAOC,KAAKzB,QAAQ8F,OAAO0H,GAAKA,EAAE9G,SAAS,cAAgB8G,EAAE9G,SAAS,eAC1FxH,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QC1DX,MAAM,EAAKpB,OAAOI,gBAElB,GAAK,EAEE,CACL/G,QAAQC,KAAK,mBAGb,MAAMmU,EAAgB,CACpBC,SAAU,CACRC,MAAO,CACLC,MAAO,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KACrD7I,OAAQ,IAEV8I,MAAO,CACLD,MAAO,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KACvG7I,OAAQ,IAEV+I,MAAO,CACLF,MAAO,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KACzJ7I,OAAQ,IAEVgJ,MAAO,CACLH,MAAO,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KACzJ7I,OAAQ,IAEViJ,MAAO,CACLJ,MAAO,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,MAClF7I,OAAQ,IAGZkJ,WAAY,CACVC,QAAS,CACPC,OAAQ,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAC/EC,OAAQ,CACN,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,MAE5CrJ,OAAQ,IAEVsJ,QAAS,CACPF,OAAQ,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAC/EC,OAAQ,CACN,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,MAE5CrJ,OAAQ,IAEVuJ,OAAQ,CACNH,OAAQ,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KACxGC,OAAQ,CACN,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,MAE5CrJ,OAAQ,IAEVwJ,aAAc,CACZJ,OAAQ,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAC/EC,OAAQ,CACN,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAC1C,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,KAAM,CAAC,IAAK,MAE5CrJ,OAAQ,KAGZyJ,SAAU,CAAC,MAAO,KAAM,MAAO,KAAM,MAAO,MAAO,MAAO,MAAO,KAAM,KAAM,KAAM,OACnFC,SAAU,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAElE,QAAAC,CAASC,GACP,IAAIC,EAAW,EAEf,KAAOA,EADa,IACW,CAC7BA,IACA,MAEMC,EAFUhV,KAAKiV,gBACHjV,KAAKkV,gBAAgBJ,GAEvC,GAAI9U,KAAKmV,YAAYH,GAAW,OAAOA,CACzC,CACA,MAAO,IAAMhV,KAAKoU,WAAWI,QAAQF,OAAO,EAC9C,EAEA,aAAAW,GACE,MAAMG,EAAQzN,OAAO0N,OAAOrV,KAAK6T,UAC3BpC,EAAc2D,EAAM1D,OAAO,CAACC,EAAK2D,IAAS3D,EAAM2D,EAAKpK,OAAQ,GACnE,IAAIK,EAASD,KAAKC,SAAWkG,EAC7B,IAAK,MAAM6D,KAAQF,EAEjB,GADA7J,GAAU+J,EAAKpK,OACXK,GAAU,EACZ,OAAO+J,EAAKvB,MAAMzI,KAAKiF,MAAMjF,KAAKC,SAAW+J,EAAKvB,MAAMxP,SAG5D,OAAOvE,KAAK6T,SAASC,MAAMC,MAAM,EACnC,EAEA,eAAAmB,CAAgBJ,GACd,MACMS,GADc,IAAI9S,MAAO+S,cACLV,EACpBW,EACJF,GAAO,GAAK,UACZA,GAAO,GAAK,UACZA,GAAO,GAAK,SAAW,eACnBG,EAAY1V,KAAKoU,WAAWqB,GAElC,GADkBnK,KAAKC,SAAW,IACjBmK,EAAUnB,OAAOhQ,OAAS,EAAG,CAC5C,MAAMoR,EAAOD,EAAUnB,OAAOjJ,KAAKiF,MAAMjF,KAAKC,SAAWmK,EAAUnB,OAAOhQ,SAC1E,OAAOoR,EAAK,GAAKA,EAAK,EACxB,CACA,OAAOD,EAAUpB,OAAOhJ,KAAKiF,MAAMjF,KAAKC,SAAWmK,EAAUpB,OAAO/P,QACtE,EAEA,WAAA4Q,CAAYxQ,GACV,OAAI3E,KAAK2U,SAAS9H,SAASlI,KACnB3E,KAAK4U,SAASjI,KAAKiJ,GAAQjR,EAAKkI,SAAS+I,GACnD,GAIIC,EAAiB,CACrBC,oBAAqB,CACnB,QAAS,MAAO,MAAO,QAAS,QAAS,QACzC,QAAS,QAAS,QAAS,QAAS,MACpC,QAAS,QAAS,QAAS,MAAO,MAClC,QAAS,QAAS,UAAW,YAC7B,cAAe,SAEjBC,OAAQ,CACNC,QAAS,CACPjC,MAAO,CAAC,QAAS,QAAS,MAAO,MAAO,QAAS,SACjD7I,OAAQ,GACR+K,cAAe,CAAC,EAAG,KAErBC,SAAU,CACRnC,MAAO,CAAC,MAAO,MAAO,MAAO,QAAS,QAAS,QAAS,MAAO,MAAO,aACtE7I,OAAQ,GACR+K,cAAe,CAAC,EAAG,KAErBE,KAAM,CACJpC,MAAO,CAAC,QAAS,QAAS,QAAS,QAAS,UAAW,UAAW,WAClE7I,OAAQ,GACR+K,cAAe,CAAC,EAAG,KAErBG,SAAU,CACRrC,MAAO,CAAC,YAAa,QAAS,QAAS,SAAU,MAAO,QAAS,OACjE7I,OAAQ,GACR+K,cAAe,CAAC,EAAG,KAErBI,OAAQ,CACNtC,MAAO,CAAC,QAAS,QAAS,QAAS,QAAS,UAAW,QAAS,eAChE7I,OAAQ,GACR+K,cAAe,CAAC,EAAG,IAErBK,MAAO,CACLvC,MAAO,CAAC,QAAS,QAAS,YAAa,QAAS,QAAS,OACzD7I,OAAQ,EACR+K,cAAe,CAAC,EAAG,KAIvB,QAAApB,GACE,GAAIvJ,KAAKC,SAAW,GAAK,CACvB,MAAMgL,EAAQvW,KAAK8V,oBAAoBxK,KAAKiF,MAAMjF,KAAKC,SAAWvL,KAAK8V,oBAAoBvR,SACrFsH,EAAW7L,KAAKwW,oBAAoBD,GAE1C,MAAO,CAAEA,QAAOE,SADCzW,KAAK0W,iBAAiB7K,EAAWA,EAASoK,cAAgB,CAAC,EAAG,KACrDpK,SAAUA,GAAY7L,KAAK+V,OAAOG,SAC9D,CAEA,MAAMS,EAAahP,OAAO0N,OAAOrV,KAAK+V,QAChCtE,EAAckF,EAAWjF,OAAO,CAACC,EAAKiF,IAAQjF,EAAMiF,EAAI1L,OAAQ,GACtE,IAAIK,EAASD,KAAKC,SAAWkG,EAC7B,IAAK,MAAM5F,KAAY8K,EAErB,GADApL,GAAUM,EAASX,OACfK,GAAU,EAAG,CAGf,MAAO,CAAEgL,MAFK1K,EAASkI,MAAMzI,KAAKiF,MAAMjF,KAAKC,SAAWM,EAASkI,MAAMxP,SAEvDkS,SADCzW,KAAK0W,iBAAiB7K,EAASoK,eACtBpK,WAC5B,CAGF,MAAO,CAAE0K,MAAO,MAAOE,SAAU,EAAG5K,SAAU7L,KAAK+V,OAAOG,SAC5D,EAEA,mBAAAM,CAAoBK,GAClB,IAAK,MAAMxU,KAAOsF,OAAOC,KAAK5H,KAAK+V,QAAS,CAC1C,MAAMlK,EAAW7L,KAAK+V,OAAO1T,GAC7B,GAAIwJ,EAASkI,MAAMlH,SAASgK,GAAY,OAAOhL,CACjD,CACA,OAAO,IACT,EAEA,gBAAA6K,CAAiBI,GACf,MAAOC,EAAKC,GAAOF,EACnB,OAAOxL,KAAKiF,MAAMjF,KAAKC,UAAYyL,EAAMD,EAAM,IAAMA,CACvD,GAIIE,EAAe,CACnBC,YAAa,GACbC,gBAAiB,GAEjB,QAAAtC,CAASrD,EAAQ,EAAGzM,EAAmC,CAAC,GACtD,MAAMqS,EAAc,GACpB,IAAK,IAAI5I,EAAI,EAAGA,EAAIgD,EAAOhD,IAAK,CAC9B,MAAM6I,EAAMrX,KAAKsX,eAAevS,GAChCqS,EAAKhX,KAAKiX,GACVrX,KAAKkX,YAAY9W,KAAKiX,EACxB,CACA,OAAOD,CACT,EAEA,cAAAE,CAAevS,EAAmC,CAAC,GACjD,MAAMwS,EAAc,EAAG1S,UAA6B,eAC9C2S,EAAYD,GAAa/E,oBAAsB+E,EAAY/E,sBAAwB,CAAC,EAEpF+C,EAAMvV,KAAKyX,cACX3C,GAAY,IAAIrS,MAAO+S,cAAgBD,EACvC5Q,EAAOiP,EAAciB,SAASC,GAC9B4C,EAAY7B,EAAehB,WAC3B8C,EAAa3X,KAAK4X,mBAAmBrC,GACrCsC,EAAc7X,KAAK8X,sBACnBC,EAAa/X,KAAKgY,mBAAmBzC,EAAKmC,GAC1CO,EAAejY,KAAKkY,uBAEpBtP,EAA0C,iBAAxB4O,GAAW5O,SAAwB4O,EAAU5O,SAAY7D,EAAQ6D,UAAuB,aAChH5I,KAAKmY,iBAAiBN,EAAaI,EAAcrP,GAkBjD,MAhBiB,CACfmC,GAAI/K,KAAKoY,aACTzT,OACA0T,OAAQ,SACR9C,MACAgB,MAAOmB,EAAUnB,MACjBE,SAAUiB,EAAUjB,SACpBkB,aACAE,cACAE,aACAE,eACArP,WACAwH,cAAe9E,KAAKiF,MAAsB,IAAhBjF,KAAKC,UAAkB,GACjDlI,OAAQ,SACRiV,UAAW7V,KAAKC,MAGpB,EAEA,WAAA+U,GACE,MAAMlM,EAASD,KAAKC,SACpB,OAAIA,EAAS,IAAaD,KAAKiF,MAAsB,EAAhBjF,KAAKC,UAAgB,GACtDA,EAAS,IAAaD,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvDA,EAAS,IAAaD,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvDA,EAAS,GAAYD,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACtDA,EAAS,IAAaD,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACpDD,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,EAC1C,EAEA,kBAAAqM,CAAmBrC,GACjB,MAAMgD,EAAU,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,KACpCjH,EAAU,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,IAGnCkH,EAAajD,EAAM,GACrB,CAAC,KAAM,OAAQ,OAAQ,QACvB,CAAC,KAAM,KAAM,KAAM,MAAO,MAAO,KAAM,MACrCkD,EAAY,CAAC,KAAM,KAAM,KAAM,KAAM,MACrCC,EAAW,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MACtD,MAAO,CACLC,OARaJ,EAAQjN,KAAKiF,MAAMjF,KAAKC,SAAWgN,EAAQhU,SASxD2G,OARaoG,EAAQhG,KAAKiF,MAAMjF,KAAKC,SAAW+F,EAAQ/M,SASxDqU,KAAMJ,EAAWlN,KAAKiF,MAAMjF,KAAKC,SAAWiN,EAAWjU,SACvDsU,KAAM,KACNC,KAAML,EAAUnN,KAAKiF,MAAMjF,KAAKC,SAAWkN,EAAUlU,SACrDmU,SAAUA,EAASpN,KAAKiF,MAAMjF,KAAKC,SAAWmN,EAASnU,SAE3D,EAEA,mBAAAuT,GACE,MAAMiB,EAAoB,CACxBC,WAAY1N,KAAKiF,MAAsB,IAAhBjF,KAAKC,UAC5B0N,YAAa3N,KAAKiF,MAAsB,IAAhBjF,KAAKC,UAC7BwG,aAAczG,KAAKiF,MAAsB,IAAhBjF,KAAKC,UAC9B2B,UAAW5B,KAAKiF,MAAsB,IAAhBjF,KAAKC,UAC3B2N,UAAW5N,KAAKiF,MAAsB,IAAhBjF,KAAKC,UAC3B4N,SAAU7N,KAAKiF,MAAsB,IAAhBjF,KAAKC,WAEtB6N,EAAiB,GAWvB,OAVIL,EAAOC,WAAa,IAAII,EAAKhZ,KAAK,QAClC2Y,EAAOE,YAAc,IAAIG,EAAKhZ,KAAK,QACnC2Y,EAAOhH,aAAe,IAAIqH,EAAKhZ,KAAK,MACpC2Y,EAAO7L,UAAY,IAAIkM,EAAKhZ,KAAK,OACjC2Y,EAAOG,UAAY,IAAIE,EAAKhZ,KAAK,MACjC2Y,EAAOI,SAAW,IAAIC,EAAKhZ,KAAK,MAChC2Y,EAAOC,WAAa,IAAII,EAAKhZ,KAAK,MAClC2Y,EAAOE,YAAc,IAAIG,EAAKhZ,KAAK,MACnC2Y,EAAO7L,UAAY,IAAIkM,EAAKhZ,KAAK,MACjC2Y,EAAOG,UAAY,IAAIE,EAAKhZ,KAAK,MAC9B,CAAE2Y,SAAQK,OACnB,EAEA,kBAAApB,CAAmBzC,EAAa8D,GAC9B,MAAMC,EAAa,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OAElDC,EAAiBvZ,KAAKkR,eAAeoI,EAAW/U,OAD7B,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,EAAG,IAE3CiV,EAAkB,CAAC,KAAM,KAAM,KAAM,MACrCC,EAAiBlE,EAAM,GAAK,CAAC,GAAI,GAAI,EAAG,GAAKA,EAAM,GAAK,CAAC,GAAI,GAAI,GAAI,GAAK,CAAC,GAAI,GAAI,GAAI,IACvFmE,EAAe1Z,KAAKkR,eAAesI,EAAgBjV,OAAQkV,GAC3DE,EAAgD,OAAlCH,EAAgBE,IAA0BpO,KAAKC,SAAW,GACxEqO,EAAgBD,EAAcrO,KAAKiF,MAAsB,EAAhBjF,KAAKC,UAAgB,EAAI,EACxE,MAAO,CACLsO,UAAWP,EAAWC,GACtBO,cAAeN,EAAgBE,GAC/BC,cACAC,gBACAG,SAAU/Z,KAAKga,mBACfC,iBAAkB3O,KAAKC,SAAW,GAAMD,KAAKiF,MAAsB,EAAhBjF,KAAKC,UAAgB,EAAI,EAEhF,EAEA,gBAAAyO,GACE,MAAME,EAAY,CAChB,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KACtD,KAAM,KAAM,KAAM,KAAM,MAAO,KAAM,KAAM,KAAM,KAAM,MAEzD,OAAOA,EAAU5O,KAAKiF,MAAMjF,KAAKC,SAAW2O,EAAU3V,QACxD,EAEA2T,qBAAoB,KACX,CACLiC,cAAe,GACfC,QAAS,KACTC,OAAQ,GACRC,QAAS,GACTC,UAAWjP,KAAKiF,MAAsB,IAAhBjF,KAAKC,YAI/B,gBAAA4M,CAAiBN,EAA6BI,EAA+BrP,GAC1D,eAAbA,GACFiP,EAAYkB,OAAO7L,WAAa,GAChC+K,EAAasC,WAAa,IACJ,aAAb3R,GACTiP,EAAYkB,OAAO7L,WAAa,GAChC2K,EAAYkB,OAAOC,YAAc,GACX,cAAbpQ,IACTiP,EAAYkB,OAAO7L,WAAa,GAChC2K,EAAYkB,OAAOC,YAAc,GACjCf,EAAasC,WAAa,IAE3B5S,OAAOC,KAAKiQ,EAAYkB,QAAmCnY,QAAQyB,IAClEwV,EAAYkB,OAAO1W,GAAOiJ,KAAK0L,IAAI,EAAG1L,KAAKyL,IAAI,IAAKc,EAAYkB,OAAO1W,OAEzE4V,EAAasC,UAAYjP,KAAK0L,IAAI,EAAG1L,KAAKyL,IAAI,IAAKkB,EAAasC,WAClE,EAEA,cAAArJ,CAAeM,EAAeF,GAC5B,MAAMG,EAAcH,EAAQI,OAAO,CAACC,EAAKC,IAAMD,EAAMC,EAAG,GACxD,IAAIrG,EAASD,KAAKC,SAAWkG,EAC7B,IAAK,IAAIjD,EAAI,EAAGA,EAAIgD,EAAOhD,IAEzB,GADAjD,GAAU+F,EAAQ9C,GACdjD,GAAU,EAAG,OAAOiD,EAE1B,OAAOgD,EAAQ,CACjB,EAEA4G,WAAU,IACD,OAAS3V,KAAKC,MAAQ,IAAM4I,KAAKC,SAASiP,SAAS,IAAIrI,MAAM,EAAG,IAGzE,gBAAAsI,CAAiBxJ,GACf,MAAkB,kBAAdA,EAAsCjR,KAAK0a,iBAC7B,iBAAdzJ,EAAqCjR,KAAK2a,iBAC5B,iBAAd1J,EAAqCjR,KAAK4a,iBAC5B,kBAAd3J,EAAsCjR,KAAK6a,iBAC7B,yBAAd5J,EACK,CAAE6J,OAAQ9a,KAAK0a,iBAAkBK,UAAW/a,KAAK6U,SAAS,EAAG,CAAEpG,KAAM,aAEvEzO,KAAKsX,eAAe,CAAErG,aAC/B,EAEA,cAAAyJ,GACE,MAAMnF,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvCuJ,GAAY,IAAIrS,MAAO+S,cAAgBD,EACvC5Q,EAAOiP,EAAciB,SAASC,GAC9BkG,EAAQ,CAAC,KAAM,KAAM,MAAO,MAC5BC,EAAOD,EAAM1P,KAAKiF,MAAMjF,KAAKC,SAAWyP,EAAMzW,SA8BpD,MA7BiB,CACfwG,GAAI/K,KAAKoY,aACTzT,OACA0T,OAAQ,SACR9C,MACA2F,KAAM,SACND,OACAtD,WAAY3X,KAAK4X,mBAAmBrC,GACpCsC,YAAa,CACXkB,OAAQ,CACNC,WAAY1N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC7C0N,YAAa3N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC9CwG,aAAczG,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC/C2B,UAAW5B,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C2N,UAAW5N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C4N,SAAU7N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,IAE7C6N,KAAM,CAAC,KAAM,OAEf+B,SAAU7P,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC3CgL,MAAO,KACPE,SAAU,EACVsB,WAAY/X,KAAKgY,mBAAmBzC,EAAK,CAAEgB,MAAO,GAAIE,SAAU,EAAG5K,SAAU,CAAEoK,cAAe,CAAC,EAAG,MAClGgC,aAAcjY,KAAKkY,uBACnBtP,SAAU,QACVwH,cAAe,EACf/M,OAAQ,SACRiV,UAAW7V,KAAKC,MAGpB,EAEA,cAAAiY,GACE,MAAMpF,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvCuJ,GAAY,IAAIrS,MAAO+S,cAAgBD,EACvC6F,EAAW9P,KAAKC,SAAW,GAC3B5G,EAAOiP,EAAciB,SAASC,GAC9B9D,EAAQ,CAAC,SAAU,OAAQ,QAE3BqK,EAAYrb,KAAKkR,eAAeF,EAAMzM,OADxB,CAAC,GAAI,GAAI,KAgC7B,MA9BiB,CACfwG,GAAI/K,KAAKoY,aACTzT,OACA0T,OAAQ+C,EAAW,SAAW,OAC9B7F,MACA2F,KAAM,SACNzM,KAAMuC,EAAMqK,GACZ1D,WAAY3X,KAAK4X,mBAAmBrC,GACpCsC,YAAa,CACXkB,OAAQ,CACNC,WAAY1N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC7C0N,YAAa3N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC9CwG,aAAczG,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC/C2B,UAAW5B,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C2N,UAAW5N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C4N,SAAU7N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,IAE7C6N,KAAM,CAAC,KAAM,OAEfkC,WAAYhQ,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,EAC7CgQ,YAAajQ,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC9CgL,MAAO,KACPE,SAAU,EACVsB,WAAY/X,KAAKgY,mBAAmBzC,EAAK,CAAEgB,MAAO,GAAIE,SAAU,EAAG5K,SAAU,CAAEoK,cAAe,CAAC,EAAG,MAClGgC,aAAcjY,KAAKkY,uBACnBtP,SAAU,WACVwH,cAAe,EACf/M,OAAQ,SACRiV,UAAW7V,KAAKC,MAGpB,EAEA,cAAAkY,GACE,MAAMY,EAAgB,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAG3DC,EAAWD,EADKxb,KAAKkR,eAAesK,EAAcjX,OADxC,CAAC,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,EAAG,KAG5C,IAAIgR,EAAM,GACN6F,GAAW,EACE,OAAbK,GACFlG,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvC6P,GAAW,GACW,OAAbK,GACTlG,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvC6P,GAAW,GACW,OAAbK,GACTlG,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvC6P,GAAW,GACW,OAAbK,GACTlG,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvC6P,GAAW,GACW,OAAbK,GAAkC,OAAbA,GAC9BlG,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvC6P,GAAW,GACW,OAAbK,GACTlG,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,EACvC6P,GAAW,GACW,OAAbK,IACTlG,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,EACvC6P,GAAW,GAEb,MAAMtG,GAAY,IAAIrS,MAAO+S,cAAgBD,EACvC5Q,EAAOiP,EAAciB,SAASC,GA8BpC,MA7BiB,CACf/J,GAAI/K,KAAKoY,aACTzT,OACA0T,OAAQ+C,EAAW,SAAW,OAC9B7F,MACA2F,KAAM,SACNO,WACA9D,WAAY3X,KAAK4X,mBAAmBrC,GACpCsC,YAAa,CACXkB,OAAQ,CACNC,WAAY1N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC7C0N,YAAa3N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC9CwG,aAAczG,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC/C2B,UAAW5B,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C2N,UAAW5N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C4N,SAAU7N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,IAE7C6N,KAAM,CAAC,KAAM,OAEfsC,aAAcpQ,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC/CgL,MAAO,KACPE,SAAU,EACVsB,WAAY/X,KAAKgY,mBAAmBzC,EAAK,CAAEgB,MAAO,GAAIE,SAAU,EAAG5K,SAAU,CAAEoK,cAAe,CAAC,EAAG,MAClGgC,aAAcjY,KAAKkY,uBACnBtP,SAAU,WACVwH,cAAe,EACf/M,OAAQ,SACRiV,UAAW7V,KAAKC,MAGpB,EAEA,cAAAmY,GACE,MAAMtF,EAAMjK,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GACvCuJ,GAAY,IAAIrS,MAAO+S,cAAgBD,EACvC5Q,EAAOiP,EAAciB,SAASC,GAC9B6G,EAAc,CAAC,KAAM,KAAM,MAAO,KAAM,OACxCC,EAAYD,EAAYrQ,KAAKiF,MAAMjF,KAAKC,SAAWoQ,EAAYpX,SA8BrE,MA7BiB,CACfwG,GAAI/K,KAAKoY,aACTzT,OACA0T,OAAQ,SACR9C,MACA2F,KAAM,SACNU,YACAjE,WAAY3X,KAAK4X,mBAAmBrC,GACpCsC,YAAa,CACXkB,OAAQ,CACNC,WAAY1N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC7C0N,YAAa3N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC9CwG,aAAczG,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC/C2B,UAAW5B,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C2N,UAAW5N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,GAC5C4N,SAAU7N,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,IAE7C6N,KAAM,CAAC,KAAM,OAEfkC,WAAYhQ,KAAKiF,MAAsB,GAAhBjF,KAAKC,UAAiB,EAC7CgL,MAAO,KACPE,SAAU,EACVsB,WAAY/X,KAAKgY,mBAAmBzC,EAAK,CAAEgB,MAAO,GAAIE,SAAU,EAAG5K,SAAU,CAAEoK,cAAe,CAAC,EAAG,MAClGgC,aAAcjY,KAAKkY,uBACnBtP,SAAU,WACVwH,cAAe,EACf/M,OAAQ,SACRiV,UAAW7V,KAAKC,MAGpB,EAEA,kBAAAmZ,GACE,OAAO7b,KAAKmX,eACd,EAEA,kBAAA2E,CAAmB1E,GACjBpX,KAAKmX,gBAAkBC,EACvB,EAAGzX,OAAOe,KAAK,oBAAqB,CAAE0W,QACxC,EAEA,YAAA2E,CAAa1E,GACXrX,KAAKmX,gBAAgB/W,KAAKiX,GAC1B,EAAG1X,OAAOe,KAAK,kBAAmB,CAAE2W,OACtC,EAEA,iBAAA2E,CAAkBC,GAChB,MAAM1b,EAAQP,KAAKmX,gBAAgB+E,UAAUC,GAAKA,EAAEpR,KAAOkR,GAC3D,IAAe,IAAX1b,EAAc,CAChB,MAAM8W,EAAMrX,KAAKmX,gBAAgB1W,OAAOF,EAAO,GAAG,GAElD,OADA,EAAGZ,OAAOe,KAAK,gBAAiB,CAAE2W,QAC3BA,CACT,CACA,OAAO,IACT,EAEA,WAAA+E,CAAYH,GACV,OAAOjc,KAAKkX,YAAYmF,KAAKF,GAAKA,EAAEpR,KAAOkR,IAAUjc,KAAKmX,gBAAgBkF,KAAKF,GAAKA,EAAEpR,KAAOkR,EAC/F,EAEA,kBAAAK,CAAmBL,EAAeM,GAChC,MAAMlF,EAAMrX,KAAKoc,YAAYH,GACzB5E,GAAOA,EAAIY,eACbZ,EAAIY,aAAakC,cAAgB7O,KAAK0L,IAAI,EAAG1L,KAAKyL,IAAI,IAAKM,EAAIY,aAAakC,cAAgBoC,IAC5F,EAAG5c,OAAOe,KAAK,uBAAwB,CACrCub,QACAO,QAASnF,EAAI1S,KACbrC,MAAO+U,EAAIY,aAAakC,cACxBoC,UAGN,EAEA,UAAAE,GACE,MAAO,CACLC,SAAU1c,KAAKkX,YACfyF,YAAa3c,KAAKmX,gBAEtB,EAEA,UAAAyF,CAAWjc,GACT,IAAKA,EAAM,OAAO,EAClB,IAIE,OAHAX,KAAKkX,YAAcvW,EAAK+b,UAAY,GACpC1c,KAAKmX,gBAAkBxW,EAAKgc,aAAe,GAC3Cnd,QAAQC,KAAK,mBACN,CACT,CAAE,MAAOqB,GAEP,OADAtB,QAAQsB,MAAM,kBAAmBA,IAC1B,CACT,CACF,EAEA,SAAA+b,GACE7c,KAAKkX,YAAc,GACnBlX,KAAKmX,gBAAkB,GACvB3X,QAAQC,KAAK,gBACf,GAIF,EAAGqd,YAAc,CAACtL,EAAgBzM,IAAsCkS,EAAapC,SAASrD,EAAOzM,GAAW,CAAC,GACjH,EAAGgY,oBAAuB9L,GAAsBgG,EAAawD,iBAAiBxJ,GAC9E,EAAG4K,mBAAqB,IAAM5E,EAAa4E,qBAC3C,EAAGC,mBAAsB1E,GAAgBH,EAAa6E,mBAAmB1E,GACzE,EAAG2E,aAAgB1E,GAAaJ,EAAa8E,aAAa1E,GAC1D,EAAG2E,kBAAqBC,GAAkBhF,EAAa+E,kBAAkBC,GACzE,EAAGe,QAAWf,GAAkBhF,EAAamF,YAAYH,GACzD,EAAGgB,sBAAwB,CAAChB,EAAeM,IAAkBtF,EAAaqF,mBAAmBL,EAAOM,GACpG,EAAGW,cAAgB,IAAMjG,EAAawF,aACtC,EAAGU,cAAiBxc,GAAqDsW,EAAa2F,WAAWjc,GAEjG,EAAG+D,eAAe,YAAauS,GAG/B,EAAGtX,OAAOE,GAAG,kBAAoBC,IAC/B,MAAMsd,EAAsE,iBAApDtd,GAA6CiL,GAChEjL,EAAgCiL,QACjCnE,EACJ,GAAKwW,GACD,CAAC,gBAAiB,eAAgB,eAAgB,gBAAiB,wBAAwBvQ,SAASuQ,GAAU,CAChH,MAAM/F,EAAMJ,EAAawD,iBAAiB2C,GAC1C,EAAGzd,OAAOe,KAAK,sBAAuB,CAAEZ,QAAOuX,OACjD,IAIF,EAAG1X,OAAOE,GAAG,gBAAkBc,IAC7B,MAAMgO,EAAMhO,GAA0CgO,GAChD0O,EAA4B,iBAAP1O,EAAkBA,EAAK,aAC5C2O,EAAWhS,KAAKiF,MAAsB,EAAhBjF,KAAKC,UAAgB,EAC3CgS,EAAUtG,EAAapC,SAASyI,EAAU,CAAE1U,SAAUyU,IAC5DpG,EAAa6E,mBAAmByB,GAChC/d,QAAQC,KAAK,kBAAkB6d,gBAGjC9d,QAAQC,KAAK,2BACf,MAhqBED,QAAQsB,MAAM,mBCxDhB,MAAM0c,EAA8C,CAClDC,gBAAiB,CACf9Y,KAAM,kBACN+Y,YAAa,QACbzT,YAAa,2BACbwF,SAAU,GACVkO,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,OACA,QACA,OACA,KACA,KACA,KACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,cACVC,MAAO,EACPC,gBAAiB,IAEnBC,0BAA2B,CACzBrZ,KAAM,4BACN+Y,YAAa,QACbzT,YAAa,4BACbwF,SAAU,EACVkO,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,OACA,OACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,IAEnBE,qBAAsB,CACpBtZ,KAAM,uBACN+Y,YAAa,QACbzT,YACE,+DACFwF,SAAU,EACVkO,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,KACA,KACA,KACA,OACA,OACA,QACA,MACA,OACA,MACA,KACA,KACA,MACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,cACVC,MAAO,EACPC,gBAAiB,IAEnBG,gBAAiB,CACfvZ,KAAM,kBACN+Y,YAAa,QACbzT,YAAa,mBACbwF,SAAU,EACVkO,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,OACA,OACA,OACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,QAEFC,UAAU,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,IAEnBI,yBAA0B,CACxBxZ,KAAM,2BACN+Y,YAAa,QACbzT,YAAa,uCACbwF,SAAU,EACVkO,SAAU,CACR,KACA,MACA,MACA,MACA,KACA,KACA,KACA,KACA,OACA,KACA,OACA,OACA,KACA,KACA,KACA,MACA,KACA,KACA,MACA,MACA,MACA,KACA,MAEFC,UAAU,EACVC,SAAU,cACVC,MAAO,EACPC,gBAAiB,IAEnBK,uBAAwB,CACtBzZ,KAAM,yBACN+Y,YAAa,QACbzT,YAAa,qBACbwF,SAAU,EACVkO,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,KAwBrBve,QAAQC,KAAK,yBAGboH,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,aACTzE,KAAM,CAAEuG,qBAAsBf,OAAOI,gBAAiBY,2BAA4BhB,OAAOI,iBACzFlB,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAGT,MAAM,EAAKpB,OAAOI,gBAElB,GAAK,EAiBE,CAELM,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,UACTzE,KAAM,CACJU,QAAS,EAAGA,QACZC,YAAa,EAAGA,YAChBmG,YAAa,EAAG9H,OAChB+H,YAAaC,OAAOC,KAAK,EAAGrG,SAAW,CAAC,GAAGgD,QAE7Cc,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAGR,EAAkD8W,YAAc,mBACjE7e,QAAQC,KAAK,sBAGb,MAAM6e,EAAuC,CAC3CC,OAAQ,IAAI3e,IACZ4e,QAAS,IAAI5e,IACb0B,aAAa,EACbmd,cAAc,EACdC,qBAAsB,KAKtB,4BAAMC,GACJnf,QAAQC,KAAK,yBAEb,IACE,MAAMmf,EAAiBC,sBAAsB,WAC7C,OAAID,EAAeE,SACjBtf,QAAQC,KAAK,wBAAwBmf,EAAeE,WACpD9e,KAAK0e,qBAAuBE,EAAeE,QACpCF,EAAeE,SAGpBF,EAAeG,WAAWxa,OAAS,GACrC/E,QAAQC,KAAK,yBAAyBmf,EAAeG,WAAW,MAChE/e,KAAK0e,qBAAuBE,EAAeG,WAAW,GAC/CH,EAAeG,WAAW,KAGnCvf,QAAQmE,KAAK,yBACN,KACT,CAAE,MAAO7C,GAEP,OADAtB,QAAQsB,MAAM,sBAAuBA,GAC9B,IACT,CACF,EAKA,mBAAMke,CAAcC,GAClB,MAAMzd,EAASgc,EAAWyB,GAC1B,IAAKzd,EACH,MAAM,IAAIyD,MAAM,WAAWga,KAI7B,GAAIjf,KAAKue,OAAOte,IAAIgf,GAElB,OADAzf,QAAQC,KAAK,YAAY+B,EAAOkc,sBACzB1d,KAAKue,OAAOpe,IAAI8e,GAIzB,GAAIjf,KAAKwe,QAAQve,IAAIgf,GAEnB,OADAzf,QAAQC,KAAK,YAAY+B,EAAOkc,gCACnB1d,KAAKwe,QAAQre,IAAI8e,GAIhC,MAAMC,EAAclf,KAAKmf,uBAAuBF,EAAUzd,GAC1DxB,KAAKwe,QAAQte,IAAI+e,EAAUC,GAE3B,IACE,MAAME,QAAeF,EAErB,OADAlf,KAAKue,OAAOre,IAAI+e,EAAUG,GACnBA,CACT,C,QACEpf,KAAKwe,QAAQ5b,OAAOqc,EACtB,CACF,EAKA,4BAAME,CAAuBF,EAAkBzd,GAC7ChC,QAAQC,KAAK,kBAAkB+B,EAAOkc,gBAAgBuB,MAGtDpY,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,UACTzE,KAAM,CAAEse,WAAUvB,YAAalc,EAAOkc,YAAajO,SAAUjO,EAAOiO,UACpEpK,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAGT,IAEE,MAAM8X,EAAoBC,oBAE1BzY,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,YACTzE,KAAM,CACJ6Q,MAAO6N,EAAkB9a,OACzBwP,MAAOsL,EAAkBlN,MAAM,EAAG,IAClCoN,kBAAmB/d,EAAOkc,YAC1B8B,WAAYhe,EAAOmD,MAErBU,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAIT,IAAIkY,EAAqC,KAGzC,MAAMC,EAAoBL,EAAkBhD,KAAK1X,GAAQA,IAASnD,EAAOkc,aACzE,GAAIgC,EACFD,EAAsBC,EACtBlgB,QAAQC,KAAK,yBAAyB+B,EAAOkc,qBACxC,GAAI2B,EAAkBxS,SAASrL,EAAOmD,MAE3C8a,EAAsBje,EAAOmD,KAC7BnF,QAAQC,KAAK,yBAAyB+B,EAAOmD,aACxC,CAEL,MAAMgb,EAAaN,EAAkBhD,KACnC1X,GACEA,EAAKkI,SAASrL,EAAOkc,cACrBlc,EAAOkc,YAAY7Q,SAASlI,IAC5BA,EAAKkI,SAASrL,EAAOmD,OACrBnD,EAAOmD,KAAKkI,SAASlI,IAErBgb,IACFF,EAAsBE,EACtBngB,QAAQC,KAAK,qBAAqBkgB,MAEtC,CAEA,IAAKF,EAAqB,CACxB,MAAMG,EAAiBP,EAAkBhN,KAAK,MAqB9C,MAnBAxL,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,UACTzE,KAAM,CACJse,WACAvB,YAAalc,EAAOkc,YACpBmC,eAAgBR,EAAkB9a,OAClCub,eAAgBT,GAElBha,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAEH,IAAItC,MACR,WAAWzD,EAAOkc,gBAAgBuB,eACrBW,6CAGjB,CAEA/Y,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,UACTzE,KAAM,CAAEse,WAAUQ,sBAAqB/B,YAAalc,EAAOkc,aAC3DrY,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAIT,MAAMxE,QAAgBgd,aAAaN,GAEnC,GAAuB,IAAnB1c,EAAQwB,OACV,MAAM,IAAIU,MAAM,SAIlB,MAAM2Z,EAAiBC,sBAAsB,WAW7C,OAVKD,EAAeG,WAAWlS,SAAS4S,WAChCO,qBAAqB,UAAW,CACpClB,QAASF,EAAeE,QACxBC,WAAY,IAAIH,EAAeG,WAAYU,KAE7CjgB,QAAQC,KAAK,uBAAuBggB,MAGtCjgB,QAAQC,KAAK,cAAc+B,EAAOkc,qBAAqB3a,EAAQwB,cAExD,CACLI,KAAMsa,EACNvB,YAAalc,EAAOkc,YACpB3a,QAASA,EACTkd,UAAU,EACVC,SAAUzd,KAAKC,MAEnB,CAAE,MAAO5B,GACP,MAAMqf,EAAerf,aAAiBmE,MAAQnE,EAAMsE,QAAUqO,OAAO3S,GAIrE,GAHAtB,QAAQmE,KAAK,cAAcnC,EAAOkc,oBAAqByC,GAGnD3e,EAAOuc,iBAAmBvc,EAAOuc,gBAAgBxZ,OAAS,EAI5D,OAHA/E,QAAQC,KAAK,cAAc+B,EAAOkc,uBAAuBlc,EAAOuc,gBAAgBxZ,cAChFvE,KAAKye,cAAe,EAEb,CACL9Z,KAAMsa,EACNvB,YAAalc,EAAOkc,YACpB3a,QAASvB,EAAOuc,gBAChBkC,UAAU,EACVnf,MAAOqf,EACPD,SAAUzd,KAAKC,OAInB,MAAM5B,CACR,CACF,EAKA,qBAAMsf,CAAgBrb,GACpB,IAAKA,GAA8B,iBAAZA,EACrB,OAGFvF,QAAQC,KAAK,uBAEb,MAAM4gB,EAAmG,GAEzG,IAAK,MAAMpB,KAAYzB,EAAY,CACjC,MAAMhc,EAASgc,EAAWyB,GAE1B,GAAIjf,KAAKue,OAAOte,IAAIgf,GAClB,SAGF,IAAIqB,EAAa,EACbC,EAAgB,EAGpB,IAAK,MAAMC,KAAWhf,EAAOmc,SAC3B,GAAI5Y,EAAQ8H,SAAS2T,GAAU,CAC7BF,IAGAC,GADsBC,EAAQjc,QAAU,EAAI,EAAI,EAI5C/C,EAAOyI,aAAezI,EAAOyI,YAAY4C,SAAS2T,KACpDD,GAAiB,EAErB,CAIF,GAAI/e,EAAOyI,YAAa,CACtB,MAAMwW,EAAejf,EAAOyI,YAAYgF,MAAM,yBAA2B,GACzE,IAAK,MAAMyR,KAAUD,EACf1b,EAAQ8H,SAAS6T,IAAWA,EAAOnc,QAAU,IAC/Cgc,GAAiB,GAGvB,CAEA,GAAID,EAAa,EAAG,CAElB,MAAMK,EAA+B,GAAlBnf,EAAOiO,SAAgB8Q,EAE1CF,EAAYjgB,KAAK,CACf6e,WACA2B,MAAON,EACP7Q,SAAUjO,EAAOiO,SACjB8Q,cAAeI,GAEnB,CACF,CAGAN,EAAYlU,KAAK,CAACC,EAAGC,IACff,KAAKuV,IAAIxU,EAAEkU,cAAgBnU,EAAEmU,eAAiB,EACzClU,EAAEkU,cAAgBnU,EAAEmU,cAEzBlU,EAAEoD,WAAarD,EAAEqD,SACZpD,EAAEoD,SAAWrD,EAAEqD,SAEjBpD,EAAEuU,MAAQxU,EAAEwU,OAGrBphB,QAAQC,KAAK,mBAAmB4gB,EAAY9b,eAG5C,MAAMuc,EAAST,EAAYpU,OAAO8U,GAAKA,EAAER,cAAgB,IAAIpO,MAAM,EAAG,GAEtE,GAAsB,IAAlB2O,EAAOvc,OAKX,IAAK,MAAMyc,KAAQF,EAAQ,CACzBthB,QAAQC,KACN,mBAAmB+d,EAAWwD,EAAK/B,UAAUvB,uBAChCsD,EAAKJ,gBAAgBI,EAAKT,cAAcjd,QAAQ,OAG/D,UACQtD,KAAKgf,cAAcgC,EAAK/B,SAChC,CAAE,MAAOne,GACPtB,QAAQmE,KAAK,qBAAqBqd,EAAK/B,WAAYne,EACrD,CACF,MAfEtB,QAAQC,KAAK,+BAgBjB,EAKA,kBAAAwhB,CAAmBlc,EAAiBmc,EAAqB,GACvD,IAAKnc,GAA8B,iBAAZA,EACrB,MAAO,GAGT,MAAMoc,EAAqG,GAE3GnhB,KAAKue,OAAO3d,QAAQ,CAACwgB,EAAUnC,KAC7B,GAAImC,EAASre,SAAWiP,MAAMC,QAAQmP,EAASre,SAC7C,IAAK,MAAMse,KAASD,EAASre,QAC3Boe,EAAW/gB,KAAK,CACdihB,QACApC,SAAUA,EACVqC,gBAAiBF,EAAS1D,YAC1BjO,SAAU+N,EAAWyB,IAAWxP,UAAY,MAMpD,MAAM8R,EAAgBJ,EAAW9P,IAAI1O,IACnC,IAAIie,EAAQ,EACZ,MAAMS,EAAQ1e,EAAK0e,MAObzZ,EAAOyZ,EAAMzZ,MAAQyZ,EAAMhf,KAAO,GAGxC,IAAK,MAAMA,KAAOuF,EAChB,GAAI7C,EAAQ8H,SAASxK,GAAM,CAEzBue,GADkBve,EAAIkC,QAAU,EAAI,GAAK,GAIrC8c,EAAM1c,MAAQ0c,EAAM1c,KAAKkI,SAASxK,KACpCue,GAAS,EAEb,CASF,GALIS,EAAM1c,MAAQI,EAAQ8H,SAASwU,EAAM1c,QACvCic,GAAS,IAIPS,EAAMxd,QAAS,CACjB,MAAM2d,EAAeH,EAAMxd,QAAQ2P,UAAU,EAAG,KAC5CzO,EAAQ8H,SAAS2U,EAAahO,UAAU,EAAG,OAC7CoN,GAAS,EAEb,CAUA,OAPAA,GAASje,EAAK8M,UAAY,EAGtB4R,EAAMI,WACRb,GAAS,IAGJ,CACLS,MAAO1e,EAAK0e,MACZT,QACA3B,SAAUtc,EAAKsc,SACfqC,gBAAiB3e,EAAK2e,mBAK1BC,EAAcpV,KAAK,CAACC,EAAGC,KACrB,GAAIf,KAAKuV,IAAIxU,EAAEuU,MAAQxU,EAAEwU,OAAS,EAChC,OAAOvU,EAAEuU,MAAQxU,EAAEwU,MAGrB,MAAMc,EAAYlE,EAAWpR,EAAE6S,WAAWxP,UAAY,EAEtD,OADkB+N,EAAWnR,EAAE4S,WAAWxP,UAAY,GACnCiS,IAGrB,MAAMC,EAAWJ,EACdtV,OAAOtJ,GAAQA,EAAKie,MAAQ,GAC5BzO,MAAM,EAAG+O,GACT7P,IAAI1O,GAAQA,EAAK0e,OASpB,OAPIM,EAASpd,OAAS,GACpB/E,QAAQC,KACN,eAAekiB,EAASpd,sBACbgd,EAAc,IAAIX,OAAS,UAAUW,EAAc,IAAID,iBAAmB,SAIlFK,CACT,EAKA,iBAAMC,CAAYC,GAChB,IAAKA,GAAkC,iBAAdA,GAA0BA,EAAUtd,OAAS,EACpE,OAGF/E,QAAQC,KAAK,sBAEb,MAAMqiB,EAMD,GAEL,IAAK,MAAM7C,KAAYzB,EAAY,CACjC,MAAMhc,EAASgc,EAAWyB,GAE1B,GAAIjf,KAAKue,OAAOte,IAAIgf,GAClB,SAGF,IAAI8C,EAAa,EACbC,EAAc,GACdC,EAAmB,EAGvB,IAAK,MAAMzB,KAAWhf,EAAOmc,SACvBkE,EAAUhV,SAAS2T,KACrBuB,IACIvB,EAAQjc,OAAS0d,IACnBA,EAAmBzB,EAAQjc,OAC3Byd,EAAcxB,IAMpB,GAAIuB,EAAa,EAAG,CAElB,MAAMnB,EAA0B,GAAlBpf,EAAOiO,SAA6B,EAAbsS,EAAiBE,EAEtDH,EAAS1hB,KAAK,CACZ6e,WACAuB,QAASwB,EACTvS,SAAUjO,EAAOiO,SACjBsS,aACAnB,SAEJ,CACF,CAEA,GAAwB,IAApBkB,EAASvd,OAEX,YADA/E,QAAQC,KAAK,oBAKfqiB,EAAS3V,KAAK,CAACC,EAAGC,IACZf,KAAKuV,IAAIxU,EAAEuU,MAAQxU,EAAEwU,OAAS,EACzBvU,EAAEuU,MAAQxU,EAAEwU,MAEdvU,EAAEoD,SAAWrD,EAAEqD,UAGxBjQ,QAAQC,KAAK,eAAeqiB,EAASvd,oBAGrC,MAAMuc,EAASgB,EAAS3P,MAAM,EAAG,GAEjC,IAAK,MAAM+P,KAAWpB,EAAQ,CAC5BthB,QAAQC,KACN,kBAAkB+d,EAAW0E,EAAQjD,UAAUvB,qBACpCwE,EAAQ1B,iBAAiB0B,EAAQH,mBAAmBG,EAAQtB,UAGzE,UACQ5gB,KAAKgf,cAAckD,EAAQjD,SACnC,CAAE,MAAOne,GACPtB,QAAQmE,KAAK,oBAAoBue,EAAQjD,WAAYne,EACvD,CACF,CACF,EAKA,SAAAqhB,GACE,MAAM9e,EAA0B,CAC9B/B,YAAatB,KAAKsB,YAClBmd,aAAcze,KAAKye,aACnB2D,mBAAoBpiB,KAAK0e,qBACzBH,OAAQ,GACRC,QAAS,GACT6D,UAAW,IAGbriB,KAAKue,OAAO3d,QAAQ,CAACD,EAAMgE,KACzBtB,EAAOkb,OAAOne,KAAK,CACjBuE,KAAMA,EACN+Y,YAAa/c,EAAK+c,YAClB3a,QAASpC,EAAKoC,QAAQwB,OACtB0b,SAAUtf,EAAKsf,SACfnf,MAAOH,EAAKG,MACZof,SAAU,IAAIzd,KAAK9B,EAAKuf,UAAUoC,yBAItCtiB,KAAKwe,QAAQ5d,QAAQ,CAAC2hB,EAAU5d,KAC9BtB,EAAOmb,QAAQpe,KAAK,CAClBuE,KAAMA,EACN+Y,YAAaF,EAAW7Y,IAAO+Y,aAAe/Y,MAIlD,IAAK,MAAMsa,KAAYzB,EAChBxd,KAAKue,OAAOte,IAAIgf,IAAcjf,KAAKwe,QAAQve,IAAIgf,IAClD5b,EAAOgf,UAAUjiB,KAAK,CACpBuE,KAAMsa,EACNvB,YAAaF,EAAWyB,GAAUvB,YAClCE,SAAUJ,EAAWyB,GAAUrB,WAKrC,OAAOva,CACT,EAKA,qBAAMmf,CAAgBvD,GACpB,IAAKjf,KAAKue,OAAOte,IAAIgf,GAEnB,YADAzf,QAAQmE,KAAK,YAAYsb,SAI3Bzf,QAAQC,KAAK,gBAAgB+d,EAAWyB,IAAWvB,aAAeuB,KAGlE,MAAML,EAAiBC,sBAAsB,WAE7C,GADmB7e,KAAKue,OAAOpe,IAAI8e,GACnB,CAEd,MACMO,EADoBF,oBACWjD,KAAK1X,GAAQA,IAASsa,GAAYta,EAAKkI,SAASoS,IAErF,GAAIO,EAAY,CACd,MAAMiD,EAAgB7D,EAAeG,WAAW9S,OAAOtH,GAAQA,IAAS6a,SAClEQ,qBAAqB,UAAW,CACpClB,QAASF,EAAeE,QACxBC,WAAY0D,GAEhB,CACF,CAEAziB,KAAKue,OAAO3b,OAAOqc,EACrB,EAKA,qBAAMyD,CAAgBzD,GAGpB,OAFAzf,QAAQC,KAAK,kBAAkB+d,EAAWyB,IAAWvB,aAAeuB,WAC9Djf,KAAKwiB,gBAAgBvD,SACdjf,KAAKgf,cAAcC,EAClC,EAKA,gBAAM3Y,GAgBJ,GAdAO,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,QACTzE,KAAM,CAAEgiB,mBAAoB3iB,KAAKsB,YAAamd,aAAcze,KAAKye,cACjEpZ,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAELvH,KAAKsB,YAEP,YADA9B,QAAQC,KAAK,oBAIfD,QAAQC,KAAK,yBAEPO,KAAK2e,yBAGX,IAAIiE,EAAU,EACVC,EAAgC,GACpC,KAAOD,EAAU,IAAI,CACnB,IAEE,GADAC,EAAsBvD,oBAClBuD,EAAoBte,OAAS,EAAG,CAClC/E,QAAQC,KAAK,wBAAwBojB,EAAoBte,aACzD/E,QAAQC,KAAK,mBAAmBojB,EAAoBxQ,KAAK,SACzD,KACF,CACF,CAAE,MAAOvR,GAET,CAEAtB,QAAQC,KAAK,wBAAwBmjB,EAAU,eACzC,IAAIE,QAAQC,GAAWrc,WAAWqc,EAAS,MACjDH,GACF,CAGApjB,QAAQC,KAAK,qBACb,IAAK,MAAMwf,KAAYzB,EAAY,CACjC,MAAMhc,EAASgc,EAAWyB,GACpB+D,EAAcH,EAAoBlW,KACtChI,GAAQA,IAASnD,EAAOkc,aAAe/Y,IAASnD,EAAOmD,MAAQA,EAAKkI,SAASrL,EAAOkc,cAEtFle,QAAQC,KACN,OAAO+B,EAAOkc,gBAAgBuB,WACrBzd,EAAOiO,kBACNjO,EAAOoc,SAAW,IAAM,YAC1BoF,EAAc,IAAM,KAEhC,CAGA,MAAMC,EAA0B,GAChC,IAAK,MAAMhE,KAAYzB,EACjBA,EAAWyB,GAAUrB,UACvBqF,EAAc7iB,KAAK6e,GAIvBzf,QAAQC,KAAK,mBAAmBwjB,EAAc1e,eAE9C,IAAK,MAAM0a,KAAYgE,EACrB,UACQjjB,KAAKgf,cAAcC,EAC3B,CAAE,MAAOiE,GACP1jB,QAAQmE,KAAK,oBAAoBsb,IAAYiE,EAC/C,CAGFljB,KAAKsB,aAAc,EAEnB,MAAM+B,EAASrD,KAAKmiB,YAyBpB,GAxBA3iB,QAAQC,KAAK,oBACbD,QAAQ2jB,MAAM9f,EAAOkb,QAErB1X,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,QACTzE,KAAM,CACJyiB,YAAa/f,EAAOkb,OAAOha,OAC3B8e,aAAchgB,EAAOmb,QAAQja,OAC7Bsb,eAAgBxc,EAAOgf,UAAU9d,OACjCka,aAAcze,KAAKye,cAErBpZ,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAILvH,KAAKye,aAAc,CACrBjf,QAAQmE,KAAK,uDACbnE,QAAQmE,KAAK,sBACbnE,QAAQmE,KAAK,6BACbnE,QAAQmE,KAAK,8BACbnE,QAAQmE,KAAK,uDAEb,MAAM2f,EAAgBjgB,EAAOkb,OAAOtS,OAAOI,GAAKA,EAAE4T,UAClDzgB,QAAQ2jB,MAAMG,GAGd5c,WAAW,KACTlH,QAAQC,KAAK,2BACbO,KAAKujB,YACJ,IACL,MACE/jB,QAAQC,KAAK,8BAEjB,EAKA,QAAA8jB,GACE/jB,QAAQC,KAAK,sBAGbO,KAAKue,OAAO1b,QACZ7C,KAAKwe,QAAQ3b,QAGT,WACM,EAAqDmc,qBACrD,EAAuDwD,uBACvD,EAAuDE,uBACvD,EAAuDtC,uBACvD,EAA0Da,0BAC1D,EAA0DuC,0BAC1D,EAAmD5B,aAG7D5hB,KAAKsB,aAAc,EACnBtB,KAAKye,cAAe,EAEpBjf,QAAQC,KAAK,4BACbD,QAAQC,KAAK,oBACf,GAKA,EASAuf,cAAiBC,GAAqBX,EAAgBU,cAAcC,GACrE,EAAmFuD,gBAClFvD,GACGX,EAAgBkE,gBAAgBvD,GACpC,EAA8FyD,gBAC7FzD,GACGX,EAAgBoE,gBAAgBzD,GACpC,EAAkFmB,gBACjFrb,GACGuZ,EAAgB8B,gBAAgBrb,GACpC,EAAgF6c,YAAeC,GAC9FvD,EAAgBsD,YAAYC,GAC7B,EAA+FZ,mBAAqB,CACnHlc,EACAiS,IACGsH,EAAgB2C,mBAAmBlc,EAASiS,GAChD,EAAwEwM,mBAAqB,IAC5FlF,EAAgB6D,YAElB,EAAGzd,eAAe,YAAa4Z,GAE/B9e,QAAQC,KAAK,uBAGb,EAAGE,OAAOE,GAAG,kBAAoB4jB,IAC/B,MAAM3jB,EAAQ2jB,EACV3jB,GAAOmK,aACTqU,EAAgB8B,gBAAgBtgB,EAAMmK,aAAa1C,MAAM2b,IACvD1jB,QAAQmE,KAAK,oBAAqBuf,OAMxC,EAAGvjB,OAAOE,GAAG,aAAec,IAE1BkG,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,WACTzE,KAAM,CACJ0S,UAAW1S,EACX2S,gBAAiB3S,EACjB4S,WAC4D,iBAAlD5S,GAAyCoD,KAC5CpD,EAA2BoD,MAAMQ,OAClC,EACNjD,YAAagd,EAAgBhd,aAE/B+D,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAET,MAAMsH,EAAQlO,EACVkO,GAAO9K,MAAQ8K,EAAM9K,KAAKQ,OAAS,IAErCsC,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,SACTzE,KAAM,CAAE4S,WAAY1E,EAAM9K,KAAKQ,OAAQmf,YAAa7U,EAAM9K,KAAKyP,UAAU,EAAG,KAC5EnO,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAET+W,EAAgBsD,YAAY/S,EAAM9K,MAAMwD,MAAM2b,IAE5Crc,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,SACTzE,KAAM,CAAEG,MAAOoiB,aAAeje,MAAQie,EAAI9d,QAAUqO,OAAOyP,IAC3D7d,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QAET/H,QAAQmE,KAAK,mBAAoBuf,QAMvCnd,EAAE,KACAvG,QAAQC,KAAK,qBAGbiH,WAAWid,UACTnkB,QAAQC,KAAK,uBAEb,UACQ6e,EAAgBhY,aACtB9G,QAAQC,KAAK,qBACf,CAAE,MAAOqB,GACPtB,QAAQsB,MAAM,sBAAuBA,GACrCtB,QAAQC,KAAK,kDACf,GACC,OAIJ0G,OAAoFyd,oBACnFD,iBAGE,GAFAnkB,QAAQC,KAAK,qBAET6e,EAAgBhd,YAElB,OADA9B,QAAQC,KAAK,oBACN6e,EAAgB6D,YAGzB,IAGE,aAFM7D,EAAgBhY,aACtB9G,QAAQC,KAAK,sBACN6e,EAAgB6D,WACzB,CAAE,MAAOrhB,GAEP,MADAtB,QAAQsB,MAAM,sBAAuBA,GAC/BA,CACR,CACF,EAEFtB,QAAQC,KAAK,qBACbD,QAAQC,KAAK,wDACf,MAr7BED,QAAQsB,MAAM,oBAEd+F,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAMhD,KAAKC,UAAU,CACnBgD,SAAU,0BACV7B,QAAS,YACTzE,KAAM,CAAE+S,WAAY/L,OAAOC,KAAKzB,QAAQ8F,OAAO0H,GAAKA,EAAE9G,SAAS,cAAgB8G,EAAE9G,SAAS,eAC1FxH,UAAW5C,KAAKC,MAChB0E,UAAW,gBACXC,MAAO,OACPC,aAAc,QAEfC,MAAM,QChUX/H,QAAQC,KAAK","sources":["src://tavern_helper_template/src//core.ts","src://tavern_helper_template/src//event_system.ts","src://tavern_helper_template/src//npc_system.ts","src://tavern_helper_template/src//worldbook_loader.ts","src://tavern_helper_template/src//index.ts"],"sourcesContent":["export { };\n\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\ndeclare const $: JQueryStaticLike;\n\nconsole.info('[] ...');\n\ntype BudgetStatus = 'critical' | 'warning' | 'normal';\n\ninterface BudgetInfo {\n  used: number;\n  total: number;\n  percentage: string;\n  remaining: number;\n  status: BudgetStatus;\n}\n\ninterface DetentionConfig {\n  tokenBudget: number;\n  fallbackBudget: number;\n  compressionQuality: number;\n  cacheExpiry: number;\n  healthCheckInterval: number;\n  healthCheckTimeout: number;\n}\n\ninterface DetentionErrorInfo {\n  message: string;\n  context: string;\n  timestamp: number;\n  stack?: string;\n}\n\ninterface DetentionState {\n  mode: 'detecting' | 'external' | 'fallback';\n  tokenUsed: number;\n  lastHealthCheck: number;\n  errors: DetentionErrorInfo[];\n}\n\ninterface CacheEntry<T> {\n  value: T;\n  expiry: number | null;\n}\n\ninterface CacheManager {\n  set<T>(key: string, value: T, ttl?: number | null): void;\n  get<T>(key: string): T | null;\n  has(key: string): boolean;\n  delete(key: string): void;\n  clear(): void;\n  cleanup(): void;\n}\n\ninterface EnvironmentInfo {\n  isSillyTavern: boolean;\n  version: string | null;\n  hasHelper: boolean;\n  helperVersion: string | null;\n  hasDataTable: boolean;\n}\n\nclass EventEmitter {\n  private readonly events = new Map<string, Array<(data?: unknown) => void>>();\n\n  on(event: string, callback: (data?: unknown) => void) {\n    if (!this.events.has(event)) {\n      this.events.set(event, []);\n    }\n    this.events.get(event)!.push(callback);\n  }\n\n  off(event: string, callback: (data?: unknown) => void) {\n    const callbacks = this.events.get(event);\n    if (!callbacks) return;\n    const index = callbacks.indexOf(callback);\n    if (index > -1) callbacks.splice(index, 1);\n  }\n\n  emit(event: string, data?: unknown) {\n    const callbacks = this.events.get(event);\n    if (!callbacks) return;\n    callbacks.forEach(cb => {\n      try {\n        cb(data);\n      } catch (error) {\n        console.error(`[]  ${event} :`, error);\n      }\n    });\n  }\n\n  once(event: string, callback: (data?: unknown) => void) {\n    const wrapper = (data?: unknown) => {\n      callback(data);\n      this.off(event, wrapper);\n    };\n    this.on(event, wrapper);\n  }\n}\n\ninterface DetentionSystem {\n  version: string;\n  initialized: boolean;\n  modules: Record<string, unknown>;\n  config: DetentionConfig;\n  state: DetentionState;\n  events: EventEmitter;\n  CacheManager: CacheManager;\n  EventEmitter: typeof EventEmitter;\n  ping(): boolean;\n  checkTokenBudget(): BudgetInfo;\n  updateTokenUsage(tokens: number): BudgetInfo;\n  compressContent(content: unknown, quality?: number | null): string;\n  registerModule(name: string, module: unknown): void;\n  getModule<T = unknown>(name: string): T | undefined;\n  handleError(error: unknown, context?: string): void;\n  detectEnvironment(): EnvironmentInfo;\n  initialize(): void;\n}\n\ndeclare global {\n  interface Window {\n    detentionSystem?: DetentionSystem;\n  }\n}\n\nconst cacheStore: Map<string, CacheEntry<unknown>> = new Map();\nlet cacheCleanupTimer: ReturnType<typeof setInterval> | undefined;\n\nfunction createCacheManager(): CacheManager {\n  return {\n    set<T>(key: string, value: T, ttl?: number | null) {\n      const expiry = ttl ? Date.now() + ttl * 1000 : null;\n      cacheStore.set(key, { value, expiry });\n    },\n    get<T>(key: string) {\n      const item = cacheStore.get(key);\n      if (!item) return null;\n      if (item.expiry !== null && Date.now() > item.expiry) {\n        cacheStore.delete(key);\n        return null;\n      }\n      return item.value as T;\n    },\n    has(key: string) {\n      return this.get(key) !== null;\n    },\n    delete(key: string) {\n      cacheStore.delete(key);\n    },\n    clear() {\n      cacheStore.clear();\n    },\n    cleanup() {\n      const now = Date.now();\n      for (const [key, item] of cacheStore.entries()) {\n        if (item.expiry !== null && now > item.expiry) {\n          cacheStore.delete(key);\n        }\n      }\n    }\n  };\n}\n\nfunction normalizeError(error: unknown): Error {\n  if (error instanceof Error) return error;\n  return new Error(typeof error === 'string' ? error : JSON.stringify(error));\n}\n\nfunction bootstrapDetentionSystem(): DetentionSystem {\n  const events = new EventEmitter();\n  const CacheManager = createCacheManager();\n\n  const system: DetentionSystem = {\n    version: '3.2.0',\n    initialized: false,\n    modules: {},\n    config: {\n      tokenBudget: 100000,\n      fallbackBudget: 40000,\n      compressionQuality: 0.8,\n      cacheExpiry: 600000,\n      healthCheckInterval: 500,\n      healthCheckTimeout: 3000\n    },\n    state: {\n      mode: 'detecting',\n      tokenUsed: 0,\n      lastHealthCheck: 0,\n      errors: []\n    },\n    events,\n    CacheManager,\n    EventEmitter,\n\n    ping() {\n      system.state.lastHealthCheck = Date.now();\n      return true;\n    },\n\n    checkTokenBudget() {\n      const total = system.state.mode === 'external'\n        ? system.config.tokenBudget\n        : system.config.fallbackBudget;\n      const used = system.state.tokenUsed;\n      const percentage = (used / total) * 100;\n\n      const status: BudgetStatus =\n        percentage > 95 ? 'critical' : percentage > 85 ? 'warning' : 'normal';\n\n      return {\n        used,\n        total,\n        percentage: percentage.toFixed(2),\n        remaining: total - used,\n        status\n      };\n    },\n\n    updateTokenUsage(tokens: number) {\n      system.state.tokenUsed += tokens;\n      const budget = system.checkTokenBudget();\n\n      if (budget.status === 'warning') {\n        console.warn(`[Token] :  ${budget.percentage}%`);\n        system.events.emit('token_warning', budget);\n      } else if (budget.status === 'critical') {\n        console.error(`[Token] :  ${budget.percentage}%`);\n        system.events.emit('token_critical', budget);\n      }\n\n      return budget;\n    },\n\n    compressContent(content: unknown, quality: number | null = null) {\n      const text = typeof content === 'string' ? content : JSON.stringify(content);\n      const actualQuality = quality ?? system.config.compressionQuality;\n\n      let compressed = text\n        .replace(/\\s+/g, ' ')\n        .replace(/\\n\\s*\\n/g, '\\n')\n        .trim();\n\n      if (actualQuality < 0.9) {\n        compressed = compressed\n          .replace(//g, ',')\n          .replace(//g, '.')\n          .replace(//g, ';')\n          .replace(//g, ':');\n      }\n\n      const originalSize = text.length;\n      const compressedSize = compressed.length;\n      const ratio = ((1 - compressedSize / originalSize) * 100).toFixed(2);\n\n      console.info(`[] : ${originalSize} -> : ${compressedSize} ( ${ratio}%)`);\n\n      return compressed;\n    },\n\n    registerModule(name: string, module: unknown) {\n      if (system.modules[name]) {\n        console.warn(`[]  ${name} `);\n      }\n      system.modules[name] = module;\n      console.info(`[]  ${name} `);\n      system.events.emit('module_registered', { name, module });\n    },\n\n    getModule<T = unknown>(name: string) {\n      return system.modules[name] as T | undefined;\n    },\n\n    handleError(error: unknown, context: string = 'unknown') {\n      const normalized = normalizeError(error);\n      const errorInfo: DetentionErrorInfo = {\n        message: normalized.message,\n        context,\n        timestamp: Date.now(),\n        stack: normalized.stack\n      };\n\n      system.state.errors.push(errorInfo);\n      console.error(`[]  [${context}]:`, normalized);\n      system.events.emit('error', errorInfo);\n\n      if (system.state.errors.length > 100) {\n        system.state.errors.shift();\n      }\n    },\n\n    detectEnvironment() {\n      const env: EnvironmentInfo = {\n        isSillyTavern: false,\n        version: null,\n        hasHelper: false,\n        helperVersion: null,\n        hasDataTable: false\n      };\n\n      const isSillyTavernAvailable = typeof SillyTavern !== 'undefined';\n      if (isSillyTavernAvailable || $('#send_textarea').length > 0) {\n        env.isSillyTavern = true;\n        if (typeof getTavernVersion === 'function') {\n          env.version = getTavernVersion() ?? null;\n        }\n      }\n\n      if (typeof getTavernHelperVersion === 'function') {\n        env.hasHelper = true;\n        env.helperVersion = getTavernHelperVersion() ?? null;\n      }\n\n      const windowWithTable = window as typeof window & {\n        insertRow?: unknown;\n        updateRow?: unknown;\n      };\n      if (typeof windowWithTable.insertRow === 'function' && typeof windowWithTable.updateRow === 'function') {\n        env.hasDataTable = true;\n      }\n\n      return env;\n    },\n\n    initialize() {\n      if (system.initialized) {\n        console.warn('[] ');\n        return;\n      }\n\n      console.info('[] ...');\n\n      const env = system.detectEnvironment();\n      console.info('[] :', env);\n\n      if (!env.isSillyTavern) {\n        console.warn('[] SillyTavern');\n      }\n\n      system.state.mode = 'external';\n      system.initialized = true;\n\n      console.info('[] ');\n      console.info(`[] : ${system.version}`);\n      console.info(`[] : ${system.state.mode}`);\n      console.info(`[] Token: ${system.config.tokenBudget}`);\n\n      system.events.emit('initialized', { env, state: system.state });\n    }\n  };\n\n  return system;\n}\n\nfunction ensureCacheCleanup(system: DetentionSystem) {\n  if (!cacheCleanupTimer) {\n    cacheCleanupTimer = setInterval(() => system.CacheManager.cleanup(), 60000);\n  }\n}\n\nfunction stopCacheCleanup() {\n  if (cacheCleanupTimer) {\n    clearInterval(cacheCleanupTimer);\n    cacheCleanupTimer = undefined;\n  }\n}\n\n$(() => {\n  console.info('[] ');\n  const system = window.detentionSystem ?? bootstrapDetentionSystem();\n  window.detentionSystem = system;\n\n  ensureCacheCleanup(system);\n\n  setTimeout(() => {\n    try {\n      system.initialize();\n    } catch (error) {\n      system.handleError(error, 'initialize');\n    }\n  }, 1000);\n});\n\n$(window).on('pagehide', () => {\n  stopCacheCleanup();\n});\n\nconsole.info('[] ');\n","export {};\n\n/**\n * \n *  registerModule \n */\n\ntype EventPriority = 1 | 2 | 3 | 4;\n\ntype Stage =\n  | 'detention'\n  | 'approval'\n  | 'investigation'\n  | 'prosecution'\n  | 'trial1'\n  | 'firstVerdict'\n  | 'appeal'\n  | 'trial2'\n  | 'finalVerdict'\n  | 'transfer'\n  | 'execution'\n  | 'deathReview'\n  | 'end';\n\ninterface EventBus {\n  on(event: string, callback: (data?: unknown) => void): void;\n  emit(event: string, data?: unknown): void;\n}\n\ninterface EventSystemExports {\n  generateRandomEvent?: (context?: unknown) => EventRecord | null;\n  advanceDay?: (days?: number) => unknown;\n  getCurrentStage?: () => unknown;\n  checkCellTransfer?: () => boolean;\n  setCaseComplexity?: (complexity: 'simple' | 'normal' | 'complex' | 'very_complex') => void;\n  rollbackToStage?: (stage: Stage, reason?: string) => boolean;\n  setDeathPenalty?: (flag: boolean) => void;\n  getEventStatistics?: () => unknown;\n  exportTimeline?: () => unknown;\n  importTimeline?: (data: unknown) => boolean;\n}\n\ninterface DetentionSystem extends EventSystemExports {\n  version: string;\n  initialized: boolean;\n  modules: Record<string, unknown>;\n  config: Record<string, unknown>;\n  state: Record<string, unknown>;\n  events: EventBus;\n  CacheManager: unknown;\n  EventEmitter: unknown;\n  ping(): boolean;\n  checkTokenBudget(): unknown;\n  updateTokenUsage(tokens: number): unknown;\n  compressContent(content: unknown, quality?: number | null): string;\n  registerModule(name: string, module: unknown): void;\n  getModule<T = unknown>(name: string): T | undefined;\n  handleError(error: unknown, context?: string): void;\n  detectEnvironment(): unknown;\n  initialize(): void;\n}\n\ninterface ProtagonistState {\n  health: number;\n  mental: number;\n  strength?: number;\n  intelligence?: number;\n}\n\ninterface Timeline {\n  arrestDay: number;\n  approvalDay: number | null;\n  prosecutionDay: number | null;\n  firstTrialDay: number | null;\n  firstVerdictDay: number | null;\n  secondTrialDay: number | null;\n  finalVerdictDay: number | null;\n  transferDay: number | null;\n  executionDay: number | null;\n}\n\ninterface EventRecord {\n  id: string;\n  name: string;\n  type?: string;\n  category?: string;\n  description?: string;\n  priority?: EventPriority;\n  day?: number;\n  stage?: Stage;\n  isEnding?: boolean;\n  endingType?: 'prison' | 'death';\n  aiControlled?: boolean;\n  text?: string;\n  from?: string;\n  to?: string;\n  reason?: string;\n}\n\ndeclare global {\n  interface Window {\n    chat?: Array<{ mes?: string }>;\n  }\n}\n\ninterface EventSystemImpl {\n  currentDay: number;\n  lastEventDay: number;\n  eventHistory: EventRecord[];\n  legalTimeline: Timeline;\n  currentStage: Stage;\n  cellType: string;\n  caseComplexity: 'simple' | 'normal' | 'complex' | 'very_complex';\n  complexityMultiplier: number;\n  eventCounters: Record<string, number>;\n  isDeathPenalty: boolean;\n  lastStageChangeDay: number;\n  readonly PRIORITY: {\n    readonly LEGAL: 1;\n    readonly CONDITION: 2;\n    readonly RANDOM: 3;\n    readonly DAILY: 4;\n  };\n  legalEvents: Record<string, unknown>;\n  conditionEvents: Array<any>;\n  randomEvents: Record<string, Array<{ id: string; name: string; weight: number }>>;\n  innerMonologues: Array<{ id: string; text: string; weight: number }>;\n  initialize(this: EventSystemImpl, startDay?: number): void;\n  setCaseComplexity(this: EventSystemImpl, complexity: 'simple' | 'normal' | 'complex' | 'very_complex'): void;\n  checkComplexityAdjustment(this: EventSystemImpl): void;\n  rollbackToStage(this: EventSystemImpl, targetStage: Stage, reason?: string): boolean;\n  handleUserRollback(this: EventSystemImpl, input: string): boolean;\n  advanceDay(\n    this: EventSystemImpl,\n    days?: number,\n  ): { interrupted: boolean; currentDay: number; event?: EventRecord; accumulatedEvents: EventRecord[] };\n  checkDayEvents(this: EventSystemImpl): EventRecord;\n  checkLegalEvent(this: EventSystemImpl): EventRecord | null;\n  checkConditionEvent(this: EventSystemImpl): EventRecord | null;\n  generateRandomEvent(this: EventSystemImpl): EventRecord | null;\n  generateInnerMonologue(this: EventSystemImpl): EventRecord | null;\n  weightedRandom(this: EventSystemImpl, count: number, weights: number[]): number;\n  getProtagonistState(this: EventSystemImpl): ProtagonistState;\n  getRecentContext(this: EventSystemImpl): string;\n  checkCellTransfer(this: EventSystemImpl): boolean;\n  setDeathPenalty(this: EventSystemImpl, isDeathPenalty: boolean): void;\n  getCurrentStageInfo(this: EventSystemImpl): unknown;\n  getEventStatistics(this: EventSystemImpl): unknown;\n  exportTimeline(this: EventSystemImpl): unknown;\n  importTimeline(this: EventSystemImpl, data: any): boolean;\n}\n\nconsole.info('[] ...');\n\n// #region agent log\nfetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    location: 'event_system.ts:151',\n    message: '',\n    data: { hasDetentionSystem: !!window.detentionSystem, detentionSystemType: typeof window.detentionSystem },\n    timestamp: Date.now(),\n    sessionId: 'debug-session',\n    runId: 'run1',\n    hypothesisId: 'A',\n  }),\n}).catch(() => {});\n// #endregion\n\nconst DS = window.detentionSystem as (DetentionSystem & EventSystemExports) | undefined;\nif (!DS) {\n  console.error('[] ');\n  // #region agent log\n  fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      location: 'event_system.ts:156',\n      message: '',\n      data: { windowKeys: Object.keys(window).filter(k => k.includes('detention') || k.includes('Detention')) },\n      timestamp: Date.now(),\n      sessionId: 'debug-session',\n      runId: 'run1',\n      hypothesisId: 'A',\n    }),\n  }).catch(() => {});\n  // #endregion\n} else {\n  // #region agent log\n  fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      location: 'event_system.ts:160',\n      message: '',\n      data: {\n        version: DS.version,\n        initialized: DS.initialized,\n        hasEvents: !!DS.events,\n        moduleCount: Object.keys(DS.modules || {}).length,\n      },\n      timestamp: Date.now(),\n      sessionId: 'debug-session',\n      runId: 'run1',\n      hypothesisId: 'A',\n    }),\n  }).catch(() => {});\n  // #endregion\n  // ----------------  ----------------\n  const EventSystem: EventSystemImpl = {\n    currentDay: 0,\n    lastEventDay: 0,\n    eventHistory: [] as EventRecord[],\n    legalTimeline: {\n      arrestDay: 0,\n      approvalDay: null,\n      prosecutionDay: null,\n      firstTrialDay: null,\n      firstVerdictDay: null,\n      secondTrialDay: null,\n      finalVerdictDay: null,\n      transferDay: null,\n      executionDay: null,\n    } as Timeline,\n    currentStage: 'detention' as Stage,\n    cellType: 'transition',\n\n    // \n    caseComplexity: 'normal' as 'simple' | 'normal' | 'complex' | 'very_complex',\n    complexityMultiplier: 1.0,\n\n    // \n    eventCounters: {\n      interrogation: 0,\n      lawyerVisit: 0,\n      familyVisit: 0,\n      medicalVisit: 0,\n      sceneIdentification: 0,\n    } as Record<string, number>,\n\n    // \n    isDeathPenalty: false,\n\n    // \n    lastStageChangeDay: 0,\n\n    // \n    PRIORITY: {\n      LEGAL: 1,\n      CONDITION: 2,\n      RANDOM: 3,\n      DAILY: 4,\n    } as const,\n\n    // \n    legalEvents: {\n      approval: {\n        name: '',\n        minDay: 30,\n        maxDay: 37,\n        stage: 'approval',\n        description: '',\n        nextStage: 'investigation',\n      },\n      investigation: {\n        name: '',\n        duration: [60, 210],\n        stage: 'investigation',\n        description: '',\n        nextStage: 'prosecution',\n      },\n      prosecution: {\n        name: '',\n        duration: [30, 45],\n        stage: 'prosecution',\n        description: '',\n        nextStage: 'trial1',\n      },\n      firstTrial: {\n        name: '',\n        duration: [30, 45],\n        stage: 'trial1',\n        description: '',\n        nextStage: 'firstVerdict',\n      },\n      firstVerdict: {\n        name: '',\n        duration: [7, 30],\n        stage: 'firstVerdict',\n        description: '',\n        nextStage: 'appeal',\n      },\n      appeal: {\n        name: '',\n        duration: [10, 10],\n        stage: 'appeal',\n        description: '10',\n        nextStage: 'trial2',\n      },\n      secondTrial: {\n        name: '',\n        duration: [60, 90],\n        stage: 'trial2',\n        description: '',\n        nextStage: 'finalVerdict',\n      },\n      finalVerdict: {\n        name: '',\n        duration: [7, 14],\n        stage: 'finalVerdict',\n        description: '',\n        nextStage: 'transfer',\n      },\n      transfer: {\n        name: '',\n        duration: [30, 90],\n        stage: 'transfer',\n        description: '',\n        nextStage: 'end',\n      },\n      deathReview: {\n        name: '',\n        duration: [180, 720],\n        stage: 'deathReview',\n        description: '',\n        nextStage: 'execution',\n      },\n      execution: {\n        name: '',\n        duration: [1, 7],\n        stage: 'execution',\n        description: '',\n        nextStage: 'end',\n      },\n    },\n\n    // \n    conditionEvents: [\n      {\n        id: 'mental_breakdown',\n        name: '',\n        condition: (state: ProtagonistState) => state.mental < 20,\n        weight: 100,\n        description: '',\n        checkAlways: true,\n      },\n      {\n        id: 'health_crisis',\n        name: '',\n        condition: (state: ProtagonistState) => state.health < 30,\n        weight: 100,\n        description: '',\n        checkAlways: true,\n      },\n      {\n        id: 'major_twist',\n        name: '',\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\n          if (system.currentDay !== system.lastStageChangeDay) return false;\n          return Math.random() < 0.15;\n        },\n        weight: 100,\n        description: '',\n        stageChangeOnly: true,\n      },\n      {\n        id: 'evidence_reversal',\n        name: '',\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\n          if (system.currentDay !== system.lastStageChangeDay) return false;\n          return Math.random() < 0.1;\n        },\n        weight: 100,\n        description: '',\n        stageChangeOnly: true,\n      },\n      {\n        id: 'interrogation',\n        name: '',\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\n          if (system.currentStage !== 'investigation') return false;\n\n          const daysSinceApproval = system.legalTimeline.approvalDay\n            ? system.currentDay - system.legalTimeline.approvalDay\n            : 0;\n\n          let baseProbability = 0.15;\n\n          if (daysSinceApproval < 30) {\n            baseProbability = 0.25;\n          } else if (daysSinceApproval < 60) {\n            baseProbability = 0.15;\n          } else {\n            baseProbability = 0.08;\n          }\n\n          const decayFactor = Math.pow(0.7, system.eventCounters.interrogation);\n          const finalProbability = baseProbability * decayFactor;\n\n          return Math.random() < finalProbability;\n        },\n        weight: 100,\n        description: '',\n        category: 'procedural',\n      },\n      {\n        id: 'lawyer_visit',\n        name: '',\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\n          let baseProbability = 0.03;\n\n          const daysInCustody = system.currentDay - system.legalTimeline.arrestDay;\n          if (daysInCustody <= 14) {\n            baseProbability = 0.15;\n          }\n\n          if (system.legalTimeline.firstTrialDay) {\n            const daysToTrial = system.legalTimeline.firstTrialDay - system.currentDay;\n            if (daysToTrial > 0 && daysToTrial <= 7) {\n              baseProbability = 0.3;\n            }\n          }\n\n          if (system.legalTimeline.secondTrialDay) {\n            const daysToTrial2 = system.legalTimeline.secondTrialDay - system.currentDay;\n            if (daysToTrial2 > 0 && daysToTrial2 <= 7) {\n              baseProbability = 0.25;\n            }\n          }\n\n          return Math.random() < baseProbability;\n        },\n        weight: 90,\n        description: '',\n        category: 'procedural',\n      },\n      {\n        id: 'family_visit',\n        name: '',\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\n          if (!system.legalTimeline.firstVerdictDay) return false;\n\n          let baseProbability = 0.05;\n\n          if (system.isDeathPenalty) {\n            baseProbability = 0.1;\n          }\n\n          const lastVisit = system.eventHistory\n            .filter(e => e.id === 'family_visit')\n            .sort((a, b) => (b.day ?? 0) - (a.day ?? 0))[0];\n\n          if (lastVisit && system.currentDay - (lastVisit.day ?? 0) < 30) {\n            return false;\n          }\n\n          return Math.random() < baseProbability;\n        },\n        weight: 85,\n        description: '',\n        category: 'procedural',\n      },\n      {\n        id: 'medical_visit',\n        name: '',\n        condition: (state: ProtagonistState, system: typeof EventSystem) => {\n          if (state.health >= 25) return false;\n\n          let probability = 0;\n          if (state.health < 10) {\n            probability = 0.4;\n          } else if (state.health < 15) {\n            probability = 0.25;\n          } else if (state.health < 20) {\n            probability = 0.15;\n          } else {\n            probability = 0.08;\n          }\n\n          const lastMedical = system.eventHistory\n            .filter(e => e.id === 'medical_visit')\n            .sort((a, b) => (b.day ?? 0) - (a.day ?? 0))[0];\n\n          if (lastMedical && system.currentDay - (lastMedical.day ?? 0) < 7) {\n            return false;\n          }\n\n          return Math.random() < probability;\n        },\n        weight: 95,\n        description: '',\n        category: 'procedural',\n      },\n      {\n        id: 'scene_identification',\n        name: '',\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\n          if (system.currentStage !== 'investigation') return false;\n          if (system.eventCounters.sceneIdentification > 0) return false;\n\n          const daysSinceApproval = system.legalTimeline.approvalDay\n            ? system.currentDay - system.legalTimeline.approvalDay\n            : 0;\n\n          if (daysSinceApproval < 15 || daysSinceApproval > 120) {\n            return false;\n          }\n\n          const baseProbability = 0.08;\n\n          const recentContext = system.getRecentContext ? system.getRecentContext() : '';\n          const keywords = ['', '', '', '', ''];\n          const hasKeyword = keywords.some(kw => recentContext.includes(kw));\n\n          const finalProbability = hasKeyword ? baseProbability * 3 : baseProbability;\n\n          return Math.random() < finalProbability;\n        },\n        weight: 80,\n        description: '',\n        category: 'procedural',\n        aiControlled: true,\n      },\n    ],\n\n    // \n    randomEvents: {\n      violence: [\n        { id: 'newcomer_bullying', name: '', weight: 30 },\n        { id: 'bed_dispute', name: '', weight: 25 },\n        { id: 'food_robbery', name: '', weight: 20 },\n        { id: 'faction_conflict', name: '', weight: 15 },\n        { id: 'revenge', name: '', weight: 10 },\n      ],\n      medical: [\n        { id: 'epidemic', name: '', weight: 15 },\n        { id: 'mental_illness', name: '', weight: 25 },\n        { id: 'chronic_disease', name: '', weight: 20 },\n        { id: 'injury', name: '', weight: 20 },\n        { id: 'gynecological', name: '', weight: 10 },\n        { id: 'malnutrition', name: '', weight: 10 },\n      ],\n      emotional: [\n        { id: 'deep_friendship', name: '', weight: 20 },\n        { id: 'betrayal', name: '', weight: 15 },\n        { id: 'motherly_bond', name: '', weight: 15 },\n        { id: 'jealousy', name: '', weight: 20 },\n        { id: 'secret_sharing', name: '', weight: 15 },\n        { id: 'collective_exclusion', name: '', weight: 10 },\n        { id: 'romance', name: '', weight: 5 },\n      ],\n      accident: [\n        { id: 'facility_failure', name: '', weight: 25 },\n        { id: 'safety_incident', name: '', weight: 20 },\n        { id: 'external_news', name: '', weight: 30 },\n        { id: 'extreme_weather', name: '', weight: 15 },\n        { id: 'management_change', name: '', weight: 10 },\n      ],\n    },\n\n    // \n    innerMonologues: [\n      { id: 'worry_about_family', text: '...', weight: 20 },\n      { id: 'regret_past', text: '...', weight: 20 },\n      { id: 'fear_future', text: '...', weight: 18 },\n      { id: 'miss_freedom', text: '...', weight: 15 },\n      { id: 'self_reflection', text: '...', weight: 12 },\n      { id: 'hope_for_leniency', text: '...', weight: 10 },\n      { id: 'worry_about_children', text: '...', weight: 15 },\n      { id: 'fear_of_inmates', text: '...', weight: 12 },\n      { id: 'loneliness', text: '...', weight: 15 },\n      { id: 'time_perception', text: '...', weight: 10 },\n      { id: 'dream_of_past', text: '...', weight: 12 },\n      { id: 'worry_about_health', text: '...', weight: 10 },\n      { id: 'guilt', text: '...', weight: 8 },\n      { id: 'anger', text: '...', weight: 8 },\n      { id: 'acceptance', text: '...', weight: 7 },\n      { id: 'hope_for_appeal', text: '...', weight: 8 },\n      { id: 'fear_of_death', text: '...', weight: 5 },\n      { id: 'nostalgia', text: '...', weight: 10 },\n    ],\n\n    // \n    initialize(startDay = 0) {\n      this.currentDay = startDay;\n      this.legalTimeline.arrestDay = startDay;\n      this.currentStage = 'detention';\n      this.cellType = 'transition';\n      this.caseComplexity = 'normal';\n      this.complexityMultiplier = 1.0;\n      this.isDeathPenalty = false;\n      this.lastStageChangeDay = startDay;\n      this.lastEventDay = startDay;\n\n      for (const key of Object.keys(this.eventCounters)) {\n        this.eventCounters[key] = 0;\n      }\n\n      console.info('[] ');\n      console.info(`[] : ${startDay}`);\n\n      DS.events.emit('event_system_initialized', {\n        day: this.currentDay,\n        stage: this.currentStage,\n      });\n    },\n\n    setCaseComplexity(complexity: 'simple' | 'normal' | 'complex' | 'very_complex') {\n      const validComplexities: Record<string, number> = {\n        simple: 0.8,\n        normal: 1.0,\n        complex: 1.3,\n        very_complex: 1.6,\n      };\n\n      if (complexity in validComplexities) {\n        this.caseComplexity = complexity;\n        this.complexityMultiplier = validComplexities[complexity];\n\n        console.info(`[] : ${complexity} (: ${this.complexityMultiplier})`);\n\n        DS.events.emit('complexity_changed', {\n          complexity: this.caseComplexity,\n          multiplier: this.complexityMultiplier,\n        });\n      } else {\n        console.warn(`[] : ${complexity}`);\n      }\n    },\n\n    checkComplexityAdjustment() {\n      if (this.currentDay % 30 !== 0) return;\n\n      DS.events.emit('request_complexity_assessment', {\n        day: this.currentDay,\n        stage: this.currentStage,\n        eventHistory: this.eventHistory,\n      });\n    },\n\n    rollbackToStage(targetStage: Stage, reason = '') {\n      console.info(`[] : ${this.currentStage} -> ${targetStage}`);\n      console.info(`[] : ${reason}`);\n\n      const stageOrder: Stage[] = [\n        'detention',\n        'approval',\n        'investigation',\n        'prosecution',\n        'trial1',\n        'firstVerdict',\n        'appeal',\n        'trial2',\n        'finalVerdict',\n        'transfer',\n        'execution',\n      ];\n\n      const targetIndex = stageOrder.indexOf(targetStage);\n      const currentIndex = stageOrder.indexOf(this.currentStage);\n\n      if (targetIndex === -1 || targetIndex >= currentIndex) {\n        console.warn('[] ');\n        return false;\n      }\n\n      const timelineKeys: Partial<Record<Stage, keyof Timeline>> = {\n        approval: 'approvalDay',\n        investigation: 'approvalDay',\n        prosecution: 'prosecutionDay',\n        trial1: 'firstTrialDay',\n        firstVerdict: 'firstVerdictDay',\n        appeal: 'firstVerdictDay',\n        trial2: 'secondTrialDay',\n        finalVerdict: 'finalVerdictDay',\n        transfer: 'transferDay',\n        execution: 'executionDay',\n      };\n\n      for (let i = targetIndex + 1; i < stageOrder.length; i++) {\n        const stage = stageOrder[i];\n        const key = timelineKeys[stage];\n        if (key && this.legalTimeline[key]) {\n          this.legalTimeline[key] = null as never;\n        }\n      }\n\n      this.currentStage = targetStage;\n\n      if (targetIndex <= stageOrder.indexOf('investigation')) {\n        this.cellType = 'pretrial';\n      }\n\n      this.eventHistory.push({\n        id: 'procedure_rollback',\n        name: '',\n        type: 'legal',\n        day: this.currentDay,\n        from: stageOrder[currentIndex],\n        to: targetStage,\n        reason,\n      });\n\n      DS.events.emit('procedure_rollback', {\n        from: stageOrder[currentIndex],\n        to: targetStage,\n        reason,\n        day: this.currentDay,\n      });\n\n      return true;\n    },\n\n    handleUserRollback(input: string) {\n      const rollbackPatterns = [\n        { pattern: /.*?.*?(|||)/, stage: null as Stage | null },\n        { pattern: /.*?(|)/, stage: null as Stage | null },\n        { pattern: /.*?(|)/, stage: null as Stage | null },\n      ];\n\n      for (const rule of rollbackPatterns) {\n        const match = input.match(rule.pattern);\n        if (match) {\n          let targetStage: Stage | null = null;\n\n          if (match[1].includes('')) {\n            targetStage = 'investigation';\n          } else if (match[1].includes('')) {\n            targetStage = 'prosecution';\n          } else if (match[1].includes('')) {\n            targetStage = 'trial1';\n          } else if (match[1].includes('')) {\n            targetStage = 'trial2';\n          }\n\n          if (targetStage) {\n            return this.rollbackToStage(targetStage, '');\n          }\n        }\n      }\n\n      return false;\n    },\n\n    advanceDay(days = 1) {\n      const events: EventRecord[] = [];\n\n      for (let i = 0; i < days; i++) {\n        this.currentDay++;\n        this.lastEventDay = this.currentDay;\n\n        this.checkComplexityAdjustment();\n\n        const dayEvent = this.checkDayEvents();\n\n        if (dayEvent) {\n          events.push(dayEvent);\n\n          this.eventHistory.push({\n            ...dayEvent,\n            day: this.currentDay,\n          });\n\n          if (Object.prototype.hasOwnProperty.call(this.eventCounters, dayEvent.id)) {\n            this.eventCounters[dayEvent.id] = (this.eventCounters[dayEvent.id] || 0) + 1;\n          }\n\n          if ((dayEvent.priority ?? this.PRIORITY.DAILY) <= this.PRIORITY.RANDOM) {\n            console.info(`[] ${this.currentDay}: ${dayEvent.name}`);\n            DS.events.emit('event_triggered', dayEvent);\n            return {\n              interrupted: true,\n              currentDay: this.currentDay,\n              event: dayEvent,\n              accumulatedEvents: events,\n            };\n          }\n        }\n      }\n\n      return {\n        interrupted: false,\n        currentDay: this.currentDay,\n        accumulatedEvents: events,\n      };\n    },\n\n    checkDayEvents(): EventRecord {\n      const legalEvent = this.checkLegalEvent();\n      if (legalEvent) {\n        return {\n          ...legalEvent,\n          priority: this.PRIORITY.LEGAL,\n          day: this.currentDay,\n        };\n      }\n\n      const conditionEvent = this.checkConditionEvent();\n      if (conditionEvent) {\n        return {\n          ...conditionEvent,\n          priority: this.PRIORITY.CONDITION,\n          day: this.currentDay,\n        };\n      }\n\n      if (Math.random() < 0.1) {\n        const randomEvent = this.generateRandomEvent();\n        if (randomEvent) {\n          return {\n            ...randomEvent,\n            priority: this.PRIORITY.RANDOM,\n            day: this.currentDay,\n          };\n        }\n      }\n\n      if (Math.random() < 0.15) {\n        const monologue = this.generateInnerMonologue();\n        if (monologue) {\n          return {\n            ...monologue,\n            priority: this.PRIORITY.DAILY,\n            day: this.currentDay,\n          };\n        }\n      }\n\n      return {\n        id: 'daily_routine',\n        name: '',\n        type: 'daily',\n        priority: this.PRIORITY.DAILY,\n        day: this.currentDay,\n        description: '',\n      };\n    },\n\n    checkLegalEvent(): EventRecord | null {\n      const daysInCustody = this.currentDay - this.legalTimeline.arrestDay;\n      const stageBefore = this.currentStage;\n\n      if (!this.legalTimeline.approvalDay) {\n        const minDays = Math.floor(30 * this.complexityMultiplier);\n        const maxDays = Math.floor(37 * this.complexityMultiplier);\n\n        if (daysInCustody >= minDays && daysInCustody <= maxDays) {\n          if (Math.random() < 0.3) {\n            this.legalTimeline.approvalDay = this.currentDay;\n            this.currentStage = 'investigation';\n            this.lastStageChangeDay = this.currentDay;\n            return {\n              id: 'approval',\n              name: '',\n              type: 'legal',\n              stage: 'approval',\n              description: '',\n              from: stageBefore,\n              to: 'investigation',\n            };\n          }\n        }\n      }\n\n      if (this.legalTimeline.approvalDay && !this.legalTimeline.prosecutionDay) {\n        const daysSinceApproval = this.currentDay - this.legalTimeline.approvalDay;\n        const minDays = Math.floor(60 * this.complexityMultiplier);\n        const maxDays = Math.floor(210 * this.complexityMultiplier);\n\n        if (daysSinceApproval >= minDays && daysSinceApproval <= maxDays && Math.random() < 0.02) {\n          this.legalTimeline.prosecutionDay = this.currentDay;\n          this.currentStage = 'prosecution';\n          this.lastStageChangeDay = this.currentDay;\n          return {\n            id: 'prosecution',\n            name: '',\n            type: 'legal',\n            stage: 'prosecution',\n            description: '',\n            from: stageBefore,\n            to: 'prosecution',\n          };\n        }\n      }\n\n      if (this.legalTimeline.prosecutionDay && !this.legalTimeline.firstTrialDay) {\n        const daysSinceProsecution = this.currentDay - this.legalTimeline.prosecutionDay;\n        const minDays = Math.floor(30 * this.complexityMultiplier);\n        const maxDays = Math.floor(45 * this.complexityMultiplier);\n\n        if (daysSinceProsecution >= minDays && daysSinceProsecution <= maxDays && Math.random() < 0.05) {\n          this.legalTimeline.firstTrialDay = this.currentDay;\n          this.currentStage = 'trial1';\n          this.lastStageChangeDay = this.currentDay;\n\n          if (this.cellType === 'transition') {\n            this.cellType = 'pretrial';\n            DS.events.emit('cell_transfer', {\n              from: 'transition',\n              to: 'pretrial',\n              reason: '',\n            });\n          }\n\n          return {\n            id: 'first_trial',\n            name: '',\n            type: 'legal',\n            stage: 'trial1',\n            description: '',\n            from: stageBefore,\n            to: 'trial1',\n          };\n        }\n      }\n\n      if (this.legalTimeline.firstTrialDay && !this.legalTimeline.firstVerdictDay) {\n        const daysSinceTrial = this.currentDay - this.legalTimeline.firstTrialDay;\n        const minDays = Math.floor(7 * this.complexityMultiplier);\n        const maxDays = Math.floor(30 * this.complexityMultiplier);\n\n        if (daysSinceTrial >= minDays && daysSinceTrial <= maxDays && Math.random() < 0.1) {\n          this.legalTimeline.firstVerdictDay = this.currentDay;\n          this.currentStage = 'appeal';\n          this.lastStageChangeDay = this.currentDay;\n\n          this.cellType = 'convicted';\n          DS.events.emit('cell_transfer', {\n            from: 'pretrial',\n            to: 'convicted',\n            reason: '',\n          });\n\n          return {\n            id: 'first_verdict',\n            name: '',\n            type: 'legal',\n            stage: 'firstVerdict',\n            description: '',\n            from: stageBefore,\n            to: 'appeal',\n          };\n        }\n      }\n\n      if (\n        this.legalTimeline.firstVerdictDay &&\n        !this.legalTimeline.secondTrialDay &&\n        !this.legalTimeline.finalVerdictDay\n      ) {\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.firstVerdictDay;\n\n        if (daysSinceVerdict === 10) {\n          if (Math.random() < 0.7) {\n            this.legalTimeline.secondTrialDay = this.currentDay;\n            this.currentStage = 'trial2';\n            this.lastStageChangeDay = this.currentDay;\n\n            return {\n              id: 'appeal_filed',\n              name: '',\n              type: 'legal',\n              stage: 'appeal',\n              description: '',\n              from: stageBefore,\n              to: 'trial2',\n            };\n          } else {\n            this.legalTimeline.finalVerdictDay = this.currentDay;\n            this.currentStage = 'transfer';\n            this.lastStageChangeDay = this.currentDay;\n\n            return {\n              id: 'verdict_final',\n              name: '',\n              type: 'legal',\n              stage: 'finalVerdict',\n              description: '',\n              from: stageBefore,\n              to: 'transfer',\n            };\n          }\n        }\n      }\n\n      if (this.legalTimeline.secondTrialDay && !this.legalTimeline.finalVerdictDay) {\n        const daysSinceAppeal = this.currentDay - this.legalTimeline.secondTrialDay;\n        const minDays = Math.floor(60 * this.complexityMultiplier);\n        const maxDays = Math.floor(90 * this.complexityMultiplier);\n\n        if (daysSinceAppeal >= minDays && daysSinceAppeal <= maxDays && Math.random() < 0.03) {\n          this.legalTimeline.finalVerdictDay = this.currentDay;\n          this.currentStage = 'transfer';\n          this.lastStageChangeDay = this.currentDay;\n\n          return {\n            id: 'final_verdict',\n            name: '',\n            type: 'legal',\n            stage: 'finalVerdict',\n            description: '',\n            from: stageBefore,\n            to: 'transfer',\n          };\n        }\n      }\n\n      if (this.legalTimeline.finalVerdictDay && !this.legalTimeline.transferDay && !this.isDeathPenalty) {\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.finalVerdictDay;\n        const minDays = Math.floor(30 * this.complexityMultiplier);\n        const maxDays = Math.floor(90 * this.complexityMultiplier);\n\n        if (daysSinceVerdict >= minDays && daysSinceVerdict <= maxDays && Math.random() < 0.02) {\n          this.legalTimeline.transferDay = this.currentDay;\n          this.currentStage = 'end';\n          this.lastStageChangeDay = this.currentDay;\n\n          return {\n            id: 'transfer_prison',\n            name: '',\n            type: 'legal',\n            stage: 'transfer',\n            description: '',\n            isEnding: true,\n            endingType: 'prison',\n            from: stageBefore,\n            to: 'end',\n          };\n        }\n      }\n\n      if (this.legalTimeline.finalVerdictDay && this.isDeathPenalty && !this.legalTimeline.executionDay) {\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.finalVerdictDay;\n        const minDays = 180;\n        const maxDays = 720;\n\n        if (daysSinceVerdict >= minDays && daysSinceVerdict <= maxDays && Math.random() < 0.005) {\n          this.legalTimeline.executionDay = this.currentDay + 7;\n          this.currentStage = 'execution';\n          this.lastStageChangeDay = this.currentDay;\n\n          return {\n            id: 'death_review_approved',\n            name: '',\n            type: 'legal',\n            stage: 'deathReview',\n            description: '7',\n            from: stageBefore,\n            to: 'execution',\n          };\n        }\n      }\n\n      if (this.legalTimeline.executionDay && this.currentDay >= this.legalTimeline.executionDay) {\n        this.currentStage = 'end';\n        this.lastStageChangeDay = this.currentDay;\n\n        return {\n          id: 'execution',\n          name: '',\n          type: 'legal',\n          stage: 'execution',\n          description: '',\n          isEnding: true,\n          endingType: 'death',\n          from: stageBefore,\n          to: 'end',\n        };\n      }\n\n      return null;\n    },\n\n    checkConditionEvent(): EventRecord | null {\n      const state = this.getProtagonistState();\n\n      for (const event of this.conditionEvents) {\n        if (event.stageChangeOnly && this.currentDay !== this.lastStageChangeDay) {\n          continue;\n        }\n\n        if (event.checkAlways || !event.stageChangeOnly) {\n          if (event.condition(state, this)) {\n            if (Math.random() * 100 < event.weight) {\n              return {\n                id: event.id,\n                name: event.name,\n                type: event.category || 'condition',\n                description: event.description,\n                aiControlled: event.aiControlled || false,\n              };\n            }\n          }\n        }\n      }\n\n      return null;\n    },\n\n    generateRandomEvent(): EventRecord | null {\n      const types = ['violence', 'medical', 'emotional', 'accident'] as const;\n      const weights = [25, 30, 30, 15];\n\n      const typeIndex = this.weightedRandom(types.length, weights);\n      const eventType = types[typeIndex];\n      const eventList = this.randomEvents[eventType];\n\n      const eventWeights = eventList.map(e => e.weight);\n      const eventIndex = this.weightedRandom(eventList.length, eventWeights);\n      const event = eventList[eventIndex];\n\n      return {\n        id: event.id,\n        name: event.name,\n        type: eventType,\n        category: 'random',\n        description: `: ${event.name}`,\n      };\n    },\n\n    generateInnerMonologue(): EventRecord | null {\n      const weights = this.innerMonologues.map(m => m.weight);\n      const index = this.weightedRandom(this.innerMonologues.length, weights);\n      const monologue = this.innerMonologues[index];\n\n      return {\n        id: monologue.id,\n        name: '',\n        type: 'monologue',\n        category: 'daily',\n        description: monologue.text,\n        text: monologue.text,\n      };\n    },\n\n    weightedRandom(count: number, weights: number[]): number {\n      const totalWeight = weights.reduce((sum, w) => sum + w, 0);\n      let random = Math.random() * totalWeight;\n\n      for (let i = 0; i < count; i++) {\n        random -= weights[i];\n        if (random <= 0) {\n          return i;\n        }\n      }\n\n      return count - 1;\n    },\n\n    getProtagonistState(): ProtagonistState {\n      const statusPanel = DS.getModule<{ state?: ProtagonistState }>('statusPanel');\n      if (statusPanel && statusPanel.state) {\n        return statusPanel.state;\n      }\n\n      return {\n        health: 80,\n        mental: 70,\n        strength: 60,\n        intelligence: 70,\n      };\n    },\n\n    getRecentContext(): string {\n      if (Array.isArray(window.chat)) {\n        const recentMessages = window.chat.slice(-5);\n        return recentMessages.map(m => m.mes || '').join(' ');\n      }\n      return '';\n    },\n\n    checkCellTransfer() {\n      const daysInCustody = this.currentDay - this.legalTimeline.arrestDay;\n\n      if (this.cellType === 'transition' && daysInCustody >= 7 && daysInCustody <= 14) {\n        if (Math.random() < 0.2) {\n          this.cellType = 'pretrial';\n          DS.events.emit('cell_transfer', {\n            from: 'transition',\n            to: 'pretrial',\n            reason: '',\n            day: this.currentDay,\n          });\n          return true;\n        }\n      }\n\n      return false;\n    },\n\n    setDeathPenalty(isDeathPenalty: boolean) {\n      this.isDeathPenalty = isDeathPenalty;\n      console.info(`[] : ${isDeathPenalty}`);\n\n      DS.events.emit('death_penalty_status_changed', {\n        isDeathPenalty: this.isDeathPenalty,\n        day: this.currentDay,\n      });\n    },\n\n    getCurrentStageInfo() {\n      return {\n        day: this.currentDay,\n        stage: this.currentStage,\n        cellType: this.cellType,\n        daysInCustody: this.currentDay - this.legalTimeline.arrestDay,\n        timeline: { ...this.legalTimeline },\n        complexity: this.caseComplexity,\n        complexityMultiplier: this.complexityMultiplier,\n        isDeathPenalty: this.isDeathPenalty,\n        eventCounters: { ...this.eventCounters },\n      };\n    },\n\n    getEventStatistics() {\n      const stats: {\n        totalEvents: number;\n        byType: Record<string, number>;\n        byPriority: Record<number, number>;\n        recentEvents: EventRecord[];\n      } = {\n        totalEvents: this.eventHistory.length,\n        byType: {},\n        byPriority: {},\n        recentEvents: this.eventHistory.slice(-10),\n      };\n\n      this.eventHistory.forEach((event: EventRecord) => {\n        const type = event.type || 'unknown';\n        stats.byType[type] = (stats.byType[type] || 0) + 1;\n\n        const priority = event.priority || 4;\n        stats.byPriority[priority] = (stats.byPriority[priority] || 0) + 1;\n      });\n\n      return stats;\n    },\n\n    exportTimeline() {\n      return {\n        currentDay: this.currentDay,\n        currentStage: this.currentStage,\n        cellType: this.cellType,\n        timeline: { ...this.legalTimeline },\n        complexity: this.caseComplexity,\n        isDeathPenalty: this.isDeathPenalty,\n        eventCounters: { ...this.eventCounters },\n        eventHistory: [...this.eventHistory],\n        lastStageChangeDay: this.lastStageChangeDay,\n      };\n    },\n\n    importTimeline(data: any) {\n      if (!data) return false;\n\n      try {\n        this.currentDay = data.currentDay || 0;\n        this.currentStage = (data.currentStage as Stage) || 'detention';\n        this.cellType = data.cellType || 'transition';\n        this.legalTimeline = (data.timeline as Timeline) || ({} as Timeline);\n        this.caseComplexity = data.complexity || 'normal';\n        this.isDeathPenalty = Boolean(data.isDeathPenalty);\n        this.eventCounters = data.eventCounters || {};\n        this.eventHistory = data.eventHistory || [];\n        this.lastStageChangeDay = data.lastStageChangeDay || 0;\n\n        console.info('[] ');\n        return true;\n      } catch (error) {\n        console.error('[] :', error);\n        return false;\n      }\n    },\n  };\n\n  // \n  DS.generateRandomEvent = (_context?: unknown) => EventSystem.generateRandomEvent();\n  DS.advanceDay = (days?: number) => EventSystem.advanceDay(days);\n  DS.getCurrentStage = () => EventSystem.getCurrentStageInfo();\n  DS.checkCellTransfer = () => EventSystem.checkCellTransfer();\n  DS.setCaseComplexity = (complexity: 'simple' | 'normal' | 'complex' | 'very_complex') =>\n    EventSystem.setCaseComplexity(complexity);\n  DS.rollbackToStage = (stage: Stage, reason?: string) => EventSystem.rollbackToStage(stage, reason);\n  DS.setDeathPenalty = (isDeathPenalty: boolean) => EventSystem.setDeathPenalty(isDeathPenalty);\n  DS.getEventStatistics = () => EventSystem.getEventStatistics();\n  DS.exportTimeline = () => EventSystem.exportTimeline();\n  DS.importTimeline = (data: unknown) => EventSystem.importTimeline(data);\n\n  DS.registerModule('eventSystem', EventSystem);\n\n  // \n  DS.events.on('user_input', (data?: unknown) => {\n    // #region agent log\n    fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        location: 'event_system.ts:1236',\n        message: '',\n        data: {\n          hasData: !!data,\n          dataType: typeof data,\n          textLength:\n            typeof (data as { text?: unknown } | undefined)?.text === 'string'\n              ? (data as { text?: string }).text?.length\n              : 0,\n        },\n        timestamp: Date.now(),\n        sessionId: 'debug-session',\n        runId: 'run1',\n        hypothesisId: 'E',\n      }),\n    }).catch(() => {});\n    // #endregion\n    const text =\n      typeof (data as { text?: unknown } | undefined)?.text === 'string' ? (data as { text?: string }).text : undefined;\n    if (text) {\n      // #region agent log\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'event_system.ts:1242',\n          message: '',\n          data: { text: text.substring(0, 50) },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'run1',\n          hypothesisId: 'E',\n        }),\n      }).catch(() => {});\n      // #endregion\n      EventSystem.handleUserRollback(text);\n    }\n  });\n\n  // \n  DS.events.on('initialized', () => {\n    // #region agent log\n    fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        location: 'event_system.ts:1246',\n        message: '',\n        data: { currentDay: EventSystem.currentDay, currentStage: EventSystem.currentStage },\n        timestamp: Date.now(),\n        sessionId: 'debug-session',\n        runId: 'run1',\n        hypothesisId: 'B',\n      }),\n    }).catch(() => {});\n    // #endregion\n    try {\n      EventSystem.initialize(0);\n      // #region agent log\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'event_system.ts:1250',\n          message: '',\n          data: { currentDay: EventSystem.currentDay, currentStage: EventSystem.currentStage },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'run1',\n          hypothesisId: 'B',\n        }),\n      }).catch(() => {});\n      // #endregion\n    } catch (error) {\n      // #region agent log\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'event_system.ts:1254',\n          message: '',\n          data: {\n            error: error instanceof Error ? error.message : String(error),\n            stack: error instanceof Error ? error.stack : undefined,\n          },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'run1',\n          hypothesisId: 'B',\n        }),\n      }).catch(() => {});\n      // #endregion\n      console.error('[] :', error);\n    }\n  });\n\n  console.info('[]  v3.4.0');\n}\n","export { };\n\n/**\n * NPC  NPC////\n *  registerModule \n */\n\ntype NPCGender = 'female' | 'male';\ntype NPCStatus = 'active' | 'removed';\ntype NPCRelationship = {\n  toProtagonist: number;\n  faction: string | null;\n  allies: string[];\n  enemies: string[];\n  influence: number;\n};\ntype NPCTraits = {\n  aggression: number;\n  sociability: number;\n  intelligence: number;\n  emotional: number;\n  dominance: number;\n  kindness: number;\n};\ntype NPCPersonality = { traits: NPCTraits; tags: string[] };\ntype NPCAppearance = {\n  height: number;\n  weight: number;\n  hair: string;\n  eyes: string;\n  skin: string;\n  features: string;\n};\ntype NPCBackground = {\n  education: string;\n  maritalStatus: string;\n  hasChildren: boolean;\n  childrenCount: number;\n  hometown: string;\n  priorConvictions: number;\n};\n\ntype NPCBase = {\n  id: string;\n  name: string;\n  gender: NPCGender;\n  age: number;\n  crime: string;\n  sentence: number;\n  appearance: NPCAppearance;\n  personality: NPCPersonality;\n  background: NPCBackground;\n  relationship: NPCRelationship;\n  cellType: string;\n  daysInCustody: number;\n  status: NPCStatus;\n  createdAt: number;\n};\n\ntype NPCPolice = {\n  role: 'police';\n  rank: string;\n  attitude: number;\n};\n\ntype NPCLawyer = {\n  role: 'lawyer';\n  type: string;\n  experience: number;\n  successRate: number;\n};\n\ntype NPCDoctor = {\n  role: 'doctor';\n  specialty: string;\n  experience: number;\n};\n\ntype NPCFamily = {\n  role: 'family';\n  relation: string;\n  supportLevel: number;\n};\n\ntype NPCSpecial = NPCPolice | NPCLawyer | NPCDoctor | NPCFamily;\ntype NPC = NPCBase & Partial<NPCSpecial>;\n\ntype EventTriggeredPayload = { id?: string };\ntype CellTransferPayload = { to?: string };\n\ninterface EventSystemModule {\n  getCurrentStageInfo?: () => { cellType?: string };\n}\n\ninterface DetentionSystem {\n  events: { on(event: string, callback: (data?: unknown) => void): void; emit(event: string, data?: unknown): void };\n  registerModule(name: string, module: unknown): void;\n  getModule<T = unknown>(name: string): T | undefined;\n}\n\ntype DetentionSystemWithNPC = DetentionSystem & {\n  generateNPC?: (count?: number, context?: Record<string, unknown>) => NPC[];\n  generateNPCForEvent?: (eventType: string) => NPC | { police: NPC; witnesses: NPC[] };\n  getCurrentCellNPCs?: () => NPC[];\n  setCurrentCellNPCs?: (npcs: NPC[]) => void;\n  addNPCToCell?: (npc: NPC) => void;\n  removeNPCFromCell?: (npcId: string) => NPC | null;\n  findNPC?: (npcId: string) => NPC | undefined;\n  updateNPCRelationship?: (npcId: string, delta: number) => void;\n  exportNPCData?: () => { database: NPC[]; currentCell: NPC[] };\n  importNPCData?: (data: { database?: NPC[]; currentCell?: NPC[] } | undefined) => boolean;\n};\n\ndeclare global {\n  interface DetentionSystem {\n    generateNPC?: (count?: number, context?: Record<string, unknown>) => NPC[];\n    generateNPCForEvent?: (eventType: string) => NPC | { police: NPC; witnesses: NPC[] };\n    getCurrentCellNPCs?: () => NPC[];\n    setCurrentCellNPCs?: (npcs: NPC[]) => void;\n    addNPCToCell?: (npc: NPC) => void;\n    removeNPCFromCell?: (npcId: string) => NPC | null;\n    findNPC?: (npcId: string) => NPC | undefined;\n    updateNPCRelationship?: (npcId: string, delta: number) => void;\n    exportNPCData?: () => { database: NPC[]; currentCell: NPC[] };\n    importNPCData?: (data: { database?: NPC[]; currentCell?: NPC[] } | undefined) => boolean;\n  }\n}\n\nconst DS = window.detentionSystem as DetentionSystemWithNPC | undefined;\n\nif (!DS) {\n  console.error('[NPC] ');\n} else {\n  console.info('[NPC] ...');\n\n  // ==========  ==========\n  const NameGenerator = {\n    surnames: {\n      tier1: {\n        names: ['', '', '', '', '', '', '', '', '', ''],\n        weight: 35\n      },\n      tier2: {\n        names: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        weight: 30\n      },\n      tier3: {\n        names: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        weight: 20\n      },\n      tier4: {\n        names: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        weight: 10\n      },\n      tier5: {\n        names: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        weight: 5\n      }\n    },\n    givenNames: {\n      vintage: {\n        single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        double: [\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', '']\n        ],\n        weight: 25\n      },\n      classic: {\n        single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        double: [\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', '']\n        ],\n        weight: 35\n      },\n      modern: {\n        single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        double: [\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', '']\n        ],\n        weight: 30\n      },\n      contemporary: {\n        single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n        double: [\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', ''],\n          ['', ''], ['', ''], ['', ''], ['', '']\n        ],\n        weight: 10\n      }\n    },\n    badNames: ['', '', '', '', '', '', '', '', '', '', '', ''],\n    badChars: ['', '', '', '', '', '', '', '', '', '', '', ''],\n\n    generate(birthYear: number): string {\n      let attempts = 0;\n      const maxAttempts = 50;\n      while (attempts < maxAttempts) {\n        attempts++;\n        const surname = this.selectSurname();\n        const givenName = this.selectGivenName(birthYear);\n        const fullName = surname + givenName;\n        if (this.isValidName(fullName)) return fullName;\n      }\n      return '' + this.givenNames.classic.single[0];\n    },\n\n    selectSurname(): string {\n      const tiers = Object.values(this.surnames);\n      const totalWeight = tiers.reduce((sum, tier) => sum + tier.weight, 0);\n      let random = Math.random() * totalWeight;\n      for (const tier of tiers) {\n        random -= tier.weight;\n        if (random <= 0) {\n          return tier.names[Math.floor(Math.random() * tier.names.length)];\n        }\n      }\n      return this.surnames.tier1.names[0];\n    },\n\n    selectGivenName(birthYear: number): string {\n      const currentYear = new Date().getFullYear();\n      const age = currentYear - birthYear;\n      const style =\n        age >= 50 ? 'vintage' :\n        age >= 35 ? 'classic' :\n        age >= 20 ? 'modern' : 'contemporary';\n      const styleData = this.givenNames[style as keyof typeof this.givenNames];\n      const useDouble = Math.random() < 0.6;\n      if (useDouble && styleData.double.length > 0) {\n        const pair = styleData.double[Math.floor(Math.random() * styleData.double.length)];\n        return pair[0] + pair[1];\n      }\n      return styleData.single[Math.floor(Math.random() * styleData.single.length)];\n    },\n\n    isValidName(name: string): boolean {\n      if (this.badNames.includes(name)) return false;\n      return !this.badChars.some(char => name.includes(char));\n    }\n  };\n\n  // ==========  ==========\n  const CrimeGenerator = {\n    characterBookCrimes: [\n      '', '', '', '', '', '',\n      '', '', '', '', '',\n      '', '', '', '', '',\n      '', '', '', '',\n      '', ''\n    ],\n    crimes: {\n      violent: {\n        names: ['', '', '', '', '', ''],\n        weight: 12,\n        sentenceRange: [3, 20] as [number, number]\n      },\n      property: {\n        names: ['', '', '', '', '', '', '', '', ''],\n        weight: 35,\n        sentenceRange: [1, 15] as [number, number]\n      },\n      drug: {\n        names: ['', '', '', '', '', '', ''],\n        weight: 20,\n        sentenceRange: [3, 15] as [number, number]\n      },\n      economic: {\n        names: ['', '', '', '', '', '', ''],\n        weight: 15,\n        sentenceRange: [2, 10] as [number, number]\n      },\n      social: {\n        names: ['', '', '', '', '', '', ''],\n        weight: 13,\n        sentenceRange: [1, 7] as [number, number]\n      },\n      other: {\n        names: ['', '', '', '', '', ''],\n        weight: 5,\n        sentenceRange: [1, 5] as [number, number]\n      }\n    },\n\n    generate(): { crime: string; sentence: number; category: { sentenceRange: [number, number] } } {\n      if (Math.random() < 0.3) {\n        const crime = this.characterBookCrimes[Math.floor(Math.random() * this.characterBookCrimes.length)];\n        const category = this.findCategoryByCrime(crime);\n        const sentence = this.generateSentence(category ? category.sentenceRange : [1, 10]);\n        return { crime, sentence, category: category || this.crimes.property };\n      }\n\n      const categories = Object.values(this.crimes);\n      const totalWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);\n      let random = Math.random() * totalWeight;\n      for (const category of categories) {\n        random -= category.weight;\n        if (random <= 0) {\n          const crime = category.names[Math.floor(Math.random() * category.names.length)];\n          const sentence = this.generateSentence(category.sentenceRange);\n          return { crime, sentence, category };\n        }\n      }\n\n      return { crime: '', sentence: 3, category: this.crimes.property };\n    },\n\n    findCategoryByCrime(crimeName: string) {\n      for (const key of Object.keys(this.crimes)) {\n        const category = this.crimes[key as keyof typeof this.crimes];\n        if (category.names.includes(crimeName)) return category;\n      }\n      return null;\n    },\n\n    generateSentence(range: [number, number]): number {\n      const [min, max] = range;\n      return Math.floor(Math.random() * (max - min + 1)) + min;\n    }\n  };\n\n  // ========== NPC ==========\n  const NPCGenerator = {\n    npcDatabase: [] as NPC[],\n    currentCellNPCs: [] as NPC[],\n\n    generate(count = 1, context: Record<string, unknown> = {}): NPC[] {\n      const npcs: NPC[] = [];\n      for (let i = 0; i < count; i++) {\n        const npc = this.generateSingle(context);\n        npcs.push(npc);\n        this.npcDatabase.push(npc);\n      }\n      return npcs;\n    },\n\n    generateSingle(context: Record<string, unknown> = {}): NPC {\n      const eventSystem = DS.getModule<EventSystemModule>('eventSystem');\n      const stageInfo = eventSystem?.getCurrentStageInfo ? eventSystem.getCurrentStageInfo() : {};\n\n      const age = this.generateAge();\n      const birthYear = new Date().getFullYear() - age;\n      const name = NameGenerator.generate(birthYear);\n      const crimeData = CrimeGenerator.generate();\n      const appearance = this.generateAppearance(age);\n      const personality = this.generatePersonality();\n      const background = this.generateBackground(age, crimeData);\n      const relationship = this.generateRelationship();\n\n      const cellType = typeof stageInfo?.cellType === 'string' ? stageInfo.cellType : (context.cellType as string) || 'transition';\n      this.adjustByCellType(personality, relationship, cellType);\n\n      const npc: NPC = {\n        id: this.generateId(),\n        name,\n        gender: 'female',\n        age,\n        crime: crimeData.crime,\n        sentence: crimeData.sentence,\n        appearance,\n        personality,\n        background,\n        relationship,\n        cellType,\n        daysInCustody: Math.floor(Math.random() * 365) + 30,\n        status: 'active',\n        createdAt: Date.now()\n      };\n      return npc;\n    },\n\n    generateAge(): number {\n      const random = Math.random();\n      if (random < 0.05) return Math.floor(Math.random() * 3) + 18;\n      if (random < 0.25) return Math.floor(Math.random() * 10) + 21;\n      if (random < 0.55) return Math.floor(Math.random() * 10) + 31;\n      if (random < 0.8) return Math.floor(Math.random() * 10) + 41;\n      if (random < 0.95) return Math.floor(Math.random() * 10) + 51;\n      return Math.floor(Math.random() * 15) + 61;\n    },\n\n    generateAppearance(age: number): NPCAppearance {\n      const heights = [150, 155, 160, 165, 170, 175];\n      const weights = [45, 50, 55, 60, 65, 70, 75];\n      const height = heights[Math.floor(Math.random() * heights.length)];\n      const weight = weights[Math.floor(Math.random() * weights.length)];\n      const hairStyles = age > 50\n        ? ['', '', '', '']\n        : ['', '', '', '', '', '', ''];\n      const skinTones = ['', '', '', '', ''];\n      const features = ['', '', '', '', '', '', ''];\n      return {\n        height,\n        weight,\n        hair: hairStyles[Math.floor(Math.random() * hairStyles.length)],\n        eyes: '',\n        skin: skinTones[Math.floor(Math.random() * skinTones.length)],\n        features: features[Math.floor(Math.random() * features.length)]\n      };\n    },\n\n    generatePersonality(): NPCPersonality {\n      const traits: NPCTraits = {\n        aggression: Math.floor(Math.random() * 100),\n        sociability: Math.floor(Math.random() * 100),\n        intelligence: Math.floor(Math.random() * 100),\n        emotional: Math.floor(Math.random() * 100),\n        dominance: Math.floor(Math.random() * 100),\n        kindness: Math.floor(Math.random() * 100)\n      };\n      const tags: string[] = [];\n      if (traits.aggression > 70) tags.push('');\n      if (traits.sociability > 70) tags.push('');\n      if (traits.intelligence > 70) tags.push('');\n      if (traits.emotional > 70) tags.push('');\n      if (traits.dominance > 70) tags.push('');\n      if (traits.kindness > 70) tags.push('');\n      if (traits.aggression < 30) tags.push('');\n      if (traits.sociability < 30) tags.push('');\n      if (traits.emotional < 30) tags.push('');\n      if (traits.dominance < 30) tags.push('');\n      return { traits, tags };\n    },\n\n    generateBackground(age: number, _crimeData: { crime: string; sentence: number; category: { sentenceRange: [number, number] } }): NPCBackground {\n      const educations = ['', '', '', '', '', '', ''];\n      const educationWeights = [10, 25, 30, 15, 10, 8, 2];\n      const educationIndex = this.weightedRandom(educations.length, educationWeights);\n      const maritalStatuses = ['', '', '', ''];\n      const maritalWeights = age < 25 ? [80, 15, 5, 0] : age < 40 ? [20, 60, 15, 5] : [10, 50, 30, 10];\n      const maritalIndex = this.weightedRandom(maritalStatuses.length, maritalWeights);\n      const hasChildren = maritalStatuses[maritalIndex] !== '' && Math.random() < 0.7;\n      const childrenCount = hasChildren ? Math.floor(Math.random() * 3) + 1 : 0;\n      return {\n        education: educations[educationIndex],\n        maritalStatus: maritalStatuses[maritalIndex],\n        hasChildren,\n        childrenCount,\n        hometown: this.generateHometown(),\n        priorConvictions: Math.random() < 0.3 ? Math.floor(Math.random() * 3) + 1 : 0\n      };\n    },\n\n    generateHometown(): string {\n      const provinces = [\n        '', '', '', '', '', '', '', '', '', '',\n        '', '', '', '', '', '', '', '', '', ''\n      ];\n      return provinces[Math.floor(Math.random() * provinces.length)];\n    },\n\n    generateRelationship(): NPCRelationship {\n      return {\n        toProtagonist: 50,\n        faction: null,\n        allies: [],\n        enemies: [],\n        influence: Math.floor(Math.random() * 100)\n      };\n    },\n\n    adjustByCellType(personality: NPCPersonality, relationship: NPCRelationship, cellType: string) {\n      if (cellType === 'transition') {\n        personality.traits.emotional += 10;\n        relationship.influence -= 20;\n      } else if (cellType === 'pretrial') {\n        personality.traits.emotional += 15;\n        personality.traits.aggression += 5;\n      } else if (cellType === 'convicted') {\n        personality.traits.emotional -= 10;\n        personality.traits.aggression += 10;\n        relationship.influence += 10;\n      }\n      (Object.keys(personality.traits) as Array<keyof NPCTraits>).forEach(key => {\n        personality.traits[key] = Math.max(0, Math.min(100, personality.traits[key]));\n      });\n      relationship.influence = Math.max(0, Math.min(100, relationship.influence));\n    },\n\n    weightedRandom(count: number, weights: number[]): number {\n      const totalWeight = weights.reduce((sum, w) => sum + w, 0);\n      let random = Math.random() * totalWeight;\n      for (let i = 0; i < count; i++) {\n        random -= weights[i];\n        if (random <= 0) return i;\n      }\n      return count - 1;\n    },\n\n    generateId(): string {\n      return 'npc_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);\n    },\n\n    generateForEvent(eventType: string): NPC | { police: NPC; witnesses: NPC[] } {\n      if (eventType === 'interrogation') return this.generatePolice();\n      if (eventType === 'lawyer_visit') return this.generateLawyer();\n      if (eventType === 'family_visit') return this.generateFamily();\n      if (eventType === 'medical_visit') return this.generateDoctor();\n      if (eventType === 'scene_identification') {\n        return { police: this.generatePolice(), witnesses: this.generate(2, { type: 'witness' }) };\n      }\n      return this.generateSingle({ eventType });\n    },\n\n    generatePolice(): NPC {\n      const age = Math.floor(Math.random() * 20) + 25;\n      const birthYear = new Date().getFullYear() - age;\n      const name = NameGenerator.generate(birthYear);\n      const ranks = ['', '', '', ''];\n      const rank = ranks[Math.floor(Math.random() * ranks.length)];\n      const npc: NPC = {\n        id: this.generateId(),\n        name,\n        gender: 'female',\n        age,\n        role: 'police',\n        rank,\n        appearance: this.generateAppearance(age),\n        personality: {\n          traits: {\n            aggression: Math.floor(Math.random() * 30) + 40,\n            sociability: Math.floor(Math.random() * 40) + 30,\n            intelligence: Math.floor(Math.random() * 30) + 50,\n            emotional: Math.floor(Math.random() * 40) + 20,\n            dominance: Math.floor(Math.random() * 30) + 60,\n            kindness: Math.floor(Math.random() * 60) + 20\n          },\n          tags: ['', '']\n        },\n        attitude: Math.floor(Math.random() * 40) + 30,\n        crime: '',\n        sentence: 0,\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\n        relationship: this.generateRelationship(),\n        cellType: 'staff',\n        daysInCustody: 0,\n        status: 'active',\n        createdAt: Date.now()\n      };\n      return npc;\n    },\n\n    generateLawyer(): NPC {\n      const age = Math.floor(Math.random() * 25) + 28;\n      const birthYear = new Date().getFullYear() - age;\n      const isFemale = Math.random() < 0.8;\n      const name = NameGenerator.generate(birthYear);\n      const types = ['', '', ''];\n      const typeWeights = [50, 40, 10];\n      const typeIndex = this.weightedRandom(types.length, typeWeights);\n      const npc: NPC = {\n        id: this.generateId(),\n        name,\n        gender: isFemale ? 'female' : 'male',\n        age,\n        role: 'lawyer',\n        type: types[typeIndex],\n        appearance: this.generateAppearance(age),\n        personality: {\n          traits: {\n            aggression: Math.floor(Math.random() * 20) + 20,\n            sociability: Math.floor(Math.random() * 30) + 60,\n            intelligence: Math.floor(Math.random() * 20) + 70,\n            emotional: Math.floor(Math.random() * 40) + 30,\n            dominance: Math.floor(Math.random() * 40) + 40,\n            kindness: Math.floor(Math.random() * 40) + 40\n          },\n          tags: ['', '']\n        },\n        experience: Math.floor(Math.random() * 20) + 5,\n        successRate: Math.floor(Math.random() * 40) + 40,\n        crime: '',\n        sentence: 0,\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\n        relationship: this.generateRelationship(),\n        cellType: 'external',\n        daysInCustody: 0,\n        status: 'active',\n        createdAt: Date.now()\n      };\n      return npc;\n    },\n\n    generateFamily(): NPC {\n      const relationships = ['', '', '', '', '', '', '', ''];\n      const weights = [30, 20, 15, 10, 10, 10, 3, 2];\n      const relationIndex = this.weightedRandom(relationships.length, weights);\n      const relation = relationships[relationIndex];\n      let age = 40;\n      let isFemale = true;\n      if (relation === '') {\n        age = Math.floor(Math.random() * 20) + 45;\n        isFemale = true;\n      } else if (relation === '') {\n        age = Math.floor(Math.random() * 20) + 45;\n        isFemale = false;\n      } else if (relation === '') {\n        age = Math.floor(Math.random() * 30) + 25;\n        isFemale = false;\n      } else if (relation === '') {\n        age = Math.floor(Math.random() * 30) + 25;\n        isFemale = true;\n      } else if (relation === '' || relation === '') {\n        age = Math.floor(Math.random() * 30) + 20;\n        isFemale = true;\n      } else if (relation === '') {\n        age = Math.floor(Math.random() * 15) + 5;\n        isFemale = true;\n      } else if (relation === '') {\n        age = Math.floor(Math.random() * 15) + 5;\n        isFemale = false;\n      }\n      const birthYear = new Date().getFullYear() - age;\n      const name = NameGenerator.generate(birthYear);\n      const npc: NPC = {\n        id: this.generateId(),\n        name,\n        gender: isFemale ? 'female' : 'male',\n        age,\n        role: 'family',\n        relation,\n        appearance: this.generateAppearance(age),\n        personality: {\n          traits: {\n            aggression: Math.floor(Math.random() * 30) + 10,\n            sociability: Math.floor(Math.random() * 50) + 30,\n            intelligence: Math.floor(Math.random() * 60) + 30,\n            emotional: Math.floor(Math.random() * 50) + 40,\n            dominance: Math.floor(Math.random() * 50) + 20,\n            kindness: Math.floor(Math.random() * 30) + 60\n          },\n          tags: ['', '']\n        },\n        supportLevel: Math.floor(Math.random() * 40) + 60,\n        crime: '',\n        sentence: 0,\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\n        relationship: this.generateRelationship(),\n        cellType: 'external',\n        daysInCustody: 0,\n        status: 'active',\n        createdAt: Date.now()\n      };\n      return npc;\n    },\n\n    generateDoctor(): NPC {\n      const age = Math.floor(Math.random() * 25) + 30;\n      const birthYear = new Date().getFullYear() - age;\n      const name = NameGenerator.generate(birthYear);\n      const specialties = ['', '', '', '', ''];\n      const specialty = specialties[Math.floor(Math.random() * specialties.length)];\n      const npc: NPC = {\n        id: this.generateId(),\n        name,\n        gender: 'female',\n        age,\n        role: 'doctor',\n        specialty,\n        appearance: this.generateAppearance(age),\n        personality: {\n          traits: {\n            aggression: Math.floor(Math.random() * 20) + 10,\n            sociability: Math.floor(Math.random() * 40) + 40,\n            intelligence: Math.floor(Math.random() * 20) + 70,\n            emotional: Math.floor(Math.random() * 40) + 30,\n            dominance: Math.floor(Math.random() * 40) + 40,\n            kindness: Math.floor(Math.random() * 30) + 60\n          },\n          tags: ['', '']\n        },\n        experience: Math.floor(Math.random() * 25) + 5,\n        crime: '',\n        sentence: 0,\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\n        relationship: this.generateRelationship(),\n        cellType: 'external',\n        daysInCustody: 0,\n        status: 'active',\n        createdAt: Date.now()\n      };\n      return npc;\n    },\n\n    getCurrentCellNPCs(): NPC[] {\n      return this.currentCellNPCs;\n    },\n\n    setCurrentCellNPCs(npcs: NPC[]) {\n      this.currentCellNPCs = npcs;\n      DS.events.emit('cell_npcs_changed', { npcs });\n    },\n\n    addNPCToCell(npc: NPC) {\n      this.currentCellNPCs.push(npc);\n      DS.events.emit('npc_joined_cell', { npc });\n    },\n\n    removeNPCFromCell(npcId: string): NPC | null {\n      const index = this.currentCellNPCs.findIndex(n => n.id === npcId);\n      if (index !== -1) {\n        const npc = this.currentCellNPCs.splice(index, 1)[0];\n        DS.events.emit('npc_left_cell', { npc });\n        return npc;\n      }\n      return null;\n    },\n\n    findNPCById(npcId: string): NPC | undefined {\n      return this.npcDatabase.find(n => n.id === npcId) || this.currentCellNPCs.find(n => n.id === npcId);\n    },\n\n    updateRelationship(npcId: string, delta: number) {\n      const npc = this.findNPCById(npcId);\n      if (npc && npc.relationship) {\n        npc.relationship.toProtagonist = Math.max(0, Math.min(100, npc.relationship.toProtagonist + delta));\n        DS.events.emit('relationship_changed', {\n          npcId,\n          npcName: npc.name,\n          value: npc.relationship.toProtagonist,\n          delta\n        });\n      }\n    },\n\n    exportData() {\n      return {\n        database: this.npcDatabase,\n        currentCell: this.currentCellNPCs\n      };\n    },\n\n    importData(data: { database?: NPC[]; currentCell?: NPC[] } | undefined): boolean {\n      if (!data) return false;\n      try {\n        this.npcDatabase = data.database || [];\n        this.currentCellNPCs = data.currentCell || [];\n        console.info('[NPC] ');\n        return true;\n      } catch (error) {\n        console.error('[NPC] :', error);\n        return false;\n      }\n    },\n\n    clearData() {\n      this.npcDatabase = [];\n      this.currentCellNPCs = [];\n      console.info('[NPC] ');\n    }\n  };\n\n  // ==========  ==========\n  DS.generateNPC = (count?: number, context?: Record<string, unknown>) => NPCGenerator.generate(count, context ?? {});\n  DS.generateNPCForEvent = (eventType: string) => NPCGenerator.generateForEvent(eventType);\n  DS.getCurrentCellNPCs = () => NPCGenerator.getCurrentCellNPCs();\n  DS.setCurrentCellNPCs = (npcs: NPC[]) => NPCGenerator.setCurrentCellNPCs(npcs);\n  DS.addNPCToCell = (npc: NPC) => NPCGenerator.addNPCToCell(npc);\n  DS.removeNPCFromCell = (npcId: string) => NPCGenerator.removeNPCFromCell(npcId);\n  DS.findNPC = (npcId: string) => NPCGenerator.findNPCById(npcId);\n  DS.updateNPCRelationship = (npcId: string, delta: number) => NPCGenerator.updateRelationship(npcId, delta);\n  DS.exportNPCData = () => NPCGenerator.exportData();\n  DS.importNPCData = (data?: { database?: NPC[]; currentCell?: NPC[] }) => NPCGenerator.importData(data);\n\n  DS.registerModule('npcSystem', NPCGenerator);\n\n  // ==========  ==========\n  DS.events.on('event_triggered', (event?: unknown) => {\n    const eventId = typeof (event as EventTriggeredPayload | undefined)?.id === 'string'\n      ? (event as EventTriggeredPayload).id\n      : undefined;\n    if (!eventId) return;\n    if (['interrogation', 'lawyer_visit', 'family_visit', 'medical_visit', 'scene_identification'].includes(eventId)) {\n      const npc = NPCGenerator.generateForEvent(eventId);\n      DS.events.emit('event_npc_generated', { event, npc });\n    }\n  });\n\n  // ==========  ==========\n  DS.events.on('cell_transfer', (data?: unknown) => {\n    const to = (data as CellTransferPayload | undefined)?.to;\n    const newCellType = typeof to === 'string' ? to : 'transition';\n    const npcCount = Math.floor(Math.random() * 5) + 3;\n    const newNPCs = NPCGenerator.generate(npcCount, { cellType: newCellType });\n    NPCGenerator.setCurrentCellNPCs(newNPCs);\n    console.info(`[NPC] ${npcCount}NPC`);\n  });\n\n  console.info('[NPC]  - ');\n}\n","export {};\n\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\ndeclare const $: JQueryStaticLike;\n\n/**\n * \n *  API name\n */\n\ninterface WorldbookConfig {\n  name: string; // \n  displayName: string; // \n  priority: number; // \n  keywords: string[]; // \n  autoLoad: boolean; // \n  description?: string; // \n  position?: 'before_char' | 'after_char'; // \n  depth?: number; // \n  fallbackEntries?: unknown[]; // \n}\n\ninterface LoadedWorldbook {\n  name: string;\n  displayName: string;\n  entries: unknown[];\n  fallback: boolean;\n  error?: string;\n  loadedAt: number;\n}\n\ninterface WorldbookStatus {\n  initialized: boolean;\n  fallbackMode: boolean;\n  characterWorldbook: string | null;\n  loaded: Array<{\n    name: string;\n    displayName: string;\n    entries: number;\n    fallback: boolean;\n    error?: string;\n    loadedAt: string;\n  }>;\n  loading: Array<{\n    name: string;\n    displayName: string;\n  }>;\n  available: Array<{\n    name: string;\n    displayName: string;\n    autoLoad: boolean;\n  }>;\n}\n\ninterface EventBus {\n  on(event: string, callback: (data?: unknown) => void): void;\n  emit(event: string, data?: unknown): void;\n}\n\ninterface DetentionSystem {\n  version: string;\n  initialized: boolean;\n  modules: Record<string, unknown>;\n  config: Record<string, unknown>;\n  state: Record<string, unknown>;\n  events: EventBus;\n  CacheManager: unknown;\n  EventEmitter: unknown;\n  ping(): boolean;\n  registerModule(name: string, module: unknown): void;\n  getModule<T = unknown>(name: string): T | undefined;\n  handleError(error: unknown, context?: string): void;\n}\n\n// \nconst WORLDBOOKS: Record<string, WorldbookConfig> = {\n  detention_rules: {\n    name: 'detention_rules',\n    displayName: '',\n    description: '',\n    priority: 10,\n    keywords: [\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    autoLoad: true,\n    position: 'before_char',\n    depth: 4,\n    fallbackEntries: [],\n  },\n  internal_basic_procedures: {\n    name: 'internal_basic_procedures',\n    displayName: '',\n    description: '',\n    priority: 9,\n    keywords: [\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    autoLoad: false,\n    position: 'after_char',\n    depth: 4,\n    fallbackEntries: [],\n  },\n  internal_basic_legal: {\n    name: 'internal_basic_legal',\n    displayName: '',\n    description:\n      '//',\n    priority: 8,\n    keywords: [\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    autoLoad: false,\n    position: 'before_char',\n    depth: 4,\n    fallbackEntries: [],\n  },\n  legal_knowledge: {\n    name: 'legal_knowledge',\n    displayName: '',\n    description: '',\n    priority: 7,\n    keywords: [\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    autoLoad: false,\n    position: 'after_char',\n    depth: 4,\n    fallbackEntries: [],\n  },\n  environment_descriptions: {\n    name: 'environment_descriptions',\n    displayName: '',\n    description: '',\n    priority: 6,\n    keywords: [\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    autoLoad: false,\n    position: 'before_char',\n    depth: 4,\n    fallbackEntries: [],\n  },\n  narrative_enhancements: {\n    name: 'narrative_enhancements',\n    displayName: '',\n    description: '',\n    priority: 5,\n    keywords: [\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n      '',\n    ],\n    autoLoad: false,\n    position: 'after_char',\n    depth: 4,\n    fallbackEntries: [],\n  },\n};\n\ninterface WorldbookLoaderImpl {\n  loaded: Map<string, LoadedWorldbook>;\n  loading: Map<string, Promise<LoadedWorldbook>>;\n  initialized: boolean;\n  fallbackMode: boolean;\n  characterWorldbookId: string | null;\n\n  findCharacterWorldbook(): Promise<string | null>;\n  loadWorldbook(bookName: string): Promise<LoadedWorldbook>;\n  _loadWorldbookInternal(bookName: string, config: WorldbookConfig): Promise<LoadedWorldbook>;\n  predictiveCache(context: string): Promise<void>;\n  getRelevantEntries(context: string, maxEntries?: number): unknown[];\n  dynamicLoad(userInput: string): Promise<void>;\n  getStatus(): WorldbookStatus;\n  unloadWorldbook(bookName: string): Promise<void>;\n  reloadWorldbook(bookName: string): Promise<LoadedWorldbook>;\n  initialize(): Promise<void>;\n  shutdown(): void;\n}\n\nconsole.info('[] v5.1.0 ...');\n\n// #region agent log\nfetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    location: 'worldbook_loader.ts:190',\n    message: '',\n    data: { hasDetentionSystem: !!window.detentionSystem, detentionSystemType: typeof window.detentionSystem },\n    timestamp: Date.now(),\n    sessionId: 'debug-session',\n    runId: 'run1',\n    hypothesisId: 'A',\n  }),\n}).catch(() => {});\n// #endregion\n\nconst DS = window.detentionSystem as DetentionSystem | undefined;\n\nif (!DS) {\n  console.error('[] ');\n  // #region agent log\n  fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      location: 'worldbook_loader.ts:195',\n      message: '',\n      data: { windowKeys: Object.keys(window).filter(k => k.includes('detention') || k.includes('Detention')) },\n      timestamp: Date.now(),\n      sessionId: 'debug-session',\n      runId: 'run1',\n      hypothesisId: 'A',\n    }),\n  }).catch(() => {});\n  // #endregion\n} else {\n  // #region agent log\n  fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      location: 'worldbook_loader.ts:199',\n      message: '',\n      data: {\n        version: DS.version,\n        initialized: DS.initialized,\n        hasEvents: !!DS.events,\n        moduleCount: Object.keys(DS.modules || {}).length,\n      },\n      timestamp: Date.now(),\n      sessionId: 'debug-session',\n      runId: 'run1',\n      hypothesisId: 'A',\n    }),\n  }).catch(() => {});\n  // #endregion\n  // \n  (DS as DetentionSystem & { characterId?: string }).characterId = 'detention_center';\n  console.info('[]  ');\n\n  // ==========  ==========\n  const WorldbookLoader: WorldbookLoaderImpl = {\n    loaded: new Map(),\n    loading: new Map(),\n    initialized: false,\n    fallbackMode: false,\n    characterWorldbookId: null,\n\n    /**\n     * \n     */\n    async findCharacterWorldbook(): Promise<string | null> {\n      console.info('[] ...');\n\n      try {\n        const charWorldbooks = getCharWorldbookNames('current');\n        if (charWorldbooks.primary) {\n          console.info(`[]  : ${charWorldbooks.primary}`);\n          this.characterWorldbookId = charWorldbooks.primary;\n          return charWorldbooks.primary;\n        }\n\n        if (charWorldbooks.additional.length > 0) {\n          console.info(`[]  : ${charWorldbooks.additional[0]}`);\n          this.characterWorldbookId = charWorldbooks.additional[0];\n          return charWorldbooks.additional[0];\n        }\n\n        console.warn('[]  ');\n        return null;\n      } catch (error) {\n        console.error('[] :', error);\n        return null;\n      }\n    },\n\n    /**\n     * \n     */\n    async loadWorldbook(bookName: string): Promise<LoadedWorldbook> {\n      const config = WORLDBOOKS[bookName];\n      if (!config) {\n        throw new Error(`: ${bookName}`);\n      }\n\n      // \n      if (this.loaded.has(bookName)) {\n        console.info(`[] ${config.displayName} `);\n        return this.loaded.get(bookName)!;\n      }\n\n      // \n      if (this.loading.has(bookName)) {\n        console.info(`[] ${config.displayName} ...`);\n        return await this.loading.get(bookName)!;\n      }\n\n      //  Promise\n      const loadPromise = this._loadWorldbookInternal(bookName, config);\n      this.loading.set(bookName, loadPromise);\n\n      try {\n        const result = await loadPromise;\n        this.loaded.set(bookName, result);\n        return result;\n      } finally {\n        this.loading.delete(bookName);\n      }\n    },\n\n    /**\n     * \n     */\n    async _loadWorldbookInternal(bookName: string, config: WorldbookConfig): Promise<LoadedWorldbook> {\n      console.info(`[] : ${config.displayName} (${bookName})`);\n\n      // #region agent log\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'worldbook_loader.ts:274',\n          message: '',\n          data: { bookName, displayName: config.displayName, priority: config.priority },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'run1',\n          hypothesisId: 'C',\n        }),\n      }).catch(() => {});\n      // #endregion\n\n      try {\n        // \n        const allWorldbookNames = getWorldbookNames();\n        // #region agent log\n        fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'worldbook_loader.ts:279',\n            message: '',\n            data: {\n              count: allWorldbookNames.length,\n              names: allWorldbookNames.slice(0, 10),\n              targetDisplayName: config.displayName,\n              targetName: config.name,\n            },\n            timestamp: Date.now(),\n            sessionId: 'debug-session',\n            runId: 'run1',\n            hypothesisId: 'C',\n          }),\n        }).catch(() => {});\n        // #endregion\n\n        // displayName\n        let targetWorldbookName: string | null = null;\n\n        // 1.  displayName- \n        const exactDisplayMatch = allWorldbookNames.find(name => name === config.displayName);\n        if (exactDisplayMatch) {\n          targetWorldbookName = exactDisplayMatch;\n          console.info(`[]  : \"${config.displayName}\"`);\n        } else if (allWorldbookNames.includes(config.name)) {\n          // 2.  name\n          targetWorldbookName = config.name;\n          console.info(`[]  : \"${config.name}\"`);\n        } else {\n          // 3.  displayName  name\n          const fuzzyMatch = allWorldbookNames.find(\n            name =>\n              name.includes(config.displayName) ||\n              config.displayName.includes(name) ||\n              name.includes(config.name) ||\n              config.name.includes(name),\n          );\n          if (fuzzyMatch) {\n            targetWorldbookName = fuzzyMatch;\n            console.info(`[]  : \"${fuzzyMatch}\"`);\n          }\n        }\n\n        if (!targetWorldbookName) {\n          const availableBooks = allWorldbookNames.join(', ');\n          // #region agent log\n          fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              location: 'worldbook_loader.ts:309',\n              message: '',\n              data: {\n                bookName,\n                displayName: config.displayName,\n                availableCount: allWorldbookNames.length,\n                availableNames: allWorldbookNames,\n              },\n              timestamp: Date.now(),\n              sessionId: 'debug-session',\n              runId: 'run1',\n              hypothesisId: 'C',\n            }),\n          }).catch(() => {});\n          // #endregion\n          throw new Error(\n            `: ${config.displayName} (${bookName})\\n` +\n              `: ${availableBooks}\\n` +\n              `:  displayName  name `,\n          );\n        }\n        // #region agent log\n        fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'worldbook_loader.ts:318',\n            message: '',\n            data: { bookName, targetWorldbookName, displayName: config.displayName },\n            timestamp: Date.now(),\n            sessionId: 'debug-session',\n            runId: 'run1',\n            hypothesisId: 'C',\n          }),\n        }).catch(() => {});\n        // #endregion\n\n        // \n        const entries = await getWorldbook(targetWorldbookName);\n\n        if (entries.length === 0) {\n          throw new Error('');\n        }\n\n        // \n        const charWorldbooks = getCharWorldbookNames('current');\n        if (!charWorldbooks.additional.includes(targetWorldbookName)) {\n          await rebindCharWorldbooks('current', {\n            primary: charWorldbooks.primary,\n            additional: [...charWorldbooks.additional, targetWorldbookName],\n          });\n          console.info(`[]  : ${targetWorldbookName}`);\n        }\n\n        console.info(`[]  ${config.displayName}  (${entries.length} )`);\n\n        return {\n          name: bookName,\n          displayName: config.displayName,\n          entries: entries,\n          fallback: false,\n          loadedAt: Date.now(),\n        };\n      } catch (error) {\n        const errorMessage = error instanceof Error ? error.message : String(error);\n        console.warn(`[]  ${config.displayName} :`, errorMessage);\n\n        // \n        if (config.fallbackEntries && config.fallbackEntries.length > 0) {\n          console.info(`[]  ${config.displayName}  (${config.fallbackEntries.length} )`);\n          this.fallbackMode = true;\n\n          return {\n            name: bookName,\n            displayName: config.displayName,\n            entries: config.fallbackEntries,\n            fallback: true,\n            error: errorMessage,\n            loadedAt: Date.now(),\n          };\n        }\n\n        throw error;\n      }\n    },\n\n    /**\n     * \n     */\n    async predictiveCache(context: string): Promise<void> {\n      if (!context || typeof context !== 'string') {\n        return;\n      }\n\n      console.info('[] ...');\n\n      const predictions: Array<{ bookName: string; score: number; priority: number; weightedScore: number }> = [];\n\n      for (const bookName in WORLDBOOKS) {\n        const config = WORLDBOOKS[bookName];\n\n        if (this.loaded.has(bookName)) {\n          continue;\n        }\n\n        let matchScore = 0;\n        let weightedScore = 0;\n\n        // \n        for (const keyword of config.keywords) {\n          if (context.includes(keyword)) {\n            matchScore++;\n            // \n            const keywordWeight = keyword.length >= 3 ? 2 : 1;\n            weightedScore += keywordWeight;\n\n            // \n            if (config.description && config.description.includes(keyword)) {\n              weightedScore += 1;\n            }\n          }\n        }\n\n        // \n        if (config.description) {\n          const descKeywords = config.description.match(/[\\u4e00-\\u9fa5]{2,}/g) || [];\n          for (const descKw of descKeywords) {\n            if (context.includes(descKw) && descKw.length >= 2) {\n              weightedScore += 0.5;\n            }\n          }\n        }\n\n        if (matchScore > 0) {\n          //  =  * 10 + \n          const finalScore = config.priority * 10 + weightedScore;\n\n          predictions.push({\n            bookName,\n            score: matchScore,\n            priority: config.priority,\n            weightedScore: finalScore,\n          });\n        }\n      }\n\n      // \n      predictions.sort((a, b) => {\n        if (Math.abs(b.weightedScore - a.weightedScore) > 1) {\n          return b.weightedScore - a.weightedScore;\n        }\n        if (b.priority !== a.priority) {\n          return b.priority - a.priority;\n        }\n        return b.score - a.score;\n      });\n\n      console.info(`[]  ${predictions.length} `);\n\n      // 1>10\n      const toLoad = predictions.filter(p => p.weightedScore > 10).slice(0, 3);\n\n      if (toLoad.length === 0) {\n        console.info('[] ');\n        return;\n      }\n\n      for (const pred of toLoad) {\n        console.info(\n          `[] : ${WORLDBOOKS[pred.bookName].displayName} ` +\n            `(: ${pred.score}, : ${pred.weightedScore.toFixed(1)})`,\n        );\n\n        try {\n          await this.loadWorldbook(pred.bookName);\n        } catch (error) {\n          console.warn(`[] : ${pred.bookName}`, error);\n        }\n      }\n    },\n\n    /**\n     * \n     */\n    getRelevantEntries(context: string, maxEntries: number = 5): unknown[] {\n      if (!context || typeof context !== 'string') {\n        return [];\n      }\n\n      const allEntries: Array<{ entry: unknown; bookName: string; bookDisplayName: string; priority: number }> = [];\n\n      this.loaded.forEach((bookData, bookName) => {\n        if (bookData.entries && Array.isArray(bookData.entries)) {\n          for (const entry of bookData.entries) {\n            allEntries.push({\n              entry,\n              bookName: bookName,\n              bookDisplayName: bookData.displayName,\n              priority: WORLDBOOKS[bookName]?.priority || 0,\n            });\n          }\n        }\n      });\n\n      const scoredEntries = allEntries.map(item => {\n        let score = 0;\n        const entry = item.entry as {\n          keys?: string[];\n          key?: string[];\n          constant?: boolean;\n          name?: string;\n          content?: string;\n        };\n        const keys = entry.keys || entry.key || [];\n\n        // \n        for (const key of keys) {\n          if (context.includes(key)) {\n            const keyWeight = key.length >= 3 ? 15 : 10;\n            score += keyWeight;\n\n            // \n            if (entry.name && entry.name.includes(key)) {\n              score += 5;\n            }\n          }\n        }\n\n        // \n        if (entry.name && context.includes(entry.name)) {\n          score += 20;\n        }\n\n        // \n        if (entry.content) {\n          const contentMatch = entry.content.substring(0, 100);\n          if (context.includes(contentMatch.substring(0, 10))) {\n            score += 3;\n          }\n        }\n\n        // \n        score += item.priority || 0;\n\n        // \n        if (entry.constant) {\n          score += 30;\n        }\n\n        return {\n          entry: item.entry,\n          score,\n          bookName: item.bookName,\n          bookDisplayName: item.bookDisplayName,\n        };\n      });\n\n      // \n      scoredEntries.sort((a, b) => {\n        if (Math.abs(b.score - a.score) > 5) {\n          return b.score - a.score;\n        }\n        // \n        const aPriority = WORLDBOOKS[a.bookName]?.priority || 0;\n        const bPriority = WORLDBOOKS[b.bookName]?.priority || 0;\n        return bPriority - aPriority;\n      });\n\n      const relevant = scoredEntries\n        .filter(item => item.score > 0)\n        .slice(0, maxEntries)\n        .map(item => item.entry);\n\n      if (relevant.length > 0) {\n        console.info(\n          `[]  ${relevant.length}  ` +\n            `(: ${scoredEntries[0]?.score || 0}, : ${scoredEntries[0]?.bookDisplayName || ''})`,\n        );\n      }\n\n      return relevant;\n    },\n\n    /**\n     * \n     */\n    async dynamicLoad(userInput: string): Promise<void> {\n      if (!userInput || typeof userInput !== 'string' || userInput.length < 3) {\n        return;\n      }\n\n      console.info('[] ...');\n\n      const triggers: Array<{\n        bookName: string;\n        keyword: string;\n        priority: number;\n        matchCount: number;\n        score: number;\n      }> = [];\n\n      for (const bookName in WORLDBOOKS) {\n        const config = WORLDBOOKS[bookName];\n\n        if (this.loaded.has(bookName)) {\n          continue;\n        }\n\n        let matchCount = 0;\n        let bestKeyword = '';\n        let maxKeywordLength = 0;\n\n        // \n        for (const keyword of config.keywords) {\n          if (userInput.includes(keyword)) {\n            matchCount++;\n            if (keyword.length > maxKeywordLength) {\n              maxKeywordLength = keyword.length;\n              bestKeyword = keyword;\n            }\n          }\n        }\n\n        // \n        if (matchCount > 0) {\n          //  =  * 10 +  * 2 + \n          const score = config.priority * 10 + matchCount * 2 + maxKeywordLength;\n\n          triggers.push({\n            bookName,\n            keyword: bestKeyword,\n            priority: config.priority,\n            matchCount,\n            score,\n          });\n        }\n      }\n\n      if (triggers.length === 0) {\n        console.info('[] ');\n        return;\n      }\n\n      // \n      triggers.sort((a, b) => {\n        if (Math.abs(b.score - a.score) > 2) {\n          return b.score - a.score;\n        }\n        return b.priority - a.priority;\n      });\n\n      console.info(`[]  ${triggers.length} `);\n\n      // 3\n      const toLoad = triggers.slice(0, 3);\n\n      for (const trigger of toLoad) {\n        console.info(\n          `[] : ${WORLDBOOKS[trigger.bookName].displayName} ` +\n            `(: ${trigger.keyword}, : ${trigger.matchCount}, : ${trigger.score})`,\n        );\n\n        try {\n          await this.loadWorldbook(trigger.bookName);\n        } catch (error) {\n          console.warn(`[] : ${trigger.bookName}`, error);\n        }\n      }\n    },\n\n    /**\n     * \n     */\n    getStatus(): WorldbookStatus {\n      const status: WorldbookStatus = {\n        initialized: this.initialized,\n        fallbackMode: this.fallbackMode,\n        characterWorldbook: this.characterWorldbookId,\n        loaded: [],\n        loading: [],\n        available: [],\n      };\n\n      this.loaded.forEach((data, name) => {\n        status.loaded.push({\n          name: name,\n          displayName: data.displayName,\n          entries: data.entries.length,\n          fallback: data.fallback,\n          error: data.error,\n          loadedAt: new Date(data.loadedAt).toLocaleTimeString(),\n        });\n      });\n\n      this.loading.forEach((_promise, name) => {\n        status.loading.push({\n          name: name,\n          displayName: WORLDBOOKS[name]?.displayName || name,\n        });\n      });\n\n      for (const bookName in WORLDBOOKS) {\n        if (!this.loaded.has(bookName) && !this.loading.has(bookName)) {\n          status.available.push({\n            name: bookName,\n            displayName: WORLDBOOKS[bookName].displayName,\n            autoLoad: WORLDBOOKS[bookName].autoLoad,\n          });\n        }\n      }\n\n      return status;\n    },\n\n    /**\n     * \n     */\n    async unloadWorldbook(bookName: string): Promise<void> {\n      if (!this.loaded.has(bookName)) {\n        console.warn(`[] ${bookName} `);\n        return;\n      }\n\n      console.info(`[] : ${WORLDBOOKS[bookName]?.displayName || bookName}`);\n\n      // \n      const charWorldbooks = getCharWorldbookNames('current');\n      const loadedData = this.loaded.get(bookName);\n      if (loadedData) {\n        // \n        const allWorldbookNames = getWorldbookNames();\n        const targetName = allWorldbookNames.find(name => name === bookName || name.includes(bookName));\n\n        if (targetName) {\n          const newAdditional = charWorldbooks.additional.filter(name => name !== targetName);\n          await rebindCharWorldbooks('current', {\n            primary: charWorldbooks.primary,\n            additional: newAdditional,\n          });\n        }\n      }\n\n      this.loaded.delete(bookName);\n    },\n\n    /**\n     * \n     */\n    async reloadWorldbook(bookName: string): Promise<LoadedWorldbook> {\n      console.info(`[] : ${WORLDBOOKS[bookName]?.displayName || bookName}`);\n      await this.unloadWorldbook(bookName);\n      return await this.loadWorldbook(bookName);\n    },\n\n    /**\n     * \n     */\n    async initialize(): Promise<void> {\n      // #region agent log\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'worldbook_loader.ts:738',\n          message: '',\n          data: { alreadyInitialized: this.initialized, fallbackMode: this.fallbackMode },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'run1',\n          hypothesisId: 'D',\n        }),\n      }).catch(() => {});\n      // #endregion\n      if (this.initialized) {\n        console.info('[] ');\n        return;\n      }\n\n      console.info('[] ...');\n\n      await this.findCharacterWorldbook();\n\n      // \n      let retries = 0;\n      let availableWorldbooks: string[] = [];\n      while (retries < 40) {\n        try {\n          availableWorldbooks = getWorldbookNames();\n          if (availableWorldbooks.length > 0) {\n            console.info(`[]   (${availableWorldbooks.length} )`);\n            console.info(`[] : ${availableWorldbooks.join(', ')}`);\n            break;\n          }\n        } catch (error) {\n          // \n        }\n\n        console.info(`[] ... (${retries + 1}/40)`);\n        await new Promise(resolve => setTimeout(resolve, 500));\n        retries++;\n      }\n\n      // \n      console.info('[] :');\n      for (const bookName in WORLDBOOKS) {\n        const config = WORLDBOOKS[bookName];\n        const isAvailable = availableWorldbooks.some(\n          name => name === config.displayName || name === config.name || name.includes(config.displayName),\n        );\n        console.info(\n          `  - ${config.displayName} (${bookName}): ` +\n            `=${config.priority}, ` +\n            `=${config.autoLoad ? '' : ''}, ` +\n            `=${isAvailable ? '' : ''}`,\n        );\n      }\n\n      // \n      const autoLoadBooks: string[] = [];\n      for (const bookName in WORLDBOOKS) {\n        if (WORLDBOOKS[bookName].autoLoad) {\n          autoLoadBooks.push(bookName);\n        }\n      }\n\n      console.info(`[]  ${autoLoadBooks.length} `);\n\n      for (const bookName of autoLoadBooks) {\n        try {\n          await this.loadWorldbook(bookName);\n        } catch (err) {\n          console.warn(`[] : ${bookName}`, err);\n        }\n      }\n\n      this.initialized = true;\n\n      const status = this.getStatus();\n      console.info('[]  ');\n      console.table(status.loaded);\n      // #region agent log\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'worldbook_loader.ts:801',\n          message: '',\n          data: {\n            loadedCount: status.loaded.length,\n            loadingCount: status.loading.length,\n            availableCount: status.available.length,\n            fallbackMode: this.fallbackMode,\n          },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'run1',\n          hypothesisId: 'D',\n        }),\n      }).catch(() => {});\n      // #endregion\n\n      // \n      if (this.fallbackMode) {\n        console.warn('');\n        console.warn('[]  ');\n        console.warn('[]  ');\n        console.warn('[]  ');\n        console.warn('');\n\n        const fallbackBooks = status.loaded.filter(b => b.fallback);\n        console.table(fallbackBooks);\n\n        // 3\n        setTimeout(() => {\n          console.info('[] ...');\n          this.shutdown();\n        }, 3000);\n      } else {\n        console.info('[]  ');\n      }\n    },\n\n    /**\n     * \n     */\n    shutdown(): void {\n      console.info('[] ...');\n\n      // \n      this.loaded.clear();\n      this.loading.clear();\n\n      // \n      if (DS) {\n        delete (DS as DetentionSystem & { loadWorldbook?: unknown }).loadWorldbook;\n        delete (DS as DetentionSystem & { unloadWorldbook?: unknown }).unloadWorldbook;\n        delete (DS as DetentionSystem & { reloadWorldbook?: unknown }).reloadWorldbook;\n        delete (DS as DetentionSystem & { predictiveCache?: unknown }).predictiveCache;\n        delete (DS as DetentionSystem & { getRelevantEntries?: unknown }).getRelevantEntries;\n        delete (DS as DetentionSystem & { getWorldbookStatus?: unknown }).getWorldbookStatus;\n        delete (DS as DetentionSystem & { dynamicLoad?: unknown }).dynamicLoad;\n      }\n\n      this.initialized = false;\n      this.fallbackMode = false;\n\n      console.info('[]  ');\n      console.info('[] ');\n    },\n  };\n\n  // ==========  ==========\n  (\n    DS as DetentionSystem & {\n      loadWorldbook?: (bookName: string) => Promise<LoadedWorldbook>;\n      unloadWorldbook?: (bookName: string) => Promise<void>;\n      reloadWorldbook?: (bookName: string) => Promise<LoadedWorldbook>;\n      predictiveCache?: (context: string) => Promise<void>;\n      dynamicLoad?: (userInput: string) => Promise<void>;\n      getRelevantEntries?: (context: string, max?: number) => unknown[];\n      getWorldbookStatus?: () => WorldbookStatus;\n    }\n  ).loadWorldbook = (bookName: string) => WorldbookLoader.loadWorldbook(bookName);\n  (DS as DetentionSystem & { unloadWorldbook?: (bookName: string) => Promise<void> }).unloadWorldbook = (\n    bookName: string,\n  ) => WorldbookLoader.unloadWorldbook(bookName);\n  (DS as DetentionSystem & { reloadWorldbook?: (bookName: string) => Promise<LoadedWorldbook> }).reloadWorldbook = (\n    bookName: string,\n  ) => WorldbookLoader.reloadWorldbook(bookName);\n  (DS as DetentionSystem & { predictiveCache?: (context: string) => Promise<void> }).predictiveCache = (\n    context: string,\n  ) => WorldbookLoader.predictiveCache(context);\n  (DS as DetentionSystem & { dynamicLoad?: (userInput: string) => Promise<void> }).dynamicLoad = (userInput: string) =>\n    WorldbookLoader.dynamicLoad(userInput);\n  (DS as DetentionSystem & { getRelevantEntries?: (context: string, max?: number) => unknown[] }).getRelevantEntries = (\n    context: string,\n    max?: number,\n  ) => WorldbookLoader.getRelevantEntries(context, max);\n  (DS as DetentionSystem & { getWorldbookStatus?: () => WorldbookStatus }).getWorldbookStatus = () =>\n    WorldbookLoader.getStatus();\n\n  DS.registerModule('worldbook', WorldbookLoader);\n\n  console.info('[]  ');\n\n  // ==========  ==========\n  DS.events.on('event_triggered', (eventData?: unknown) => {\n    const event = eventData as { id?: string; description?: string } | undefined;\n    if (event?.description) {\n      WorldbookLoader.predictiveCache(event.description).catch(err => {\n        console.warn('[] :', err);\n      });\n    }\n  });\n\n  // ==========  ==========\n  DS.events.on('user_input', (data?: unknown) => {\n    // #region agent log\n    fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        location: 'worldbook_loader.ts:899',\n        message: '',\n        data: {\n          hasData: !!data,\n          dataType: typeof data,\n          textLength:\n            typeof (data as { text?: unknown } | undefined)?.text === 'string'\n              ? (data as { text?: string }).text?.length\n              : 0,\n          initialized: WorldbookLoader.initialized,\n        },\n        timestamp: Date.now(),\n        sessionId: 'debug-session',\n        runId: 'run1',\n        hypothesisId: 'E',\n      }),\n    }).catch(() => {});\n    // #endregion\n    const input = data as { text?: string } | undefined;\n    if (input?.text && input.text.length > 5) {\n      // #region agent log\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'worldbook_loader.ts:905',\n          message: '',\n          data: { textLength: input.text.length, textPreview: input.text.substring(0, 50) },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'run1',\n          hypothesisId: 'E',\n        }),\n      }).catch(() => {});\n      // #endregion\n      WorldbookLoader.dynamicLoad(input.text).catch(err => {\n        // #region agent log\n        fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'worldbook_loader.ts:908',\n            message: '',\n            data: { error: err instanceof Error ? err.message : String(err) },\n            timestamp: Date.now(),\n            sessionId: 'debug-session',\n            runId: 'run1',\n            hypothesisId: 'E',\n          }),\n        }).catch(() => {});\n        // #endregion\n        console.warn('[] :', err);\n      });\n    }\n  });\n\n  // ==========  ==========\n  $(() => {\n    console.info('[] ...');\n\n    // 2\n    setTimeout(async () => {\n      console.info('[] ...');\n\n      try {\n        await WorldbookLoader.initialize();\n        console.info('[]  ');\n      } catch (error) {\n        console.error('[]  :', error);\n        console.info('[]  : window.initWorldbookLoader()');\n      }\n    }, 2000);\n  });\n\n  // ==========  ==========\n  (window as typeof window & { initWorldbookLoader?: () => Promise<WorldbookStatus> }).initWorldbookLoader =\n    async function () {\n      console.info('[] ...');\n\n      if (WorldbookLoader.initialized) {\n        console.info('[] ');\n        return WorldbookLoader.getStatus();\n      }\n\n      try {\n        await WorldbookLoader.initialize();\n        console.info('[]  ');\n        return WorldbookLoader.getStatus();\n      } catch (error) {\n        console.error('[]  :', error);\n        throw error;\n      }\n    };\n\n  console.info('[]  ');\n  console.info('[]  : window.initWorldbookLoader()');\n}\n","/**\r\n *  - \r\n * NPC\r\n *\r\n * \r\n * 1.  (core.ts) - \r\n * 2.  (event_system.ts) - \r\n * 3. NPC (npc_system.ts) - NPC\r\n * 4.  (worldbook_loader.ts) - \r\n */\r\n\r\n// \r\nimport './core';\r\nimport './event_system';\r\nimport './npc_system';\r\nimport './worldbook_loader';\r\n\r\nconsole.info('[] ');\r\n"],"names":["console","info","EventEmitter","events","Map","on","event","callback","this","has","set","get","push","off","callbacks","index","indexOf","splice","emit","data","forEach","cb","error","once","wrapper","cacheStore","cacheCleanupTimer","bootstrapDetentionSystem","system","version","initialized","modules","config","tokenBudget","fallbackBudget","compressionQuality","cacheExpiry","healthCheckInterval","healthCheckTimeout","state","mode","tokenUsed","lastHealthCheck","errors","CacheManager","key","value","ttl","expiry","Date","now","item","delete","clear","cleanup","entries","ping","checkTokenBudget","total","used","percentage","status","toFixed","remaining","updateTokenUsage","tokens","budget","warn","compressContent","content","quality","text","JSON","stringify","actualQuality","compressed","replace","trim","originalSize","length","compressedSize","ratio","registerModule","name","module","getModule","handleError","context","normalized","Error","normalizeError","errorInfo","message","timestamp","stack","shift","detectEnvironment","env","isSillyTavern","hasHelper","helperVersion","hasDataTable","SillyTavern","$","getTavernVersion","getTavernHelperVersion","windowWithTable","window","insertRow","updateRow","initialize","detentionSystem","setInterval","ensureCacheCleanup","setTimeout","clearInterval","undefined","fetch","method","headers","body","location","hasDetentionSystem","detentionSystemType","sessionId","runId","hypothesisId","catch","DS","hasEvents","moduleCount","Object","keys","EventSystem","currentDay","lastEventDay","eventHistory","legalTimeline","arrestDay","approvalDay","prosecutionDay","firstTrialDay","firstVerdictDay","secondTrialDay","finalVerdictDay","transferDay","executionDay","currentStage","cellType","caseComplexity","complexityMultiplier","eventCounters","interrogation","lawyerVisit","familyVisit","medicalVisit","sceneIdentification","isDeathPenalty","lastStageChangeDay","PRIORITY","LEGAL","CONDITION","RANDOM","DAILY","legalEvents","approval","minDay","maxDay","stage","description","nextStage","investigation","duration","prosecution","firstTrial","firstVerdict","appeal","secondTrial","finalVerdict","transfer","deathReview","execution","conditionEvents","id","condition","mental","weight","checkAlways","health","_state","Math","random","stageChangeOnly","daysSinceApproval","baseProbability","finalProbability","pow","category","daysToTrial","daysToTrial2","lastVisit","filter","e","sort","a","b","day","probability","lastMedical","recentContext","getRecentContext","some","kw","includes","aiControlled","randomEvents","violence","medical","emotional","accident","innerMonologues","startDay","setCaseComplexity","complexity","validComplexities","simple","normal","complex","very_complex","multiplier","checkComplexityAdjustment","rollbackToStage","targetStage","reason","stageOrder","targetIndex","currentIndex","timelineKeys","trial1","trial2","i","type","from","to","handleUserRollback","input","rollbackPatterns","pattern","rule","match","advanceDay","days","dayEvent","checkDayEvents","prototype","hasOwnProperty","call","priority","interrupted","accumulatedEvents","legalEvent","checkLegalEvent","conditionEvent","checkConditionEvent","randomEvent","generateRandomEvent","monologue","generateInnerMonologue","daysInCustody","stageBefore","minDays","floor","maxDays","daysSinceProsecution","daysSinceTrial","daysSinceAppeal","daysSinceVerdict","isEnding","endingType","getProtagonistState","types","eventType","weightedRandom","eventList","eventWeights","map","weights","m","count","totalWeight","reduce","sum","w","statusPanel","strength","intelligence","Array","isArray","chat","slice","mes","join","checkCellTransfer","setDeathPenalty","getCurrentStageInfo","timeline","getEventStatistics","stats","totalEvents","byType","byPriority","recentEvents","exportTimeline","importTimeline","Boolean","_context","getCurrentStage","hasData","dataType","textLength","substring","String","windowKeys","k","NameGenerator","surnames","tier1","names","tier2","tier3","tier4","tier5","givenNames","vintage","single","double","classic","modern","contemporary","badNames","badChars","generate","birthYear","attempts","fullName","selectSurname","selectGivenName","isValidName","tiers","values","tier","age","getFullYear","style","styleData","pair","char","CrimeGenerator","characterBookCrimes","crimes","violent","sentenceRange","property","drug","economic","social","other","crime","findCategoryByCrime","sentence","generateSentence","categories","cat","crimeName","range","min","max","NPCGenerator","npcDatabase","currentCellNPCs","npcs","npc","generateSingle","eventSystem","stageInfo","generateAge","crimeData","appearance","generateAppearance","personality","generatePersonality","background","generateBackground","relationship","generateRelationship","adjustByCellType","generateId","gender","createdAt","heights","hairStyles","skinTones","features","height","hair","eyes","skin","traits","aggression","sociability","dominance","kindness","tags","_crimeData","educations","educationIndex","maritalStatuses","maritalWeights","maritalIndex","hasChildren","childrenCount","education","maritalStatus","hometown","generateHometown","priorConvictions","provinces","toProtagonist","faction","allies","enemies","influence","toString","generateForEvent","generatePolice","generateLawyer","generateFamily","generateDoctor","police","witnesses","ranks","rank","role","attitude","isFemale","typeIndex","experience","successRate","relationships","relation","supportLevel","specialties","specialty","getCurrentCellNPCs","setCurrentCellNPCs","addNPCToCell","removeNPCFromCell","npcId","findIndex","n","findNPCById","find","updateRelationship","delta","npcName","exportData","database","currentCell","importData","clearData","generateNPC","generateNPCForEvent","findNPC","updateNPCRelationship","exportNPCData","importNPCData","eventId","newCellType","npcCount","newNPCs","WORLDBOOKS","detention_rules","displayName","keywords","autoLoad","position","depth","fallbackEntries","internal_basic_procedures","internal_basic_legal","legal_knowledge","environment_descriptions","narrative_enhancements","characterId","WorldbookLoader","loaded","loading","fallbackMode","characterWorldbookId","findCharacterWorldbook","charWorldbooks","getCharWorldbookNames","primary","additional","loadWorldbook","bookName","loadPromise","_loadWorldbookInternal","result","allWorldbookNames","getWorldbookNames","targetDisplayName","targetName","targetWorldbookName","exactDisplayMatch","fuzzyMatch","availableBooks","availableCount","availableNames","getWorldbook","rebindCharWorldbooks","fallback","loadedAt","errorMessage","predictiveCache","predictions","matchScore","weightedScore","keyword","descKeywords","descKw","finalScore","score","abs","toLoad","p","pred","getRelevantEntries","maxEntries","allEntries","bookData","entry","bookDisplayName","scoredEntries","contentMatch","constant","aPriority","relevant","dynamicLoad","userInput","triggers","matchCount","bestKeyword","maxKeywordLength","trigger","getStatus","characterWorldbook","available","toLocaleTimeString","_promise","unloadWorldbook","newAdditional","reloadWorldbook","alreadyInitialized","retries","availableWorldbooks","Promise","resolve","isAvailable","autoLoadBooks","err","table","loadedCount","loadingCount","fallbackBooks","shutdown","getWorldbookStatus","eventData","textPreview","async","initWorldbookLoader"],"ignoreList":[],"sourceRoot":""}