console.info('[æ ¸å¿ƒç³»ç»Ÿ] å¼€å§‹åŠ è½½...');class e{events=new Map;on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}off(e,t){const n=this.events.get(e);if(!n)return;const o=n.indexOf(t);o>-1&&n.splice(o,1)}emit(e,t){const n=this.events.get(e);n&&n.forEach(n=>{try{n(t)}catch(t){console.error(`[äº‹ä»¶ç³»ç»Ÿ] äº‹ä»¶ ${e} å›è°ƒé”™è¯¯:`,t)}})}once(e,t){const n=o=>{t(o),this.off(e,n)};this.on(e,n)}}const t=new Map;let n;function o(){console.log('[DEBUG-HYP-D] core.ts:172 - bootstrapDetentionSystem å‡½æ•°å¼€å§‹æ‰§è¡Œ',{timestamp:Date.now(),location:'core.ts:172',hypothesisId:'D'});const n=new e,o={set(e,n,o){const i=o?Date.now()+1e3*o:null;t.set(e,{value:n,expiry:i})},get(e){const n=t.get(e);return n?null!==n.expiry&&Date.now()>n.expiry?(t.delete(e),null):n.value:null},has(e){return null!==this.get(e)},delete(e){t.delete(e)},clear(){t.clear()},cleanup(){const e=Date.now();for(const[n,o]of t.entries())null!==o.expiry&&e>o.expiry&&t.delete(n)}};console.log('[DEBUG-HYP-D] core.ts:175 - EventEmitter å’Œ CacheManager å·²åˆ›å»º',{timestamp:Date.now(),eventsType:typeof n,cacheManagerType:'object',location:'core.ts:175',hypothesisId:'D'});const i={version:'3.2.0',initialized:!1,modules:{},config:{tokenBudget:1e5,fallbackBudget:4e4,compressionQuality:.8,cacheExpiry:6e5,healthCheckInterval:500,healthCheckTimeout:3e3},state:{mode:'detecting',tokenUsed:0,lastHealthCheck:0,errors:[]},events:n,CacheManager:o,EventEmitter:e,ping:()=>(i.state.lastHealthCheck=Date.now(),!0),checkTokenBudget(){const e='external'===i.state.mode?i.config.tokenBudget:i.config.fallbackBudget,t=i.state.tokenUsed,n=t/e*100,o=n>95?'critical':n>85?'warning':'normal';return{used:t,total:e,percentage:n.toFixed(2),remaining:e-t,status:o}},updateTokenUsage(e){i.state.tokenUsed+=e;const t=i.checkTokenBudget();return'warning'===t.status?(console.warn(`[Tokené¢„ç®—] è­¦å‘Š: å·²ä½¿ç”¨ ${t.percentage}%`),i.events.emit('token_warning',t)):'critical'===t.status&&(console.error(`[Tokené¢„ç®—] ä¸¥é‡: å·²ä½¿ç”¨ ${t.percentage}%`),i.events.emit('token_critical',t)),t},compressContent(e,t=null){const n='string'==typeof e?e:JSON.stringify(e),o=t??i.config.compressionQuality;let a=n.replace(/\s+/g,' ').replace(/\n\s*\n/g,'\n').trim();o<.9&&(a=a.replace(/ï¼Œ/g,',').replace(/ã€‚/g,'.').replace(/ï¼›/g,';').replace(/ï¼š/g,':'));const s=n.length,r=a.length,l=(100*(1-r/s)).toFixed(2);return console.info(`[å†…å®¹å‹ç¼©] åŸå§‹: ${s} -> å‹ç¼©: ${r} (èŠ‚çœ ${l}%)`),a},registerModule(e,t){i.modules[e]&&console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] æ¨¡å— ${e} å·²å­˜åœ¨ï¼Œå°†è¢«è¦†ç›–`),i.modules[e]=t,console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æ¨¡å— ${e} å·²æ³¨å†Œ`),i.events.emit('module_registered',{name:e,module:t});try{window.parent&&window.parent!==window&&(window.parent.detentionSystem=i,window.parent.DS=i)}catch(e){}},getModule:e=>i.modules[e],handleError(e,t='unknown'){const n=function(e){return e instanceof Error?e:new Error('string'==typeof e?e:JSON.stringify(e))}(e),o={message:n.message,context:t,timestamp:Date.now(),stack:n.stack};i.state.errors.push(o),console.error(`[æ ¸å¿ƒç³»ç»Ÿ] é”™è¯¯ [${t}]:`,n),i.events.emit('error',o),i.state.errors.length>100&&i.state.errors.shift()},detectEnvironment(){const e={isSillyTavern:!1,version:null,hasHelper:!1,helperVersion:null,hasDataTable:!1};('undefined'!=typeof SillyTavern||$('#send_textarea').length>0)&&(e.isSillyTavern=!0,'function'==typeof getTavernVersion&&(e.version=getTavernVersion()??null)),'function'==typeof getTavernHelperVersion&&(e.hasHelper=!0,e.helperVersion=getTavernHelperVersion()??null);const t=window;return'function'==typeof t.insertRow&&'function'==typeof t.updateRow&&(e.hasDataTable=!0),e},initialize(){if(i.initialized)return void console.warn('[æ ¸å¿ƒç³»ç»Ÿ] å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡');console.info('[æ ¸å¿ƒç³»ç»Ÿ] å¼€å§‹åˆå§‹åŒ–...');const e=i.detectEnvironment();console.info('[æ ¸å¿ƒç³»ç»Ÿ] ç¯å¢ƒæ£€æµ‹:',e),e.isSillyTavern||console.warn('[æ ¸å¿ƒç³»ç»Ÿ] æœªæ£€æµ‹åˆ°SillyTavernç¯å¢ƒ'),i.state.mode='external',i.initialized=!0,console.info('[æ ¸å¿ƒç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆ'),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] ç‰ˆæœ¬: ${i.version}`),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æ¨¡å¼: ${i.state.mode}`),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] Tokené¢„ç®—: ${i.config.tokenBudget}`),i.events.emit('initialized',{env:e,state:i.state})},initializeState(e){if(!e)return void console.warn('[æ ¸å¿ƒç³»ç»Ÿ] initializeState è¢«è°ƒç”¨ä½†æ²¡æœ‰æä¾›çŠ¶æ€æ•°æ®');console.info('[æ ¸å¿ƒç³»ç»Ÿ] åˆå§‹åŒ–ä¸»è§’çŠ¶æ€:',e),i.events.emit('stateChanged',e);i.getModule('statusPanel')?console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ çŠ¶æ€æ æ¨¡å—å·²æ‰¾åˆ°ï¼Œå·²é€šè¿‡äº‹ä»¶é€šçŸ¥çŠ¶æ€æ›´æ–°'):console.warn('[æ ¸å¿ƒç³»ç»Ÿ] âš  çŠ¶æ€æ æ¨¡å—æœªæ‰¾åˆ°ï¼ŒçŠ¶æ€å°†é€šè¿‡äº‹ä»¶åœ¨æ¨¡å—æ³¨å†Œåæ›´æ–°')}};return console.log('[DEBUG-HYP-D] core.ts:365 - bootstrapDetentionSystem å‡†å¤‡è¿”å› system å¯¹è±¡',{timestamp:Date.now(),systemType:typeof i,systemExists:!!i,hasVersion:'version'in i,hasModules:'modules'in i,hasEvents:'events'in i,systemVersion:i.version,location:'core.ts:365',hypothesisId:'D'}),i}if(console.log('[DEBUG-HYP-B] core.ts:363 - å‡†å¤‡åˆ›å»ºæ ¸å¿ƒç³»ç»Ÿ',{timestamp:Date.now(),windowExists:'undefined'!=typeof window,windowDetentionSystemExists:void 0!==window.detentionSystem,location:'core.ts:363',hypothesisId:'B'}),window.detentionSystem)console.log('[DEBUG-HYP-E] core.ts:364 - window.detentionSystem å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º',{timestamp:Date.now(),existingType:typeof window.detentionSystem,location:'core.ts:364',hypothesisId:'E'});else{try{'undefined'!=typeof window&&window.location&&('localhost'===window.location.hostname||'127.0.0.1'===window.location.hostname||window.location.hostname.startsWith('192.168.')||window.location.hostname.startsWith('10.')||window.location.hostname.startsWith('172.'))}catch(e){}try{window.detentionSystem=o(),window.DS=window.detentionSystem,console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²å°† DS æš´éœ²åˆ°å…¨å±€ï¼ˆä½œä¸º window.detentionSystem çš„åˆ«åï¼‰'),console.log('[DEBUG-HYP-D] core.ts:365 - bootstrapDetentionSystem æ‰§è¡Œå®Œæˆ',{timestamp:Date.now(),resultType:typeof window.detentionSystem,resultExists:!!window.detentionSystem,hasVersion:!(!window.detentionSystem||!('version'in window.detentionSystem)),location:'core.ts:365',hypothesisId:'D'}),console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ æ ¸å¿ƒç³»ç»Ÿå¯¹è±¡å·²åˆ›å»ºï¼ˆè„šæœ¬åŠ è½½æ—¶ï¼‰'),console.info('[æ ¸å¿ƒç³»ç»Ÿ] window.detentionSystem ç±»å‹:',typeof window.detentionSystem),console.info('[æ ¸å¿ƒç³»ç»Ÿ] window.detentionSystem å€¼:',window.detentionSystem),window.__DETENTION_SYSTEM_CORE_LOADED__=!0,window.__DETENTION_SYSTEM_VERSION__=window.detentionSystem.version;try{if(window.parent&&window.parent!==window){$(()=>{try{window.parent.detentionSystem=window.detentionSystem,window.parent.DS=window.detentionSystem,console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²å°†ç³»ç»Ÿæš´éœ²åˆ°ä¸»çª—å£ï¼ˆiframe æ¨¡å¼ï¼‰')}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] âš  æ— æ³•å°†ç³»ç»Ÿæš´éœ²åˆ°ä¸»çª—å£ï¼ˆå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶ï¼‰:',e)}});try{window.parent.detentionSystem=window.detentionSystem,window.parent.DS=window.detentionSystem,console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²ç«‹å³å°†ç³»ç»Ÿæš´éœ²åˆ°ä¸»çª—å£ï¼ˆiframe æ¨¡å¼ï¼Œç«‹å³æš´éœ²ï¼‰')}catch(e){console.debug('[æ ¸å¿ƒç³»ç»Ÿ] ç«‹å³æš´éœ²å¤±è´¥ï¼ˆå°†åœ¨ jQuery ready æ—¶é‡è¯•ï¼‰:',e)}}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] âš  iframe æ£€æµ‹å¤±è´¥:',e)}}catch(e){throw console.error('[DEBUG-HYP-D] core.ts:365 - bootstrapDetentionSystem æ‰§è¡Œå¤±è´¥',{timestamp:Date.now(),error:e instanceof Error?e.message:String(e),errorStack:e instanceof Error?e.stack:void 0,location:'core.ts:365',hypothesisId:'D'}),e}}console.log('[DEBUG-HYP-F] core.ts:371 - æ£€æŸ¥ jQuery æ˜¯å¦å¯ç”¨',{timestamp:Date.now(),jQueryExists:'undefined'!=typeof $,jQueryType:typeof $,location:'core.ts:371',hypothesisId:'F'}),$(()=>{console.log('[DEBUG-HYP-F] core.ts:371 - jQuery ready å›è°ƒæ‰§è¡Œ',{timestamp:Date.now(),windowDetentionSystemExists:void 0!==window.detentionSystem,location:'core.ts:371',hypothesisId:'F'}),console.info('[æ ¸å¿ƒç³»ç»Ÿ] é…’é¦†é¡µé¢å·²åŠ è½½ï¼ˆjQuery readyï¼‰'),window.detentionSystem?console.log('[DEBUG-HYP-E] core.ts:375 - jQuery ready æ—¶æ ¸å¿ƒç³»ç»Ÿå·²å­˜åœ¨',{timestamp:Date.now(),systemType:typeof window.detentionSystem,systemVersion:window.detentionSystem?.version,location:'core.ts:375',hypothesisId:'E'}):(console.warn('[DEBUG-HYP-E] core.ts:375 - åœ¨ jQuery ready æ—¶æœªæ‰¾åˆ°æ ¸å¿ƒç³»ç»Ÿï¼Œé‡æ–°åˆ›å»º',{timestamp:Date.now(),location:'core.ts:375',hypothesisId:'E'}),console.warn('[æ ¸å¿ƒç³»ç»Ÿ] è­¦å‘Šï¼šåœ¨ jQuery ready æ—¶æœªæ‰¾åˆ°æ ¸å¿ƒç³»ç»Ÿï¼Œé‡æ–°åˆ›å»º'),window.detentionSystem=o(),window.DS||(window.DS=window.detentionSystem,console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²å°† DS æš´éœ²åˆ°å…¨å±€ï¼ˆä½œä¸º window.detentionSystem çš„åˆ«åï¼‰')),console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ ¸å¿ƒç³»ç»Ÿå¯¹è±¡å·²åˆ›å»ºï¼ˆjQuery ready æ—¶ï¼‰'));const e=window.detentionSystem;window.DS||(window.DS=e,console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²å°† DS æš´éœ²åˆ°å…¨å±€ï¼ˆä½œä¸º window.detentionSystem çš„åˆ«åï¼‰')),console.info('[æ ¸å¿ƒç³»ç»Ÿ] å½“å‰æ ¸å¿ƒç³»ç»ŸçŠ¶æ€:',{exists:!!e,version:e.version,initialized:e.initialized}),function(e){n||(n=setInterval(()=>e.CacheManager.cleanup(),6e4))}(e),console.info('[æ ¸å¿ƒç³»ç»Ÿ] å‡†å¤‡åœ¨ 1 ç§’ååˆå§‹åŒ–...'),setTimeout(()=>{console.info('[æ ¸å¿ƒç³»ç»Ÿ] setTimeout å›è°ƒæ‰§è¡Œï¼Œå¼€å§‹åˆå§‹åŒ–...');try{e.initialize(),console.info('[æ ¸å¿ƒç³»ç»Ÿ] initialize() è°ƒç”¨å®Œæˆ');try{window.parent&&window.parent!==window&&e&&(window.parent.detentionSystem=e,window.parent.DS=e,console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ åˆå§‹åŒ–å®Œæˆåå·²åŒæ­¥åˆ°ä¸»çª—å£'))}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] âš  åˆå§‹åŒ–åæš´éœ²åˆ°ä¸»çª—å£å¤±è´¥:',e)}!window.DS&&e&&(window.DS=e,console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ åˆå§‹åŒ–å®Œæˆåå·²å°† DS æš´éœ²åˆ°å…¨å±€'))}catch(t){console.error('[æ ¸å¿ƒç³»ç»Ÿ] initialize() è°ƒç”¨å‡ºé”™:',t),e.handleError(t,'initialize')}},1e3)}),$(window).on('pagehide',()=>{n&&(clearInterval(n),n=void 0)});let i=null;$(()=>{console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ­£åœ¨æ³¨å†Œæ¶ˆæ¯æ‹¦æˆªç›‘å¬å™¨...');const e=new Set;eventMakeFirst(tavern_events.USER_MESSAGE_RENDERED,async t=>{try{const n=getChatMessages(t,{role:'user'})[0];if(!n||!n.message)return;const o=n.message,i=n.data,a=!0===i?.isSystemEventMessage,r=o.startsWith('[ç³»ç»Ÿäº‹ä»¶]')||o.startsWith('[ç¬¬')&&o.includes(']');if(a||r){if(s)try{await stopAllGeneration()}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] åœ¨USER_MESSAGE_RENDEREDä¸­åœæ­¢ç”Ÿæˆå¤±è´¥:',e)}return}const l=/(?:è·³è¿‡|æ¨è¿›|å¿«é€Ÿæ¨è¿›|å¿«è¿›)\s*(\d+|å[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|[äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]å[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|ç™¾[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?å?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|åƒ[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?ç™¾?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?å?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|ä¸‡)\s*å¤©[ã€‚ï¼Œï¼ï¼Ÿ\s]*/;if(o.match(l))try{await setChatMessages([{message_id:t,is_hidden:!0,message:'.'}],{refresh:'all'}),e.add(t),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²åœ¨USER_MESSAGE_RENDEREDä¸­éšè—è·³è¿‡å¤©æ•°æŒ‡ä»¤æ¶ˆæ¯ (message_id: ${t})`)}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] åœ¨USER_MESSAGE_RENDEREDä¸­éšè—æ¶ˆæ¯å¤±è´¥:',e)}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] USER_MESSAGE_RENDEREDå¤„ç†å¤±è´¥:',e)}}),eventOn(tavern_events.GENERATE_BEFORE_COMBINE_PROMPTS,()=>{e.size>0&&e.clear();try{const e=getChatMessages(-1,{role:'user'}),t=e[e.length-1];if(t){t.data;const e=t.message||'';e.startsWith('[ç³»ç»Ÿäº‹ä»¶]')||e.startsWith('[ç¬¬')&&e.includes(']')}}catch(e){}});let t=null,n=null;const o=[];eventOn(iframe_events.GENERATION_STARTED,e=>{const a=Date.now();if(o.push({generation_id:e,type:'iframe',timestamp:a,triggerTime:t,eventName:n,source:'iframe'}),null!==i)return console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âš  æ£€æµ‹åˆ°æ­£åœ¨ç”Ÿæˆè·³è¿‡æŒ‡ä»¤æ¶ˆæ¯ï¼Œç«‹å³åœæ­¢ç”Ÿæˆ (generation_id: ${e})`),void stopGenerationById(e).then(t=>{t?console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âœ“ æˆåŠŸåœæ­¢ç”Ÿæˆ (generation_id: ${e})`):console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] åœæ­¢ç”Ÿæˆå¤±è´¥ (generation_id: ${e})`),i=null});try{const t=getChatMessages(-1,{role:'user'}),n=t[t.length-1];if(n){const t=n.data,o=!0===t?.isSystemEventMessage,i=n.message||'',a=i.startsWith('[ç³»ç»Ÿäº‹ä»¶]')||i.startsWith('[ç¬¬')&&i.includes(']');s&&(o||a)&&(console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  æ£€æµ‹åˆ°æ­£åœ¨ç”Ÿæˆç³»ç»Ÿäº‹ä»¶æ¶ˆæ¯ï¼ˆå¯èƒ½ç”±å…¶ä»–ç›‘å¬å™¨è§¦å‘ï¼‰ï¼Œç«‹å³åœæ­¢ç”Ÿæˆ (generation_id: ${e})`),stopGenerationById(e).then(t=>{t?console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âœ“ æˆåŠŸåœæ­¢ç³»ç»Ÿäº‹ä»¶æ¶ˆæ¯çš„è‡ªåŠ¨ç”Ÿæˆ (generation_id: ${e})`):console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] åœæ­¢ç³»ç»Ÿäº‹ä»¶æ¶ˆæ¯çš„è‡ªåŠ¨ç”Ÿæˆå¤±è´¥ (generation_id: ${e})`)}))}}catch(e){}}),eventOn(tavern_events.GENERATION_STARTED,(e,i,a)=>{const s=Date.now();o.push({generation_id:null,type:e,timestamp:s,triggerTime:t,eventName:n,source:'tavern'})});const a=[];eventMakeFirst(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>{try{const o=getChatMessages(e,{role:'assistant'})[0];if(o&&o.message){const i=Date.now(),s=o.message;if(a.some(t=>t.message_id===e))return void console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  CHARACTER_MESSAGE_RENDERED äº‹ä»¶é‡å¤è§¦å‘ï¼Œmessage_id: ${e}`);a.push({message_id:e,timestamp:i,triggerTime:t,eventName:n,messageLength:s.length,messagePreview:s.substring(0,100)});const r=a.filter(e=>e.triggerTime===t&&e.eventName===n);if(r.length>1){const e=r.sort((e,t)=>e.timestamp-t.timestamp).map((e,t,n)=>t>0?e.timestamp-n[t-1].timestamp:0).filter(e=>e>0);console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  æ£€æµ‹åˆ°å¯èƒ½çš„æ¶ˆæ¯åˆ†å‰²ï¼šäº‹ä»¶ "${n}" è§¦å‘çš„ç”Ÿæˆäº§ç”Ÿäº† ${r.length} æ¡æ¶ˆæ¯`,{messageIds:r.map(e=>e.message_id),lengths:r.map(e=>e.messageLength),timeGaps:e,totalLength:r.reduce((e,t)=>e+t.messageLength,0)})}const l=a.filter(t=>t.message_id!==e&&Math.abs(t.timestamp-i)<3e3);l.length>0&&console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æ£€æµ‹åˆ°é™„è¿‘æœ‰ ${l.length} æ¡å…¶ä»–æ¶ˆæ¯ï¼ˆ3ç§’å†…ï¼‰`,l.map(e=>({id:e.message_id,timeDiff:Math.abs(e.timestamp-i)})))}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] CHARACTER_MESSAGE_RENDERED è¿½è¸ªå¤±è´¥:',e)}}),eventOn(tavern_events.MESSAGE_SENT,async t=>{try{if(console.info(`[æ ¸å¿ƒç³»ç»Ÿ] ğŸ“¨ MESSAGE_SENT äº‹ä»¶è§¦å‘ï¼Œmessage_id: ${t}`),s){const e=getChatMessages(-1,{role:'user'}).find(e=>e.message_id===Number(t));if(e){const t=e.data,n=!0===t?.isSystemEventMessage,o=e.message||'',i=o.startsWith('[ç³»ç»Ÿäº‹ä»¶]')||o.startsWith('[ç¬¬')&&o.includes(']');if(n||i)return}}const n=getChatMessages(-1,{role:'user'}).find(e=>e.message_id===Number(t));if(n&&n.message){const o=n.message;console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ£€æµ‹åˆ°ç”¨æˆ·è¾“å…¥:',o.substring(0,50)+'...');const a=n.data;if(!0===a?.isSystemEventMessage||o.startsWith('[ç³»ç»Ÿäº‹ä»¶]')||o.startsWith('[ç¬¬')&&o.includes(']'))return;const s=/(?:ç”Ÿæˆ|åˆ›å»º|éšæœºç”Ÿæˆ|éšæœºåˆ›å»º)\s*(\d+)?\s*(?:å|ä¸ª)?\s*(?:ä¸»è§’|è§’è‰²|äººç‰©)/;if(o.match(s)){console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ£€æµ‹åˆ°ç”Ÿæˆä¸»è§’æŒ‡ä»¤:',o);try{const e=window.detentionSystem,t=e?.getModule('npcSystem');if(t&&t.generateProtagonist){const e={};(o.includes('ç»æµçŠ¯ç½ª')||o.includes('ç»æµ'))&&(e.crimeType='economic'),(o.includes('å­¦æœ¯è…è´¥')||o.includes('ä¸å¾—æ˜¯å­¦æœ¯è…è´¥')||o.includes('éå­¦æœ¯è…è´¥'))&&(e.excludeCrimes=['å­¦æœ¯è…è´¥']),(o.includes('é«˜çº§çŸ¥è¯†åˆ†å­')||o.includes('çŸ¥è¯†åˆ†å­'))&&(e.background={...e.background,isIntellectual:!0}),(o.includes('éå­¦æœ¯')||o.includes('ä¸å¾—æ˜¯å­¦æœ¯'))&&(e.background={...e.background,isAcademic:!1}),(o.includes('å•†ä¸š')||o.includes('ä¼ä¸š'))&&(e.background={...e.background,isBusiness:!0}),(o.includes('35')||o.includes('45'))&&(e.ageRange=[35,45]),(o.includes('é«˜å­¦å†')||o.includes('æœ¬ç§‘')||o.includes('ç ”ç©¶ç”Ÿ'))&&(e.education='high');const n=t.generateProtagonist(e);if(n&&n.name){if(SillyTavern.getCurrentChatId()){const e={name:n.name,age:n.age||30,crime:n.crime||'ç»æµçŠ¯ç½ª',appearance:n.appearance||{height:168,weight:58,hair:'é»‘è‰²é•¿å‘',skin:'ç™½çš™',features:'æ°”è´¨ä¼˜é›…'},background:n.background||{},personality:n.personality||{}};replaceVariables({protagonist:e,protagonist_name:n.name,protagonist_age:n.age||30,protagonist_crime:n.crime||'ç»æµçŠ¯ç½ª'},{type:'chat'}),console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ ä¸»è§’å·²ç”Ÿæˆå¹¶ä¿å­˜:',n.name,n.age,n.crime)}}else console.warn('[æ ¸å¿ƒç³»ç»Ÿ] generateProtagonistè¿”å›ç©ºæ•°æ®')}else console.warn('[æ ¸å¿ƒç³»ç»Ÿ] NPCç³»ç»Ÿæˆ–generateProtagonistä¸å¯ç”¨')}catch(e){console.error('[æ ¸å¿ƒç³»ç»Ÿ] ç”Ÿæˆä¸»è§’å¤±è´¥:',e)}}const r=/(?:è·³è¿‡|æ¨è¿›|å¿«é€Ÿæ¨è¿›|å¿«è¿›)\s*(\d+|å[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|[äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]å[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|ç™¾[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?å?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|åƒ[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?ç™¾?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?å?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|ä¸‡)\s*å¤©[ã€‚ï¼Œï¼ï¼Ÿ\s]*/,l=o.match(r),c=window.detentionSystem;if(c&&c.initialized){if(c.getModule('eventSystem')&&c.advanceDay){let n=0;if(l&&(n=(e=>{const t=parseInt(e,10);if(!isNaN(t))return t;const n={é›¶:0,ä¸€:1,äºŒ:2,ä¸‰:3,å››:4,äº”:5,å…­:6,ä¸ƒ:7,å…«:8,ä¹:9,å:10,ç™¾:100,åƒ:1e3,ä¸‡:1e4};if(e in n)return n[e];let o=0;if(e.startsWith('å')){o=10;const t=e.slice(1);t in n&&(o+=n[t])}else if(e.endsWith('å')){const t=e.slice(0,-1);t in n&&(o=10*n[t])}else{const t=e.indexOf('å');if(t>-1){const i=e.slice(0,t),a=e.slice(t+1);o=10*((i in n?n[i]:0)||1)+(a in n?n[a]:0)}}return o>0?o:0})(l[1]),n>0&&console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æ£€æµ‹åˆ°è·³è¿‡/æ¨è¿›å¤©æ•°æŒ‡ä»¤: ${l[0].trim()} (${n}å¤©)`)),n>0){if(e.has(Number(t)))return void console.debug(`[æ ¸å¿ƒç³»ç»Ÿ] è·³è¿‡æŒ‡ä»¤æ¶ˆæ¯ ${t} å·²å¤„ç†ï¼Œè·³è¿‡é‡å¤æ‰§è¡Œ`);i=Number(t);try{await stopAllGeneration(),console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²åœæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ç”Ÿæˆ');const e=()=>new Promise(e=>{let t=!1,n=null;const o=()=>{n&&(n.stop(),n=null)};n=eventOnce(tavern_events.GENERATION_ENDED,()=>{t||setTimeout(()=>{t||(t=!0,clearTimeout(i),o(),e())},800)});const i=setTimeout(()=>{t||(t=!0,o(),e())},2500);'undefined'!=typeof builtin&&builtin.duringGenerating&&builtin.duringGenerating()||t||(t=!0,clearTimeout(i),o(),e())});await e();let t=0;for(;'undefined'!=typeof builtin&&builtin.duringGenerating&&builtin.duringGenerating()&&t<5;)t++,console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  ç­‰å¾…åä»åœ¨ç”Ÿæˆï¼Œå†æ¬¡å¼ºåˆ¶åœæ­¢ (ç¬¬${t}æ¬¡)`),await stopAllGeneration(),await new Promise(e=>setTimeout(e,500))}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] åœæ­¢ç”Ÿæˆå¤±è´¥:',e)}const o=getChatMessages(Number(t),{role:'user'})[0];if(!0===o?.is_hidden||e.has(Number(t)))console.info(`[æ ¸å¿ƒç³»ç»Ÿ] è·³è¿‡æŒ‡ä»¤æ¶ˆæ¯å·²åœ¨USER_MESSAGE_RENDEREDä¸­è¢«éšè— (message_id: ${t})`);else try{await setChatMessages([{message_id:Number(t),is_hidden:!0,message:'.'}],{refresh:'all'}),e.add(Number(t)),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²åœ¨MESSAGE_SENTä¸­éšè—è·³è¿‡æŒ‡ä»¤æ¶ˆæ¯ (message_id: ${t})`)}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] éšè—æ¶ˆæ¯å¤±è´¥:',e)}try{const e=c.getModule('worldbook');e&&e.loadWorldbook&&(console.info('[æ ¸å¿ƒç³»ç»Ÿ] è·³è¿‡å¤©æ•°æ—¶å¼ºåˆ¶åŠ è½½ç¯å¢ƒæå†™åº“å’Œç”Ÿæ´»ç»†èŠ‚åº“'),Promise.all([e.loadWorldbook('environment_descriptions').catch(e=>{console.warn('[æ ¸å¿ƒç³»ç»Ÿ] åŠ è½½ç¯å¢ƒæå†™åº“å¤±è´¥:',e)}),e.loadWorldbook('internal_basic_procedures').catch(e=>{console.warn('[æ ¸å¿ƒç³»ç»Ÿ] åŠ è½½ç”Ÿæ´»ç»†èŠ‚åº“å¤±è´¥:',e)})]).catch(()=>{}))}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] å¼ºåˆ¶åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥:',e)}try{const e=c.advanceDay(n);if(e&&e.interrupted&&e.event){const t=e.event.day??e.tempCurrentDay??e.currentDay??0;console.info(`[æ ¸å¿ƒç³»ç»Ÿ] è·³è¿‡ ${n} å¤©åè§¦å‘äº‹ä»¶: ${e.event.name} (ç¬¬${t}å¤©)`)}else{if(void 0!==e.pendingDays&&e.pendingDays>0){const t=c.getModule('eventSystem');t&&t.confirmDayAdvancement&&t.confirmDayAdvancement(e.pendingDays)}const t=e.tempCurrentDay??e.currentDay??0;console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æˆåŠŸè·³è¿‡ ${n} å¤©ï¼Œå½“å‰ç¬¬ ${t} å¤©`);try{await createChatMessages([{role:'system',message:`[ç³»ç»Ÿ] å·²è·³è¿‡ ${n} å¤©ï¼Œå½“å‰ç¬¬ ${t} å¤©`,is_hidden:!0}])}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å¤±è´¥:',e)}}}catch(e){console.error('[æ ¸å¿ƒç³»ç»Ÿ] æ‰§è¡Œè·³è¿‡å¤©æ•°å¤±è´¥:',e)}return void(i=null)}}}const d=window.detentionSystem;d&&d.events&&d.events.emit('user_input',{text:o,message_id:t})}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶å¤±è´¥:',e)}});let s=!1;console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²æ³¨å†Œç”¨æˆ·è¾“å…¥å’Œå¤©æ•°è·³è¿‡äº‹ä»¶ç›‘å¬'),console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ MESSAGE_SENT ç›‘å¬å™¨å·²æ³¨å†Œï¼Œå¯ä»¥æ£€æµ‹"è·³è¿‡Xå¤©"æŒ‡ä»¤');const r=window.detentionSystem;r&&r.events&&(r.events.on('event_triggered',async e=>{try{const i=e;if(!i||!i.name)return;const l=i.priority??5;if(l>4)return void console.debug(`[æ ¸å¿ƒç³»ç»Ÿ] è·³è¿‡æ—¥å¸¸äº‹ä»¶ ${i.name} çš„AIè§¦å‘ï¼ˆä¼˜å…ˆçº§: ${l}ï¼‰`);s=!0,console.info(`[æ ¸å¿ƒç³»ç»Ÿ] æ£€æµ‹åˆ°é«˜ä¼˜å…ˆçº§äº‹ä»¶: ${i.name}ï¼Œå‡†å¤‡è§¦å‘AIç”Ÿæˆ`);const c=r.getModule('eventSystem'),d=i.day??c?.currentDay??0;let h='';const g=i.text||i.description||`${i.name}å‘ç”Ÿäº†`;let m='';const u=i.id||'';if(u&&['interrogation','lawyer_visit','family_visit','medical_visit','scene_identification','prosecutor_interrogation'].includes(u))try{if('function'==typeof r.generateNPCForEvent){const e=r.generateNPCForEvent(u);if(e&&'object'==typeof e)if('name'in e&&'string'==typeof e.name){const t=e;m=`\n\nã€ç›¸å…³NPCä¿¡æ¯ã€‘${'police'===t.role?`${t.name}ï¼ˆ${t.rank||'æ°‘è­¦'}ï¼‰`:'lawyer'===t.role?`${t.name}ï¼ˆ${t.type||'å¾‹å¸ˆ'}ï¼‰`:'family'===t.role?`${t.name}ï¼ˆ${t.relation||'å®¶å±'}ï¼‰`:'doctor'===t.role?`${t.name}ï¼ˆåŒ»ç”Ÿï¼‰`:t.name}ï¼ˆå·²ç”±NPCç³»ç»Ÿç”Ÿæˆï¼Œè¯·ä½¿ç”¨æ­¤åå­—ï¼Œä¸è¦è‡ªè¡Œç”Ÿæˆå…¶ä»–åå­—ï¼‰ã€‚`}else if('police'in e&&'witnesses'in e){const t=e,n=`${t.police.name}ï¼ˆ${t.police.rank||'æ°‘è­¦'}ï¼‰`;m=`\n\nã€ç›¸å…³NPCä¿¡æ¯ã€‘è­¦å¯Ÿï¼š${n}ï¼›è¯äººï¼š${t.witnesses.map(e=>e.name).join('ã€')}ï¼ˆå·²ç”±NPCç³»ç»Ÿç”Ÿæˆï¼Œè¯·ä½¿ç”¨è¿™äº›åå­—ï¼Œä¸è¦è‡ªè¡Œç”Ÿæˆå…¶ä»–åå­—ï¼‰ã€‚`}}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] ç”Ÿæˆäº‹ä»¶NPCå¤±è´¥:',e)}if('cell_transfer'===u)try{const e=r.getModule('eventSystem'),t=i.to||e?.cellType||'pretrial';if('function'==typeof r.generateNPC&&'function'==typeof r.setCurrentCellNPCs){const e=Math.floor(5*Math.random())+3,n=r.generateNPC(e,{cellType:t});if(Array.isArray(n)&&n.length>0){r.setCurrentCellNPCs(n),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²ä¸ºç›‘å®¤è½¬ç§»ç”Ÿæˆ${n.length}ä¸ªæ–°NPC`);const e=n.reduce((e,t)=>(t.relationship?.influence??0)>(e.relationship?.influence??0)?t:e,n[0]),t=n.filter(t=>t!==e),o=e.name||'æœªçŸ¥';m=`\n\nã€ç›‘å®¤NPCä¿¡æ¯ã€‘æ–°ç›‘å®¤ç‰¢å¤´ï¼š${o}ï¼›å…¶ä»–ç‹±å‹ï¼š${t.map(e=>e.name).filter(Boolean).join('ã€')||'æš‚æ— '}ï¼ˆå·²ç”±NPCç³»ç»Ÿéšæœºç”Ÿæˆï¼Œè¯·ä½¿ç”¨è¿™äº›åå­—ï¼Œä¸è¦è‡ªè¡Œç”Ÿæˆå…¶ä»–åå­—ï¼‰ã€‚`}}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] ç”Ÿæˆç›‘å®¤è½¬ç§»NPCå¤±è´¥:',e)}const y=i.category;if(!m&&('random'===y||4===i.priority)&&'function'==typeof r.getCurrentCellNPCs)try{let e=r.getCurrentCellNPCs();if((!e||Array.isArray(e)&&0===e.length)&&d<=1&&(console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ£€æµ‹åˆ°åˆå§‹åœºæ™¯ï¼Œç”Ÿæˆåˆå§‹ç›‘å®¤NPC'),'function'==typeof r.generateNPC)){const t=r.getModule('eventSystem'),n=t?.cellType||'transition',o=Math.floor(5*Math.random())+3,i=r.generateNPC(o,{cellType:n});Array.isArray(i)&&i.length>0&&('function'==typeof r.setCurrentCellNPCs&&(r.setCurrentCellNPCs(i),console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²ç”Ÿæˆ${i.length}ä¸ªåˆå§‹ç›‘å®¤NPC`)),e=i)}if(Array.isArray(e)&&e.length>0){const t=e.sort(()=>Math.random()-.5).slice(0,Math.min(3,e.length)).map(e=>e.name).filter(Boolean).join('ã€');t&&(m=`\n\nã€ç›¸å…³NPCä¿¡æ¯ã€‘å‚ä¸äº‹ä»¶çš„ç‹±å‹ï¼š${t}ï¼ˆå·²ç”±NPCç³»ç»Ÿç”Ÿæˆï¼Œè¯·ä½¿ç”¨è¿™äº›åå­—ï¼Œä¸è¦è‡ªè¡Œç”Ÿæˆå…¶ä»–åå­—ï¼‰ã€‚`)}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] è·å–éšæœºäº‹ä»¶NPCå¤±è´¥:',e)}h=i.text?`[ç³»ç»Ÿäº‹ä»¶] ç¬¬${d}å¤©ï¼š${g}${m}`:`[ç³»ç»Ÿäº‹ä»¶] ç¬¬${d}å¤©ï¼š${g}ã€‚è¯·è¯¦ç»†æè¿°äº‹ä»¶çš„å‘å±•å’Œä¸»è§’çš„ååº”ã€‚${m}`,await stopAllGeneration(),await stopAllGeneration();const p=createChatMessages([{role:'user',message:h,is_hidden:!1,data:{isSystemEventMessage:!0,eventId:i.id,eventName:i.name}}],{refresh:'affected'});await p,await new Promise(e=>setTimeout(e,150)),await stopAllGeneration(),await new Promise(e=>setTimeout(e,200));const f=getLastMessageId();try{await stopAllGeneration();const e=()=>new Promise(e=>{let t=!1,n=null,o=null,i=!1;const a=()=>{n&&(n.stop(),n=null),o&&(o.stop(),o=null)};o=eventOn(tavern_events.GENERATION_STARTED,async(e,t,n)=>{0;Date.now();await stopAllGeneration()}),n=eventOnce(tavern_events.GENERATION_ENDED,()=>{t||(i=!0,setTimeout(()=>{t||(t=!0,clearTimeout(s),a(),e())},800))});const s=setTimeout(()=>{t||(t=!0,a(),e())},2500)});await e();const l=()=>new Promise(e=>{if('undefined'==typeof builtin||!builtin.duringGenerating||!builtin.duringGenerating())return void e();let t=null;const n=eventOnce(tavern_events.GENERATION_ENDED,()=>{t&&(clearTimeout(t),t=null),setTimeout(()=>{e()},500)});t=setTimeout(()=>{n.stop(),t=null,e()},1e4)});await l();let c=0;for(;'undefined'!=typeof builtin&&builtin.duringGenerating&&builtin.duringGenerating()&&c<3;)c++,console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  æ£€æµ‹åˆ°ä»åœ¨ç”Ÿæˆï¼Œå†æ¬¡å¼ºåˆ¶åœæ­¢ (ç¬¬${c}æ¬¡)ï¼Œäº‹ä»¶: ${i.name}`),await stopAllGeneration(),await new Promise(e=>setTimeout(e,500));'undefined'!=typeof builtin&&builtin.duringGenerating&&builtin.duringGenerating()&&console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  å¼ºåˆ¶åœæ­¢åä»åœ¨ç”Ÿæˆï¼Œä½†ç»§ç»­è§¦å‘AIç”Ÿæˆï¼Œäº‹ä»¶: ${i.name}`),await new Promise(e=>setTimeout(e,300));const d=i.name;i.id;t=Date.now(),n=i.name,o.length=0;let h=[],g=null;try{const e=getChatMessages(-1);h=e.map(e=>({message_id:e.message_id||0,role:e.role||'unknown',messageLength:(e.message||'').length}));const t=e.filter(e=>'assistant'===e.role);if(t.length>0){const e=t[t.length-1];g={message_id:e.message_id||0,message:e.message||'',messageLength:(e.message||'').length}}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] è·å– triggerSlash å‰çš„æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:',e)}const m=g?.message_id||null,u=g?.messageLength||0,y=g?.message?.substring(0,100)||'';null!==m&&(u<100||y.includes('<thinking>')||y.includes('...'));await triggerSlash('/trigger');Date.now();let p=[];try{await new Promise(e=>setTimeout(e,100));p=getChatMessages(-1).map(e=>({message_id:e.message_id||0,role:e.role||'unknown',messageLength:(e.message||'').length}))}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] è·å– triggerSlash åçš„æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:',e)}p.filter(e=>!h.some(t=>t.message_id===e.message_id));console.info(`[æ ¸å¿ƒç³»ç»Ÿ] âœ“ å·²è§¦å‘AIç”Ÿæˆï¼Œäº‹ä»¶: ${i.name}`);const w=eventOnce(tavern_events.GENERATION_ENDED,e=>{Date.now();s=!1,console.debug(`[æ ¸å¿ƒç³»ç»Ÿ] AIå“åº”äº‹ä»¶å®Œæˆï¼Œæ¸…é™¤ç­‰å¾…æ ‡å¿—: ${d}`);const o=a.filter(e=>e.triggerTime===t&&e.eventName===n),l=o.some(t=>t.message_id===e);let c=null,h=0;try{const t=getChatMessages(e,{role:'assistant'});t&&t.length>0&&t[0].message&&(c=t[0].message,h=c.length)}catch(e){}let g=null,m=0,u=null;try{const e=getChatMessages(5,{role:'assistant'});e&&e.length>0&&e[0].message&&(g=e[0].message,m=g.length,u=g.substring(0,300))}catch(e){}const y=g&&d&&g.includes(d),p=g&&(g.includes('[ç³»ç»Ÿäº‹ä»¶]')||g.includes('ç¬¬')&&g.includes('å¤©')),f=!c&&(y||p);let w=[];try{w=getChatMessages(-1,{role:'assistant'}).map(e=>({message_id:e.message_id||0,messageLength:(e.message||'').length})),w=w.map(e=>{const t=a.find(t=>t.message_id===e.message_id);return{...e,timestamp:t?.timestamp}})}catch(e){}if(f){const t=5;console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  æ£€æµ‹åˆ°æµå¼ç”Ÿæˆå°†å†…å®¹æ›´æ–°åˆ°äº†å·²å­˜åœ¨çš„ message_id ${t}ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çš„ message_id ${e}ã€‚å°†ä½¿ç”¨å®é™…çš„ message_id ${t} è¿›è¡Œå¤„ç†ã€‚`,{expectedMessageId:e,actualMessageId:t,message5Length:m,message5ContainsEventContent:y,message5ContainsSystemEvent:p,relatedMessagesCount:o.length})}else o.length>0&&!l?console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  æ£€æµ‹åˆ°æ¶ˆæ¯ ID ä¸åŒ¹é…ï¼šGENERATION_ENDED çš„ message_id (${e}) ä¸ CHARACTER_MESSAGE_RENDERED è¿½è¸ªçš„æ¶ˆæ¯ ID ä¸ä¸€è‡´`,{generationEndMessageId:e,trackedMessageIds:o.map(e=>e.message_id),allTrackedMessages:a.map(e=>({id:e.message_id,triggerTime:e.triggerTime,eventName:e.eventName,length:e.messageLength}))}):!f&&o.length>1&&console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  æ£€æµ‹åˆ°å¯èƒ½çš„æ¶ˆæ¯åˆ†å‰²ï¼šäº‹ä»¶ "${n}" è§¦å‘çš„ç”Ÿæˆäº§ç”Ÿäº† ${o.length} æ¡æ¶ˆæ¯`,{eventName:n,triggerTime:t,generationEndMessageId:e,relatedMessageIds:o.map(e=>e.message_id),totalLength:o.reduce((e,t)=>e+t.messageLength,0)});try{const e=r.getModule('eventSystem'),t=i;e&&void 0!==t.pendingDayAdvancement&&e.confirmDayAdvancement&&e.confirmDayAdvancement(t.pendingDayAdvancement),e&&e.saveStateToChatVars&&(e.saveStateToChatVars(),e.saveEventInterruptSnapshot&&e.saveEventInterruptSnapshot(),console.debug('[æ ¸å¿ƒç³»ç»Ÿ] å·²ä¿å­˜AIå›å¤ç»“æŸæ—¶çš„çŠ¶æ€å¿«ç…§'))}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] ä¿å­˜AIå›å¤ç»“æŸæ—¶çŠ¶æ€å¿«ç…§å¤±è´¥:',e)}}),v=eventOnce(tavern_events.GENERATION_STOPPED,()=>{try{const e=getChatMessages(f,{role:'user'});if(!e||0===e.length){const e=r.getModule('eventSystem');if(e&&e.rollbackToInterruptSnapshot){e.rollbackToInterruptSnapshot()&&console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ“ æ£€æµ‹åˆ°äº‹ä»¶æ¶ˆæ¯è¢«åˆ é™¤ï¼Œå·²å›é€€åˆ°äº‹ä»¶æ‰“æ–­æ—¶çš„çŠ¶æ€')}}}catch(e){console.warn('[æ ¸å¿ƒç³»ç»Ÿ] æ£€æŸ¥äº‹ä»¶æ¶ˆæ¯çŠ¶æ€å¤±è´¥:',e)}s=!1,w.stop()});setTimeout(()=>{s&&(s=!1,v.stop(),console.warn(`[æ ¸å¿ƒç³»ç»Ÿ] âš  äº‹ä»¶å“åº”ç­‰å¾…è¶…æ—¶ï¼ˆ30ç§’ï¼‰ï¼Œæ¸…é™¤ç­‰å¾…æ ‡å¿—: ${d}`))},3e4)}catch(e){console.error('[æ ¸å¿ƒç³»ç»Ÿ] âœ— è§¦å‘AIç”Ÿæˆå¤±è´¥:',e)}}catch(e){console.error('[æ ¸å¿ƒç³»ç»Ÿ] å¤„ç†äº‹ä»¶è§¦å‘AIç”Ÿæˆå¤±è´¥:',e)}}),console.info('[æ ¸å¿ƒç³»ç»Ÿ] å·²æ³¨å†Œäº‹ä»¶è§¦å‘AIç”Ÿæˆç›‘å¬'))}),console.info('[æ ¸å¿ƒç³»ç»Ÿ] è„šæœ¬åŠ è½½å®Œæˆ'),console.info('[æ ¸å¿ƒç³»ç»Ÿ] âœ¨ å®æ—¶ç›‘å¬æµ‹è¯• - ä¿®æ”¹æ—¶é—´: '+(new Date).toLocaleTimeString());const a={exists:void 0!==window.detentionSystem,type:typeof window.detentionSystem,value:window.detentionSystem?'object':'undefined',hasPing:window.detentionSystem&&'function'==typeof window.detentionSystem.ping,pingResult:window.detentionSystem&&'function'==typeof window.detentionSystem.ping?window.detentionSystem.ping():'N/A',hasInitializeState:window.detentionSystem&&'function'==typeof window.detentionSystem.initializeState,hasModules:window.detentionSystem&&'modules'in window.detentionSystem,modulesCount:window.detentionSystem&&'modules'in window.detentionSystem?Object.keys(window.detentionSystem.modules).length:0,isIframe:window.parent!==window,hasParent:!!window.parent,parentHasDetentionSystem:window.parent&&window.parent!==window?void 0!==window.parent.detentionSystem:'N/A',parentHasDS:window.parent&&window.parent!==window?void 0!==window.parent.DS:'N/A'};console.info('[æ ¸å¿ƒç³»ç»Ÿ] æ£€æŸ¥ window.detentionSystem:',a),console.info('[äº‹ä»¶ç³»ç»Ÿ] å¼€å§‹åŠ è½½...'),$(()=>{const e=window.detentionSystem;let t=null;if(!e)return console.error('[äº‹ä»¶ç³»ç»Ÿ] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½'),void console.error('[äº‹ä»¶ç³»ç»Ÿ] è¯·ç¡®ä¿ core.ts å·²æ­£ç¡®åŠ è½½');const n=e;function o(e=0){try{const t=n.getModule('statusPanel');if(t&&t.getState){const n=t.getState();if(n&&(void 0!==n.days||void 0!==n.day)){return n.days??n.day??e}}return e}catch(t){return console.warn('[äº‹ä»¶ç³»ç»Ÿ] ä»è®°å¿†å¢å¼ºæ’ä»¶è·å–å¤©æ•°å¤±è´¥:',t),e}}const i={currentDay:0,getCurrentDayInternal(){return o(this.currentDay)},lastEventDay:0,eventHistory:[],legalTimeline:{arrestDay:0,approvalDay:null,prosecutionDay:null,firstTrialDay:null,firstVerdictDay:null,secondTrialDay:null,finalVerdictDay:null,transferDay:null,executionDay:null},currentStage:'detention',cellType:'transition',caseComplexity:'normal',complexityMultiplier:1,eventCounters:{interrogation:0,prosecutor_interrogation:0,lawyer_visit:0,family_visit:0,medical_visit:0,scene_identification:0},isDeathPenalty:!1,lastStageChangeDay:0,assignedOfficers:{police:[],prosecutor:null},PRIORITY:{LEGAL:1,PROCEDURAL:2,CONDITION:3,RANDOM:4,DAILY:5},legalEvents:{approval:{name:'æ‰¹å‡†é€®æ•',minDay:30,maxDay:37,stage:'approval',description:'æ£€å¯Ÿé™¢æ‰¹å‡†é€®æ•å†³å®š',nextStage:'investigation'},investigation:{name:'ä¾¦æŸ¥ç¾æŠ¼',duration:[60,210],stage:'investigation',description:'å…¬å®‰æœºå…³ä¾¦æŸ¥é˜¶æ®µ',nextStage:'prosecution'},prosecution:{name:'å®¡æŸ¥èµ·è¯‰',duration:[30,45],stage:'prosecution',description:'æ£€å¯Ÿé™¢å®¡æŸ¥èµ·è¯‰',nextStage:'trial1'},firstTrial:{name:'ä¸€å®¡å¼€åº­',duration:[30,45],stage:'trial1',description:'æ³•é™¢ä¸€å®¡å®¡ç†',nextStage:'firstVerdict'},firstVerdict:{name:'ä¸€å®¡åˆ¤å†³',duration:[7,30],stage:'firstVerdict',description:'ä¸€å®¡åˆ¤å†³å®£å‘Š',nextStage:'appeal'},appeal:{name:'ä¸Šè¯‰æœŸ',duration:[10,10],stage:'appeal',description:'10å¤©ä¸Šè¯‰æœŸ',nextStage:'trial2'},secondTrial:{name:'äºŒå®¡å®¡ç†',duration:[60,90],stage:'trial2',description:'äºŒå®¡æ³•é™¢å®¡ç†',nextStage:'finalVerdict'},finalVerdict:{name:'ç»ˆå®¡åˆ¤å†³',duration:[7,14],stage:'finalVerdict',description:'äºŒå®¡åˆ¤å†³å®£å‘Š',nextStage:'transfer'},transfer:{name:'ç§»é€ç›‘ç‹±',duration:[30,90],stage:'transfer',description:'ç§»é€ç›‘ç‹±æ‰§è¡Œ',nextStage:'end'},deathReview:{name:'æ­»åˆ‘å¤æ ¸',duration:[180,720],stage:'deathReview',description:'æœ€é«˜æ³•é™¢æ­»åˆ‘å¤æ ¸',nextStage:'execution'},execution:{name:'æ‰§è¡Œæ­»åˆ‘',duration:[1,7],stage:'execution',description:'æ­»åˆ‘æ‰§è¡Œ',nextStage:'end'}},conditionEvents:[{id:'mental_breakdown',name:'ç²¾ç¥å´©æºƒ',condition:e=>e.mental<20,weight:100,description:'ç²¾ç¥çŠ¶æ€æåº¦æ¶åŒ–ï¼Œå‡ºç°è‡ªæ€å€¾å‘',checkAlways:!0},{id:'health_crisis',name:'å¥åº·å±æœº',condition:e=>e.health<30,weight:100,description:'å¥åº·çŠ¶å†µä¸¥é‡æ¶åŒ–ï¼Œéœ€è¦ç´§æ€¥åŒ»ç–—',checkAlways:!0},{id:'major_twist',name:'é‡å¤§è½¬æŠ˜',condition:(e,t)=>t.currentDay===t.lastStageChangeDay&&Math.random()<.15,weight:100,description:'æ¡ˆä»¶å‡ºç°é‡å¤§è½¬æŠ˜',stageChangeOnly:!0},{id:'evidence_reversal',name:'è¯æ®åè½¬',condition:(e,t)=>t.currentDay===t.lastStageChangeDay&&Math.random()<.1,weight:100,description:'æ–°è¯æ®å‡ºç°ï¼Œæ¡ˆæƒ…åè½¬',stageChangeOnly:!0},{id:'prosecutor_interrogation',name:'æ£€å¯Ÿå®˜æå®¡',condition:(e,t)=>{if(t.legalTimeline.arrestDay>0&&null===t.legalTimeline.approvalDay&&0===t.eventCounters.prosecutor_interrogation){const e=t.currentDay-t.legalTimeline.arrestDay,n=Math.floor(30*t.complexityMultiplier),o=Math.floor(37*t.complexityMultiplier);if(e>=n&&e<=o)return!0}return!1},weight:100,description:'æ£€å¯Ÿå®˜æå®¡è®¯é—®ï¼ˆæ£€å¯Ÿå®˜+2åè­¦å®˜ï¼‰',category:'procedural'},{id:'interrogation',name:'æå®¡',condition:(e,t)=>{if(t.currentDay<=10&&0===t.eventCounters.interrogation){const e=10-t.currentDay+1,n=1;if(e===n)return!0;const o=n/e;if(Math.random()<o)return!0}if('investigation'!==t.currentStage)return!1;const n=t.legalTimeline.approvalDay?t.currentDay-t.legalTimeline.approvalDay:0;let o=.15;o=n<30?.25:n<60?.15:.08;const i=o*Math.pow(.7,t.eventCounters.interrogation);return Math.random()<i},weight:100,description:'å…¬å®‰æœºå…³æå®¡è®¯é—®',category:'procedural'},{id:'lawyer_visit',name:'å¾‹å¸ˆä¼šè§',condition:(e,t)=>{if('transition'===t.cellType)return!1;if(!t.eventCounters.interrogation||0===t.eventCounters.interrogation)return!1;let n=.03;if(t.currentDay-t.legalTimeline.arrestDay<=14&&(n=.15),t.legalTimeline.firstTrialDay){const e=t.legalTimeline.firstTrialDay-t.currentDay;e>0&&e<=7&&(n=.3)}if(t.legalTimeline.secondTrialDay){const e=t.legalTimeline.secondTrialDay-t.currentDay;e>0&&e<=7&&(n=.25)}return Math.random()<n},weight:90,description:'å¾‹å¸ˆå‰æ¥ä¼šè§',category:'procedural'},{id:'family_visit',name:'å®¶å±æ¢è§†',condition:(e,t)=>{if(!t.legalTimeline.firstVerdictDay)return!1;let n=.05;t.isDeathPenalty&&(n=.1);const o=t.eventHistory.filter(e=>'family_visit'===e.id).sort((e,t)=>(t.day??0)-(e.day??0))[0];return!(o&&t.currentDay-(o.day??0)<30)&&Math.random()<n},weight:85,description:'å®¶å±å‰æ¥æ¢è§†',category:'procedural'},{id:'medical_visit',name:'å¤–å‡ºå°±åŒ»',condition:(e,t)=>{if(e.health>=25)return!1;let n=0;n=e.health<10?.4:e.health<15?.25:e.health<20?.15:.08;const o=t.eventHistory.filter(e=>'medical_visit'===e.id).sort((e,t)=>(t.day??0)-(e.day??0))[0];return!(o&&t.currentDay-(o.day??0)<7)&&Math.random()<n},weight:95,description:'å¥åº·çŠ¶å†µä¸¥é‡ï¼Œéœ€å¤–å‡ºå°±åŒ»',category:'procedural'},{id:'scene_identification',name:'æŒ‡è®¤ç°åœº',condition:(e,t)=>{if('investigation'!==t.currentStage)return!1;if(t.eventCounters.scene_identification>0)return!1;const n=t.legalTimeline.approvalDay?t.currentDay-t.legalTimeline.approvalDay:0;if(n<15||n>120)return!1;const o=t.getRecentContext?t.getRecentContext():'',i=['ç°åœº','æ¡ˆå‘åœ°','æŒ‡è®¤','å¸¦å›','å‹˜æŸ¥'].some(e=>o.includes(e))?.24:.08;return Math.random()<i},weight:80,description:'å…¬å®‰æœºå…³å¸¦å¾€æ¡ˆå‘ç°åœºæŒ‡è®¤',category:'procedural',aiControlled:!0}],randomEvents:{violence:[{id:'newcomer_bullying',name:'æ–°äººæ¬ºå‡Œ',weight:30},{id:'bed_dispute',name:'åºŠä½äº‰å¤º',weight:25},{id:'food_robbery',name:'é£Ÿç‰©æŠ¢å¤º',weight:20},{id:'faction_conflict',name:'æ´¾ç³»å†²çª',weight:15},{id:'revenge',name:'æŠ¥å¤è¡ŒåŠ¨',weight:10}],medical:[{id:'epidemic',name:'ä¼ æŸ“ç—…çˆ†å‘',weight:15},{id:'mental_illness',name:'ç²¾ç¥ç–¾ç—…å‘ä½œ',weight:25},{id:'chronic_disease',name:'æ…¢æ€§ç—…æ¶åŒ–',weight:20},{id:'injury',name:'æ„å¤–å—ä¼¤',weight:20},{id:'gynecological',name:'å¦‡ç§‘é—®é¢˜',weight:10},{id:'malnutrition',name:'è¥å…»ä¸è‰¯',weight:10}],emotional:[{id:'deep_friendship',name:'æ·±åº¦å‹è°Šå»ºç«‹',weight:20},{id:'betrayal',name:'é—ºèœœåç›®',weight:15},{id:'motherly_bond',name:'æ¯å¥³èˆ¬å…³ç³»',weight:15},{id:'jealousy',name:'å«‰å¦’ä¸æ’æŒ¤',weight:20},{id:'secret_sharing',name:'ç§˜å¯†åˆ†äº«',weight:15},{id:'collective_exclusion',name:'é›†ä½“æ’æ–¥',weight:10},{id:'romance',name:'æ‹æƒ…èŒèŠ½',weight:5}],accident:[{id:'facility_failure',name:'è®¾æ–½æ•…éšœ',weight:25},{id:'safety_incident',name:'å®‰å…¨äº‹æ•…',weight:20},{id:'external_news',name:'å¤–éƒ¨æ¶ˆæ¯',weight:30},{id:'extreme_weather',name:'æç«¯å¤©æ°”',weight:15},{id:'management_change',name:'ç®¡ç†å˜åŒ–',weight:10}]},innerMonologues:[{id:'worry_about_family',text:'ä¸çŸ¥é“å®¶é‡Œäººç°åœ¨æ€ä¹ˆæ ·äº†...',weight:20},{id:'regret_past',text:'å¦‚æœå½“åˆæ²¡æœ‰åšé‚£ä»¶äº‹å°±å¥½äº†...',weight:20},{id:'fear_future',text:'ä¸çŸ¥é“åˆ¤å†³ä¼šæ˜¯ä»€ä¹ˆç»“æœ...',weight:18},{id:'miss_freedom',text:'å¥½æƒ³å¿µå¤–é¢çš„é˜³å…‰å’Œè‡ªç”±...',weight:15},{id:'self_reflection',text:'æˆ‘åˆ°åº•æ˜¯æ€ä¹ˆèµ°åˆ°è¿™ä¸€æ­¥çš„...',weight:12},{id:'hope_for_leniency',text:'å¸Œæœ›æ³•å®˜èƒ½ä»è½»åˆ¤å†³...',weight:10},{id:'worry_about_children',text:'å­©å­ä»¬ç°åœ¨è¿˜å¥½å—...',weight:15},{id:'fear_of_inmates',text:'è¿™é‡Œçš„äººçœ‹èµ·æ¥éƒ½å¾ˆå¯æ€•...',weight:12},{id:'loneliness',text:'ä»æ¥æ²¡æœ‰æ„Ÿè§‰è¿™ä¹ˆå­¤ç‹¬è¿‡...',weight:15},{id:'time_perception',text:'åœ¨è¿™é‡Œï¼Œæ—¶é—´è¿‡å¾—å¥½æ…¢...',weight:10},{id:'dream_of_past',text:'æ˜¨æ™šåˆæ¢¦åˆ°äº†ä»¥å‰çš„ç”Ÿæ´»...',weight:12},{id:'worry_about_health',text:'èº«ä½“è¶Šæ¥è¶Šå·®äº†ï¼Œä¸çŸ¥é“èƒ½ä¸èƒ½æ’‘ä¸‹å»...',weight:10},{id:'guilt',text:'å¯¹ä¸èµ·é‚£äº›è¢«æˆ‘ä¼¤å®³çš„äºº...',weight:8},{id:'anger',text:'ä¸ºä»€ä¹ˆåªæœ‰æˆ‘è¢«æŠ“ï¼Œå…¶ä»–äººéƒ½æ²¡äº‹...',weight:8},{id:'acceptance',text:'ä¹Ÿè®¸è¿™å°±æ˜¯æˆ‘åº”å¾—çš„æƒ©ç½š...',weight:7},{id:'hope_for_appeal',text:'ä¸Šè¯‰è¿˜æœ‰å¸Œæœ›å—...',weight:8},{id:'fear_of_death',text:'å¦‚æœè¢«åˆ¤æ­»åˆ‘æ€ä¹ˆåŠ...',weight:5},{id:'nostalgia',text:'å¥½æƒ³åƒä¸€é¡¿å®¶é‡Œåšçš„é¥­...',weight:10}],initialize(e=0){try{if(!('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null)){console.debug('[äº‹ä»¶ç³»ç»Ÿ] æ²¡æœ‰æ‰“å¼€çš„èŠå¤©æ–‡ä»¶ï¼Œè·³è¿‡ä»èŠå¤©å˜é‡åŠ è½½çŠ¶æ€'),this.currentDay=e,this.legalTimeline.arrestDay=e,this.currentStage='detention',this.cellType='transition',this.caseComplexity='normal',this.complexityMultiplier=1,this.isDeathPenalty=!1,this.lastStageChangeDay=e,this.lastEventDay=e;for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0;return this.assignedOfficers={police:[],prosecutor:null},console.info('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼ŒèŠå¤©æ–‡ä»¶æœªåˆ›å»ºï¼‰'),void console.info(`[äº‹ä»¶ç³»ç»Ÿ] èµ·å§‹æ—¥æœŸ: ç¬¬${this.currentDay}å¤©`)}let t=null;try{if(t=getVariables({type:'chat'}),!t||'object'!=typeof t)throw new Error('èŠå¤©å˜é‡æ— æ•ˆæˆ–ä¸ºç©º')}catch(t){console.debug('[äº‹ä»¶ç³»ç»Ÿ] è·å–èŠå¤©å˜é‡å¤±è´¥ï¼ŒèŠå¤©æ–‡ä»¶å¯èƒ½æœªåˆ›å»º:',t),this.currentDay=e,this.legalTimeline.arrestDay=e,this.currentStage='detention',this.cellType='transition',this.caseComplexity='normal',this.complexityMultiplier=1,this.isDeathPenalty=!1,this.lastStageChangeDay=e,this.lastEventDay=e;for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0;return console.info('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œæ— æ³•è·å–èŠå¤©å˜é‡ï¼‰'),void console.info(`[äº‹ä»¶ç³»ç»Ÿ] èµ·å§‹æ—¥æœŸ: ç¬¬${this.currentDay}å¤©`)}if(t&&'object'==typeof t){const n=t.detentionSystemState;if(n&&'object'==typeof n){if(console.info('[äº‹ä»¶ç³»ç»Ÿ] ä»èŠå¤©å˜é‡åŠ è½½ä¿å­˜çš„çŠ¶æ€æ•°æ®'),this.currentDay=n.currentDay??e,this.currentStage=n.currentStage??'detention',this.cellType=n.cellType??'transition',this.caseComplexity=n.caseComplexity??'normal',this.isDeathPenalty=Boolean(n.isDeathPenalty),this.lastStageChangeDay=n.lastStageChangeDay??e,this.lastEventDay=this.currentDay,n.legalTimeline&&'object'==typeof n.legalTimeline?this.legalTimeline={...this.legalTimeline,...n.legalTimeline}:this.legalTimeline.arrestDay=this.currentDay,n.eventCounters&&'object'==typeof n.eventCounters)this.eventCounters={...this.eventCounters,...n.eventCounters};else for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0;if(Array.isArray(n.eventHistory)&&(this.eventHistory=[...n.eventHistory]),n.assignedOfficers&&'object'==typeof n.assignedOfficers){const e=n.assignedOfficers.police;let t=[];Array.isArray(e)?t=e:'string'==typeof e&&e&&(t=[e]),this.assignedOfficers={police:t,prosecutor:n.assignedOfficers.prosecutor??null}}else this.assignedOfficers={police:[],prosecutor:null};console.info(`[äº‹ä»¶ç³»ç»Ÿ] å·²åŠ è½½ä¿å­˜çš„çŠ¶æ€: ç¬¬${this.currentDay}å¤©`)}else{this.currentDay=e,this.legalTimeline.arrestDay=e,this.currentStage='detention',this.cellType='transition',this.caseComplexity='normal',this.complexityMultiplier=1,this.isDeathPenalty=!1,this.lastStageChangeDay=e,this.lastEventDay=e;for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0}}else{this.currentDay=e,this.legalTimeline.arrestDay=e,this.currentStage='detention',this.cellType='transition',this.caseComplexity='normal',this.complexityMultiplier=1,this.isDeathPenalty=!1,this.lastStageChangeDay=e,this.lastEventDay=e;for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0}}catch(t){console.warn('[äº‹ä»¶ç³»ç»Ÿ] åŠ è½½èŠå¤©å˜é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:',t),this.currentDay=e,this.legalTimeline.arrestDay=e,this.currentStage='detention',this.cellType='transition',this.caseComplexity='normal',this.complexityMultiplier=1,this.isDeathPenalty=!1,this.lastStageChangeDay=e,this.lastEventDay=e;for(const e of Object.keys(this.eventCounters))this.eventCounters[e]=0}console.info('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆ'),console.info(`[äº‹ä»¶ç³»ç»Ÿ] èµ·å§‹æ—¥æœŸ: ç¬¬${this.currentDay}å¤©`),setTimeout(()=>{try{('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null)?this.saveStateToChatVars():console.debug('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–æ—¶æ— èŠå¤©IDï¼Œè·³è¿‡ä¿å­˜çŠ¶æ€')}catch(e){console.warn('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–åä¿å­˜çŠ¶æ€å¤±è´¥:',e)}},2e3),n.events.emit('event_system_initialized',{day:this.currentDay,stage:this.currentStage})},saveStateToChatVars(){t&&(clearTimeout(t),t=null),t=setTimeout(()=>{try{if(!('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null))return console.debug('[äº‹ä»¶ç³»ç»Ÿ] æ²¡æœ‰æ‰“å¼€çš„èŠå¤©æ–‡ä»¶ï¼Œè·³è¿‡ä¿å­˜çŠ¶æ€åˆ°èŠå¤©å˜é‡'),void(t=null);const e={currentDay:this.currentDay,currentStage:this.currentStage,cellType:this.cellType,legalTimeline:{...this.legalTimeline},caseComplexity:this.caseComplexity,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters},eventHistory:[...this.eventHistory],lastStageChangeDay:this.lastStageChangeDay,assignedOfficers:{...this.assignedOfficers}};if(JSON.stringify(e).length>1e5){console.warn('[äº‹ä»¶ç³»ç»Ÿ] çŠ¶æ€æ•°æ®è¿‡å¤§ï¼Œæˆªæ–­äº‹ä»¶å†å²');const t={...e,eventHistory:this.eventHistory.slice(-50)};e.eventHistory=t.eventHistory}try{const e=getVariables({type:'chat'});if(!e||'object'!=typeof e)return console.debug('[äº‹ä»¶ç³»ç»Ÿ] æ— æ³•è·å–èŠå¤©å˜é‡ï¼ŒèŠå¤©æ–‡ä»¶å¯èƒ½æœªåˆ›å»ºï¼Œè·³è¿‡ä¿å­˜çŠ¶æ€'),void(t=null)}catch(e){return console.debug('[äº‹ä»¶ç³»ç»Ÿ] æµ‹è¯•è·å–èŠå¤©å˜é‡å¤±è´¥ï¼ŒèŠå¤©æ–‡ä»¶å¯èƒ½æœªåˆ›å»ºï¼Œè·³è¿‡ä¿å­˜çŠ¶æ€:',e),void(t=null)}try{const e=getVariables({type:'chat'});if(!e||'object'!=typeof e)return console.debug('[äº‹ä»¶ç³»ç»Ÿ] æ— æ³•è·å–èŠå¤©å˜é‡ï¼ŒèŠå¤©æ–‡ä»¶å¯èƒ½æœªåˆ›å»ºï¼Œè·³è¿‡ä¿å­˜çŠ¶æ€'),void(t=null)}catch(e){return console.debug('[äº‹ä»¶ç³»ç»Ÿ] æµ‹è¯•è·å–èŠå¤©å˜é‡å¤±è´¥ï¼ŒèŠå¤©æ–‡ä»¶å¯èƒ½æœªåˆ›å»ºï¼Œè·³è¿‡ä¿å­˜çŠ¶æ€:',e),void(t=null)}updateVariablesWith(t=>({...t,detentionSystemState:e}),{type:'chat'}),console.debug('[äº‹ä»¶ç³»ç»Ÿ] âœ“ çŠ¶æ€å·²ä¿å­˜åˆ°èŠå¤©å˜é‡ (é˜²æŠ–)')}catch(e){console.warn('[äº‹ä»¶ç³»ç»Ÿ] ä¿å­˜çŠ¶æ€åˆ°èŠå¤©å˜é‡å¤±è´¥ (updateVariablesWith):',e)}t=null},500)},setCaseComplexity(e){const t={simple:.8,normal:1,complex:1.3,very_complex:1.6};e in t?(this.caseComplexity=e,this.complexityMultiplier=t[e],console.info(`[äº‹ä»¶ç³»ç»Ÿ] æ¡ˆä»¶å¤æ‚åº¦è®¾ç½®ä¸º: ${e} (æ—¶é™å€æ•°: ${this.complexityMultiplier})`),n.events.emit('complexity_changed',{complexity:this.caseComplexity,multiplier:this.complexityMultiplier})):console.warn(`[äº‹ä»¶ç³»ç»Ÿ] æ— æ•ˆçš„å¤æ‚åº¦: ${e}`)},checkComplexityAdjustment(){this.currentDay%30==0&&n.events.emit('request_complexity_assessment',{day:this.currentDay,stage:this.currentStage,eventHistory:this.eventHistory})},rollbackToStage(e,t='ç‰¹æ®Šæƒ…å†µ'){console.info(`[äº‹ä»¶ç³»ç»Ÿ] æ³•å¾‹ç¨‹åºå›é€€: ${this.currentStage} -> ${e}`),console.info(`[äº‹ä»¶ç³»ç»Ÿ] å›é€€åŸå› : ${t}`);const o=['detention','approval','investigation','prosecution','trial1','firstVerdict','appeal','trial2','finalVerdict','transfer','execution'],i=o.indexOf(e),a=o.indexOf(this.currentStage);if(-1===i||i>=a)return console.warn('[äº‹ä»¶ç³»ç»Ÿ] æ— æ•ˆçš„å›é€€ç›®æ ‡æˆ–æ— éœ€å›é€€'),!1;const s={approval:'approvalDay',investigation:'approvalDay',prosecution:'prosecutionDay',trial1:'firstTrialDay',firstVerdict:'firstVerdictDay',appeal:'firstVerdictDay',trial2:'secondTrialDay',finalVerdict:'finalVerdictDay',transfer:'transferDay',execution:'executionDay'};for(let e=i+1;e<o.length;e++){const t=s[o[e]];t&&this.legalTimeline[t]&&(this.legalTimeline[t]=null)}return this.currentStage=e,i<=o.indexOf('investigation')&&(this.cellType='pretrial'),this.eventHistory.push({id:'procedure_rollback',name:'ç¨‹åºå›é€€',type:'legal',day:this.currentDay,from:o[a],to:e,reason:t}),n.events.emit('procedure_rollback',{from:o[a],to:e,reason:t,day:this.currentDay}),!0},advanceToStage(e,t='ç”¨æˆ·è¯·æ±‚å¼ºåˆ¶æ¨è¿›'){console.info(`[äº‹ä»¶ç³»ç»Ÿ] å¼ºåˆ¶æ¨è¿›é˜¶æ®µ: ${this.currentStage} -> ${e}`),console.info(`[äº‹ä»¶ç³»ç»Ÿ] æ¨è¿›åŸå› : ${t}`);const o=['detention','approval','investigation','prosecution','trial1','firstVerdict','appeal','trial2','finalVerdict','transfer','execution'],i=o.indexOf(e),a=o.indexOf(this.currentStage);if(-1===i)return console.warn(`[äº‹ä»¶ç³»ç»Ÿ] æ— æ•ˆçš„ç›®æ ‡é˜¶æ®µ: ${e}`),!1;if(i<=a)return console.warn(`[äº‹ä»¶ç³»ç»Ÿ] ç›®æ ‡é˜¶æ®µ ${e} ä¸åœ¨å½“å‰é˜¶æ®µ ${this.currentStage} ä¹‹åï¼Œæ— æ³•æ¨è¿›`),!1;const s={approval:'approvalDay',investigation:'approvalDay',prosecution:'prosecutionDay',trial1:'firstTrialDay',firstVerdict:'firstVerdictDay',appeal:'firstVerdictDay',trial2:'secondTrialDay',finalVerdict:'finalVerdictDay',transfer:'transferDay',execution:'executionDay'};for(let e=a+1;e<=i;e++){const t=s[o[e]];t&&!this.legalTimeline[t]&&(this.legalTimeline[t]=this.currentDay)}return this.currentStage=e,this.lastStageChangeDay=this.currentDay,i>=o.indexOf('investigation')&&i<o.indexOf('firstVerdict')&&(this.cellType='pretrial'),i>=o.indexOf('firstVerdict')&&(this.cellType='convicted'),'execution'===e&&(this.isDeathPenalty=!0,this.legalTimeline.executionDay=this.currentDay),this.eventHistory.push({id:'procedure_advance',name:'å¼ºåˆ¶é˜¶æ®µæ¨è¿›',type:'legal',day:this.currentDay,from:o[a],to:e,reason:t}),this.saveStateToChatVars(),n.events.emit('procedure_advance',{from:o[a],to:e,reason:t,day:this.currentDay}),console.info(`[äº‹ä»¶ç³»ç»Ÿ] âœ“ å·²å¼ºåˆ¶æ¨è¿›åˆ°é˜¶æ®µ: ${e} (ç¬¬${this.currentDay}å¤©)`),!0},handleUserRollback(e){const t=[{pattern:/å›é€€.*?åˆ°.*?(ä¾¦æŸ¥|å®¡æŸ¥èµ·è¯‰|ä¸€å®¡|äºŒå®¡)/,stage:null},{pattern:/æ’¤å›.*?(èµ·è¯‰|åˆ¤å†³)/,stage:null},{pattern:/é‡æ–°.*?(ä¾¦æŸ¥|å®¡ç†)/,stage:null}];for(const n of t){const t=e.match(n.pattern);if(t){let e=null;if(t[1].includes('ä¾¦æŸ¥')?e='investigation':t[1].includes('å®¡æŸ¥èµ·è¯‰')?e='prosecution':t[1].includes('ä¸€å®¡')?e='trial1':t[1].includes('äºŒå®¡')&&(e='trial2'),e)return this.rollbackToStage(e,'ç”¨æˆ·è¯·æ±‚')}}return!1},advanceDay(e=1){const t=[],o=this.getCurrentDayInternal();let i=this.getCurrentDayInternal();const a=Math.max(1,Math.floor(e));for(let e=0;e<a;e++){i++;const e=this.currentDay;this.currentDay=i,this.lastEventDay=i,this.checkComplexityAdjustment();const a=this.checkDayEvents();if(this.currentDay=e,(0!==i||!a||'no_event'===a.id)&&a){t.push(a),this.eventHistory.push({...a,day:i}),Object.prototype.hasOwnProperty.call(this.eventCounters,a.id)&&(this.eventCounters[a.id]=(this.eventCounters[a.id]||0)+1);const e=a.priority??this.PRIORITY.DAILY;if(e<=this.PRIORITY.RANDOM){console.info(`[äº‹ä»¶ç³»ç»Ÿ] ç¬¬${i}å¤©è§¦å‘äº‹ä»¶: ${a.name} (ä¼˜å…ˆçº§: ${e})ï¼Œç«‹å³æ‰“æ–­å¤©æ•°æ¨è¿›`);const t=i-o;this.saveStateToChatVars();const s={...a,day:i,pendingDayAdvancement:t,startDay:o};n.events.emit('event_triggered',s);return{interrupted:!0,currentDay:this.currentDay,tempCurrentDay:i,pendingDays:t,event:{...a,day:i}}}console.debug(`[äº‹ä»¶ç³»ç»Ÿ] ç¬¬${i}å¤©è§¦å‘äº‹ä»¶: ${a.name} (ä¼˜å…ˆçº§: ${e})ï¼Œç»§ç»­æ¨è¿›`)}}const s=t.find(e=>(e.priority??this.PRIORITY.DAILY)<=this.PRIORITY.RANDOM);this.saveStateToChatVars();const r=i-o;return s?{interrupted:!0,currentDay:this.currentDay,tempCurrentDay:i,pendingDays:r,event:{...s,day:i}}:{interrupted:!1,currentDay:this.currentDay,tempCurrentDay:i,pendingDays:r}},checkDayEvents(){if(0===this.currentDay)return{id:'no_event',name:'æ— äº‹ä»¶',type:'daily',description:'ç¬¬0å¤©ä¸è§¦å‘äº‹ä»¶',priority:this.PRIORITY.DAILY,day:0};const e=new Date,t=e.getMonth()+1,n=e.getDate();if(this.checkCellTransfer()){const e={transition:'è¿‡æ¸¡ç›‘å®¤',pretrial:'æœªå†³çŠ¯ç›‘å®¤',convicted:'å·²å†³çŠ¯ç›‘å®¤'};return{id:'cell_transfer',name:'ç›‘å®¤è½¬ç§»',type:'legal',description:`ä»${e.transition||'è¿‡æ¸¡ç›‘å®¤'}è½¬ç§»è‡³${e[this.cellType]||'æœªå†³çŠ¯ç›‘å®¤'}`,priority:this.PRIORITY.LEGAL,day:this.currentDay,from:'transition',to:this.cellType,reason:'è¿‡æ¸¡æœŸç»“æŸ',text:`${t}æœˆ${n}æ—¥ï¼Œè§¦å‘äº†ç›‘å®¤è½¬ç§»äº‹ä»¶ã€‚è¯·æè¿°ä»ä¸Šæ¬¡å›å¤åˆ°äº‹ä»¶å‘ç”Ÿå‰è¿™ä¸€æ®µæ—¶é—´å†…ä¸»è§’çš„ä¸»è¦ç»å†å’ŒçŠ¶æ€å˜åŒ–ï¼Œå¹¶åœ¨äº‹ä»¶å³å°†å¼€å§‹æ—¶ç»“æŸï¼ˆä¸è¦æè¿°äº‹ä»¶æœ¬èº«ï¼Œåªæè¿°äº‹ä»¶å‘ç”Ÿå‰çš„å‡†å¤‡å’ŒçŠ¶æ€ï¼‰ã€‚`}}const o=this.checkLegalEvent();if(o)return{...o,priority:this.PRIORITY.LEGAL,day:this.currentDay,text:`${t}æœˆ${n}æ—¥ï¼Œè§¦å‘äº†${o.name}äº‹ä»¶ã€‚è¯·æè¿°ä»ä¸Šæ¬¡å›å¤åˆ°äº‹ä»¶å‘ç”Ÿå‰è¿™ä¸€æ®µæ—¶é—´å†…ä¸»è§’çš„ä¸»è¦ç»å†å’ŒçŠ¶æ€å˜åŒ–ï¼Œå¹¶åœ¨äº‹ä»¶å³å°†å¼€å§‹æ—¶ç»“æŸï¼ˆä¸è¦æè¿°äº‹ä»¶æœ¬èº«ï¼Œåªæè¿°äº‹ä»¶å‘ç”Ÿå‰çš„å‡†å¤‡å’ŒçŠ¶æ€ï¼‰ã€‚`};const i=this.checkConditionEvent();if(i){const e='interrogation'===i.id||'lawyer_visit'===i.id||'family_visit'===i.id||'prosecutor_interrogation'===i.id?this.PRIORITY.PROCEDURAL:this.PRIORITY.CONDITION;if('interrogation'===i.id||'prosecutor_interrogation'===i.id){const e=['å¼ è­¦å®˜','æè­¦å®˜','ç‹è­¦å®˜','åˆ˜è­¦å®˜','é™ˆè­¦å®˜','èµµè­¦å®˜','å­™è­¦å®˜','å‘¨è­¦å®˜'],t=['å¼ æ£€å¯Ÿå®˜','ææ£€å¯Ÿå®˜','ç‹æ£€å¯Ÿå®˜','åˆ˜æ£€å¯Ÿå®˜','é™ˆæ£€å¯Ÿå®˜','èµµæ£€å¯Ÿå®˜'];if('prosecutor_interrogation'===i.id){if(this.assignedOfficers.police.length<2){const t=new Set(this.assignedOfficers.police);for(;this.assignedOfficers.police.length<2;){const n=e.filter(e=>!t.has(e));if(0===n.length)break;const o=n[Math.floor(Math.random()*n.length)];this.assignedOfficers.police.push(o),t.add(o)}console.info(`[äº‹ä»¶ç³»ç»Ÿ] å·²åˆ†é…å›ºå®šè­¦å®˜: ${this.assignedOfficers.police.join('ã€')}`)}this.assignedOfficers.prosecutor||(this.assignedOfficers.prosecutor=t[Math.floor(Math.random()*t.length)],console.info(`[äº‹ä»¶ç³»ç»Ÿ] å·²åˆ†é…å›ºå®šæ£€å¯Ÿå®˜: ${this.assignedOfficers.prosecutor}`)),i.description=`æ£€å¯Ÿå®˜æå®¡è®¯é—®ï¼ˆ${this.assignedOfficers.prosecutor}è´Ÿè´£ï¼Œ${this.assignedOfficers.police.join('ã€')}ååŠ©ï¼‰`}else if('interrogation'===i.id){if(this.assignedOfficers.police.length<2){const t=new Set(this.assignedOfficers.police);for(;this.assignedOfficers.police.length<2;){const n=e.filter(e=>!t.has(e));if(0===n.length)break;const o=n[Math.floor(Math.random()*n.length)];this.assignedOfficers.police.push(o),t.add(o)}console.info(`[äº‹ä»¶ç³»ç»Ÿ] å·²åˆ†é…å›ºå®šè­¦å®˜: ${this.assignedOfficers.police.join('ã€')}`)}const n=null!==this.legalTimeline.approvalDay,o=!this.legalTimeline.firstTrialDay||this.currentDay<this.legalTimeline.firstTrialDay,a='investigation'===this.currentStage||'prosecution'===this.currentStage;n&&o&&a&&Math.random()<.5?(this.assignedOfficers.prosecutor||(this.assignedOfficers.prosecutor=t[Math.floor(Math.random()*t.length)],console.info(`[äº‹ä»¶ç³»ç»Ÿ] å·²åˆ†é…å›ºå®šæ£€å¯Ÿå®˜: ${this.assignedOfficers.prosecutor}`)),i.description=`å…¬å®‰æœºå…³æå®¡è®¯é—®ï¼ˆ${this.assignedOfficers.police.join('ã€')}è´Ÿè´£ï¼‰ï¼Œ${this.assignedOfficers.prosecutor}å‚ä¸æå®¡`):i.description=`å…¬å®‰æœºå…³æå®¡è®¯é—®ï¼ˆ${this.assignedOfficers.police.join('ã€')}è´Ÿè´£ï¼‰`}}const o=e<=this.PRIORITY.CONDITION;return{...i,priority:e,day:this.currentDay,text:o?`${t}æœˆ${n}æ—¥ï¼Œè§¦å‘äº†${i.name}äº‹ä»¶ã€‚è¯·æè¿°ä»ä¸Šæ¬¡å›å¤åˆ°äº‹ä»¶å‘ç”Ÿå‰è¿™ä¸€æ®µæ—¶é—´å†…ä¸»è§’çš„ä¸»è¦ç»å†å’ŒçŠ¶æ€å˜åŒ–ï¼Œå¹¶åœ¨äº‹ä»¶å³å°†å¼€å§‹æ—¶ç»“æŸï¼ˆä¸è¦æè¿°äº‹ä»¶æœ¬èº«ï¼Œåªæè¿°äº‹ä»¶å‘ç”Ÿå‰çš„å‡†å¤‡å’ŒçŠ¶æ€ï¼‰ã€‚`:void 0}}if(this.currentDay>0&&'transition'!==this.cellType&&Math.random()<.05){const e=this.generateRandomEvent();if(e)return{...e,priority:this.PRIORITY.RANDOM,day:this.currentDay,text:`${t}æœˆ${n}æ—¥ï¼Œè§¦å‘äº†${e.name}äº‹ä»¶ã€‚è¯·æè¿°ä»ä¸Šæ¬¡å›å¤åˆ°äº‹ä»¶å‘ç”Ÿå‰è¿™ä¸€æ®µæ—¶é—´å†…ä¸»è§’çš„ä¸»è¦ç»å†å’ŒçŠ¶æ€å˜åŒ–ï¼Œå¹¶åœ¨äº‹ä»¶å³å°†å¼€å§‹æ—¶ç»“æŸï¼ˆä¸è¦æè¿°äº‹ä»¶æœ¬èº«ï¼Œåªæè¿°äº‹ä»¶å‘ç”Ÿå‰çš„å‡†å¤‡å’ŒçŠ¶æ€ï¼‰ã€‚`}}if(Math.random()<.15){const e=this.generateInnerMonologue();if(e)return{...e,priority:this.PRIORITY.DAILY,day:this.currentDay}}return{id:'daily_routine',name:'æ—¥å¸¸ç”Ÿæ´»',type:'daily',priority:this.PRIORITY.DAILY,day:this.currentDay,description:'å¹³é™çš„ä¸€å¤©'}},checkLegalEvent(){const e=this.currentDay-this.legalTimeline.arrestDay,t=this.currentStage;if(!this.legalTimeline.approvalDay){const n=Math.floor(30*this.complexityMultiplier),o=Math.floor(37*this.complexityMultiplier);if(e>=n&&e<=o&&Math.random()<.3)return this.legalTimeline.approvalDay=this.currentDay,this.currentStage='investigation',this.lastStageChangeDay=this.currentDay,{id:'approval',name:'æ‰¹å‡†é€®æ•',type:'legal',stage:'approval',description:'æ£€å¯Ÿé™¢æ‰¹å‡†é€®æ•å†³å®šä¸‹è¾¾',from:t,to:'investigation'}}if(this.legalTimeline.approvalDay&&!this.legalTimeline.prosecutionDay){const e=this.currentDay-this.legalTimeline.approvalDay,n=Math.floor(60*this.complexityMultiplier),o=Math.floor(210*this.complexityMultiplier);if(e>=n&&e<=o&&Math.random()<.02)return this.legalTimeline.prosecutionDay=this.currentDay,this.currentStage='prosecution',this.lastStageChangeDay=this.currentDay,{id:'prosecution',name:'æ£€å¯Ÿé™¢èµ·è¯‰',type:'legal',stage:'prosecution',description:'æ£€å¯Ÿé™¢å‘æ³•é™¢æèµ·å…¬è¯‰',from:t,to:'prosecution'}}if(this.legalTimeline.prosecutionDay&&!this.legalTimeline.firstTrialDay){const e=this.currentDay-this.legalTimeline.prosecutionDay,o=Math.floor(30*this.complexityMultiplier),i=Math.floor(45*this.complexityMultiplier);if(e>=o&&e<=i&&Math.random()<.05)return this.legalTimeline.firstTrialDay=this.currentDay,this.currentStage='trial1',this.lastStageChangeDay=this.currentDay,'transition'===this.cellType&&(this.cellType='pretrial',n.events.emit('cell_transfer',{from:'transition',to:'pretrial',reason:'ç­‰å¾…å¼€åº­'})),{id:'first_trial',name:'ä¸€å®¡å¼€åº­',type:'legal',stage:'trial1',description:'æ³•é™¢ä¸€å®¡å¼€åº­å®¡ç†',from:t,to:'trial1'}}if(this.legalTimeline.firstTrialDay&&!this.legalTimeline.firstVerdictDay){const e=this.currentDay-this.legalTimeline.firstTrialDay,o=Math.floor(7*this.complexityMultiplier),i=Math.floor(30*this.complexityMultiplier);if(e>=o&&e<=i&&Math.random()<.1)return this.legalTimeline.firstVerdictDay=this.currentDay,this.currentStage='appeal',this.lastStageChangeDay=this.currentDay,this.cellType='convicted',n.events.emit('cell_transfer',{from:'pretrial',to:'convicted',reason:'ä¸€å®¡åˆ¤å†³å®£å‘Š'}),{id:'first_verdict',name:'ä¸€å®¡åˆ¤å†³',type:'legal',stage:'firstVerdict',description:'æ³•é™¢å®£å‘Šä¸€å®¡åˆ¤å†³',from:t,to:'appeal'}}if(this.legalTimeline.firstVerdictDay&&!this.legalTimeline.secondTrialDay&&!this.legalTimeline.finalVerdictDay){if(10===this.currentDay-this.legalTimeline.firstVerdictDay)return Math.random()<.7?(this.legalTimeline.secondTrialDay=this.currentDay,this.currentStage='trial2',this.lastStageChangeDay=this.currentDay,{id:'appeal_filed',name:'æèµ·ä¸Šè¯‰',type:'legal',stage:'appeal',description:'å‘ä¸Šçº§æ³•é™¢æèµ·ä¸Šè¯‰',from:t,to:'trial2'}):(this.legalTimeline.finalVerdictDay=this.currentDay,this.currentStage='transfer',this.lastStageChangeDay=this.currentDay,{id:'verdict_final',name:'åˆ¤å†³ç”Ÿæ•ˆ',type:'legal',stage:'finalVerdict',description:'æœªä¸Šè¯‰ï¼Œä¸€å®¡åˆ¤å†³ç”Ÿæ•ˆ',from:t,to:'transfer'})}if(this.legalTimeline.secondTrialDay&&!this.legalTimeline.finalVerdictDay){const e=this.currentDay-this.legalTimeline.secondTrialDay,n=Math.floor(60*this.complexityMultiplier),o=Math.floor(90*this.complexityMultiplier);if(e>=n&&e<=o&&Math.random()<.03)return this.legalTimeline.finalVerdictDay=this.currentDay,this.currentStage='transfer',this.lastStageChangeDay=this.currentDay,{id:'final_verdict',name:'äºŒå®¡åˆ¤å†³',type:'legal',stage:'finalVerdict',description:'äºŒå®¡æ³•é™¢å®£å‘Šç»ˆå®¡åˆ¤å†³',from:t,to:'transfer'}}if(this.legalTimeline.finalVerdictDay&&!this.legalTimeline.transferDay&&!this.isDeathPenalty){const e=this.currentDay-this.legalTimeline.finalVerdictDay,n=Math.floor(30*this.complexityMultiplier),o=Math.floor(90*this.complexityMultiplier);if(e>=n&&e<=o&&Math.random()<.02)return this.legalTimeline.transferDay=this.currentDay,this.currentStage='end',this.lastStageChangeDay=this.currentDay,{id:'transfer_prison',name:'ç§»é€ç›‘ç‹±',type:'legal',stage:'transfer',description:'ç§»é€ç›‘ç‹±æ‰§è¡Œåˆ‘ç½š',isEnding:!0,endingType:'prison',from:t,to:'end'}}if(this.legalTimeline.finalVerdictDay&&this.isDeathPenalty&&!this.legalTimeline.executionDay){const e=this.currentDay-this.legalTimeline.finalVerdictDay;if(e>=180&&e<=720&&Math.random()<.005)return this.legalTimeline.executionDay=this.currentDay+7,this.currentStage='execution',this.lastStageChangeDay=this.currentDay,{id:'death_review_approved',name:'æ­»åˆ‘å¤æ ¸æ ¸å‡†',type:'legal',stage:'deathReview',description:'æœ€é«˜æ³•é™¢æ ¸å‡†æ­»åˆ‘ï¼Œ7æ—¥å†…æ‰§è¡Œ',from:t,to:'execution'}}return this.legalTimeline.executionDay&&this.currentDay>=this.legalTimeline.executionDay?(this.currentStage='end',this.lastStageChangeDay=this.currentDay,{id:'execution',name:'æ‰§è¡Œæ­»åˆ‘',type:'legal',stage:'execution',description:'æ­»åˆ‘æ‰§è¡Œ',isEnding:!0,endingType:'death',from:t,to:'end'}):null},checkConditionEvent(){const e=this.getProtagonistState();for(const t of this.conditionEvents)if((!t.stageChangeOnly||this.currentDay===this.lastStageChangeDay)&&(t.checkAlways||!t.stageChangeOnly)){if(t.condition(e,this)){if(100*Math.random()<t.weight)return{id:t.id,name:t.name,type:t.category||'condition',description:t.description,aiControlled:t.aiControlled||!1}}}return null},generateRandomEvent(){const e=['violence','medical','emotional','accident'],t=e[this.weightedRandom(e.length,[25,30,30,15])],n=this.randomEvents[t],o=n.map(e=>e.weight),i=n[this.weightedRandom(n.length,o)];return{id:i.id,name:i.name,type:t,category:'random',description:`éšæœºäº‹ä»¶: ${i.name}`}},generateInnerMonologue(){const e=this.innerMonologues.map(e=>e.weight),t=this.weightedRandom(this.innerMonologues.length,e),n=this.innerMonologues[t];return{id:n.id,name:'å¿ƒç†ç‹¬ç™½',type:'monologue',category:'daily',description:n.text,text:n.text}},weightedRandom(e,t){const n=t.reduce((e,t)=>e+t,0);let o=Math.random()*n;for(let n=0;n<e;n++)if(o-=t[n],o<=0)return n;return e-1},getProtagonistState(){console.log('[äº‹ä»¶ç³»ç»Ÿ] getProtagonistState: æ–°ç‰ˆæœ¬ä»£ç å·²åŠ è½½ï¼Œæ”¯æŒè®°å¿†å¼ºåŒ–æ’ä»¶');const e=n.getModule('statusPanel');if(e&&e.getState){return e.getState()}return console.warn('[äº‹ä»¶ç³»ç»Ÿ] çŠ¶æ€æ æ¨¡å—ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€å€¼'),{health:70,mental:65,strength:50,intelligence:55}},getRecentContext(){if(Array.isArray(window.chat)){return window.chat.slice(-5).map(e=>e.mes||'').join(' ')}return''},checkCellTransfer(){const e=this.currentDay-this.legalTimeline.arrestDay;return'transition'===this.cellType&&e>=7&&e<=14&&(this.cellType='pretrial',n.events.emit('cell_transfer',{from:'transition',to:'pretrial',reason:'è¿‡æ¸¡æœŸç»“æŸ',day:this.currentDay}),!0)},setDeathPenalty(e){this.isDeathPenalty=e,console.info(`[äº‹ä»¶ç³»ç»Ÿ] æ­»åˆ‘æ ‡è®°è®¾ç½®ä¸º: ${e}`),n.events.emit('death_penalty_status_changed',{isDeathPenalty:this.isDeathPenalty,day:this.currentDay})},getCurrentStageInfo(){const e={transition:'è¿‡æ¸¡ç›‘å®¤',pretrial:'æœªå†³çŠ¯ç›‘å®¤',convicted:'å·²å†³çŠ¯ç›‘å®¤'}[this.cellType]||'è¿‡æ¸¡ç›‘å®¤';return{day:this.currentDay,stage:this.currentStage,cellType:e,cellTypeRaw:this.cellType,daysInCustody:this.currentDay-this.legalTimeline.arrestDay,timeline:{...this.legalTimeline},complexity:this.caseComplexity,complexityMultiplier:this.complexityMultiplier,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters}}},getEventStatistics(){const e={totalEvents:this.eventHistory.length,byType:{},byPriority:{},recentEvents:this.eventHistory.slice(-10)};return this.eventHistory.forEach(t=>{const n=t.type||'unknown';e.byType[n]=(e.byType[n]||0)+1;const o=t.priority||4;e.byPriority[o]=(e.byPriority[o]||0)+1}),e},exportTimeline(){return{currentDay:this.currentDay,currentStage:this.currentStage,cellType:this.cellType,timeline:{...this.legalTimeline},complexity:this.caseComplexity,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters},eventHistory:[...this.eventHistory],lastStageChangeDay:this.lastStageChangeDay}},importTimeline(e){if(!e)return!1;try{return this.currentDay=e.currentDay||0,this.currentStage=e.currentStage||'detention',this.cellType=e.cellType||'transition',this.legalTimeline=e.timeline||{},this.caseComplexity=e.complexity||'normal',this.isDeathPenalty=Boolean(e.isDeathPenalty),this.eventCounters=e.eventCounters||{},this.eventHistory=e.eventHistory||[],this.lastStageChangeDay=e.lastStageChangeDay||0,console.info('[äº‹ä»¶ç³»ç»Ÿ] æ—¶é—´çº¿å¯¼å…¥æˆåŠŸ'),!0}catch(e){return console.error('[äº‹ä»¶ç³»ç»Ÿ] æ—¶é—´çº¿å¯¼å…¥å¤±è´¥:',e),!1}},saveEventInterruptSnapshot(){try{if(!('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null))return void console.debug('[äº‹ä»¶ç³»ç»Ÿ] æ²¡æœ‰æ‰“å¼€çš„èŠå¤©æ–‡ä»¶ï¼Œè·³è¿‡ä¿å­˜äº‹ä»¶æ‰“æ–­å¿«ç…§');try{const e=getVariables({type:'chat'});if(!e||'object'!=typeof e)return void console.debug('[äº‹ä»¶ç³»ç»Ÿ] æ— æ³•è·å–èŠå¤©å˜é‡ï¼ŒèŠå¤©æ–‡ä»¶å¯èƒ½æœªåˆ›å»ºï¼Œè·³è¿‡ä¿å­˜äº‹ä»¶æ‰“æ–­å¿«ç…§')}catch(e){return void console.debug('[äº‹ä»¶ç³»ç»Ÿ] æµ‹è¯•è·å–èŠå¤©å˜é‡å¤±è´¥ï¼ŒèŠå¤©æ–‡ä»¶å¯èƒ½æœªåˆ›å»ºï¼Œè·³è¿‡ä¿å­˜äº‹ä»¶æ‰“æ–­å¿«ç…§:',e)}const e={currentDay:this.currentDay,currentStage:this.currentStage,cellType:this.cellType,legalTimeline:{...this.legalTimeline},caseComplexity:this.caseComplexity,isDeathPenalty:this.isDeathPenalty,eventCounters:{...this.eventCounters},eventHistory:[...this.eventHistory],lastStageChangeDay:this.lastStageChangeDay,snapshotTime:Date.now()};try{updateVariablesWith(t=>({...t,detentionSystemInterruptSnapshot:e}),{type:'chat'})}catch(e){console.warn('[äº‹ä»¶ç³»ç»Ÿ] ä¿å­˜äº‹ä»¶æ‰“æ–­å¿«ç…§å¤±è´¥ (updateVariablesWith):',e)}console.debug('[äº‹ä»¶ç³»ç»Ÿ] äº‹ä»¶æ‰“æ–­å¿«ç…§å·²ä¿å­˜')}catch(e){console.warn('[äº‹ä»¶ç³»ç»Ÿ] ä¿å­˜äº‹ä»¶æ‰“æ–­å¿«ç…§å¤±è´¥:',e)}},confirmDayAdvancement(e){if(e>0){const t=this.getCurrentDayInternal(),o=t+e;this.currentDay=o,this.lastEventDay=o;try{const i=n.getModule('statusPanel');i&&i.modifyValue?(i.modifyValue('days',e,`ç¡®è®¤å¤©æ•°æ¨è¿›${e}å¤©`),console.info(`[äº‹ä»¶ç³»ç»Ÿ] âœ“ å·²åŒæ­¥å¤©æ•°åˆ°è®°å¿†å¢å¼ºæ’ä»¶: ${t} -> ${o} (æ¨è¿›äº†${e}å¤©)`)):console.warn('[äº‹ä»¶ç³»ç»Ÿ] âš  statusPanel æ¨¡å—ä¸å¯ç”¨ï¼Œæ— æ³•åŒæ­¥å¤©æ•°åˆ°è®°å¿†å¢å¼ºæ’ä»¶')}catch(e){console.warn('[äº‹ä»¶ç³»ç»Ÿ] âš  åŒæ­¥å¤©æ•°åˆ°è®°å¿†å¢å¼ºæ’ä»¶å¤±è´¥:',e)}console.info(`[äº‹ä»¶ç³»ç»Ÿ] âœ“ å·²ç¡®è®¤å¤©æ•°æ¨è¿›: ${t} -> ${o} (æ¨è¿›äº†${e}å¤©)`),this.saveStateToChatVars()}},rollbackToInterruptSnapshot(){try{const e=getVariables({type:'chat'}).detentionSystemInterruptSnapshot;return e&&'object'==typeof e?(console.info('[äº‹ä»¶ç³»ç»Ÿ] å›é€€åˆ°äº‹ä»¶æ‰“æ–­æ—¶çš„çŠ¶æ€'),this.currentDay=e.currentDay??this.currentDay,this.currentStage=e.currentStage??this.currentStage,this.cellType=e.cellType??this.cellType,this.caseComplexity=e.caseComplexity??this.caseComplexity,this.isDeathPenalty=Boolean(e.isDeathPenalty),this.lastStageChangeDay=e.lastStageChangeDay??this.lastStageChangeDay,e.legalTimeline&&'object'==typeof e.legalTimeline&&(this.legalTimeline={...this.legalTimeline,...e.legalTimeline}),e.eventCounters&&'object'==typeof e.eventCounters&&(this.eventCounters={...this.eventCounters,...e.eventCounters}),Array.isArray(e.eventHistory)&&(this.eventHistory=[...e.eventHistory]),this.saveStateToChatVars(),!0):(console.warn('[äº‹ä»¶ç³»ç»Ÿ] æœªæ‰¾åˆ°äº‹ä»¶æ‰“æ–­å¿«ç…§ï¼Œæ— æ³•å›é€€'),!1)}catch(e){return console.error('[äº‹ä»¶ç³»ç»Ÿ] å›é€€åˆ°äº‹ä»¶æ‰“æ–­å¿«ç…§å¤±è´¥:',e),!1}}};n.generateRandomEvent=e=>i.generateRandomEvent(),n.advanceDay=e=>i.advanceDay(e),n.getCurrentDay=()=>o(i.currentDay),n.getCurrentStage=()=>i.getCurrentStageInfo(),n.checkCellTransfer=()=>i.checkCellTransfer(),n.setCaseComplexity=e=>i.setCaseComplexity(e),n.rollbackToStage=(e,t)=>i.rollbackToStage(e,t),n.advanceToStage=(e,t)=>i.advanceToStage(e,t),n.setDeathPenalty=e=>i.setDeathPenalty(e),n.getEventStatistics=()=>i.getEventStatistics(),n.exportTimeline=()=>i.exportTimeline(),n.importTimeline=e=>i.importTimeline(e),n.rollbackToInterruptSnapshot=()=>i.rollbackToInterruptSnapshot(),n.registerModule('eventSystem',i);try{window.parent&&window.parent!==window&&(window.parent.detentionSystem=n,console.info('[äº‹ä»¶ç³»ç»Ÿ] âœ“ å·²åŒæ­¥åˆ°ä¸»çª—å£'))}catch(e){}n.events.on('user_input',e=>{const t='string'==typeof e?.text?e.text:void 0;t&&i.handleUserRollback(t)}),n.events.on('initialized',()=>{try{i.initialize(0)}catch(e){console.error('[äº‹ä»¶ç³»ç»Ÿ] åˆå§‹åŒ–å¤±è´¥:',e)}}),console.info('[äº‹ä»¶ç³»ç»Ÿ] è„šæœ¬åŠ è½½å®Œæˆ v3.4.0')}),console.info('[NPCç³»ç»Ÿ] å¼€å§‹åŠ è½½...');const s={surnames:{tier1:{names:['ç‹','æ','å¼ ','åˆ˜','é™ˆ','æ¨','é»„','èµµ','å´','å‘¨'],weight:35},tier2:{names:['å¾','å­™','é©¬','æœ±','èƒ¡','éƒ­','ä½•','æ—','é«˜','ç½—','éƒ‘','æ¢','è°¢','å®‹','å”','è®¸','éŸ©','å†¯','é‚“','æ›¹'],weight:30},tier3:{names:['å½­','æ›¾','è‚–','ç”°','è‘£','è¢','æ½˜','äº','è’‹','è”¡','ä½™','æœ','å¶','ç¨‹','è‹','é­','å•','ä¸','ä»»','æ²ˆ','å§š','å¢','å§œ','å´”','é’Ÿ','è°­','é™†','æ±ª','èŒƒ','é‡‘'],weight:20},tier4:{names:['çŸ³','å»–','è´¾','å¤','éŸ¦','ä»˜','æ–¹','ç™½','é‚¹','å­Ÿ','ç†Š','ç§¦','é‚±','æ±Ÿ','å°¹','è–›','é—«','æ®µ','é›·','ä¾¯','é¾™','å²','é™¶','é»','è´º','é¡¾','æ¯›','éƒ','é¾š','é‚µ'],weight:10},tier5:{names:['ä¸‡','è¦ƒ','æ­¦','ä¹”','ä¸¥','èµ–','æ–‡','æ´ª','å­£','è«','æ¬§é˜³','å¸é©¬','ä¸Šå®˜','è¯¸è‘›','ä¸œæ–¹'],weight:5}},givenNames:{vintage:{single:['èŠ³','ä¸½','å¨Ÿ','è‹±','å','ç‰','ç§€','ç','çº¢','æ¢…','å…°','éœ','ç‡•','è','é™'],double:[['ç§€','è‹±'],['ç§€','å…°'],['ç§€','ç'],['ç§€','èŠ³'],['ä¸½','å'],['ä¸½','å¨Ÿ'],['ä¸½','è'],['ä¸½','èŠ³'],['ç‰','å…°'],['ç‰','æ¢…'],['ç‰','å'],['ç‰','ç'],['æ˜¥','æ¢…'],['æ˜¥','å…°'],['æ˜¥','å'],['æ˜¥','ç‡•'],['å°','çº¢'],['å°','èŠ³'],['å°','ä¸½'],['å°','ç‡•']],weight:25},classic:{single:['å©·','æ´','è‰','æ•','è‰³','å¨œ','å€©','é›ª','ç³','é¢–','æ™¶','æ¬£','æ…§','ä½³','è–‡'],double:[['é›…','å©·'],['é›…','æ´'],['é›…','ç³'],['é›…','æ¬£'],['æ™“','ç‡•'],['æ™“','ä¸½'],['æ™“','çº¢'],['æ™“','éœ'],['æ–‡','é™'],['æ–‡','æ…§'],['æ–‡','å¨Ÿ'],['æ–‡','å©·'],['å¿—','çº¢'],['å¿—','å'],['å¿—','è‹±'],['å¿—','èŠ³'],['æµ·','ç‡•'],['æµ·','éœ'],['æµ·','è‹±'],['æµ·','ä¸½']],weight:35},modern:{single:['å©·','æ´','è‰','æ•','è‰³','å¨œ','å€©','é›ª','ç³','é¢–','æ™¶','æ¬£','æ…§','ä½³','è–‡','æ¶µ','è±','çª','ç‘¶','è¯—'],double:[['é›¨','å©·'],['é›¨','æ¬£'],['é›¨','æ¶µ'],['é›¨','è±'],['æ€','çª'],['æ€','æ¶µ'],['æ€','é›¨'],['æ€','é¢–'],['æ¢¦','çª'],['æ¢¦','ç‘¶'],['æ¢¦','æ¶µ'],['æ¢¦','è±'],['è¯—','æ¶µ'],['è¯—','çª'],['è¯—','é›¨'],['è¯—','å©·'],['æ¬£','æ€¡'],['æ¬£','æ‚¦'],['æ¬£','ç„¶'],['æ¬£','å¦']],weight:30},contemporary:{single:['æ¶µ','è±','çª','ç‘¶','è¯—','è¯­','é¦¨','å¦','å½¤','æ‚¦','ç„¶','æ€¡','å¯','ä¾','æ¢“'],double:[['æ¢“','æ¶µ'],['æ¢“','è±'],['æ¢“','çª'],['æ¢“','ç‘¶'],['å­','æ¶µ'],['å­','è±'],['å­','çª'],['å­','ç‘¶'],['é›¨','æ¡'],['é›¨','å½¤'],['é›¨','é¦¨'],['é›¨','è¯º'],['è¯—','è¯­'],['è¯—','æ¶µ'],['è¯—','é›¨'],['è¯—','çª'],['å¯','æ¬£'],['å¯','é¦¨'],['å¯','å¿ƒ'],['å¯','å„¿']],weight:10}},badNames:['å²çé¦™','èŒƒç»Ÿ','æœå­è…¾','èŒƒå‰‘','æœ±é€¸ç¾¤','ç§¦å¯¿ç”Ÿ','æœç¦ç‡•','é­ç”Ÿæ´¥','è´¹å½¦','æ®·é™','èŒƒå©‰','èƒ¡ä¸½æ™¶'],badChars:['å±','å°¿','ç²ª','æ­»','ä¸§','ç—…','æ®‹','åºŸ','è´±','å¥´','å¦“','å¨¼'],generate(e){let t=0;for(;t<50;){t++;const n=this.selectSurname()+this.selectGivenName(e);if(this.isValidName(n))return n}return'å¼ '+this.givenNames.classic.single[0]},selectSurname(){const e=Object.values(this.surnames),t=e.reduce((e,t)=>e+t.weight,0);let n=Math.random()*t;for(const t of e)if(n-=t.weight,n<=0)return t.names[Math.floor(Math.random()*t.names.length)];return this.surnames.tier1.names[0]},selectGivenName(e){const t=(new Date).getFullYear()-e,n=t>=50?'vintage':t>=35?'classic':t>=20?'modern':'contemporary',o=this.givenNames[n];if(Math.random()<.6&&o.double.length>0){const e=o.double[Math.floor(Math.random()*o.double.length)];return e[0]+e[1]}return o.single[Math.floor(Math.random()*o.single.length)]},isValidName(e){return!this.badNames.includes(e)&&!this.badChars.some(t=>e.includes(t))}},r={characterBookCrimes:['å±é™©é©¾é©¶ç½ª','ç›—çªƒç½ª','è¯ˆéª—ç½ª','æ•…æ„ä¼¤å®³ç½ª','èµ°ç§æ¯’å“ç½ª','è´©å–æ¯’å“ç½ª','è¿è¾“æ¯’å“ç½ª','åˆ¶é€ æ¯’å“ç½ª','äº¤é€šè‚‡äº‹ç½ª','å¯»è¡…æ»‹äº‹ç½ª','æŠ¢åŠ«ç½ª','æ•…æ„æ€äººç½ª','å¼€è®¾èµŒåœºç½ª','æ•²è¯ˆå‹’ç´¢ç½ª','è´ªæ±¡ç½ª','å—è´¿ç½ª','èšä¼—æ–—æ®´ç½ª','éæ³•æ‹˜ç¦ç½ª','å®¹ç•™ä»–äººå¸æ¯’ç½ª','æ©é¥°éšç’çŠ¯ç½ªæ‰€å¾—ç½ª','å¸®åŠ©ä¿¡æ¯ç½‘ç»œçŠ¯ç½ªæ´»åŠ¨ç½ª','èŒåŠ¡ä¾µå ç½ª'],crimes:{violent:{names:['æ•…æ„æ€äººç½ª','æ•…æ„ä¼¤å®³ç½ª','æŠ¢åŠ«ç½ª','ç»‘æ¶ç½ª','éæ³•æ‹˜ç¦ç½ª','èšä¼—æ–—æ®´ç½ª'],weight:12,sentenceRange:[3,20]},property:{names:['ç›—çªƒç½ª','è¯ˆéª—ç½ª','æŠ¢å¤ºç½ª','æ•²è¯ˆå‹’ç´¢ç½ª','èŒåŠ¡ä¾µå ç½ª','æŒªç”¨èµ„é‡‘ç½ª','è´ªæ±¡ç½ª','å—è´¿ç½ª','æ©é¥°éšç’çŠ¯ç½ªæ‰€å¾—ç½ª'],weight:35,sentenceRange:[1,15]},drug:{names:['è´©å–æ¯’å“ç½ª','è¿è¾“æ¯’å“ç½ª','åˆ¶é€ æ¯’å“ç½ª','èµ°ç§æ¯’å“ç½ª','éæ³•æŒæœ‰æ¯’å“ç½ª','å®¹ç•™ä»–äººå¸æ¯’ç½ª','å¼•è¯±ä»–äººå¸æ¯’ç½ª'],weight:20,sentenceRange:[3,15]},economic:{names:['éæ³•å¸æ”¶å…¬ä¼—å­˜æ¬¾ç½ª','é›†èµ„è¯ˆéª—ç½ª','åˆåŒè¯ˆéª—ç½ª','ä¿¡ç”¨å¡è¯ˆéª—ç½ª','æ´—é’±ç½ª','è™šå¼€å‘ç¥¨ç½ª','é€ƒç¨ç½ª'],weight:15,sentenceRange:[2,10]},social:{names:['å¯»è¡…æ»‹äº‹ç½ª','èšä¼—æ–—æ®´ç½ª','å¼€è®¾èµŒåœºç½ª','ç»„ç»‡å–æ·«ç½ª','ä¼ æ’­æ·«ç§½ç‰©å“ç½ª','å¦¨å®³å…¬åŠ¡ç½ª','å¸®åŠ©ä¿¡æ¯ç½‘ç»œçŠ¯ç½ªæ´»åŠ¨ç½ª'],weight:13,sentenceRange:[1,7]},other:{names:['äº¤é€šè‚‡äº‹ç½ª','å±é™©é©¾é©¶ç½ª','ç”Ÿäº§é”€å”®ä¼ªåŠ£äº§å“ç½ª','éæ³•ç»è¥ç½ª','æ±¡æŸ“ç¯å¢ƒç½ª','èµ°ç§ç½ª'],weight:5,sentenceRange:[1,5]}},generate(){if(Math.random()<.3){const e=this.characterBookCrimes[Math.floor(Math.random()*this.characterBookCrimes.length)],t=this.findCategoryByCrime(e);return{crime:e,sentence:this.generateSentence(t?t.sentenceRange:[1,10]),category:t||this.crimes.property}}const e=Object.values(this.crimes),t=e.reduce((e,t)=>e+t.weight,0);let n=Math.random()*t;for(const t of e)if(n-=t.weight,n<=0){return{crime:t.names[Math.floor(Math.random()*t.names.length)],sentence:this.generateSentence(t.sentenceRange),category:t}}return{crime:'ç›—çªƒç½ª',sentence:3,category:this.crimes.property}},findCategoryByCrime(e){for(const t of Object.keys(this.crimes)){const n=this.crimes[t];if(n.names.includes(e))return n}return null},generateSentence(e){const[t,n]=e;return Math.floor(Math.random()*(n-t+1))+t}};$(()=>{const e=window.detentionSystem;if(!e)return console.error('âŒ [NPCç³»ç»Ÿ] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½ï¼'),console.error('[NPCç³»ç»Ÿ] window.detentionSystem:',typeof window.detentionSystem),console.error('[NPCç³»ç»Ÿ] window.__DETENTION_SYSTEM_LOADED__:',window.__DETENTION_SYSTEM_LOADED__),void console.error('[NPCç³»ç»Ÿ] window.__DETENTION_SYSTEM_CORE_LOADED__:',window.__DETENTION_SYSTEM_CORE_LOADED__);const t=e;console.info('âœ“ [NPCç³»ç»Ÿ] å¼€å§‹åŠ è½½...'),window.__NPC_SYSTEM_LOADING__=!0;const n={npcDatabase:[],currentCellNPCs:[],generate(e=1,t={}){const n=[];for(let o=0;o<e;o++){const e=this.generateSingle(t);n.push(e),this.npcDatabase.push(e)}return n},generateSingle(e={}){const n=t.getModule('eventSystem'),o=n?.getCurrentStageInfo?n.getCurrentStageInfo():{},i=this.generateAge(),a=(new Date).getFullYear()-i,l=s.generate(a),c=r.generate(),d=this.generateAppearance(i),h=this.generatePersonality(),g=this.generateBackground(i,c),m=this.generateRelationship(),u='string'==typeof o?.cellType?o.cellType:e.cellType||'transition';this.adjustByCellType(h,m,u);return{id:this.generateId(),name:l,gender:'female',age:i,crime:c.crime,sentence:c.sentence,appearance:d,personality:h,background:g,relationship:m,cellType:u,daysInCustody:Math.floor(365*Math.random())+30,status:'active',createdAt:Date.now()}},generateAge(){const e=Math.random();return e<.05?Math.floor(3*Math.random())+18:e<.25?Math.floor(10*Math.random())+21:e<.55?Math.floor(10*Math.random())+31:e<.8?Math.floor(10*Math.random())+41:e<.95?Math.floor(10*Math.random())+51:Math.floor(15*Math.random())+61},generateAppearance(e){const t=[150,155,160,165,170,175],n=[45,50,55,60,65,70,75],o=e>50?['çŸ­å‘','èŠ±ç™½çŸ­å‘','ç°ç™½çŸ­å‘','ç¨€ç–çŸ­å‘']:['é•¿å‘','çŸ­å‘','é©¬å°¾','é½è‚©å‘','æ³¢æµªå·','ç›´å‘','å·å‘'],i=['ç™½çš™','åç™½','è‡ªç„¶','åé»‘','é»é»‘'],a=['æ¸…ç§€','æ™®é€š','æ†”æ‚´','ç²¾è‡´','æ²§æ¡‘','å§£å¥½','ç«¯åº„'];return{height:t[Math.floor(Math.random()*t.length)],weight:n[Math.floor(Math.random()*n.length)],hair:o[Math.floor(Math.random()*o.length)],eyes:'é»‘è‰²',skin:i[Math.floor(Math.random()*i.length)],features:a[Math.floor(Math.random()*a.length)]}},generatePersonality(){const e={aggression:Math.floor(100*Math.random()),sociability:Math.floor(100*Math.random()),intelligence:Math.floor(100*Math.random()),emotional:Math.floor(100*Math.random()),dominance:Math.floor(100*Math.random()),kindness:Math.floor(100*Math.random())},t=[];return e.aggression>70&&t.push('æš´åŠ›å€¾å‘'),e.sociability>70&&t.push('å–„äºäº¤é™…'),e.intelligence>70&&t.push('èªæ˜'),e.emotional>70&&t.push('æƒ…ç»ªåŒ–'),e.dominance>70&&t.push('å¼ºåŠ¿'),e.kindness>70&&t.push('å–„è‰¯'),e.aggression<30&&t.push('æ¸©å’Œ'),e.sociability<30&&t.push('å­¤åƒ»'),e.emotional<30&&t.push('å†·é™'),e.dominance<30&&t.push('é¡ºä»'),{traits:e,tags:t}},generateBackground(e,t){const n=['å°å­¦','åˆä¸­','é«˜ä¸­','ä¸­ä¸“','å¤§ä¸“','æœ¬ç§‘','ç ”ç©¶ç”Ÿ'],o=this.weightedRandom(n.length,[10,25,30,15,10,8,2]),i=['æœªå©š','å·²å©š','ç¦»å¼‚','ä¸§å¶'],a=e<25?[80,15,5,0]:e<40?[20,60,15,5]:[10,50,30,10],s=this.weightedRandom(i.length,a),r='æœªå©š'!==i[s]&&Math.random()<.7,l=r?Math.floor(3*Math.random())+1:0;return{education:n[o],maritalStatus:i[s],hasChildren:r,childrenCount:l,hometown:this.generateHometown(),priorConvictions:Math.random()<.3?Math.floor(3*Math.random())+1:0}},generateHometown(){const e=['æ²³å—','å±±ä¸œ','å››å·','å¹¿ä¸œ','æ±Ÿè‹','æ²³åŒ—','æ¹–å—','å®‰å¾½','æ¹–åŒ—','æµ™æ±Ÿ','å¹¿è¥¿','äº‘å—','æ±Ÿè¥¿','è¾½å®','é»‘é¾™æ±Ÿ','é™•è¥¿','ç¦å»º','å±±è¥¿','è´µå·','é‡åº†'];return e[Math.floor(Math.random()*e.length)]},generateRelationship:()=>({toProtagonist:50,faction:null,allies:[],enemies:[],influence:Math.floor(100*Math.random())}),adjustByCellType(e,t,n){'transition'===n?(e.traits.emotional+=10,t.influence-=20):'pretrial'===n?(e.traits.emotional+=15,e.traits.aggression+=5):'convicted'===n&&(e.traits.emotional-=10,e.traits.aggression+=10,t.influence+=10),Object.keys(e.traits).forEach(t=>{e.traits[t]=Math.max(0,Math.min(100,e.traits[t]))}),t.influence=Math.max(0,Math.min(100,t.influence))},weightedRandom(e,t){const n=t.reduce((e,t)=>e+t,0);let o=Math.random()*n;for(let n=0;n<e;n++)if(o-=t[n],o<=0)return n;return e-1},generateId:()=>'npc_'+Date.now()+'_'+Math.random().toString(36).slice(2,11),generateForEvent(e){return'interrogation'===e?this.generatePolice():'lawyer_visit'===e?this.generateLawyer():'family_visit'===e?this.generateFamily():'medical_visit'===e?this.generateDoctor():'scene_identification'===e?{police:this.generatePolice(),witnesses:this.generate(2,{type:'witness'})}:this.generateSingle({eventType:e})},generatePolice(){const e=Math.floor(20*Math.random())+25,t=(new Date).getFullYear()-e,n=s.generate(t),o=['æ°‘è­¦','è­¦é•¿','å‰¯é˜Ÿé•¿','é˜Ÿé•¿'],i=o[Math.floor(Math.random()*o.length)];return{id:this.generateId(),name:n,gender:'female',age:e,role:'police',rank:i,appearance:this.generateAppearance(e),personality:{traits:{aggression:Math.floor(30*Math.random())+40,sociability:Math.floor(40*Math.random())+30,intelligence:Math.floor(30*Math.random())+50,emotional:Math.floor(40*Math.random())+20,dominance:Math.floor(30*Math.random())+60,kindness:Math.floor(60*Math.random())+20},tags:['ä¸¥è‚ƒ','ä¸“ä¸š']},attitude:Math.floor(40*Math.random())+30,crime:'â€”â€”',sentence:0,background:this.generateBackground(e,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'staff',daysInCustody:0,status:'active',createdAt:Date.now()}},generateLawyer(){const e=Math.floor(25*Math.random())+28,t=(new Date).getFullYear()-e,n=Math.random()<.8,o=s.generate(t),i=['æ³•å¾‹æ´åŠ©å¾‹å¸ˆ','ç§äººå¾‹å¸ˆ','çŸ¥åå¾‹å¸ˆ'],a=this.weightedRandom(i.length,[50,40,10]);return{id:this.generateId(),name:o,gender:n?'female':'male',age:e,role:'lawyer',type:i[a],appearance:this.generateAppearance(e),personality:{traits:{aggression:Math.floor(20*Math.random())+20,sociability:Math.floor(30*Math.random())+60,intelligence:Math.floor(20*Math.random())+70,emotional:Math.floor(40*Math.random())+30,dominance:Math.floor(40*Math.random())+40,kindness:Math.floor(40*Math.random())+40},tags:['ä¸“ä¸š','ç†æ€§']},experience:Math.floor(20*Math.random())+5,successRate:Math.floor(40*Math.random())+40,crime:'â€”â€”',sentence:0,background:this.generateBackground(e,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},generateFamily(){const e=['æ¯äº²','çˆ¶äº²','ä¸ˆå¤«','å¦»å­','å§å§','å¦¹å¦¹','å¥³å„¿','å„¿å­'],t=e[this.weightedRandom(e.length,[30,20,15,10,10,10,3,2])];let n=40,o=!0;'æ¯äº²'===t?(n=Math.floor(20*Math.random())+45,o=!0):'çˆ¶äº²'===t?(n=Math.floor(20*Math.random())+45,o=!1):'ä¸ˆå¤«'===t?(n=Math.floor(30*Math.random())+25,o=!1):'å¦»å­'===t?(n=Math.floor(30*Math.random())+25,o=!0):'å§å§'===t||'å¦¹å¦¹'===t?(n=Math.floor(30*Math.random())+20,o=!0):'å¥³å„¿'===t?(n=Math.floor(15*Math.random())+5,o=!0):'å„¿å­'===t&&(n=Math.floor(15*Math.random())+5,o=!1);const i=(new Date).getFullYear()-n,a=s.generate(i);return{id:this.generateId(),name:a,gender:o?'female':'male',age:n,role:'family',relation:t,appearance:this.generateAppearance(n),personality:{traits:{aggression:Math.floor(30*Math.random())+10,sociability:Math.floor(50*Math.random())+30,intelligence:Math.floor(60*Math.random())+30,emotional:Math.floor(50*Math.random())+40,dominance:Math.floor(50*Math.random())+20,kindness:Math.floor(30*Math.random())+60},tags:['å…³å¿ƒ','æ‹…å¿§']},supportLevel:Math.floor(40*Math.random())+60,crime:'â€”â€”',sentence:0,background:this.generateBackground(n,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},generateDoctor(){const e=Math.floor(25*Math.random())+30,t=(new Date).getFullYear()-e,n=s.generate(t),o=['å†…ç§‘','å¤–ç§‘','ç²¾ç¥ç§‘','å¦‡ç§‘','æ€¥è¯Šç§‘'],i=o[Math.floor(Math.random()*o.length)];return{id:this.generateId(),name:n,gender:'female',age:e,role:'doctor',specialty:i,appearance:this.generateAppearance(e),personality:{traits:{aggression:Math.floor(20*Math.random())+10,sociability:Math.floor(40*Math.random())+40,intelligence:Math.floor(20*Math.random())+70,emotional:Math.floor(40*Math.random())+30,dominance:Math.floor(40*Math.random())+40,kindness:Math.floor(30*Math.random())+60},tags:['ä¸“ä¸š','å†·é™']},experience:Math.floor(25*Math.random())+5,crime:'â€”â€”',sentence:0,background:this.generateBackground(e,{crime:'',sentence:0,category:{sentenceRange:[0,0]}}),relationship:this.generateRelationship(),cellType:'external',daysInCustody:0,status:'active',createdAt:Date.now()}},generateProtagonist(e={}){try{fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'npc_system.ts:generateProtagonistå¼€å§‹',message:'å¼€å§‹ç”Ÿæˆä¸»è§’',data:{options:e,hasOptions:!!e},timestamp:Date.now(),sessionId:'debug-session',runId:'protagonist-generation',hypothesisId:'PROTAGONIST_START'})}).catch(()=>{})}catch(e){}let t;if(e.ageRange&&2===e.ageRange.length){const[n,o]=e.ageRange;t=Math.floor(Math.random()*(o-n+1))+n}else t=e.background?.isIntellectual||e.background?.isBusiness?Math.floor(11*Math.random())+35:Math.floor(15*Math.random())+28;const n=(new Date).getFullYear()-t,o=s.generate(n);let i;if(e.crimeName){const t=r.findCategoryByCrime(e.crimeName),n=t?t.sentenceRange:[2,10];i={crime:e.crimeName,sentence:r.generateSentence(n),category:t||r.crimes.economic}}else if(e.crimeType){const t=e.crimeType;if(r.crimes[t]){const n=r.crimes[t];n.names[Math.floor(Math.random()*n.names.length)];let o=n.names;e.excludeCrimes&&e.excludeCrimes.length>0&&(o=n.names.filter(t=>!e.excludeCrimes.includes(t))),0===o.length&&(o=n.names);i={crime:o[Math.floor(Math.random()*o.length)],sentence:r.generateSentence(n.sentenceRange),category:n}}else{const t=r.crimes.economic,n=e.excludeCrimes?t.names.filter(t=>!e.excludeCrimes.includes(t)):t.names;i={crime:n.length>0?n[Math.floor(Math.random()*n.length)]:t.names[0],sentence:r.generateSentence(t.sentenceRange),category:t}}}else if(e.background?.isIntellectual||e.background?.isBusiness){const t=r.crimes.economic,n=e.excludeCrimes?t.names.filter(t=>!e.excludeCrimes.includes(t)):t.names;i={crime:n.length>0?n[Math.floor(Math.random()*n.length)]:t.names[0],sentence:r.generateSentence(t.sentenceRange),category:t}}else if(i=r.generate(),e.excludeCrimes&&e.excludeCrimes.includes(i.crime)){let t=0;for(;t<10&&e.excludeCrimes.includes(i.crime);)i=r.generate(),t++}const a=this.generateAppearance(t);let l,c;if('high'===e.education){const e=['æœ¬ç§‘','ç ”ç©¶ç”Ÿ','ç¡•å£«','åšå£«'];l=e[Math.floor(Math.random()*e.length)]}else if('medium'===e.education){const e=['å¤§ä¸“','ä¸­ä¸“','é«˜èŒ'];l=e[Math.floor(Math.random()*e.length)]}else if('low'===e.education){const e=['å°å­¦','åˆä¸­','é«˜ä¸­'];l=e[Math.floor(Math.random()*e.length)]}else if(e.background?.isIntellectual){const e=['æœ¬ç§‘','ç ”ç©¶ç”Ÿ','ç¡•å£«','åšå£«'];l=e[Math.floor(Math.random()*e.length)]}else if(e.background?.isBusiness){const e=['å¤§ä¸“','æœ¬ç§‘','ç ”ç©¶ç”Ÿ','MBA'];l=e[Math.floor(Math.random()*e.length)]}else if(t<30){const e=['é«˜ä¸­','å¤§ä¸“','æœ¬ç§‘','ç ”ç©¶ç”Ÿ'],t=[20,30,40,10];l=e[this.weightedRandom(e.length,t)]}else{const e=['é«˜ä¸­','å¤§ä¸“','æœ¬ç§‘','ç ”ç©¶ç”Ÿ','ç¡•å£«','åšå£«'],t=[15,25,35,10,10,5];l=e[this.weightedRandom(e.length,t)]}if(e.profession&&e.profession.length>0)c=e.profession[Math.floor(Math.random()*e.profession.length)];else if(e.background?.isBusiness){const e=['ä¼ä¸šå®¶','å…¬å¸é«˜ç®¡','é‡‘èä»ä¸šè€…','æŠ•èµ„é¡¾é—®','ä¼ä¸šç®¡ç†è€…'];c=e[Math.floor(Math.random()*e.length)]}else if(e.background?.isIntellectual&&!e.background?.isAcademic){const e=['ä¼ä¸šé«˜ç®¡','é‡‘èä»ä¸šè€…','å’¨è¯¢é¡¾é—®','é«˜çº§ç®¡ç†è€…','æŠ€æœ¯æ€»ç›‘'];c=e[Math.floor(Math.random()*e.length)]}else if(e.background?.isAcademic){const e=['æ•™æˆ','ç ”ç©¶å‘˜','å­¦è€…','é«˜æ ¡æ•™å¸ˆ','ç§‘ç ”äººå‘˜'];c=e[Math.floor(Math.random()*e.length)]}const d=t<30?['æœªå©š','å·²å©š']:t<40?['å·²å©š','ç¦»å¼‚','æœªå©š']:['å·²å©š','ç¦»å¼‚'],h=t<30?[40,60]:t<40?[60,25,15]:'åšå£«'===l||'ç¡•å£«'===l?[70,30]:[65,35],g=d[this.weightedRandom(d.length,h)],m='æœªå©š'!==g&&t>28&&Math.random()<.7,u=m?t<35?1:Math.floor(2*Math.random())+1:0,y=this.generateHometown(),p={traits:{intelligence:e.background?.isIntellectual?Math.floor(15*Math.random())+80:e.background?.isBusiness?Math.floor(20*Math.random())+70:Math.floor(30*Math.random())+60,sociability:e.background?.isBusiness?Math.floor(25*Math.random())+60:Math.floor(40*Math.random())+40,emotional:Math.floor(40*Math.random())+30},tags:[]};return e.background?.isIntellectual&&(p.tags.push('é«˜å­¦å†','ç†æ€§'),e.background.isAcademic||p.tags.push('éå­¦æœ¯èƒŒæ™¯')),e.background?.isBusiness&&p.tags.push('å•†ä¸šèƒŒæ™¯','ç²¾æ˜'),p.traits.intelligence>=75&&p.tags.push('èªæ˜'),p.traits.sociability>=60&&p.tags.push('å–„äºäº¤é™…'),{name:o,age:t,crime:i.crime,sentence:i.sentence,appearance:{height:a.height,weight:a.weight,hair:a.hair,skin:a.skin,features:a.features,eyes:a.eyes},background:{education:l,profession:c,maritalStatus:g,hasChildren:m,childrenCount:u,hometown:y},personality:p}},getCurrentCellNPCs(){return this.currentCellNPCs},setCurrentCellNPCs(e){this.currentCellNPCs=e,t.events.emit('cell_npcs_changed',{npcs:e})},addNPCToCell(e){this.currentCellNPCs.push(e),t.events.emit('npc_joined_cell',{npc:e})},removeNPCFromCell(e){const n=this.currentCellNPCs.findIndex(t=>t.id===e);if(-1!==n){const e=this.currentCellNPCs.splice(n,1)[0];return t.events.emit('npc_left_cell',{npc:e}),e}return null},findNPCById(e){return this.npcDatabase.find(t=>t.id===e)||this.currentCellNPCs.find(t=>t.id===e)},updateRelationship(e,n){const o=this.findNPCById(e);o&&o.relationship&&(o.relationship.toProtagonist=Math.max(0,Math.min(100,o.relationship.toProtagonist+n)),t.events.emit('relationship_changed',{npcId:e,npcName:o.name,value:o.relationship.toProtagonist,delta:n}))},exportData(){return{database:this.npcDatabase,currentCell:this.currentCellNPCs}},importData(e){if(!e)return!1;try{return this.npcDatabase=e.database||[],this.currentCellNPCs=e.currentCell||[],console.info('[NPCç³»ç»Ÿ] æ•°æ®å¯¼å…¥æˆåŠŸ'),!0}catch(e){return console.error('[NPCç³»ç»Ÿ] æ•°æ®å¯¼å…¥å¤±è´¥:',e),!1}},clearData(){this.npcDatabase=[],this.currentCellNPCs=[],console.info('[NPCç³»ç»Ÿ] æ•°æ®å·²æ¸…ç©º')}};t.generateNPC=(e,t)=>n.generate(e,t??{}),t.generateNPCForEvent=e=>n.generateForEvent(e),t.generateProtagonist=e=>n.generateProtagonist(e),t.getCurrentCellNPCs=()=>n.getCurrentCellNPCs(),t.setCurrentCellNPCs=e=>n.setCurrentCellNPCs(e),t.addNPCToCell=e=>n.addNPCToCell(e),t.removeNPCFromCell=e=>n.removeNPCFromCell(e),t.findNPC=e=>n.findNPCById(e),t.updateNPCRelationship=(e,t)=>n.updateRelationship(e,t),t.exportNPCData=()=>n.exportData(),t.importNPCData=e=>n.importData(e),t.registerModule('npcSystem',n);try{if(window.parent&&window.parent!==window){const e=window.parent;e.detentionSystem=t,e.detentionSystem&&(e.detentionSystem.generateNPC=t.generateNPC,e.detentionSystem.generateNPCForEvent=t.generateNPCForEvent,e.detentionSystem.generateProtagonist=t.generateProtagonist,e.detentionSystem.getCurrentCellNPCs=t.getCurrentCellNPCs,e.detentionSystem.setCurrentCellNPCs=t.setCurrentCellNPCs,e.detentionSystem.addNPCToCell=t.addNPCToCell,e.detentionSystem.removeNPCFromCell=t.removeNPCFromCell,e.detentionSystem.findNPC=t.findNPC,e.detentionSystem.updateNPCRelationship=t.updateNPCRelationship,e.detentionSystem.exportNPCData=t.exportNPCData,e.detentionSystem.importNPCData=t.importNPCData,e.detentionSystem.generateProtagonist=t.generateProtagonist),console.info('[NPCç³»ç»Ÿ] âœ“ å·²åŒæ­¥åˆ°ä¸»çª—å£ï¼ŒåŒ…æ‹¬æ‰€æœ‰NPCæ–¹æ³•');const n=window.parent.detentionSystem;if(n){const e={hasGenerateNPC:'function'==typeof n.generateNPC,hasGenerateNPCForEvent:'function'==typeof n.generateNPCForEvent,hasGenerateProtagonist:'function'==typeof n.generateProtagonist,hasGetCurrentCellNPCs:'function'==typeof n.getCurrentCellNPCs,hasSetCurrentCellNPCs:'function'==typeof n.setCurrentCellNPCs,modulesCount:n.modules?Object.keys(n.modules).length:0,hasNPCSystemModule:!(!n.getModule||'function'!=typeof n.getModule||!n.getModule('npcSystem'))};e.hasGenerateNPC&&e.hasNPCSystemModule?console.info('[NPCç³»ç»Ÿ] âœ“ ä¸»çª—å£éªŒè¯ç»“æœ:',e):console.error('[NPCç³»ç»Ÿ] âš ï¸ è­¦å‘Šï¼šä¸»çª—å£åŒæ­¥å¯èƒ½ä¸å®Œæ•´ï¼',e)}else console.error('[NPCç³»ç»Ÿ] âŒ é”™è¯¯ï¼šä¸»çª—å£ detentionSystem ä¸ºç©ºï¼')}}catch(e){console.warn('[NPCç³»ç»Ÿ] åŒæ­¥åˆ°ä¸»çª—å£å¤±è´¥:',e)}t.events.on('event_triggered',e=>{const o='string'==typeof e?.id?e.id:void 0;if(o&&['interrogation','lawyer_visit','family_visit','medical_visit','scene_identification'].includes(o)){const i=n.generateForEvent(o);t.events.emit('event_npc_generated',{event:e,npc:i})}}),t.events.on('cell_transfer',e=>{const t=e?.to,o='string'==typeof t?t:'transition',i=Math.floor(5*Math.random())+3,a=n.generate(i,{cellType:o});n.setCurrentCellNPCs(a),console.info(`[NPCç³»ç»Ÿ] ç›‘å®¤è½¬ç§»ï¼Œç”Ÿæˆ${i}ä¸ªæ–°å¥³æ€§å›šçŠ¯NPC`)}),console.info('âœ“ [NPCç³»ç»Ÿ] è„šæœ¬åŠ è½½å®Œæˆ - å¥³æ€§çœ‹å®ˆæ‰€ç‰ˆæœ¬'),window.__NPC_SYSTEM_LOADED__=!0,window.__NPC_SYSTEM_LOADED_TIMESTAMP__=Date.now()});Vue;const l={updateInterval:500,animationDuration:300,trendWindow:5,slowChangeThreshold:1,regressionRate:.005,healthBaseline:70,mentalBaseline:65,parseRetryAttempts:3,parseRetryDelay:100,debugMode:!0};let c={name:'',age:0,crime:'',health:75,mental:70,strength:65,intelligence:70,appearance:{height:0,weight:0,hair:'',condition:''},clothing:{top:'',bottom:'',underwear:'',underpants:'',socks:'',shoes:'',restraints:'æ— ',cleanliness:'æ•´æ´'},currentTask:'',currentThought:'',biggestWorry:'',days:0,stage:'åˆ‘äº‹æ‹˜ç•™',cellType:'è¿‡æ¸¡ç›‘å®¤',changes:{health:[],mental:[],strength:[],intelligence:[]},accumulated:{health:0,mental:0,strength:0,intelligence:0},lastUpdate:Date.now(),stats:{totalUpdates:0,successfulParses:0,failedParses:0,lastParseTime:0}};let d=!1,h=null,g=null;function m(...e){l.debugMode&&console.log('[çŠ¶æ€æ ]',...e)}function u(e){const t=Math.floor(e/1e3),n=Math.floor(t/60),o=Math.floor(n/60),i=Math.floor(o/24);return i>0?`${i}å¤©${o%24}å°æ—¶`:o>0?`${o}å°æ—¶${n%60}åˆ†é’Ÿ`:n>0?`${n}åˆ†é’Ÿ${t%60}ç§’`:`${t}ç§’`}function y(e,t){c.changes[e]||(c.changes[e]=[]),c.changes[e].push({value:t,timestamp:Date.now()}),c.changes[e].length>l.trendWindow&&c.changes[e].shift(),m(`è®°å½•å˜åŒ–: ${e} ${t>0?'+':''}${t}`)}function p(e){if(!c.changes[e]||0===c.changes[e].length)return'stable';const t=c.changes[e].reduce((e,t)=>e+t.value,0);return t>2?'up':t<-2?'down':'stable'}function f(e){try{if(!('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null))return void console.debug('[çŠ¶æ€æ ] èŠå¤©æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥çŠ¶æ€åˆ°è®°å¿†å¢å¼ºæ’ä»¶');try{const e=getVariables({type:'chat'});if(!e||'object'!=typeof e)return void console.debug('[çŠ¶æ€æ ] æ— æ³•è·å–èŠå¤©å˜é‡ï¼Œè·³è¿‡åŒæ­¥çŠ¶æ€åˆ°è®°å¿†å¢å¼ºæ’ä»¶')}catch(e){return void console.debug('[çŠ¶æ€æ ] æµ‹è¯•è·å–èŠå¤©å˜é‡å¤±è´¥ï¼Œè·³è¿‡åŒæ­¥çŠ¶æ€åˆ°è®°å¿†å¢å¼ºæ’ä»¶:',e)}}catch(e){return void console.debug('[çŠ¶æ€æ ] æ£€æŸ¥èŠå¤©æ–‡ä»¶çŠ¶æ€å¤±è´¥ï¼Œè·³è¿‡åŒæ­¥çŠ¶æ€åˆ°è®°å¿†å¢å¼ºæ’ä»¶:',e)}const t=b();if(t)try{'function'==typeof t.updateState?t.updateState(e):'function'==typeof t.setState&&t.setState(e)}catch(e){console.warn('[çŠ¶æ€æ ] åŒæ­¥çŠ¶æ€åˆ°è®°å¿†å¢å¼ºæ’ä»¶æ—¶å‡ºé”™:',e)}}function w(e){if(d)console.warn('[çŠ¶æ€æ ] æ£€æµ‹åˆ°å¹¶å‘æ›´æ–°ï¼Œå·²å¿½ç•¥');else{d=!0;try{if(m('å¼€å§‹æ›´æ–°çŠ¶æ€:',e),c.stats.totalUpdates++,void 0!==e.name&&(c.name=e.name),void 0!==e.age&&(c.age=e.age),void 0!==e.crime&&(c.crime=e.crime),void 0!==e.health){const t=e.health-c.health;if(Math.abs(t)>=l.slowChangeThreshold)c.health=e.health,y('health',t),m(`å¥åº·ç›´æ¥æ›´æ–°: ${c.health} (å˜åŒ–: ${t})`);else if(c.accumulated.health+=t,m(`å¥åº·ç´¯ç§¯å˜åŒ–: ${c.accumulated.health}`),Math.abs(c.accumulated.health)>=l.slowChangeThreshold){const e=Math.floor(c.accumulated.health);c.health+=e,c.accumulated.health-=e,y('health',e),m(`å¥åº·ç´¯ç§¯è§¦å‘: ${c.health} (å˜åŒ–: ${e})`)}}if(void 0!==e.mental){const t=e.mental-c.mental;if(Math.abs(t)>=l.slowChangeThreshold)c.mental=e.mental,y('mental',t),m(`ç²¾ç¥ç›´æ¥æ›´æ–°: ${c.mental} (å˜åŒ–: ${t})`);else if(c.accumulated.mental+=t,m(`ç²¾ç¥ç´¯ç§¯å˜åŒ–: ${c.accumulated.mental}`),Math.abs(c.accumulated.mental)>=l.slowChangeThreshold){const e=Math.floor(c.accumulated.mental);c.mental+=e,c.accumulated.mental-=e,y('mental',e),m(`ç²¾ç¥ç´¯ç§¯è§¦å‘: ${c.mental} (å˜åŒ–: ${e})`)}}if(void 0!==e.strength){const t=e.strength-c.strength;if(Math.abs(t)>=l.slowChangeThreshold)c.strength=e.strength,y('strength',t),m(`åŠ›é‡ç›´æ¥æ›´æ–°: ${c.strength} (å˜åŒ–: ${t})`);else if(c.accumulated.strength+=t,m(`åŠ›é‡ç´¯ç§¯å˜åŒ–: ${c.accumulated.strength}`),Math.abs(c.accumulated.strength)>=l.slowChangeThreshold){const e=Math.floor(c.accumulated.strength);c.strength+=e,c.accumulated.strength-=e,y('strength',e),m(`åŠ›é‡ç´¯ç§¯è§¦å‘: ${c.strength} (å˜åŒ–: ${e})`)}}if(void 0!==e.intelligence){const t=e.intelligence-c.intelligence;if(Math.abs(t)>=l.slowChangeThreshold)c.intelligence=e.intelligence,y('intelligence',t),m(`æ™ºåŠ›ç›´æ¥æ›´æ–°: ${c.intelligence} (å˜åŒ–: ${t})`);else if(c.accumulated.intelligence+=t,m(`æ™ºåŠ›ç´¯ç§¯å˜åŒ–: ${c.accumulated.intelligence}`),Math.abs(c.accumulated.intelligence)>=l.slowChangeThreshold){const e=Math.floor(c.accumulated.intelligence);c.intelligence+=e,c.accumulated.intelligence-=e,y('intelligence',e),m(`æ™ºåŠ›ç´¯ç§¯è§¦å‘: ${c.intelligence} (å˜åŒ–: ${e})`)}}e.appearance&&(void 0!==e.appearance.height&&(c.appearance.height=e.appearance.height),void 0!==e.appearance.weight&&(c.appearance.weight=e.appearance.weight),void 0!==e.appearance.hair&&(c.appearance.hair=e.appearance.hair),void 0!==e.appearance.condition&&(c.appearance.condition=e.appearance.condition)),e.clothing&&(void 0!==e.clothing.top&&(c.clothing.top=e.clothing.top),void 0!==e.clothing.bottom&&(c.clothing.bottom=e.clothing.bottom),void 0!==e.clothing.underwear&&(c.clothing.underwear=e.clothing.underwear),void 0!==e.clothing.underpants&&(c.clothing.underpants=e.clothing.underpants),void 0!==e.clothing.socks&&(c.clothing.socks=e.clothing.socks),void 0!==e.clothing.shoes&&(c.clothing.shoes=e.clothing.shoes),void 0!==e.clothing.restraints&&(c.clothing.restraints=e.clothing.restraints),void 0!==e.clothing.cleanliness&&(c.clothing.cleanliness=e.clothing.cleanliness)),void 0!==e.currentTask&&(c.currentTask=e.currentTask),void 0!==e.currentThought&&(c.currentThought=e.currentThought),void 0!==e.biggestWorry&&(c.biggestWorry=e.biggestWorry),void 0!==e.days&&(c.days=e.days),void 0!==e.stage&&(c.stage=e.stage),void 0!==e.cellType&&(c.cellType=e.cellType),c.lastUpdate=Date.now(),m('çŠ¶æ€æ›´æ–°å®Œæˆ');f({name:c.name,age:c.age,crime:c.crime,health:c.health,mental:c.mental,strength:c.strength,intelligence:c.intelligence,appearance:{...c.appearance},clothing:{...c.clothing},currentTask:c.currentTask,currentThought:c.currentThought,biggestWorry:c.biggestWorry,days:c.days,stage:c.stage,cellType:c.cellType}),S()}catch(e){console.error('[çŠ¶æ€æ ] æ›´æ–°çŠ¶æ€å¤±è´¥:',e)}finally{d=!1}}}function v(e){if(e&&e.nodeType===Node.COMMENT_NODE)try{let t=e.nodeValue||e.textContent||'';if(t=t.trim(),!t)return;if(m('æ£€æµ‹åˆ°æ³¨é‡ŠèŠ‚ç‚¹:',t.substring(0,100)+(t.length>100?'...':'')),t.startsWith('STATUS_UPDATE:')){const e=t.substring(14).trim();m('æå–JSONå­—ç¬¦ä¸²:',e.substring(0,100)+(e.length>100?'...':'')),D(e)}}catch(e){console.error('[çŠ¶æ€æ ] è§£ææ³¨é‡ŠèŠ‚ç‚¹å¤±è´¥:',e)}}function D(e,t=1){try{e=(e=(e=e.trim()).replace(/,(\s*[}\]])/g,'$1')).replace(/[\n\r\t]/g,''),m(`å°è¯•è§£æJSON (ç¬¬${t}æ¬¡):`,e.substring(0,200)+(e.length>200?'...':''));const n=JSON.parse(e);console.log('[çŠ¶æ€æ ] âœ… æˆåŠŸè§£æçŠ¶æ€æ›´æ–°:',n),c.stats.successfulParses++,c.stats.lastParseTime=Date.now(),w(n);const o=window.detentionSystem;return o&&o.events&&o.events.emit('statusUpdated',n),!0}catch(n){const o=n instanceof Error?n.message:String(n);if(console.error(`[çŠ¶æ€æ ] âŒ è§£æå¤±è´¥ (å°è¯• ${t}/${l.parseRetryAttempts}):`,o),console.error('[çŠ¶æ€æ ] åŸå§‹JSON:',e),c.stats.failedParses++,t<l.parseRetryAttempts)return console.log(`[çŠ¶æ€æ ] å°†åœ¨ ${l.parseRetryDelay}ms åé‡è¯•...`),setTimeout(()=>{D(e,t+1)},l.parseRetryDelay),!1;{console.error('[çŠ¶æ€æ ] âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒè§£æ');const n=window.detentionSystem;return n&&n.events&&n.events.emit('parseError',{jsonStr:e,error:o,attempts:t}),!1}}}function C(e){if(e&&e.nodeType===Node.ELEMENT_NODE)try{const t=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT);let n,o=0;for(;n=t.nextNode();)o++,v(n);o>0&&m(`TreeWalker æ‰«æå®Œæˆï¼Œæ‰¾åˆ° ${o} ä¸ªæ³¨é‡ŠèŠ‚ç‚¹`)}catch(e){console.error('[çŠ¶æ€æ ] TreeWalker æ‰«æå¤±è´¥:',e)}}function S(){try{N()&&m('[çŠ¶æ€æ ] çŠ¶æ€å·²åŒæ­¥åˆ°è®°å¿†å¢å¼ºæ’ä»¶ï¼Œè§’è‰²å¡ä¼šè‡ªåŠ¨è¯»å–å¹¶æ˜¾ç¤º')}catch(e){console.error('[çŠ¶æ€æ ] çŠ¶æ€åŒæ­¥æ£€æŸ¥å¤±è´¥:',e)}}function T(){h&&(h.disconnect(),h=null,console.log('[çŠ¶æ€æ ] HTMLæ³¨é‡Šç›‘å¬å·²åœæ­¢'))}function M(){g&&(clearInterval(g),g=null)}function b(){try{const e=window.stMemoryEnhancement||window.MemoryEnhancement||window.memoryEnhancement||window.MemoryEnhancementPlugin||window.memoryEnhancementPlugin;return!e||'function'!=typeof e.ext_getAllTables&&'function'!=typeof e.ext_exportAllTablesAsJson?null:e}catch(e){return console.warn('[çŠ¶æ€æ ] æ£€æµ‹è®°å¿†å¢å¼ºæ’ä»¶æ—¶å‡ºé”™:',e),null}}function N(){const e=b();if(!e)return null;try{let t=null;if(!t){try{const e=getVariables({type:'chat'}),n=getVariables({type:'message',message_id:'latest'}),o=['state','status','character','protagonist','player','main','current','stat_data','memory','memoryEnhancement','stMemoryEnhancement'];for(const i of o){if(e&&'object'==typeof e&&i in e){const n=e[i];if(n&&'object'==typeof n&&('health'in n||'mental'in n)){t=n;break}}if(n&&'object'==typeof n&&i in n){const e=n[i];if(e&&'object'==typeof e&&('health'in e||'mental'in e)){t=e;break}}}if(!t){const o=(e,t='')=>{if(!e||'object'!=typeof e)return null;if(Array.isArray(e)){for(let n=0;n<e.length;n++){const i=o(e[n],`${t}[${n}]`);if(i)return i}return null}if('health'in e&&'mental'in e)return e;for(const[n,i]of Object.entries(e)){const e=o(i,t?`${t}.${n}`:n);if(e)return e}return null},i=o(e);if(i)t=i;else{const e=o(n);e&&(t=e)}}}catch(e){console.warn('[çŠ¶æ€æ ] ä»å˜é‡ç³»ç»Ÿè¯»å–çŠ¶æ€æ—¶å‡ºé”™:',e)}if(!t){if('function'==typeof e.ext_exportAllTablesAsJson)try{const n=e.ext_exportAllTablesAsJson();if(n&&'object'==typeof n&&!Array.isArray(n)){const e=Object.values(n),o=['state','status','character','protagonist','player','main','current','çŠ¶æ€','è§’è‰²','ä¸»è§’','ç©å®¶'];let i=null;for(const t of e)if(t&&'object'==typeof t&&'name'in t&&'string'==typeof t.name&&o.some(e=>t.name.toLowerCase().includes(e.toLowerCase()))){i=t;break}if(!i)for(const t of e)if(t&&'object'==typeof t&&'content'in t&&Array.isArray(t.content)&&t.content.length>=2){const e=t.content[0];if(Array.isArray(e)&&(e.some(e=>e&&e.toLowerCase().includes('health'))||e.some(e=>e&&e.toLowerCase().includes('mental'))||e.some(e=>e&&e.toLowerCase().includes('å¥åº·'))||e.some(e=>e&&e.toLowerCase().includes('ç²¾ç¥')))){i=t;break}}if(i&&Array.isArray(i.content)&&i.content.length>=2){const e=i.content[0],n=i.content[1];if(Array.isArray(e)&&Array.isArray(n)){const o={};e.forEach((e,t)=>{if(e&&void 0!==n[t]){const i=e.toLowerCase().trim(),a=n[t],s='string'==typeof a?parseFloat(a):a,r=isNaN(s)||null===s?a:s;i.includes('health')||i.includes('å¥åº·')?o.health=r:i.includes('mental')||i.includes('ç²¾ç¥')?o.mental=r:i.includes('strength')||i.includes('åŠ›é‡')?o.strength=r:(i.includes('intelligence')||i.includes('æ™ºåŠ›'))&&(o.intelligence=r),o[e]=r}}),('health'in o||'mental'in o)&&(t=o)}}}}catch(e){console.warn('[çŠ¶æ€æ ] ext_exportAllTablesAsJson è°ƒç”¨å¤±è´¥ï¼Œå°è¯• ext_getAllTables:',e)}if(!t&&'function'==typeof e.ext_getAllTables)try{const n=e.ext_getAllTables();if(Array.isArray(n)&&n.length>0){const e=['state','status','character','protagonist','player','main','current','çŠ¶æ€','è§’è‰²','ä¸»è§’','ç©å®¶'];let o=null;for(const t of n)if(t&&t.name&&e.some(e=>t.name.toLowerCase().includes(e.toLowerCase()))){o=t;break}if(!o)for(const e of n){if(!e||!Array.isArray(e.data)||e.data.length<2)continue;const t=e.data[0];if(Array.isArray(t)&&(t.some(e=>e&&e.toLowerCase().includes('health'))||t.some(e=>e&&e.toLowerCase().includes('mental'))||t.some(e=>e&&e.toLowerCase().includes('å¥åº·'))||t.some(e=>e&&e.toLowerCase().includes('ç²¾ç¥')))){o=e;break}}if(o&&Array.isArray(o.data)&&o.data.length>=2){const e=o.data[0],n=o.data[1];if(Array.isArray(e)&&Array.isArray(n)){const o={};e.forEach((e,t)=>{if(e&&void 0!==n[t]){const i=e.toLowerCase().trim(),a=n[t],s='string'==typeof a?parseFloat(a):a,r=isNaN(s)||null===s?a:s;i.includes('health')||i.includes('å¥åº·')?o.health=r:i.includes('mental')||i.includes('ç²¾ç¥')?o.mental=r:i.includes('strength')||i.includes('åŠ›é‡')?o.strength=r:(i.includes('intelligence')||i.includes('æ™ºåŠ›'))&&(o.intelligence=r),o[e]=r}}),('health'in o||'mental'in o)&&(t=o)}}}}catch(e){console.warn('[çŠ¶æ€æ ] ext_getAllTables è°ƒç”¨å¤±è´¥ï¼Œè·³è¿‡:',e)}}}if(!t||'object'!=typeof t)return null;if(void 0===t.health&&void 0===t.mental)return null;return{name:t.name??c.name??void 0,age:t.age??c.age??void 0,crime:t.crime??c.crime??void 0,health:t.health??c.health??70,mental:t.mental??c.mental??65,strength:t.strength??c.strength??50,intelligence:t.intelligence??c.intelligence??55,appearance:t.appearance?{height:t.appearance.height??c.appearance.height,weight:t.appearance.weight??c.appearance.weight,hair:t.appearance.hair??c.appearance.hair,condition:t.appearance.condition??c.appearance.condition}:{...c.appearance},clothing:t.clothing?{top:t.clothing.top??c.clothing.top,bottom:t.clothing.bottom??c.clothing.bottom,underwear:t.clothing.underwear??c.clothing.underwear,underpants:t.clothing.underpants??c.clothing.underpants,socks:t.clothing.socks??c.clothing.socks,shoes:t.clothing.shoes??c.clothing.shoes,restraints:t.clothing.restraints??c.clothing.restraints,cleanliness:t.clothing.cleanliness??c.clothing.cleanliness}:{...c.clothing},currentTask:t.currentTask??c.currentTask??void 0,currentThought:t.currentThought??c.currentThought??void 0,biggestWorry:t.biggestWorry??c.biggestWorry??void 0,days:t.days??t.day??c.days??0,stage:t.stage??c.stage??void 0,cellType:t.cellType??t.cell_type??c.cellType??void 0}}catch(e){return console.warn('[çŠ¶æ€æ ] ä»è®°å¿†å¢å¼ºæ’ä»¶è·å–çŠ¶æ€æ—¶å‡ºé”™:',e),null}}const E={version:'3.5.6',state:c,initialize(){console.log('[çŠ¶æ€æ ] åˆå§‹åŒ–çŠ¶æ€æ ç³»ç»Ÿ v3.5.6 (ä½¿ç”¨è®°å¿†å¢å¼ºæ’ä»¶ï¼Œç”±è§’è‰²å¡æ˜¾ç¤ºçŠ¶æ€æ )'),b()?console.log('[çŠ¶æ€æ ] è®°å¿†å¢å¼ºæ’ä»¶å¯ç”¨ï¼ŒçŠ¶æ€æ ç”±è§’è‰²å¡è¯»å–å¹¶æ˜¾ç¤º'):console.log('[çŠ¶æ€æ ] è®°å¿†å¢å¼ºæ’ä»¶ä¸å¯ç”¨ï¼ŒçŠ¶æ€æ åŠŸèƒ½ç”±è§’è‰²å¡å¤„ç†'),h&&h.disconnect(),console.log('[çŠ¶æ€æ ] å¯åŠ¨HTMLæ³¨é‡Šç›‘å¬...'),h=new MutationObserver(e=>{for(const t of e){if('childList'===t.type)for(const e of t.addedNodes)e.nodeType===Node.COMMENT_NODE?v(e):e.nodeType===Node.ELEMENT_NODE&&C(e);'characterData'===t.type&&t.target.nodeType===Node.COMMENT_NODE&&v(t.target)}}),h.observe(document.body,{childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!1}),console.log('[çŠ¶æ€æ ] æ‰§è¡Œåˆå§‹æ‰«æ...'),setTimeout(()=>{C(document.body)},1e3),console.log('[çŠ¶æ€æ ] HTMLæ³¨é‡Šç›‘å¬å·²å¯åŠ¨');const e=window.detentionSystem;e&&e.events&&(e.events.on('stateChanged',e=>{m('çŠ¶æ€å˜åŒ–äº‹ä»¶:',e),e&&'object'==typeof e&&w(e)}),e.events.on('dayAdvanced',e=>{if(m('æ—¥æœŸæ¨è¿›äº‹ä»¶:',e),e&&'object'==typeof e){const t=e;void 0!==t.days&&(c.days=t.days),void 0!==t.stage&&(c.stage=t.stage),void 0!==t.cellType&&(c.cellType=t.cellType),S()}})),console.log('[çŠ¶æ€æ ] åˆå§‹åŒ–å®Œæˆ'),console.log('[çŠ¶æ€æ ] è°ƒè¯•æ¨¡å¼:',l.debugMode?'å¼€å¯':'å…³é—­')},destroy(){console.log('[çŠ¶æ€æ ] å¼€å§‹é”€æ¯...'),T(),M();const e=window.detentionSystem;e&&e.events&&(e.events.off('stateChanged',()=>{}),e.events.off('dayAdvanced',()=>{})),console.log('[çŠ¶æ€æ ] é”€æ¯å®Œæˆ')},getState(){const e=N();if(e)return m('[çŠ¶æ€æ ] ä»è®°å¿†å¢å¼ºæ’ä»¶è·å–çŠ¶æ€ï¼ˆè§’è‰²å¡ä¼šè¯»å–å¹¶æ˜¾ç¤ºï¼‰'),e;m('[çŠ¶æ€æ ] è®°å¿†å¢å¼ºæ’ä»¶ä¸å¯ç”¨ï¼Œä½¿ç”¨çŠ¶æ€æ æ¨¡å—å†…éƒ¨çŠ¶æ€');return{name:c.name,age:c.age,crime:c.crime,health:c.health,mental:c.mental,strength:c.strength,intelligence:c.intelligence,appearance:{...c.appearance},clothing:{...c.clothing},currentTask:c.currentTask,currentThought:c.currentThought,biggestWorry:c.biggestWorry,days:c.days,stage:c.stage,cellType:c.cellType}},modifyValue(e,t,n=''){if(void 0===c[e])return void console.error(`[çŠ¶æ€æ ] æœªçŸ¥çš„çŠ¶æ€é”®: ${e}`);const o=c[e],i=Math.max(0,Math.min(100,o+t));if(i!==o){c[e]=i,y(e,t),console.log(`[çŠ¶æ€æ ] ${e} å˜åŒ–: ${o} â†’ ${i} (${t>0?'+':''}${t}) ${n?`åŸå› : ${n}`:''}`);const a=window.detentionSystem;a&&a.events&&a.events.emit('valueChanged',{key:e,oldValue:o,newValue:i,delta:t,reason:n}),f(E.getState()),S()}},getTrendAnalysis:()=>({health:{value:c.health,trend:p('health'),changes:c.changes.health||[]},mental:{value:c.mental,trend:p('mental'),changes:c.changes.mental||[]},strength:{value:c.strength,trend:p('strength'),changes:c.changes.strength||[]},intelligence:{value:c.intelligence,trend:p('intelligence'),changes:c.changes.intelligence||[]}}),getCurrentStage:()=>({days:c.days,stage:c.stage,cellType:c.cellType}),parseStatusUpdate:D,reset(){c={name:'',age:0,crime:'',health:75,mental:70,strength:65,intelligence:70,appearance:{height:0,weight:0,hair:'',condition:''},clothing:{top:'',bottom:'',underwear:'',underpants:'',socks:'',shoes:'',restraints:'æ— ',cleanliness:'æ•´æ´'},currentTask:'',currentThought:'',biggestWorry:'',days:0,stage:'åˆ‘äº‹æ‹˜ç•™',cellType:'è¿‡æ¸¡ç›‘å®¤',changes:{health:[],mental:[],strength:[],intelligence:[]},accumulated:{health:0,mental:0,strength:0,intelligence:0},lastUpdate:Date.now(),stats:{totalUpdates:0,successfulParses:0,failedParses:0,lastParseTime:0}},S(),console.log('[çŠ¶æ€æ ] çŠ¶æ€å·²é‡ç½®')},exportData:()=>({version:'3.5.6',timestamp:Date.now(),state:JSON.parse(JSON.stringify(c))}),importData(e){if(!e||!e.state)return console.error('[çŠ¶æ€æ ] æ— æ•ˆçš„å¯¼å…¥æ•°æ®'),!1;try{return e.version&&'3.5.6'!==e.version&&console.warn(`[çŠ¶æ€æ ] æ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…: ${e.version} vs 3.5.6`),c=e.state,c.changes||(c.changes={health:[],mental:[],strength:[],intelligence:[]}),c.accumulated||(c.accumulated={health:0,mental:0,strength:0,intelligence:0}),c.stats||(c.stats={totalUpdates:0,successfulParses:0,failedParses:0,lastParseTime:0}),c.lastUpdate=Date.now(),S(),console.log('[çŠ¶æ€æ ] æ•°æ®å¯¼å…¥æˆåŠŸ'),!0}catch(e){return console.error('[çŠ¶æ€æ ] å¯¼å…¥æ•°æ®å¤±è´¥:',e),!1}}};E.debug={scanAllComments:function(){console.log('[çŠ¶æ€æ ] å¼€å§‹æ‰«æé¡µé¢ä¸­çš„æ‰€æœ‰æ³¨é‡Š...');const e=document.createTreeWalker(document.body,NodeFilter.SHOW_COMMENT),t=[];let n;for(;n=e.nextNode();){const e=(n.nodeValue||n.textContent||'').trim();t.push({content:e.substring(0,100)+(e.length>100?'...':''),fullContent:e,isStatusUpdate:e.startsWith('STATUS_UPDATE:'),length:e.length}),e.startsWith('STATUS_UPDATE:')&&(console.log('[çŠ¶æ€æ ] âœ… æ‰¾åˆ°çŠ¶æ€æ›´æ–°æ³¨é‡Š:',e.substring(0,100)),v(n))}return console.log(`[çŠ¶æ€æ ] æ‰«æå®Œæˆï¼Œå…±æ‰¾åˆ° ${t.length} ä¸ªæ³¨é‡Š`),console.log('[çŠ¶æ€æ ] å…¶ä¸­çŠ¶æ€æ›´æ–°æ³¨é‡Š:',t.filter(e=>e.isStatusUpdate).length),console.table(t),t},getDiagnostics:function(){const e={version:'3.5.6',timestamp:(new Date).toLocaleString('zh-CN'),observer:{active:null!==h,status:h?'è¿è¡Œä¸­':'å·²åœæ­¢'},state:{lastUpdate:new Date(c.lastUpdate).toLocaleString('zh-CN'),timeSinceUpdate:Date.now()-c.lastUpdate,timeSinceUpdateFormatted:u(Date.now()-c.lastUpdate)},stats:{totalUpdates:c.stats.totalUpdates,successfulParses:c.stats.successfulParses,failedParses:c.stats.failedParses,successRate:c.stats.totalUpdates>0?`${(c.stats.successfulParses/c.stats.totalUpdates*100).toFixed(2)}%`:'N/A',lastParseTime:c.stats.lastParseTime>0?new Date(c.stats.lastParseTime).toLocaleString('zh-CN'):'ä»æœª'},currentState:E.getState(),config:l};return console.log('[çŠ¶æ€æ ] è¯Šæ–­ä¿¡æ¯'),console.log('[çŠ¶æ€æ ] ç‰ˆæœ¬:',e.version),console.log('[çŠ¶æ€æ ] æ—¶é—´:',e.timestamp),console.log('[çŠ¶æ€æ ] è§‚å¯Ÿå™¨çŠ¶æ€:',e.observer.status),console.log('[çŠ¶æ€æ ] æœ€åæ›´æ–°:',e.state.lastUpdate),console.log('[çŠ¶æ€æ ] è·ç¦»ä¸Šæ¬¡æ›´æ–°:',e.state.timeSinceUpdateFormatted),console.log('[çŠ¶æ€æ ] ç»Ÿè®¡ä¿¡æ¯:',e.stats),console.log('[çŠ¶æ€æ ] å½“å‰çŠ¶æ€:',e.currentState),e},parseCommentNode:v,checkForStatusUpdate:C},$(()=>{console.info('[çŠ¶æ€æ ] è„šæœ¬å¼€å§‹åŠ è½½ v3.5.6 (å·²é€‚é…è®°å¿†å¢å¼ºæ’ä»¶)');const e=window.detentionSystem;if(e){e.getState=()=>E.getState(),e.modifyValue=(e,t,n)=>E.modifyValue(e,t,n),e.getTrendAnalysis=()=>E.getTrendAnalysis(),e.getCurrentStage=()=>E.getCurrentStage(),e.parseStatusUpdate=e=>E.parseStatusUpdate(e),e.registerModule('statusPanel',E),window.detentionSystem.statusPanel=E;try{window.parent&&window.parent!==window&&(window.parent.detentionSystem=e,console.info('[çŠ¶æ€æ ] âœ“ å·²åŒæ­¥åˆ°ä¸»çª—å£'))}catch(e){}e.events.on('initialized',()=>{console.info('[çŠ¶æ€æ ] æ ¸å¿ƒç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œå¼€å§‹åˆå§‹åŒ–çŠ¶æ€æ '),setTimeout(()=>{try{E.initialize(),console.info('[çŠ¶æ€æ ] âœ“ çŠ¶æ€æ åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('[çŠ¶æ€æ ] âœ— çŠ¶æ€æ åˆå§‹åŒ–å¤±è´¥:',e)}},500)}),e.initialized&&setTimeout(()=>{try{E.initialize(),console.info('[çŠ¶æ€æ ] âœ“ çŠ¶æ€æ åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('[çŠ¶æ€æ ] âœ— çŠ¶æ€æ åˆå§‹åŒ–å¤±è´¥:',e)}},500),console.info('[çŠ¶æ€æ ] è„šæœ¬åŠ è½½å®Œæˆ v3.5.6 (å·²é€‚é…è®°å¿†å¢å¼ºæ’ä»¶)')}else console.error('[çŠ¶æ€æ ] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½')}),$(window).on('pagehide',()=>{console.log('[çŠ¶æ€æ ] é¡µé¢å³å°†å¸è½½ï¼Œæ‰§è¡Œæ¸…ç†...'),T(),M()});const k={detention_rules:{name:'detention_rules',displayName:'æ ¸å¿ƒè§„åˆ™åº“',description:'çœ‹å®ˆæ‰€åŸºæœ¬è§„èŒƒã€ç®¡ç†åˆ¶åº¦ã€è¿è§„å¤„ç½šæœºåˆ¶ç­‰æ ¸å¿ƒè§„åˆ™',priority:10,keywords:['ç›‘è§„','å¤„ç½š','çºªå¾‹','è§„å®š','è¿è§„','ç®¡æ•™','æŠ¥å‘Š','ç®¡ç†åˆ¶åº¦','åŸºæœ¬è§„èŒƒ','è¿è§„å¤„ç½š','çœ‹å®ˆæ‰€è§„åˆ™','ç›‘ç®¡åˆ¶åº¦','è¿å','å¤„åˆ†','è­¦å‘Š','ç¦é—­','æ‰£åˆ†','è€ƒæ ¸'],autoLoad:!0,position:'before_char',depth:4,fallbackEntries:[]},internal_basic_procedures:{name:'internal_basic_procedures',displayName:'ç”Ÿæ´»ç»†èŠ‚åº“',description:'å…¥æ‰€æœèº«ã€åƒé¥­ã€æ´—æ¾¡ã€å®¡è®¯ç­‰æ—¥å¸¸ç”Ÿæ´»æµç¨‹çš„è¯¦ç»†æè¿°',priority:9,keywords:['åƒé¥­','æ´—æ¾¡','ç¡è§‰','å¦‚å•','å®¡è®¯','ä¼šè§','æ”¾é£','ç‚¹å','åŠ³åŠ¨','å…¥æ‰€','æœèº«','æ—¥å¸¸ç”Ÿæ´»','ç”Ÿæ´»æµç¨‹','æ—¥å¸¸æµç¨‹','ç”Ÿæ´»ç»†èŠ‚','èµ·åºŠ','æ´—æ¼±','ç”¨é¤','å°±å¯','ä½“æ£€','ç™»è®°','åˆ†é…'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]},internal_basic_legal:{name:'internal_basic_legal',displayName:'æ³•å¾‹ç»†èŠ‚åº“',description:'è¯¦ç»†çš„å¸æ³•æµç¨‹ï¼ŒåŒ…æ‹¬é€®æ•ã€èµ·è¯‰ã€ä¸€å®¡ã€äºŒå®¡ã€æ­»åˆ‘å¤æ ¸ã€æ­»åˆ‘æ‰§è¡Œï¼ˆæªå†³/æ³¨å°„/ç»åˆ‘ï¼‰ç­‰ï¼Œè¿˜åŒ…æ‹¬æ³•å¾‹æ–‡ä¹¦æ ·æœ¬ã€ç¨‹åºæ€§è¯è¯­æ¨¡æ¿',priority:8,keywords:['æ‰¹æ•','èµ·è¯‰','å¼€åº­','åˆ¤å†³','æ‰§è¡Œ','å¾‹å¸ˆ','å–ä¿','ä¿é‡Š','é€®æ•','ä¸€å®¡','äºŒå®¡','æ­»åˆ‘å¤æ ¸','æ­»åˆ‘æ‰§è¡Œ','æªå†³','æ³¨å°„','ç»åˆ‘','å¸æ³•æµç¨‹','æ³•å¾‹æ–‡ä¹¦','ç¨‹åºæ€§è¯è¯­','ç¨‹åºæ€§','å¸æ³•ç¨‹åº','æ£€å¯Ÿé™¢','æ³•é™¢','æ³•å®˜','æ£€å¯Ÿå®˜','è¾©æŠ¤','ä¸Šè¯‰','ç»ˆå®¡'],autoLoad:!1,position:'before_char',depth:4,fallbackEntries:[]},legal_knowledge:{name:'legal_knowledge',displayName:'ä¸“ä¸šçŸ¥è¯†åº“',description:'è¯¦ç»†æ³•å¾‹æ¡æ–‡ã€é‡åˆ‘æ ‡å‡†ã€å¸æ³•ç¨‹åº',priority:7,keywords:['ç½ªå','é‡åˆ‘','æ³•å¾‹','åˆ‘æ³•','åˆ‘æœŸ','ç¼“åˆ‘','å‡é‡Š','æ³•å¾‹æ¡æ–‡','é‡åˆ‘æ ‡å‡†','å¸æ³•ç¨‹åº','åˆ‘æ³•æ¡æ–‡','æ³•å¾‹ä¾æ®','ä»è½»','ä»é‡','å‡è½»','åŠ é‡','ç´¯çŠ¯','è‡ªé¦–','ç«‹åŠŸ','è®¤ç½ªè®¤ç½š'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]},environment_descriptions:{name:'environment_descriptions',displayName:'ç¯å¢ƒæå†™åº“',description:'å„åœºæ‰€çš„è¯¦ç»†ç¯å¢ƒæå†™æ¨¡æ¿ï¼ŒåŒ…å«æªå†³ã€æ³¨å°„ã€ç»åˆ‘ä¸‰ç§æ‰§è¡Œæ–¹å¼çš„ä¸åŒåˆ‘åœºç¯å¢ƒ',priority:6,keywords:['ç›‘å®¤','å®¡è®¯å®¤','ä¼šè§å®¤','ç¦é—­å®¤','æ³•é™¢','åˆ‘åœº','èµ°å»Š','é“é—¨','ç¯å¢ƒæå†™','åœºæ‰€','åˆ‘åœºç¯å¢ƒ','æ‰§è¡Œæ–¹å¼','æªå†³','æ³¨å°„','ç»åˆ‘','çœ‹å®ˆæ‰€','ç›‘ç‹±','æ³•åº­','ç¾æŠ¼å®¤','æå®¡å®¤','åŒ»åŠ¡å®¤','é£Ÿå ‚','æ“åœº'],autoLoad:!1,position:'before_char',depth:4,fallbackEntries:[]},narrative_enhancements:{name:'narrative_enhancements',displayName:'å™äº‹å¢å¼ºåº“',description:'è½¬æŠ˜ã€å›å¿†ã€æ¢¦å¢ƒã€åè½¬ç­‰å™äº‹å¢å¼ºåŠŸèƒ½',priority:5,keywords:['è½¬æŠ˜','å›å¿†','æ¢¦å¢ƒ','åè½¬','é«˜æ½®','å¿ƒç†','æƒ…ç»ª','å™äº‹å¢å¼º','å™äº‹','å›å¿†æ€','æ¢¦å¢ƒ','å¹»è§‰','é—ªå›','å†…å¿ƒ','æ€ç»ª','æƒ…æ„Ÿ','æ„Ÿå—','æƒ³æ³•','æ€è€ƒ','åæ€'],autoLoad:!1,position:'after_char',depth:4,fallbackEntries:[]}};function P(){if(fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'worldbook_loader.ts:safeGetWorldbookNames',message:'å°è¯•è·å–ä¸–ç•Œä¹¦åç§°',data:{hasGlobalFn:void 0!==window.getWorldbookNames,hasTavernHelper:'undefined'!=typeof window&&!!window.TavernHelper,hasTavernHelperFn:'undefined'!=typeof window&&!!window.TavernHelper&&'function'==typeof window.TavernHelper.getWorldbookNames},timestamp:Date.now(),sessionId:'debug-session',runId:'initial',hypothesisId:'A'})}).catch(()=>{}),void 0!==window.getWorldbookNames)return window.getWorldbookNames();if('undefined'!=typeof window&&window.TavernHelper){const e=window.TavernHelper;if('function'==typeof e.getWorldbookNames)return e.getWorldbookNames()}throw new Error('getWorldbookNames å‡½æ•°ä¸å¯ç”¨ã€‚è¯·ç¡®ä¿ Tavern Helper å·²æ­£ç¡®åŠ è½½ï¼Œå¹¶æ£€æŸ¥ getWorldbookNames æ˜¯å¦åœ¨å…¨å±€ä½œç”¨åŸŸæˆ– window.TavernHelper ä¸­å¯ç”¨ã€‚')}console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] v5.1.0 å¯åŠ¨...'),$(()=>{const e=window.detentionSystem;if(!e)return console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] æ ¸å¿ƒç³»ç»ŸæœªåŠ è½½'),void console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] è¯·ç¡®ä¿ core.ts å·²æ­£ç¡®åŠ è½½');const t=e;t.characterId='detention_center',console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²è®¾ç½®è§’è‰²æ ‡è¯†');const n={loaded:new Map,loading:new Map,initialized:!1,fallbackMode:!1,characterWorldbookId:null,failedBooks:new Set,async findCharacterWorldbook(){console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æŸ¥æ‰¾è§’è‰²ä¸“å±ä¸–ç•Œä¹¦...');try{const e=getCharWorldbookNames('current');return e.primary?(console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰¾åˆ°è§’è‰²ä¸»ä¸–ç•Œä¹¦: ${e.primary}`),this.characterWorldbookId=e.primary,e.primary):e.additional.length>0?(console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰¾åˆ°è§’è‰²é™„åŠ ä¸–ç•Œä¹¦: ${e.additional[0]}`),this.characterWorldbookId=e.additional[0],e.additional[0]):(console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  æœªæ‰¾åˆ°è§’è‰²ä¸“å±ä¸–ç•Œä¹¦'),null)}catch(e){return console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] æŸ¥æ‰¾è§’è‰²ä¸–ç•Œä¹¦å¤±è´¥:',e),null}},async loadWorldbook(e){const t=k[e];if(!t)throw new Error(`æœªçŸ¥çš„çŸ¥è¯†åº“: ${e}`);if(this.failedBooks?.has(e))throw console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  ${t.displayName} ä¹‹å‰åŠ è½½å¤±è´¥ï¼Œè·³è¿‡ä»¥é¿å…é‡å¤é”™è¯¯`),new Error(`ä¸–ç•Œä¹¦ "${e}" ä¹‹å‰åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸–ç•Œä¹¦æ•°æ®æ ¼å¼`);if(this.loaded.has(e))return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] ${t.displayName} å·²åŠ è½½ï¼Œè·³è¿‡`),this.loaded.get(e);if(this.loading.has(e))return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] ${t.displayName} æ­£åœ¨åŠ è½½ï¼Œç­‰å¾…...`),await this.loading.get(e);const n=this._loadWorldbookInternal(e,t);this.loading.set(e,n);try{const o=await n;return this.loaded.set(e,o),this.failedBooks?.has(e)&&(this.failedBooks.delete(e),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ${t.displayName} åŠ è½½æˆåŠŸï¼Œå·²ä»å¤±è´¥åˆ—è¡¨ç§»é™¤`)),o}catch(e){throw e}finally{this.loading.delete(e)}},async _loadWorldbookInternal(e,t){console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] å¼€å§‹åŠ è½½: ${t.displayName} (${e})`);try{const n=P();let o=null;const i=n.find(e=>e===t.displayName);if(i)o=i,console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ç²¾ç¡®åŒ¹é…ä¸­æ–‡åç§°: "${t.displayName}"`);else if(n.includes(t.name))o=t.name,console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ç²¾ç¡®åŒ¹é…è‹±æ–‡æ ‡è¯†: "${t.name}"`);else{const e=n.find(e=>e.includes(t.displayName)||t.displayName.includes(e)||e.includes(t.name)||t.name.includes(e));e&&(o=e,console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ¨¡ç³ŠåŒ¹é…: "${e}"`))}if(!o){const o=n.join(', ');throw new Error(`æœªæ‰¾åˆ°ä¸–ç•Œä¹¦: ${t.displayName} (${e})\nå¯ç”¨çš„ä¸–ç•Œä¹¦: ${o}\næç¤º: è¯·ç¡®ä¿çŸ¥è¯†åº“åç§°ä¸é…ç½®ä¸­çš„ displayName æˆ– name åŒ¹é…`)}let a,s;try{s=await getWorldbook(o),a=Array.isArray(s)?s:s&&'object'==typeof s&&!Array.isArray(s)&&'entries'in s&&Array.isArray(s.entries)?s.entries:Array.isArray(s)?s:[]}catch(n){const i=n instanceof Error?n.message:String(n);console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  ${t.displayName} åŠ è½½å¤±è´¥ (ä½¿ç”¨åç§°: ${o}):`,i);const a=i.includes('map')||i.includes('undefined')||i.includes('Cannot read properties');a&&(console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  æ£€æµ‹åˆ°æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¯èƒ½æ˜¯ä¸–ç•Œä¹¦ "${o}" çš„æ•°æ®æŸåæˆ–ä¸å®Œæ•´`),console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  é”™è¯¯è¯¦æƒ…: ${i}`),console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  å»ºè®®: 1) æ£€æŸ¥ä¸–ç•Œä¹¦ "${o}" æ˜¯å¦åœ¨é…’é¦†ä¸­å­˜åœ¨ 2) æ£€æŸ¥ä¸–ç•Œä¹¦æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡® 3) å°è¯•é‡æ–°å¯¼å…¥ä¸–ç•Œä¹¦`),this.failedBooks&&(this.failedBooks.add(e),console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  å·²å°† "${e}" æ ‡è®°ä¸ºå¤±è´¥ï¼Œåç»­å°†è·³è¿‡æ­¤ä¸–ç•Œä¹¦`)));throw new Error(`è·å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥: ${i}\nä¸–ç•Œä¹¦åç§°: ${o}\né…ç½®åç§°: ${e} (${t.displayName})\né”™è¯¯ç±»å‹: ${a?'æ•°æ®æ ¼å¼é”™è¯¯ï¼ˆå¯èƒ½æ˜¯ä¸–ç•Œä¹¦æ•°æ®æŸåæˆ–ä¸å®Œæ•´ï¼‰':'æœªçŸ¥é”™è¯¯'}\nå»ºè®®: `+(a?'è¯·æ£€æŸ¥ä¸–ç•Œä¹¦æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°å¯¼å…¥ä¸–ç•Œä¹¦':'è¯·æ£€æŸ¥ä¸–ç•Œä¹¦æ˜¯å¦å­˜åœ¨ï¼Œæˆ–è”ç³»å¼€å‘è€…'))}if(null==a)throw new Error(`ä¸–ç•Œä¹¦ "${o}" è¿”å›å€¼ä¸ºç©º (undefined/null)\nåŸå§‹æ•°æ®ç±»å‹: ${typeof s}\næç¤º: è¯·ç¡®ä¿ä¸–ç•Œä¹¦æ ¼å¼æ­£ç¡®ï¼Œåº”åŒ…å« entries æ•°ç»„`);if(!Array.isArray(a))throw new Error(`ä¸–ç•Œä¹¦ "${o}" è¿”å›å€¼ä¸æ˜¯æ•°ç»„ (ç±»å‹: ${typeof a})\nåŸå§‹æ•°æ®ç±»å‹: ${typeof s}\næç¤º: ä¸–ç•Œä¹¦æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼ŒgetWorldbook åº”è¿”å› entries æ•°ç»„æˆ–åŒ…å« entries å­—æ®µçš„å¯¹è±¡`);if(0===a.length)throw new Error('ä¸–ç•Œä¹¦ä¸ºç©º');const r=getCharWorldbookNames('current');return r.additional.includes(o)||(await rebindCharWorldbooks('current',{primary:r.primary,additional:[...r.additional,o]}),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²ç»‘å®šåˆ°è§’è‰²å¡: ${o}`)),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ${t.displayName} åŠ è½½æˆåŠŸ (${a.length} æ¡ç›®)`),{name:e,displayName:t.displayName,entries:a,fallback:!1,loadedAt:Date.now()}}catch(n){const o=n instanceof Error?n.message:String(n);if(console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  ${t.displayName} åŠ è½½å¤±è´¥:`,o),t.fallbackEntries&&t.fallbackEntries.length>0)return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âš  ${t.displayName} ä½¿ç”¨é™çº§ç‰ˆæœ¬ (${t.fallbackEntries.length} æ¡ç›®)`),this.fallbackMode=!0,{name:e,displayName:t.displayName,entries:t.fallbackEntries,fallback:!0,error:o,loadedAt:Date.now()};throw n}},async predictiveCache(e){if(!e||'string'!=typeof e)return;console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰§è¡Œé¢„æµ‹æ€§ç¼“å­˜...');const t=[];for(const n in k){const o=k[n];if(this.loaded.has(n))continue;let i=0,a=0;for(const t of o.keywords)if(e.includes(t)){i++;a+=t.length>=3?2:1,o.description&&o.description.includes(t)&&(a+=1)}if(o.description){const t=o.description.match(/[\u4e00-\u9fa5]{2,}/g)||[];for(const n of t)e.includes(n)&&n.length>=2&&(a+=.5)}if(i>0){const e=10*o.priority+a;t.push({bookName:n,score:i,priority:o.priority,weightedScore:e})}}t.sort((e,t)=>Math.abs(t.weightedScore-e.weightedScore)>1?t.weightedScore-e.weightedScore:t.priority!==e.priority?t.priority-e.priority:t.score-e.score),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹éœ€è¦åŠ è½½ ${t.length} ä¸ªçŸ¥è¯†åº“`);const n=t.filter(e=>e.weightedScore>10).slice(0,3);if(0!==n.length)for(const e of n)if(this.failedBooks?.has(e.bookName))console.debug(`[çŸ¥è¯†åº“åŠ è½½å™¨] è·³è¿‡å·²çŸ¥å¤±è´¥çš„ä¸–ç•Œä¹¦: ${k[e.bookName].displayName}`);else{console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹æ€§åŠ è½½: ${k[e.bookName].displayName} (åŒ¹é…å…³é”®è¯: ${e.score}, ç»¼åˆè¯„åˆ†: ${e.weightedScore.toFixed(1)})`);try{await this.loadWorldbook(e.bookName)}catch(t){const n=t instanceof Error?t.message:String(t);console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹æ€§åŠ è½½å¤±è´¥: ${e.bookName}`,n)}}else console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æœªæ‰¾åˆ°è¶³å¤ŸåŒ¹é…çš„çŸ¥è¯†åº“ï¼Œè·³è¿‡é¢„æµ‹æ€§åŠ è½½')},getRelevantEntries(e,t=5){if(!e||'string'!=typeof e)return[];const n=[];this.loaded.forEach((e,t)=>{if(e.entries&&Array.isArray(e.entries))for(const o of e.entries)n.push({entry:o,bookName:t,bookDisplayName:e.displayName,priority:k[t]?.priority||0})});const o=n.map(t=>{let n=0;const o=t.entry,i=o.keys||o.key||[];for(const t of i)if(e.includes(t)){n+=t.length>=3?15:10,o.name&&o.name.includes(t)&&(n+=5)}if(o.name&&e.includes(o.name)&&(n+=20),o.content){const t=o.content.substring(0,100);e.includes(t.substring(0,10))&&(n+=3)}return n+=t.priority||0,o.constant&&(n+=30),{entry:t.entry,score:n,bookName:t.bookName,bookDisplayName:t.bookDisplayName}});o.sort((e,t)=>{if(Math.abs(t.score-e.score)>5)return t.score-e.score;const n=k[e.bookName]?.priority||0;return(k[t.bookName]?.priority||0)-n});const i=o.filter(e=>e.score>0).slice(0,t).map(e=>e.entry);return i.length>0&&console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰¾åˆ° ${i.length} ä¸ªç›¸å…³æ¡ç›® (æœ€é«˜åˆ†: ${o[0]?.score||0}, æ¥æº: ${o[0]?.bookDisplayName||'æœªçŸ¥'})`),i},async dynamicLoad(e){if(!e||'string'!=typeof e||e.length<3)return;console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰§è¡ŒåŠ¨æ€åŠ è½½...');const t=[];for(const n in k){const o=k[n];if(this.loaded.has(n))continue;let i=0,a='',s=0;for(const t of o.keywords)e.includes(t)&&(i++,t.length>s&&(s=t.length,a=t));if(i>0){const e=10*o.priority+2*i+s;t.push({bookName:n,keyword:a,priority:o.priority,matchCount:i,score:e})}}if(0===t.length)return void console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æœªè§¦å‘åŠ¨æ€åŠ è½½');t.sort((e,t)=>Math.abs(t.score-e.score)>2?t.score-e.score:t.priority-e.priority),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] è§¦å‘ ${t.length} ä¸ªçŸ¥è¯†åº“çš„åŠ¨æ€åŠ è½½`);const n=t.slice(0,3);for(const e of n){console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] åŠ¨æ€åŠ è½½: ${k[e.bookName].displayName} (è§¦å‘è¯: ${e.keyword}, åŒ¹é…æ•°: ${e.matchCount}, è¯„åˆ†: ${e.score})`);try{await this.loadWorldbook(e.bookName)}catch(t){console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] åŠ¨æ€åŠ è½½å¤±è´¥: ${e.bookName}`,t)}}},getStatus(){const e={initialized:this.initialized,fallbackMode:this.fallbackMode,characterWorldbook:this.characterWorldbookId,loaded:[],loading:[],available:[]};this.loaded.forEach((t,n)=>{e.loaded.push({name:n,displayName:t.displayName,entries:t.entries.length,fallback:t.fallback,error:t.error,loadedAt:new Date(t.loadedAt).toLocaleTimeString()})}),this.loading.forEach((t,n)=>{e.loading.push({name:n,displayName:k[n]?.displayName||n})});for(const t in k)this.loaded.has(t)||this.loading.has(t)||e.available.push({name:t,displayName:k[t].displayName,autoLoad:k[t].autoLoad});return e},async unloadWorldbook(e){if(!this.loaded.has(e))return void console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] ${e} æœªåŠ è½½`);console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] å¸è½½: ${k[e]?.displayName||e}`);const t=getCharWorldbookNames('current');if(this.loaded.get(e)){const n=P().find(t=>t===e||t.includes(e));if(n){const e=t.additional.filter(e=>e!==n);await rebindCharWorldbooks('current',{primary:t.primary,additional:e})}}this.loaded.delete(e)},async reloadWorldbook(e){return console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] é‡æ–°åŠ è½½: ${k[e]?.displayName||e}`),await this.unloadWorldbook(e),await this.loadWorldbook(e)},async initialize(){if(this.initialized)return void console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] åˆå§‹åŒ–...'),await this.findCharacterWorldbook();let e=0,t=[];for(;e<40;){try{if(t=P(),t.length>0){console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ ä¸–ç•Œä¹¦åˆ—è¡¨å·²å°±ç»ª (${t.length} ä¸ª)`),console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] å¯ç”¨ä¸–ç•Œä¹¦: ${t.join(', ')}`);break}}catch(e){}console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] ç­‰å¾…ä¸–ç•Œä¹¦åˆ—è¡¨... (${e+1}/40)`),await new Promise(e=>setTimeout(e,500)),e++}console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å·²é…ç½®çš„çŸ¥è¯†åº“:');for(const e in k){const n=k[e],o=t.some(e=>e===n.displayName||e===n.name||e.includes(n.displayName));console.info(`  - ${n.displayName} (${e}): ä¼˜å…ˆçº§=${n.priority}, è‡ªåŠ¨åŠ è½½=${n.autoLoad?'æ˜¯':'å¦'}, å¯ç”¨=`+(o?'âœ“':'âœ—'))}const n=[];for(const e in k)k[e].autoLoad&&n.push(e);console.info(`[çŸ¥è¯†åº“åŠ è½½å™¨] éœ€è¦è‡ªåŠ¨åŠ è½½ ${n.length} ä¸ªçŸ¥è¯†åº“`);for(const e of n)try{await this.loadWorldbook(e)}catch(t){console.warn(`[çŸ¥è¯†åº“åŠ è½½å™¨] è‡ªåŠ¨åŠ è½½å¤±è´¥: ${e}`,t)}this.initialized=!0;const o=this.getStatus();if(console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ åˆå§‹åŒ–å®Œæˆ'),console.table(o.loaded),this.fallbackMode){console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  å·²è¿›å…¥é™çº§æ¨¡å¼'),console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  éƒ¨åˆ†çŸ¥è¯†åº“ä½¿ç”¨äº†å†…ç½®é™çº§æ•°æ®'),console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] âš  è„šæœ¬å°†è‡ªåŠ¨é€€å‡ºï¼Œäº¤ç”±è§’è‰²å¡å¤„ç†');const e=o.loaded.filter(e=>e.fallback);console.table(e),setTimeout(()=>{console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] é™çº§æ¨¡å¼ï¼šå¼€å§‹è‡ªåŠ¨å¸è½½...'),this.shutdown()},3e3)}else console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰€æœ‰çŸ¥è¯†åº“æ­£å¸¸åŠ è½½ï¼Œè„šæœ¬ä¿æŒè¿è¡Œ')},shutdown(){console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰§è¡Œå…³é—­æµç¨‹...'),this.loaded.clear(),this.loading.clear(),delete t.loadWorldbook,delete t.unloadWorldbook,delete t.reloadWorldbook,delete t.predictiveCache,delete t.getRelevantEntries,delete t.getWorldbookStatus,delete t.dynamicLoad,this.initialized=!1,this.fallbackMode=!1,console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²å®Œå…¨å¸è½½ï¼Œäº¤ç”±è§’è‰²å¡å¤„ç†'),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] è„šæœ¬ç”Ÿå‘½å‘¨æœŸç»“æŸ')}};t.loadWorldbook=e=>n.loadWorldbook(e),t.unloadWorldbook=e=>n.unloadWorldbook(e),t.reloadWorldbook=e=>n.reloadWorldbook(e),t.predictiveCache=e=>n.predictiveCache(e),t.dynamicLoad=e=>n.dynamicLoad(e),t.getRelevantEntries=(e,t)=>n.getRelevantEntries(e,t),t.getWorldbookStatus=()=>n.getStatus(),t.registerModule('worldbook',n);try{window.parent&&window.parent!==window&&(window.parent.detentionSystem=t,console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²åŒæ­¥åˆ°ä¸»çª—å£'))}catch(e){}console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ å·²æ³¨å†Œåˆ°æ ¸å¿ƒç³»ç»Ÿ'),t.events.on('event_triggered',e=>{const t=e;t?.description&&n.predictiveCache(t.description).catch(e=>{console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] é¢„æµ‹æ€§ç¼“å­˜å¤±è´¥:',e)})}),t.events.on('user_input',e=>{const t=e;t?.text&&t.text.length>5&&n.dynamicLoad(t.text).catch(e=>{console.warn('[çŸ¥è¯†åº“åŠ è½½å™¨] åŠ¨æ€åŠ è½½å¤±è´¥:',e)})}),$(()=>{console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å‡†å¤‡åˆå§‹åŒ–...'),setTimeout(async()=>{console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å¼€å§‹è‡ªåŠ¨åˆå§‹åŒ–...');try{await n.initialize(),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ è‡ªåŠ¨åˆå§‹åŒ–å®Œæˆ')}catch(e){console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ— è‡ªåŠ¨åˆå§‹åŒ–å¤±è´¥:',e),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] ğŸ’¡ è¯·æ‰‹åŠ¨æ‰§è¡Œ: window.initWorldbookLoader()')}},2e3)}),window.initWorldbookLoader=async function(){if(console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] æ‰‹åŠ¨åˆå§‹åŒ–...'),n.initialized)return console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] å·²ç»åˆå§‹åŒ–è¿‡äº†'),n.getStatus();try{return await n.initialize(),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ æ‰‹åŠ¨åˆå§‹åŒ–å®Œæˆ'),n.getStatus()}catch(e){throw console.error('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ— æ‰‹åŠ¨åˆå§‹åŒ–å¤±è´¥:',e),e}},console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] âœ“ è„šæœ¬åŠ è½½å®Œæˆ'),console.info('[çŸ¥è¯†åº“åŠ è½½å™¨] ğŸ’¡ å¦‚éœ€æ‰‹åŠ¨åˆå§‹åŒ–ï¼Œè¯·æ‰§è¡Œ: window.initWorldbookLoader()')});try{'undefined'!=typeof window&&window.location&&('localhost'===window.location.hostname||'127.0.0.1'===window.location.hostname||window.location.hostname.startsWith('192.168.')||window.location.hostname.startsWith('10.')||window.location.hostname.startsWith('172.'))&&fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:å…¥å£ç‚¹',message:'è„šæœ¬æ–‡ä»¶å¼€å§‹æ‰§è¡Œ',data:{windowExists:'undefined'!=typeof window,windowDetentionSystemExists:void 0!==window.detentionSystem,windowDetentionSystemType:typeof window.detentionSystem,userAgent:'undefined'!=typeof navigator?navigator.userAgent:'N/A',isIframe:'undefined'!=typeof window&&window.parent!==window,currentUrl:'undefined'!=typeof window&&window.location?window.location.href:'N/A'},timestamp:Date.now(),sessionId:'debug-session',runId:'script-load-debug',hypothesisId:'A'})}).catch(()=>{})}catch(e){}console.info('ğŸ”µ [çœ‹å®ˆæ‰€æ¨¡æ‹Ÿå™¨] è„šæœ¬æ–‡ä»¶å¼€å§‹æ‰§è¡Œï¼'),window.__DETENTION_SYSTEM_LOADED__=!0,window.__DETENTION_SYSTEM_LOADED_TIMESTAMP__=Date.now(),console.log('[DEBUG-HYP-A] index.ts:13 - è„šæœ¬æ–‡ä»¶å¼€å§‹åŠ è½½',{timestamp:Date.now(),windowExists:'undefined'!=typeof window,windowDetentionSystem:typeof window.detentionSystem,location:'index.ts:13',hypothesisId:'A'}),console.info('[çœ‹å®ˆæ‰€æ¨¡æ‹Ÿå™¨] è„šæœ¬æ–‡ä»¶å·²åŠ è½½ï¼Œå¼€å§‹æ‰§è¡Œ...'),console.info('[çœ‹å®ˆæ‰€æ¨¡æ‹Ÿå™¨] å¦‚æœçœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜è„šæœ¬æ­£åœ¨æ‰§è¡Œï¼');try{'undefined'!=typeof window&&window.location&&('localhost'===window.location.hostname||'127.0.0.1'===window.location.hostname||window.location.hostname.startsWith('192.168.')||window.location.hostname.startsWith('10.')||window.location.hostname.startsWith('172.'))&&fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:æ¨¡å—å¯¼å…¥å‰',message:'å‡†å¤‡å¯¼å…¥æ¨¡å—',data:{windowDetentionSystemExists:void 0!==window.detentionSystem},timestamp:Date.now(),sessionId:'debug-session',runId:'script-load-debug',hypothesisId:'B'})}).catch(()=>{})}catch(e){}setTimeout(()=>{try{'undefined'!=typeof window&&window.location&&('localhost'===window.location.hostname||'127.0.0.1'===window.location.hostname||window.location.hostname.startsWith('192.168.')||window.location.hostname.startsWith('10.')||window.location.hostname.startsWith('172.'))&&fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:æ¨¡å—å¯¼å…¥å',message:'æ‰€æœ‰æ¨¡å—å¯¼å…¥å®Œæˆï¼Œæ£€æŸ¥window.detentionSystem',data:{windowDetentionSystemExists:void 0!==window.detentionSystem,windowDetentionSystemType:typeof window.detentionSystem,hasPing:void 0!==window.detentionSystem&&'function'==typeof window.detentionSystem.ping,pingResult:void 0!==window.detentionSystem&&'function'==typeof window.detentionSystem.ping?window.detentionSystem.ping():'N/A',version:void 0!==window.detentionSystem&&window.detentionSystem.version?window.detentionSystem.version:'N/A'},timestamp:Date.now(),sessionId:'debug-session',runId:'script-load-debug',hypothesisId:'C'})}).catch(()=>{})}catch(e){}},100),console.log('[DEBUG-HYP-A] index.ts:22 - æ‰€æœ‰æ¨¡å—å¯¼å…¥å®Œæˆ',{timestamp:Date.now(),windowDetentionSystemExists:void 0!==window.detentionSystem,windowDetentionSystemType:typeof window.detentionSystem,windowDetentionSystemValue:window.detentionSystem?'object':'undefined',location:'index.ts:22',hypothesisId:'A'}),console.info('[çœ‹å®ˆæ‰€æ¨¡æ‹Ÿå™¨] æ‰€æœ‰æ¨¡å—å·²åŠ è½½å®Œæˆ'),console.log('ğŸ”µ [çœ‹å®ˆæ‰€æ¨¡æ‹Ÿå™¨] è„šæœ¬æ‰§è¡Œå®Œæˆï¼'),console.log('ğŸ”µ window.detentionSystem:',void 0!==window.detentionSystem?'âœ… å­˜åœ¨':'âŒ ä¸å­˜åœ¨');
//# sourceMappingURL=detention-system.js.map