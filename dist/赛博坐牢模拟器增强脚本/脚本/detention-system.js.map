{"version":3,"file":"detention-system.js","mappings":"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KACA,OACA,OACA,QACA,MACA,OACA,MACA,KACA,KACA,MACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,cACVC,MAAO,EACPC,gBAAiB,IAEnBG,gBAAiB,CACfpzB,KAAM,kBACN4yB,YAAa,QACbhmB,YAAa,mBACbF,SAAU,EACVmmB,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,OACA,OACA,OACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,QAEFC,UAAU,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,IAEnBI,yBAA0B,CACxBrzB,KAAM,2BACN4yB,YAAa,QACbhmB,YAAa,uCACbF,SAAU,EACVmmB,SAAU,CACR,KACA,MACA,MACA,MACA,KACA,KACA,KACA,KACA,OACA,KACA,OACA,OACA,KACA,KACA,KACA,MACA,KACA,KACA,MACA,MACA,MACA,KACA,MAEFC,UAAU,EACVC,SAAU,cACVC,MAAO,EACPC,gBAAiB,IAEnBK,uBAAwB,CACtBtzB,KAAM,yBACN4yB,YAAa,QACbhmB,YAAa,qBACbF,SAAU,EACVmmB,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,KA8BrB,SAASM,IAIP,QAAiD,IAArCrzB,OAAeszB,kBAEzB,OAAQtzB,OAAeszB,oBAIzB,GAAsB,oBAAXtzB,QAA2BA,OAAeuzB,aAAc,CACjE,MAAMC,EAAUxzB,OAAeuzB,aAC/B,GAAwC,mBAA7BC,EAAOF,kBAEhB,OAAOE,EAAOF,mBAElB,CAIA,MAAM,IAAI7yB,MACR,2GAIJ,CA9BA9F,QAAQC,KAAK,yBAiCb2G,EAAE,KACA,MAAM2R,EAASlT,OAAOE,gBACtB,IAAKgT,EAGH,OAFAvY,QAAQsB,MAAM,yBACdtB,QAAQsB,MAAM,8BAKhB,MAAMkE,EAAK+S,EAGV/S,EAAkDszB,YAAc,mBACjE94B,QAAQC,KAAK,sBAGb,MA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","sources":["src://tavern_helper_template/src///core.ts","src://tavern_helper_template/src///event_system.ts","src://tavern_helper_template/src///npc_system.ts","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/src///status_panel.ts","src://tavern_helper_template/src///worldbook_loader.ts","src://tavern_helper_template/src///index.ts"],"sourcesContent":["export {};\r\n\r\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\r\ndeclare const $: JQueryStaticLike;\r\n\r\n//  CORS \r\n\r\nconsole.info('[] ...');\r\n\r\ntype BudgetStatus = 'critical' | 'warning' | 'normal';\r\n\r\ninterface BudgetInfo {\r\n  used: number;\r\n  total: number;\r\n  percentage: string;\r\n  remaining: number;\r\n  status: BudgetStatus;\r\n}\r\n\r\ninterface DetentionConfig {\r\n  tokenBudget: number;\r\n  fallbackBudget: number;\r\n  compressionQuality: number;\r\n  cacheExpiry: number;\r\n  healthCheckInterval: number;\r\n  healthCheckTimeout: number;\r\n}\r\n\r\ninterface DetentionErrorInfo {\r\n  message: string;\r\n  context: string;\r\n  timestamp: number;\r\n  stack?: string;\r\n}\r\n\r\ninterface DetentionState {\r\n  mode: 'detecting' | 'external' | 'fallback';\r\n  tokenUsed: number;\r\n  lastHealthCheck: number;\r\n  errors: DetentionErrorInfo[];\r\n}\r\n\r\ninterface CacheEntry<T> {\r\n  value: T;\r\n  expiry: number | null;\r\n}\r\n\r\ninterface CacheManager {\r\n  set<T>(key: string, value: T, ttl?: number | null): void;\r\n  get<T>(key: string): T | null;\r\n  has(key: string): boolean;\r\n  delete(key: string): void;\r\n  clear(): void;\r\n  cleanup(): void;\r\n}\r\n\r\ninterface EnvironmentInfo {\r\n  isSillyTavern: boolean;\r\n  version: string | null;\r\n  hasHelper: boolean;\r\n  helperVersion: string | null;\r\n  hasDataTable: boolean;\r\n}\r\n\r\nclass EventEmitter {\r\n  private readonly events = new Map<string, Array<(data?: unknown) => void>>();\r\n\r\n  on(event: string, callback: (data?: unknown) => void) {\r\n    if (!this.events.has(event)) {\r\n      this.events.set(event, []);\r\n    }\r\n    this.events.get(event)!.push(callback);\r\n  }\r\n\r\n  off(event: string, callback: (data?: unknown) => void) {\r\n    const callbacks = this.events.get(event);\r\n    if (!callbacks) return;\r\n    const index = callbacks.indexOf(callback);\r\n    if (index > -1) callbacks.splice(index, 1);\r\n  }\r\n\r\n  emit(event: string, data?: unknown) {\r\n    const callbacks = this.events.get(event);\r\n    if (!callbacks) return;\r\n    callbacks.forEach(cb => {\r\n      try {\r\n        cb(data);\r\n      } catch (error) {\r\n        console.error(`[]  ${event} :`, error);\r\n      }\r\n    });\r\n  }\r\n\r\n  once(event: string, callback: (data?: unknown) => void) {\r\n    const wrapper = (data?: unknown) => {\r\n      callback(data);\r\n      this.off(event, wrapper);\r\n    };\r\n    this.on(event, wrapper);\r\n  }\r\n}\r\n\r\ninterface DetentionSystem {\r\n  version: string;\r\n  initialized: boolean;\r\n  modules: Record<string, unknown>;\r\n  config: DetentionConfig;\r\n  state: DetentionState;\r\n  events: EventEmitter;\r\n  CacheManager: CacheManager;\r\n  EventEmitter: typeof EventEmitter;\r\n  ping(): boolean;\r\n  checkTokenBudget(): BudgetInfo;\r\n  updateTokenUsage(tokens: number): BudgetInfo;\r\n  compressContent(content: unknown, quality?: number | null): string;\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n  handleError(error: unknown, context?: string): void;\r\n  detectEnvironment(): EnvironmentInfo;\r\n  initialize(): void;\r\n  initializeState?(state: {\r\n    name?: string;\r\n    age?: number;\r\n    crime?: string;\r\n    health?: number;\r\n    mental?: number;\r\n    strength?: number;\r\n    intelligence?: number;\r\n    appearance?: {\r\n      height?: number;\r\n      weight?: number;\r\n      hair?: string;\r\n      condition?: string;\r\n    };\r\n    clothing?: {\r\n      top?: string;\r\n      bottom?: string;\r\n      underwear?: string;\r\n      underpants?: string;\r\n      socks?: string;\r\n      shoes?: string;\r\n      restraints?: string;\r\n      cleanliness?: string;\r\n    };\r\n    currentTask?: string;\r\n    currentThought?: string;\r\n    biggestWorry?: string;\r\n  }): void;\r\n}\r\n\r\ndeclare global {\r\n  interface Window {\r\n    detentionSystem?: DetentionSystem;\r\n  }\r\n}\r\n\r\nconst cacheStore: Map<string, CacheEntry<unknown>> = new Map();\r\nlet cacheCleanupTimer: ReturnType<typeof setInterval> | undefined;\r\n\r\nfunction createCacheManager(): CacheManager {\r\n  return {\r\n    set<T>(key: string, value: T, ttl?: number | null) {\r\n      const expiry = ttl ? Date.now() + ttl * 1000 : null;\r\n      cacheStore.set(key, { value, expiry });\r\n    },\r\n    get<T>(key: string) {\r\n      const item = cacheStore.get(key);\r\n      if (!item) return null;\r\n      if (item.expiry !== null && Date.now() > item.expiry) {\r\n        cacheStore.delete(key);\r\n        return null;\r\n      }\r\n      return item.value as T;\r\n    },\r\n    has(key: string) {\r\n      return this.get(key) !== null;\r\n    },\r\n    delete(key: string) {\r\n      cacheStore.delete(key);\r\n    },\r\n    clear() {\r\n      cacheStore.clear();\r\n    },\r\n    cleanup() {\r\n      const now = Date.now();\r\n      for (const [key, item] of cacheStore.entries()) {\r\n        if (item.expiry !== null && now > item.expiry) {\r\n          cacheStore.delete(key);\r\n        }\r\n      }\r\n    },\r\n  };\r\n}\r\n\r\nfunction normalizeError(error: unknown): Error {\r\n  if (error instanceof Error) return error;\r\n  return new Error(typeof error === 'string' ? error : JSON.stringify(error));\r\n}\r\n\r\nfunction bootstrapDetentionSystem(): DetentionSystem {\r\n  //  CORS \r\n\r\n  const events = new EventEmitter();\r\n  const CacheManager = createCacheManager();\r\n\r\n  //  CORS \r\n\r\n  const system: DetentionSystem = {\r\n    version: '3.2.0',\r\n    initialized: false,\r\n    modules: {},\r\n    config: {\r\n      tokenBudget: 100000,\r\n      fallbackBudget: 40000,\r\n      compressionQuality: 0.8,\r\n      cacheExpiry: 600000,\r\n      healthCheckInterval: 500,\r\n      healthCheckTimeout: 3000,\r\n    },\r\n    state: {\r\n      mode: 'detecting',\r\n      tokenUsed: 0,\r\n      lastHealthCheck: 0,\r\n      errors: [],\r\n    },\r\n    events,\r\n    CacheManager,\r\n    EventEmitter,\r\n\r\n    ping() {\r\n      system.state.lastHealthCheck = Date.now();\r\n      return true;\r\n    },\r\n\r\n    checkTokenBudget() {\r\n      const total = system.state.mode === 'external' ? system.config.tokenBudget : system.config.fallbackBudget;\r\n      const used = system.state.tokenUsed;\r\n      const percentage = (used / total) * 100;\r\n\r\n      const status: BudgetStatus = percentage > 95 ? 'critical' : percentage > 85 ? 'warning' : 'normal';\r\n\r\n      return {\r\n        used,\r\n        total,\r\n        percentage: percentage.toFixed(2),\r\n        remaining: total - used,\r\n        status,\r\n      };\r\n    },\r\n\r\n    updateTokenUsage(tokens: number) {\r\n      system.state.tokenUsed += tokens;\r\n      const budget = system.checkTokenBudget();\r\n\r\n      if (budget.status === 'warning') {\r\n        console.warn(`[Token] :  ${budget.percentage}%`);\r\n        system.events.emit('token_warning', budget);\r\n      } else if (budget.status === 'critical') {\r\n        console.error(`[Token] :  ${budget.percentage}%`);\r\n        system.events.emit('token_critical', budget);\r\n      }\r\n\r\n      return budget;\r\n    },\r\n\r\n    compressContent(content: unknown, quality: number | null = null) {\r\n      const text = typeof content === 'string' ? content : JSON.stringify(content);\r\n      const actualQuality = quality ?? system.config.compressionQuality;\r\n\r\n      let compressed = text\r\n        .replace(/\\s+/g, ' ')\r\n        .replace(/\\n\\s*\\n/g, '\\n')\r\n        .trim();\r\n\r\n      if (actualQuality < 0.9) {\r\n        compressed = compressed.replace(//g, ',').replace(//g, '.').replace(//g, ';').replace(//g, ':');\r\n      }\r\n\r\n      const originalSize = text.length;\r\n      const compressedSize = compressed.length;\r\n      const ratio = ((1 - compressedSize / originalSize) * 100).toFixed(2);\r\n\r\n      console.info(`[] : ${originalSize} -> : ${compressedSize} ( ${ratio}%)`);\r\n\r\n      return compressed;\r\n    },\r\n\r\n    registerModule(name: string, module: unknown) {\r\n      if (system.modules[name]) {\r\n        console.warn(`[]  ${name} `);\r\n      }\r\n      system.modules[name] = module;\r\n      console.info(`[]  ${name} `);\r\n      system.events.emit('module_registered', { name, module });\r\n\r\n      // \r\n      try {\r\n        if (window.parent && window.parent !== window) {\r\n          (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem = system;\r\n          (window.parent as any).DS = system;\r\n        }\r\n      } catch (e) {\r\n        // \r\n      }\r\n    },\r\n\r\n    getModule<T = unknown>(name: string) {\r\n      return system.modules[name] as T | undefined;\r\n    },\r\n\r\n    handleError(error: unknown, context: string = 'unknown') {\r\n      const normalized = normalizeError(error);\r\n      const errorInfo: DetentionErrorInfo = {\r\n        message: normalized.message,\r\n        context,\r\n        timestamp: Date.now(),\r\n        stack: normalized.stack,\r\n      };\r\n\r\n      system.state.errors.push(errorInfo);\r\n      console.error(`[]  [${context}]:`, normalized);\r\n      system.events.emit('error', errorInfo);\r\n\r\n      if (system.state.errors.length > 100) {\r\n        system.state.errors.shift();\r\n      }\r\n    },\r\n\r\n    detectEnvironment() {\r\n      const env: EnvironmentInfo = {\r\n        isSillyTavern: false,\r\n        version: null,\r\n        hasHelper: false,\r\n        helperVersion: null,\r\n        hasDataTable: false,\r\n      };\r\n\r\n      const isSillyTavernAvailable = typeof SillyTavern !== 'undefined';\r\n      if (isSillyTavernAvailable || $('#send_textarea').length > 0) {\r\n        env.isSillyTavern = true;\r\n        if (typeof getTavernVersion === 'function') {\r\n          env.version = getTavernVersion() ?? null;\r\n        }\r\n      }\r\n\r\n      if (typeof getTavernHelperVersion === 'function') {\r\n        env.hasHelper = true;\r\n        env.helperVersion = getTavernHelperVersion() ?? null;\r\n      }\r\n\r\n      const windowWithTable = window as typeof window & {\r\n        insertRow?: unknown;\r\n        updateRow?: unknown;\r\n      };\r\n      if (typeof windowWithTable.insertRow === 'function' && typeof windowWithTable.updateRow === 'function') {\r\n        env.hasDataTable = true;\r\n      }\r\n\r\n      return env;\r\n    },\r\n\r\n    initialize() {\r\n      if (system.initialized) {\r\n        console.warn('[] ');\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      const env = system.detectEnvironment();\r\n      console.info('[] :', env);\r\n\r\n      if (!env.isSillyTavern) {\r\n        console.warn('[] SillyTavern');\r\n      }\r\n\r\n      system.state.mode = 'external';\r\n      system.initialized = true;\r\n\r\n      console.info('[] ');\r\n      console.info(`[] : ${system.version}`);\r\n      console.info(`[] : ${system.state.mode}`);\r\n      console.info(`[] Token: ${system.config.tokenBudget}`);\r\n\r\n      system.events.emit('initialized', { env, state: system.state });\r\n    },\r\n\r\n    // \r\n    initializeState(state?: {\r\n      name?: string;\r\n      age?: number;\r\n      crime?: string;\r\n      health?: number;\r\n      mental?: number;\r\n      strength?: number;\r\n      intelligence?: number;\r\n      appearance?: {\r\n        height?: number;\r\n        weight?: number;\r\n        hair?: string;\r\n        condition?: string;\r\n      };\r\n      clothing?: {\r\n        top?: string;\r\n        bottom?: string;\r\n        underwear?: string;\r\n        underpants?: string;\r\n        socks?: string;\r\n        shoes?: string;\r\n        restraints?: string;\r\n        cleanliness?: string;\r\n      };\r\n      currentTask?: string;\r\n      currentThought?: string;\r\n      biggestWorry?: string;\r\n    }) {\r\n      if (!state) {\r\n        console.warn('[] initializeState ');\r\n        return;\r\n      }\r\n\r\n      console.info('[] :', state);\r\n\r\n      //  stateChanged \r\n      system.events.emit('stateChanged', state);\r\n\r\n      // \r\n      const statusPanel = system.getModule('statusPanel') as\r\n        | {\r\n            initialize?: () => void;\r\n            getState?: () => unknown;\r\n          }\r\n        | undefined;\r\n\r\n      if (statusPanel) {\r\n        console.info('[]  ');\r\n      } else {\r\n        console.warn('[]  ');\r\n      }\r\n    },\r\n  };\r\n\r\n  //  CORS \r\n\r\n  return system;\r\n}\r\n\r\nfunction ensureCacheCleanup(system: DetentionSystem) {\r\n  if (!cacheCleanupTimer) {\r\n    cacheCleanupTimer = setInterval(() => system.CacheManager.cleanup(), 60000);\r\n  }\r\n}\r\n\r\nfunction stopCacheCleanup() {\r\n  if (cacheCleanupTimer) {\r\n    clearInterval(cacheCleanupTimer);\r\n    cacheCleanupTimer = undefined;\r\n  }\r\n}\r\n\r\n//  CORS \r\n\r\n// \r\nif (!window.detentionSystem) {\r\n  //  CORS \r\n\r\n  try {\r\n    window.detentionSystem = bootstrapDetentionSystem();\r\n    //  DS \r\n    (window as any).DS = window.detentionSystem;\r\n    console.info('[]   DS  window.detentionSystem ');\r\n\r\n    //  CORS \r\n\r\n    //  CORS \r\n\r\n    console.info('[]  ');\r\n    console.info('[] window.detentionSystem :', typeof window.detentionSystem);\r\n    console.info('[] window.detentionSystem :', window.detentionSystem);\r\n    // \r\n    (window as any).__DETENTION_SYSTEM_CORE_LOADED__ = true;\r\n    (window as any).__DETENTION_SYSTEM_VERSION__ = window.detentionSystem.version;\r\n\r\n    //  iframe \r\n    try {\r\n      if (window.parent && window.parent !== window) {\r\n        //  CORS \r\n\r\n        //  jQuery ready \r\n        $(() => {\r\n          try {\r\n            (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem =\r\n              window.detentionSystem;\r\n            //  DS\r\n            (window.parent as any).DS = window.detentionSystem;\r\n            console.info('[]  iframe ');\r\n\r\n            //  CORS \r\n          } catch (e) {\r\n            console.warn('[]  :', e);\r\n\r\n            //  CORS \r\n          }\r\n        });\r\n\r\n        //  jQuery ready\r\n        try {\r\n          (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem =\r\n            window.detentionSystem;\r\n          (window.parent as any).DS = window.detentionSystem;\r\n          console.info('[]  iframe ');\r\n\r\n          //  CORS \r\n        } catch (e) {\r\n          console.debug('[]  jQuery ready :', e);\r\n        }\r\n      } else {\r\n        //  CORS \r\n      }\r\n    } catch (e) {\r\n      console.warn('[]  iframe :', e);\r\n\r\n      //  CORS \r\n    }\r\n  } catch (error) {\r\n    //  CORS \r\n    throw error;\r\n  }\r\n} else {\r\n  //  CORS \r\n}\r\n\r\n//  CORS \r\n\r\n$(() => {\r\n  //  CORS \r\n\r\n  console.info('[] jQuery ready');\r\n\r\n  // \r\n  if (!window.detentionSystem) {\r\n    //  CORS \r\n\r\n    console.warn('[]  jQuery ready ');\r\n    window.detentionSystem = bootstrapDetentionSystem();\r\n    //  DS \r\n    if (!(window as any).DS) {\r\n      (window as any).DS = window.detentionSystem;\r\n      console.info('[]   DS  window.detentionSystem ');\r\n    }\r\n    console.info('[] jQuery ready ');\r\n  } else {\r\n    //  CORS \r\n  }\r\n\r\n  const system = window.detentionSystem!;\r\n\r\n  //  DS \r\n  if (!(window as any).DS) {\r\n    (window as any).DS = system;\r\n    console.info('[]   DS  window.detentionSystem ');\r\n  }\r\n\r\n  console.info('[] :', {\r\n    exists: !!system,\r\n    version: system.version,\r\n    initialized: system.initialized,\r\n  });\r\n\r\n  ensureCacheCleanup(system);\r\n\r\n  console.info('[]  1 ...');\r\n  setTimeout(() => {\r\n    console.info('[] setTimeout ...');\r\n    try {\r\n      system.initialize();\r\n      console.info('[] initialize() ');\r\n\r\n      // \r\n      try {\r\n        if (window.parent && window.parent !== window && system) {\r\n          (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem = system;\r\n          //  DS\r\n          (window.parent as any).DS = system;\r\n          console.info('[]  ');\r\n\r\n          //  CORS \r\n        }\r\n      } catch (e) {\r\n        console.warn('[]  :', e);\r\n\r\n        //  CORS \r\n      }\r\n\r\n      //  DS\r\n      if (!(window as any).DS && system) {\r\n        (window as any).DS = system;\r\n        console.info('[]   DS ');\r\n      }\r\n    } catch (error) {\r\n      console.error('[] initialize() :', error);\r\n      system.handleError(error, 'initialize');\r\n    }\r\n  }, 1000);\r\n});\r\n\r\n$(window).on('pagehide', () => {\r\n  stopCacheCleanup();\r\n});\r\n\r\n// ==========  ==========\r\n// ID\r\nlet skipMessageId: number | null = null;\r\n\r\n$(() => {\r\n  console.info('[] ...');\r\n\r\n  // \r\n  const skipCommandMessages = new Set<number>();\r\n\r\n  // \r\n  //  eventMakeFirst  quick-reply \r\n  eventMakeFirst(tavern_events.USER_MESSAGE_RENDERED, async (message_id: number) => {\r\n    try {\r\n      const messages = getChatMessages(message_id, { role: 'user' });\r\n      const userMessage = messages[0];\r\n      if (!userMessage || !userMessage.message) return;\r\n\r\n      const userInput = userMessage.message;\r\n\r\n      //  data \r\n      const messageData = userMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n      const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n      const isSystemByContent =\r\n        userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n      if (isSystemEventMessage || isSystemByContent) {\r\n        //  event_triggered \r\n        //  quick-reply \r\n        // \r\n        //\r\n        // \r\n        // 1.  eventMakeFirst\r\n        // 2.  GENERATION_STARTED \r\n        // 3.  waitingForEventResponse \r\n\r\n        //  CORS \r\n\r\n        // \r\n        if (waitingForEventResponse) {\r\n          //  quick-reply\r\n          try {\r\n            await stopAllGeneration();\r\n            //  CORS \r\n          } catch (error) {\r\n            console.warn('[] USER_MESSAGE_RENDERED:', error);\r\n          }\r\n        }\r\n\r\n        return; // \r\n      }\r\n\r\n      // \r\n      // 151515\r\n      const skipDayPattern =\r\n        /(?:|||)\\s*(\\d+|[]?|[][]?|[]??[]?|[]??[]??[]?|)\\s*[\\s]*/;\r\n      const skipDayMatch = userInput.match(skipDayPattern);\r\n\r\n      if (skipDayMatch) {\r\n        // \r\n        try {\r\n          await setChatMessages([{ message_id, is_hidden: true, message: '.' }], { refresh: 'all' });\r\n          skipCommandMessages.add(message_id);\r\n          console.info(`[]  USER_MESSAGE_RENDERED (message_id: ${message_id})`);\r\n\r\n          //  CORS \r\n        } catch (error) {\r\n          console.warn('[] USER_MESSAGE_RENDERED:', error);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('[] USER_MESSAGE_RENDERED:', error);\r\n    }\r\n  });\r\n\r\n  // AI\r\n  eventOn(tavern_events.GENERATE_BEFORE_COMBINE_PROMPTS, () => {\r\n    // \r\n    if (skipCommandMessages.size > 0) {\r\n      // \r\n      skipCommandMessages.clear();\r\n      // \r\n    }\r\n\r\n    // \r\n    try {\r\n      const messages = getChatMessages(-1, { role: 'user' });\r\n      const lastUserMessage = messages[messages.length - 1];\r\n      if (lastUserMessage) {\r\n        const messageData = lastUserMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n        const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n        const userInput = lastUserMessage.message || '';\r\n        const isSystemByContent =\r\n          userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n        if (isSystemEventMessage || isSystemByContent) {\r\n          //  CORS \r\n          // GENERATE_BEFORE_COMBINE_PROMPTS \r\n          //  MESSAGE_SENT  USER_MESSAGE_RENDERED \r\n        }\r\n      }\r\n    } catch (error) {\r\n      // \r\n    }\r\n  });\r\n\r\n  // \r\n  //  ID triggerSlash \r\n  let lastTriggerTime: number | null = null;\r\n  let lastTriggerEventName: string | null = null;\r\n  const generationTracking: Array<{\r\n    generation_id: string | null;\r\n    type: string;\r\n    timestamp: number;\r\n    triggerTime: number | null;\r\n    eventName: string | null;\r\n    source: 'iframe' | 'tavern';\r\n  }> = [];\r\n\r\n  //  iframe_events  tavern_events  GENERATION_STARTED\r\n  eventOn(iframe_events.GENERATION_STARTED, (generation_id: string) => {\r\n    //  CORS \r\n\r\n    if (skipMessageId !== null) {\r\n      console.info(`[]   (generation_id: ${generation_id})`);\r\n\r\n      //  CORS \r\n\r\n      stopGenerationById(generation_id).then(success => {\r\n        if (success) {\r\n          console.info(`[]   (generation_id: ${generation_id})`);\r\n        } else {\r\n          console.warn(`[]  (generation_id: ${generation_id})`);\r\n        }\r\n        // \r\n        skipMessageId = null;\r\n      });\r\n      return;\r\n    }\r\n\r\n    // \r\n    try {\r\n      const messages = getChatMessages(-1, { role: 'user' });\r\n      const lastUserMessage = messages[messages.length - 1];\r\n      if (lastUserMessage) {\r\n        const messageData = lastUserMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n        const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n        const userInput = lastUserMessage.message || '';\r\n        const isSystemByContent =\r\n          userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n        // \r\n        if (waitingForEventResponse && (isSystemEventMessage || isSystemByContent)) {\r\n          console.warn(\r\n            `[]   (generation_id: ${generation_id})`,\r\n          );\r\n\r\n          //  CORS \r\n\r\n          stopGenerationById(generation_id).then(success => {\r\n            if (success) {\r\n              console.info(`[]   (generation_id: ${generation_id})`);\r\n            } else {\r\n              console.warn(`[]  (generation_id: ${generation_id})`);\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // \r\n    }\r\n  });\r\n\r\n  //  tavern_events.GENERATION_STARTED triggerSlash \r\n  eventOn(tavern_events.GENERATION_STARTED, (type: string, options: unknown, dry_run: boolean) => {\r\n    //  CORS \r\n  });\r\n\r\n  //  AI \r\n  const aiMessageTracking: Array<{\r\n    message_id: number;\r\n    timestamp: number;\r\n    triggerTime: number | null;\r\n    eventName: string | null;\r\n    messageLength: number;\r\n    messagePreview: string;\r\n  }> = [];\r\n\r\n  //  AI \r\n  //  eventMakeFirst \r\n  eventMakeFirst(tavern_events.CHARACTER_MESSAGE_RENDERED, (message_id: number) => {\r\n    try {\r\n      const messages = getChatMessages(message_id, { role: 'assistant' });\r\n      const aiMessage = messages[0];\r\n      if (aiMessage && aiMessage.message) {\r\n        const now = Date.now();\r\n        const messageText = aiMessage.message;\r\n\r\n        // \r\n        const alreadyTracked = aiMessageTracking.some(m => m.message_id === message_id);\r\n        if (alreadyTracked) {\r\n          console.warn(`[]  CHARACTER_MESSAGE_RENDERED message_id: ${message_id}`);\r\n          return;\r\n        }\r\n\r\n        aiMessageTracking.push({\r\n          message_id,\r\n          timestamp: now,\r\n          triggerTime: lastTriggerTime,\r\n          eventName: lastTriggerEventName,\r\n          messageLength: messageText.length,\r\n          messagePreview: messageText.substring(0, 100),\r\n        });\r\n\r\n        //  CORS \r\n\r\n        // \r\n        const relatedMessages = aiMessageTracking.filter(\r\n          m => m.triggerTime === lastTriggerTime && m.eventName === lastTriggerEventName,\r\n        );\r\n\r\n        // \r\n        if (relatedMessages.length > 1) {\r\n          const timeGaps = relatedMessages\r\n            .sort((a, b) => a.timestamp - b.timestamp)\r\n            .map((m, i, arr) => (i > 0 ? m.timestamp - arr[i - 1].timestamp : 0))\r\n            .filter(gap => gap > 0);\r\n\r\n          console.warn(\r\n            `[]   \"${lastTriggerEventName}\"  ${relatedMessages.length} `,\r\n            {\r\n              messageIds: relatedMessages.map(m => m.message_id),\r\n              lengths: relatedMessages.map(m => m.messageLength),\r\n              timeGaps,\r\n              totalLength: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0),\r\n            },\r\n          );\r\n\r\n          //  CORS \r\n        }\r\n\r\n        //  triggerTime \r\n        const recentMessages = aiMessageTracking.filter(\r\n          m => m.message_id !== message_id && Math.abs(m.timestamp - now) < 3000,\r\n        );\r\n        if (recentMessages.length > 0) {\r\n          console.info(\r\n            `[]  ${recentMessages.length} 3`,\r\n            recentMessages.map(m => ({ id: m.message_id, timeDiff: Math.abs(m.timestamp - now) })),\r\n          );\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('[] CHARACTER_MESSAGE_RENDERED :', error);\r\n    }\r\n  });\r\n\r\n  // \r\n  // \r\n  eventOn(tavern_events.MESSAGE_SENT, async (message_id: number | string) => {\r\n    //  CORS \r\n\r\n    try {\r\n      console.info(`[]  MESSAGE_SENT message_id: ${message_id}`);\r\n\r\n      // \r\n      // \r\n      if (waitingForEventResponse) {\r\n        //  CORS \r\n\r\n        // \r\n        const messages = getChatMessages(-1, { role: 'user' });\r\n        const userMessage = messages.find(m => m.message_id === Number(message_id));\r\n\r\n        if (userMessage) {\r\n          //  data \r\n          const messageData = userMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n          const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n          const userInput = userMessage.message || '';\r\n          const isSystemByContent =\r\n            userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n          if (isSystemEventMessage || isSystemByContent) {\r\n            //  CORS \r\n\r\n            //  user_input \r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // \r\n      const messages = getChatMessages(-1, { role: 'user' });\r\n\r\n      //  CORS \r\n\r\n      const userMessage = messages.find(m => m.message_id === Number(message_id));\r\n\r\n      //  CORS \r\n\r\n      if (userMessage && userMessage.message) {\r\n        const userInput = userMessage.message;\r\n        console.info('[] :', userInput.substring(0, 50) + '...');\r\n\r\n        //  data \r\n        const messageData = userMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n        const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n\r\n        //  data \r\n        if (\r\n          isSystemEventMessage ||\r\n          userInput.startsWith('[]') ||\r\n          (userInput.startsWith('[') && userInput.includes(']'))\r\n        ) {\r\n          // \r\n          //  CORS \r\n\r\n          // \r\n          // 1. event_triggered AI\r\n          // 2.  event_triggered \r\n          // 3. \r\n          //  user_input \r\n          // const DS_EMIT_SYSTEM = window.detentionSystem;\r\n          // if (DS_EMIT_SYSTEM && DS_EMIT_SYSTEM.events) {\r\n          //   DS_EMIT_SYSTEM.events.emit('user_input', { text: userInput, message_id });\r\n          // }\r\n\r\n          //  CORS \r\n\r\n          return;\r\n        }\r\n\r\n        // \"\"\"\"\r\n        const protagonistPattern = /(?:|||)\\s*(\\d+)?\\s*(?:|)?\\s*(?:||)/;\r\n        const protagonistMatch = userInput.match(protagonistPattern);\r\n\r\n        if (protagonistMatch) {\r\n          //  CORS \r\n\r\n          console.info('[] :', userInput);\r\n\r\n          try {\r\n            const DS_PROTAGONIST = window.detentionSystem;\r\n            const npcSystem = DS_PROTAGONIST?.getModule('npcSystem') as {\r\n              generateProtagonist?: (options?: {\r\n                crimeType?: string;\r\n                excludeCrimes?: string[];\r\n                background?: {\r\n                  isIntellectual?: boolean;\r\n                  isAcademic?: boolean;\r\n                  isBusiness?: boolean;\r\n                };\r\n                ageRange?: [number, number];\r\n                education?: string;\r\n                profession?: string[];\r\n              }) => {\r\n                name?: string;\r\n                age?: number;\r\n                crime?: string;\r\n                appearance?: {\r\n                  height?: number;\r\n                  weight?: number;\r\n                  hair?: string;\r\n                  skin?: string;\r\n                  features?: string;\r\n                };\r\n                background?: {\r\n                  education?: string;\r\n                  profession?: string;\r\n                };\r\n                personality?: {\r\n                  tags?: string[];\r\n                };\r\n              };\r\n            };\r\n\r\n            if (npcSystem && npcSystem.generateProtagonist) {\r\n              // \r\n              const options: {\r\n                crimeType?: string;\r\n                excludeCrimes?: string[];\r\n                background?: {\r\n                  isIntellectual?: boolean;\r\n                  isAcademic?: boolean;\r\n                  isBusiness?: boolean;\r\n                };\r\n                ageRange?: [number, number];\r\n                education?: string;\r\n                profession?: string[];\r\n              } = {};\r\n\r\n              // \r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.crimeType = 'economic';\r\n              }\r\n              if (userInput.includes('')) {\r\n                options.excludeCrimes = [''];\r\n              } else if (userInput.includes('') || userInput.includes('')) {\r\n                options.excludeCrimes = [''];\r\n              }\r\n\r\n              // \r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.background = { ...options.background, isIntellectual: true };\r\n              }\r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.background = { ...options.background, isAcademic: false };\r\n              }\r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.background = { ...options.background, isBusiness: true };\r\n              }\r\n\r\n              // \r\n              if (userInput.includes('35') || userInput.includes('45')) {\r\n                options.ageRange = [35, 45];\r\n              }\r\n\r\n              // \r\n              if (userInput.includes('') || userInput.includes('') || userInput.includes('')) {\r\n                options.education = 'high';\r\n              }\r\n\r\n              //  CORS \r\n\r\n              const protagonistData = npcSystem.generateProtagonist(options);\r\n\r\n              //  CORS \r\n\r\n              if (protagonistData && protagonistData.name) {\r\n                // \r\n                const chatId = SillyTavern.getCurrentChatId();\r\n                if (chatId) {\r\n                  const protagonistInfo = {\r\n                    name: protagonistData.name,\r\n                    age: protagonistData.age || 30,\r\n                    crime: protagonistData.crime || '',\r\n                    appearance: protagonistData.appearance || {\r\n                      height: 168,\r\n                      weight: 58,\r\n                      hair: '',\r\n                      skin: '',\r\n                      features: '',\r\n                    },\r\n                    background: protagonistData.background || {},\r\n                    personality: protagonistData.personality || {},\r\n                  };\r\n\r\n                  // replaceVariables\r\n                  replaceVariables(\r\n                    {\r\n                      protagonist: protagonistInfo,\r\n                      protagonist_name: protagonistData.name,\r\n                      protagonist_age: protagonistData.age || 30,\r\n                      protagonist_crime: protagonistData.crime || '',\r\n                    },\r\n                    { type: 'chat' },\r\n                  );\r\n\r\n                  console.info(\r\n                    '[]  :',\r\n                    protagonistData.name,\r\n                    protagonistData.age,\r\n                    protagonistData.crime,\r\n                  );\r\n\r\n                  //  CORS \r\n                }\r\n              } else {\r\n                console.warn('[] generateProtagonist');\r\n              }\r\n            } else {\r\n              console.warn('[] NPCgenerateProtagonist');\r\n            }\r\n          } catch (error) {\r\n            console.error('[] :', error);\r\n\r\n            //  CORS \r\n          }\r\n\r\n          // return\r\n        }\r\n\r\n        // \"X\"\"X\"\"X\"\r\n        // 1015\r\n        const skipDayPattern =\r\n          /(?:|||)\\s*(\\d+|[]?|[][]?|[]??[]?|[]??[]??[]?|)\\s*[\\s]*/;\r\n        const skipDayMatch = userInput.match(skipDayPattern);\r\n\r\n        //  CORS \r\n\r\n        const DS_CHECK = window.detentionSystem;\r\n        if (DS_CHECK && DS_CHECK.initialized) {\r\n          const eventSystem = DS_CHECK.getModule('eventSystem');\r\n          if (eventSystem && (DS_CHECK as any).advanceDay) {\r\n            let daysToSkip = 0;\r\n\r\n            // \"\"\"\"\r\n            const parseNumber = (numStr: string): number => {\r\n              // \r\n              const parsed = parseInt(numStr, 10);\r\n              if (!isNaN(parsed)) return parsed;\r\n\r\n              // \r\n              const chineseDigits: Record<string, number> = {\r\n                : 0,\r\n                : 1,\r\n                : 2,\r\n                : 3,\r\n                : 4,\r\n                : 5,\r\n                : 6,\r\n                : 7,\r\n                : 8,\r\n                : 9,\r\n                : 10,\r\n                : 100,\r\n                : 1000,\r\n                : 10000,\r\n              };\r\n\r\n              // \r\n              if (numStr in chineseDigits) return chineseDigits[numStr];\r\n\r\n              // \"\"\"\"\"\"\r\n              let result = 0;\r\n\r\n              // \"X\"\"\"\"\"\r\n              if (numStr.startsWith('')) {\r\n                result = 10;\r\n                const rest = numStr.slice(1);\r\n                if (rest in chineseDigits) result += chineseDigits[rest];\r\n              }\r\n              // \"X\"\"\"\"\"\r\n              else if (numStr.endsWith('')) {\r\n                const prefix = numStr.slice(0, -1);\r\n                if (prefix in chineseDigits) result = chineseDigits[prefix] * 10;\r\n              }\r\n              // \"XY\"\"\"\"\"\r\n              else {\r\n                const shiIndex = numStr.indexOf('');\r\n                if (shiIndex > -1) {\r\n                  const before = numStr.slice(0, shiIndex);\r\n                  const after = numStr.slice(shiIndex + 1);\r\n                  const beforeNum = before in chineseDigits ? chineseDigits[before] : 0;\r\n                  const afterNum = after in chineseDigits ? chineseDigits[after] : 0;\r\n                  result = (beforeNum || 1) * 10 + afterNum; // \"\"1\"\"\r\n                }\r\n              }\r\n\r\n              return result > 0 ? result : 0;\r\n            };\r\n\r\n            // \"X\"\"X\"\"X\"\r\n            if (skipDayMatch) {\r\n              daysToSkip = parseNumber(skipDayMatch[1]);\r\n              if (daysToSkip > 0) {\r\n                console.info(`[] /: ${skipDayMatch[0].trim()} (${daysToSkip})`);\r\n              }\r\n            }\r\n\r\n            // \r\n            if (daysToSkip > 0) {\r\n              // \r\n              if (skipCommandMessages.has(Number(message_id))) {\r\n                console.debug(`[]  ${message_id} `);\r\n                return;\r\n              }\r\n\r\n              // \r\n              skipMessageId = Number(message_id);\r\n\r\n              //  CORS \r\n\r\n              // AI\r\n              try {\r\n                await stopAllGeneration();\r\n                console.info(`[]  `);\r\n\r\n                //  CORS \r\n\r\n                // event_triggered\r\n                const waitForGenerationToStop = (): Promise<void> => {\r\n                  return new Promise(resolve => {\r\n                    let resolved = false;\r\n                    let eventReturn: { stop: () => void } | null = null;\r\n\r\n                    const cleanup = () => {\r\n                      if (eventReturn) {\r\n                        eventReturn.stop();\r\n                        eventReturn = null;\r\n                      }\r\n                    };\r\n\r\n                    //  eventOnce \r\n                    eventReturn = eventOnce(tavern_events.GENERATION_ENDED, () => {\r\n                      if (!resolved) {\r\n                        // 800ms\r\n                        setTimeout(() => {\r\n                          if (!resolved) {\r\n                            resolved = true;\r\n                            clearTimeout(timeout);\r\n                            cleanup();\r\n                            resolve();\r\n                          }\r\n                        }, 800);\r\n                      }\r\n                    });\r\n\r\n                    // 2500msGENERATION_ENDED\r\n                    const timeout = setTimeout(() => {\r\n                      if (!resolved) {\r\n                        resolved = true;\r\n                        cleanup();\r\n                        //  CORS \r\n                        resolve();\r\n                      }\r\n                    }, 2500);\r\n\r\n                    // resolve\r\n                    if (typeof builtin === 'undefined' || !builtin.duringGenerating || !builtin.duringGenerating()) {\r\n                      if (!resolved) {\r\n                        resolved = true;\r\n                        clearTimeout(timeout);\r\n                        cleanup();\r\n                        resolve();\r\n                      }\r\n                    }\r\n                  });\r\n                };\r\n\r\n                await waitForGenerationToStop();\r\n\r\n                // \r\n                let finalCheckCount = 0;\r\n                while (\r\n                  typeof builtin !== 'undefined' &&\r\n                  builtin.duringGenerating &&\r\n                  builtin.duringGenerating() &&\r\n                  finalCheckCount < 5\r\n                ) {\r\n                  finalCheckCount++;\r\n                  console.warn(`[]   (${finalCheckCount})`);\r\n                  await stopAllGeneration();\r\n                  // 500ms\r\n                  await new Promise(resolve => setTimeout(resolve, 500));\r\n                }\r\n\r\n                //  CORS \r\n              } catch (stopError) {\r\n                console.warn('[] :', stopError);\r\n              }\r\n\r\n              // USER_MESSAGE_RENDERED\r\n              const checkMessages = getChatMessages(Number(message_id), { role: 'user' });\r\n              const existingMessage = checkMessages[0];\r\n              const alreadyHidden = existingMessage?.is_hidden === true || skipCommandMessages.has(Number(message_id));\r\n\r\n              if (!alreadyHidden) {\r\n                // AI\r\n                try {\r\n                  await setChatMessages([{ message_id: Number(message_id), is_hidden: true, message: '.' }], {\r\n                    refresh: 'all',\r\n                  });\r\n                  skipCommandMessages.add(Number(message_id));\r\n                  console.info(`[]  MESSAGE_SENT (message_id: ${message_id})`);\r\n\r\n                  //  CORS \r\n                } catch (hideError) {\r\n                  console.warn('[] :', hideError);\r\n                  //  CORS \r\n                }\r\n              } else {\r\n                console.info(`[] USER_MESSAGE_RENDERED (message_id: ${message_id})`);\r\n              }\r\n\r\n              // \r\n              try {\r\n                const worldbookLoader = DS_CHECK.getModule('worldbook') as {\r\n                  loadWorldbook?: (bookName: string) => Promise<unknown>;\r\n                };\r\n                if (worldbookLoader && worldbookLoader.loadWorldbook) {\r\n                  console.info('[] ');\r\n                  // \r\n                  Promise.all([\r\n                    worldbookLoader.loadWorldbook('environment_descriptions').catch(err => {\r\n                      console.warn('[] :', err);\r\n                    }),\r\n                    worldbookLoader.loadWorldbook('internal_basic_procedures').catch(err => {\r\n                      console.warn('[] :', err);\r\n                    }),\r\n                  ]).catch(() => {\r\n                    // \r\n                  });\r\n                }\r\n              } catch (loadError) {\r\n                console.warn('[] :', loadError);\r\n              }\r\n\r\n              // \r\n              try {\r\n                const result = (DS_CHECK as any).advanceDay(daysToSkip) as {\r\n                  interrupted?: boolean;\r\n                  currentDay?: number;\r\n                  tempCurrentDay?: number;\r\n                  pendingDays?: number;\r\n                  event?: { name?: string; priority?: number };\r\n                };\r\n\r\n                //  CORS \r\n\r\n                if (result && result.interrupted && result.event) {\r\n                  // currentDay\r\n                  const eventDay = result.event.day ?? result.tempCurrentDay ?? result.currentDay ?? 0;\r\n                  console.info(`[]  ${daysToSkip} : ${result.event.name} (${eventDay})`);\r\n\r\n                  //  CORS \r\n\r\n                  //  advanceDay  DS.events.emit('event_triggered') \r\n                  // event_triggered AI\r\n                  //  event_triggered \r\n                } else {\r\n                  // AI\r\n                  if (result.pendingDays !== undefined && result.pendingDays > 0) {\r\n                    const eventSystem = DS_CHECK.getModule('eventSystem') as {\r\n                      confirmDayAdvancement?: (pendingDays: number) => void;\r\n                    };\r\n                    if (eventSystem && eventSystem.confirmDayAdvancement) {\r\n                      eventSystem.confirmDayAdvancement(result.pendingDays);\r\n                    }\r\n                  }\r\n\r\n                  const finalDay = result.tempCurrentDay ?? result.currentDay ?? 0;\r\n                  console.info(`[]  ${daysToSkip}  ${finalDay} `);\r\n\r\n                  // AI\r\n                  // AI\r\n                  try {\r\n                    await createChatMessages([\r\n                      {\r\n                        role: 'system',\r\n                        message: `[]  ${daysToSkip}  ${finalDay} `,\r\n                        is_hidden: true,\r\n                      },\r\n                    ]);\r\n                  } catch (createError) {\r\n                    console.warn('[] :', createError);\r\n                  }\r\n                }\r\n              } catch (error) {\r\n                console.error('[] :', error);\r\n\r\n                //  CORS \r\n              }\r\n\r\n              // \r\n              skipMessageId = null;\r\n\r\n              // \r\n              return;\r\n            }\r\n          }\r\n        }\r\n\r\n        //  user_input \r\n        const DS_EMIT = window.detentionSystem;\r\n        if (DS_EMIT && DS_EMIT.events) {\r\n          DS_EMIT.events.emit('user_input', { text: userInput, message_id });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('[] :', error);\r\n    }\r\n  });\r\n\r\n  // \r\n  let waitingForEventResponse = false;\r\n\r\n  console.info('[]  ');\r\n  console.info('[]  MESSAGE_SENT \"X\"');\r\n\r\n  // AI\r\n  const DS_EVENT = window.detentionSystem as DetentionSystem & {\r\n    generateNPC?: (\r\n      count?: number,\r\n      context?: Record<string, unknown>,\r\n    ) => Array<{\r\n      name?: string;\r\n      role?: string;\r\n      age?: number;\r\n      rank?: string;\r\n      type?: string;\r\n      relation?: string;\r\n      relationship?: { influence?: number };\r\n    }>;\r\n    generateNPCForEvent?: (\r\n      eventType: string,\r\n    ) =>\r\n      | { name: string; role?: string; age?: number; rank?: string; type?: string; relation?: string }\r\n      | { police: { name: string; rank?: string }; witnesses: Array<{ name: string }> };\r\n    getCurrentCellNPCs?: () => Array<{ name?: string; relationship?: { influence?: number } }>;\r\n    setCurrentCellNPCs?: (npcs: Array<{ name?: string; relationship?: { influence?: number } }>) => void;\r\n  };\r\n  if (DS_EVENT && DS_EVENT.events) {\r\n    DS_EVENT.events.on('event_triggered', async (eventData?: unknown) => {\r\n      try {\r\n        const event = eventData as\r\n          | {\r\n              id?: string;\r\n              name?: string;\r\n              description?: string;\r\n              type?: string;\r\n              priority?: number;\r\n              day?: number;\r\n              text?: string;\r\n            }\r\n          | undefined;\r\n\r\n        if (!event || !event.name) {\r\n          //  CORS \r\n          return;\r\n        }\r\n\r\n        //  <= 4\r\n        // LEGAL(1), PROCEDURAL(2), CONDITION(3), RANDOM(4), DAILY(5)\r\n        //  <= 4 AI advanceDay \r\n        const eventPriority = event.priority ?? 5;\r\n        if (eventPriority > 4) {\r\n          console.debug(`[]  ${event.name} AI: ${eventPriority}`);\r\n          //  CORS \r\n          return;\r\n        }\r\n\r\n        // \r\n        //  MESSAGE_SENT \r\n        waitingForEventResponse = true;\r\n\r\n        //  CORS \r\n\r\n        console.info(`[] : ${event.name}AI`);\r\n\r\n        // \r\n        const eventSystem = DS_EVENT.getModule('eventSystem') as {\r\n          currentDay?: number;\r\n          advanceDay?: (days: number) => { accumulatedEvents?: unknown[] };\r\n        };\r\n        //  day \r\n        // eventSystem.currentDay AI\r\n        const currentDay = event.day ?? eventSystem?.currentDay ?? 0;\r\n\r\n        let userInput = '';\r\n\r\n        // \"\"\r\n\r\n        // AI\r\n        const eventText = event.text || event.description || `${event.name}`;\r\n\r\n        // NPCuserInput\r\n        let npcInfoText = '';\r\n        const eventId = event.id || '';\r\n\r\n        //  CORS \r\n\r\n        // NPCNPC\r\n        if (\r\n          eventId &&\r\n          [\r\n            'interrogation',\r\n            'lawyer_visit',\r\n            'family_visit',\r\n            'medical_visit',\r\n            'scene_identification',\r\n            'prosecutor_interrogation',\r\n          ].includes(eventId)\r\n        ) {\r\n          try {\r\n            if (typeof DS_EVENT.generateNPCForEvent === 'function') {\r\n              const eventNPC = DS_EVENT.generateNPCForEvent(eventId);\r\n\r\n              //  CORS \r\n\r\n              if (eventNPC && typeof eventNPC === 'object') {\r\n                // NPC\r\n                if ('name' in eventNPC && typeof (eventNPC as { name: string }).name === 'string') {\r\n                  const npc = eventNPC as {\r\n                    name: string;\r\n                    role?: string;\r\n                    age?: number;\r\n                    rank?: string;\r\n                    type?: string;\r\n                    relation?: string;\r\n                  };\r\n                  const npcDesc =\r\n                    npc.role === 'police'\r\n                      ? `${npc.name}${npc.rank || ''}`\r\n                      : npc.role === 'lawyer'\r\n                        ? `${npc.name}${npc.type || ''}`\r\n                        : npc.role === 'family'\r\n                          ? `${npc.name}${npc.relation || ''}`\r\n                          : npc.role === 'doctor'\r\n                            ? `${npc.name}`\r\n                            : npc.name;\r\n                  npcInfoText = `\\n\\nNPC${npcDesc}NPC`;\r\n                }\r\n                // NPC\r\n                else if ('police' in eventNPC && 'witnesses' in eventNPC) {\r\n                  const sceneData = eventNPC as {\r\n                    police: { name: string; rank?: string };\r\n                    witnesses: Array<{ name: string }>;\r\n                  };\r\n                  const policeDesc = `${sceneData.police.name}${sceneData.police.rank || ''}`;\r\n                  const witnessesDesc = sceneData.witnesses.map(w => w.name).join('');\r\n                  npcInfoText = `\\n\\nNPC${policeDesc}${witnessesDesc}NPC`;\r\n                }\r\n              }\r\n            }\r\n          } catch (npcError) {\r\n            console.warn('[] NPC:', npcError);\r\n\r\n            //  CORS \r\n          }\r\n        }\r\n\r\n        // NPC\r\n        if (eventId === 'cell_transfer') {\r\n          try {\r\n            // \r\n            const eventSystemModule = DS_EVENT.getModule('eventSystem') as\r\n              | {\r\n                  cellType?: string;\r\n                }\r\n              | undefined;\r\n            const targetCellType = (event as { to?: string }).to || eventSystemModule?.cellType || 'pretrial';\r\n\r\n            //  CORS \r\n\r\n            // NPCcell_transfer\r\n            if (typeof DS_EVENT.generateNPC === 'function' && typeof DS_EVENT.setCurrentCellNPCs === 'function') {\r\n              const npcCount = Math.floor(Math.random() * 5) + 3; // 3-7\r\n              const newNPCs = DS_EVENT.generateNPC(npcCount, { cellType: targetCellType });\r\n\r\n              //  CORS \r\n\r\n              if (Array.isArray(newNPCs) && newNPCs.length > 0) {\r\n                // NPCNPC\r\n                DS_EVENT.setCurrentCellNPCs(newNPCs);\r\n                console.info(`[]  ${newNPCs.length}NPC`);\r\n\r\n                // \r\n                const cellBoss = newNPCs.reduce((max, npc) => {\r\n                  const influence = (npc as { relationship?: { influence?: number } }).relationship?.influence ?? 0;\r\n                  const maxInfluence = (max as { relationship?: { influence?: number } }).relationship?.influence ?? 0;\r\n                  return influence > maxInfluence ? npc : max;\r\n                }, newNPCs[0]);\r\n\r\n                const otherNPCs = newNPCs.filter(npc => npc !== cellBoss);\r\n                const cellBossName = (cellBoss as { name?: string }).name || '';\r\n                const otherNames = otherNPCs\r\n                  .map((npc: { name?: string }) => npc.name)\r\n                  .filter(Boolean)\r\n                  .join('');\r\n\r\n                npcInfoText = `\\n\\nNPC${cellBossName}${otherNames || ''}NPC`;\r\n              }\r\n            }\r\n          } catch (cellNPCError) {\r\n            console.warn('[] NPC:', cellNPCError);\r\n\r\n            //  CORS \r\n          }\r\n        }\r\n\r\n        // NPCNPC\r\n        // category'random'ID\r\n        const eventCategory = (event as { category?: string }).category;\r\n        if (\r\n          !npcInfoText &&\r\n          (eventCategory === 'random' || event.priority === 4) &&\r\n          typeof DS_EVENT.getCurrentCellNPCs === 'function'\r\n        ) {\r\n          try {\r\n            let cellNPCs = DS_EVENT.getCurrentCellNPCs();\r\n\r\n            // NPC01NPC\r\n            if ((!cellNPCs || (Array.isArray(cellNPCs) && cellNPCs.length === 0)) && currentDay <= 1) {\r\n              console.info('[] NPC');\r\n\r\n              //  CORS \r\n\r\n              if (typeof DS_EVENT.generateNPC === 'function') {\r\n                const eventSystemModule = DS_EVENT.getModule('eventSystem') as\r\n                  | {\r\n                      cellType?: string;\r\n                    }\r\n                  | undefined;\r\n                const cellType = eventSystemModule?.cellType || 'transition';\r\n                const initialNPCCount = Math.floor(Math.random() * 5) + 3; // 3-7\r\n                const initialNPCs = DS_EVENT.generateNPC(initialNPCCount, { cellType });\r\n\r\n                if (Array.isArray(initialNPCs) && initialNPCs.length > 0) {\r\n                  if (typeof DS_EVENT.setCurrentCellNPCs === 'function') {\r\n                    DS_EVENT.setCurrentCellNPCs(initialNPCs);\r\n                    console.info(`[]  ${initialNPCs.length}NPC`);\r\n                  }\r\n                  cellNPCs = initialNPCs;\r\n                }\r\n              }\r\n            }\r\n\r\n            if (Array.isArray(cellNPCs) && cellNPCs.length > 0) {\r\n              // 1-3NPC\r\n              const selectedNPCs = cellNPCs.sort(() => Math.random() - 0.5).slice(0, Math.min(3, cellNPCs.length));\r\n              const npcNames = selectedNPCs\r\n                .map((npc: { name?: string }) => npc.name)\r\n                .filter(Boolean)\r\n                .join('');\r\n              if (npcNames) {\r\n                npcInfoText = `\\n\\nNPC${npcNames}NPC`;\r\n              }\r\n            }\r\n          } catch (cellNPCError) {\r\n            console.warn('[] NPC:', cellNPCError);\r\n\r\n            //  CORS \r\n          }\r\n        }\r\n\r\n        // text\"\"\r\n        // \r\n        if (event.text) {\r\n          // \r\n          userInput = `[] ${currentDay}${eventText}${npcInfoText}`;\r\n        } else {\r\n          // text\r\n          userInput = `[] ${currentDay}${eventText}${npcInfoText}`;\r\n        }\r\n\r\n        //  CORS \r\n\r\n        //  CORS \r\n\r\n        //  CORS \r\n\r\n        // \r\n        await stopAllGeneration();\r\n\r\n        //  CORS \r\n\r\n        // \r\n        //  CORS \r\n\r\n        // \r\n        await stopAllGeneration();\r\n\r\n        //  CORS \r\n\r\n        //  refresh: 'affected'  MESSAGE_SENT \r\n        // MESSAGE_SENT \r\n        // createChatMessages  MESSAGE_SENT \r\n        const createPromise = createChatMessages(\r\n          [\r\n            {\r\n              role: 'user',\r\n              message: userInput,\r\n              is_hidden: false,\r\n              //  data  MESSAGE_SENT \r\n              data: {\r\n                isSystemEventMessage: true,\r\n                eventId: event.id,\r\n                eventName: event.name,\r\n              },\r\n            },\r\n          ],\r\n          { refresh: 'affected' }, //  'affected'  MESSAGE_SENT \r\n        );\r\n\r\n        //  CORS \r\n\r\n        // \r\n        await createPromise;\r\n\r\n        // \r\n        //  MESSAGE_SENT \r\n        await new Promise(resolve => setTimeout(resolve, 150)); //  MESSAGE_SENT \r\n        await stopAllGeneration();\r\n\r\n        //  CORS \r\n\r\n        //  CORS \r\n\r\n        // message_id/\r\n        //  MESSAGE_SENT \r\n        await new Promise(resolve => setTimeout(resolve, 200));\r\n        const eventMessageId = getLastMessageId();\r\n\r\n        //  CORS \r\n\r\n        //  CORS \r\n\r\n        // AI\r\n        try {\r\n          // createChatMessages\r\n          await stopAllGeneration();\r\n\r\n          //  CORS \r\n\r\n          //  GENERATION_ENDED \r\n          const waitForGenerationToStop = (): Promise<void> => {\r\n            return new Promise(resolve => {\r\n              let resolved = false;\r\n              let eventReturn: { stop: () => void } | null = null;\r\n              let generationStartedReturn: { stop: () => void } | null = null;\r\n              let generationEndedReceived = false;\r\n              let generationStartedCount = 0;\r\n\r\n              const cleanup = () => {\r\n                if (eventReturn) {\r\n                  eventReturn.stop();\r\n                  eventReturn = null;\r\n                }\r\n                if (generationStartedReturn) {\r\n                  generationStartedReturn.stop();\r\n                  generationStartedReturn = null;\r\n                }\r\n              };\r\n\r\n              //  GENERATION_STARTED \r\n              generationStartedReturn = eventOn(\r\n                tavern_events.GENERATION_STARTED,\r\n                async (type: string, options: unknown, dry_run: boolean) => {\r\n                  generationStartedCount++;\r\n                  const now = Date.now();\r\n                  //  CORS \r\n                  await stopAllGeneration();\r\n                },\r\n              );\r\n\r\n              //  eventOnce \r\n              eventReturn = eventOnce(tavern_events.GENERATION_ENDED, () => {\r\n                if (!resolved) {\r\n                  generationEndedReceived = true;\r\n                  //  CORS \r\n                  // GENERATION_ENDED\r\n                  setTimeout(() => {\r\n                    if (!resolved) {\r\n                      resolved = true;\r\n                      clearTimeout(timeout);\r\n                      cleanup();\r\n                      resolve();\r\n                    }\r\n                  }, 800); // 800ms\r\n                }\r\n              });\r\n\r\n              // 2000msGENERATION_ENDED\r\n              const timeout = setTimeout(() => {\r\n                if (!resolved) {\r\n                  resolved = true;\r\n                  cleanup();\r\n                  //  CORS \r\n                  resolve();\r\n                }\r\n              }, 2500); // 2500ms\r\n            });\r\n          };\r\n\r\n          await waitForGenerationToStop();\r\n\r\n          //  CORS \r\n\r\n          // \r\n          const waitForGenerationToComplete = (): Promise<void> => {\r\n            return new Promise(resolve => {\r\n              // resolve\r\n              if (typeof builtin === 'undefined' || !builtin.duringGenerating || !builtin.duringGenerating()) {\r\n                resolve();\r\n                return;\r\n              }\r\n\r\n              //  CORS \r\n\r\n              let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n\r\n              //  GENERATION_ENDED \r\n              const eventReturn = eventOnce(tavern_events.GENERATION_ENDED, () => {\r\n                if (timeoutHandle) {\r\n                  clearTimeout(timeoutHandle);\r\n                  timeoutHandle = null;\r\n                }\r\n                // 500ms\r\n                setTimeout(() => {\r\n                  //  CORS \r\n                  resolve();\r\n                }, 500);\r\n              });\r\n\r\n              // 10\r\n              timeoutHandle = setTimeout(() => {\r\n                eventReturn.stop();\r\n                timeoutHandle = null;\r\n                //  CORS \r\n                resolve(); // resolve\r\n              }, 10000);\r\n            });\r\n          };\r\n\r\n          await waitForGenerationToComplete();\r\n\r\n          // 3\r\n          let forceStopAttempts = 0;\r\n          while (\r\n            typeof builtin !== 'undefined' &&\r\n            builtin.duringGenerating &&\r\n            builtin.duringGenerating() &&\r\n            forceStopAttempts < 3\r\n          ) {\r\n            forceStopAttempts++;\r\n            console.warn(`[]   (${forceStopAttempts}): ${event.name}`);\r\n            await stopAllGeneration();\r\n            // 500ms\r\n            await new Promise(resolve => setTimeout(resolve, 500));\r\n          }\r\n\r\n          // \r\n          if (typeof builtin !== 'undefined' && builtin.duringGenerating && builtin.duringGenerating()) {\r\n            //  CORS \r\n            console.warn(`[]  AI: ${event.name}`);\r\n            // AI\r\n          }\r\n\r\n          // 300ms\r\n          await new Promise(resolve => setTimeout(resolve, 300));\r\n\r\n          //  CORS \r\n\r\n          // AI\r\n          // \r\n          const eventName = event.name;\r\n          const eventId = event.id;\r\n          lastTriggerTime = Date.now();\r\n          lastTriggerEventName = event.name;\r\n          generationTracking.length = 0; // \r\n\r\n          //  triggerSlash \r\n          let messagesBeforeTrigger: Array<{ message_id: number; role: string; messageLength: number }> = [];\r\n          let lastAssistantMessage: { message_id: number; message: string; messageLength: number } | null = null;\r\n          try {\r\n            const allMessages = getChatMessages(-1);\r\n            messagesBeforeTrigger = allMessages.map(m => ({\r\n              message_id: m.message_id || 0,\r\n              role: m.role || 'unknown',\r\n              messageLength: (m.message || '').length,\r\n            }));\r\n\r\n            // \r\n            const assistantMessages = allMessages.filter(m => m.role === 'assistant');\r\n            if (assistantMessages.length > 0) {\r\n              const lastAssistant = assistantMessages[assistantMessages.length - 1];\r\n              lastAssistantMessage = {\r\n                message_id: lastAssistant.message_id || 0,\r\n                message: lastAssistant.message || '',\r\n                messageLength: (lastAssistant.message || '').length,\r\n              };\r\n            }\r\n          } catch (error) {\r\n            console.warn('[]  triggerSlash :', error);\r\n          }\r\n\r\n          // \r\n          // \r\n          const lastAssistantMessageId = lastAssistantMessage?.message_id || null;\r\n          const lastAssistantMessageLength = lastAssistantMessage?.messageLength || 0;\r\n          const lastAssistantMessagePreview = lastAssistantMessage?.message?.substring(0, 100) || '';\r\n          const potentiallyIncompleteMessage =\r\n            lastAssistantMessageId !== null &&\r\n            (lastAssistantMessageLength < 100 || // \r\n              lastAssistantMessagePreview.includes('<thinking>') || // \r\n              lastAssistantMessagePreview.includes('...')); // \r\n\r\n          //  CORS \r\n\r\n          await triggerSlash('/trigger');\r\n\r\n          //  CORS \r\n\r\n          console.info(`[]  AI: ${event.name}`);\r\n\r\n          // AI\r\n          const generationEndHandler = eventOnce(tavern_events.GENERATION_ENDED, (message_id: number) => {\r\n            const endTime = Date.now();\r\n            waitingForEventResponse = false;\r\n            console.debug(`[] AI: ${eventName}`);\r\n\r\n            // \r\n            const relatedMessages = aiMessageTracking.filter(\r\n              m => m.triggerTime === lastTriggerTime && m.eventName === lastTriggerEventName,\r\n            );\r\n\r\n            //  ID \r\n            const messageIdMatched = relatedMessages.some(m => m.message_id === message_id);\r\n\r\n            //  message_id  CHARACTER_MESSAGE_RENDERED \r\n            let messageEndContent: string | null = null;\r\n            let messageEndLength = 0;\r\n            try {\r\n              const messageEnd = getChatMessages(message_id, { role: 'assistant' });\r\n              if (messageEnd && messageEnd.length > 0 && messageEnd[0].message) {\r\n                messageEndContent = messageEnd[0].message;\r\n                messageEndLength = messageEndContent.length;\r\n              }\r\n            } catch (error) {\r\n              // \r\n            }\r\n\r\n            //  message_id 5 \r\n            let message5Content: string | null = null;\r\n            let message5Length = 0;\r\n            let message5Preview: string | null = null;\r\n            try {\r\n              const message5 = getChatMessages(5, { role: 'assistant' });\r\n              if (message5 && message5.length > 0 && message5[0].message) {\r\n                message5Content = message5[0].message;\r\n                message5Length = message5Content.length;\r\n                message5Preview = message5Content.substring(0, 300);\r\n              }\r\n            } catch (error) {\r\n              // \r\n            }\r\n\r\n            //  message_id 5  message_id 5\r\n            // \r\n            const message5ContainsEventContent = message5Content && eventName && message5Content.includes(eventName);\r\n            // \r\n            const message5ContainsSystemEvent =\r\n              message5Content &&\r\n              (message5Content.includes('[]') ||\r\n                (message5Content.includes('') && message5Content.includes('')));\r\n            //  message_id 6  message_id 5  message_id 5\r\n            const contentUpdatedToMessage5 =\r\n              !messageEndContent && (message5ContainsEventContent || message5ContainsSystemEvent);\r\n\r\n            // \r\n            let allAssistantMessages: Array<{ message_id: number; messageLength: number; timestamp?: number }> = [];\r\n            try {\r\n              const allMessages = getChatMessages(-1, { role: 'assistant' });\r\n              allAssistantMessages = allMessages.map(m => ({\r\n                message_id: m.message_id || 0,\r\n                messageLength: (m.message || '').length,\r\n              }));\r\n              //  aiMessageTracking \r\n              allAssistantMessages = allAssistantMessages.map(msg => {\r\n                const tracked = aiMessageTracking.find(t => t.message_id === msg.message_id);\r\n                return { ...msg, timestamp: tracked?.timestamp };\r\n              });\r\n            } catch (error) {\r\n              // \r\n            }\r\n\r\n            //  CORS \r\n\r\n            //  message_id 5 relatedMessages\r\n            if (contentUpdatedToMessage5) {\r\n              //  message_id5 message_id6\r\n              const actualMessageId = 5;\r\n\r\n              console.warn(\r\n                `[]   message_id ${actualMessageId} message_id ${message_id} message_id ${actualMessageId} `,\r\n                {\r\n                  expectedMessageId: message_id,\r\n                  actualMessageId,\r\n                  message5Length,\r\n                  message5ContainsEventContent,\r\n                  message5ContainsSystemEvent,\r\n                  relatedMessagesCount: relatedMessages.length,\r\n                },\r\n              );\r\n\r\n              //  CORS \r\n\r\n              //  message_id \r\n              //  message_id  GENERATION_ENDED  message_id\r\n              //  message_id \r\n            } else if (relatedMessages.length > 0 && !messageIdMatched) {\r\n              //  ID  contentUpdatedToMessage5 \r\n              console.warn(\r\n                `[]   ID GENERATION_ENDED  message_id (${message_id})  CHARACTER_MESSAGE_RENDERED  ID `,\r\n                {\r\n                  generationEndMessageId: message_id,\r\n                  trackedMessageIds: relatedMessages.map(m => m.message_id),\r\n                  allTrackedMessages: aiMessageTracking.map(m => ({\r\n                    id: m.message_id,\r\n                    triggerTime: m.triggerTime,\r\n                    eventName: m.eventName,\r\n                    length: m.messageLength,\r\n                  })),\r\n                },\r\n              );\r\n\r\n              //  CORS \r\n            } else if (!contentUpdatedToMessage5 && relatedMessages.length > 1) {\r\n              // \r\n              // \r\n              console.warn(\r\n                `[]   \"${lastTriggerEventName}\"  ${relatedMessages.length} `,\r\n                {\r\n                  eventName: lastTriggerEventName,\r\n                  triggerTime: lastTriggerTime,\r\n                  generationEndMessageId: message_id,\r\n                  relatedMessageIds: relatedMessages.map(m => m.message_id),\r\n                  totalLength: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0),\r\n                },\r\n              );\r\n\r\n              //  CORS \r\n            }\r\n\r\n            // AI\r\n            try {\r\n              const eventSystem = DS_EVENT.getModule('eventSystem') as {\r\n                saveStateToChatVars?: () => void;\r\n                saveEventInterruptSnapshot?: () => void;\r\n                confirmDayAdvancement?: (pendingDays: number) => void;\r\n              };\r\n\r\n              // \r\n              const eventWithPending = event as { pendingDayAdvancement?: number };\r\n              if (eventSystem && eventWithPending.pendingDayAdvancement !== undefined) {\r\n                // AI\r\n                if (eventSystem.confirmDayAdvancement) {\r\n                  eventSystem.confirmDayAdvancement(eventWithPending.pendingDayAdvancement);\r\n                }\r\n              }\r\n\r\n              if (eventSystem && eventSystem.saveStateToChatVars) {\r\n                // \r\n                eventSystem.saveStateToChatVars();\r\n                // \r\n                // \"\"\r\n                if (eventSystem.saveEventInterruptSnapshot) {\r\n                  eventSystem.saveEventInterruptSnapshot();\r\n                }\r\n                console.debug('[] AI');\r\n\r\n                //  CORS \r\n              }\r\n            } catch (error) {\r\n              console.warn('[] AI:', error);\r\n            }\r\n          });\r\n\r\n          // \r\n          const generationStoppedHandler = eventOnce(tavern_events.GENERATION_STOPPED, () => {\r\n            // \r\n            try {\r\n              const messages = getChatMessages(eventMessageId, { role: 'user' });\r\n              if (!messages || messages.length === 0) {\r\n                // \r\n                // \r\n                const eventSystem = DS_EVENT.getModule('eventSystem') as {\r\n                  rollbackToInterruptSnapshot?: () => boolean;\r\n                };\r\n                if (eventSystem && eventSystem.rollbackToInterruptSnapshot) {\r\n                  const rollbackSuccess = eventSystem.rollbackToInterruptSnapshot();\r\n                  if (rollbackSuccess) {\r\n                    console.info(`[]  `);\r\n                    //  CORS \r\n                  }\r\n                }\r\n              }\r\n            } catch (error) {\r\n              console.warn('[] :', error);\r\n            }\r\n\r\n            waitingForEventResponse = false;\r\n            generationEndHandler.stop();\r\n          });\r\n\r\n          // 30AI\r\n          setTimeout(() => {\r\n            if (waitingForEventResponse) {\r\n              waitingForEventResponse = false;\r\n              generationStoppedHandler.stop();\r\n              console.warn(`[]  30: ${eventName}`);\r\n            }\r\n          }, 30000);\r\n\r\n          //  CORS \r\n        } catch (error) {\r\n          console.error(`[]  AI:`, error);\r\n\r\n          //  CORS \r\n        }\r\n      } catch (error) {\r\n        console.error('[] AI:', error);\r\n      }\r\n    });\r\n\r\n    console.info('[] AI');\r\n  }\r\n});\r\n\r\nconsole.info('[] ');\r\nconsole.info('[]   - : ' + new Date().toLocaleTimeString());\r\n\r\n// \r\nconst systemCheck = {\r\n  exists: typeof window.detentionSystem !== 'undefined',\r\n  type: typeof window.detentionSystem,\r\n  value: window.detentionSystem ? 'object' : 'undefined',\r\n  hasPing: window.detentionSystem && typeof (window.detentionSystem as DetentionSystem).ping === 'function',\r\n  pingResult:\r\n    window.detentionSystem && typeof (window.detentionSystem as DetentionSystem).ping === 'function'\r\n      ? (window.detentionSystem as DetentionSystem).ping()\r\n      : 'N/A',\r\n  hasInitializeState:\r\n    window.detentionSystem &&\r\n    typeof (window.detentionSystem as DetentionSystem & { initializeState?: unknown }).initializeState === 'function',\r\n  hasModules: window.detentionSystem && 'modules' in (window.detentionSystem as DetentionSystem),\r\n  modulesCount:\r\n    window.detentionSystem && 'modules' in (window.detentionSystem as DetentionSystem)\r\n      ? Object.keys((window.detentionSystem as DetentionSystem).modules).length\r\n      : 0,\r\n  isIframe: window.parent !== window,\r\n  hasParent: !!window.parent,\r\n  parentHasDetentionSystem:\r\n    window.parent && window.parent !== window\r\n      ? typeof (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem !==\r\n        'undefined'\r\n      : 'N/A',\r\n  parentHasDS: window.parent && window.parent !== window ? typeof (window.parent as any).DS !== 'undefined' : 'N/A',\r\n};\r\n\r\nconsole.info('[]  window.detentionSystem:', systemCheck);\r\n\r\n//  CORS \r\n","export {};\r\n\r\n/**\r\n * \r\n *  registerModule \r\n */\r\n\r\ntype EventPriority = 1 | 2 | 3 | 4 | 5;\r\n\r\ntype Stage =\r\n  | 'detention'\r\n  | 'approval'\r\n  | 'investigation'\r\n  | 'prosecution'\r\n  | 'trial1'\r\n  | 'firstVerdict'\r\n  | 'appeal'\r\n  | 'trial2'\r\n  | 'finalVerdict'\r\n  | 'transfer'\r\n  | 'execution'\r\n  | 'deathReview'\r\n  | 'end';\r\n\r\ninterface EventBus {\r\n  on(event: string, callback: (data?: unknown) => void): void;\r\n  emit(event: string, data?: unknown): void;\r\n}\r\n\r\ninterface EventSystemExports {\r\n  generateRandomEvent?: (context?: unknown) => EventRecord | null;\r\n  advanceDay?: (days?: number) => unknown;\r\n  getCurrentDay?: () => number;\r\n  getCurrentStage?: () => unknown;\r\n  checkCellTransfer?: () => boolean;\r\n  setCaseComplexity?: (complexity: 'simple' | 'normal' | 'complex' | 'very_complex') => void;\r\n  rollbackToStage?: (stage: Stage, reason?: string) => boolean;\r\n  advanceToStage?: (stage: Stage, reason?: string) => boolean;\r\n  setDeathPenalty?: (flag: boolean) => void;\r\n  getEventStatistics?: () => unknown;\r\n  exportTimeline?: () => unknown;\r\n  importTimeline?: (data: unknown) => boolean;\r\n  rollbackToInterruptSnapshot?: () => boolean;\r\n}\r\n\r\ninterface DetentionSystem extends EventSystemExports {\r\n  version: string;\r\n  initialized: boolean;\r\n  modules: Record<string, unknown>;\r\n  config: Record<string, unknown>;\r\n  state: Record<string, unknown>;\r\n  events: EventBus;\r\n  CacheManager: unknown;\r\n  EventEmitter: unknown;\r\n  ping(): boolean;\r\n  checkTokenBudget(): unknown;\r\n  updateTokenUsage(tokens: number): unknown;\r\n  compressContent(content: unknown, quality?: number | null): string;\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n  handleError(error: unknown, context?: string): void;\r\n  detectEnvironment(): unknown;\r\n  initialize(): void;\r\n}\r\n\r\ninterface ProtagonistState {\r\n  health: number;\r\n  mental: number;\r\n  strength?: number;\r\n  intelligence?: number;\r\n}\r\n\r\ninterface Timeline {\r\n  arrestDay: number;\r\n  approvalDay: number | null;\r\n  prosecutionDay: number | null;\r\n  firstTrialDay: number | null;\r\n  firstVerdictDay: number | null;\r\n  secondTrialDay: number | null;\r\n  finalVerdictDay: number | null;\r\n  transferDay: number | null;\r\n  executionDay: number | null;\r\n}\r\n\r\ninterface EventRecord {\r\n  id: string;\r\n  name: string;\r\n  type?: string;\r\n  category?: string;\r\n  description?: string;\r\n  priority?: EventPriority;\r\n  day?: number;\r\n  stage?: Stage;\r\n  isEnding?: boolean;\r\n  endingType?: 'prison' | 'death';\r\n  aiControlled?: boolean;\r\n  text?: string;\r\n  from?: string;\r\n  to?: string;\r\n  reason?: string;\r\n}\r\n\r\ndeclare global {\r\n  interface Window {\r\n    chat?: Array<{ mes?: string }>;\r\n  }\r\n}\r\n\r\ninterface EventSystemImpl {\r\n  currentDay: number;\r\n  lastEventDay: number;\r\n  eventHistory: EventRecord[];\r\n  legalTimeline: Timeline;\r\n  currentStage: Stage;\r\n  cellType: string;\r\n  caseComplexity: 'simple' | 'normal' | 'complex' | 'very_complex';\r\n  complexityMultiplier: number;\r\n  eventCounters: Record<string, number>;\r\n  isDeathPenalty: boolean;\r\n  lastStageChangeDay: number;\r\n  assignedOfficers: { police: string[]; prosecutor: string | null };\r\n  getCurrentDayInternal(this: EventSystemImpl): number;\r\n  readonly PRIORITY: {\r\n    readonly LEGAL: 1;\r\n    readonly PROCEDURAL: 2;\r\n    readonly CONDITION: 3;\r\n    readonly RANDOM: 4;\r\n    readonly DAILY: 5;\r\n  };\r\n  legalEvents: Record<string, unknown>;\r\n  conditionEvents: Array<any>;\r\n  randomEvents: Record<string, Array<{ id: string; name: string; weight: number }>>;\r\n  innerMonologues: Array<{ id: string; text: string; weight: number }>;\r\n  initialize(this: EventSystemImpl, startDay?: number): void;\r\n  setCaseComplexity(this: EventSystemImpl, complexity: 'simple' | 'normal' | 'complex' | 'very_complex'): void;\r\n  checkComplexityAdjustment(this: EventSystemImpl): void;\r\n  rollbackToStage(this: EventSystemImpl, targetStage: Stage, reason?: string): boolean;\r\n  advanceToStage(this: EventSystemImpl, targetStage: Stage, reason?: string): boolean;\r\n  handleUserRollback(this: EventSystemImpl, input: string): boolean;\r\n  advanceDay(\r\n    this: EventSystemImpl,\r\n    days?: number,\r\n  ): {\r\n    interrupted: boolean;\r\n    currentDay: number;\r\n    tempCurrentDay?: number;\r\n    pendingDays?: number;\r\n    event?: EventRecord;\r\n  };\r\n  checkDayEvents(this: EventSystemImpl): EventRecord;\r\n  checkLegalEvent(this: EventSystemImpl): EventRecord | null;\r\n  checkConditionEvent(this: EventSystemImpl): EventRecord | null;\r\n  generateRandomEvent(this: EventSystemImpl): EventRecord | null;\r\n  generateInnerMonologue(this: EventSystemImpl): EventRecord | null;\r\n  weightedRandom(this: EventSystemImpl, count: number, weights: number[]): number;\r\n  getProtagonistState(this: EventSystemImpl): ProtagonistState;\r\n  getRecentContext(this: EventSystemImpl): string;\r\n  checkCellTransfer(this: EventSystemImpl): boolean;\r\n  setDeathPenalty(this: EventSystemImpl, isDeathPenalty: boolean): void;\r\n  getCurrentStageInfo(this: EventSystemImpl): unknown;\r\n  getEventStatistics(this: EventSystemImpl): unknown;\r\n  exportTimeline(this: EventSystemImpl): unknown;\r\n  importTimeline(this: EventSystemImpl, data: any): boolean;\r\n  saveStateToChatVars(this: EventSystemImpl): void;\r\n  saveEventInterruptSnapshot(this: EventSystemImpl): void;\r\n  rollbackToInterruptSnapshot(this: EventSystemImpl): boolean;\r\n  confirmDayAdvancement(this: EventSystemImpl, pendingDays: number): void;\r\n}\r\n\r\nconsole.info('[] ...');\r\n\r\n//  jQuery ready \r\n$(() => {\r\n  const DS_RAW = window.detentionSystem as (DetentionSystem & EventSystemExports) | undefined;\r\n\r\n  // \r\n  let saveStateTimer: ReturnType<typeof setTimeout> | null = null;\r\n  if (!DS_RAW) {\r\n    console.error('[] ');\r\n    console.error('[]  core.ts ');\r\n    return;\r\n  }\r\n\r\n  // DS \r\n  const DS = DS_RAW as DetentionSystem & EventSystemExports;\r\n\r\n  // ==========  ==========\r\n  /**\r\n   * \r\n   * @returns \r\n   */\r\n  function getCurrentDayFromMemoryEnhancement(fallback: number = 0): number {\r\n    try {\r\n      //  statusPanel \r\n      const statusPanel = DS.getModule('statusPanel') as {\r\n        getState?: () => { days?: number; day?: number };\r\n      };\r\n\r\n      if (statusPanel && statusPanel.getState) {\r\n        const state = statusPanel.getState();\r\n        if (state && (state.days !== undefined || state.day !== undefined)) {\r\n          const dayFromMemory = state.days ?? state.day ?? fallback;\r\n          //  CORS \r\n          return dayFromMemory;\r\n        }\r\n      }\r\n\r\n      //  CORS \r\n      return fallback;\r\n    } catch (error) {\r\n      console.warn('[] :', error);\r\n      //  CORS \r\n      return fallback;\r\n    }\r\n  }\r\n\r\n  // ----------------  ----------------\r\n  const EventSystem: EventSystemImpl = {\r\n    currentDay: 0, // \r\n\r\n    /**\r\n     * \r\n     * @returns \r\n     */\r\n    getCurrentDayInternal(): number {\r\n      return getCurrentDayFromMemoryEnhancement(this.currentDay);\r\n    },\r\n\r\n    lastEventDay: 0,\r\n    eventHistory: [] as EventRecord[],\r\n    legalTimeline: {\r\n      arrestDay: 0,\r\n      approvalDay: null,\r\n      prosecutionDay: null,\r\n      firstTrialDay: null,\r\n      firstVerdictDay: null,\r\n      secondTrialDay: null,\r\n      finalVerdictDay: null,\r\n      transferDay: null,\r\n      executionDay: null,\r\n    } as Timeline,\r\n    currentStage: 'detention' as Stage,\r\n    cellType: 'transition',\r\n\r\n    // \r\n    caseComplexity: 'normal' as 'simple' | 'normal' | 'complex' | 'very_complex',\r\n    complexityMultiplier: 1.0,\r\n\r\n    // ID\r\n    eventCounters: {\r\n      interrogation: 0,\r\n      prosecutor_interrogation: 0,\r\n      lawyer_visit: 0,\r\n      family_visit: 0,\r\n      medical_visit: 0,\r\n      scene_identification: 0,\r\n    } as Record<string, number>,\r\n\r\n    // \r\n    isDeathPenalty: false,\r\n\r\n    // \r\n    lastStageChangeDay: 0,\r\n\r\n    // \r\n    assignedOfficers: {\r\n      police: [] as string[],\r\n      prosecutor: null as string | null,\r\n    },\r\n\r\n    // \r\n    // LEGAL: 1 - \r\n    // PROCEDURAL: 2 - \r\n    // CONDITION: 3 - \r\n    // RANDOM: 4 - \r\n    // DAILY: 5 - \r\n    PRIORITY: {\r\n      LEGAL: 1,\r\n      PROCEDURAL: 2,\r\n      CONDITION: 3,\r\n      RANDOM: 4,\r\n      DAILY: 5,\r\n    } as const,\r\n\r\n    // \r\n    legalEvents: {\r\n      approval: {\r\n        name: '',\r\n        minDay: 30,\r\n        maxDay: 37,\r\n        stage: 'approval',\r\n        description: '',\r\n        nextStage: 'investigation',\r\n      },\r\n      investigation: {\r\n        name: '',\r\n        duration: [60, 210],\r\n        stage: 'investigation',\r\n        description: '',\r\n        nextStage: 'prosecution',\r\n      },\r\n      prosecution: {\r\n        name: '',\r\n        duration: [30, 45],\r\n        stage: 'prosecution',\r\n        description: '',\r\n        nextStage: 'trial1',\r\n      },\r\n      firstTrial: {\r\n        name: '',\r\n        duration: [30, 45],\r\n        stage: 'trial1',\r\n        description: '',\r\n        nextStage: 'firstVerdict',\r\n      },\r\n      firstVerdict: {\r\n        name: '',\r\n        duration: [7, 30],\r\n        stage: 'firstVerdict',\r\n        description: '',\r\n        nextStage: 'appeal',\r\n      },\r\n      appeal: {\r\n        name: '',\r\n        duration: [10, 10],\r\n        stage: 'appeal',\r\n        description: '10',\r\n        nextStage: 'trial2',\r\n      },\r\n      secondTrial: {\r\n        name: '',\r\n        duration: [60, 90],\r\n        stage: 'trial2',\r\n        description: '',\r\n        nextStage: 'finalVerdict',\r\n      },\r\n      finalVerdict: {\r\n        name: '',\r\n        duration: [7, 14],\r\n        stage: 'finalVerdict',\r\n        description: '',\r\n        nextStage: 'transfer',\r\n      },\r\n      transfer: {\r\n        name: '',\r\n        duration: [30, 90],\r\n        stage: 'transfer',\r\n        description: '',\r\n        nextStage: 'end',\r\n      },\r\n      deathReview: {\r\n        name: '',\r\n        duration: [180, 720],\r\n        stage: 'deathReview',\r\n        description: '',\r\n        nextStage: 'execution',\r\n      },\r\n      execution: {\r\n        name: '',\r\n        duration: [1, 7],\r\n        stage: 'execution',\r\n        description: '',\r\n        nextStage: 'end',\r\n      },\r\n    },\r\n\r\n    // \r\n    conditionEvents: [\r\n      {\r\n        id: 'mental_breakdown',\r\n        name: '',\r\n        condition: (state: ProtagonistState) => state.mental < 20,\r\n        weight: 100,\r\n        description: '',\r\n        checkAlways: true,\r\n      },\r\n      {\r\n        id: 'health_crisis',\r\n        name: '',\r\n        condition: (state: ProtagonistState) => state.health < 30,\r\n        weight: 100,\r\n        description: '',\r\n        checkAlways: true,\r\n      },\r\n      {\r\n        id: 'major_twist',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (system.currentDay !== system.lastStageChangeDay) return false;\r\n          return Math.random() < 0.15;\r\n        },\r\n        weight: 100,\r\n        description: '',\r\n        stageChangeOnly: true,\r\n      },\r\n      {\r\n        id: 'evidence_reversal',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (system.currentDay !== system.lastStageChangeDay) return false;\r\n          return Math.random() < 0.1;\r\n        },\r\n        weight: 100,\r\n        description: '',\r\n        stageChangeOnly: true,\r\n      },\r\n      {\r\n        id: 'prosecutor_interrogation',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          // 30-37100%+2\r\n          // arrestDayapprovalDaynull30-37\r\n          if (\r\n            system.legalTimeline.arrestDay > 0 &&\r\n            system.legalTimeline.approvalDay === null &&\r\n            system.eventCounters.prosecutor_interrogation === 0\r\n          ) {\r\n            const daysInCustody = system.currentDay - system.legalTimeline.arrestDay;\r\n            const minDays = Math.floor(30 * system.complexityMultiplier);\r\n            const maxDays = Math.floor(37 * system.complexityMultiplier);\r\n\r\n            // 30-37100%\r\n            if (daysInCustody >= minDays && daysInCustody <= maxDays) {\r\n              return true;\r\n            }\r\n          }\r\n          return false;\r\n        },\r\n        weight: 100,\r\n        description: '+2',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'interrogation',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          // 10\r\n          if (system.currentDay <= 10 && system.eventCounters.interrogation === 0) {\r\n            const remainingDays = 10 - system.currentDay + 1;\r\n            const requiredTriggers = 1; // 1\r\n\r\n            // \r\n            if (remainingDays === requiredTriggers) {\r\n              //  CORS \r\n              return true;\r\n            }\r\n\r\n            // 10\r\n            // \r\n            const forcedProbability = requiredTriggers / remainingDays; // \r\n            const shouldTrigger = Math.random() < forcedProbability;\r\n\r\n            //  CORS \r\n\r\n            if (shouldTrigger) {\r\n              return true;\r\n            }\r\n          }\r\n\r\n          //  investigation \r\n          if (system.currentStage !== 'investigation') return false;\r\n\r\n          const daysSinceApproval = system.legalTimeline.approvalDay\r\n            ? system.currentDay - system.legalTimeline.approvalDay\r\n            : 0;\r\n\r\n          let baseProbability = 0.15;\r\n\r\n          if (daysSinceApproval < 30) {\r\n            baseProbability = 0.25;\r\n          } else if (daysSinceApproval < 60) {\r\n            baseProbability = 0.15;\r\n          } else {\r\n            baseProbability = 0.08;\r\n          }\r\n\r\n          const decayFactor = Math.pow(0.7, system.eventCounters.interrogation);\r\n          const finalProbability = baseProbability * decayFactor;\r\n\r\n          return Math.random() < finalProbability;\r\n        },\r\n        weight: 100,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'lawyer_visit',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          //  pretrial  convicted \r\n          if (system.cellType === 'transition') {\r\n            return false;\r\n          }\r\n\r\n          // \r\n          if (!system.eventCounters.interrogation || system.eventCounters.interrogation === 0) {\r\n            return false;\r\n          }\r\n\r\n          let baseProbability = 0.03;\r\n\r\n          const daysInCustody = system.currentDay - system.legalTimeline.arrestDay;\r\n          if (daysInCustody <= 14) {\r\n            baseProbability = 0.15;\r\n          }\r\n\r\n          if (system.legalTimeline.firstTrialDay) {\r\n            const daysToTrial = system.legalTimeline.firstTrialDay - system.currentDay;\r\n            if (daysToTrial > 0 && daysToTrial <= 7) {\r\n              baseProbability = 0.3;\r\n            }\r\n          }\r\n\r\n          if (system.legalTimeline.secondTrialDay) {\r\n            const daysToTrial2 = system.legalTimeline.secondTrialDay - system.currentDay;\r\n            if (daysToTrial2 > 0 && daysToTrial2 <= 7) {\r\n              baseProbability = 0.25;\r\n            }\r\n          }\r\n\r\n          return Math.random() < baseProbability;\r\n        },\r\n        weight: 90,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'family_visit',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          // \r\n          if (!system.legalTimeline.firstVerdictDay) {\r\n            return false;\r\n          }\r\n\r\n          let baseProbability = 0.05;\r\n\r\n          if (system.isDeathPenalty) {\r\n            baseProbability = 0.1;\r\n          }\r\n\r\n          const lastVisit = system.eventHistory\r\n            .filter(e => e.id === 'family_visit')\r\n            .sort((a, b) => (b.day ?? 0) - (a.day ?? 0))[0];\r\n\r\n          if (lastVisit && system.currentDay - (lastVisit.day ?? 0) < 30) {\r\n            return false;\r\n          }\r\n\r\n          return Math.random() < baseProbability;\r\n        },\r\n        weight: 85,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'medical_visit',\r\n        name: '',\r\n        condition: (state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (state.health >= 25) return false;\r\n\r\n          let probability = 0;\r\n          if (state.health < 10) {\r\n            probability = 0.4;\r\n          } else if (state.health < 15) {\r\n            probability = 0.25;\r\n          } else if (state.health < 20) {\r\n            probability = 0.15;\r\n          } else {\r\n            probability = 0.08;\r\n          }\r\n\r\n          const lastMedical = system.eventHistory\r\n            .filter(e => e.id === 'medical_visit')\r\n            .sort((a, b) => (b.day ?? 0) - (a.day ?? 0))[0];\r\n\r\n          if (lastMedical && system.currentDay - (lastMedical.day ?? 0) < 7) {\r\n            return false;\r\n          }\r\n\r\n          return Math.random() < probability;\r\n        },\r\n        weight: 95,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'scene_identification',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (system.currentStage !== 'investigation') return false;\r\n          if (system.eventCounters.scene_identification > 0) return false;\r\n\r\n          const daysSinceApproval = system.legalTimeline.approvalDay\r\n            ? system.currentDay - system.legalTimeline.approvalDay\r\n            : 0;\r\n\r\n          if (daysSinceApproval < 15 || daysSinceApproval > 120) {\r\n            return false;\r\n          }\r\n\r\n          const baseProbability = 0.08;\r\n\r\n          const recentContext = system.getRecentContext ? system.getRecentContext() : '';\r\n          const keywords = ['', '', '', '', ''];\r\n          const hasKeyword = keywords.some(kw => recentContext.includes(kw));\r\n\r\n          const finalProbability = hasKeyword ? baseProbability * 3 : baseProbability;\r\n\r\n          return Math.random() < finalProbability;\r\n        },\r\n        weight: 80,\r\n        description: '',\r\n        category: 'procedural',\r\n        aiControlled: true,\r\n      },\r\n    ],\r\n\r\n    // \r\n    randomEvents: {\r\n      violence: [\r\n        { id: 'newcomer_bullying', name: '', weight: 30 },\r\n        { id: 'bed_dispute', name: '', weight: 25 },\r\n        { id: 'food_robbery', name: '', weight: 20 },\r\n        { id: 'faction_conflict', name: '', weight: 15 },\r\n        { id: 'revenge', name: '', weight: 10 },\r\n      ],\r\n      medical: [\r\n        { id: 'epidemic', name: '', weight: 15 },\r\n        { id: 'mental_illness', name: '', weight: 25 },\r\n        { id: 'chronic_disease', name: '', weight: 20 },\r\n        { id: 'injury', name: '', weight: 20 },\r\n        { id: 'gynecological', name: '', weight: 10 },\r\n        { id: 'malnutrition', name: '', weight: 10 },\r\n      ],\r\n      emotional: [\r\n        { id: 'deep_friendship', name: '', weight: 20 },\r\n        { id: 'betrayal', name: '', weight: 15 },\r\n        { id: 'motherly_bond', name: '', weight: 15 },\r\n        { id: 'jealousy', name: '', weight: 20 },\r\n        { id: 'secret_sharing', name: '', weight: 15 },\r\n        { id: 'collective_exclusion', name: '', weight: 10 },\r\n        { id: 'romance', name: '', weight: 5 },\r\n      ],\r\n      accident: [\r\n        { id: 'facility_failure', name: '', weight: 25 },\r\n        { id: 'safety_incident', name: '', weight: 20 },\r\n        { id: 'external_news', name: '', weight: 30 },\r\n        { id: 'extreme_weather', name: '', weight: 15 },\r\n        { id: 'management_change', name: '', weight: 10 },\r\n      ],\r\n    },\r\n\r\n    // \r\n    innerMonologues: [\r\n      { id: 'worry_about_family', text: '...', weight: 20 },\r\n      { id: 'regret_past', text: '...', weight: 20 },\r\n      { id: 'fear_future', text: '...', weight: 18 },\r\n      { id: 'miss_freedom', text: '...', weight: 15 },\r\n      { id: 'self_reflection', text: '...', weight: 12 },\r\n      { id: 'hope_for_leniency', text: '...', weight: 10 },\r\n      { id: 'worry_about_children', text: '...', weight: 15 },\r\n      { id: 'fear_of_inmates', text: '...', weight: 12 },\r\n      { id: 'loneliness', text: '...', weight: 15 },\r\n      { id: 'time_perception', text: '...', weight: 10 },\r\n      { id: 'dream_of_past', text: '...', weight: 12 },\r\n      { id: 'worry_about_health', text: '...', weight: 10 },\r\n      { id: 'guilt', text: '...', weight: 8 },\r\n      { id: 'anger', text: '...', weight: 8 },\r\n      { id: 'acceptance', text: '...', weight: 7 },\r\n      { id: 'hope_for_appeal', text: '...', weight: 8 },\r\n      { id: 'fear_of_death', text: '...', weight: 5 },\r\n      { id: 'nostalgia', text: '...', weight: 10 },\r\n    ],\r\n\r\n    // \r\n    initialize(startDay = 0) {\r\n      // \r\n      try {\r\n        // ID saveChat \r\n        const currentChatId =\r\n          typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n        if (!currentChatId) {\r\n          console.debug('[] ');\r\n          //  CORS \r\n          // \r\n          this.currentDay = startDay;\r\n          this.legalTimeline.arrestDay = startDay;\r\n          this.currentStage = 'detention';\r\n          this.cellType = 'transition';\r\n          this.caseComplexity = 'normal';\r\n          this.complexityMultiplier = 1.0;\r\n          this.isDeathPenalty = false;\r\n          this.lastStageChangeDay = startDay;\r\n          this.lastEventDay = startDay;\r\n\r\n          for (const key of Object.keys(this.eventCounters)) {\r\n            this.eventCounters[key] = 0;\r\n          }\r\n\r\n          // \r\n          this.assignedOfficers = {\r\n            police: [],\r\n            prosecutor: null,\r\n          };\r\n\r\n          console.info('[] ');\r\n          console.info(`[] : ${this.currentDay}`);\r\n          return;\r\n        }\r\n\r\n        // \r\n        let chatVars: Record<string, any> | null = null;\r\n        try {\r\n          chatVars = getVariables({ type: 'chat' });\r\n          // \r\n          if (!chatVars || typeof chatVars !== 'object') {\r\n            throw new Error('');\r\n          }\r\n        } catch (getVarsError) {\r\n          console.debug('[] :', getVarsError);\r\n          //  CORS \r\n          // \r\n          this.currentDay = startDay;\r\n          this.legalTimeline.arrestDay = startDay;\r\n          this.currentStage = 'detention';\r\n          this.cellType = 'transition';\r\n          this.caseComplexity = 'normal';\r\n          this.complexityMultiplier = 1.0;\r\n          this.isDeathPenalty = false;\r\n          this.lastStageChangeDay = startDay;\r\n          this.lastEventDay = startDay;\r\n\r\n          for (const key of Object.keys(this.eventCounters)) {\r\n            this.eventCounters[key] = 0;\r\n          }\r\n\r\n          console.info('[] ');\r\n          console.info(`[] : ${this.currentDay}`);\r\n          return;\r\n        }\r\n\r\n        if (chatVars && typeof chatVars === 'object') {\r\n          const savedData = (chatVars as Record<string, unknown>).detentionSystemState as\r\n            | {\r\n                currentDay?: number;\r\n                currentStage?: string;\r\n                cellType?: string;\r\n                legalTimeline?: Timeline;\r\n                caseComplexity?: string;\r\n                isDeathPenalty?: boolean;\r\n                eventCounters?: Record<string, number>;\r\n                eventHistory?: EventRecord[];\r\n                lastStageChangeDay?: number;\r\n                assignedOfficers?: { police?: string | string[] | null; prosecutor?: string | null };\r\n              }\r\n            | undefined;\r\n\r\n          if (savedData && typeof savedData === 'object') {\r\n            console.info('[] ');\r\n            this.currentDay = savedData.currentDay ?? startDay;\r\n            this.currentStage = (savedData.currentStage as Stage) ?? 'detention';\r\n            this.cellType = savedData.cellType ?? 'transition';\r\n            this.caseComplexity =\r\n              (savedData.caseComplexity as 'simple' | 'normal' | 'complex' | 'very_complex') ?? 'normal';\r\n            this.isDeathPenalty = Boolean(savedData.isDeathPenalty);\r\n            this.lastStageChangeDay = savedData.lastStageChangeDay ?? startDay;\r\n            this.lastEventDay = this.currentDay;\r\n\r\n            if (savedData.legalTimeline && typeof savedData.legalTimeline === 'object') {\r\n              this.legalTimeline = { ...this.legalTimeline, ...savedData.legalTimeline };\r\n            } else {\r\n              this.legalTimeline.arrestDay = this.currentDay;\r\n            }\r\n\r\n            if (savedData.eventCounters && typeof savedData.eventCounters === 'object') {\r\n              this.eventCounters = { ...this.eventCounters, ...savedData.eventCounters };\r\n            } else {\r\n              for (const key of Object.keys(this.eventCounters)) {\r\n                this.eventCounters[key] = 0;\r\n              }\r\n            }\r\n\r\n            if (Array.isArray(savedData.eventHistory)) {\r\n              this.eventHistory = [...savedData.eventHistory];\r\n            }\r\n\r\n            if (savedData.assignedOfficers && typeof savedData.assignedOfficers === 'object') {\r\n              // policenull\r\n              const savedPolice = savedData.assignedOfficers.police;\r\n              let policeArray: string[] = [];\r\n              if (Array.isArray(savedPolice)) {\r\n                policeArray = savedPolice;\r\n              } else if (typeof savedPolice === 'string' && savedPolice) {\r\n                policeArray = [savedPolice];\r\n              }\r\n\r\n              this.assignedOfficers = {\r\n                police: policeArray,\r\n                prosecutor: savedData.assignedOfficers.prosecutor ?? null,\r\n              };\r\n            } else {\r\n              this.assignedOfficers = {\r\n                police: [],\r\n                prosecutor: null,\r\n              };\r\n            }\r\n\r\n            console.info(`[] : ${this.currentDay}`);\r\n          } else {\r\n            // \r\n            this.currentDay = startDay;\r\n            this.legalTimeline.arrestDay = startDay;\r\n            this.currentStage = 'detention';\r\n            this.cellType = 'transition';\r\n            this.caseComplexity = 'normal';\r\n            this.complexityMultiplier = 1.0;\r\n            this.isDeathPenalty = false;\r\n            this.lastStageChangeDay = startDay;\r\n            this.lastEventDay = startDay;\r\n\r\n            for (const key of Object.keys(this.eventCounters)) {\r\n              this.eventCounters[key] = 0;\r\n            }\r\n          }\r\n        } else {\r\n          // \r\n          this.currentDay = startDay;\r\n          this.legalTimeline.arrestDay = startDay;\r\n          this.currentStage = 'detention';\r\n          this.cellType = 'transition';\r\n          this.caseComplexity = 'normal';\r\n          this.complexityMultiplier = 1.0;\r\n          this.isDeathPenalty = false;\r\n          this.lastStageChangeDay = startDay;\r\n          this.lastEventDay = startDay;\r\n\r\n          for (const key of Object.keys(this.eventCounters)) {\r\n            this.eventCounters[key] = 0;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn('[] :', error);\r\n        // \r\n        this.currentDay = startDay;\r\n        this.legalTimeline.arrestDay = startDay;\r\n        this.currentStage = 'detention';\r\n        this.cellType = 'transition';\r\n        this.caseComplexity = 'normal';\r\n        this.complexityMultiplier = 1.0;\r\n        this.isDeathPenalty = false;\r\n        this.lastStageChangeDay = startDay;\r\n        this.lastEventDay = startDay;\r\n\r\n        for (const key of Object.keys(this.eventCounters)) {\r\n          this.eventCounters[key] = 0;\r\n        }\r\n      }\r\n\r\n      console.info('[] ');\r\n      console.info(`[] : ${this.currentDay}`);\r\n\r\n      // \r\n      // \r\n      setTimeout(() => {\r\n        try {\r\n          // ID\r\n          const currentChatId =\r\n            typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n          if (currentChatId) {\r\n            //  CORS \r\n            this.saveStateToChatVars();\r\n          } else {\r\n            //  CORS \r\n            console.debug('[] ID');\r\n          }\r\n        } catch (error) {\r\n          console.warn('[] :', error);\r\n        }\r\n      }, 2000); // 2\r\n\r\n      DS.events.emit('event_system_initialized', {\r\n        day: this.currentDay,\r\n        stage: this.currentStage,\r\n      });\r\n    },\r\n\r\n    // \r\n    saveStateToChatVars() {\r\n      // \r\n      if (saveStateTimer) {\r\n        clearTimeout(saveStateTimer);\r\n        saveStateTimer = null;\r\n      }\r\n\r\n      // 500ms\r\n      // \r\n      saveStateTimer = setTimeout(() => {\r\n        try {\r\n          // ID saveChat \r\n          const currentChatId =\r\n            typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n          if (!currentChatId) {\r\n            console.debug('[] ');\r\n            //  CORS \r\n            saveStateTimer = null;\r\n            return;\r\n          }\r\n\r\n          const stateData = {\r\n            currentDay: this.currentDay,\r\n            currentStage: this.currentStage,\r\n            cellType: this.cellType,\r\n            legalTimeline: { ...this.legalTimeline },\r\n            caseComplexity: this.caseComplexity,\r\n            isDeathPenalty: this.isDeathPenalty,\r\n            eventCounters: { ...this.eventCounters },\r\n            eventHistory: [...this.eventHistory],\r\n            lastStageChangeDay: this.lastStageChangeDay,\r\n            assignedOfficers: { ...this.assignedOfficers },\r\n          };\r\n\r\n          //  CORS \r\n\r\n          //  eventHistory\r\n          const stateDataStr = JSON.stringify(stateData);\r\n          if (stateDataStr.length > 100000) {\r\n            // 50\r\n            console.warn('[] ');\r\n            const truncatedStateData = {\r\n              ...stateData,\r\n              eventHistory: this.eventHistory.slice(-50),\r\n            };\r\n            //  CORS \r\n            stateData.eventHistory = truncatedStateData.eventHistory;\r\n          }\r\n\r\n          // \r\n          try {\r\n            const testChatVars = getVariables({ type: 'chat' });\r\n            if (!testChatVars || typeof testChatVars !== 'object') {\r\n              console.debug('[] ');\r\n              //  CORS \r\n              saveStateTimer = null;\r\n              return;\r\n            }\r\n          } catch (testError) {\r\n            console.debug('[] :', testError);\r\n            //  CORS \r\n            saveStateTimer = null;\r\n            return;\r\n          }\r\n\r\n          // \r\n          try {\r\n            const testChatVars = getVariables({ type: 'chat' });\r\n            if (!testChatVars || typeof testChatVars !== 'object') {\r\n              console.debug('[] ');\r\n              //  CORS \r\n              saveStateTimer = null;\r\n              return;\r\n            }\r\n          } catch (testError) {\r\n            console.debug('[] :', testError);\r\n            //  CORS \r\n            saveStateTimer = null;\r\n            return;\r\n          }\r\n\r\n          //  updateVariablesWith  replaceVariables\r\n          // \r\n          updateVariablesWith(\r\n            variables => {\r\n              return { ...variables, detentionSystemState: stateData };\r\n            },\r\n            { type: 'chat' },\r\n          );\r\n\r\n          //  CORS \r\n          console.debug('[]   ()');\r\n        } catch (error) {\r\n          //  CORS \r\n          console.warn('[]  (updateVariablesWith):', error);\r\n          //  updateVariablesWith  replaceVariables\r\n          // \r\n        }\r\n        saveStateTimer = null;\r\n      }, 500); // 500ms\r\n    },\r\n\r\n    setCaseComplexity(complexity: 'simple' | 'normal' | 'complex' | 'very_complex') {\r\n      const validComplexities: Record<string, number> = {\r\n        simple: 0.8,\r\n        normal: 1.0,\r\n        complex: 1.3,\r\n        very_complex: 1.6,\r\n      };\r\n\r\n      if (complexity in validComplexities) {\r\n        this.caseComplexity = complexity;\r\n        this.complexityMultiplier = validComplexities[complexity];\r\n\r\n        console.info(`[] : ${complexity} (: ${this.complexityMultiplier})`);\r\n\r\n        DS.events.emit('complexity_changed', {\r\n          complexity: this.caseComplexity,\r\n          multiplier: this.complexityMultiplier,\r\n        });\r\n      } else {\r\n        console.warn(`[] : ${complexity}`);\r\n      }\r\n    },\r\n\r\n    checkComplexityAdjustment() {\r\n      if (this.currentDay % 30 !== 0) return;\r\n\r\n      DS.events.emit('request_complexity_assessment', {\r\n        day: this.currentDay,\r\n        stage: this.currentStage,\r\n        eventHistory: this.eventHistory,\r\n      });\r\n    },\r\n\r\n    rollbackToStage(targetStage: Stage, reason = '') {\r\n      console.info(`[] : ${this.currentStage} -> ${targetStage}`);\r\n      console.info(`[] : ${reason}`);\r\n\r\n      const stageOrder: Stage[] = [\r\n        'detention',\r\n        'approval',\r\n        'investigation',\r\n        'prosecution',\r\n        'trial1',\r\n        'firstVerdict',\r\n        'appeal',\r\n        'trial2',\r\n        'finalVerdict',\r\n        'transfer',\r\n        'execution',\r\n      ];\r\n\r\n      const targetIndex = stageOrder.indexOf(targetStage);\r\n      const currentIndex = stageOrder.indexOf(this.currentStage);\r\n\r\n      if (targetIndex === -1 || targetIndex >= currentIndex) {\r\n        console.warn('[] ');\r\n        return false;\r\n      }\r\n\r\n      const timelineKeys: Partial<Record<Stage, keyof Timeline>> = {\r\n        approval: 'approvalDay',\r\n        investigation: 'approvalDay',\r\n        prosecution: 'prosecutionDay',\r\n        trial1: 'firstTrialDay',\r\n        firstVerdict: 'firstVerdictDay',\r\n        appeal: 'firstVerdictDay',\r\n        trial2: 'secondTrialDay',\r\n        finalVerdict: 'finalVerdictDay',\r\n        transfer: 'transferDay',\r\n        execution: 'executionDay',\r\n      };\r\n\r\n      for (let i = targetIndex + 1; i < stageOrder.length; i++) {\r\n        const stage = stageOrder[i];\r\n        const key = timelineKeys[stage];\r\n        if (key && this.legalTimeline[key]) {\r\n          this.legalTimeline[key] = null as never;\r\n        }\r\n      }\r\n\r\n      this.currentStage = targetStage;\r\n\r\n      if (targetIndex <= stageOrder.indexOf('investigation')) {\r\n        this.cellType = 'pretrial';\r\n      }\r\n\r\n      this.eventHistory.push({\r\n        id: 'procedure_rollback',\r\n        name: '',\r\n        type: 'legal',\r\n        day: this.currentDay,\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n      });\r\n\r\n      DS.events.emit('procedure_rollback', {\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n        day: this.currentDay,\r\n      });\r\n\r\n      return true;\r\n    },\r\n\r\n    // \r\n    advanceToStage(targetStage: Stage, reason = '') {\r\n      console.info(`[] : ${this.currentStage} -> ${targetStage}`);\r\n      console.info(`[] : ${reason}`);\r\n\r\n      const stageOrder: Stage[] = [\r\n        'detention',\r\n        'approval',\r\n        'investigation',\r\n        'prosecution',\r\n        'trial1',\r\n        'firstVerdict',\r\n        'appeal',\r\n        'trial2',\r\n        'finalVerdict',\r\n        'transfer',\r\n        'execution',\r\n      ];\r\n\r\n      const targetIndex = stageOrder.indexOf(targetStage);\r\n      const currentIndex = stageOrder.indexOf(this.currentStage);\r\n\r\n      if (targetIndex === -1) {\r\n        console.warn(`[] : ${targetStage}`);\r\n        return false;\r\n      }\r\n\r\n      if (targetIndex <= currentIndex) {\r\n        console.warn(`[]  ${targetStage}  ${this.currentStage} `);\r\n        return false;\r\n      }\r\n\r\n      // \r\n      const timelineKeys: Partial<Record<Stage, keyof Timeline>> = {\r\n        approval: 'approvalDay',\r\n        investigation: 'approvalDay',\r\n        prosecution: 'prosecutionDay',\r\n        trial1: 'firstTrialDay',\r\n        firstVerdict: 'firstVerdictDay',\r\n        appeal: 'firstVerdictDay',\r\n        trial2: 'secondTrialDay',\r\n        finalVerdict: 'finalVerdictDay',\r\n        transfer: 'transferDay',\r\n        execution: 'executionDay',\r\n      };\r\n\r\n      // \r\n      for (let i = currentIndex + 1; i <= targetIndex; i++) {\r\n        const stage = stageOrder[i];\r\n        const key = timelineKeys[stage];\r\n        if (key && !this.legalTimeline[key]) {\r\n          // \r\n          (this.legalTimeline as any)[key] = this.currentDay;\r\n        }\r\n      }\r\n\r\n      // \r\n      this.currentStage = targetStage;\r\n      this.lastStageChangeDay = this.currentDay;\r\n\r\n      // \r\n      // \r\n      if (targetIndex >= stageOrder.indexOf('investigation') && targetIndex < stageOrder.indexOf('firstVerdict')) {\r\n        this.cellType = 'pretrial';\r\n      }\r\n      // \r\n      if (targetIndex >= stageOrder.indexOf('firstVerdict')) {\r\n        this.cellType = 'convicted';\r\n      }\r\n\r\n      // \r\n      if (targetStage === 'execution') {\r\n        this.isDeathPenalty = true;\r\n        // \r\n        this.legalTimeline.executionDay = this.currentDay;\r\n      }\r\n\r\n      // \r\n      this.eventHistory.push({\r\n        id: 'procedure_advance',\r\n        name: '',\r\n        type: 'legal',\r\n        day: this.currentDay,\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n      });\r\n\r\n      // \r\n      this.saveStateToChatVars();\r\n\r\n      // \r\n      DS.events.emit('procedure_advance', {\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n        day: this.currentDay,\r\n      });\r\n\r\n      console.info(`[]  : ${targetStage} (${this.currentDay})`);\r\n\r\n      return true;\r\n    },\r\n\r\n    handleUserRollback(input: string) {\r\n      const rollbackPatterns = [\r\n        { pattern: /.*?.*?(|||)/, stage: null as Stage | null },\r\n        { pattern: /.*?(|)/, stage: null as Stage | null },\r\n        { pattern: /.*?(|)/, stage: null as Stage | null },\r\n      ];\r\n\r\n      for (const rule of rollbackPatterns) {\r\n        const match = input.match(rule.pattern);\r\n        if (match) {\r\n          let targetStage: Stage | null = null;\r\n\r\n          if (match[1].includes('')) {\r\n            targetStage = 'investigation';\r\n          } else if (match[1].includes('')) {\r\n            targetStage = 'prosecution';\r\n          } else if (match[1].includes('')) {\r\n            targetStage = 'trial1';\r\n          } else if (match[1].includes('')) {\r\n            targetStage = 'trial2';\r\n          }\r\n\r\n          if (targetStage) {\r\n            return this.rollbackToStage(targetStage, '');\r\n          }\r\n        }\r\n      }\r\n\r\n      return false;\r\n    },\r\n\r\n    advanceDay(days = 1) {\r\n      const events: EventRecord[] = [];\r\n      // \r\n      const startDay = this.getCurrentDayInternal();\r\n\r\n      // currentDay\r\n      // AIconfirmDayAdvancement\r\n      // \r\n      let tempCurrentDay = this.getCurrentDayInternal();\r\n\r\n      //  CORS \r\n\r\n      // days>=1\r\n      const daysToAdvance = Math.max(1, Math.floor(days));\r\n\r\n      // LEGAL, PROCEDURAL, CONDITION\r\n      for (let i = 0; i < daysToAdvance; i++) {\r\n        tempCurrentDay++;\r\n        //  this.currentDay\r\n        // AI confirmDayAdvancement \r\n\r\n        //  CORS \r\n\r\n        // currentDay\r\n        const originalCurrentDay = this.currentDay;\r\n        this.currentDay = tempCurrentDay;\r\n        this.lastEventDay = tempCurrentDay;\r\n\r\n        //  CORS \r\n\r\n        this.checkComplexityAdjustment();\r\n\r\n        const dayEvent = this.checkDayEvents();\r\n\r\n        // originalCurrentDayAI\r\n        this.currentDay = originalCurrentDay;\r\n\r\n        //  CORS \r\n\r\n        // 0\r\n        if (tempCurrentDay === 0 && dayEvent && dayEvent.id !== 'no_event') {\r\n          //  CORS \r\n          continue; // 0\r\n        }\r\n\r\n        if (dayEvent) {\r\n          events.push(dayEvent);\r\n\r\n          this.eventHistory.push({\r\n            ...dayEvent,\r\n            day: tempCurrentDay,\r\n          });\r\n\r\n          if (Object.prototype.hasOwnProperty.call(this.eventCounters, dayEvent.id)) {\r\n            this.eventCounters[dayEvent.id] = (this.eventCounters[dayEvent.id] || 0) + 1;\r\n          }\r\n\r\n          // \r\n          // LEGAL: 1, PROCEDURAL: 2, CONDITION: 3, RANDOM: 4DAILY: 5\r\n          const eventPriority = dayEvent.priority ?? this.PRIORITY.DAILY;\r\n          const shouldInterrupt = eventPriority <= this.PRIORITY.RANDOM;\r\n\r\n          //  CORS \r\n\r\n          // LEGAL: 1, PROCEDURAL: 2, CONDITION: 3, RANDOM: 4\r\n          // DAILY: 5\r\n          if (shouldInterrupt) {\r\n            console.info(\r\n              `[] ${tempCurrentDay}: ${dayEvent.name} (: ${eventPriority})`,\r\n            );\r\n\r\n            // currentDay\r\n            // AIconfirmDayAdvancement\r\n            // \r\n            const pendingDays = tempCurrentDay - startDay;\r\n\r\n            // currentDay\r\n            this.saveStateToChatVars();\r\n\r\n            // accumulatedEvents\r\n            // \r\n            const eventData = {\r\n              ...dayEvent,\r\n              day: tempCurrentDay, // \r\n              pendingDayAdvancement: pendingDays, // \r\n              startDay, // \r\n            };\r\n            DS.events.emit('event_triggered', eventData);\r\n\r\n            //  CORS \r\n\r\n            const result = {\r\n              interrupted: true,\r\n              currentDay: this.currentDay, // currentDay\r\n              tempCurrentDay, // \r\n              pendingDays, // \r\n              event: { ...dayEvent, day: tempCurrentDay },\r\n            };\r\n\r\n            //  CORS \r\n\r\n            return result;\r\n          } else {\r\n            // DAILY: 5\r\n            // RANDOMDAILY\r\n            console.debug(\r\n              `[] ${tempCurrentDay}: ${dayEvent.name} (: ${eventPriority})`,\r\n            );\r\n            //  CORS \r\n          }\r\n        } else {\r\n          //  CORS \r\n        }\r\n      }\r\n\r\n      //  CORS \r\n\r\n      // LEGAL, PROCEDURAL, CONDITION, RANDOM\r\n      const interruptedEvent = events.find(e => {\r\n        const priority = e.priority ?? this.PRIORITY.DAILY;\r\n        return priority <= this.PRIORITY.RANDOM;\r\n      });\r\n\r\n      // currentDay\r\n      this.saveStateToChatVars();\r\n\r\n      // \r\n      const pendingDays = tempCurrentDay - startDay;\r\n\r\n      // \r\n      if (interruptedEvent) {\r\n        return {\r\n          interrupted: true,\r\n          currentDay: this.currentDay, // currentDay\r\n          tempCurrentDay, // \r\n          pendingDays, // \r\n          event: { ...interruptedEvent, day: tempCurrentDay },\r\n        };\r\n      }\r\n\r\n      // \r\n      // AIconfirmDayAdvancement\r\n      return {\r\n        interrupted: false,\r\n        currentDay: this.currentDay, // currentDay\r\n        tempCurrentDay, // \r\n        pendingDays, // \r\n      };\r\n    },\r\n\r\n    checkDayEvents(): EventRecord {\r\n      //  CORS \r\n\r\n      // 0\r\n      if (this.currentDay === 0) {\r\n        //  CORS \r\n        return {\r\n          id: 'no_event',\r\n          name: '',\r\n          type: 'daily',\r\n          description: '0',\r\n          priority: this.PRIORITY.DAILY,\r\n          day: 0,\r\n        };\r\n      }\r\n\r\n      // \r\n      const currentDate = new Date();\r\n      const month = currentDate.getMonth() + 1;\r\n      const day = currentDate.getDate();\r\n\r\n      // 1. \r\n      const cellTransferResult = this.checkCellTransfer();\r\n      if (cellTransferResult) {\r\n        //  LEGAL\r\n        //  CORS \r\n\r\n        // \r\n        const cellTypeNames: Record<string, string> = {\r\n          transition: '',\r\n          pretrial: '',\r\n          convicted: '',\r\n        };\r\n        const fromCellName = cellTypeNames['transition'] || '';\r\n        const toCellName = cellTypeNames[this.cellType] || '';\r\n\r\n        return {\r\n          id: 'cell_transfer',\r\n          name: '',\r\n          type: 'legal',\r\n          description: `${fromCellName}${toCellName}`,\r\n          priority: this.PRIORITY.LEGAL,\r\n          day: this.currentDay,\r\n          from: 'transition',\r\n          to: this.cellType,\r\n          reason: '',\r\n          text: `${month}${day}`,\r\n        };\r\n      }\r\n\r\n      // 2. \r\n      const legalEvent = this.checkLegalEvent();\r\n      if (legalEvent) {\r\n        //  CORS \r\n        return {\r\n          ...legalEvent,\r\n          priority: this.PRIORITY.LEGAL,\r\n          day: this.currentDay,\r\n          text: `${month}${day}${legalEvent.name}`,\r\n        };\r\n      }\r\n\r\n      // 3. \r\n      const conditionEvent = this.checkConditionEvent();\r\n      if (conditionEvent) {\r\n        // \r\n        const isProcedural =\r\n          conditionEvent.id === 'interrogation' ||\r\n          conditionEvent.id === 'lawyer_visit' ||\r\n          conditionEvent.id === 'family_visit' ||\r\n          conditionEvent.id === 'prosecutor_interrogation';\r\n\r\n        const eventPriority = isProcedural ? this.PRIORITY.PROCEDURAL : this.PRIORITY.CONDITION;\r\n\r\n        // \r\n        if (conditionEvent.id === 'interrogation' || conditionEvent.id === 'prosecutor_interrogation') {\r\n          const policeNames = ['', '', '', '', '', '', '', ''];\r\n          const prosecutorNames = ['', '', '', '', '', ''];\r\n\r\n          // 30-371+2\r\n          if (conditionEvent.id === 'prosecutor_interrogation') {\r\n            // 22\r\n            if (this.assignedOfficers.police.length < 2) {\r\n              const usedNames = new Set(this.assignedOfficers.police);\r\n              while (this.assignedOfficers.police.length < 2) {\r\n                const availableNames = policeNames.filter(name => !usedNames.has(name));\r\n                if (availableNames.length === 0) break;\r\n                const selectedName = availableNames[Math.floor(Math.random() * availableNames.length)];\r\n                this.assignedOfficers.police.push(selectedName);\r\n                usedNames.add(selectedName);\r\n              }\r\n              console.info(`[] : ${this.assignedOfficers.police.join('')}`);\r\n            }\r\n\r\n            // \r\n            if (!this.assignedOfficers.prosecutor) {\r\n              this.assignedOfficers.prosecutor = prosecutorNames[Math.floor(Math.random() * prosecutorNames.length)];\r\n              console.info(`[] : ${this.assignedOfficers.prosecutor}`);\r\n            }\r\n\r\n            // +2\r\n            conditionEvent.description = `${this.assignedOfficers.prosecutor}${this.assignedOfficers.police.join('')}`;\r\n          }\r\n          // \r\n          else if (conditionEvent.id === 'interrogation') {\r\n            // 2\r\n            if (this.assignedOfficers.police.length < 2) {\r\n              const usedNames = new Set(this.assignedOfficers.police);\r\n              while (this.assignedOfficers.police.length < 2) {\r\n                const availableNames = policeNames.filter(name => !usedNames.has(name));\r\n                if (availableNames.length === 0) break;\r\n                const selectedName = availableNames[Math.floor(Math.random() * availableNames.length)];\r\n                this.assignedOfficers.police.push(selectedName);\r\n                usedNames.add(selectedName);\r\n              }\r\n              console.info(`[] : ${this.assignedOfficers.police.join('')}`);\r\n            }\r\n\r\n            // 50%\r\n            const hasApproval = this.legalTimeline.approvalDay !== null;\r\n            const beforeFirstTrial =\r\n              !this.legalTimeline.firstTrialDay || this.currentDay < this.legalTimeline.firstTrialDay;\r\n            const isInvestigationOrProsecution =\r\n              this.currentStage === 'investigation' || this.currentStage === 'prosecution';\r\n\r\n            if (hasApproval && beforeFirstTrial && isInvestigationOrProsecution && Math.random() < 0.5) {\r\n              // \r\n              if (!this.assignedOfficers.prosecutor) {\r\n                this.assignedOfficers.prosecutor = prosecutorNames[Math.floor(Math.random() * prosecutorNames.length)];\r\n                console.info(`[] : ${this.assignedOfficers.prosecutor}`);\r\n              }\r\n              // 2+\r\n              conditionEvent.description = `${this.assignedOfficers.police.join('')}${this.assignedOfficers.prosecutor}`;\r\n            } else {\r\n              // 2\r\n              conditionEvent.description = `${this.assignedOfficers.police.join('')}`;\r\n            }\r\n          }\r\n        }\r\n\r\n        //  CORS \r\n\r\n        // LEGALPROCEDURALCONDITION\r\n        const shouldInterrupt = eventPriority <= this.PRIORITY.CONDITION;\r\n\r\n        return {\r\n          ...conditionEvent,\r\n          priority: eventPriority,\r\n          day: this.currentDay,\r\n          text: shouldInterrupt\r\n            ? `${month}${day}${conditionEvent.name}`\r\n            : undefined,\r\n        };\r\n      }\r\n\r\n      // 4. 05%\r\n      if (this.currentDay > 0 && this.cellType !== 'transition' && Math.random() < 0.05) {\r\n        const randomEvent = this.generateRandomEvent();\r\n        if (randomEvent) {\r\n          return {\r\n            ...randomEvent,\r\n            priority: this.PRIORITY.RANDOM,\r\n            day: this.currentDay,\r\n            text: `${month}${day}${randomEvent.name}`,\r\n          };\r\n        }\r\n      }\r\n\r\n      // 5. \r\n      if (Math.random() < 0.15) {\r\n        const monologue = this.generateInnerMonologue();\r\n        if (monologue) {\r\n          return {\r\n            ...monologue,\r\n            priority: this.PRIORITY.DAILY,\r\n            day: this.currentDay,\r\n          };\r\n        }\r\n      }\r\n\r\n      // 6. \r\n      return {\r\n        id: 'daily_routine',\r\n        name: '',\r\n        type: 'daily',\r\n        priority: this.PRIORITY.DAILY,\r\n        day: this.currentDay,\r\n        description: '',\r\n      };\r\n    },\r\n\r\n    checkLegalEvent(): EventRecord | null {\r\n      const daysInCustody = this.currentDay - this.legalTimeline.arrestDay;\r\n      const stageBefore = this.currentStage;\r\n\r\n      if (!this.legalTimeline.approvalDay) {\r\n        const minDays = Math.floor(30 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(37 * this.complexityMultiplier);\r\n\r\n        if (daysInCustody >= minDays && daysInCustody <= maxDays) {\r\n          if (Math.random() < 0.3) {\r\n            this.legalTimeline.approvalDay = this.currentDay;\r\n            this.currentStage = 'investigation';\r\n            this.lastStageChangeDay = this.currentDay;\r\n            return {\r\n              id: 'approval',\r\n              name: '',\r\n              type: 'legal',\r\n              stage: 'approval',\r\n              description: '',\r\n              from: stageBefore,\r\n              to: 'investigation',\r\n            };\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.approvalDay && !this.legalTimeline.prosecutionDay) {\r\n        const daysSinceApproval = this.currentDay - this.legalTimeline.approvalDay;\r\n        const minDays = Math.floor(60 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(210 * this.complexityMultiplier);\r\n\r\n        if (daysSinceApproval >= minDays && daysSinceApproval <= maxDays && Math.random() < 0.02) {\r\n          this.legalTimeline.prosecutionDay = this.currentDay;\r\n          this.currentStage = 'prosecution';\r\n          this.lastStageChangeDay = this.currentDay;\r\n          return {\r\n            id: 'prosecution',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'prosecution',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'prosecution',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.prosecutionDay && !this.legalTimeline.firstTrialDay) {\r\n        const daysSinceProsecution = this.currentDay - this.legalTimeline.prosecutionDay;\r\n        const minDays = Math.floor(30 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(45 * this.complexityMultiplier);\r\n\r\n        if (daysSinceProsecution >= minDays && daysSinceProsecution <= maxDays && Math.random() < 0.05) {\r\n          this.legalTimeline.firstTrialDay = this.currentDay;\r\n          this.currentStage = 'trial1';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          if (this.cellType === 'transition') {\r\n            this.cellType = 'pretrial';\r\n            DS.events.emit('cell_transfer', {\r\n              from: 'transition',\r\n              to: 'pretrial',\r\n              reason: '',\r\n            });\r\n          }\r\n\r\n          return {\r\n            id: 'first_trial',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'trial1',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'trial1',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.firstTrialDay && !this.legalTimeline.firstVerdictDay) {\r\n        const daysSinceTrial = this.currentDay - this.legalTimeline.firstTrialDay;\r\n        const minDays = Math.floor(7 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(30 * this.complexityMultiplier);\r\n\r\n        if (daysSinceTrial >= minDays && daysSinceTrial <= maxDays && Math.random() < 0.1) {\r\n          this.legalTimeline.firstVerdictDay = this.currentDay;\r\n          this.currentStage = 'appeal';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          this.cellType = 'convicted';\r\n          DS.events.emit('cell_transfer', {\r\n            from: 'pretrial',\r\n            to: 'convicted',\r\n            reason: '',\r\n          });\r\n\r\n          return {\r\n            id: 'first_verdict',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'firstVerdict',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'appeal',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (\r\n        this.legalTimeline.firstVerdictDay &&\r\n        !this.legalTimeline.secondTrialDay &&\r\n        !this.legalTimeline.finalVerdictDay\r\n      ) {\r\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.firstVerdictDay;\r\n\r\n        if (daysSinceVerdict === 10) {\r\n          if (Math.random() < 0.7) {\r\n            this.legalTimeline.secondTrialDay = this.currentDay;\r\n            this.currentStage = 'trial2';\r\n            this.lastStageChangeDay = this.currentDay;\r\n\r\n            return {\r\n              id: 'appeal_filed',\r\n              name: '',\r\n              type: 'legal',\r\n              stage: 'appeal',\r\n              description: '',\r\n              from: stageBefore,\r\n              to: 'trial2',\r\n            };\r\n          } else {\r\n            this.legalTimeline.finalVerdictDay = this.currentDay;\r\n            this.currentStage = 'transfer';\r\n            this.lastStageChangeDay = this.currentDay;\r\n\r\n            return {\r\n              id: 'verdict_final',\r\n              name: '',\r\n              type: 'legal',\r\n              stage: 'finalVerdict',\r\n              description: '',\r\n              from: stageBefore,\r\n              to: 'transfer',\r\n            };\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.secondTrialDay && !this.legalTimeline.finalVerdictDay) {\r\n        const daysSinceAppeal = this.currentDay - this.legalTimeline.secondTrialDay;\r\n        const minDays = Math.floor(60 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(90 * this.complexityMultiplier);\r\n\r\n        if (daysSinceAppeal >= minDays && daysSinceAppeal <= maxDays && Math.random() < 0.03) {\r\n          this.legalTimeline.finalVerdictDay = this.currentDay;\r\n          this.currentStage = 'transfer';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          return {\r\n            id: 'final_verdict',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'finalVerdict',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'transfer',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.finalVerdictDay && !this.legalTimeline.transferDay && !this.isDeathPenalty) {\r\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.finalVerdictDay;\r\n        const minDays = Math.floor(30 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(90 * this.complexityMultiplier);\r\n\r\n        if (daysSinceVerdict >= minDays && daysSinceVerdict <= maxDays && Math.random() < 0.02) {\r\n          this.legalTimeline.transferDay = this.currentDay;\r\n          this.currentStage = 'end';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          return {\r\n            id: 'transfer_prison',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'transfer',\r\n            description: '',\r\n            isEnding: true,\r\n            endingType: 'prison',\r\n            from: stageBefore,\r\n            to: 'end',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.finalVerdictDay && this.isDeathPenalty && !this.legalTimeline.executionDay) {\r\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.finalVerdictDay;\r\n        const minDays = 180;\r\n        const maxDays = 720;\r\n\r\n        if (daysSinceVerdict >= minDays && daysSinceVerdict <= maxDays && Math.random() < 0.005) {\r\n          this.legalTimeline.executionDay = this.currentDay + 7;\r\n          this.currentStage = 'execution';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          return {\r\n            id: 'death_review_approved',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'deathReview',\r\n            description: '7',\r\n            from: stageBefore,\r\n            to: 'execution',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.executionDay && this.currentDay >= this.legalTimeline.executionDay) {\r\n        this.currentStage = 'end';\r\n        this.lastStageChangeDay = this.currentDay;\r\n\r\n        return {\r\n          id: 'execution',\r\n          name: '',\r\n          type: 'legal',\r\n          stage: 'execution',\r\n          description: '',\r\n          isEnding: true,\r\n          endingType: 'death',\r\n          from: stageBefore,\r\n          to: 'end',\r\n        };\r\n      }\r\n\r\n      return null;\r\n    },\r\n\r\n    checkConditionEvent(): EventRecord | null {\r\n      const state = this.getProtagonistState();\r\n\r\n      //  CORS \r\n\r\n      for (const event of this.conditionEvents) {\r\n        if (event.stageChangeOnly && this.currentDay !== this.lastStageChangeDay) {\r\n          continue;\r\n        }\r\n\r\n        if (event.checkAlways || !event.stageChangeOnly) {\r\n          const conditionResult = event.condition(state, this);\r\n          //  CORS \r\n\r\n          if (conditionResult) {\r\n            const randomCheck = Math.random() * 100 < event.weight;\r\n            //  CORS \r\n\r\n            if (randomCheck) {\r\n              //  CORS \r\n\r\n              return {\r\n                id: event.id,\r\n                name: event.name,\r\n                type: event.category || 'condition',\r\n                description: event.description,\r\n                aiControlled: event.aiControlled || false,\r\n              };\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      return null;\r\n    },\r\n\r\n    generateRandomEvent(): EventRecord | null {\r\n      const types = ['violence', 'medical', 'emotional', 'accident'] as const;\r\n      const weights = [25, 30, 30, 15];\r\n\r\n      const typeIndex = this.weightedRandom(types.length, weights);\r\n      const eventType = types[typeIndex];\r\n      const eventList = this.randomEvents[eventType];\r\n\r\n      const eventWeights = eventList.map(e => e.weight);\r\n      const eventIndex = this.weightedRandom(eventList.length, eventWeights);\r\n      const event = eventList[eventIndex];\r\n\r\n      return {\r\n        id: event.id,\r\n        name: event.name,\r\n        type: eventType,\r\n        category: 'random',\r\n        description: `: ${event.name}`,\r\n      };\r\n    },\r\n\r\n    generateInnerMonologue(): EventRecord | null {\r\n      const weights = this.innerMonologues.map(m => m.weight);\r\n      const index = this.weightedRandom(this.innerMonologues.length, weights);\r\n      const monologue = this.innerMonologues[index];\r\n\r\n      return {\r\n        id: monologue.id,\r\n        name: '',\r\n        type: 'monologue',\r\n        category: 'daily',\r\n        description: monologue.text,\r\n        text: monologue.text,\r\n      };\r\n    },\r\n\r\n    weightedRandom(count: number, weights: number[]): number {\r\n      const totalWeight = weights.reduce((sum, w) => sum + w, 0);\r\n      let random = Math.random() * totalWeight;\r\n\r\n      for (let i = 0; i < count; i++) {\r\n        random -= weights[i];\r\n        if (random <= 0) {\r\n          return i;\r\n        }\r\n      }\r\n\r\n      return count - 1;\r\n    },\r\n\r\n    getProtagonistState(): ProtagonistState {\r\n      // \r\n      console.log('[] getProtagonistState: ');\r\n\r\n      //  CORS \r\n\r\n      //  getState()\r\n      //  >  >  > \r\n      const statusPanel = DS.getModule<{ getState?: () => ProtagonistState }>('statusPanel');\r\n\r\n      //  CORS \r\n\r\n      if (statusPanel && statusPanel.getState) {\r\n        const state = statusPanel.getState();\r\n        //  CORS \r\n        // \r\n        return state;\r\n      }\r\n\r\n      // \r\n      const fallbackState: ProtagonistState = {\r\n        health: 70,\r\n        mental: 65,\r\n        strength: 50,\r\n        intelligence: 55,\r\n        //  undefined ProtagonistState \r\n      };\r\n\r\n      //  CORS \r\n\r\n      console.warn('[] ');\r\n      return fallbackState;\r\n    },\r\n\r\n    getRecentContext(): string {\r\n      if (Array.isArray(window.chat)) {\r\n        const recentMessages = window.chat.slice(-5);\r\n        return recentMessages.map(m => m.mes || '').join(' ');\r\n      }\r\n      return '';\r\n    },\r\n\r\n    checkCellTransfer() {\r\n      const daysInCustody = this.currentDay - this.legalTimeline.arrestDay;\r\n\r\n      // \r\n      if (this.cellType === 'transition' && daysInCustody >= 7 && daysInCustody <= 14) {\r\n        this.cellType = 'pretrial';\r\n        DS.events.emit('cell_transfer', {\r\n          from: 'transition',\r\n          to: 'pretrial',\r\n          reason: '',\r\n          day: this.currentDay,\r\n        });\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    },\r\n\r\n    setDeathPenalty(isDeathPenalty: boolean) {\r\n      this.isDeathPenalty = isDeathPenalty;\r\n      console.info(`[] : ${isDeathPenalty}`);\r\n\r\n      DS.events.emit('death_penalty_status_changed', {\r\n        isDeathPenalty: this.isDeathPenalty,\r\n        day: this.currentDay,\r\n      });\r\n    },\r\n\r\n    getCurrentStageInfo() {\r\n      // \r\n      const cellTypeNames: Record<string, string> = {\r\n        transition: '',\r\n        pretrial: '',\r\n        convicted: '',\r\n      };\r\n      const cellTypeChinese = cellTypeNames[this.cellType] || '';\r\n\r\n      return {\r\n        day: this.currentDay,\r\n        stage: this.currentStage,\r\n        cellType: cellTypeChinese,\r\n        cellTypeRaw: this.cellType, // \r\n        daysInCustody: this.currentDay - this.legalTimeline.arrestDay,\r\n        timeline: { ...this.legalTimeline },\r\n        complexity: this.caseComplexity,\r\n        complexityMultiplier: this.complexityMultiplier,\r\n        isDeathPenalty: this.isDeathPenalty,\r\n        eventCounters: { ...this.eventCounters },\r\n      };\r\n    },\r\n\r\n    getEventStatistics() {\r\n      const stats: {\r\n        totalEvents: number;\r\n        byType: Record<string, number>;\r\n        byPriority: Record<number, number>;\r\n        recentEvents: EventRecord[];\r\n      } = {\r\n        totalEvents: this.eventHistory.length,\r\n        byType: {},\r\n        byPriority: {},\r\n        recentEvents: this.eventHistory.slice(-10),\r\n      };\r\n\r\n      this.eventHistory.forEach((event: EventRecord) => {\r\n        const type = event.type || 'unknown';\r\n        stats.byType[type] = (stats.byType[type] || 0) + 1;\r\n\r\n        const priority = event.priority || 4;\r\n        stats.byPriority[priority] = (stats.byPriority[priority] || 0) + 1;\r\n      });\r\n\r\n      return stats;\r\n    },\r\n\r\n    exportTimeline() {\r\n      return {\r\n        currentDay: this.currentDay,\r\n        currentStage: this.currentStage,\r\n        cellType: this.cellType,\r\n        timeline: { ...this.legalTimeline },\r\n        complexity: this.caseComplexity,\r\n        isDeathPenalty: this.isDeathPenalty,\r\n        eventCounters: { ...this.eventCounters },\r\n        eventHistory: [...this.eventHistory],\r\n        lastStageChangeDay: this.lastStageChangeDay,\r\n      };\r\n    },\r\n\r\n    importTimeline(data: any) {\r\n      if (!data) return false;\r\n\r\n      try {\r\n        this.currentDay = data.currentDay || 0;\r\n        this.currentStage = (data.currentStage as Stage) || 'detention';\r\n        this.cellType = data.cellType || 'transition';\r\n        this.legalTimeline = (data.timeline as Timeline) || ({} as Timeline);\r\n        this.caseComplexity = data.complexity || 'normal';\r\n        this.isDeathPenalty = Boolean(data.isDeathPenalty);\r\n        this.eventCounters = data.eventCounters || {};\r\n        this.eventHistory = data.eventHistory || [];\r\n        this.lastStageChangeDay = data.lastStageChangeDay || 0;\r\n\r\n        console.info('[] ');\r\n        return true;\r\n      } catch (error) {\r\n        console.error('[] :', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    // \r\n    // advanceDay\"\"\r\n    // AIsaveStateToChatVars\r\n    saveEventInterruptSnapshot() {\r\n      try {\r\n        // ID saveChat \r\n        const currentChatId =\r\n          typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n        if (!currentChatId) {\r\n          console.debug('[] ');\r\n          //  CORS \r\n          return;\r\n        }\r\n\r\n        // \r\n        try {\r\n          const testChatVars = getVariables({ type: 'chat' });\r\n          if (!testChatVars || typeof testChatVars !== 'object') {\r\n            console.debug('[] ');\r\n            //  CORS \r\n            return;\r\n          }\r\n        } catch (testError) {\r\n          console.debug('[] :', testError);\r\n          //  CORS \r\n          return;\r\n        }\r\n\r\n        // \r\n        // saveStateToChatVars\r\n        const snapshot = {\r\n          currentDay: this.currentDay,\r\n          currentStage: this.currentStage,\r\n          cellType: this.cellType,\r\n          legalTimeline: { ...this.legalTimeline },\r\n          caseComplexity: this.caseComplexity,\r\n          isDeathPenalty: this.isDeathPenalty,\r\n          eventCounters: { ...this.eventCounters },\r\n          eventHistory: [...this.eventHistory],\r\n          lastStageChangeDay: this.lastStageChangeDay,\r\n          snapshotTime: Date.now(),\r\n        };\r\n\r\n        //  updateVariablesWith  replaceVariables\r\n        try {\r\n          //  CORS \r\n\r\n          updateVariablesWith(\r\n            variables => {\r\n              return { ...variables, detentionSystemInterruptSnapshot: snapshot };\r\n            },\r\n            { type: 'chat' },\r\n          );\r\n\r\n          //  CORS \r\n        } catch (updateError) {\r\n          //  CORS \r\n          //  updateVariablesWith  replaceVariables\r\n          console.warn('[]  (updateVariablesWith):', updateError);\r\n        }\r\n\r\n        console.debug('[] ');\r\n\r\n        //  CORS \r\n      } catch (error) {\r\n        console.warn('[] :', error);\r\n      }\r\n    },\r\n\r\n    // \r\n    // AI\r\n    confirmDayAdvancement(pendingDays: number): void {\r\n      if (pendingDays > 0) {\r\n        // \r\n        const oldDay = this.getCurrentDayInternal();\r\n        const newDay = oldDay + pendingDays;\r\n\r\n        // \r\n        this.currentDay = newDay;\r\n        this.lastEventDay = newDay;\r\n\r\n        //  statusPanel \r\n        try {\r\n          const statusPanel = DS.getModule('statusPanel') as {\r\n            getState?: () => { days?: number; day?: number };\r\n            modifyValue?: (key: string, delta: number, reason?: string) => void;\r\n          };\r\n\r\n          if (statusPanel && statusPanel.modifyValue) {\r\n            // \r\n            statusPanel.modifyValue('days', pendingDays, `${pendingDays}`);\r\n            console.info(`[]  : ${oldDay} -> ${newDay} (${pendingDays})`);\r\n          } else {\r\n            console.warn('[]  statusPanel ');\r\n          }\r\n        } catch (error) {\r\n          console.warn('[]  :', error);\r\n        }\r\n\r\n        console.info(`[]  : ${oldDay} -> ${newDay} (${pendingDays})`);\r\n\r\n        // \r\n        this.saveStateToChatVars();\r\n\r\n        //  CORS \r\n      }\r\n    },\r\n\r\n    rollbackToInterruptSnapshot(): boolean {\r\n      try {\r\n        const chatVars = getVariables({ type: 'chat' });\r\n        const snapshot = (chatVars as Record<string, unknown>).detentionSystemInterruptSnapshot as\r\n          | {\r\n              currentDay?: number;\r\n              currentStage?: string;\r\n              cellType?: string;\r\n              legalTimeline?: Timeline;\r\n              caseComplexity?: string;\r\n              isDeathPenalty?: boolean;\r\n              eventCounters?: Record<string, number>;\r\n              eventHistory?: EventRecord[];\r\n              lastStageChangeDay?: number;\r\n            }\r\n          | undefined;\r\n\r\n        if (!snapshot || typeof snapshot !== 'object') {\r\n          console.warn('[] ');\r\n          return false;\r\n        }\r\n\r\n        console.info('[] ');\r\n\r\n        this.currentDay = snapshot.currentDay ?? this.currentDay;\r\n        this.currentStage = (snapshot.currentStage as Stage) ?? this.currentStage;\r\n        this.cellType = snapshot.cellType ?? this.cellType;\r\n        this.caseComplexity =\r\n          (snapshot.caseComplexity as 'simple' | 'normal' | 'complex' | 'very_complex') ?? this.caseComplexity;\r\n        this.isDeathPenalty = Boolean(snapshot.isDeathPenalty);\r\n        this.lastStageChangeDay = snapshot.lastStageChangeDay ?? this.lastStageChangeDay;\r\n\r\n        if (snapshot.legalTimeline && typeof snapshot.legalTimeline === 'object') {\r\n          this.legalTimeline = { ...this.legalTimeline, ...snapshot.legalTimeline };\r\n        }\r\n\r\n        if (snapshot.eventCounters && typeof snapshot.eventCounters === 'object') {\r\n          this.eventCounters = { ...this.eventCounters, ...snapshot.eventCounters };\r\n        }\r\n\r\n        if (Array.isArray(snapshot.eventHistory)) {\r\n          this.eventHistory = [...snapshot.eventHistory];\r\n        }\r\n\r\n        // \r\n        this.saveStateToChatVars();\r\n\r\n        //  CORS \r\n\r\n        return true;\r\n      } catch (error) {\r\n        console.error('[] :', error);\r\n        return false;\r\n      }\r\n    },\r\n  };\r\n\r\n  // \r\n  DS.generateRandomEvent = (_context?: unknown) => EventSystem.generateRandomEvent();\r\n  DS.advanceDay = (days?: number) => {\r\n    //  CORS \r\n    const result = EventSystem.advanceDay(days);\r\n    //  CORS \r\n    return result;\r\n  };\r\n  // \r\n  DS.getCurrentDay = () => getCurrentDayFromMemoryEnhancement(EventSystem.currentDay);\r\n  DS.getCurrentStage = () => EventSystem.getCurrentStageInfo();\r\n  DS.checkCellTransfer = () => EventSystem.checkCellTransfer();\r\n  DS.setCaseComplexity = (complexity: 'simple' | 'normal' | 'complex' | 'very_complex') =>\r\n    EventSystem.setCaseComplexity(complexity);\r\n  DS.rollbackToStage = (stage: Stage, reason?: string) => EventSystem.rollbackToStage(stage, reason);\r\n  DS.advanceToStage = (stage: Stage, reason?: string) => EventSystem.advanceToStage(stage, reason);\r\n  DS.setDeathPenalty = (isDeathPenalty: boolean) => EventSystem.setDeathPenalty(isDeathPenalty);\r\n  DS.getEventStatistics = () => EventSystem.getEventStatistics();\r\n  DS.exportTimeline = () => EventSystem.exportTimeline();\r\n  DS.importTimeline = (data: unknown) => EventSystem.importTimeline(data);\r\n  DS.rollbackToInterruptSnapshot = () => EventSystem.rollbackToInterruptSnapshot();\r\n\r\n  DS.registerModule('eventSystem', EventSystem);\r\n\r\n  // iframe \r\n  try {\r\n    if (window.parent && window.parent !== window) {\r\n      (window.parent as any).detentionSystem = DS;\r\n      console.info('[]  ');\r\n    }\r\n  } catch (e) {\r\n    // \r\n  }\r\n\r\n  // \r\n  DS.events.on('user_input', (data?: unknown) => {\r\n    const text =\r\n      typeof (data as { text?: unknown } | undefined)?.text === 'string' ? (data as { text?: string }).text : undefined;\r\n    if (text) {\r\n      EventSystem.handleUserRollback(text);\r\n    }\r\n  });\r\n\r\n  // \r\n  DS.events.on('initialized', () => {\r\n    try {\r\n      EventSystem.initialize(0);\r\n    } catch (error) {\r\n      console.error('[] :', error);\r\n    }\r\n  });\r\n\r\n  console.info('[]  v3.4.0');\r\n});\r\n","export {};\r\n\r\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\r\ndeclare const $: JQueryStaticLike;\r\n\r\n/**\r\n * NPC  NPC////\r\n *  registerModule \r\n */\r\n\r\ntype NPCGender = 'female' | 'male';\r\ntype NPCStatus = 'active' | 'removed';\r\ntype NPCRelationship = {\r\n  toProtagonist: number;\r\n  faction: string | null;\r\n  allies: string[];\r\n  enemies: string[];\r\n  influence: number;\r\n};\r\ntype NPCTraits = {\r\n  aggression: number;\r\n  sociability: number;\r\n  intelligence: number;\r\n  emotional: number;\r\n  dominance: number;\r\n  kindness: number;\r\n};\r\ntype NPCPersonality = { traits: NPCTraits; tags: string[] };\r\ntype NPCAppearance = {\r\n  height: number;\r\n  weight: number;\r\n  hair: string;\r\n  eyes: string;\r\n  skin: string;\r\n  features: string;\r\n};\r\ntype NPCBackground = {\r\n  education: string;\r\n  maritalStatus: string;\r\n  hasChildren: boolean;\r\n  childrenCount: number;\r\n  hometown: string;\r\n  priorConvictions: number;\r\n};\r\n\r\ntype NPCBase = {\r\n  id: string;\r\n  name: string;\r\n  gender: NPCGender;\r\n  age: number;\r\n  crime: string;\r\n  sentence: number;\r\n  appearance: NPCAppearance;\r\n  personality: NPCPersonality;\r\n  background: NPCBackground;\r\n  relationship: NPCRelationship;\r\n  cellType: string;\r\n  daysInCustody: number;\r\n  status: NPCStatus;\r\n  createdAt: number;\r\n};\r\n\r\ntype NPCPolice = {\r\n  role: 'police';\r\n  rank: string;\r\n  attitude: number;\r\n};\r\n\r\ntype NPCLawyer = {\r\n  role: 'lawyer';\r\n  type: string;\r\n  experience: number;\r\n  successRate: number;\r\n};\r\n\r\ntype NPCDoctor = {\r\n  role: 'doctor';\r\n  specialty: string;\r\n  experience: number;\r\n};\r\n\r\ntype NPCFamily = {\r\n  role: 'family';\r\n  relation: string;\r\n  supportLevel: number;\r\n};\r\n\r\ntype NPCSpecial = NPCPolice | NPCLawyer | NPCDoctor | NPCFamily;\r\ntype NPC = NPCBase & Partial<NPCSpecial>;\r\n\r\ntype EventTriggeredPayload = { id?: string };\r\ntype CellTransferPayload = { to?: string };\r\n\r\ninterface EventSystemModule {\r\n  getCurrentStageInfo?: () => { cellType?: string };\r\n}\r\n\r\ninterface DetentionSystem {\r\n  events: { on(event: string, callback: (data?: unknown) => void): void; emit(event: string, data?: unknown): void };\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n}\r\n\r\ntype ProtagonistOptions = {\r\n  crimeType?: 'economic' | 'property' | 'violent' | 'drug' | 'social' | 'other' | string;\r\n  crimeName?: string; // \r\n  ageRange?: [number, number]; // [min, max]\r\n  education?: 'high' | 'medium' | 'low' | 'custom'; // high: , medium: /, low: \r\n  profession?: string[]; //  ['', '', '']\r\n  excludeCrimes?: string[]; //  ['']\r\n  background?: {\r\n    isIntellectual?: boolean; // \r\n    isAcademic?: boolean; // \r\n    isBusiness?: boolean; // \r\n  };\r\n};\r\n\r\ntype ProtagonistInfo = {\r\n  name: string;\r\n  age: number;\r\n  crime: string;\r\n  sentence: number;\r\n  appearance: {\r\n    height: number;\r\n    weight: number;\r\n    hair: string;\r\n    skin: string;\r\n    features: string;\r\n    eyes: string;\r\n  };\r\n  background: {\r\n    education: string;\r\n    profession?: string;\r\n    maritalStatus: string;\r\n    hasChildren: boolean;\r\n    childrenCount: number;\r\n    hometown: string;\r\n  };\r\n  personality?: {\r\n    traits: {\r\n      intelligence: number;\r\n      sociability: number;\r\n      emotional: number;\r\n    };\r\n    tags: string[];\r\n  };\r\n};\r\n\r\ntype DetentionSystemWithNPC = DetentionSystem & {\r\n  generateNPC?: (count?: number, context?: Record<string, unknown>) => NPC[];\r\n  generateNPCForEvent?: (eventType: string) => NPC | { police: NPC; witnesses: NPC[] };\r\n  generateProtagonist?: (options?: ProtagonistOptions) => ProtagonistInfo;\r\n  getCurrentCellNPCs?: () => NPC[];\r\n  setCurrentCellNPCs?: (npcs: NPC[]) => void;\r\n  addNPCToCell?: (npc: NPC) => void;\r\n  removeNPCFromCell?: (npcId: string) => NPC | null;\r\n  findNPC?: (npcId: string) => NPC | undefined;\r\n  updateNPCRelationship?: (npcId: string, delta: number) => void;\r\n  exportNPCData?: () => { database: NPC[]; currentCell: NPC[] };\r\n  importNPCData?: (data: { database?: NPC[]; currentCell?: NPC[] } | undefined) => boolean;\r\n};\r\n\r\ndeclare global {\r\n  interface DetentionSystem {\r\n    generateNPC?: (count?: number, context?: Record<string, unknown>) => NPC[];\r\n    generateNPCForEvent?: (eventType: string) => NPC | { police: NPC; witnesses: NPC[] };\r\n    generateProtagonist?: (options?: ProtagonistOptions) => ProtagonistInfo;\r\n    getCurrentCellNPCs?: () => NPC[];\r\n    setCurrentCellNPCs?: (npcs: NPC[]) => void;\r\n    addNPCToCell?: (npc: NPC) => void;\r\n    removeNPCFromCell?: (npcId: string) => NPC | null;\r\n    findNPC?: (npcId: string) => NPC | undefined;\r\n    updateNPCRelationship?: (npcId: string, delta: number) => void;\r\n    exportNPCData?: () => { database: NPC[]; currentCell: NPC[] };\r\n    importNPCData?: (data: { database?: NPC[]; currentCell?: NPC[] } | undefined) => boolean;\r\n  }\r\n}\r\n\r\n//  CORS \r\n\r\nconsole.info('[NPC] ...');\r\n\r\n// ========== DS==========\r\nconst NameGenerator = {\r\n  surnames: {\r\n    tier1: {\r\n      names: ['', '', '', '', '', '', '', '', '', ''],\r\n      weight: 35,\r\n    },\r\n    tier2: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 30,\r\n    },\r\n    tier3: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 20,\r\n    },\r\n    tier4: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 10,\r\n    },\r\n    tier5: {\r\n      names: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      weight: 5,\r\n    },\r\n  },\r\n  givenNames: {\r\n    vintage: {\r\n      single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 25,\r\n    },\r\n    classic: {\r\n      single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 35,\r\n    },\r\n    modern: {\r\n      single: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 30,\r\n    },\r\n    contemporary: {\r\n      single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 10,\r\n    },\r\n  },\r\n  badNames: [\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n  ],\r\n  badChars: ['', '', '', '', '', '', '', '', '', '', '', ''],\r\n\r\n  generate(birthYear: number): string {\r\n    let attempts = 0;\r\n    const maxAttempts = 50;\r\n    while (attempts < maxAttempts) {\r\n      attempts++;\r\n      const surname = this.selectSurname();\r\n      const givenName = this.selectGivenName(birthYear);\r\n      const fullName = surname + givenName;\r\n      if (this.isValidName(fullName)) return fullName;\r\n    }\r\n    return '' + this.givenNames.classic.single[0];\r\n  },\r\n\r\n  selectSurname(): string {\r\n    const tiers = Object.values(this.surnames);\r\n    const totalWeight = tiers.reduce((sum, tier) => sum + tier.weight, 0);\r\n    let random = Math.random() * totalWeight;\r\n    for (const tier of tiers) {\r\n      random -= tier.weight;\r\n      if (random <= 0) {\r\n        return tier.names[Math.floor(Math.random() * tier.names.length)];\r\n      }\r\n    }\r\n    return this.surnames.tier1.names[0];\r\n  },\r\n\r\n  selectGivenName(birthYear: number): string {\r\n    const currentYear = new Date().getFullYear();\r\n    const age = currentYear - birthYear;\r\n    const style = age >= 50 ? 'vintage' : age >= 35 ? 'classic' : age >= 20 ? 'modern' : 'contemporary';\r\n    const styleData = this.givenNames[style as keyof typeof this.givenNames];\r\n    const useDouble = Math.random() < 0.6;\r\n    if (useDouble && styleData.double.length > 0) {\r\n      const pair = styleData.double[Math.floor(Math.random() * styleData.double.length)];\r\n      return pair[0] + pair[1];\r\n    }\r\n    return styleData.single[Math.floor(Math.random() * styleData.single.length)];\r\n  },\r\n\r\n  isValidName(name: string): boolean {\r\n    if (this.badNames.includes(name)) return false;\r\n    return !this.badChars.some(char => name.includes(char));\r\n  },\r\n};\r\n\r\n// ========== DS==========\r\nconst CrimeGenerator = {\r\n  characterBookCrimes: [\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n  ],\r\n  crimes: {\r\n    violent: {\r\n      names: ['', '', '', '', '', ''],\r\n      weight: 12,\r\n      sentenceRange: [3, 20] as [number, number],\r\n    },\r\n    property: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 35,\r\n      sentenceRange: [1, 15] as [number, number],\r\n    },\r\n    drug: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 20,\r\n      sentenceRange: [3, 15] as [number, number],\r\n    },\r\n    economic: {\r\n      names: ['', '', '', '', '', '', ''],\r\n      weight: 15,\r\n      sentenceRange: [2, 10] as [number, number],\r\n    },\r\n    social: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 13,\r\n      sentenceRange: [1, 7] as [number, number],\r\n    },\r\n    other: {\r\n      names: ['', '', '', '', '', ''],\r\n      weight: 5,\r\n      sentenceRange: [1, 5] as [number, number],\r\n    },\r\n  },\r\n\r\n  generate(): { crime: string; sentence: number; category: { sentenceRange: [number, number] } } {\r\n    if (Math.random() < 0.3) {\r\n      const crime = this.characterBookCrimes[Math.floor(Math.random() * this.characterBookCrimes.length)];\r\n      const category = this.findCategoryByCrime(crime);\r\n      const sentence = this.generateSentence(category ? category.sentenceRange : [1, 10]);\r\n      return { crime, sentence, category: category || this.crimes.property };\r\n    }\r\n\r\n    const categories = Object.values(this.crimes);\r\n    const totalWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);\r\n    let random = Math.random() * totalWeight;\r\n    for (const category of categories) {\r\n      random -= category.weight;\r\n      if (random <= 0) {\r\n        const crime = category.names[Math.floor(Math.random() * category.names.length)];\r\n        const sentence = this.generateSentence(category.sentenceRange);\r\n        return { crime, sentence, category };\r\n      }\r\n    }\r\n\r\n    return { crime: '', sentence: 3, category: this.crimes.property };\r\n  },\r\n\r\n  findCategoryByCrime(crimeName: string) {\r\n    for (const key of Object.keys(this.crimes)) {\r\n      const category = this.crimes[key as keyof typeof this.crimes];\r\n      if (category.names.includes(crimeName)) return category;\r\n    }\r\n    return null;\r\n  },\r\n\r\n  generateSentence(range: [number, number]): number {\r\n    const [min, max] = range;\r\n    return Math.floor(Math.random() * (max - min + 1)) + min;\r\n  },\r\n};\r\n\r\n//  jQuery ready \r\n$(() => {\r\n  const DS_RAW = window.detentionSystem as DetentionSystemWithNPC | undefined;\r\n\r\n  if (!DS_RAW) {\r\n    console.error(' [NPC] ');\r\n    console.error('[NPC] window.detentionSystem:', typeof window.detentionSystem);\r\n    console.error('[NPC] window.__DETENTION_SYSTEM_LOADED__:', (window as any).__DETENTION_SYSTEM_LOADED__);\r\n    console.error(\r\n      '[NPC] window.__DETENTION_SYSTEM_CORE_LOADED__:',\r\n      (window as any).__DETENTION_SYSTEM_CORE_LOADED__,\r\n    );\r\n    //  CORS \r\n    return;\r\n  }\r\n\r\n  // DS \r\n  const DS = DS_RAW as DetentionSystemWithNPC;\r\n\r\n  console.info(' [NPC] ...');\r\n  // \r\n  (window as any).__NPC_SYSTEM_LOADING__ = true;\r\n  //  CORS \r\n\r\n  // ========== NPC ==========\r\n  const NPCGenerator = {\r\n    npcDatabase: [] as NPC[],\r\n    currentCellNPCs: [] as NPC[],\r\n\r\n    generate(count = 1, context: Record<string, unknown> = {}): NPC[] {\r\n      const npcs: NPC[] = [];\r\n      for (let i = 0; i < count; i++) {\r\n        const npc = this.generateSingle(context);\r\n        npcs.push(npc);\r\n        this.npcDatabase.push(npc);\r\n      }\r\n      return npcs;\r\n    },\r\n\r\n    generateSingle(context: Record<string, unknown> = {}): NPC {\r\n      const eventSystem = DS.getModule<EventSystemModule>('eventSystem');\r\n      const stageInfo = eventSystem?.getCurrentStageInfo ? eventSystem.getCurrentStageInfo() : {};\r\n\r\n      const age = this.generateAge();\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const crimeData = CrimeGenerator.generate();\r\n      const appearance = this.generateAppearance(age);\r\n      const personality = this.generatePersonality();\r\n      const background = this.generateBackground(age, crimeData);\r\n      const relationship = this.generateRelationship();\r\n\r\n      const cellType =\r\n        typeof stageInfo?.cellType === 'string' ? stageInfo.cellType : (context.cellType as string) || 'transition';\r\n      this.adjustByCellType(personality, relationship, cellType);\r\n\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: 'female',\r\n        age,\r\n        crime: crimeData.crime,\r\n        sentence: crimeData.sentence,\r\n        appearance,\r\n        personality,\r\n        background,\r\n        relationship,\r\n        cellType,\r\n        daysInCustody: Math.floor(Math.random() * 365) + 30,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateAge(): number {\r\n      const random = Math.random();\r\n      if (random < 0.05) return Math.floor(Math.random() * 3) + 18;\r\n      if (random < 0.25) return Math.floor(Math.random() * 10) + 21;\r\n      if (random < 0.55) return Math.floor(Math.random() * 10) + 31;\r\n      if (random < 0.8) return Math.floor(Math.random() * 10) + 41;\r\n      if (random < 0.95) return Math.floor(Math.random() * 10) + 51;\r\n      return Math.floor(Math.random() * 15) + 61;\r\n    },\r\n\r\n    generateAppearance(age: number): NPCAppearance {\r\n      const heights = [150, 155, 160, 165, 170, 175];\r\n      const weights = [45, 50, 55, 60, 65, 70, 75];\r\n      const height = heights[Math.floor(Math.random() * heights.length)];\r\n      const weight = weights[Math.floor(Math.random() * weights.length)];\r\n      const hairStyles =\r\n        age > 50\r\n          ? ['', '', '', '']\r\n          : ['', '', '', '', '', '', ''];\r\n      const skinTones = ['', '', '', '', ''];\r\n      const features = ['', '', '', '', '', '', ''];\r\n      return {\r\n        height,\r\n        weight,\r\n        hair: hairStyles[Math.floor(Math.random() * hairStyles.length)],\r\n        eyes: '',\r\n        skin: skinTones[Math.floor(Math.random() * skinTones.length)],\r\n        features: features[Math.floor(Math.random() * features.length)],\r\n      };\r\n    },\r\n\r\n    generatePersonality(): NPCPersonality {\r\n      const traits: NPCTraits = {\r\n        aggression: Math.floor(Math.random() * 100),\r\n        sociability: Math.floor(Math.random() * 100),\r\n        intelligence: Math.floor(Math.random() * 100),\r\n        emotional: Math.floor(Math.random() * 100),\r\n        dominance: Math.floor(Math.random() * 100),\r\n        kindness: Math.floor(Math.random() * 100),\r\n      };\r\n      const tags: string[] = [];\r\n      if (traits.aggression > 70) tags.push('');\r\n      if (traits.sociability > 70) tags.push('');\r\n      if (traits.intelligence > 70) tags.push('');\r\n      if (traits.emotional > 70) tags.push('');\r\n      if (traits.dominance > 70) tags.push('');\r\n      if (traits.kindness > 70) tags.push('');\r\n      if (traits.aggression < 30) tags.push('');\r\n      if (traits.sociability < 30) tags.push('');\r\n      if (traits.emotional < 30) tags.push('');\r\n      if (traits.dominance < 30) tags.push('');\r\n      return { traits, tags };\r\n    },\r\n\r\n    generateBackground(\r\n      age: number,\r\n      _crimeData: { crime: string; sentence: number; category: { sentenceRange: [number, number] } },\r\n    ): NPCBackground {\r\n      const educations = ['', '', '', '', '', '', ''];\r\n      const educationWeights = [10, 25, 30, 15, 10, 8, 2];\r\n      const educationIndex = this.weightedRandom(educations.length, educationWeights);\r\n      const maritalStatuses = ['', '', '', ''];\r\n      const maritalWeights = age < 25 ? [80, 15, 5, 0] : age < 40 ? [20, 60, 15, 5] : [10, 50, 30, 10];\r\n      const maritalIndex = this.weightedRandom(maritalStatuses.length, maritalWeights);\r\n      const hasChildren = maritalStatuses[maritalIndex] !== '' && Math.random() < 0.7;\r\n      const childrenCount = hasChildren ? Math.floor(Math.random() * 3) + 1 : 0;\r\n      return {\r\n        education: educations[educationIndex],\r\n        maritalStatus: maritalStatuses[maritalIndex],\r\n        hasChildren,\r\n        childrenCount,\r\n        hometown: this.generateHometown(),\r\n        priorConvictions: Math.random() < 0.3 ? Math.floor(Math.random() * 3) + 1 : 0,\r\n      };\r\n    },\r\n\r\n    generateHometown(): string {\r\n      const provinces = [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ];\r\n      return provinces[Math.floor(Math.random() * provinces.length)];\r\n    },\r\n\r\n    generateRelationship(): NPCRelationship {\r\n      return {\r\n        toProtagonist: 50,\r\n        faction: null,\r\n        allies: [],\r\n        enemies: [],\r\n        influence: Math.floor(Math.random() * 100),\r\n      };\r\n    },\r\n\r\n    adjustByCellType(personality: NPCPersonality, relationship: NPCRelationship, cellType: string) {\r\n      if (cellType === 'transition') {\r\n        personality.traits.emotional += 10;\r\n        relationship.influence -= 20;\r\n      } else if (cellType === 'pretrial') {\r\n        personality.traits.emotional += 15;\r\n        personality.traits.aggression += 5;\r\n      } else if (cellType === 'convicted') {\r\n        personality.traits.emotional -= 10;\r\n        personality.traits.aggression += 10;\r\n        relationship.influence += 10;\r\n      }\r\n      (Object.keys(personality.traits) as Array<keyof NPCTraits>).forEach(key => {\r\n        personality.traits[key] = Math.max(0, Math.min(100, personality.traits[key]));\r\n      });\r\n      relationship.influence = Math.max(0, Math.min(100, relationship.influence));\r\n    },\r\n\r\n    weightedRandom(count: number, weights: number[]): number {\r\n      const totalWeight = weights.reduce((sum, w) => sum + w, 0);\r\n      let random = Math.random() * totalWeight;\r\n      for (let i = 0; i < count; i++) {\r\n        random -= weights[i];\r\n        if (random <= 0) return i;\r\n      }\r\n      return count - 1;\r\n    },\r\n\r\n    generateId(): string {\r\n      return 'npc_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);\r\n    },\r\n\r\n    generateForEvent(eventType: string): NPC | { police: NPC; witnesses: NPC[] } {\r\n      if (eventType === 'interrogation') return this.generatePolice();\r\n      if (eventType === 'lawyer_visit') return this.generateLawyer();\r\n      if (eventType === 'family_visit') return this.generateFamily();\r\n      if (eventType === 'medical_visit') return this.generateDoctor();\r\n      if (eventType === 'scene_identification') {\r\n        return { police: this.generatePolice(), witnesses: this.generate(2, { type: 'witness' }) };\r\n      }\r\n      return this.generateSingle({ eventType });\r\n    },\r\n\r\n    generatePolice(): NPC {\r\n      const age = Math.floor(Math.random() * 20) + 25;\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const ranks = ['', '', '', ''];\r\n      const rank = ranks[Math.floor(Math.random() * ranks.length)];\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: 'female',\r\n        age,\r\n        role: 'police',\r\n        rank,\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 30) + 40,\r\n            sociability: Math.floor(Math.random() * 40) + 30,\r\n            intelligence: Math.floor(Math.random() * 30) + 50,\r\n            emotional: Math.floor(Math.random() * 40) + 20,\r\n            dominance: Math.floor(Math.random() * 30) + 60,\r\n            kindness: Math.floor(Math.random() * 60) + 20,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        attitude: Math.floor(Math.random() * 40) + 30,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'staff',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateLawyer(): NPC {\r\n      const age = Math.floor(Math.random() * 25) + 28;\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const isFemale = Math.random() < 0.8;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const types = ['', '', ''];\r\n      const typeWeights = [50, 40, 10];\r\n      const typeIndex = this.weightedRandom(types.length, typeWeights);\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: isFemale ? 'female' : 'male',\r\n        age,\r\n        role: 'lawyer',\r\n        type: types[typeIndex],\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 20) + 20,\r\n            sociability: Math.floor(Math.random() * 30) + 60,\r\n            intelligence: Math.floor(Math.random() * 20) + 70,\r\n            emotional: Math.floor(Math.random() * 40) + 30,\r\n            dominance: Math.floor(Math.random() * 40) + 40,\r\n            kindness: Math.floor(Math.random() * 40) + 40,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        experience: Math.floor(Math.random() * 20) + 5,\r\n        successRate: Math.floor(Math.random() * 40) + 40,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'external',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateFamily(): NPC {\r\n      const relationships = ['', '', '', '', '', '', '', ''];\r\n      const weights = [30, 20, 15, 10, 10, 10, 3, 2];\r\n      const relationIndex = this.weightedRandom(relationships.length, weights);\r\n      const relation = relationships[relationIndex];\r\n      let age = 40;\r\n      let isFemale = true;\r\n      if (relation === '') {\r\n        age = Math.floor(Math.random() * 20) + 45;\r\n        isFemale = true;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 20) + 45;\r\n        isFemale = false;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 30) + 25;\r\n        isFemale = false;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 30) + 25;\r\n        isFemale = true;\r\n      } else if (relation === '' || relation === '') {\r\n        age = Math.floor(Math.random() * 30) + 20;\r\n        isFemale = true;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 15) + 5;\r\n        isFemale = true;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 15) + 5;\r\n        isFemale = false;\r\n      }\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: isFemale ? 'female' : 'male',\r\n        age,\r\n        role: 'family',\r\n        relation,\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 30) + 10,\r\n            sociability: Math.floor(Math.random() * 50) + 30,\r\n            intelligence: Math.floor(Math.random() * 60) + 30,\r\n            emotional: Math.floor(Math.random() * 50) + 40,\r\n            dominance: Math.floor(Math.random() * 50) + 20,\r\n            kindness: Math.floor(Math.random() * 30) + 60,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        supportLevel: Math.floor(Math.random() * 40) + 60,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'external',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateDoctor(): NPC {\r\n      const age = Math.floor(Math.random() * 25) + 30;\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const specialties = ['', '', '', '', ''];\r\n      const specialty = specialties[Math.floor(Math.random() * specialties.length)];\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: 'female',\r\n        age,\r\n        role: 'doctor',\r\n        specialty,\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 20) + 10,\r\n            sociability: Math.floor(Math.random() * 40) + 40,\r\n            intelligence: Math.floor(Math.random() * 20) + 70,\r\n            emotional: Math.floor(Math.random() * 40) + 30,\r\n            dominance: Math.floor(Math.random() * 40) + 40,\r\n            kindness: Math.floor(Math.random() * 30) + 60,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        experience: Math.floor(Math.random() * 25) + 5,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'external',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    /**\r\n     * \r\n     * @param options \r\n     * @returns \r\n     */\r\n    generateProtagonist(options: ProtagonistOptions = {}): ProtagonistInfo {\r\n      //  CORS \r\n\r\n      // 1. \r\n      let age: number;\r\n      if (options.ageRange && options.ageRange.length === 2) {\r\n        const [min, max] = options.ageRange;\r\n        age = Math.floor(Math.random() * (max - min + 1)) + min;\r\n      } else if (options.background?.isIntellectual || options.background?.isBusiness) {\r\n        // 35-45\r\n        age = Math.floor(Math.random() * 11) + 35;\r\n      } else {\r\n        // 28-42\r\n        age = Math.floor(Math.random() * 15) + 28;\r\n      }\r\n      const birthYear = new Date().getFullYear() - age;\r\n\r\n      // 2. \r\n      const name = NameGenerator.generate(birthYear);\r\n\r\n      // 3. \r\n      let crimeData: { crime: string; sentence: number; category: { sentenceRange: [number, number] } };\r\n      if (options.crimeName) {\r\n        // \r\n        const category = CrimeGenerator.findCategoryByCrime(options.crimeName);\r\n        const sentenceRange = category ? category.sentenceRange : [2, 10];\r\n        crimeData = {\r\n          crime: options.crimeName,\r\n          sentence: CrimeGenerator.generateSentence(sentenceRange),\r\n          category: category || CrimeGenerator.crimes.economic,\r\n        };\r\n      } else if (options.crimeType) {\r\n        // \r\n        const categoryKey = options.crimeType as keyof typeof CrimeGenerator.crimes;\r\n        if (CrimeGenerator.crimes[categoryKey]) {\r\n          const category = CrimeGenerator.crimes[categoryKey];\r\n          const crime = category.names[Math.floor(Math.random() * category.names.length)];\r\n          // \r\n          let filteredCrimes = category.names;\r\n          if (options.excludeCrimes && options.excludeCrimes.length > 0) {\r\n            filteredCrimes = category.names.filter(c => !options.excludeCrimes!.includes(c));\r\n          }\r\n          if (filteredCrimes.length === 0) {\r\n            filteredCrimes = category.names; // \r\n          }\r\n          const selectedCrime = filteredCrimes[Math.floor(Math.random() * filteredCrimes.length)];\r\n          crimeData = {\r\n            crime: selectedCrime,\r\n            sentence: CrimeGenerator.generateSentence(category.sentenceRange),\r\n            category: category,\r\n          };\r\n        } else {\r\n          // \r\n          const category = CrimeGenerator.crimes.economic;\r\n          const filteredCrimes = options.excludeCrimes\r\n            ? category.names.filter(c => !options.excludeCrimes!.includes(c))\r\n            : category.names;\r\n          const selectedCrime =\r\n            filteredCrimes.length > 0\r\n              ? filteredCrimes[Math.floor(Math.random() * filteredCrimes.length)]\r\n              : category.names[0];\r\n          crimeData = {\r\n            crime: selectedCrime,\r\n            sentence: CrimeGenerator.generateSentence(category.sentenceRange),\r\n            category: category,\r\n          };\r\n        }\r\n      } else if (options.background?.isIntellectual || options.background?.isBusiness) {\r\n        // \r\n        const category = CrimeGenerator.crimes.economic;\r\n        const filteredCrimes = options.excludeCrimes\r\n          ? category.names.filter(c => !options.excludeCrimes!.includes(c))\r\n          : category.names;\r\n        const selectedCrime =\r\n          filteredCrimes.length > 0\r\n            ? filteredCrimes[Math.floor(Math.random() * filteredCrimes.length)]\r\n            : category.names[0];\r\n        crimeData = {\r\n          crime: selectedCrime,\r\n          sentence: CrimeGenerator.generateSentence(category.sentenceRange),\r\n          category: category,\r\n        };\r\n      } else {\r\n        // \r\n        crimeData = CrimeGenerator.generate();\r\n        // \r\n        if (options.excludeCrimes && options.excludeCrimes.includes(crimeData.crime)) {\r\n          // \r\n          let attempts = 0;\r\n          while (attempts < 10 && options.excludeCrimes.includes(crimeData.crime)) {\r\n            crimeData = CrimeGenerator.generate();\r\n            attempts++;\r\n          }\r\n        }\r\n      }\r\n\r\n      // 4. \r\n      const appearance = this.generateAppearance(age);\r\n\r\n      // 5. \r\n      let education: string;\r\n      if (options.education === 'high') {\r\n        const highEducations = ['', '', '', ''];\r\n        education = highEducations[Math.floor(Math.random() * highEducations.length)];\r\n      } else if (options.education === 'medium') {\r\n        const mediumEducations = ['', '', ''];\r\n        education = mediumEducations[Math.floor(Math.random() * mediumEducations.length)];\r\n      } else if (options.education === 'low') {\r\n        const lowEducations = ['', '', ''];\r\n        education = lowEducations[Math.floor(Math.random() * lowEducations.length)];\r\n      } else if (options.background?.isIntellectual) {\r\n        // \r\n        const highEducations = ['', '', '', ''];\r\n        education = highEducations[Math.floor(Math.random() * highEducations.length)];\r\n      } else if (options.background?.isBusiness) {\r\n        // \r\n        const businessEducations = ['', '', '', 'MBA'];\r\n        education = businessEducations[Math.floor(Math.random() * businessEducations.length)];\r\n      } else {\r\n        // \r\n        if (age < 30) {\r\n          const educations = ['', '', '', ''];\r\n          const weights = [20, 30, 40, 10];\r\n          education = educations[this.weightedRandom(educations.length, weights)];\r\n        } else {\r\n          const educations = ['', '', '', '', '', ''];\r\n          const weights = [15, 25, 35, 10, 10, 5];\r\n          education = educations[this.weightedRandom(educations.length, weights)];\r\n        }\r\n      }\r\n\r\n      // 6. \r\n      let profession: string | undefined;\r\n      if (options.profession && options.profession.length > 0) {\r\n        profession = options.profession[Math.floor(Math.random() * options.profession.length)];\r\n      } else if (options.background?.isBusiness) {\r\n        const businessProfessions = ['', '', '', '', ''];\r\n        profession = businessProfessions[Math.floor(Math.random() * businessProfessions.length)];\r\n      } else if (options.background?.isIntellectual && !options.background?.isAcademic) {\r\n        // \r\n        const intellectualProfessions = ['', '', '', '', ''];\r\n        profession = intellectualProfessions[Math.floor(Math.random() * intellectualProfessions.length)];\r\n      } else if (options.background?.isAcademic) {\r\n        const academicProfessions = ['', '', '', '', ''];\r\n        profession = academicProfessions[Math.floor(Math.random() * academicProfessions.length)];\r\n      }\r\n\r\n      // 7. \r\n      const maritalStatuses = age < 30 ? ['', ''] : age < 40 ? ['', '', ''] : ['', ''];\r\n      const maritalWeights =\r\n        age < 30\r\n          ? [40, 60]\r\n          : age < 40\r\n            ? [60, 25, 15]\r\n            : education === '' || education === ''\r\n              ? [70, 30]\r\n              : [65, 35];\r\n      const maritalIndex = this.weightedRandom(maritalStatuses.length, maritalWeights);\r\n      const maritalStatus = maritalStatuses[maritalIndex];\r\n\r\n      // 8. \r\n      const hasChildren = maritalStatus !== '' && age > 28 && Math.random() < 0.7;\r\n      const childrenCount = hasChildren ? (age < 35 ? 1 : Math.floor(Math.random() * 2) + 1) : 0;\r\n\r\n      // 9. \r\n      const hometown = this.generateHometown();\r\n\r\n      // 10. \r\n      const personality: ProtagonistInfo['personality'] = {\r\n        traits: {\r\n          intelligence: options.background?.isIntellectual\r\n            ? Math.floor(Math.random() * 15) + 80\r\n            : options.background?.isBusiness\r\n              ? Math.floor(Math.random() * 20) + 70\r\n              : Math.floor(Math.random() * 30) + 60,\r\n          sociability: options.background?.isBusiness\r\n            ? Math.floor(Math.random() * 25) + 60\r\n            : Math.floor(Math.random() * 40) + 40,\r\n          emotional: Math.floor(Math.random() * 40) + 30,\r\n        },\r\n        tags: [],\r\n      };\r\n\r\n      // \r\n      if (options.background?.isIntellectual) {\r\n        personality.tags.push('', '');\r\n        if (!options.background.isAcademic) {\r\n          personality.tags.push('');\r\n        }\r\n      }\r\n      if (options.background?.isBusiness) {\r\n        personality.tags.push('', '');\r\n      }\r\n      if (personality.traits.intelligence >= 75) {\r\n        personality.tags.push('');\r\n      }\r\n      if (personality.traits.sociability >= 60) {\r\n        personality.tags.push('');\r\n      }\r\n\r\n      //  CORS \r\n\r\n      return {\r\n        name,\r\n        age,\r\n        crime: crimeData.crime,\r\n        sentence: crimeData.sentence,\r\n        appearance: {\r\n          height: appearance.height,\r\n          weight: appearance.weight,\r\n          hair: appearance.hair,\r\n          skin: appearance.skin,\r\n          features: appearance.features,\r\n          eyes: appearance.eyes,\r\n        },\r\n        background: {\r\n          education,\r\n          profession,\r\n          maritalStatus,\r\n          hasChildren,\r\n          childrenCount,\r\n          hometown,\r\n        },\r\n        personality,\r\n      };\r\n    },\r\n\r\n    getCurrentCellNPCs(): NPC[] {\r\n      return this.currentCellNPCs;\r\n    },\r\n\r\n    setCurrentCellNPCs(npcs: NPC[]) {\r\n      this.currentCellNPCs = npcs;\r\n      DS.events.emit('cell_npcs_changed', { npcs });\r\n    },\r\n\r\n    addNPCToCell(npc: NPC) {\r\n      this.currentCellNPCs.push(npc);\r\n      DS.events.emit('npc_joined_cell', { npc });\r\n    },\r\n\r\n    removeNPCFromCell(npcId: string): NPC | null {\r\n      const index = this.currentCellNPCs.findIndex(n => n.id === npcId);\r\n      if (index !== -1) {\r\n        const npc = this.currentCellNPCs.splice(index, 1)[0];\r\n        DS.events.emit('npc_left_cell', { npc });\r\n        return npc;\r\n      }\r\n      return null;\r\n    },\r\n\r\n    findNPCById(npcId: string): NPC | undefined {\r\n      return this.npcDatabase.find(n => n.id === npcId) || this.currentCellNPCs.find(n => n.id === npcId);\r\n    },\r\n\r\n    updateRelationship(npcId: string, delta: number) {\r\n      const npc = this.findNPCById(npcId);\r\n      if (npc && npc.relationship) {\r\n        npc.relationship.toProtagonist = Math.max(0, Math.min(100, npc.relationship.toProtagonist + delta));\r\n        DS.events.emit('relationship_changed', {\r\n          npcId,\r\n          npcName: npc.name,\r\n          value: npc.relationship.toProtagonist,\r\n          delta,\r\n        });\r\n      }\r\n    },\r\n\r\n    exportData() {\r\n      return {\r\n        database: this.npcDatabase,\r\n        currentCell: this.currentCellNPCs,\r\n      };\r\n    },\r\n\r\n    importData(data: { database?: NPC[]; currentCell?: NPC[] } | undefined): boolean {\r\n      if (!data) return false;\r\n      try {\r\n        this.npcDatabase = data.database || [];\r\n        this.currentCellNPCs = data.currentCell || [];\r\n        console.info('[NPC] ');\r\n        return true;\r\n      } catch (error) {\r\n        console.error('[NPC] :', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    clearData() {\r\n      this.npcDatabase = [];\r\n      this.currentCellNPCs = [];\r\n      console.info('[NPC] ');\r\n    },\r\n  };\r\n\r\n  // ==========  ==========\r\n  DS.generateNPC = (count?: number, context?: Record<string, unknown>) => NPCGenerator.generate(count, context ?? {});\r\n  DS.generateNPCForEvent = (eventType: string) => NPCGenerator.generateForEvent(eventType);\r\n  DS.generateProtagonist = (options?: ProtagonistOptions) => NPCGenerator.generateProtagonist(options);\r\n  DS.getCurrentCellNPCs = () => NPCGenerator.getCurrentCellNPCs();\r\n  DS.setCurrentCellNPCs = (npcs: NPC[]) => NPCGenerator.setCurrentCellNPCs(npcs);\r\n  DS.addNPCToCell = (npc: NPC) => NPCGenerator.addNPCToCell(npc);\r\n  DS.removeNPCFromCell = (npcId: string) => NPCGenerator.removeNPCFromCell(npcId);\r\n  DS.findNPC = (npcId: string) => NPCGenerator.findNPCById(npcId);\r\n  DS.updateNPCRelationship = (npcId: string, delta: number) => NPCGenerator.updateRelationship(npcId, delta);\r\n  DS.exportNPCData = () => NPCGenerator.exportData();\r\n  DS.importNPCData = (data?: { database?: NPC[]; currentCell?: NPC[] }) => NPCGenerator.importData(data);\r\n\r\n  DS.registerModule('npcSystem', NPCGenerator);\r\n\r\n  //  CORS \r\n\r\n  // iframe \r\n  try {\r\n    if (window.parent && window.parent !== window) {\r\n      //  CORS \r\n\r\n      //  DS \r\n      const parentWindow = window.parent as typeof window.parent & { detentionSystem?: DetentionSystem };\r\n      parentWindow.detentionSystem = DS;\r\n      //  DS \r\n      if (parentWindow.detentionSystem) {\r\n        parentWindow.detentionSystem.generateNPC = DS.generateNPC;\r\n        parentWindow.detentionSystem.generateNPCForEvent = DS.generateNPCForEvent;\r\n        parentWindow.detentionSystem.generateProtagonist = DS.generateProtagonist;\r\n        parentWindow.detentionSystem.getCurrentCellNPCs = DS.getCurrentCellNPCs;\r\n        parentWindow.detentionSystem.setCurrentCellNPCs = DS.setCurrentCellNPCs;\r\n        parentWindow.detentionSystem.addNPCToCell = DS.addNPCToCell;\r\n        parentWindow.detentionSystem.removeNPCFromCell = DS.removeNPCFromCell;\r\n        parentWindow.detentionSystem.findNPC = DS.findNPC;\r\n        parentWindow.detentionSystem.updateNPCRelationship = DS.updateNPCRelationship;\r\n        parentWindow.detentionSystem.exportNPCData = DS.exportNPCData;\r\n        parentWindow.detentionSystem.importNPCData = DS.importNPCData;\r\n        parentWindow.detentionSystem.generateProtagonist = DS.generateProtagonist;\r\n      }\r\n      console.info('[NPC]  NPC');\r\n\r\n      // \r\n      const parentDS = (window.parent as any).detentionSystem;\r\n      if (parentDS) {\r\n        const verification = {\r\n          hasGenerateNPC: typeof parentDS.generateNPC === 'function',\r\n          hasGenerateNPCForEvent: typeof parentDS.generateNPCForEvent === 'function',\r\n          hasGenerateProtagonist: typeof parentDS.generateProtagonist === 'function',\r\n          hasGetCurrentCellNPCs: typeof parentDS.getCurrentCellNPCs === 'function',\r\n          hasSetCurrentCellNPCs: typeof parentDS.setCurrentCellNPCs === 'function',\r\n          modulesCount: parentDS.modules ? Object.keys(parentDS.modules).length : 0,\r\n          hasNPCSystemModule: !!(\r\n            parentDS.getModule &&\r\n            typeof parentDS.getModule === 'function' &&\r\n            parentDS.getModule('npcSystem')\r\n          ),\r\n        };\r\n        //  info error\r\n        if (verification.hasGenerateNPC && verification.hasNPCSystemModule) {\r\n          console.info('[NPC]  :', verification);\r\n        } else {\r\n          console.error('[NPC]  ', verification);\r\n        }\r\n      } else {\r\n        console.error('[NPC]   detentionSystem ');\r\n      }\r\n\r\n      //  CORS \r\n    }\r\n  } catch (e) {\r\n    //  CORS \r\n    console.warn('[NPC] :', e);\r\n  }\r\n\r\n  // ==========  ==========\r\n  DS.events.on('event_triggered', (event?: unknown) => {\r\n    const eventId =\r\n      typeof (event as EventTriggeredPayload | undefined)?.id === 'string'\r\n        ? (event as EventTriggeredPayload).id\r\n        : undefined;\r\n    if (!eventId) return;\r\n    if (['interrogation', 'lawyer_visit', 'family_visit', 'medical_visit', 'scene_identification'].includes(eventId)) {\r\n      const npc = NPCGenerator.generateForEvent(eventId);\r\n      DS.events.emit('event_npc_generated', { event, npc });\r\n    }\r\n  });\r\n\r\n  // ==========  ==========\r\n  DS.events.on('cell_transfer', (data?: unknown) => {\r\n    const to = (data as CellTransferPayload | undefined)?.to;\r\n    const newCellType = typeof to === 'string' ? to : 'transition';\r\n    const npcCount = Math.floor(Math.random() * 5) + 3;\r\n    const newNPCs = NPCGenerator.generate(npcCount, { cellType: newCellType });\r\n    NPCGenerator.setCurrentCellNPCs(newNPCs);\r\n    console.info(`[NPC] ${npcCount}NPC`);\r\n  });\r\n\r\n  console.info(' [NPC]  - ');\r\n  (window as any).__NPC_SYSTEM_LOADED__ = true;\r\n  (window as any).__NPC_SYSTEM_LOADED_TIMESTAMP__ = Date.now();\r\n});\r\n","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","/**\n *  - \n * HTML\n * : 3.5.6 ()\n */\n// ==========  ==========\nconst CONFIG = {\n    updateInterval: 500,\n    animationDuration: 300,\n    trendWindow: 5,\n    slowChangeThreshold: 1.0,\n    regressionRate: 0.005,\n    healthBaseline: 70,\n    mentalBaseline: 65,\n    parseRetryAttempts: 3,\n    parseRetryDelay: 100,\n    debugMode: true,\n};\nconst TREND_SYMBOLS = {\n    up: '',\n    down: '',\n    stable: '',\n};\nlet state = {\n    name: '',\n    age: 0,\n    crime: '',\n    health: 75,\n    mental: 70,\n    strength: 65,\n    intelligence: 70,\n    appearance: {\n        height: 0,\n        weight: 0,\n        hair: '',\n        condition: '',\n    },\n    clothing: {\n        top: '',\n        bottom: '',\n        underwear: '',\n        underpants: '',\n        socks: '',\n        shoes: '',\n        restraints: '',\n        cleanliness: '',\n    },\n    currentTask: '',\n    currentThought: '',\n    biggestWorry: '',\n    days: 0,\n    stage: '',\n    cellType: '',\n    changes: {\n        health: [],\n        mental: [],\n        strength: [],\n        intelligence: [],\n    },\n    accumulated: {\n        health: 0,\n        mental: 0,\n        strength: 0,\n        intelligence: 0,\n    },\n    lastUpdate: Date.now(),\n    stats: {\n        totalUpdates: 0,\n        successfulParses: 0,\n        failedParses: 0,\n        lastParseTime: 0,\n    },\n};\nconst skipDisplayUpdate = false;\nlet isUpdating = false;\nlet mutationObserver = null;\nlet updateLoopInterval = null;\n// ==========  ==========\nfunction debugLog(...args) {\n    if (CONFIG.debugMode) {\n        console.log('[]', ...args);\n    }\n}\nfunction formatDuration(ms) {\n    const seconds = Math.floor(ms / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const hours = Math.floor(minutes / 60);\n    const days = Math.floor(hours / 24);\n    if (days > 0)\n        return `${days}${hours % 24}`;\n    if (hours > 0)\n        return `${hours}${minutes % 60}`;\n    if (minutes > 0)\n        return `${minutes}${seconds % 60}`;\n    return `${seconds}`;\n}\n// ==========  ==========\nfunction recordChange(key, delta) {\n    if (!state.changes[key]) {\n        state.changes[key] = [];\n    }\n    state.changes[key].push({\n        value: delta,\n        timestamp: Date.now(),\n    });\n    if (state.changes[key].length > CONFIG.trendWindow) {\n        state.changes[key].shift();\n    }\n    debugLog(`: ${key} ${delta > 0 ? '+' : ''}${delta}`);\n}\nfunction calculateTrend(key) {\n    if (!state.changes[key] || state.changes[key].length === 0) {\n        return 'stable';\n    }\n    const sum = state.changes[key].reduce((acc, change) => acc + change.value, 0);\n    if (sum > 2)\n        return 'up';\n    if (sum < -2)\n        return 'down';\n    return 'stable';\n}\nfunction applyRegression() {\n    const healthDelta = (CONFIG.healthBaseline - state.health) * CONFIG.regressionRate;\n    if (Math.abs(healthDelta) > 0.01) {\n        state.accumulated.health += healthDelta;\n        if (Math.abs(state.accumulated.health) >= CONFIG.slowChangeThreshold) {\n            const change = Math.floor(state.accumulated.health);\n            state.health += change;\n            state.accumulated.health -= change;\n            recordChange('health', change);\n            debugLog(`: ${change}`);\n        }\n    }\n    const mentalDelta = (CONFIG.mentalBaseline - state.mental) * CONFIG.regressionRate;\n    if (Math.abs(mentalDelta) > 0.01) {\n        state.accumulated.mental += mentalDelta;\n        if (Math.abs(state.accumulated.mental) >= CONFIG.slowChangeThreshold) {\n            const change = Math.floor(state.accumulated.mental);\n            state.mental += change;\n            state.accumulated.mental -= change;\n            recordChange('mental', change);\n            debugLog(`: ${change}`);\n        }\n    }\n}\n// ==========  ==========\n/**\n * \n * @param stateData \n */\nfunction syncStateToMemoryEnhancement(stateData) {\n    // \n    try {\n        const currentChatId = typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\n        if (!currentChatId) {\n            //  CORS \n            console.debug('[] ');\n            return;\n        }\n        // \n        try {\n            const testChatVars = getVariables({ type: 'chat' });\n            if (!testChatVars || typeof testChatVars !== 'object') {\n                //  CORS \n                console.debug('[] ');\n                return;\n            }\n        }\n        catch (testError) {\n            //  CORS \n            console.debug('[] :', testError);\n            return;\n        }\n    }\n    catch (checkError) {\n        //  CORS \n        console.debug('[] :', checkError);\n        return;\n    }\n    const plugin = detectMemoryEnhancementPlugin();\n    if (!plugin) {\n        return;\n    }\n    try {\n        //  updateState \n        if (typeof plugin.updateState === 'function') {\n            plugin.updateState(stateData);\n        }\n        //  setState \n        else if (typeof plugin.setState === 'function') {\n            plugin.setState(stateData);\n        }\n        // HTML\n    }\n    catch (error) {\n        console.warn('[] :', error);\n        //  CORS \n    }\n}\nfunction updateState(data) {\n    if (isUpdating) {\n        console.warn('[] ');\n        return;\n    }\n    isUpdating = true;\n    try {\n        debugLog(':', data);\n        state.stats.totalUpdates++;\n        if (data.name !== undefined)\n            state.name = data.name;\n        if (data.age !== undefined)\n            state.age = data.age;\n        if (data.crime !== undefined)\n            state.crime = data.crime;\n        if (data.health !== undefined) {\n            const delta = data.health - state.health;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.health = data.health;\n                recordChange('health', delta);\n                debugLog(`: ${state.health} (: ${delta})`);\n            }\n            else {\n                state.accumulated.health += delta;\n                debugLog(`: ${state.accumulated.health}`);\n                if (Math.abs(state.accumulated.health) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.health);\n                    state.health += change;\n                    state.accumulated.health -= change;\n                    recordChange('health', change);\n                    debugLog(`: ${state.health} (: ${change})`);\n                }\n            }\n        }\n        if (data.mental !== undefined) {\n            const delta = data.mental - state.mental;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.mental = data.mental;\n                recordChange('mental', delta);\n                debugLog(`: ${state.mental} (: ${delta})`);\n            }\n            else {\n                state.accumulated.mental += delta;\n                debugLog(`: ${state.accumulated.mental}`);\n                if (Math.abs(state.accumulated.mental) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.mental);\n                    state.mental += change;\n                    state.accumulated.mental -= change;\n                    recordChange('mental', change);\n                    debugLog(`: ${state.mental} (: ${change})`);\n                }\n            }\n        }\n        if (data.strength !== undefined) {\n            const delta = data.strength - state.strength;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.strength = data.strength;\n                recordChange('strength', delta);\n                debugLog(`: ${state.strength} (: ${delta})`);\n            }\n            else {\n                state.accumulated.strength += delta;\n                debugLog(`: ${state.accumulated.strength}`);\n                if (Math.abs(state.accumulated.strength) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.strength);\n                    state.strength += change;\n                    state.accumulated.strength -= change;\n                    recordChange('strength', change);\n                    debugLog(`: ${state.strength} (: ${change})`);\n                }\n            }\n        }\n        if (data.intelligence !== undefined) {\n            const delta = data.intelligence - state.intelligence;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.intelligence = data.intelligence;\n                recordChange('intelligence', delta);\n                debugLog(`: ${state.intelligence} (: ${delta})`);\n            }\n            else {\n                state.accumulated.intelligence += delta;\n                debugLog(`: ${state.accumulated.intelligence}`);\n                if (Math.abs(state.accumulated.intelligence) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.intelligence);\n                    state.intelligence += change;\n                    state.accumulated.intelligence -= change;\n                    recordChange('intelligence', change);\n                    debugLog(`: ${state.intelligence} (: ${change})`);\n                }\n            }\n        }\n        if (data.appearance) {\n            if (data.appearance.height !== undefined)\n                state.appearance.height = data.appearance.height;\n            if (data.appearance.weight !== undefined)\n                state.appearance.weight = data.appearance.weight;\n            if (data.appearance.hair !== undefined)\n                state.appearance.hair = data.appearance.hair;\n            if (data.appearance.condition !== undefined)\n                state.appearance.condition = data.appearance.condition;\n        }\n        if (data.clothing) {\n            //  CORS \n            if (data.clothing.top !== undefined)\n                state.clothing.top = data.clothing.top;\n            if (data.clothing.bottom !== undefined)\n                state.clothing.bottom = data.clothing.bottom;\n            if (data.clothing.underwear !== undefined)\n                state.clothing.underwear = data.clothing.underwear;\n            if (data.clothing.underpants !== undefined)\n                state.clothing.underpants = data.clothing.underpants;\n            if (data.clothing.socks !== undefined)\n                state.clothing.socks = data.clothing.socks;\n            if (data.clothing.shoes !== undefined)\n                state.clothing.shoes = data.clothing.shoes;\n            if (data.clothing.restraints !== undefined)\n                state.clothing.restraints = data.clothing.restraints;\n            if (data.clothing.cleanliness !== undefined)\n                state.clothing.cleanliness = data.clothing.cleanliness;\n            //  CORS \n        }\n        if (data.currentTask !== undefined)\n            state.currentTask = data.currentTask;\n        if (data.currentThought !== undefined)\n            state.currentThought = data.currentThought;\n        if (data.biggestWorry !== undefined)\n            state.biggestWorry = data.biggestWorry;\n        if (data.days !== undefined)\n            state.days = data.days;\n        if (data.stage !== undefined)\n            state.stage = data.stage;\n        if (data.cellType !== undefined)\n            state.cellType = data.cellType;\n        state.lastUpdate = Date.now();\n        debugLog('');\n        // \n        const currentState = {\n            name: state.name,\n            age: state.age,\n            crime: state.crime,\n            health: state.health,\n            mental: state.mental,\n            strength: state.strength,\n            intelligence: state.intelligence,\n            appearance: { ...state.appearance },\n            clothing: { ...state.clothing },\n            currentTask: state.currentTask,\n            currentThought: state.currentThought,\n            biggestWorry: state.biggestWorry,\n            days: state.days,\n            stage: state.stage,\n            cellType: state.cellType,\n        };\n        syncStateToMemoryEnhancement(currentState);\n        updateDisplay();\n    }\n    catch (error) {\n        console.error('[] :', error);\n    }\n    finally {\n        isUpdating = false;\n    }\n}\n// ========== HTML ==========\nfunction parseCommentNode(node) {\n    if (!node || node.nodeType !== Node.COMMENT_NODE) {\n        return;\n    }\n    try {\n        let content = node.nodeValue || node.textContent || '';\n        content = content.trim();\n        if (!content) {\n            return;\n        }\n        debugLog(':', content.substring(0, 100) + (content.length > 100 ? '...' : ''));\n        if (content.startsWith('STATUS_UPDATE:')) {\n            const jsonStr = content.substring('STATUS_UPDATE:'.length).trim();\n            debugLog('JSON:', jsonStr.substring(0, 100) + (jsonStr.length > 100 ? '...' : ''));\n            parseStatusUpdate(jsonStr);\n        }\n    }\n    catch (error) {\n        console.error('[] :', error);\n    }\n}\nfunction parseStatusUpdate(jsonStr, attempt = 1) {\n    try {\n        jsonStr = jsonStr.trim();\n        jsonStr = jsonStr.replace(/,(\\s*[}\\]])/g, '$1');\n        jsonStr = jsonStr.replace(/[\\n\\r\\t]/g, '');\n        debugLog(`JSON (${attempt}):`, jsonStr.substring(0, 200) + (jsonStr.length > 200 ? '...' : ''));\n        const data = JSON.parse(jsonStr);\n        console.log('[]  :', data);\n        state.stats.successfulParses++;\n        state.stats.lastParseTime = Date.now();\n        updateState(data);\n        const DS = window.detentionSystem;\n        if (DS && DS.events) {\n            DS.events.emit('statusUpdated', data);\n        }\n        return true;\n    }\n    catch (error) {\n        const errorMessage = error instanceof Error ? error.message : String(error);\n        console.error(`[]   ( ${attempt}/${CONFIG.parseRetryAttempts}):`, errorMessage);\n        console.error('[] JSON:', jsonStr);\n        state.stats.failedParses++;\n        if (attempt < CONFIG.parseRetryAttempts) {\n            console.log(`[]  ${CONFIG.parseRetryDelay}ms ...`);\n            setTimeout(() => {\n                parseStatusUpdate(jsonStr, attempt + 1);\n            }, CONFIG.parseRetryDelay);\n            return false;\n        }\n        else {\n            console.error('[]  ');\n            const DS = window.detentionSystem;\n            if (DS && DS.events) {\n                DS.events.emit('parseError', {\n                    jsonStr,\n                    error: errorMessage,\n                    attempts: attempt,\n                });\n            }\n            return false;\n        }\n    }\n}\nfunction checkForStatusUpdate(element) {\n    if (!element || element.nodeType !== Node.ELEMENT_NODE) {\n        return;\n    }\n    try {\n        const walker = document.createTreeWalker(element, NodeFilter.SHOW_COMMENT);\n        let node;\n        let count = 0;\n        while ((node = walker.nextNode())) {\n            count++;\n            parseCommentNode(node);\n        }\n        if (count > 0) {\n            debugLog(`TreeWalker  ${count} `);\n        }\n    }\n    catch (error) {\n        console.error('[] TreeWalker :', error);\n    }\n}\n// ========== UI ==========\nfunction updateElement(id, value) {\n    const element = document.getElementById(id);\n    if (element && element.textContent !== value) {\n        element.textContent = value;\n        element.classList.remove('updated');\n        setTimeout(() => {\n            element.classList.add('updated');\n        }, 10);\n        setTimeout(() => {\n            element.classList.remove('updated');\n        }, 500);\n    }\n}\nfunction updateStat(key, value) {\n    value = Math.max(0, Math.min(100, value));\n    const valueElement = document.getElementById(`${key}-value`);\n    if (valueElement) {\n        valueElement.textContent = Math.round(value).toString();\n    }\n    const barElement = document.getElementById(`${key}-bar`);\n    if (barElement) {\n        barElement.style.width = `${value}%`;\n        const statBar = barElement.closest('.stat-bar');\n        if (statBar) {\n            statBar.classList.remove('changed');\n            setTimeout(() => {\n                statBar.classList.add('changed');\n            }, 10);\n            setTimeout(() => {\n                statBar.classList.remove('changed');\n            }, 500);\n        }\n    }\n    const trend = calculateTrend(key);\n    const trendElement = document.getElementById(`${key}-trend`);\n    if (trendElement) {\n        trendElement.textContent = TREND_SYMBOLS[trend];\n        trendElement.style.color = trend === 'up' ? '#43e97b' : trend === 'down' ? '#f5576c' : '#999';\n    }\n}\nfunction updateDisplay() {\n    // \n    // \n    if (skipDisplayUpdate)\n        return;\n    // UI\n    try {\n        const memoryState = getStateFromMemoryEnhancement();\n        if (memoryState) {\n            debugLog('[] ');\n        }\n    }\n    catch (error) {\n        console.error('[] :', error);\n    }\n}\nfunction addStyles() {\n    if (document.getElementById('detention-status-styles')) {\n        return;\n    }\n    const style = document.createElement('style');\n    style.id = 'detention-status-styles';\n    style.textContent = `\r\n    #detention-status-panel {\r\n      position: fixed;\r\n      top: 20px;\r\n      right: 20px;\r\n      width: 320px;\r\n      max-height: 90vh;\r\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n      border-radius: 12px;\r\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\r\n      z-index: 10000;\r\n      font-family: 'Microsoft YaHei', 'SimHei', sans-serif;\r\n      overflow: hidden;\r\n      backdrop-filter: blur(10px);\r\n    }\r\n\r\n    .status-header {\r\n      background: rgba(0, 0, 0, 0.2);\r\n      padding: 12px 16px;\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\r\n    }\r\n\r\n    .status-header h3 {\r\n      margin: 0;\r\n      color: #fff;\r\n      font-size: 16px;\r\n      font-weight: 600;\r\n    }\r\n\r\n    .status-header-buttons {\r\n      display: flex;\r\n      gap: 8px;\r\n    }\r\n\r\n    .status-toggle, .status-debug-btn {\r\n      background: rgba(255, 255, 255, 0.2);\r\n      border: none;\r\n      color: #fff;\r\n      width: 28px;\r\n      height: 28px;\r\n      border-radius: 6px;\r\n      cursor: pointer;\r\n      font-size: 16px;\r\n      line-height: 1;\r\n      transition: all 0.3s;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n    }\r\n\r\n    .status-toggle:hover, .status-debug-btn:hover {\r\n      background: rgba(255, 255, 255, 0.3);\r\n      transform: scale(1.1);\r\n    }\r\n\r\n    .status-content {\r\n      max-height: calc(90vh - 60px);\r\n      overflow-y: auto;\r\n      padding: 16px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar {\r\n      width: 6px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar-track {\r\n      background: rgba(0, 0, 0, 0.1);\r\n      border-radius: 3px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar-thumb {\r\n      background: rgba(255, 255, 255, 0.3);\r\n      border-radius: 3px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar-thumb:hover {\r\n      background: rgba(255, 255, 255, 0.5);\r\n    }\r\n\r\n    .status-section {\r\n      background: rgba(255, 255, 255, 0.95);\r\n      border-radius: 8px;\r\n      padding: 12px;\r\n      margin-bottom: 12px;\r\n    }\r\n\r\n    .status-section:last-child {\r\n      margin-bottom: 0;\r\n    }\r\n\r\n    .status-section h4 {\r\n      margin: 0 0 10px 0;\r\n      color: #667eea;\r\n      font-size: 14px;\r\n      font-weight: 600;\r\n      border-bottom: 2px solid #667eea;\r\n      padding-bottom: 6px;\r\n    }\r\n\r\n    .status-item {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 6px 0;\r\n      border-bottom: 1px solid rgba(0, 0, 0, 0.05);\r\n    }\r\n\r\n    .status-item:last-child {\r\n      border-bottom: none;\r\n    }\r\n\r\n    .status-item.full-width {\r\n      flex-direction: column;\r\n      align-items: flex-start;\r\n    }\r\n\r\n    .status-item.full-width .value {\r\n      width: 100%;\r\n      margin-top: 4px;\r\n      padding: 6px;\r\n      background: rgba(102, 126, 234, 0.1);\r\n      border-radius: 4px;\r\n    }\r\n\r\n    .status-item .label {\r\n      color: #666;\r\n      font-size: 13px;\r\n      font-weight: 500;\r\n    }\r\n\r\n    .status-item .value {\r\n      color: #333;\r\n      font-size: 13px;\r\n      font-weight: 600;\r\n      text-align: right;\r\n    }\r\n\r\n    .stat-bar {\r\n      margin-bottom: 12px;\r\n    }\r\n\r\n    .stat-bar:last-child {\r\n      margin-bottom: 0;\r\n    }\r\n\r\n    .stat-label {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      margin-bottom: 6px;\r\n      font-size: 13px;\r\n      font-weight: 600;\r\n      color: #333;\r\n    }\r\n\r\n    .stat-value {\r\n      color: #667eea;\r\n      font-size: 14px;\r\n    }\r\n\r\n    .stat-trend {\r\n      font-size: 16px;\r\n      margin-left: 4px;\r\n    }\r\n\r\n    .stat-progress {\r\n      height: 8px;\r\n      background: rgba(0, 0, 0, 0.1);\r\n      border-radius: 4px;\r\n      overflow: hidden;\r\n    }\r\n\r\n    .stat-fill {\r\n      height: 100%;\r\n      transition: width 0.3s ease, background-color 0.3s ease;\r\n      border-radius: 4px;\r\n    }\r\n\r\n    .stat-fill.health {\r\n      background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);\r\n    }\r\n\r\n    .stat-fill.mental {\r\n      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);\r\n    }\r\n\r\n    .stat-fill.strength {\r\n      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);\r\n    }\r\n\r\n    .stat-fill.intelligence {\r\n      background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);\r\n    }\r\n\r\n    .debug-buttons {\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 8px;\r\n      margin-top: 12px;\r\n    }\r\n\r\n    .debug-btn {\r\n      background: #667eea;\r\n      color: white;\r\n      border: none;\r\n      padding: 8px 12px;\r\n      border-radius: 6px;\r\n      cursor: pointer;\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      transition: all 0.3s;\r\n    }\r\n\r\n    .debug-btn:hover {\r\n      background: #764ba2;\r\n      transform: translateY(-2px);\r\n      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\r\n    }\r\n\r\n    @keyframes pulse {\r\n      0%, 100% { transform: scale(1); }\r\n      50% { transform: scale(1.05); }\r\n    }\r\n\r\n    .stat-bar.changed {\r\n      animation: pulse 0.5s ease;\r\n    }\r\n\r\n    @keyframes fadeIn {\r\n      from { opacity: 0; transform: translateY(-10px); }\r\n      to { opacity: 1; transform: translateY(0); }\r\n    }\r\n\r\n    .status-item.updated {\r\n      animation: fadeIn 0.3s ease;\r\n    }\r\n\r\n    @media (max-width: 768px) {\r\n      #detention-status-panel {\r\n        width: 280px;\r\n        top: 10px;\r\n        right: 10px;\r\n      }\r\n    }\r\n  `;\n    document.head.appendChild(style);\n}\nfunction createStatusPanel() {\n    // \n    // UI\n    const memoryEnhancement = detectMemoryEnhancementPlugin();\n    if (memoryEnhancement) {\n        console.log('[] ');\n    }\n    else {\n        console.log('[] ');\n    }\n}\nfunction updateDebugInfo() {\n    updateElement('debug-total-updates', state.stats.totalUpdates.toString());\n    updateElement('debug-success-parses', state.stats.successfulParses.toString());\n    updateElement('debug-failed-parses', state.stats.failedParses.toString());\n    const lastUpdate = state.stats.lastParseTime > 0 ? new Date(state.stats.lastParseTime).toLocaleTimeString('zh-CN') : '';\n    updateElement('debug-last-update', lastUpdate);\n    const observerStatus = mutationObserver ? '' : '';\n    updateElement('debug-observer-status', observerStatus);\n}\n// ==========  ==========\nfunction startCommentListener() {\n    if (mutationObserver) {\n        mutationObserver.disconnect();\n    }\n    console.log('[] HTML...');\n    mutationObserver = new MutationObserver(mutations => {\n        for (const mutation of mutations) {\n            if (mutation.type === 'childList') {\n                for (const node of mutation.addedNodes) {\n                    if (node.nodeType === Node.COMMENT_NODE) {\n                        parseCommentNode(node);\n                    }\n                    else if (node.nodeType === Node.ELEMENT_NODE) {\n                        checkForStatusUpdate(node);\n                    }\n                }\n            }\n            if (mutation.type === 'characterData') {\n                if (mutation.target.nodeType === Node.COMMENT_NODE) {\n                    parseCommentNode(mutation.target);\n                }\n            }\n        }\n    });\n    mutationObserver.observe(document.body, {\n        childList: true,\n        subtree: true,\n        characterData: true,\n        characterDataOldValue: false,\n    });\n    console.log('[] ...');\n    setTimeout(() => {\n        checkForStatusUpdate(document.body);\n    }, 1000);\n    console.log('[] HTML');\n}\nfunction stopCommentListener() {\n    if (mutationObserver) {\n        mutationObserver.disconnect();\n        mutationObserver = null;\n        console.log('[] HTML');\n    }\n}\nfunction startUpdateLoop() {\n    // \n    // \n    debugLog('');\n}\nfunction stopUpdateLoop() {\n    // \n    if (updateLoopInterval) {\n        clearInterval(updateLoopInterval);\n        updateLoopInterval = null;\n    }\n}\n// ==========  ==========\n/**\n * \n * @returns  null\n */\nfunction detectMemoryEnhancementPlugin() {\n    //  CORS \n    try {\n        //  stMemoryEnhancement\n        const memoryEnhancement = window.stMemoryEnhancement ||\n            window.MemoryEnhancement ||\n            window.memoryEnhancement ||\n            window.MemoryEnhancementPlugin ||\n            window.memoryEnhancementPlugin;\n        //  CORS \n        //  ext_getAllTables  ext_exportAllTablesAsJson\n        if (memoryEnhancement &&\n            (typeof memoryEnhancement.ext_getAllTables === 'function' ||\n                typeof memoryEnhancement.ext_exportAllTablesAsJson === 'function')) {\n            //  CORS \n            return memoryEnhancement;\n        }\n        //  CORS \n        return null;\n    }\n    catch (error) {\n        console.warn('[] :', error);\n        //  CORS \n        return null;\n    }\n}\n/**\n * \n * @returns  null\n */\nfunction getStateFromMemoryEnhancement() {\n    const plugin = detectMemoryEnhancementPlugin();\n    if (!plugin) {\n        return null;\n    }\n    try {\n        // \n        let memoryState = null;\n        //  getState \n        //  ext_exportAllTablesAsJson\n        if (!memoryState) {\n            //  CORS \n            // \n            // \n            try {\n                const chatVars = getVariables({ type: 'chat' });\n                const messageVars = getVariables({ type: 'message', message_id: 'latest' });\n                // \n                const possiblePaths = [\n                    'state',\n                    'status',\n                    'character',\n                    'protagonist',\n                    'player',\n                    'main',\n                    'current',\n                    'stat_data',\n                    'memory',\n                    'memoryEnhancement',\n                    'stMemoryEnhancement',\n                ];\n                for (const path of possiblePaths) {\n                    // \n                    if (chatVars && typeof chatVars === 'object' && path in chatVars) {\n                        const candidate = chatVars[path];\n                        if (candidate && typeof candidate === 'object' && ('health' in candidate || 'mental' in candidate)) {\n                            memoryState = candidate;\n                            //  CORS \n                            break;\n                        }\n                    }\n                    // \n                    if (messageVars && typeof messageVars === 'object' && path in messageVars) {\n                        const candidate = messageVars[path];\n                        if (candidate && typeof candidate === 'object' && ('health' in candidate || 'mental' in candidate)) {\n                            memoryState = candidate;\n                            //  CORS \n                            break;\n                        }\n                    }\n                }\n                // \n                if (!memoryState) {\n                    const searchInVars = (vars, prefix = '') => {\n                        if (!vars || typeof vars !== 'object')\n                            return null;\n                        if (Array.isArray(vars)) {\n                            for (let i = 0; i < vars.length; i++) {\n                                const result = searchInVars(vars[i], `${prefix}[${i}]`);\n                                if (result)\n                                    return result;\n                            }\n                            return null;\n                        }\n                        if ('health' in vars && 'mental' in vars) {\n                            return vars;\n                        }\n                        for (const [key, value] of Object.entries(vars)) {\n                            const result = searchInVars(value, prefix ? `${prefix}.${key}` : key);\n                            if (result)\n                                return result;\n                        }\n                        return null;\n                    };\n                    const foundInChat = searchInVars(chatVars);\n                    if (foundInChat) {\n                        memoryState = foundInChat;\n                        //  CORS \n                    }\n                    else {\n                        const foundInMessage = searchInVars(messageVars);\n                        if (foundInMessage) {\n                            memoryState = foundInMessage;\n                            //  CORS \n                        }\n                    }\n                }\n            }\n            catch (error) {\n                console.warn('[] :', error);\n                //  CORS \n            }\n            //  ext_exportAllTablesAsJson\n            //  ext_exportAllTablesAsJson  ext_getAllTables\n            if (!memoryState) {\n                //  ext_exportAllTablesAsJson\n                if (typeof plugin.ext_exportAllTablesAsJson === 'function') {\n                    try {\n                        //  CORS \n                        const jsonData = plugin.ext_exportAllTablesAsJson();\n                        //  CORS \n                        // ext_exportAllTablesAsJson : {uid: {uid, name, content: Array<Array<string>>}, ...}\n                        if (jsonData && typeof jsonData === 'object' && !Array.isArray(jsonData)) {\n                            const tables = Object.values(jsonData);\n                            // \n                            const possibleTableNames = [\n                                'state',\n                                'status',\n                                'character',\n                                'protagonist',\n                                'player',\n                                'main',\n                                'current',\n                                '',\n                                '',\n                                '',\n                                '',\n                            ];\n                            let targetTable = null;\n                            for (const table of tables) {\n                                if (table &&\n                                    typeof table === 'object' &&\n                                    'name' in table &&\n                                    typeof table.name === 'string' &&\n                                    possibleTableNames.some(name => table.name.toLowerCase().includes(name.toLowerCase()))) {\n                                    targetTable = table;\n                                    break;\n                                }\n                            }\n                            //  health  mental \n                            if (!targetTable) {\n                                for (const table of tables) {\n                                    if (table &&\n                                        typeof table === 'object' &&\n                                        'content' in table &&\n                                        Array.isArray(table.content) &&\n                                        table.content.length >= 2) {\n                                        const header = table.content[0];\n                                        if (Array.isArray(header) &&\n                                            (header.some((h) => h && h.toLowerCase().includes('health')) ||\n                                                header.some((h) => h && h.toLowerCase().includes('mental')) ||\n                                                header.some((h) => h && h.toLowerCase().includes('')) ||\n                                                header.some((h) => h && h.toLowerCase().includes('')))) {\n                                            targetTable = table;\n                                            break;\n                                        }\n                                    }\n                                }\n                            }\n                            // \n                            if (targetTable && Array.isArray(targetTable.content) && targetTable.content.length >= 2) {\n                                const header = targetTable.content[0];\n                                const firstDataRow = targetTable.content[1];\n                                if (Array.isArray(header) && Array.isArray(firstDataRow)) {\n                                    const stateObj = {};\n                                    header.forEach((colName, index) => {\n                                        if (colName && firstDataRow[index] !== undefined) {\n                                            const normalizedName = colName.toLowerCase().trim();\n                                            const value = firstDataRow[index];\n                                            const numValue = typeof value === 'string' ? parseFloat(value) : value;\n                                            const finalValue = !isNaN(numValue) && numValue !== null ? numValue : value;\n                                            if (normalizedName.includes('health') || normalizedName.includes('')) {\n                                                stateObj.health = finalValue;\n                                            }\n                                            else if (normalizedName.includes('mental') || normalizedName.includes('')) {\n                                                stateObj.mental = finalValue;\n                                            }\n                                            else if (normalizedName.includes('strength') || normalizedName.includes('')) {\n                                                stateObj.strength = finalValue;\n                                            }\n                                            else if (normalizedName.includes('intelligence') || normalizedName.includes('')) {\n                                                stateObj.intelligence = finalValue;\n                                            }\n                                            stateObj[colName] = finalValue;\n                                        }\n                                    });\n                                    if ('health' in stateObj || 'mental' in stateObj) {\n                                        memoryState = stateObj;\n                                        //  CORS \n                                    }\n                                }\n                            }\n                        }\n                    }\n                    catch (jsonError) {\n                        console.warn('[] ext_exportAllTablesAsJson  ext_getAllTables:', jsonError);\n                        //  CORS \n                    }\n                }\n                //  ext_exportAllTablesAsJson  ext_getAllTables\n                if (!memoryState && typeof plugin.ext_getAllTables === 'function') {\n                    try {\n                        //  CORS \n                        const allTables = plugin.ext_getAllTables();\n                        //  CORS \n                        // ext_getAllTables : [{name: string, data: Array<Array<string>>}, ...]\n                        // data \n                        if (Array.isArray(allTables) && allTables.length > 0) {\n                            // \n                            const possibleTableNames = [\n                                'state',\n                                'status',\n                                'character',\n                                'protagonist',\n                                'player',\n                                'main',\n                                'current',\n                                '',\n                                '',\n                                '',\n                                '',\n                            ];\n                            let targetTable = null;\n                            for (const table of allTables) {\n                                if (table &&\n                                    table.name &&\n                                    possibleTableNames.some(name => table.name.toLowerCase().includes(name.toLowerCase()))) {\n                                    targetTable = table;\n                                    break;\n                                }\n                            }\n                            //  health  mental \n                            if (!targetTable) {\n                                for (const table of allTables) {\n                                    if (!table || !Array.isArray(table.data) || table.data.length < 2)\n                                        continue;\n                                    const header = table.data[0]; // \n                                    if (Array.isArray(header) &&\n                                        (header.some((h) => h && h.toLowerCase().includes('health')) ||\n                                            header.some((h) => h && h.toLowerCase().includes('mental')) ||\n                                            header.some((h) => h && h.toLowerCase().includes('')) ||\n                                            header.some((h) => h && h.toLowerCase().includes('')))) {\n                                        targetTable = table;\n                                        break;\n                                    }\n                                }\n                            }\n                            // \n                            if (targetTable && Array.isArray(targetTable.data) && targetTable.data.length >= 2) {\n                                const header = targetTable.data[0];\n                                const firstDataRow = targetTable.data[1]; // \n                                if (Array.isArray(header) && Array.isArray(firstDataRow)) {\n                                    const stateObj = {};\n                                    header.forEach((colName, index) => {\n                                        if (colName && firstDataRow[index] !== undefined) {\n                                            // \n                                            const normalizedName = colName.toLowerCase().trim();\n                                            const value = firstDataRow[index];\n                                            // \n                                            const numValue = typeof value === 'string' ? parseFloat(value) : value;\n                                            const finalValue = !isNaN(numValue) && numValue !== null ? numValue : value;\n                                            // \n                                            if (normalizedName.includes('health') || normalizedName.includes('')) {\n                                                stateObj.health = finalValue;\n                                            }\n                                            else if (normalizedName.includes('mental') || normalizedName.includes('')) {\n                                                stateObj.mental = finalValue;\n                                            }\n                                            else if (normalizedName.includes('strength') || normalizedName.includes('')) {\n                                                stateObj.strength = finalValue;\n                                            }\n                                            else if (normalizedName.includes('intelligence') || normalizedName.includes('')) {\n                                                stateObj.intelligence = finalValue;\n                                            }\n                                            // \n                                            stateObj[colName] = finalValue;\n                                        }\n                                    });\n                                    //  health  mental\n                                    if ('health' in stateObj || 'mental' in stateObj) {\n                                        memoryState = stateObj;\n                                        //  CORS \n                                    }\n                                }\n                            }\n                        }\n                    }\n                    catch (extError) {\n                        // ext_getAllTables  table.getBody is not a function\n                        console.warn('[] ext_getAllTables :', extError);\n                        //  CORS \n                    }\n                }\n            }\n        } //  if (!memoryState) - \n        if (!memoryState || typeof memoryState !== 'object') {\n            //  CORS \n            return null;\n        }\n        // \n        if (memoryState.health === undefined && memoryState.mental === undefined) {\n            //  CORS \n            return null;\n        }\n        // \n        const fullState = {\n            name: memoryState.name ?? state.name ?? undefined,\n            age: memoryState.age ?? state.age ?? undefined,\n            crime: memoryState.crime ?? state.crime ?? undefined,\n            health: memoryState.health ?? state.health ?? 70,\n            mental: memoryState.mental ?? state.mental ?? 65,\n            strength: memoryState.strength ?? state.strength ?? 50,\n            intelligence: memoryState.intelligence ?? state.intelligence ?? 55,\n            appearance: memoryState.appearance\n                ? {\n                    height: memoryState.appearance.height ?? state.appearance.height,\n                    weight: memoryState.appearance.weight ?? state.appearance.weight,\n                    hair: memoryState.appearance.hair ?? state.appearance.hair,\n                    condition: memoryState.appearance.condition ?? state.appearance.condition,\n                }\n                : { ...state.appearance },\n            clothing: memoryState.clothing\n                ? {\n                    top: memoryState.clothing.top ?? state.clothing.top,\n                    bottom: memoryState.clothing.bottom ?? state.clothing.bottom,\n                    underwear: memoryState.clothing.underwear ?? state.clothing.underwear,\n                    underpants: memoryState.clothing.underpants ?? state.clothing.underpants,\n                    socks: memoryState.clothing.socks ?? state.clothing.socks,\n                    shoes: memoryState.clothing.shoes ?? state.clothing.shoes,\n                    restraints: memoryState.clothing.restraints ?? state.clothing.restraints,\n                    cleanliness: memoryState.clothing.cleanliness ?? state.clothing.cleanliness,\n                }\n                : { ...state.clothing },\n            currentTask: memoryState.currentTask ?? state.currentTask ?? undefined,\n            currentThought: memoryState.currentThought ?? state.currentThought ?? undefined,\n            biggestWorry: memoryState.biggestWorry ?? state.biggestWorry ?? undefined,\n            days: memoryState.days ?? memoryState.day ?? state.days ?? 0,\n            stage: memoryState.stage ?? state.stage ?? undefined,\n            cellType: memoryState.cellType ?? memoryState.cell_type ?? state.cellType ?? undefined,\n        };\n        return fullState;\n    }\n    catch (error) {\n        console.warn('[] :', error);\n        return null;\n    }\n}\n// ========== API ==========\nconst StatusPanel = {\n    version: '3.5.6',\n    state,\n    initialize() {\n        console.log('[]  v3.5.6 ()');\n        // UI\n        createStatusPanel(); // UI\n        startCommentListener(); // HTML\n        const DS = window.detentionSystem;\n        if (DS && DS.events) {\n            DS.events.on('stateChanged', (data) => {\n                debugLog(':', data);\n                if (data && typeof data === 'object') {\n                    updateState(data);\n                }\n            });\n            DS.events.on('dayAdvanced', (data) => {\n                debugLog(':', data);\n                if (data && typeof data === 'object') {\n                    const d = data;\n                    if (d.days !== undefined)\n                        state.days = d.days;\n                    if (d.stage !== undefined)\n                        state.stage = d.stage;\n                    if (d.cellType !== undefined)\n                        state.cellType = d.cellType;\n                    updateDisplay();\n                }\n            });\n        }\n        console.log('[] ');\n        console.log('[] :', CONFIG.debugMode ? '' : '');\n    },\n    destroy() {\n        console.log('[] ...');\n        stopCommentListener();\n        stopUpdateLoop();\n        // UI\n        // \n        const DS = window.detentionSystem;\n        if (DS && DS.events) {\n            DS.events.off('stateChanged', () => { });\n            DS.events.off('dayAdvanced', () => { });\n        }\n        console.log('[] ');\n    },\n    getState() {\n        // \n        const memoryState = getStateFromMemoryEnhancement();\n        if (memoryState) {\n            debugLog('[] ');\n            return memoryState;\n        }\n        // \n        debugLog('[] ');\n        //  CORS \n        const internalState = {\n            name: state.name,\n            age: state.age,\n            crime: state.crime,\n            health: state.health,\n            mental: state.mental,\n            strength: state.strength,\n            intelligence: state.intelligence,\n            appearance: { ...state.appearance },\n            clothing: { ...state.clothing },\n            currentTask: state.currentTask,\n            currentThought: state.currentThought,\n            biggestWorry: state.biggestWorry,\n            days: state.days,\n            stage: state.stage,\n            cellType: state.cellType,\n        };\n        return internalState;\n    },\n    modifyValue(key, delta, reason = '') {\n        if (state[key] === undefined) {\n            console.error(`[] : ${key}`);\n            return;\n        }\n        const oldValue = state[key];\n        const newValue = Math.max(0, Math.min(100, oldValue + delta));\n        if (newValue !== oldValue) {\n            state[key] = newValue;\n            recordChange(key, delta);\n            console.log(`[] ${key} : ${oldValue}  ${newValue} (${delta > 0 ? '+' : ''}${delta}) ${reason ? `: ${reason}` : ''}`);\n            const DS = window.detentionSystem;\n            if (DS && DS.events) {\n                DS.events.emit('valueChanged', {\n                    key,\n                    oldValue,\n                    newValue,\n                    delta,\n                    reason,\n                });\n            }\n            // \n            syncStateToMemoryEnhancement(StatusPanel.getState());\n            updateDisplay();\n        }\n    },\n    getTrendAnalysis() {\n        return {\n            health: {\n                value: state.health,\n                trend: calculateTrend('health'),\n                changes: state.changes.health || [],\n            },\n            mental: {\n                value: state.mental,\n                trend: calculateTrend('mental'),\n                changes: state.changes.mental || [],\n            },\n            strength: {\n                value: state.strength,\n                trend: calculateTrend('strength'),\n                changes: state.changes.strength || [],\n            },\n            intelligence: {\n                value: state.intelligence,\n                trend: calculateTrend('intelligence'),\n                changes: state.changes.intelligence || [],\n            },\n        };\n    },\n    getCurrentStage() {\n        return {\n            days: state.days,\n            stage: state.stage,\n            cellType: state.cellType,\n        };\n    },\n    parseStatusUpdate,\n    reset() {\n        state = {\n            name: '',\n            age: 0,\n            crime: '',\n            health: 75,\n            mental: 70,\n            strength: 65,\n            intelligence: 70,\n            appearance: {\n                height: 0,\n                weight: 0,\n                hair: '',\n                condition: '',\n            },\n            clothing: {\n                top: '',\n                bottom: '',\n                underwear: '',\n                underpants: '',\n                socks: '',\n                shoes: '',\n                restraints: '',\n                cleanliness: '',\n            },\n            currentTask: '',\n            currentThought: '',\n            biggestWorry: '',\n            days: 0,\n            stage: '',\n            cellType: '',\n            changes: {\n                health: [],\n                mental: [],\n                strength: [],\n                intelligence: [],\n            },\n            accumulated: {\n                health: 0,\n                mental: 0,\n                strength: 0,\n                intelligence: 0,\n            },\n            lastUpdate: Date.now(),\n            stats: {\n                totalUpdates: 0,\n                successfulParses: 0,\n                failedParses: 0,\n                lastParseTime: 0,\n            },\n        };\n        updateDisplay();\n        console.log('[] ');\n    },\n    exportData() {\n        return {\n            version: '3.5.6',\n            timestamp: Date.now(),\n            state: JSON.parse(JSON.stringify(state)),\n        };\n    },\n    importData(data) {\n        if (!data || !data.state) {\n            console.error('[] ');\n            return false;\n        }\n        try {\n            if (data.version && data.version !== '3.5.6') {\n                console.warn(`[] : ${data.version} vs 3.5.6`);\n            }\n            state = data.state;\n            if (!state.changes) {\n                state.changes = {\n                    health: [],\n                    mental: [],\n                    strength: [],\n                    intelligence: [],\n                };\n            }\n            if (!state.accumulated) {\n                state.accumulated = {\n                    health: 0,\n                    mental: 0,\n                    strength: 0,\n                    intelligence: 0,\n                };\n            }\n            if (!state.stats) {\n                state.stats = {\n                    totalUpdates: 0,\n                    successfulParses: 0,\n                    failedParses: 0,\n                    lastParseTime: 0,\n                };\n            }\n            state.lastUpdate = Date.now();\n            updateDisplay();\n            console.log('[] ');\n            return true;\n        }\n        catch (error) {\n            console.error('[] :', error);\n            return false;\n        }\n    },\n};\n// ==========  ==========\nfunction scanAllComments() {\n    console.log('[] ...');\n    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_COMMENT);\n    const comments = [];\n    let node;\n    while ((node = walker.nextNode())) {\n        const content = (node.nodeValue || node.textContent || '').trim();\n        comments.push({\n            content: content.substring(0, 100) + (content.length > 100 ? '...' : ''),\n            fullContent: content,\n            isStatusUpdate: content.startsWith('STATUS_UPDATE:'),\n            length: content.length,\n        });\n        if (content.startsWith('STATUS_UPDATE:')) {\n            console.log('[]  :', content.substring(0, 100));\n            parseCommentNode(node);\n        }\n    }\n    console.log(`[]  ${comments.length} `);\n    console.log('[] :', comments.filter(c => c.isStatusUpdate).length);\n    console.table(comments);\n    return comments;\n}\nfunction getDiagnostics() {\n    const diagnostics = {\n        version: '3.5.6',\n        timestamp: new Date().toLocaleString('zh-CN'),\n        observer: {\n            active: mutationObserver !== null,\n            status: mutationObserver ? '' : '',\n        },\n        state: {\n            lastUpdate: new Date(state.lastUpdate).toLocaleString('zh-CN'),\n            timeSinceUpdate: Date.now() - state.lastUpdate,\n            timeSinceUpdateFormatted: formatDuration(Date.now() - state.lastUpdate),\n        },\n        stats: {\n            totalUpdates: state.stats.totalUpdates,\n            successfulParses: state.stats.successfulParses,\n            failedParses: state.stats.failedParses,\n            successRate: state.stats.totalUpdates > 0\n                ? `${((state.stats.successfulParses / state.stats.totalUpdates) * 100).toFixed(2)}%`\n                : 'N/A',\n            lastParseTime: state.stats.lastParseTime > 0 ? new Date(state.stats.lastParseTime).toLocaleString('zh-CN') : '',\n        },\n        currentState: StatusPanel.getState(),\n        config: CONFIG,\n    };\n    console.log('[] ');\n    console.log('[] :', diagnostics.version);\n    console.log('[] :', diagnostics.timestamp);\n    console.log('[] :', diagnostics.observer.status);\n    console.log('[] :', diagnostics.state.lastUpdate);\n    console.log('[] :', diagnostics.state.timeSinceUpdateFormatted);\n    console.log('[] :', diagnostics.stats);\n    console.log('[] :', diagnostics.currentState);\n    return diagnostics;\n}\n//  StatusPanel \nStatusPanel.debug = {\n    scanAllComments,\n    getDiagnostics,\n    parseCommentNode,\n    checkForStatusUpdate,\n};\n// ==========  ==========\n$(() => {\n    console.info('[]  v3.5.6 ()');\n    const DS = window.detentionSystem;\n    if (!DS) {\n        console.error('[] ');\n        return;\n    }\n    // \n    DS.getState = () => StatusPanel.getState();\n    DS.modifyValue = (key, delta, reason) => StatusPanel.modifyValue(key, delta, reason);\n    DS.getTrendAnalysis = () => StatusPanel.getTrendAnalysis();\n    DS.getCurrentStage = () => StatusPanel.getCurrentStage();\n    DS.parseStatusUpdate = (jsonStr) => StatusPanel.parseStatusUpdate(jsonStr);\n    // \n    DS.registerModule('statusPanel', StatusPanel);\n    //  window \n    window.detentionSystem.statusPanel = StatusPanel;\n    // iframe \n    try {\n        if (window.parent && window.parent !== window) {\n            window.parent.detentionSystem = DS;\n            console.info('[]  ');\n        }\n    }\n    catch (e) {\n        // \n    }\n    // \n    DS.events.on('initialized', () => {\n        console.info('[] ');\n        setTimeout(() => {\n            try {\n                StatusPanel.initialize();\n                console.info('[]  ');\n            }\n            catch (error) {\n                console.error('[]  :', error);\n            }\n        }, 500);\n    });\n    // \n    if (DS.initialized) {\n        setTimeout(() => {\n            try {\n                StatusPanel.initialize();\n                console.info('[]  ');\n            }\n            catch (error) {\n                console.error('[]  :', error);\n            }\n        }, 500);\n    }\n    console.info('[]  v3.5.6 ()');\n});\n// \n$(window).on('pagehide', () => {\n    console.log('[] ...');\n    stopCommentListener();\n    stopUpdateLoop();\n});\nexport {};\n","export {};\r\n\r\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\r\ndeclare const $: JQueryStaticLike;\r\n\r\n/**\r\n * \r\n *  API name\r\n */\r\n\r\ninterface WorldbookConfig {\r\n  name: string; // \r\n  displayName: string; // \r\n  priority: number; // \r\n  keywords: string[]; // \r\n  autoLoad: boolean; // \r\n  description?: string; // \r\n  position?: 'before_char' | 'after_char'; // \r\n  depth?: number; // \r\n  fallbackEntries?: unknown[]; // \r\n}\r\n\r\ninterface LoadedWorldbook {\r\n  name: string;\r\n  displayName: string;\r\n  entries: unknown[];\r\n  fallback: boolean;\r\n  error?: string;\r\n  loadedAt: number;\r\n}\r\n\r\ninterface WorldbookStatus {\r\n  initialized: boolean;\r\n  fallbackMode: boolean;\r\n  characterWorldbook: string | null;\r\n  loaded: Array<{\r\n    name: string;\r\n    displayName: string;\r\n    entries: number;\r\n    fallback: boolean;\r\n    error?: string;\r\n    loadedAt: string;\r\n  }>;\r\n  loading: Array<{\r\n    name: string;\r\n    displayName: string;\r\n  }>;\r\n  available: Array<{\r\n    name: string;\r\n    displayName: string;\r\n    autoLoad: boolean;\r\n  }>;\r\n}\r\n\r\ninterface EventBus {\r\n  on(event: string, callback: (data?: unknown) => void): void;\r\n  emit(event: string, data?: unknown): void;\r\n}\r\n\r\ninterface DetentionSystem {\r\n  version: string;\r\n  initialized: boolean;\r\n  modules: Record<string, unknown>;\r\n  config: Record<string, unknown>;\r\n  state: Record<string, unknown>;\r\n  events: EventBus;\r\n  CacheManager: unknown;\r\n  EventEmitter: unknown;\r\n  ping(): boolean;\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n  handleError(error: unknown, context?: string): void;\r\n}\r\n\r\n// \r\nconst WORLDBOOKS: Record<string, WorldbookConfig> = {\r\n  detention_rules: {\r\n    name: 'detention_rules',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 10,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: true,\r\n    position: 'before_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  internal_basic_procedures: {\r\n    name: 'internal_basic_procedures',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 9,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'after_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  internal_basic_legal: {\r\n    name: 'internal_basic_legal',\r\n    displayName: '',\r\n    description:\r\n      '//',\r\n    priority: 8,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'before_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  legal_knowledge: {\r\n    name: 'legal_knowledge',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 7,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'after_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  environment_descriptions: {\r\n    name: 'environment_descriptions',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 6,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'before_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  narrative_enhancements: {\r\n    name: 'narrative_enhancements',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 5,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'after_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n};\r\n\r\ninterface WorldbookLoaderImpl {\r\n  loaded: Map<string, LoadedWorldbook>;\r\n  loading: Map<string, Promise<LoadedWorldbook>>;\r\n  initialized: boolean;\r\n  fallbackMode: boolean;\r\n  characterWorldbookId: string | null;\r\n  failedBooks?: Set<string>; // \r\n\r\n  findCharacterWorldbook(): Promise<string | null>;\r\n  loadWorldbook(bookName: string): Promise<LoadedWorldbook>;\r\n  _loadWorldbookInternal(bookName: string, config: WorldbookConfig): Promise<LoadedWorldbook>;\r\n  predictiveCache(context: string): Promise<void>;\r\n  getRelevantEntries(context: string, maxEntries?: number): unknown[];\r\n  dynamicLoad(userInput: string): Promise<void>;\r\n  getStatus(): WorldbookStatus;\r\n  unloadWorldbook(bookName: string): Promise<void>;\r\n  reloadWorldbook(bookName: string): Promise<LoadedWorldbook>;\r\n  initialize(): Promise<void>;\r\n  shutdown(): void;\r\n}\r\n\r\nconsole.info('[] v5.1.0 ...');\r\n\r\n/**\r\n * \r\n */\r\nfunction safeGetWorldbookNames(): string[] {\r\n  //  CORS \r\n\r\n  // A: \r\n  if (typeof (window as any).getWorldbookNames !== 'undefined') {\r\n    //  CORS \r\n    return (window as any).getWorldbookNames();\r\n  }\r\n\r\n  // B:  window.TavernHelper \r\n  if (typeof window !== 'undefined' && (window as any).TavernHelper) {\r\n    const helper = (window as any).TavernHelper;\r\n    if (typeof helper.getWorldbookNames === 'function') {\r\n      //  CORS \r\n      return helper.getWorldbookNames();\r\n    }\r\n  }\r\n\r\n  //  CORS \r\n\r\n  throw new Error(\r\n    'getWorldbookNames ' +\r\n      ' Tavern Helper ' +\r\n      ' getWorldbookNames  window.TavernHelper ',\r\n  );\r\n}\r\n\r\n//  jQuery ready \r\n$(() => {\r\n  const DS_RAW = window.detentionSystem as DetentionSystem | undefined;\r\n  if (!DS_RAW) {\r\n    console.error('[] ');\r\n    console.error('[]  core.ts ');\r\n    return;\r\n  }\r\n\r\n  // DS \r\n  const DS = DS_RAW as DetentionSystem;\r\n\r\n  // \r\n  (DS as DetentionSystem & { characterId?: string }).characterId = 'detention_center';\r\n  console.info('[]  ');\r\n\r\n  // ==========  ==========\r\n  const WorldbookLoader: WorldbookLoaderImpl = {\r\n    loaded: new Map(),\r\n    loading: new Map(),\r\n    initialized: false,\r\n    fallbackMode: false,\r\n    characterWorldbookId: null,\r\n    // \r\n    failedBooks: new Set<string>(),\r\n\r\n    /**\r\n     * \r\n     */\r\n    async findCharacterWorldbook(): Promise<string | null> {\r\n      console.info('[] ...');\r\n\r\n      try {\r\n        const charWorldbooks = getCharWorldbookNames('current');\r\n        if (charWorldbooks.primary) {\r\n          console.info(`[]  : ${charWorldbooks.primary}`);\r\n          this.characterWorldbookId = charWorldbooks.primary;\r\n          return charWorldbooks.primary;\r\n        }\r\n\r\n        if (charWorldbooks.additional.length > 0) {\r\n          console.info(`[]  : ${charWorldbooks.additional[0]}`);\r\n          this.characterWorldbookId = charWorldbooks.additional[0];\r\n          return charWorldbooks.additional[0];\r\n        }\r\n\r\n        console.warn('[]  ');\r\n        return null;\r\n      } catch (error) {\r\n        console.error('[] :', error);\r\n        return null;\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async loadWorldbook(bookName: string): Promise<LoadedWorldbook> {\r\n      const config = WORLDBOOKS[bookName];\r\n      if (!config) {\r\n        throw new Error(`: ${bookName}`);\r\n      }\r\n\r\n      // \r\n      if (this.failedBooks?.has(bookName)) {\r\n        console.warn(`[]  ${config.displayName} `);\r\n        throw new Error(` \"${bookName}\" `);\r\n      }\r\n\r\n      // \r\n      if (this.loaded.has(bookName)) {\r\n        console.info(`[] ${config.displayName} `);\r\n        return this.loaded.get(bookName)!;\r\n      }\r\n\r\n      // \r\n      if (this.loading.has(bookName)) {\r\n        console.info(`[] ${config.displayName} ...`);\r\n        return await this.loading.get(bookName)!;\r\n      }\r\n\r\n      //  Promise\r\n      const loadPromise = this._loadWorldbookInternal(bookName, config);\r\n      this.loading.set(bookName, loadPromise);\r\n\r\n      try {\r\n        const result = await loadPromise;\r\n        this.loaded.set(bookName, result);\r\n        // \r\n        if (this.failedBooks?.has(bookName)) {\r\n          this.failedBooks.delete(bookName);\r\n          console.info(`[]  ${config.displayName} `);\r\n        }\r\n        return result;\r\n      } catch (error) {\r\n        //  _loadWorldbookInternal \r\n        throw error;\r\n      } finally {\r\n        this.loading.delete(bookName);\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async _loadWorldbookInternal(bookName: string, config: WorldbookConfig): Promise<LoadedWorldbook> {\r\n      console.info(`[] : ${config.displayName} (${bookName})`);\r\n\r\n      try {\r\n        // \r\n        //  CORS \r\n        const allWorldbookNames = safeGetWorldbookNames();\r\n        //  CORS \r\n\r\n        // displayName\r\n        let targetWorldbookName: string | null = null;\r\n\r\n        // 1.  displayName- \r\n        const exactDisplayMatch = allWorldbookNames.find(name => name === config.displayName);\r\n        if (exactDisplayMatch) {\r\n          targetWorldbookName = exactDisplayMatch;\r\n          console.info(`[]  : \"${config.displayName}\"`);\r\n        } else if (allWorldbookNames.includes(config.name)) {\r\n          // 2.  name\r\n          targetWorldbookName = config.name;\r\n          console.info(`[]  : \"${config.name}\"`);\r\n        } else {\r\n          // 3.  displayName  name\r\n          const fuzzyMatch = allWorldbookNames.find(\r\n            name =>\r\n              name.includes(config.displayName) ||\r\n              config.displayName.includes(name) ||\r\n              name.includes(config.name) ||\r\n              config.name.includes(name),\r\n          );\r\n          if (fuzzyMatch) {\r\n            targetWorldbookName = fuzzyMatch;\r\n            console.info(`[]  : \"${fuzzyMatch}\"`);\r\n          }\r\n        }\r\n\r\n        if (!targetWorldbookName) {\r\n          const availableBooks = allWorldbookNames.join(', ');\r\n          //  CORS \r\n          throw new Error(\r\n            `: ${config.displayName} (${bookName})\\n` +\r\n              `: ${availableBooks}\\n` +\r\n              `:  displayName  name `,\r\n          );\r\n        }\r\n\r\n        // \r\n        //  CORS \r\n\r\n        let entries;\r\n        let worldbookData: unknown;\r\n        try {\r\n          worldbookData = await getWorldbook(targetWorldbookName);\r\n          //  CORS \r\n\r\n          // getWorldbook  entries \r\n          //   entries Array.prototype.entries \r\n          if (Array.isArray(worldbookData)) {\r\n            // getWorldbook \r\n            entries = worldbookData;\r\n          } else if (\r\n            worldbookData &&\r\n            typeof worldbookData === 'object' &&\r\n            !Array.isArray(worldbookData) &&\r\n            'entries' in worldbookData &&\r\n            Array.isArray((worldbookData as { entries?: unknown }).entries)\r\n          ) {\r\n            // getWorldbook  entries \r\n            entries = (worldbookData as { entries: unknown[] }).entries;\r\n          } else {\r\n            // \r\n            entries = Array.isArray(worldbookData) ? worldbookData : [];\r\n          }\r\n\r\n          //  CORS \r\n        } catch (getWorldbookError) {\r\n          //  CORS \r\n\r\n          // \r\n          const errorMessage =\r\n            getWorldbookError instanceof Error ? getWorldbookError.message : String(getWorldbookError);\r\n          console.warn(\r\n            `[]  ${config.displayName}  (: ${targetWorldbookName}):`,\r\n            errorMessage,\r\n          );\r\n\r\n          //  map \r\n          const isDataFormatError =\r\n            errorMessage.includes('map') ||\r\n            errorMessage.includes('undefined') ||\r\n            errorMessage.includes('Cannot read properties');\r\n\r\n          if (isDataFormatError) {\r\n            console.warn(\r\n              `[]   \"${targetWorldbookName}\" `,\r\n            );\r\n            console.warn(`[]  : ${errorMessage}`);\r\n            console.warn(\r\n              `[]  : 1)  \"${targetWorldbookName}\"  2)  3) `,\r\n            );\r\n\r\n            // \r\n            if (this.failedBooks) {\r\n              this.failedBooks.add(bookName);\r\n              console.warn(`[]   \"${bookName}\" `);\r\n              //  CORS \r\n            }\r\n          }\r\n\r\n          // \r\n          const detailedError = new Error(\r\n            `: ${errorMessage}\\n` +\r\n              `: ${targetWorldbookName}\\n` +\r\n              `: ${bookName} (${config.displayName})\\n` +\r\n              `: ${isDataFormatError ? '' : ''}\\n` +\r\n              `: ${isDataFormatError ? '' : ''}`,\r\n          );\r\n          throw detailedError;\r\n        }\r\n\r\n        // \r\n        if (entries === undefined || entries === null) {\r\n          //  CORS \r\n          throw new Error(\r\n            ` \"${targetWorldbookName}\"  (undefined/null)\\n` +\r\n              `: ${typeof worldbookData}\\n` +\r\n              `:  entries `,\r\n          );\r\n        }\r\n\r\n        if (!Array.isArray(entries)) {\r\n          //  CORS \r\n          throw new Error(\r\n            ` \"${targetWorldbookName}\"  (: ${typeof entries})\\n` +\r\n              `: ${typeof worldbookData}\\n` +\r\n              `: getWorldbook  entries  entries `,\r\n          );\r\n        }\r\n\r\n        if (entries.length === 0) {\r\n          throw new Error('');\r\n        }\r\n\r\n        // \r\n        const charWorldbooks = getCharWorldbookNames('current');\r\n        if (!charWorldbooks.additional.includes(targetWorldbookName)) {\r\n          await rebindCharWorldbooks('current', {\r\n            primary: charWorldbooks.primary,\r\n            additional: [...charWorldbooks.additional, targetWorldbookName],\r\n          });\r\n          console.info(`[]  : ${targetWorldbookName}`);\r\n        }\r\n\r\n        console.info(`[]  ${config.displayName}  (${entries.length} )`);\r\n\r\n        return {\r\n          name: bookName,\r\n          displayName: config.displayName,\r\n          entries: entries,\r\n          fallback: false,\r\n          loadedAt: Date.now(),\r\n        };\r\n      } catch (error) {\r\n        const errorMessage = error instanceof Error ? error.message : String(error);\r\n        console.warn(`[]  ${config.displayName} :`, errorMessage);\r\n\r\n        // \r\n        if (config.fallbackEntries && config.fallbackEntries.length > 0) {\r\n          console.info(`[]  ${config.displayName}  (${config.fallbackEntries.length} )`);\r\n          this.fallbackMode = true;\r\n\r\n          return {\r\n            name: bookName,\r\n            displayName: config.displayName,\r\n            entries: config.fallbackEntries,\r\n            fallback: true,\r\n            error: errorMessage,\r\n            loadedAt: Date.now(),\r\n          };\r\n        }\r\n\r\n        throw error;\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async predictiveCache(context: string): Promise<void> {\r\n      if (!context || typeof context !== 'string') {\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      const predictions: Array<{ bookName: string; score: number; priority: number; weightedScore: number }> = [];\r\n\r\n      for (const bookName in WORLDBOOKS) {\r\n        const config = WORLDBOOKS[bookName];\r\n\r\n        if (this.loaded.has(bookName)) {\r\n          continue;\r\n        }\r\n\r\n        let matchScore = 0;\r\n        let weightedScore = 0;\r\n\r\n        // \r\n        for (const keyword of config.keywords) {\r\n          if (context.includes(keyword)) {\r\n            matchScore++;\r\n            // \r\n            const keywordWeight = keyword.length >= 3 ? 2 : 1;\r\n            weightedScore += keywordWeight;\r\n\r\n            // \r\n            if (config.description && config.description.includes(keyword)) {\r\n              weightedScore += 1;\r\n            }\r\n          }\r\n        }\r\n\r\n        // \r\n        if (config.description) {\r\n          const descKeywords = config.description.match(/[\\u4e00-\\u9fa5]{2,}/g) || [];\r\n          for (const descKw of descKeywords) {\r\n            if (context.includes(descKw) && descKw.length >= 2) {\r\n              weightedScore += 0.5;\r\n            }\r\n          }\r\n        }\r\n\r\n        if (matchScore > 0) {\r\n          //  =  * 10 + \r\n          const finalScore = config.priority * 10 + weightedScore;\r\n\r\n          predictions.push({\r\n            bookName,\r\n            score: matchScore,\r\n            priority: config.priority,\r\n            weightedScore: finalScore,\r\n          });\r\n        }\r\n      }\r\n\r\n      // \r\n      predictions.sort((a, b) => {\r\n        if (Math.abs(b.weightedScore - a.weightedScore) > 1) {\r\n          return b.weightedScore - a.weightedScore;\r\n        }\r\n        if (b.priority !== a.priority) {\r\n          return b.priority - a.priority;\r\n        }\r\n        return b.score - a.score;\r\n      });\r\n\r\n      console.info(`[]  ${predictions.length} `);\r\n\r\n      // 1>10\r\n      const toLoad = predictions.filter(p => p.weightedScore > 10).slice(0, 3);\r\n\r\n      if (toLoad.length === 0) {\r\n        console.info('[] ');\r\n        return;\r\n      }\r\n\r\n      for (const pred of toLoad) {\r\n        // \r\n        if (this.failedBooks?.has(pred.bookName)) {\r\n          console.debug(`[] : ${WORLDBOOKS[pred.bookName].displayName}`);\r\n          continue;\r\n        }\r\n\r\n        console.info(\r\n          `[] : ${WORLDBOOKS[pred.bookName].displayName} ` +\r\n            `(: ${pred.score}, : ${pred.weightedScore.toFixed(1)})`,\r\n        );\r\n\r\n        try {\r\n          await this.loadWorldbook(pred.bookName);\r\n        } catch (error) {\r\n          const errorMessage = error instanceof Error ? error.message : String(error);\r\n          console.warn(`[] : ${pred.bookName}`, errorMessage);\r\n          //  loadWorldbook \r\n        }\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    getRelevantEntries(context: string, maxEntries: number = 5): unknown[] {\r\n      if (!context || typeof context !== 'string') {\r\n        return [];\r\n      }\r\n\r\n      const allEntries: Array<{ entry: unknown; bookName: string; bookDisplayName: string; priority: number }> = [];\r\n\r\n      this.loaded.forEach((bookData, bookName) => {\r\n        if (bookData.entries && Array.isArray(bookData.entries)) {\r\n          for (const entry of bookData.entries) {\r\n            allEntries.push({\r\n              entry,\r\n              bookName: bookName,\r\n              bookDisplayName: bookData.displayName,\r\n              priority: WORLDBOOKS[bookName]?.priority || 0,\r\n            });\r\n          }\r\n        }\r\n      });\r\n\r\n      const scoredEntries = allEntries.map(item => {\r\n        let score = 0;\r\n        const entry = item.entry as {\r\n          keys?: string[];\r\n          key?: string[];\r\n          constant?: boolean;\r\n          name?: string;\r\n          content?: string;\r\n        };\r\n        const keys = entry.keys || entry.key || [];\r\n\r\n        // \r\n        for (const key of keys) {\r\n          if (context.includes(key)) {\r\n            const keyWeight = key.length >= 3 ? 15 : 10;\r\n            score += keyWeight;\r\n\r\n            // \r\n            if (entry.name && entry.name.includes(key)) {\r\n              score += 5;\r\n            }\r\n          }\r\n        }\r\n\r\n        // \r\n        if (entry.name && context.includes(entry.name)) {\r\n          score += 20;\r\n        }\r\n\r\n        // \r\n        if (entry.content) {\r\n          const contentMatch = entry.content.substring(0, 100);\r\n          if (context.includes(contentMatch.substring(0, 10))) {\r\n            score += 3;\r\n          }\r\n        }\r\n\r\n        // \r\n        score += item.priority || 0;\r\n\r\n        // \r\n        if (entry.constant) {\r\n          score += 30;\r\n        }\r\n\r\n        return {\r\n          entry: item.entry,\r\n          score,\r\n          bookName: item.bookName,\r\n          bookDisplayName: item.bookDisplayName,\r\n        };\r\n      });\r\n\r\n      // \r\n      scoredEntries.sort((a, b) => {\r\n        if (Math.abs(b.score - a.score) > 5) {\r\n          return b.score - a.score;\r\n        }\r\n        // \r\n        const aPriority = WORLDBOOKS[a.bookName]?.priority || 0;\r\n        const bPriority = WORLDBOOKS[b.bookName]?.priority || 0;\r\n        return bPriority - aPriority;\r\n      });\r\n\r\n      const relevant = scoredEntries\r\n        .filter(item => item.score > 0)\r\n        .slice(0, maxEntries)\r\n        .map(item => item.entry);\r\n\r\n      if (relevant.length > 0) {\r\n        console.info(\r\n          `[]  ${relevant.length}  ` +\r\n            `(: ${scoredEntries[0]?.score || 0}, : ${scoredEntries[0]?.bookDisplayName || ''})`,\r\n        );\r\n      }\r\n\r\n      return relevant;\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async dynamicLoad(userInput: string): Promise<void> {\r\n      if (!userInput || typeof userInput !== 'string' || userInput.length < 3) {\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      const triggers: Array<{\r\n        bookName: string;\r\n        keyword: string;\r\n        priority: number;\r\n        matchCount: number;\r\n        score: number;\r\n      }> = [];\r\n\r\n      for (const bookName in WORLDBOOKS) {\r\n        const config = WORLDBOOKS[bookName];\r\n\r\n        if (this.loaded.has(bookName)) {\r\n          continue;\r\n        }\r\n\r\n        let matchCount = 0;\r\n        let bestKeyword = '';\r\n        let maxKeywordLength = 0;\r\n\r\n        // \r\n        for (const keyword of config.keywords) {\r\n          if (userInput.includes(keyword)) {\r\n            matchCount++;\r\n            if (keyword.length > maxKeywordLength) {\r\n              maxKeywordLength = keyword.length;\r\n              bestKeyword = keyword;\r\n            }\r\n          }\r\n        }\r\n\r\n        // \r\n        if (matchCount > 0) {\r\n          //  =  * 10 +  * 2 + \r\n          const score = config.priority * 10 + matchCount * 2 + maxKeywordLength;\r\n\r\n          triggers.push({\r\n            bookName,\r\n            keyword: bestKeyword,\r\n            priority: config.priority,\r\n            matchCount,\r\n            score,\r\n          });\r\n        }\r\n      }\r\n\r\n      if (triggers.length === 0) {\r\n        console.info('[] ');\r\n        return;\r\n      }\r\n\r\n      // \r\n      triggers.sort((a, b) => {\r\n        if (Math.abs(b.score - a.score) > 2) {\r\n          return b.score - a.score;\r\n        }\r\n        return b.priority - a.priority;\r\n      });\r\n\r\n      console.info(`[]  ${triggers.length} `);\r\n\r\n      // 3\r\n      const toLoad = triggers.slice(0, 3);\r\n\r\n      for (const trigger of toLoad) {\r\n        console.info(\r\n          `[] : ${WORLDBOOKS[trigger.bookName].displayName} ` +\r\n            `(: ${trigger.keyword}, : ${trigger.matchCount}, : ${trigger.score})`,\r\n        );\r\n\r\n        try {\r\n          await this.loadWorldbook(trigger.bookName);\r\n        } catch (error) {\r\n          console.warn(`[] : ${trigger.bookName}`, error);\r\n        }\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    getStatus(): WorldbookStatus {\r\n      const status: WorldbookStatus = {\r\n        initialized: this.initialized,\r\n        fallbackMode: this.fallbackMode,\r\n        characterWorldbook: this.characterWorldbookId,\r\n        loaded: [],\r\n        loading: [],\r\n        available: [],\r\n      };\r\n\r\n      this.loaded.forEach((data, name) => {\r\n        status.loaded.push({\r\n          name: name,\r\n          displayName: data.displayName,\r\n          entries: data.entries.length,\r\n          fallback: data.fallback,\r\n          error: data.error,\r\n          loadedAt: new Date(data.loadedAt).toLocaleTimeString(),\r\n        });\r\n      });\r\n\r\n      this.loading.forEach((_promise, name) => {\r\n        status.loading.push({\r\n          name: name,\r\n          displayName: WORLDBOOKS[name]?.displayName || name,\r\n        });\r\n      });\r\n\r\n      for (const bookName in WORLDBOOKS) {\r\n        if (!this.loaded.has(bookName) && !this.loading.has(bookName)) {\r\n          status.available.push({\r\n            name: bookName,\r\n            displayName: WORLDBOOKS[bookName].displayName,\r\n            autoLoad: WORLDBOOKS[bookName].autoLoad,\r\n          });\r\n        }\r\n      }\r\n\r\n      return status;\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async unloadWorldbook(bookName: string): Promise<void> {\r\n      if (!this.loaded.has(bookName)) {\r\n        console.warn(`[] ${bookName} `);\r\n        return;\r\n      }\r\n\r\n      console.info(`[] : ${WORLDBOOKS[bookName]?.displayName || bookName}`);\r\n\r\n      // \r\n      const charWorldbooks = getCharWorldbookNames('current');\r\n      const loadedData = this.loaded.get(bookName);\r\n      if (loadedData) {\r\n        // \r\n        const allWorldbookNames = safeGetWorldbookNames();\r\n        const targetName = allWorldbookNames.find(name => name === bookName || name.includes(bookName));\r\n\r\n        if (targetName) {\r\n          const newAdditional = charWorldbooks.additional.filter(name => name !== targetName);\r\n          await rebindCharWorldbooks('current', {\r\n            primary: charWorldbooks.primary,\r\n            additional: newAdditional,\r\n          });\r\n        }\r\n      }\r\n\r\n      this.loaded.delete(bookName);\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async reloadWorldbook(bookName: string): Promise<LoadedWorldbook> {\r\n      console.info(`[] : ${WORLDBOOKS[bookName]?.displayName || bookName}`);\r\n      await this.unloadWorldbook(bookName);\r\n      return await this.loadWorldbook(bookName);\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async initialize(): Promise<void> {\r\n      if (this.initialized) {\r\n        console.info('[] ');\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      await this.findCharacterWorldbook();\r\n\r\n      // \r\n      let retries = 0;\r\n      let availableWorldbooks: string[] = [];\r\n      while (retries < 40) {\r\n        try {\r\n          availableWorldbooks = safeGetWorldbookNames();\r\n          if (availableWorldbooks.length > 0) {\r\n            console.info(`[]   (${availableWorldbooks.length} )`);\r\n            console.info(`[] : ${availableWorldbooks.join(', ')}`);\r\n            break;\r\n          }\r\n        } catch (error) {\r\n          // \r\n        }\r\n\r\n        console.info(`[] ... (${retries + 1}/40)`);\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n        retries++;\r\n      }\r\n\r\n      // \r\n      console.info('[] :');\r\n      for (const bookName in WORLDBOOKS) {\r\n        const config = WORLDBOOKS[bookName];\r\n        const isAvailable = availableWorldbooks.some(\r\n          name => name === config.displayName || name === config.name || name.includes(config.displayName),\r\n        );\r\n        console.info(\r\n          `  - ${config.displayName} (${bookName}): ` +\r\n            `=${config.priority}, ` +\r\n            `=${config.autoLoad ? '' : ''}, ` +\r\n            `=${isAvailable ? '' : ''}`,\r\n        );\r\n      }\r\n\r\n      // \r\n      const autoLoadBooks: string[] = [];\r\n      for (const bookName in WORLDBOOKS) {\r\n        if (WORLDBOOKS[bookName].autoLoad) {\r\n          autoLoadBooks.push(bookName);\r\n        }\r\n      }\r\n\r\n      console.info(`[]  ${autoLoadBooks.length} `);\r\n\r\n      for (const bookName of autoLoadBooks) {\r\n        try {\r\n          await this.loadWorldbook(bookName);\r\n        } catch (err) {\r\n          console.warn(`[] : ${bookName}`, err);\r\n        }\r\n      }\r\n\r\n      this.initialized = true;\r\n\r\n      const status = this.getStatus();\r\n      console.info('[]  ');\r\n      console.table(status.loaded);\r\n\r\n      // \r\n      if (this.fallbackMode) {\r\n        console.warn('[]  ');\r\n        console.warn('[]  ');\r\n        console.warn('[]  ');\r\n\r\n        const fallbackBooks = status.loaded.filter(b => b.fallback);\r\n        console.table(fallbackBooks);\r\n\r\n        // 3\r\n        setTimeout(() => {\r\n          console.info('[] ...');\r\n          this.shutdown();\r\n        }, 3000);\r\n      } else {\r\n        console.info('[]  ');\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    shutdown(): void {\r\n      console.info('[] ...');\r\n\r\n      // \r\n      this.loaded.clear();\r\n      this.loading.clear();\r\n\r\n      // \r\n      delete (DS as DetentionSystem & { loadWorldbook?: unknown }).loadWorldbook;\r\n      delete (DS as DetentionSystem & { unloadWorldbook?: unknown }).unloadWorldbook;\r\n      delete (DS as DetentionSystem & { reloadWorldbook?: unknown }).reloadWorldbook;\r\n      delete (DS as DetentionSystem & { predictiveCache?: unknown }).predictiveCache;\r\n      delete (DS as DetentionSystem & { getRelevantEntries?: unknown }).getRelevantEntries;\r\n      delete (DS as DetentionSystem & { getWorldbookStatus?: unknown }).getWorldbookStatus;\r\n      delete (DS as DetentionSystem & { dynamicLoad?: unknown }).dynamicLoad;\r\n\r\n      this.initialized = false;\r\n      this.fallbackMode = false;\r\n\r\n      console.info('[]  ');\r\n      console.info('[] ');\r\n    },\r\n  };\r\n\r\n  // ==========  ==========\r\n  (\r\n    DS as DetentionSystem & {\r\n      loadWorldbook?: (bookName: string) => Promise<LoadedWorldbook>;\r\n      unloadWorldbook?: (bookName: string) => Promise<void>;\r\n      reloadWorldbook?: (bookName: string) => Promise<LoadedWorldbook>;\r\n      predictiveCache?: (context: string) => Promise<void>;\r\n      dynamicLoad?: (userInput: string) => Promise<void>;\r\n      getRelevantEntries?: (context: string, max?: number) => unknown[];\r\n      getWorldbookStatus?: () => WorldbookStatus;\r\n    }\r\n  ).loadWorldbook = (bookName: string) => WorldbookLoader.loadWorldbook(bookName);\r\n  (DS as DetentionSystem & { unloadWorldbook?: (bookName: string) => Promise<void> }).unloadWorldbook = (\r\n    bookName: string,\r\n  ) => WorldbookLoader.unloadWorldbook(bookName);\r\n  (DS as DetentionSystem & { reloadWorldbook?: (bookName: string) => Promise<LoadedWorldbook> }).reloadWorldbook = (\r\n    bookName: string,\r\n  ) => WorldbookLoader.reloadWorldbook(bookName);\r\n  (DS as DetentionSystem & { predictiveCache?: (context: string) => Promise<void> }).predictiveCache = (\r\n    context: string,\r\n  ) => WorldbookLoader.predictiveCache(context);\r\n  (DS as DetentionSystem & { dynamicLoad?: (userInput: string) => Promise<void> }).dynamicLoad = (userInput: string) =>\r\n    WorldbookLoader.dynamicLoad(userInput);\r\n  (DS as DetentionSystem & { getRelevantEntries?: (context: string, max?: number) => unknown[] }).getRelevantEntries = (\r\n    context: string,\r\n    max?: number,\r\n  ) => WorldbookLoader.getRelevantEntries(context, max);\r\n  (DS as DetentionSystem & { getWorldbookStatus?: () => WorldbookStatus }).getWorldbookStatus = () =>\r\n    WorldbookLoader.getStatus();\r\n\r\n  DS.registerModule('worldbook', WorldbookLoader);\r\n\r\n  // iframe \r\n  try {\r\n    if (window.parent && window.parent !== window) {\r\n      (window.parent as any).detentionSystem = DS;\r\n      console.info('[]  ');\r\n    }\r\n  } catch (e) {\r\n    // \r\n  }\r\n\r\n  console.info('[]  ');\r\n\r\n  // ==========  ==========\r\n  DS.events.on('event_triggered', (eventData?: unknown) => {\r\n    const event = eventData as { id?: string; description?: string } | undefined;\r\n    if (event?.description) {\r\n      WorldbookLoader.predictiveCache(event.description).catch(err => {\r\n        console.warn('[] :', err);\r\n      });\r\n    }\r\n  });\r\n\r\n  // ==========  ==========\r\n  DS.events.on('user_input', (data?: unknown) => {\r\n    const input = data as { text?: string } | undefined;\r\n    if (input?.text && input.text.length > 5) {\r\n      WorldbookLoader.dynamicLoad(input.text).catch(err => {\r\n        console.warn('[] :', err);\r\n      });\r\n    }\r\n  });\r\n\r\n  // ==========  ==========\r\n  $(() => {\r\n    console.info('[] ...');\r\n\r\n    // 2\r\n    setTimeout(async () => {\r\n      console.info('[] ...');\r\n\r\n      try {\r\n        await WorldbookLoader.initialize();\r\n        console.info('[]  ');\r\n      } catch (error) {\r\n        console.error('[]  :', error);\r\n        console.info('[]  : window.initWorldbookLoader()');\r\n      }\r\n    }, 2000);\r\n  });\r\n\r\n  // ==========  ==========\r\n  (window as typeof window & { initWorldbookLoader?: () => Promise<WorldbookStatus> }).initWorldbookLoader =\r\n    async function () {\r\n      console.info('[] ...');\r\n\r\n      if (WorldbookLoader.initialized) {\r\n        console.info('[] ');\r\n        return WorldbookLoader.getStatus();\r\n      }\r\n\r\n      try {\r\n        await WorldbookLoader.initialize();\r\n        console.info('[]  ');\r\n        return WorldbookLoader.getStatus();\r\n      } catch (error) {\r\n        console.error('[]  :', error);\r\n        throw error;\r\n      }\r\n    };\r\n\r\n  console.info('[]  ');\r\n  console.info('[]  : window.initWorldbookLoader()');\r\n});\r\n","/**\r\n *  - \r\n * NPC\r\n *\r\n * \r\n * 1.  (core.ts) - \r\n * 2.  (status_panel.ts) - HTML\r\n * 3.  (event_system.ts) - \r\n * 4. NPC (npc_system.ts) - NPC\r\n * 5.  (worldbook_loader.ts) - \r\n */\r\n\r\n//  CORS \r\n\r\n// \r\nconsole.info(' [] ');\r\n// \r\n(window as any).__DETENTION_SYSTEM_LOADED__ = true;\r\n(window as any).__DETENTION_SYSTEM_LOADED_TIMESTAMP__ = Date.now();\r\nconsole.log('[DEBUG-HYP-A] index.ts:13 - ', {\r\n  timestamp: Date.now(),\r\n  windowExists: typeof window !== 'undefined',\r\n  windowDetentionSystem: typeof window.detentionSystem,\r\n  location: 'index.ts:13',\r\n  hypothesisId: 'A',\r\n});\r\nconsole.info('[] ...');\r\nconsole.info('[] ');\r\n\r\n//  CORS \r\n\r\n// \r\nimport './core';\r\nimport './event_system';\r\nimport './npc_system';\r\nimport './status_panel';\r\nimport './worldbook_loader';\r\n\r\n//  CORS \r\n\r\nconsole.log('[DEBUG-HYP-A] index.ts:22 - ', {\r\n  timestamp: Date.now(),\r\n  windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\r\n  windowDetentionSystemType: typeof window.detentionSystem,\r\n  windowDetentionSystemValue: window.detentionSystem ? 'object' : 'undefined',\r\n  location: 'index.ts:22',\r\n  hypothesisId: 'A',\r\n});\r\nconsole.info('[] ');\r\nconsole.log(' [] ');\r\nconsole.log(' window.detentionSystem:', typeof window.detentionSystem !== 'undefined' ? ' ' : ' ');\r\n"],"names":["console","info","EventEmitter","events","Map","on","event","callback","this","has","set","get","push","off","callbacks","index","indexOf","splice","emit","data","forEach","cb","error","once","wrapper","cacheStore","cacheCleanupTimer","bootstrapDetentionSystem","system","version","initialized","modules","config","tokenBudget","fallbackBudget","compressionQuality","cacheExpiry","healthCheckInterval","healthCheckTimeout","state","mode","tokenUsed","lastHealthCheck","errors","CacheManager","key","value","ttl","expiry","Date","now","item","delete","clear","cleanup","entries","ping","checkTokenBudget","total","used","percentage","status","toFixed","remaining","updateTokenUsage","tokens","budget","warn","compressContent","content","quality","text","JSON","stringify","actualQuality","compressed","replace","trim","originalSize","length","compressedSize","ratio","registerModule","name","module","window","parent","detentionSystem","DS","e","getModule","handleError","context","normalized","Error","normalizeError","errorInfo","message","timestamp","stack","shift","detectEnvironment","env","isSillyTavern","hasHelper","helperVersion","hasDataTable","SillyTavern","$","getTavernVersion","getTavernHelperVersion","windowWithTable","insertRow","updateRow","initialize","initializeState","__DETENTION_SYSTEM_CORE_LOADED__","__DETENTION_SYSTEM_VERSION__","debug","exists","setInterval","ensureCacheCleanup","setTimeout","clearInterval","undefined","skipMessageId","skipCommandMessages","Set","eventMakeFirst","tavern_events","USER_MESSAGE_RENDERED","async","message_id","userMessage","getChatMessages","role","userInput","messageData","isSystemEventMessage","isSystemByContent","startsWith","includes","waitingForEventResponse","stopAllGeneration","skipDayPattern","match","setChatMessages","is_hidden","refresh","add","eventOn","GENERATE_BEFORE_COMBINE_PROMPTS","size","messages","lastUserMessage","lastTriggerTime","lastTriggerEventName","generationTracking","iframe_events","GENERATION_STARTED","generation_id","stopGenerationById","then","success","type","options","dry_run","aiMessageTracking","CHARACTER_MESSAGE_RENDERED","aiMessage","messageText","some","m","triggerTime","eventName","messageLength","messagePreview","substring","relatedMessages","filter","timeGaps","sort","a","b","map","i","arr","gap","messageIds","lengths","totalLength","reduce","sum","recentMessages","Math","abs","id","timeDiff","MESSAGE_SENT","find","Number","protagonistPattern","DS_PROTAGONIST","npcSystem","generateProtagonist","crimeType","excludeCrimes","background","isIntellectual","isAcademic","isBusiness","ageRange","education","protagonistData","getCurrentChatId","protagonistInfo","age","crime","appearance","height","weight","hair","skin","features","personality","replaceVariables","protagonist","protagonist_name","protagonist_age","protagonist_crime","skipDayMatch","DS_CHECK","advanceDay","daysToSkip","numStr","parsed","parseInt","isNaN","chineseDigits","result","rest","slice","endsWith","prefix","shiIndex","before","after","parseNumber","waitForGenerationToStop","Promise","resolve","resolved","eventReturn","stop","eventOnce","GENERATION_ENDED","clearTimeout","timeout","builtin","duringGenerating","finalCheckCount","stopError","existingMessage","hideError","worldbookLoader","loadWorldbook","all","catch","err","loadError","interrupted","eventDay","day","tempCurrentDay","currentDay","pendingDays","eventSystem","confirmDayAdvancement","finalDay","createChatMessages","createError","DS_EMIT","DS_EVENT","eventData","eventPriority","priority","eventText","description","npcInfoText","eventId","generateNPCForEvent","eventNPC","npc","rank","relation","sceneData","policeDesc","police","witnesses","w","join","npcError","eventSystemModule","targetCellType","to","cellType","generateNPC","setCurrentCellNPCs","npcCount","floor","random","newNPCs","Array","isArray","cellBoss","max","relationship","influence","otherNPCs","cellBossName","Boolean","cellNPCError","eventCategory","category","getCurrentCellNPCs","cellNPCs","initialNPCCount","initialNPCs","npcNames","min","createPromise","eventMessageId","getLastMessageId","generationStartedReturn","generationEndedReceived","generationStartedCount","waitForGenerationToComplete","timeoutHandle","forceStopAttempts","messagesBeforeTrigger","lastAssistantMessage","allMessages","assistantMessages","lastAssistant","lastAssistantMessageId","lastAssistantMessageLength","lastAssistantMessagePreview","triggerSlash","generationEndHandler","messageIdMatched","messageEndContent","messageEndLength","messageEnd","message5Content","message5Length","message5Preview","message5","message5ContainsEventContent","message5ContainsSystemEvent","contentUpdatedToMessage5","allAssistantMessages","msg","tracked","t","actualMessageId","expectedMessageId","relatedMessagesCount","generationEndMessageId","trackedMessageIds","allTrackedMessages","relatedMessageIds","eventWithPending","pendingDayAdvancement","saveStateToChatVars","saveEventInterruptSnapshot","generationStoppedHandler","GENERATION_STOPPED","rollbackToInterruptSnapshot","toLocaleTimeString","systemCheck","hasPing","pingResult","hasInitializeState","hasModules","modulesCount","Object","keys","isIframe","hasParent","parentHasDetentionSystem","parentHasDS","DS_RAW","saveStateTimer","getCurrentDayFromMemoryEnhancement","fallback","statusPanel","getState","days","EventSystem","getCurrentDayInternal","lastEventDay","eventHistory","legalTimeline","arrestDay","approvalDay","prosecutionDay","firstTrialDay","firstVerdictDay","secondTrialDay","finalVerdictDay","transferDay","executionDay","currentStage","caseComplexity","complexityMultiplier","eventCounters","interrogation","prosecutor_interrogation","lawyer_visit","family_visit","medical_visit","scene_identification","isDeathPenalty","lastStageChangeDay","assignedOfficers","prosecutor","PRIORITY","LEGAL","PROCEDURAL","CONDITION","RANDOM","DAILY","legalEvents","approval","minDay","maxDay","stage","nextStage","investigation","duration","prosecution","firstTrial","firstVerdict","appeal","secondTrial","finalVerdict","transfer","deathReview","execution","conditionEvents","condition","mental","checkAlways","health","_state","stageChangeOnly","daysInCustody","minDays","maxDays","remainingDays","requiredTriggers","forcedProbability","daysSinceApproval","baseProbability","finalProbability","pow","daysToTrial","daysToTrial2","lastVisit","probability","lastMedical","recentContext","getRecentContext","kw","aiControlled","randomEvents","violence","medical","emotional","accident","innerMonologues","startDay","chatVars","getVariables","getVarsError","savedData","detentionSystemState","savedPolice","policeArray","stateData","truncatedStateData","testChatVars","testError","updateVariablesWith","variables","setCaseComplexity","complexity","validComplexities","simple","normal","complex","very_complex","multiplier","checkComplexityAdjustment","rollbackToStage","targetStage","reason","stageOrder","targetIndex","currentIndex","timelineKeys","trial1","trial2","from","advanceToStage","handleUserRollback","input","rollbackPatterns","pattern","rule","daysToAdvance","originalCurrentDay","dayEvent","checkDayEvents","prototype","hasOwnProperty","call","interruptedEvent","currentDate","month","getMonth","getDate","checkCellTransfer","cellTypeNames","transition","pretrial","convicted","legalEvent","checkLegalEvent","conditionEvent","checkConditionEvent","policeNames","prosecutorNames","usedNames","availableNames","selectedName","hasApproval","beforeFirstTrial","isInvestigationOrProsecution","shouldInterrupt","randomEvent","generateRandomEvent","monologue","generateInnerMonologue","stageBefore","daysSinceProsecution","daysSinceTrial","daysSinceAppeal","daysSinceVerdict","isEnding","endingType","getProtagonistState","types","eventType","weightedRandom","eventList","eventWeights","weights","count","totalWeight","log","strength","intelligence","chat","mes","setDeathPenalty","getCurrentStageInfo","cellTypeChinese","cellTypeRaw","timeline","getEventStatistics","stats","totalEvents","byType","byPriority","recentEvents","exportTimeline","importTimeline","snapshot","snapshotTime","detentionSystemInterruptSnapshot","updateError","oldDay","newDay","modifyValue","_context","getCurrentDay","getCurrentStage","NameGenerator","surnames","tier1","names","tier2","tier3","tier4","tier5","givenNames","vintage","single","double","classic","modern","contemporary","badNames","badChars","generate","birthYear","attempts","fullName","selectSurname","selectGivenName","isValidName","tiers","values","tier","getFullYear","style","styleData","pair","char","CrimeGenerator","characterBookCrimes","crimes","violent","sentenceRange","property","drug","economic","social","other","findCategoryByCrime","sentence","generateSentence","categories","cat","crimeName","range","__DETENTION_SYSTEM_LOADED__","__NPC_SYSTEM_LOADING__","NPCGenerator","npcDatabase","currentCellNPCs","npcs","generateSingle","stageInfo","generateAge","crimeData","generateAppearance","generatePersonality","generateBackground","generateRelationship","adjustByCellType","generateId","gender","createdAt","heights","hairStyles","skinTones","eyes","traits","aggression","sociability","dominance","kindness","tags","_crimeData","educations","educationIndex","maritalStatuses","maritalWeights","maritalIndex","hasChildren","childrenCount","maritalStatus","hometown","generateHometown","priorConvictions","provinces","toProtagonist","faction","allies","enemies","toString","generateForEvent","generatePolice","generateLawyer","generateFamily","generateDoctor","ranks","attitude","isFemale","typeIndex","experience","successRate","relationships","supportLevel","specialties","specialty","categoryKey","filteredCrimes","c","profession","highEducations","mediumEducations","lowEducations","businessEducations","businessProfessions","intellectualProfessions","academicProfessions","addNPCToCell","removeNPCFromCell","npcId","findIndex","n","findNPCById","updateRelationship","delta","npcName","exportData","database","currentCell","importData","clearData","findNPC","updateNPCRelationship","exportNPCData","importNPCData","parentWindow","parentDS","verification","hasGenerateNPC","hasGenerateNPCForEvent","hasGenerateProtagonist","hasGetCurrentCellNPCs","hasSetCurrentCellNPCs","hasNPCSystemModule","newCellType","__NPC_SYSTEM_LOADED__","__NPC_SYSTEM_LOADED_TIMESTAMP__","Vue","CONFIG","updateInterval","animationDuration","trendWindow","slowChangeThreshold","regressionRate","healthBaseline","mentalBaseline","parseRetryAttempts","parseRetryDelay","debugMode","clothing","top","bottom","underwear","underpants","socks","shoes","restraints","cleanliness","currentTask","currentThought","biggestWorry","changes","accumulated","lastUpdate","totalUpdates","successfulParses","failedParses","lastParseTime","isUpdating","mutationObserver","updateLoopInterval","debugLog","args","formatDuration","ms","seconds","minutes","hours","recordChange","calculateTrend","acc","change","syncStateToMemoryEnhancement","checkError","plugin","detectMemoryEnhancementPlugin","updateState","setState","updateDisplay","parseCommentNode","node","nodeType","Node","COMMENT_NODE","nodeValue","textContent","jsonStr","parseStatusUpdate","attempt","parse","errorMessage","String","checkForStatusUpdate","element","ELEMENT_NODE","walker","document","createTreeWalker","NodeFilter","SHOW_COMMENT","nextNode","getStateFromMemoryEnhancement","stopCommentListener","disconnect","stopUpdateLoop","memoryEnhancement","stMemoryEnhancement","MemoryEnhancement","MemoryEnhancementPlugin","memoryEnhancementPlugin","ext_getAllTables","ext_exportAllTablesAsJson","memoryState","messageVars","possiblePaths","path","candidate","searchInVars","vars","foundInChat","foundInMessage","jsonData","tables","possibleTableNames","targetTable","table","toLowerCase","header","h","firstDataRow","stateObj","colName","normalizedName","numValue","parseFloat","finalValue","jsonError","allTables","extError","cell_type","StatusPanel","MutationObserver","mutations","mutation","addedNodes","target","observe","body","childList","subtree","characterData","characterDataOldValue","d","destroy","oldValue","newValue","getTrendAnalysis","trend","reset","scanAllComments","comments","fullContent","isStatusUpdate","getDiagnostics","diagnostics","toLocaleString","observer","active","timeSinceUpdate","timeSinceUpdateFormatted","currentState","WORLDBOOKS","detention_rules","displayName","keywords","autoLoad","position","depth","fallbackEntries","internal_basic_procedures","internal_basic_legal","legal_knowledge","environment_descriptions","narrative_enhancements","safeGetWorldbookNames","getWorldbookNames","TavernHelper","helper","characterId","WorldbookLoader","loaded","loading","fallbackMode","characterWorldbookId","failedBooks","findCharacterWorldbook","charWorldbooks","getCharWorldbookNames","primary","additional","bookName","loadPromise","_loadWorldbookInternal","allWorldbookNames","targetWorldbookName","exactDisplayMatch","fuzzyMatch","availableBooks","worldbookData","getWorldbook","getWorldbookError","isDataFormatError","rebindCharWorldbooks","loadedAt","predictiveCache","predictions","matchScore","weightedScore","keyword","descKeywords","descKw","finalScore","score","toLoad","p","pred","getRelevantEntries","maxEntries","allEntries","bookData","entry","bookDisplayName","scoredEntries","contentMatch","constant","aPriority","relevant","dynamicLoad","triggers","matchCount","bestKeyword","maxKeywordLength","trigger","getStatus","characterWorldbook","available","_promise","unloadWorldbook","targetName","newAdditional","reloadWorldbook","retries","availableWorldbooks","isAvailable","autoLoadBooks","fallbackBooks","shutdown","getWorldbookStatus","initWorldbookLoader","__DETENTION_SYSTEM_LOADED_TIMESTAMP__","windowExists","windowDetentionSystem","location","hypothesisId","windowDetentionSystemExists","windowDetentionSystemType","windowDetentionSystemValue"],"ignoreList":[],"sourceRoot":""}