{"version":3,"file":"detention-system.js","mappings":"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,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,IAEnBE,qBAAsB,CACpBv0B,KAAM,uBACNg0B,YAAa,QACbpmB,YACE,+DACFF,SAAU,EACVumB,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,KACA,KACA,KACA,OACA,OACA,QACA,MACA,OACA,MACA,KACA,KACA,MACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,cACVC,MAAO,EACPC,gBAAiB,IAEnBG,gBAAiB,CACfx0B,KAAM,kBACNg0B,YAAa,QACbpmB,YAAa,mBACbF,SAAU,EACVumB,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,OACA,OACA,OACA,OACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,QAEFC,UAAU,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,IAEnBI,yBAA0B,CACxBz0B,KAAM,2BACNg0B,YAAa,QACbpmB,YAAa,uCACbF,SAAU,EACVumB,SAAU,CACR,KACA,MACA,MACA,MACA,KACA,KACA,KACA,KACA,OACA,KACA,OACA,OACA,KACA,KACA,KACA,MACA,KACA,KACA,MACA,MACA,MACA,KACA,MAEFC,UAAU,EACVC,SAAU,cACVC,MAAO,EACPC,gBAAiB,IAEnBK,uBAAwB,CACtB10B,KAAM,yBACNg0B,YAAa,QACbpmB,YAAa,qBACbF,SAAU,EACVumB,SAAU,CACR,KACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,KACA,MACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAEFC,UAAU,EACVC,SAAU,aACVC,MAAO,EACPC,gBAAiB,KA8BrB,SAASM,IAyBP,GAvBA3M,MAAM,oEAAqE,CACzEC,OAAQ,OACRC,QAAS,CAAE,eAAgB,oBAC3BC,KAAM9oB,KAAKC,UAAU,CACnB/C,SAAU,4CACVuE,QAAS,YACTpF,KAAM,CACJk5B,iBAA0D,IAArC10B,OAAe20B,kBACpCC,gBAAmC,oBAAX50B,UAA6BA,OAAe6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","sources":["src://tavern_helper_template/src///core.ts","src://tavern_helper_template/src///event_system.ts","src://tavern_helper_template/src///npc_system.ts","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/src///status_panel.ts","src://tavern_helper_template/src///worldbook_loader.ts","src://tavern_helper_template/src///index.ts"],"sourcesContent":["export {};\r\n\r\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\r\ndeclare const $: JQueryStaticLike;\r\n\r\n//  CORS \r\n\r\nconsole.info('[] ...');\r\n\r\ntype BudgetStatus = 'critical' | 'warning' | 'normal';\r\n\r\ninterface BudgetInfo {\r\n  used: number;\r\n  total: number;\r\n  percentage: string;\r\n  remaining: number;\r\n  status: BudgetStatus;\r\n}\r\n\r\ninterface DetentionConfig {\r\n  tokenBudget: number;\r\n  fallbackBudget: number;\r\n  compressionQuality: number;\r\n  cacheExpiry: number;\r\n  healthCheckInterval: number;\r\n  healthCheckTimeout: number;\r\n}\r\n\r\ninterface DetentionErrorInfo {\r\n  message: string;\r\n  context: string;\r\n  timestamp: number;\r\n  stack?: string;\r\n}\r\n\r\ninterface DetentionState {\r\n  mode: 'detecting' | 'external' | 'fallback';\r\n  tokenUsed: number;\r\n  lastHealthCheck: number;\r\n  errors: DetentionErrorInfo[];\r\n}\r\n\r\ninterface CacheEntry<T> {\r\n  value: T;\r\n  expiry: number | null;\r\n}\r\n\r\ninterface CacheManager {\r\n  set<T>(key: string, value: T, ttl?: number | null): void;\r\n  get<T>(key: string): T | null;\r\n  has(key: string): boolean;\r\n  delete(key: string): void;\r\n  clear(): void;\r\n  cleanup(): void;\r\n}\r\n\r\ninterface EnvironmentInfo {\r\n  isSillyTavern: boolean;\r\n  version: string | null;\r\n  hasHelper: boolean;\r\n  helperVersion: string | null;\r\n  hasDataTable: boolean;\r\n}\r\n\r\nclass EventEmitter {\r\n  private readonly events = new Map<string, Array<(data?: unknown) => void>>();\r\n\r\n  on(event: string, callback: (data?: unknown) => void) {\r\n    if (!this.events.has(event)) {\r\n      this.events.set(event, []);\r\n    }\r\n    this.events.get(event)!.push(callback);\r\n  }\r\n\r\n  off(event: string, callback: (data?: unknown) => void) {\r\n    const callbacks = this.events.get(event);\r\n    if (!callbacks) return;\r\n    const index = callbacks.indexOf(callback);\r\n    if (index > -1) callbacks.splice(index, 1);\r\n  }\r\n\r\n  emit(event: string, data?: unknown) {\r\n    const callbacks = this.events.get(event);\r\n    if (!callbacks) return;\r\n    callbacks.forEach(cb => {\r\n      try {\r\n        cb(data);\r\n      } catch (error) {\r\n        console.error(`[]  ${event} :`, error);\r\n      }\r\n    });\r\n  }\r\n\r\n  once(event: string, callback: (data?: unknown) => void) {\r\n    const wrapper = (data?: unknown) => {\r\n      callback(data);\r\n      this.off(event, wrapper);\r\n    };\r\n    this.on(event, wrapper);\r\n  }\r\n}\r\n\r\ninterface DetentionSystem {\r\n  version: string;\r\n  initialized: boolean;\r\n  modules: Record<string, unknown>;\r\n  config: DetentionConfig;\r\n  state: DetentionState;\r\n  events: EventEmitter;\r\n  CacheManager: CacheManager;\r\n  EventEmitter: typeof EventEmitter;\r\n  ping(): boolean;\r\n  checkTokenBudget(): BudgetInfo;\r\n  updateTokenUsage(tokens: number): BudgetInfo;\r\n  compressContent(content: unknown, quality?: number | null): string;\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n  handleError(error: unknown, context?: string): void;\r\n  detectEnvironment(): EnvironmentInfo;\r\n  initialize(): void;\r\n  initializeState?(state: {\r\n    name?: string;\r\n    age?: number;\r\n    crime?: string;\r\n    health?: number;\r\n    mental?: number;\r\n    strength?: number;\r\n    intelligence?: number;\r\n    appearance?: {\r\n      height?: number;\r\n      weight?: number;\r\n      hair?: string;\r\n      condition?: string;\r\n    };\r\n    clothing?: {\r\n      top?: string;\r\n      bottom?: string;\r\n      underwear?: string;\r\n      underpants?: string;\r\n      socks?: string;\r\n      shoes?: string;\r\n      restraints?: string;\r\n      cleanliness?: string;\r\n    };\r\n    currentTask?: string;\r\n    currentThought?: string;\r\n    biggestWorry?: string;\r\n  }): void;\r\n}\r\n\r\ndeclare global {\r\n  interface Window {\r\n    detentionSystem?: DetentionSystem;\r\n  }\r\n}\r\n\r\nconst cacheStore: Map<string, CacheEntry<unknown>> = new Map();\r\nlet cacheCleanupTimer: ReturnType<typeof setInterval> | undefined;\r\n\r\nfunction createCacheManager(): CacheManager {\r\n  return {\r\n    set<T>(key: string, value: T, ttl?: number | null) {\r\n      const expiry = ttl ? Date.now() + ttl * 1000 : null;\r\n      cacheStore.set(key, { value, expiry });\r\n    },\r\n    get<T>(key: string) {\r\n      const item = cacheStore.get(key);\r\n      if (!item) return null;\r\n      if (item.expiry !== null && Date.now() > item.expiry) {\r\n        cacheStore.delete(key);\r\n        return null;\r\n      }\r\n      return item.value as T;\r\n    },\r\n    has(key: string) {\r\n      return this.get(key) !== null;\r\n    },\r\n    delete(key: string) {\r\n      cacheStore.delete(key);\r\n    },\r\n    clear() {\r\n      cacheStore.clear();\r\n    },\r\n    cleanup() {\r\n      const now = Date.now();\r\n      for (const [key, item] of cacheStore.entries()) {\r\n        if (item.expiry !== null && now > item.expiry) {\r\n          cacheStore.delete(key);\r\n        }\r\n      }\r\n    },\r\n  };\r\n}\r\n\r\nfunction normalizeError(error: unknown): Error {\r\n  if (error instanceof Error) return error;\r\n  return new Error(typeof error === 'string' ? error : JSON.stringify(error));\r\n}\r\n\r\nfunction bootstrapDetentionSystem(): DetentionSystem {\r\n  // #region agent log\r\n  console.log('[DEBUG-HYP-D] core.ts:172 - bootstrapDetentionSystem ', {\r\n    timestamp: Date.now(),\r\n    location: 'core.ts:172',\r\n    hypothesisId: 'D',\r\n  });\r\n  // #endregion\r\n\r\n  const events = new EventEmitter();\r\n  const CacheManager = createCacheManager();\r\n\r\n  // #region agent log\r\n  console.log('[DEBUG-HYP-D] core.ts:175 - EventEmitter  CacheManager ', {\r\n    timestamp: Date.now(),\r\n    eventsType: typeof events,\r\n    cacheManagerType: typeof CacheManager,\r\n    location: 'core.ts:175',\r\n    hypothesisId: 'D',\r\n  });\r\n  // #endregion\r\n\r\n  const system: DetentionSystem = {\r\n    version: '3.2.0',\r\n    initialized: false,\r\n    modules: {},\r\n    config: {\r\n      tokenBudget: 100000,\r\n      fallbackBudget: 40000,\r\n      compressionQuality: 0.8,\r\n      cacheExpiry: 600000,\r\n      healthCheckInterval: 500,\r\n      healthCheckTimeout: 3000,\r\n    },\r\n    state: {\r\n      mode: 'detecting',\r\n      tokenUsed: 0,\r\n      lastHealthCheck: 0,\r\n      errors: [],\r\n    },\r\n    events,\r\n    CacheManager,\r\n    EventEmitter,\r\n\r\n    ping() {\r\n      system.state.lastHealthCheck = Date.now();\r\n      return true;\r\n    },\r\n\r\n    checkTokenBudget() {\r\n      const total = system.state.mode === 'external' ? system.config.tokenBudget : system.config.fallbackBudget;\r\n      const used = system.state.tokenUsed;\r\n      const percentage = (used / total) * 100;\r\n\r\n      const status: BudgetStatus = percentage > 95 ? 'critical' : percentage > 85 ? 'warning' : 'normal';\r\n\r\n      return {\r\n        used,\r\n        total,\r\n        percentage: percentage.toFixed(2),\r\n        remaining: total - used,\r\n        status,\r\n      };\r\n    },\r\n\r\n    updateTokenUsage(tokens: number) {\r\n      system.state.tokenUsed += tokens;\r\n      const budget = system.checkTokenBudget();\r\n\r\n      if (budget.status === 'warning') {\r\n        console.warn(`[Token] :  ${budget.percentage}%`);\r\n        system.events.emit('token_warning', budget);\r\n      } else if (budget.status === 'critical') {\r\n        console.error(`[Token] :  ${budget.percentage}%`);\r\n        system.events.emit('token_critical', budget);\r\n      }\r\n\r\n      return budget;\r\n    },\r\n\r\n    compressContent(content: unknown, quality: number | null = null) {\r\n      const text = typeof content === 'string' ? content : JSON.stringify(content);\r\n      const actualQuality = quality ?? system.config.compressionQuality;\r\n\r\n      let compressed = text\r\n        .replace(/\\s+/g, ' ')\r\n        .replace(/\\n\\s*\\n/g, '\\n')\r\n        .trim();\r\n\r\n      if (actualQuality < 0.9) {\r\n        compressed = compressed.replace(//g, ',').replace(//g, '.').replace(//g, ';').replace(//g, ':');\r\n      }\r\n\r\n      const originalSize = text.length;\r\n      const compressedSize = compressed.length;\r\n      const ratio = ((1 - compressedSize / originalSize) * 100).toFixed(2);\r\n\r\n      console.info(`[] : ${originalSize} -> : ${compressedSize} ( ${ratio}%)`);\r\n\r\n      return compressed;\r\n    },\r\n\r\n    registerModule(name: string, module: unknown) {\r\n      if (system.modules[name]) {\r\n        console.warn(`[]  ${name} `);\r\n      }\r\n      system.modules[name] = module;\r\n      console.info(`[]  ${name} `);\r\n      system.events.emit('module_registered', { name, module });\r\n\r\n      // \r\n      try {\r\n        if (window.parent && window.parent !== window) {\r\n          (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem = system;\r\n          (window.parent as any).DS = system;\r\n        }\r\n      } catch (e) {\r\n        // \r\n      }\r\n    },\r\n\r\n    getModule<T = unknown>(name: string) {\r\n      return system.modules[name] as T | undefined;\r\n    },\r\n\r\n    handleError(error: unknown, context: string = 'unknown') {\r\n      const normalized = normalizeError(error);\r\n      const errorInfo: DetentionErrorInfo = {\r\n        message: normalized.message,\r\n        context,\r\n        timestamp: Date.now(),\r\n        stack: normalized.stack,\r\n      };\r\n\r\n      system.state.errors.push(errorInfo);\r\n      console.error(`[]  [${context}]:`, normalized);\r\n      system.events.emit('error', errorInfo);\r\n\r\n      if (system.state.errors.length > 100) {\r\n        system.state.errors.shift();\r\n      }\r\n    },\r\n\r\n    detectEnvironment() {\r\n      const env: EnvironmentInfo = {\r\n        isSillyTavern: false,\r\n        version: null,\r\n        hasHelper: false,\r\n        helperVersion: null,\r\n        hasDataTable: false,\r\n      };\r\n\r\n      const isSillyTavernAvailable = typeof SillyTavern !== 'undefined';\r\n      if (isSillyTavernAvailable || $('#send_textarea').length > 0) {\r\n        env.isSillyTavern = true;\r\n        if (typeof getTavernVersion === 'function') {\r\n          env.version = getTavernVersion() ?? null;\r\n        }\r\n      }\r\n\r\n      if (typeof getTavernHelperVersion === 'function') {\r\n        env.hasHelper = true;\r\n        env.helperVersion = getTavernHelperVersion() ?? null;\r\n      }\r\n\r\n      const windowWithTable = window as typeof window & {\r\n        insertRow?: unknown;\r\n        updateRow?: unknown;\r\n      };\r\n      if (typeof windowWithTable.insertRow === 'function' && typeof windowWithTable.updateRow === 'function') {\r\n        env.hasDataTable = true;\r\n      }\r\n\r\n      return env;\r\n    },\r\n\r\n    initialize() {\r\n      if (system.initialized) {\r\n        console.warn('[] ');\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      const env = system.detectEnvironment();\r\n      console.info('[] :', env);\r\n\r\n      if (!env.isSillyTavern) {\r\n        console.warn('[] SillyTavern');\r\n      }\r\n\r\n      system.state.mode = 'external';\r\n      system.initialized = true;\r\n\r\n      console.info('[] ');\r\n      console.info(`[] : ${system.version}`);\r\n      console.info(`[] : ${system.state.mode}`);\r\n      console.info(`[] Token: ${system.config.tokenBudget}`);\r\n\r\n      system.events.emit('initialized', { env, state: system.state });\r\n    },\r\n\r\n    // \r\n    initializeState(state?: {\r\n      name?: string;\r\n      age?: number;\r\n      crime?: string;\r\n      health?: number;\r\n      mental?: number;\r\n      strength?: number;\r\n      intelligence?: number;\r\n      appearance?: {\r\n        height?: number;\r\n        weight?: number;\r\n        hair?: string;\r\n        condition?: string;\r\n      };\r\n      clothing?: {\r\n        top?: string;\r\n        bottom?: string;\r\n        underwear?: string;\r\n        underpants?: string;\r\n        socks?: string;\r\n        shoes?: string;\r\n        restraints?: string;\r\n        cleanliness?: string;\r\n      };\r\n      currentTask?: string;\r\n      currentThought?: string;\r\n      biggestWorry?: string;\r\n    }) {\r\n      if (!state) {\r\n        console.warn('[] initializeState ');\r\n        return;\r\n      }\r\n\r\n      console.info('[] :', state);\r\n\r\n      //  stateChanged \r\n      system.events.emit('stateChanged', state);\r\n\r\n      // \r\n      const statusPanel = system.getModule('statusPanel') as\r\n        | {\r\n            initialize?: () => void;\r\n            getState?: () => unknown;\r\n          }\r\n        | undefined;\r\n\r\n      if (statusPanel) {\r\n        console.info('[]  ');\r\n      } else {\r\n        console.warn('[]  ');\r\n      }\r\n    },\r\n  };\r\n\r\n  // #region agent log\r\n  console.log('[DEBUG-HYP-D] core.ts:365 - bootstrapDetentionSystem  system ', {\r\n    timestamp: Date.now(),\r\n    systemType: typeof system,\r\n    systemExists: !!system,\r\n    hasVersion: 'version' in system,\r\n    hasModules: 'modules' in system,\r\n    hasEvents: 'events' in system,\r\n    systemVersion: system.version,\r\n    location: 'core.ts:365',\r\n    hypothesisId: 'D',\r\n  });\r\n  // #endregion\r\n\r\n  return system;\r\n}\r\n\r\nfunction ensureCacheCleanup(system: DetentionSystem) {\r\n  if (!cacheCleanupTimer) {\r\n    cacheCleanupTimer = setInterval(() => system.CacheManager.cleanup(), 60000);\r\n  }\r\n}\r\n\r\nfunction stopCacheCleanup() {\r\n  if (cacheCleanupTimer) {\r\n    clearInterval(cacheCleanupTimer);\r\n    cacheCleanupTimer = undefined;\r\n  }\r\n}\r\n\r\n// #region agent log\r\nconsole.log('[DEBUG-HYP-B] core.ts:363 - ', {\r\n  timestamp: Date.now(),\r\n  windowExists: typeof window !== 'undefined',\r\n  windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\r\n  location: 'core.ts:363',\r\n  hypothesisId: 'B',\r\n});\r\n// #endregion\r\n\r\n// \r\nif (!window.detentionSystem) {\r\n  // #region agent log\r\n  //  CORS \r\n  try {\r\n    const isLocalDev =\r\n      typeof window !== 'undefined' &&\r\n      window.location &&\r\n      (window.location.hostname === 'localhost' ||\r\n        window.location.hostname === '127.0.0.1' ||\r\n        window.location.hostname.startsWith('192.168.') ||\r\n        window.location.hostname.startsWith('10.') ||\r\n        window.location.hostname.startsWith('172.'));\r\n    \r\n    //  CORS \r\n    /* if (isLocalDev) {\r\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'core.ts:',\r\n          message: ' bootstrapDetentionSystem',\r\n          data: {\r\n            windowType: typeof window,\r\n            isIframe: window.parent !== window,\r\n            parentExists: !!window.parent,\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-init-failure',\r\n          hypothesisId: 'A',\r\n        }),\r\n      }).catch(() => {});\r\n    } */\r\n  } catch (e) {\r\n    // \r\n  }\r\n  // #endregion\r\n\r\n  try {\r\n    window.detentionSystem = bootstrapDetentionSystem();\r\n    //  DS \r\n    (window as any).DS = window.detentionSystem;\r\n    console.info('[]   DS  window.detentionSystem ');\r\n\r\n    // #region agent log ( CORS )\r\n    // \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'core.ts:',\r\n        message: '',\r\n        data: {\r\n          hasWindowDetentionSystem: typeof window.detentionSystem !== 'undefined',\r\n          hasPing: typeof (window.detentionSystem as DetentionSystem).ping === 'function',\r\n          pingResult:\r\n            typeof (window.detentionSystem as DetentionSystem).ping === 'function'\r\n              ? (window.detentionSystem as DetentionSystem).ping()\r\n              : 'N/A',\r\n          hasInitializeState:\r\n            typeof (window.detentionSystem as DetentionSystem & { initializeState?: unknown }).initializeState ===\r\n            'function',\r\n          version: (window.detentionSystem as DetentionSystem).version,\r\n        },\r\n        timestamp: Date.now(),\r\n        sessionId: 'debug-session',\r\n        runId: 'fix-init-failure',\r\n        hypothesisId: 'B',\r\n      }),\r\n    }).catch(() => {}); */\r\n    // #endregion\r\n\r\n    // #region agent log\r\n    console.log('[DEBUG-HYP-D] core.ts:365 - bootstrapDetentionSystem ', {\r\n      timestamp: Date.now(),\r\n      resultType: typeof window.detentionSystem,\r\n      resultExists: !!window.detentionSystem,\r\n      hasVersion: !!(window.detentionSystem && 'version' in window.detentionSystem),\r\n      location: 'core.ts:365',\r\n      hypothesisId: 'D',\r\n    });\r\n    // #endregion\r\n\r\n    console.info('[]  ');\r\n    console.info('[] window.detentionSystem :', typeof window.detentionSystem);\r\n    console.info('[] window.detentionSystem :', window.detentionSystem);\r\n    // \r\n    (window as any).__DETENTION_SYSTEM_CORE_LOADED__ = true;\r\n    (window as any).__DETENTION_SYSTEM_VERSION__ = window.detentionSystem.version;\r\n\r\n    //  iframe \r\n    try {\r\n      if (window.parent && window.parent !== window) {\r\n        // #region agent log ( CORS )\r\n        // \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:iframe',\r\n            message: ' iframe ',\r\n            data: {\r\n              hasParent: !!window.parent,\r\n              parentIsDifferent: window.parent !== window,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-init-failure',\r\n            hypothesisId: 'C',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        //  jQuery ready \r\n        $(() => {\r\n          try {\r\n            (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem =\r\n              window.detentionSystem;\r\n            //  DS\r\n            (window.parent as any).DS = window.detentionSystem;\r\n            console.info('[]  iframe ');\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:iframe',\r\n                message: '',\r\n                data: {\r\n                  parentHasDetentionSystem:\r\n                    typeof (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem })\r\n                      .detentionSystem !== 'undefined',\r\n                  parentHasDS: typeof (window.parent as any).DS !== 'undefined',\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-init-failure',\r\n                hypothesisId: 'D',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n          } catch (e) {\r\n            console.warn('[]  :', e);\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:iframe',\r\n                message: '',\r\n                data: {\r\n                  error: e instanceof Error ? e.message : String(e),\r\n                  errorType: e instanceof Error ? e.constructor.name : typeof e,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-init-failure',\r\n                hypothesisId: 'E',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n          }\r\n        });\r\n\r\n        //  jQuery ready\r\n        try {\r\n          (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem =\r\n            window.detentionSystem;\r\n          (window.parent as any).DS = window.detentionSystem;\r\n          console.info('[]  iframe ');\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:iframe',\r\n              message: '',\r\n              data: {\r\n                parentHasDetentionSystem:\r\n                  typeof (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem })\r\n                    .detentionSystem !== 'undefined',\r\n                parentHasDS: typeof (window.parent as any).DS !== 'undefined',\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-init-failure',\r\n              hypothesisId: 'F',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        } catch (e) {\r\n          console.debug('[]  jQuery ready :', e);\r\n        }\r\n      } else {\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:iframe',\r\n            message: ' iframe ',\r\n            data: {\r\n              hasParent: !!window.parent,\r\n              parentIsDifferent: window.parent !== window,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-init-failure',\r\n            hypothesisId: 'G',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n      }\r\n    } catch (e) {\r\n      console.warn('[]  iframe :', e);\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'core.ts:iframe',\r\n          message: 'iframe ',\r\n          data: {\r\n            error: e instanceof Error ? e.message : String(e),\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-init-failure',\r\n          hypothesisId: 'H',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n    }\r\n  } catch (error) {\r\n    // #region agent log\r\n    console.error('[DEBUG-HYP-D] core.ts:365 - bootstrapDetentionSystem ', {\r\n      timestamp: Date.now(),\r\n      error: error instanceof Error ? error.message : String(error),\r\n      errorStack: error instanceof Error ? error.stack : undefined,\r\n      location: 'core.ts:365',\r\n      hypothesisId: 'D',\r\n    });\r\n    // #endregion\r\n    throw error;\r\n  }\r\n} else {\r\n  // #region agent log\r\n  console.log('[DEBUG-HYP-E] core.ts:364 - window.detentionSystem ', {\r\n    timestamp: Date.now(),\r\n    existingType: typeof window.detentionSystem,\r\n    location: 'core.ts:364',\r\n    hypothesisId: 'E',\r\n  });\r\n  // #endregion\r\n}\r\n\r\n// #region agent log\r\nconsole.log('[DEBUG-HYP-F] core.ts:371 -  jQuery ', {\r\n  timestamp: Date.now(),\r\n  jQueryExists: typeof $ !== 'undefined',\r\n  jQueryType: typeof $,\r\n  location: 'core.ts:371',\r\n  hypothesisId: 'F',\r\n});\r\n// #endregion\r\n\r\n$(() => {\r\n  // #region agent log\r\n  console.log('[DEBUG-HYP-F] core.ts:371 - jQuery ready ', {\r\n    timestamp: Date.now(),\r\n    windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\r\n    location: 'core.ts:371',\r\n    hypothesisId: 'F',\r\n  });\r\n  // #endregion\r\n\r\n  console.info('[] jQuery ready');\r\n\r\n  // \r\n  if (!window.detentionSystem) {\r\n    // #region agent log\r\n    console.warn('[DEBUG-HYP-E] core.ts:375 -  jQuery ready ', {\r\n      timestamp: Date.now(),\r\n      location: 'core.ts:375',\r\n      hypothesisId: 'E',\r\n    });\r\n    // #endregion\r\n\r\n    console.warn('[]  jQuery ready ');\r\n    window.detentionSystem = bootstrapDetentionSystem();\r\n    //  DS \r\n    if (!(window as any).DS) {\r\n      (window as any).DS = window.detentionSystem;\r\n      console.info('[]   DS  window.detentionSystem ');\r\n    }\r\n    console.info('[] jQuery ready ');\r\n  } else {\r\n    // #region agent log\r\n    console.log('[DEBUG-HYP-E] core.ts:375 - jQuery ready ', {\r\n      timestamp: Date.now(),\r\n      systemType: typeof window.detentionSystem,\r\n      systemVersion: window.detentionSystem?.version,\r\n      location: 'core.ts:375',\r\n      hypothesisId: 'E',\r\n    });\r\n    // #endregion\r\n  }\r\n\r\n  const system = window.detentionSystem!;\r\n\r\n  //  DS \r\n  if (!(window as any).DS) {\r\n    (window as any).DS = system;\r\n    console.info('[]   DS  window.detentionSystem ');\r\n  }\r\n\r\n  console.info('[] :', {\r\n    exists: !!system,\r\n    version: system.version,\r\n    initialized: system.initialized,\r\n  });\r\n\r\n  ensureCacheCleanup(system);\r\n\r\n  console.info('[]  1 ...');\r\n  setTimeout(() => {\r\n    console.info('[] setTimeout ...');\r\n    try {\r\n      system.initialize();\r\n      console.info('[] initialize() ');\r\n\r\n      // \r\n      try {\r\n        if (window.parent && window.parent !== window && system) {\r\n          (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem = system;\r\n          //  DS\r\n          (window.parent as any).DS = system;\r\n          console.info('[]  ');\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:',\r\n              message: '',\r\n              data: {\r\n                parentHasDetentionSystem:\r\n                  typeof (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem })\r\n                    .detentionSystem !== 'undefined',\r\n                parentHasDS: typeof (window.parent as any).DS !== 'undefined',\r\n                modulesCount: Object.keys(system.modules).length,\r\n                moduleNames: Object.keys(system.modules),\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-init-failure',\r\n              hypothesisId: 'I',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        }\r\n      } catch (e) {\r\n        console.warn('[]  :', e);\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:',\r\n            message: '',\r\n            data: {\r\n              error: e instanceof Error ? e.message : String(e),\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-init-failure',\r\n            hypothesisId: 'J',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n      }\r\n\r\n      //  DS\r\n      if (!(window as any).DS && system) {\r\n        (window as any).DS = system;\r\n        console.info('[]   DS ');\r\n      }\r\n    } catch (error) {\r\n      console.error('[] initialize() :', error);\r\n      system.handleError(error, 'initialize');\r\n    }\r\n  }, 1000);\r\n});\r\n\r\n$(window).on('pagehide', () => {\r\n  stopCacheCleanup();\r\n});\r\n\r\n// ==========  ==========\r\n// ID\r\nlet skipMessageId: number | null = null;\r\n\r\n$(() => {\r\n  console.info('[] ...');\r\n\r\n  // \r\n  const skipCommandMessages = new Set<number>();\r\n\r\n  // \r\n  //  eventMakeFirst  quick-reply \r\n  eventMakeFirst(tavern_events.USER_MESSAGE_RENDERED, async (message_id: number) => {\r\n    try {\r\n      const messages = getChatMessages(message_id, { role: 'user' });\r\n      const userMessage = messages[0];\r\n      if (!userMessage || !userMessage.message) return;\r\n\r\n      const userInput = userMessage.message;\r\n\r\n      //  data \r\n      const messageData = userMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n      const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n      const isSystemByContent =\r\n        userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n      if (isSystemEventMessage || isSystemByContent) {\r\n        //  event_triggered \r\n        //  quick-reply \r\n        // \r\n        //\r\n        // \r\n        // 1.  eventMakeFirst\r\n        // 2.  GENERATION_STARTED \r\n        // 3.  waitingForEventResponse \r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:USER_MESSAGE_RENDERED',\r\n            message: 'event_triggered',\r\n            data: {\r\n              message_id,\r\n              isSystemEventMessage,\r\n              isSystemByContent,\r\n              userInput: userInput.substring(0, 50) + '...',\r\n              waitingForEventResponse,\r\n              duringGenerating:\r\n                typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v7',\r\n            hypothesisId: 'SKIP_SYSTEM_EVENT',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        if (waitingForEventResponse) {\r\n          //  quick-reply\r\n          try {\r\n            await stopAllGeneration();\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:USER_MESSAGE_RENDERED',\r\n                message: 'USER_MESSAGE_RENDERED',\r\n                data: {\r\n                  message_id,\r\n                  waitingForEventResponse,\r\n                  afterStopDuringGenerating:\r\n                    typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-duplicate-trigger-v7',\r\n                hypothesisId: 'STOP_IN_USER_RENDERED',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n          } catch (error) {\r\n            console.warn('[] USER_MESSAGE_RENDERED:', error);\r\n          }\r\n        }\r\n\r\n        return; // \r\n      }\r\n\r\n      // \r\n      // 151515\r\n      const skipDayPattern =\r\n        /(?:|||)\\s*(\\d+|[]?|[][]?|[]??[]?|[]??[]??[]?|)\\s*[\\s]*/;\r\n      const skipDayMatch = userInput.match(skipDayPattern);\r\n\r\n      if (skipDayMatch) {\r\n        // \r\n        try {\r\n          await setChatMessages([{ message_id, is_hidden: true, message: '.' }], { refresh: 'all' });\r\n          skipCommandMessages.add(message_id);\r\n          console.info(`[]  USER_MESSAGE_RENDERED (message_id: ${message_id})`);\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:USER_MESSAGE_RENDERED',\r\n              message: '',\r\n              data: { message_id, userInput },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-skip-rounds-early',\r\n              hypothesisId: 'HIDE_EARLY',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        } catch (error) {\r\n          console.warn('[] USER_MESSAGE_RENDERED:', error);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('[] USER_MESSAGE_RENDERED:', error);\r\n    }\r\n  });\r\n\r\n  // AI\r\n  eventOn(tavern_events.GENERATE_BEFORE_COMBINE_PROMPTS, () => {\r\n    // \r\n    if (skipCommandMessages.size > 0) {\r\n      // \r\n      skipCommandMessages.clear();\r\n      // \r\n    }\r\n\r\n    // \r\n    try {\r\n      const messages = getChatMessages(-1, { role: 'user' });\r\n      const lastUserMessage = messages[messages.length - 1];\r\n      if (lastUserMessage) {\r\n        const messageData = lastUserMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n        const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n        const userInput = lastUserMessage.message || '';\r\n        const isSystemByContent =\r\n          userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n        if (isSystemEventMessage || isSystemByContent) {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:GENERATE_BEFORE_COMBINE_PROMPTS',\r\n              message: '',\r\n              data: {\r\n                message_id: lastUserMessage.message_id,\r\n                isSystemEventMessage,\r\n                isSystemByContent,\r\n                waitingForEventResponse,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-duplicate-trigger-v7',\r\n              hypothesisId: 'GENERATE_BEFORE_CHECK',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          // GENERATE_BEFORE_COMBINE_PROMPTS \r\n          //  MESSAGE_SENT  USER_MESSAGE_RENDERED \r\n        }\r\n      }\r\n    } catch (error) {\r\n      // \r\n    }\r\n  });\r\n\r\n  // \r\n  //  ID triggerSlash \r\n  let lastTriggerTime: number | null = null;\r\n  let lastTriggerEventName: string | null = null;\r\n  const generationTracking: Array<{\r\n    generation_id: string | null;\r\n    type: string;\r\n    timestamp: number;\r\n    triggerTime: number | null;\r\n    eventName: string | null;\r\n    source: 'iframe' | 'tavern';\r\n  }> = [];\r\n\r\n  //  iframe_events  tavern_events  GENERATION_STARTED\r\n  eventOn(iframe_events.GENERATION_STARTED, (generation_id: string) => {\r\n    // #region agent log -  GENERATION_STARTED iframe\r\n    const now = Date.now();\r\n    generationTracking.push({\r\n      generation_id: generation_id,\r\n      type: 'iframe',\r\n      timestamp: now,\r\n      triggerTime: lastTriggerTime,\r\n      eventName: lastTriggerEventName,\r\n      source: 'iframe',\r\n    });\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'core.ts:GENERATION_STARTED:iframe',\r\n        message: 'iframe_events.GENERATION_STARTED ',\r\n        data: {\r\n          generation_id,\r\n          timestamp: now,\r\n          lastTriggerTime,\r\n          lastTriggerEventName,\r\n          timeSinceLastTrigger: lastTriggerTime ? now - lastTriggerTime : null,\r\n          trackingCount: generationTracking.length,\r\n          source: 'iframe',\r\n        },\r\n        timestamp: now,\r\n        sessionId: 'debug-session',\r\n        runId: 'track-streaming-gen',\r\n        hypothesisId: 'GEN_STARTED_TRACK_IFRAME',\r\n      }),\r\n    }).catch(() => {}); */\r\n    // #endregion\r\n\r\n    if (skipMessageId !== null) {\r\n      console.info(`[]   (generation_id: ${generation_id})`);\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'core.ts:GENERATION_STARTED',\r\n          message: '',\r\n          data: {\r\n            generation_id,\r\n            skipMessageId,\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-skip-rounds',\r\n          hypothesisId: 'STOP_GEN',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      stopGenerationById(generation_id).then(success => {\r\n        if (success) {\r\n          console.info(`[]   (generation_id: ${generation_id})`);\r\n        } else {\r\n          console.warn(`[]  (generation_id: ${generation_id})`);\r\n        }\r\n        // \r\n        skipMessageId = null;\r\n      });\r\n      return;\r\n    }\r\n\r\n    // \r\n    try {\r\n      const messages = getChatMessages(-1, { role: 'user' });\r\n      const lastUserMessage = messages[messages.length - 1];\r\n      if (lastUserMessage) {\r\n        const messageData = lastUserMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n        const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n        const userInput = lastUserMessage.message || '';\r\n        const isSystemByContent =\r\n          userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n        // \r\n        if (waitingForEventResponse && (isSystemEventMessage || isSystemByContent)) {\r\n          console.warn(\r\n            `[]   (generation_id: ${generation_id})`,\r\n          );\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:GENERATION_STARTED',\r\n              message: '',\r\n              data: {\r\n                generation_id,\r\n                message_id: lastUserMessage.message_id,\r\n                isSystemEventMessage,\r\n                isSystemByContent,\r\n                waitingForEventResponse,\r\n                userInput: userInput.substring(0, 100),\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-duplicate-trigger-v7',\r\n              hypothesisId: 'STOP_SYSTEM_EVENT_GEN',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          stopGenerationById(generation_id).then(success => {\r\n            if (success) {\r\n              console.info(`[]   (generation_id: ${generation_id})`);\r\n            } else {\r\n              console.warn(`[]  (generation_id: ${generation_id})`);\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // \r\n    }\r\n  });\r\n\r\n  //  tavern_events.GENERATION_STARTED triggerSlash \r\n  eventOn(tavern_events.GENERATION_STARTED, (type: string, options: unknown, dry_run: boolean) => {\r\n    // #region agent log -  GENERATION_STARTED tavern\r\n    const now = Date.now();\r\n    generationTracking.push({\r\n      generation_id: null,\r\n      type,\r\n      timestamp: now,\r\n      triggerTime: lastTriggerTime,\r\n      eventName: lastTriggerEventName,\r\n      source: 'tavern',\r\n    });\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'core.ts:GENERATION_STARTED:tavern',\r\n        message: 'tavern_events.GENERATION_STARTED ',\r\n        data: {\r\n          type,\r\n          dry_run,\r\n          options: typeof options === 'object' && options !== null ? Object.keys(options as object) : typeof options,\r\n          timestamp: now,\r\n          lastTriggerTime,\r\n          lastTriggerEventName,\r\n          timeSinceLastTrigger: lastTriggerTime ? now - lastTriggerTime : null,\r\n          trackingCount: generationTracking.length,\r\n          source: 'tavern',\r\n          waitingForEventResponse,\r\n        },\r\n        timestamp: now,\r\n        sessionId: 'debug-session',\r\n        runId: 'track-streaming-gen',\r\n        hypothesisId: 'GEN_STARTED_TRACK_TAVERN',\r\n      }),\r\n    }).catch(() => {}); */\r\n    // #endregion\r\n  });\r\n\r\n  //  AI \r\n  const aiMessageTracking: Array<{\r\n    message_id: number;\r\n    timestamp: number;\r\n    triggerTime: number | null;\r\n    eventName: string | null;\r\n    messageLength: number;\r\n    messagePreview: string;\r\n  }> = [];\r\n\r\n  //  AI \r\n  //  eventMakeFirst \r\n  eventMakeFirst(tavern_events.CHARACTER_MESSAGE_RENDERED, (message_id: number) => {\r\n    try {\r\n      const messages = getChatMessages(message_id, { role: 'assistant' });\r\n      const aiMessage = messages[0];\r\n      if (aiMessage && aiMessage.message) {\r\n        const now = Date.now();\r\n        const messageText = aiMessage.message;\r\n\r\n        // \r\n        const alreadyTracked = aiMessageTracking.some(m => m.message_id === message_id);\r\n        if (alreadyTracked) {\r\n          console.warn(`[]  CHARACTER_MESSAGE_RENDERED message_id: ${message_id}`);\r\n          return;\r\n        }\r\n\r\n        aiMessageTracking.push({\r\n          message_id,\r\n          timestamp: now,\r\n          triggerTime: lastTriggerTime,\r\n          eventName: lastTriggerEventName,\r\n          messageLength: messageText.length,\r\n          messagePreview: messageText.substring(0, 100),\r\n        });\r\n\r\n        // #region agent log -  CHARACTER_MESSAGE_RENDERED \r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:CHARACTER_MESSAGE_RENDERED',\r\n            message: 'CHARACTER_MESSAGE_RENDERED ',\r\n            data: {\r\n              message_id,\r\n              timestamp: now,\r\n              lastTriggerTime,\r\n              lastTriggerEventName,\r\n              timeSinceLastTrigger: lastTriggerTime ? now - lastTriggerTime : null,\r\n              messageLength: messageText.length,\r\n              messagePreview: messageText.substring(0, 200),\r\n              trackingCount: aiMessageTracking.length,\r\n              allMessageIds: aiMessageTracking.map(m => m.message_id),\r\n              allMessages: aiMessageTracking.map(m => ({\r\n                id: m.message_id,\r\n                length: m.messageLength,\r\n                triggerTime: m.triggerTime,\r\n                eventName: m.eventName,\r\n                timestamp: m.timestamp,\r\n              })),\r\n              totalCharacters: aiMessageTracking.reduce((sum, m) => sum + m.messageLength, 0),\r\n              // \r\n              recentMessages: aiMessageTracking\r\n                .filter(m => Math.abs(m.timestamp - now) < 5000 && m.message_id !== message_id)\r\n                .map(m => ({\r\n                  id: m.message_id,\r\n                  length: m.messageLength,\r\n                  timeDiff: Math.abs(m.timestamp - now),\r\n                })),\r\n            },\r\n            timestamp: now,\r\n            sessionId: 'debug-session',\r\n            runId: 'track-streaming-gen',\r\n            hypothesisId: 'CHAR_MSG_RENDERED_TRACK',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        const relatedMessages = aiMessageTracking.filter(\r\n          m => m.triggerTime === lastTriggerTime && m.eventName === lastTriggerEventName,\r\n        );\r\n\r\n        // \r\n        if (relatedMessages.length > 1) {\r\n          const timeGaps = relatedMessages\r\n            .sort((a, b) => a.timestamp - b.timestamp)\r\n            .map((m, i, arr) => (i > 0 ? m.timestamp - arr[i - 1].timestamp : 0))\r\n            .filter(gap => gap > 0);\r\n\r\n          console.warn(\r\n            `[]   \"${lastTriggerEventName}\"  ${relatedMessages.length} `,\r\n            {\r\n              messageIds: relatedMessages.map(m => m.message_id),\r\n              lengths: relatedMessages.map(m => m.messageLength),\r\n              timeGaps,\r\n              totalLength: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0),\r\n            },\r\n          );\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:CHARACTER_MESSAGE_RENDERED',\r\n              message: ' ',\r\n              data: {\r\n                eventName: lastTriggerEventName,\r\n                triggerTime: lastTriggerTime,\r\n                messageCount: relatedMessages.length,\r\n                messages: relatedMessages\r\n                  .sort((a, b) => a.timestamp - b.timestamp)\r\n                  .map((m, i, arr) => ({\r\n                    message_id: m.message_id,\r\n                    messageLength: m.messageLength,\r\n                    timestamp: m.timestamp,\r\n                    timeSinceTrigger: lastTriggerTime ? m.timestamp - lastTriggerTime : null,\r\n                    timeSincePrevious: i > 0 ? m.timestamp - arr[i - 1].timestamp : null,\r\n                    preview: m.messagePreview.substring(0, 150),\r\n                  })),\r\n                totalLength: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0),\r\n                averageLength: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0) / relatedMessages.length,\r\n                timeGaps,\r\n                potentialSplit: timeGaps.length > 0 && timeGaps.some(gap => gap < 2000), // 2\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'track-streaming-gen',\r\n              hypothesisId: 'MESSAGE_SPLIT_DETECTED',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        }\r\n\r\n        //  triggerTime \r\n        const recentMessages = aiMessageTracking.filter(\r\n          m => m.message_id !== message_id && Math.abs(m.timestamp - now) < 3000,\r\n        );\r\n        if (recentMessages.length > 0) {\r\n          console.info(\r\n            `[]  ${recentMessages.length} 3`,\r\n            recentMessages.map(m => ({ id: m.message_id, timeDiff: Math.abs(m.timestamp - now) })),\r\n          );\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('[] CHARACTER_MESSAGE_RENDERED :', error);\r\n    }\r\n  });\r\n\r\n  // \r\n  // \r\n  eventOn(tavern_events.MESSAGE_SENT, async (message_id: number | string) => {\r\n    // #region agent log\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'core.ts:MESSAGE_SENT',\r\n        message: 'MESSAGE_SENT',\r\n        data: {\r\n          message_id,\r\n          messageIdType: typeof message_id,\r\n          waitingForEventResponse,\r\n        },\r\n        timestamp: Date.now(),\r\n        sessionId: 'debug-session',\r\n        runId: 'fix-duplicate-trigger-v5',\r\n        hypothesisId: 'A',\r\n      }),\r\n    }).catch(() => {}); */\r\n    // #endregion\r\n\r\n    try {\r\n      console.info(`[]  MESSAGE_SENT message_id: ${message_id}`);\r\n\r\n      // \r\n      // \r\n      if (waitingForEventResponse) {\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:MESSAGE_SENT',\r\n            message: '',\r\n            data: {\r\n              message_id,\r\n              waitingForEventResponse: true,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v5',\r\n            hypothesisId: 'EARLY_CHECK',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        const messages = getChatMessages(-1, { role: 'user' });\r\n        const userMessage = messages.find(m => m.message_id === Number(message_id));\r\n\r\n        if (userMessage) {\r\n          //  data \r\n          const messageData = userMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n          const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n          const userInput = userMessage.message || '';\r\n          const isSystemByContent =\r\n            userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']'));\r\n\r\n          if (isSystemEventMessage || isSystemByContent) {\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:MESSAGE_SENT',\r\n                message: '',\r\n                data: {\r\n                  message_id,\r\n                  isSystemEventMessage,\r\n                  isSystemByContent,\r\n                  matchedByData: isSystemEventMessage,\r\n                  matchedByContent: isSystemByContent,\r\n                  waitingForEventResponse: true,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-duplicate-trigger-v5',\r\n                hypothesisId: 'EARLY_SKIP',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n\r\n            //  user_input \r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // \r\n      const messages = getChatMessages(-1, { role: 'user' });\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'core.ts:MESSAGE_SENT',\r\n          message: '',\r\n          data: {\r\n            message_id,\r\n            messagesCount: messages.length,\r\n            messageIds: messages.map(m => m.message_id),\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-skip-rounds-input',\r\n          hypothesisId: 'B',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      const userMessage = messages.find(m => m.message_id === Number(message_id));\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'core.ts:MESSAGE_SENT',\r\n          message: '',\r\n          data: {\r\n            message_id,\r\n            foundMessage: !!userMessage,\r\n            hasMessage: !!(userMessage && userMessage.message),\r\n            messageLength: userMessage?.message?.length || 0,\r\n            messagePreview: userMessage?.message?.substring(0, 100) || 'N/A',\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-skip-rounds-input',\r\n          hypothesisId: 'C',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      if (userMessage && userMessage.message) {\r\n        const userInput = userMessage.message;\r\n        console.info('[] :', userInput.substring(0, 50) + '...');\r\n\r\n        //  data \r\n        const messageData = userMessage.data as { isSystemEventMessage?: boolean } | undefined;\r\n        const isSystemEventMessage = messageData?.isSystemEventMessage === true;\r\n\r\n        //  data \r\n        if (\r\n          isSystemEventMessage ||\r\n          userInput.startsWith('[]') ||\r\n          (userInput.startsWith('[') && userInput.includes(']'))\r\n        ) {\r\n          // \r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:MESSAGE_SENT',\r\n              message: '',\r\n              data: {\r\n                userInput: userInput.substring(0, 100),\r\n                message_id: Number(message_id),\r\n                isSystemEventMessage,\r\n                matchedByData: isSystemEventMessage,\r\n                matchedByContent:\r\n                  userInput.startsWith('[]') || (userInput.startsWith('[') && userInput.includes(']')),\r\n                matchedPattern: isSystemEventMessage\r\n                  ? 'data'\r\n                  : userInput.startsWith('[]')\r\n                    ? '[]'\r\n                    : '[X]',\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-duplicate-trigger-v2',\r\n              hypothesisId: 'SKIP_SYSTEM_MSG',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          // \r\n          // 1. event_triggered AI\r\n          // 2.  event_triggered \r\n          // 3. \r\n          //  user_input \r\n          // const DS_EMIT_SYSTEM = window.detentionSystem;\r\n          // if (DS_EMIT_SYSTEM && DS_EMIT_SYSTEM.events) {\r\n          //   DS_EMIT_SYSTEM.events.emit('user_input', { text: userInput, message_id });\r\n          // }\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:MESSAGE_SENT',\r\n              message: '',\r\n              data: {\r\n                message_id: Number(message_id),\r\n                currentMessageId: Number(message_id),\r\n                waitingForEventResponse,\r\n                isSystemMessage: true,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-duplicate-trigger',\r\n              hypothesisId: 'SKIP_RETURN',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          return;\r\n        }\r\n\r\n        // \"\"\"\"\r\n        const protagonistPattern = /(?:|||)\\s*(\\d+)?\\s*(?:|)?\\s*(?:||)/;\r\n        const protagonistMatch = userInput.match(protagonistPattern);\r\n\r\n        if (protagonistMatch) {\r\n          // #region agent log - HYP-PROTAGONIST: \r\n          try {\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:MESSAGE_SENT:',\r\n                message: '',\r\n                data: {\r\n                  userInput,\r\n                  message_id: Number(message_id),\r\n                  match: protagonistMatch[0],\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'protagonist-generation',\r\n                hypothesisId: 'PROTAGONIST-DETECT',\r\n              }),\r\n            }).catch(() => {}); */\r\n          } catch (e) {}\r\n          // #endregion\r\n\r\n          console.info('[] :', userInput);\r\n\r\n          try {\r\n            const DS_PROTAGONIST = window.detentionSystem;\r\n            const npcSystem = DS_PROTAGONIST?.getModule('npcSystem') as {\r\n              generateProtagonist?: (options?: {\r\n                crimeType?: string;\r\n                excludeCrimes?: string[];\r\n                background?: {\r\n                  isIntellectual?: boolean;\r\n                  isAcademic?: boolean;\r\n                  isBusiness?: boolean;\r\n                };\r\n                ageRange?: [number, number];\r\n                education?: string;\r\n                profession?: string[];\r\n              }) => {\r\n                name?: string;\r\n                age?: number;\r\n                crime?: string;\r\n                appearance?: {\r\n                  height?: number;\r\n                  weight?: number;\r\n                  hair?: string;\r\n                  skin?: string;\r\n                  features?: string;\r\n                };\r\n                background?: {\r\n                  education?: string;\r\n                  profession?: string;\r\n                };\r\n                personality?: {\r\n                  tags?: string[];\r\n                };\r\n              };\r\n            };\r\n\r\n            if (npcSystem && npcSystem.generateProtagonist) {\r\n              // \r\n              const options: {\r\n                crimeType?: string;\r\n                excludeCrimes?: string[];\r\n                background?: {\r\n                  isIntellectual?: boolean;\r\n                  isAcademic?: boolean;\r\n                  isBusiness?: boolean;\r\n                };\r\n                ageRange?: [number, number];\r\n                education?: string;\r\n                profession?: string[];\r\n              } = {};\r\n\r\n              // \r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.crimeType = 'economic';\r\n              }\r\n              if (userInput.includes('')) {\r\n                options.excludeCrimes = [''];\r\n              } else if (userInput.includes('') || userInput.includes('')) {\r\n                options.excludeCrimes = [''];\r\n              }\r\n\r\n              // \r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.background = { ...options.background, isIntellectual: true };\r\n              }\r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.background = { ...options.background, isAcademic: false };\r\n              }\r\n              if (userInput.includes('') || userInput.includes('')) {\r\n                options.background = { ...options.background, isBusiness: true };\r\n              }\r\n\r\n              // \r\n              if (userInput.includes('35') || userInput.includes('45')) {\r\n                options.ageRange = [35, 45];\r\n              }\r\n\r\n              // \r\n              if (userInput.includes('') || userInput.includes('') || userInput.includes('')) {\r\n                options.education = 'high';\r\n              }\r\n\r\n              // #region agent log - HYP-PROTAGONIST: generateProtagonist\r\n              try {\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:MESSAGE_SENT:generateProtagonist',\r\n                    message: 'generateProtagonist',\r\n                    data: {\r\n                      hasGenerateProtagonist: !!npcSystem.generateProtagonist,\r\n                      options,\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'protagonist-generation',\r\n                    hypothesisId: 'PROTAGONIST-BEFORE',\r\n                  }),\r\n                }).catch(() => {}); */\r\n              } catch (e) {}\r\n              // #endregion\r\n\r\n              const protagonistData = npcSystem.generateProtagonist(options);\r\n\r\n              // #region agent log - HYP-PROTAGONIST: generateProtagonist\r\n              try {\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:MESSAGE_SENT:generateProtagonist',\r\n                    message: 'generateProtagonist',\r\n                    data: {\r\n                      hasProtagonistData: !!protagonistData,\r\n                      protagonistName: protagonistData?.name || 'N/A',\r\n                      protagonistAge: protagonistData?.age || 'N/A',\r\n                      protagonistCrime: protagonistData?.crime || 'N/A',\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'protagonist-generation',\r\n                    hypothesisId: 'PROTAGONIST-AFTER',\r\n                  }),\r\n                }).catch(() => {}); */\r\n              } catch (e) {}\r\n              // #endregion\r\n\r\n              if (protagonistData && protagonistData.name) {\r\n                // \r\n                const chatId = SillyTavern.getCurrentChatId();\r\n                if (chatId) {\r\n                  const protagonistInfo = {\r\n                    name: protagonistData.name,\r\n                    age: protagonistData.age || 30,\r\n                    crime: protagonistData.crime || '',\r\n                    appearance: protagonistData.appearance || {\r\n                      height: 168,\r\n                      weight: 58,\r\n                      hair: '',\r\n                      skin: '',\r\n                      features: '',\r\n                    },\r\n                    background: protagonistData.background || {},\r\n                    personality: protagonistData.personality || {},\r\n                  };\r\n\r\n                  // replaceVariables\r\n                  replaceVariables(\r\n                    {\r\n                      protagonist: protagonistInfo,\r\n                      protagonist_name: protagonistData.name,\r\n                      protagonist_age: protagonistData.age || 30,\r\n                      protagonist_crime: protagonistData.crime || '',\r\n                    },\r\n                    { type: 'chat' },\r\n                  );\r\n\r\n                  console.info(\r\n                    '[]  :',\r\n                    protagonistData.name,\r\n                    protagonistData.age,\r\n                    protagonistData.crime,\r\n                  );\r\n\r\n                  // #region agent log - HYP-PROTAGONIST: \r\n                  try {\r\n                    //  CORS \r\n                    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                      method: 'POST',\r\n                      headers: { 'Content-Type': 'application/json' },\r\n                      body: JSON.stringify({\r\n                        location: 'core.ts:MESSAGE_SENT:',\r\n                        message: '',\r\n                        data: {\r\n                          protagonistName: protagonistData.name,\r\n                          protagonistAge: protagonistData.age,\r\n                          protagonistCrime: protagonistData.crime,\r\n                          chatId,\r\n                        },\r\n                        timestamp: Date.now(),\r\n                        sessionId: 'debug-session',\r\n                        runId: 'protagonist-generation',\r\n                        hypothesisId: 'PROTAGONIST-SAVED',\r\n                      }),\r\n                    }).catch(() => {}); */\r\n                  } catch (e) {}\r\n                  // #endregion\r\n                }\r\n              } else {\r\n                console.warn('[] generateProtagonist');\r\n              }\r\n            } else {\r\n              console.warn('[] NPCgenerateProtagonist');\r\n            }\r\n          } catch (error) {\r\n            console.error('[] :', error);\r\n\r\n            // #region agent log - HYP-PROTAGONIST: \r\n            try {\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:MESSAGE_SENT:',\r\n                  message: '',\r\n                  data: {\r\n                    error: error instanceof Error ? error.message : String(error),\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'protagonist-generation',\r\n                  hypothesisId: 'PROTAGONIST-ERROR',\r\n                }),\r\n              }).catch(() => {}); */\r\n            } catch (e) {}\r\n            // #endregion\r\n          }\r\n\r\n          // return\r\n        }\r\n\r\n        // \"X\"\"X\"\"X\"\r\n        // 1015\r\n        const skipDayPattern =\r\n          /(?:|||)\\s*(\\d+|[]?|[][]?|[]??[]?|[]??[]??[]?|)\\s*[\\s]*/;\r\n        const skipDayMatch = userInput.match(skipDayPattern);\r\n\r\n        // #region agent log ( CORS )\r\n        // \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:MESSAGE_SENT',\r\n            message: '',\r\n            data: {\r\n              userInput,\r\n              skipDayMatch: skipDayMatch ? skipDayMatch[0] : null,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-skip-rounds-input',\r\n            hypothesisId: 'D',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        const DS_CHECK = window.detentionSystem;\r\n        if (DS_CHECK && DS_CHECK.initialized) {\r\n          const eventSystem = DS_CHECK.getModule('eventSystem');\r\n          if (eventSystem && (DS_CHECK as any).advanceDay) {\r\n            let daysToSkip = 0;\r\n\r\n            // \"\"\"\"\r\n            const parseNumber = (numStr: string): number => {\r\n              // \r\n              const parsed = parseInt(numStr, 10);\r\n              if (!isNaN(parsed)) return parsed;\r\n\r\n              // \r\n              const chineseDigits: Record<string, number> = {\r\n                : 0,\r\n                : 1,\r\n                : 2,\r\n                : 3,\r\n                : 4,\r\n                : 5,\r\n                : 6,\r\n                : 7,\r\n                : 8,\r\n                : 9,\r\n                : 10,\r\n                : 100,\r\n                : 1000,\r\n                : 10000,\r\n              };\r\n\r\n              // \r\n              if (numStr in chineseDigits) return chineseDigits[numStr];\r\n\r\n              // \"\"\"\"\"\"\r\n              let result = 0;\r\n\r\n              // \"X\"\"\"\"\"\r\n              if (numStr.startsWith('')) {\r\n                result = 10;\r\n                const rest = numStr.slice(1);\r\n                if (rest in chineseDigits) result += chineseDigits[rest];\r\n              }\r\n              // \"X\"\"\"\"\"\r\n              else if (numStr.endsWith('')) {\r\n                const prefix = numStr.slice(0, -1);\r\n                if (prefix in chineseDigits) result = chineseDigits[prefix] * 10;\r\n              }\r\n              // \"XY\"\"\"\"\"\r\n              else {\r\n                const shiIndex = numStr.indexOf('');\r\n                if (shiIndex > -1) {\r\n                  const before = numStr.slice(0, shiIndex);\r\n                  const after = numStr.slice(shiIndex + 1);\r\n                  const beforeNum = before in chineseDigits ? chineseDigits[before] : 0;\r\n                  const afterNum = after in chineseDigits ? chineseDigits[after] : 0;\r\n                  result = (beforeNum || 1) * 10 + afterNum; // \"\"1\"\"\r\n                }\r\n              }\r\n\r\n              return result > 0 ? result : 0;\r\n            };\r\n\r\n            // \"X\"\"X\"\"X\"\r\n            if (skipDayMatch) {\r\n              daysToSkip = parseNumber(skipDayMatch[1]);\r\n              if (daysToSkip > 0) {\r\n                console.info(`[] /: ${skipDayMatch[0].trim()} (${daysToSkip})`);\r\n              }\r\n            }\r\n\r\n            // \r\n            if (daysToSkip > 0) {\r\n              // \r\n              if (skipCommandMessages.has(Number(message_id))) {\r\n                console.debug(`[]  ${message_id} `);\r\n                return;\r\n              }\r\n\r\n              // \r\n              skipMessageId = Number(message_id);\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:MESSAGE_SENT',\r\n                  message: '/',\r\n                  data: {\r\n                    userInput,\r\n                    daysToSkip,\r\n                    originalInput: userInput,\r\n                    message_id: Number(message_id),\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-skip-rounds',\r\n                  hypothesisId: 'A',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n\r\n              // AI\r\n              try {\r\n                await stopAllGeneration();\r\n                console.info(`[]  `);\r\n\r\n                // #region agent log\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:MESSAGE_SENT',\r\n                    message: 'stopAllGeneration',\r\n                    data: {\r\n                      duringGenerating:\r\n                        typeof builtin !== 'undefined' && builtin.duringGenerating\r\n                          ? builtin.duringGenerating()\r\n                          : 'unknown',\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'fix-skip-rounds',\r\n                    hypothesisId: 'STOP_GEN',\r\n                  }),\r\n                }).catch(() => {}); */\r\n                // #endregion\r\n\r\n                // event_triggered\r\n                const waitForGenerationToStop = (): Promise<void> => {\r\n                  return new Promise(resolve => {\r\n                    let resolved = false;\r\n                    let eventReturn: { stop: () => void } | null = null;\r\n\r\n                    const cleanup = () => {\r\n                      if (eventReturn) {\r\n                        eventReturn.stop();\r\n                        eventReturn = null;\r\n                      }\r\n                    };\r\n\r\n                    //  eventOnce \r\n                    eventReturn = eventOnce(tavern_events.GENERATION_ENDED, () => {\r\n                      if (!resolved) {\r\n                        // 800ms\r\n                        setTimeout(() => {\r\n                          if (!resolved) {\r\n                            resolved = true;\r\n                            clearTimeout(timeout);\r\n                            cleanup();\r\n                            resolve();\r\n                          }\r\n                        }, 800);\r\n                      }\r\n                    });\r\n\r\n                    // 2500msGENERATION_ENDED\r\n                    const timeout = setTimeout(() => {\r\n                      if (!resolved) {\r\n                        resolved = true;\r\n                        cleanup();\r\n                        // #region agent log\r\n                        //  CORS \r\n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                          method: 'POST',\r\n                          headers: { 'Content-Type': 'application/json' },\r\n                          body: JSON.stringify({\r\n                            location: 'core.ts:MESSAGE_SENT',\r\n                            message: '',\r\n                            data: {\r\n                              duringGenerating:\r\n                                typeof builtin !== 'undefined' && builtin.duringGenerating\r\n                                  ? builtin.duringGenerating()\r\n                                  : 'unknown',\r\n                            },\r\n                            timestamp: Date.now(),\r\n                            sessionId: 'debug-session',\r\n                            runId: 'fix-skip-rounds',\r\n                            hypothesisId: 'WAIT_TIMEOUT',\r\n                          }),\r\n                        }).catch(() => {}); */\r\n                        // #endregion\r\n                        resolve();\r\n                      }\r\n                    }, 2500);\r\n\r\n                    // resolve\r\n                    if (typeof builtin === 'undefined' || !builtin.duringGenerating || !builtin.duringGenerating()) {\r\n                      if (!resolved) {\r\n                        resolved = true;\r\n                        clearTimeout(timeout);\r\n                        cleanup();\r\n                        resolve();\r\n                      }\r\n                    }\r\n                  });\r\n                };\r\n\r\n                await waitForGenerationToStop();\r\n\r\n                // \r\n                let finalCheckCount = 0;\r\n                while (\r\n                  typeof builtin !== 'undefined' &&\r\n                  builtin.duringGenerating &&\r\n                  builtin.duringGenerating() &&\r\n                  finalCheckCount < 5\r\n                ) {\r\n                  finalCheckCount++;\r\n                  console.warn(`[]   (${finalCheckCount})`);\r\n                  await stopAllGeneration();\r\n                  // 500ms\r\n                  await new Promise(resolve => setTimeout(resolve, 500));\r\n                }\r\n\r\n                // #region agent log\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:MESSAGE_SENT',\r\n                    message: '',\r\n                    data: {\r\n                      duringGenerating:\r\n                        typeof builtin !== 'undefined' && builtin.duringGenerating\r\n                          ? builtin.duringGenerating()\r\n                          : 'unknown',\r\n                      finalCheckCount,\r\n                      forcedStop: finalCheckCount > 0,\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'fix-skip-rounds',\r\n                    hypothesisId: 'GEN_STOPPED',\r\n                  }),\r\n                }).catch(() => {}); */\r\n                // #endregion\r\n              } catch (stopError) {\r\n                console.warn('[] :', stopError);\r\n              }\r\n\r\n              // USER_MESSAGE_RENDERED\r\n              const checkMessages = getChatMessages(Number(message_id), { role: 'user' });\r\n              const existingMessage = checkMessages[0];\r\n              const alreadyHidden = existingMessage?.is_hidden === true || skipCommandMessages.has(Number(message_id));\r\n\r\n              if (!alreadyHidden) {\r\n                // AI\r\n                try {\r\n                  await setChatMessages([{ message_id: Number(message_id), is_hidden: true, message: '.' }], {\r\n                    refresh: 'all',\r\n                  });\r\n                  skipCommandMessages.add(Number(message_id));\r\n                  console.info(`[]  MESSAGE_SENT (message_id: ${message_id})`);\r\n\r\n                  // #region agent log\r\n                  //  CORS \r\n                  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                      location: 'core.ts:MESSAGE_SENT',\r\n                      message: '',\r\n                      data: {\r\n                        message_id: Number(message_id),\r\n                      },\r\n                      timestamp: Date.now(),\r\n                      sessionId: 'debug-session',\r\n                      runId: 'fix-skip-rounds',\r\n                      hypothesisId: 'DELETE',\r\n                    }),\r\n                  }).catch(() => {}); */\r\n                  // #endregion\r\n                } catch (hideError) {\r\n                  console.warn('[] :', hideError);\r\n                  // #region agent log\r\n                  //  CORS \r\n                  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                      location: 'core.ts:MESSAGE_SENT',\r\n                      message: '',\r\n                      data: {\r\n                        error: hideError instanceof Error ? hideError.message : String(hideError),\r\n                        message_id: Number(message_id),\r\n                      },\r\n                      timestamp: Date.now(),\r\n                      sessionId: 'debug-session',\r\n                      runId: 'fix-skip-rounds',\r\n                      hypothesisId: 'HIDE_ERROR',\r\n                    }),\r\n                  }).catch(() => {}); */\r\n                  // #endregion\r\n                }\r\n              } else {\r\n                console.info(`[] USER_MESSAGE_RENDERED (message_id: ${message_id})`);\r\n              }\r\n\r\n              // \r\n              try {\r\n                const worldbookLoader = DS_CHECK.getModule('worldbook') as {\r\n                  loadWorldbook?: (bookName: string) => Promise<unknown>;\r\n                };\r\n                if (worldbookLoader && worldbookLoader.loadWorldbook) {\r\n                  console.info('[] ');\r\n                  // \r\n                  Promise.all([\r\n                    worldbookLoader.loadWorldbook('environment_descriptions').catch(err => {\r\n                      console.warn('[] :', err);\r\n                    }),\r\n                    worldbookLoader.loadWorldbook('internal_basic_procedures').catch(err => {\r\n                      console.warn('[] :', err);\r\n                    }),\r\n                  ]).catch(() => {\r\n                    // \r\n                  });\r\n                }\r\n              } catch (loadError) {\r\n                console.warn('[] :', loadError);\r\n              }\r\n\r\n              // \r\n              try {\r\n                const result = (DS_CHECK as any).advanceDay(daysToSkip) as {\r\n                  interrupted?: boolean;\r\n                  currentDay?: number;\r\n                  tempCurrentDay?: number;\r\n                  pendingDays?: number;\r\n                  event?: { name?: string; priority?: number };\r\n                };\r\n\r\n                // #region agent log\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:MESSAGE_SENT',\r\n                    message: '/',\r\n                    data: {\r\n                      daysToSkip,\r\n                      result,\r\n                      interrupted: result.interrupted,\r\n                      eventName: result.event?.name,\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'fix-skip-rounds',\r\n                    hypothesisId: 'B',\r\n                  }),\r\n                }).catch(() => {}); */\r\n                // #endregion\r\n\r\n                if (result && result.interrupted && result.event) {\r\n                  // currentDay\r\n                  const eventDay = result.event.day ?? result.tempCurrentDay ?? result.currentDay ?? 0;\r\n                  console.info(`[]  ${daysToSkip} : ${result.event.name} (${eventDay})`);\r\n\r\n                  // #region agent log\r\n                  //  CORS \r\n                  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                      location: 'core.ts:MESSAGE_SENT',\r\n                      message: '',\r\n                      data: {\r\n                        daysToSkip,\r\n                        eventName: result.event.name,\r\n                        eventPriority: result.event.priority,\r\n                        currentDay: result.currentDay,\r\n                        willWaitForEventTriggered: true,\r\n                      },\r\n                      timestamp: Date.now(),\r\n                      sessionId: 'debug-session',\r\n                      runId: 'fix-skip-rounds',\r\n                      hypothesisId: 'INTERRUPTED',\r\n                    }),\r\n                  }).catch(() => {}); */\r\n                  // #endregion\r\n\r\n                  //  advanceDay  DS.events.emit('event_triggered') \r\n                  // event_triggered AI\r\n                  //  event_triggered \r\n                } else {\r\n                  // AI\r\n                  if (result.pendingDays !== undefined && result.pendingDays > 0) {\r\n                    const eventSystem = DS_CHECK.getModule('eventSystem') as {\r\n                      confirmDayAdvancement?: (pendingDays: number) => void;\r\n                    };\r\n                    if (eventSystem && eventSystem.confirmDayAdvancement) {\r\n                      eventSystem.confirmDayAdvancement(result.pendingDays);\r\n                    }\r\n                  }\r\n\r\n                  const finalDay = result.tempCurrentDay ?? result.currentDay ?? 0;\r\n                  console.info(`[]  ${daysToSkip}  ${finalDay} `);\r\n\r\n                  // AI\r\n                  // AI\r\n                  try {\r\n                    await createChatMessages([\r\n                      {\r\n                        role: 'system',\r\n                        message: `[]  ${daysToSkip}  ${finalDay} `,\r\n                        is_hidden: true,\r\n                      },\r\n                    ]);\r\n                  } catch (createError) {\r\n                    console.warn('[] :', createError);\r\n                  }\r\n                }\r\n              } catch (error) {\r\n                console.error('[] :', error);\r\n\r\n                // #region agent log\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:MESSAGE_SENT',\r\n                    message: '',\r\n                    data: {\r\n                      error: error instanceof Error ? error.message : String(error),\r\n                      daysToSkip,\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'fix-skip-rounds',\r\n                    hypothesisId: 'C',\r\n                  }),\r\n                }).catch(() => {}); */\r\n                // #endregion\r\n              }\r\n\r\n              // \r\n              skipMessageId = null;\r\n\r\n              // \r\n              return;\r\n            }\r\n          }\r\n        }\r\n\r\n        //  user_input \r\n        const DS_EMIT = window.detentionSystem;\r\n        if (DS_EMIT && DS_EMIT.events) {\r\n          DS_EMIT.events.emit('user_input', { text: userInput, message_id });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('[] :', error);\r\n    }\r\n  });\r\n\r\n  // \r\n  let waitingForEventResponse = false;\r\n\r\n  console.info('[]  ');\r\n  console.info('[]  MESSAGE_SENT \"X\"');\r\n\r\n  // AI\r\n  const DS_EVENT = window.detentionSystem as DetentionSystem & {\r\n    generateNPC?: (\r\n      count?: number,\r\n      context?: Record<string, unknown>,\r\n    ) => Array<{\r\n      name?: string;\r\n      role?: string;\r\n      age?: number;\r\n      rank?: string;\r\n      type?: string;\r\n      relation?: string;\r\n      relationship?: { influence?: number };\r\n    }>;\r\n    generateNPCForEvent?: (\r\n      eventType: string,\r\n    ) =>\r\n      | { name: string; role?: string; age?: number; rank?: string; type?: string; relation?: string }\r\n      | { police: { name: string; rank?: string }; witnesses: Array<{ name: string }> };\r\n    getCurrentCellNPCs?: () => Array<{ name?: string; relationship?: { influence?: number } }>;\r\n    setCurrentCellNPCs?: (npcs: Array<{ name?: string; relationship?: { influence?: number } }>) => void;\r\n  };\r\n  if (DS_EVENT && DS_EVENT.events) {\r\n    DS_EVENT.events.on('event_triggered', async (eventData?: unknown) => {\r\n      try {\r\n        const event = eventData as\r\n          | {\r\n              id?: string;\r\n              name?: string;\r\n              description?: string;\r\n              type?: string;\r\n              priority?: number;\r\n              day?: number;\r\n              text?: string;\r\n            }\r\n          | undefined;\r\n\r\n        if (!event || !event.name) {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: '',\r\n              data: {\r\n                hasEvent: !!event,\r\n                eventName: event?.name,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-event-trigger',\r\n              hypothesisId: 'B',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          return;\r\n        }\r\n\r\n        //  <= 4\r\n        // LEGAL(1), PROCEDURAL(2), CONDITION(3), RANDOM(4), DAILY(5)\r\n        //  <= 4 AI advanceDay \r\n        const eventPriority = event.priority ?? 5;\r\n        if (eventPriority > 4) {\r\n          console.debug(`[]  ${event.name} AI: ${eventPriority}`);\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: '',\r\n              data: {\r\n                eventName: event.name,\r\n                eventPriority,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-event-trigger',\r\n              hypothesisId: 'C',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          return;\r\n        }\r\n\r\n        // \r\n        //  MESSAGE_SENT \r\n        waitingForEventResponse = true;\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: ' waitingForEventResponse ',\r\n            data: {\r\n              eventName: event.name,\r\n              eventId: event.id,\r\n              waitingForEventResponse: true,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v5',\r\n            hypothesisId: 'SET_FLAG',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        console.info(`[] : ${event.name}AI`);\r\n\r\n        // \r\n        const eventSystem = DS_EVENT.getModule('eventSystem') as {\r\n          currentDay?: number;\r\n          advanceDay?: (days: number) => { accumulatedEvents?: unknown[] };\r\n        };\r\n        //  day \r\n        // eventSystem.currentDay AI\r\n        const currentDay = event.day ?? eventSystem?.currentDay ?? 0;\r\n\r\n        let userInput = '';\r\n\r\n        // \"\"\r\n\r\n        // AI\r\n        const eventText = event.text || event.description || `${event.name}`;\r\n\r\n        // NPCuserInput\r\n        let npcInfoText = '';\r\n        const eventId = event.id || '';\r\n\r\n        // #region agent log - NPC\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered-NPC',\r\n            message: 'NPC',\r\n            data: {\r\n              eventId,\r\n              eventName: event.name,\r\n              hasGenerateNPCForEvent: typeof DS_EVENT.generateNPCForEvent === 'function',\r\n              hasGetCurrentCellNPCs: typeof DS_EVENT.getCurrentCellNPCs === 'function',\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-npc-injection',\r\n            hypothesisId: 'NPC_INJECT_START',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // NPCNPC\r\n        if (\r\n          eventId &&\r\n          [\r\n            'interrogation',\r\n            'lawyer_visit',\r\n            'family_visit',\r\n            'medical_visit',\r\n            'scene_identification',\r\n            'prosecutor_interrogation',\r\n          ].includes(eventId)\r\n        ) {\r\n          try {\r\n            if (typeof DS_EVENT.generateNPCForEvent === 'function') {\r\n              const eventNPC = DS_EVENT.generateNPCForEvent(eventId);\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:event_triggered-NPC',\r\n                  message: 'NPC',\r\n                  data: {\r\n                    eventId,\r\n                    npcType:\r\n                      typeof eventNPC === 'object' && eventNPC !== null\r\n                        ? Array.isArray(eventNPC)\r\n                          ? 'array'\r\n                          : Object.keys(eventNPC)\r\n                        : typeof eventNPC,\r\n                    npcName:\r\n                      typeof eventNPC === 'object' && eventNPC !== null && 'name' in eventNPC\r\n                        ? (eventNPC as { name: string }).name\r\n                        : undefined,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-npc-injection',\r\n                  hypothesisId: 'NPC_GENERATED',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n\r\n              if (eventNPC && typeof eventNPC === 'object') {\r\n                // NPC\r\n                if ('name' in eventNPC && typeof (eventNPC as { name: string }).name === 'string') {\r\n                  const npc = eventNPC as {\r\n                    name: string;\r\n                    role?: string;\r\n                    age?: number;\r\n                    rank?: string;\r\n                    type?: string;\r\n                    relation?: string;\r\n                  };\r\n                  const npcDesc =\r\n                    npc.role === 'police'\r\n                      ? `${npc.name}${npc.rank || ''}`\r\n                      : npc.role === 'lawyer'\r\n                        ? `${npc.name}${npc.type || ''}`\r\n                        : npc.role === 'family'\r\n                          ? `${npc.name}${npc.relation || ''}`\r\n                          : npc.role === 'doctor'\r\n                            ? `${npc.name}`\r\n                            : npc.name;\r\n                  npcInfoText = `\\n\\nNPC${npcDesc}NPC`;\r\n                }\r\n                // NPC\r\n                else if ('police' in eventNPC && 'witnesses' in eventNPC) {\r\n                  const sceneData = eventNPC as {\r\n                    police: { name: string; rank?: string };\r\n                    witnesses: Array<{ name: string }>;\r\n                  };\r\n                  const policeDesc = `${sceneData.police.name}${sceneData.police.rank || ''}`;\r\n                  const witnessesDesc = sceneData.witnesses.map(w => w.name).join('');\r\n                  npcInfoText = `\\n\\nNPC${policeDesc}${witnessesDesc}NPC`;\r\n                }\r\n              }\r\n            }\r\n          } catch (npcError) {\r\n            console.warn('[] NPC:', npcError);\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:event_triggered-NPC',\r\n                message: 'NPC',\r\n                data: {\r\n                  eventId,\r\n                  error: npcError instanceof Error ? npcError.message : String(npcError),\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-npc-injection',\r\n                hypothesisId: 'NPC_GEN_ERROR',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n          }\r\n        }\r\n\r\n        // NPC\r\n        if (eventId === 'cell_transfer') {\r\n          try {\r\n            // \r\n            const eventSystemModule = DS_EVENT.getModule('eventSystem') as\r\n              | {\r\n                  cellType?: string;\r\n                }\r\n              | undefined;\r\n            const targetCellType = (event as { to?: string }).to || eventSystemModule?.cellType || 'pretrial';\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:event_triggered-NPC',\r\n                message: 'NPC',\r\n                data: {\r\n                  eventId: 'cell_transfer',\r\n                  targetCellType,\r\n                  hasGenerateNPC: typeof DS_EVENT.generateNPC === 'function',\r\n                  hasSetCurrentCellNPCs: typeof DS_EVENT.setCurrentCellNPCs === 'function',\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-npc-injection',\r\n                hypothesisId: 'CELL_TRANSFER_START',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n\r\n            // NPCcell_transfer\r\n            if (typeof DS_EVENT.generateNPC === 'function' && typeof DS_EVENT.setCurrentCellNPCs === 'function') {\r\n              const npcCount = Math.floor(Math.random() * 5) + 3; // 3-7\r\n              const newNPCs = DS_EVENT.generateNPC(npcCount, { cellType: targetCellType });\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:event_triggered-NPC',\r\n                  message: 'NPC',\r\n                  data: {\r\n                    eventId: 'cell_transfer',\r\n                    npcCount: Array.isArray(newNPCs) ? newNPCs.length : 0,\r\n                    npcNames: Array.isArray(newNPCs)\r\n                      ? newNPCs.map((npc: { name?: string }) => npc.name).filter(Boolean)\r\n                      : [],\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-npc-injection',\r\n                  hypothesisId: 'CELL_NPC_GENERATED',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n\r\n              if (Array.isArray(newNPCs) && newNPCs.length > 0) {\r\n                // NPCNPC\r\n                DS_EVENT.setCurrentCellNPCs(newNPCs);\r\n                console.info(`[]  ${newNPCs.length}NPC`);\r\n\r\n                // \r\n                const cellBoss = newNPCs.reduce((max, npc) => {\r\n                  const influence = (npc as { relationship?: { influence?: number } }).relationship?.influence ?? 0;\r\n                  const maxInfluence = (max as { relationship?: { influence?: number } }).relationship?.influence ?? 0;\r\n                  return influence > maxInfluence ? npc : max;\r\n                }, newNPCs[0]);\r\n\r\n                const otherNPCs = newNPCs.filter(npc => npc !== cellBoss);\r\n                const cellBossName = (cellBoss as { name?: string }).name || '';\r\n                const otherNames = otherNPCs\r\n                  .map((npc: { name?: string }) => npc.name)\r\n                  .filter(Boolean)\r\n                  .join('');\r\n\r\n                npcInfoText = `\\n\\nNPC${cellBossName}${otherNames || ''}NPC`;\r\n              }\r\n            }\r\n          } catch (cellNPCError) {\r\n            console.warn('[] NPC:', cellNPCError);\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:event_triggered-NPC',\r\n                message: 'NPC',\r\n                data: {\r\n                  eventId: 'cell_transfer',\r\n                  error: cellNPCError instanceof Error ? cellNPCError.message : String(cellNPCError),\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-npc-injection',\r\n                hypothesisId: 'CELL_NPC_ERROR',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n          }\r\n        }\r\n\r\n        // NPCNPC\r\n        // category'random'ID\r\n        const eventCategory = (event as { category?: string }).category;\r\n        if (\r\n          !npcInfoText &&\r\n          (eventCategory === 'random' || event.priority === 4) &&\r\n          typeof DS_EVENT.getCurrentCellNPCs === 'function'\r\n        ) {\r\n          try {\r\n            let cellNPCs = DS_EVENT.getCurrentCellNPCs();\r\n\r\n            // NPC01NPC\r\n            if ((!cellNPCs || (Array.isArray(cellNPCs) && cellNPCs.length === 0)) && currentDay <= 1) {\r\n              console.info('[] NPC');\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:event_triggered-NPC',\r\n                  message: 'NPC',\r\n                  data: {\r\n                    currentDay,\r\n                    eventId,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-npc-injection',\r\n                  hypothesisId: 'INIT_CELL_NPC',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n\r\n              if (typeof DS_EVENT.generateNPC === 'function') {\r\n                const eventSystemModule = DS_EVENT.getModule('eventSystem') as\r\n                  | {\r\n                      cellType?: string;\r\n                    }\r\n                  | undefined;\r\n                const cellType = eventSystemModule?.cellType || 'transition';\r\n                const initialNPCCount = Math.floor(Math.random() * 5) + 3; // 3-7\r\n                const initialNPCs = DS_EVENT.generateNPC(initialNPCCount, { cellType });\r\n\r\n                if (Array.isArray(initialNPCs) && initialNPCs.length > 0) {\r\n                  if (typeof DS_EVENT.setCurrentCellNPCs === 'function') {\r\n                    DS_EVENT.setCurrentCellNPCs(initialNPCs);\r\n                    console.info(`[]  ${initialNPCs.length}NPC`);\r\n                  }\r\n                  cellNPCs = initialNPCs;\r\n                }\r\n              }\r\n            }\r\n\r\n            if (Array.isArray(cellNPCs) && cellNPCs.length > 0) {\r\n              // 1-3NPC\r\n              const selectedNPCs = cellNPCs.sort(() => Math.random() - 0.5).slice(0, Math.min(3, cellNPCs.length));\r\n              const npcNames = selectedNPCs\r\n                .map((npc: { name?: string }) => npc.name)\r\n                .filter(Boolean)\r\n                .join('');\r\n              if (npcNames) {\r\n                npcInfoText = `\\n\\nNPC${npcNames}NPC`;\r\n              }\r\n            }\r\n          } catch (cellNPCError) {\r\n            console.warn('[] NPC:', cellNPCError);\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:event_triggered-NPC',\r\n                message: 'NPC',\r\n                data: {\r\n                  eventId,\r\n                  error: cellNPCError instanceof Error ? cellNPCError.message : String(cellNPCError),\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-npc-injection',\r\n                hypothesisId: 'RANDOM_NPC_ERROR',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n          }\r\n        }\r\n\r\n        // text\"\"\r\n        // \r\n        if (event.text) {\r\n          // \r\n          userInput = `[] ${currentDay}${eventText}${npcInfoText}`;\r\n        } else {\r\n          // text\r\n          userInput = `[] ${currentDay}${eventText}${npcInfoText}`;\r\n        }\r\n\r\n        // #region agent log - NPC\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered-NPC',\r\n            message: 'NPC',\r\n            data: {\r\n              eventId,\r\n              eventName: event.name,\r\n              hasNPCInfo: !!npcInfoText,\r\n              npcInfoLength: npcInfoText.length,\r\n              finalUserInput: userInput.substring(0, 200),\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-npc-injection',\r\n            hypothesisId: 'NPC_INJECT_COMPLETE',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: '',\r\n            data: {\r\n              eventName: event.name,\r\n              currentDay,\r\n              userInput,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-event-description',\r\n            hypothesisId: 'BUILD_DESC',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: 'AI',\r\n            data: {\r\n              eventName: event.name,\r\n              eventId: event.id,\r\n              eventPriority,\r\n              userInput,\r\n              currentDay,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-ai-output',\r\n            hypothesisId: 'A',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        await stopAllGeneration();\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: '',\r\n            data: {\r\n              eventName: event.name,\r\n              duringGenerating:\r\n                typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-ai-output',\r\n            hypothesisId: 'BEFORE_CREATE',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: '',\r\n            data: {\r\n              eventName: event.name,\r\n              eventId: event.id,\r\n              userInputLength: userInput.length,\r\n              waitingForEventResponse,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger',\r\n            hypothesisId: 'HYP-A',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        await stopAllGeneration();\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: '',\r\n            data: {\r\n              eventName: event.name,\r\n              duringGenerating:\r\n                typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n              beforeCreateChatMessages: true,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v4',\r\n            hypothesisId: 'HYP-D',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        //  refresh: 'affected'  MESSAGE_SENT \r\n        // MESSAGE_SENT \r\n        // createChatMessages  MESSAGE_SENT \r\n        const createPromise = createChatMessages(\r\n          [\r\n            {\r\n              role: 'user',\r\n              message: userInput,\r\n              is_hidden: false,\r\n              //  data  MESSAGE_SENT \r\n              data: {\r\n                isSystemEventMessage: true,\r\n                eventId: event.id,\r\n                eventName: event.name,\r\n              },\r\n            },\r\n          ],\r\n          { refresh: 'affected' }, //  'affected'  MESSAGE_SENT \r\n        );\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: 'createChatMessages ',\r\n            data: {\r\n              eventName: event.name,\r\n              duringGenerating:\r\n                typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n              createPromisePending: true,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v4',\r\n            hypothesisId: 'HYP-F',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        await createPromise;\r\n\r\n        // \r\n        //  MESSAGE_SENT \r\n        await new Promise(resolve => setTimeout(resolve, 150)); //  MESSAGE_SENT \r\n        await stopAllGeneration();\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: 'createChatMessages  + ',\r\n            data: {\r\n              eventName: event.name,\r\n              duringGenerating:\r\n                typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n              afterCreateChatMessages: true,\r\n              afterDelay: true,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v4',\r\n            hypothesisId: 'HYP-E',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: 'refresh: affected data ',\r\n            data: {\r\n              eventName: event.name,\r\n              eventId: event.id,\r\n              eventMessageId: getLastMessageId(),\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v2',\r\n            hypothesisId: 'HYP-B',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // message_id/\r\n        //  MESSAGE_SENT \r\n        await new Promise(resolve => setTimeout(resolve, 200));\r\n        const eventMessageId = getLastMessageId();\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: ' MESSAGE_SENT ',\r\n            data: {\r\n              eventName: event.name,\r\n              eventMessageId,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-duplicate-trigger-v2',\r\n            hypothesisId: 'HYP-C',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'core.ts:event_triggered',\r\n            message: '',\r\n            data: {\r\n              userInput,\r\n              duringGenerating:\r\n                typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-ai-output',\r\n            hypothesisId: 'B',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // AI\r\n        try {\r\n          // createChatMessages\r\n          await stopAllGeneration();\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: 'stopAllGeneration',\r\n              data: {\r\n                eventName: event.name,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-ai-output',\r\n              hypothesisId: 'WAIT_STOP_START',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          //  GENERATION_ENDED \r\n          const waitForGenerationToStop = (): Promise<void> => {\r\n            return new Promise(resolve => {\r\n              let resolved = false;\r\n              let eventReturn: { stop: () => void } | null = null;\r\n              let generationStartedReturn: { stop: () => void } | null = null;\r\n              let generationEndedReceived = false;\r\n              let generationStartedCount = 0;\r\n\r\n              const cleanup = () => {\r\n                if (eventReturn) {\r\n                  eventReturn.stop();\r\n                  eventReturn = null;\r\n                }\r\n                if (generationStartedReturn) {\r\n                  generationStartedReturn.stop();\r\n                  generationStartedReturn = null;\r\n                }\r\n              };\r\n\r\n              //  GENERATION_STARTED \r\n              generationStartedReturn = eventOn(\r\n                tavern_events.GENERATION_STARTED,\r\n                async (type: string, options: unknown, dry_run: boolean) => {\r\n                  generationStartedCount++;\r\n                  const now = Date.now();\r\n                  // #region agent log\r\n                  //  CORS \r\n                  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                      location: 'core.ts:event_triggered:waitForGenerationToStop',\r\n                      message: 'tavern_events.GENERATION_STARTED',\r\n                      data: {\r\n                        eventName: event.name,\r\n                        generationStartedCount,\r\n                        type,\r\n                        dry_run,\r\n                        timestamp: now,\r\n                        lastTriggerTime,\r\n                        lastTriggerEventName,\r\n                        timeSinceLastTrigger: lastTriggerTime ? now - lastTriggerTime : null,\r\n                      },\r\n                      timestamp: now,\r\n                      sessionId: 'debug-session',\r\n                      runId: 'track-streaming-gen',\r\n                      hypothesisId: 'NEW_GENERATION_DETECTED_IN_WAIT',\r\n                    }),\r\n                  }).catch(() => {}); */\r\n                  // #endregion\r\n                  await stopAllGeneration();\r\n                },\r\n              );\r\n\r\n              //  eventOnce \r\n              eventReturn = eventOnce(tavern_events.GENERATION_ENDED, () => {\r\n                if (!resolved) {\r\n                  generationEndedReceived = true;\r\n                  // #region agent log\r\n                  //  CORS \r\n                  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                      location: 'core.ts:event_triggered',\r\n                      message: 'GENERATION_ENDED',\r\n                      data: {\r\n                        eventName: event.name,\r\n                        generationStartedCount,\r\n                      },\r\n                      timestamp: Date.now(),\r\n                      sessionId: 'debug-session',\r\n                      runId: 'fix-ai-output',\r\n                      hypothesisId: 'GENERATION_ENDED_RECEIVED',\r\n                    }),\r\n                  }).catch(() => {}); */\r\n                  // #endregion\r\n                  // GENERATION_ENDED\r\n                  setTimeout(() => {\r\n                    if (!resolved) {\r\n                      resolved = true;\r\n                      clearTimeout(timeout);\r\n                      cleanup();\r\n                      resolve();\r\n                    }\r\n                  }, 800); // 800ms\r\n                }\r\n              });\r\n\r\n              // 2000msGENERATION_ENDED\r\n              const timeout = setTimeout(() => {\r\n                if (!resolved) {\r\n                  resolved = true;\r\n                  cleanup();\r\n                  // #region agent log\r\n                  //  CORS \r\n                  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                      location: 'core.ts:event_triggered',\r\n                      message: '',\r\n                      data: {\r\n                        eventName: event.name,\r\n                        generationEndedReceived,\r\n                        generationStartedCount,\r\n                        duringGenerating:\r\n                          typeof builtin !== 'undefined' && builtin.duringGenerating\r\n                            ? builtin.duringGenerating()\r\n                            : 'unknown',\r\n                      },\r\n                      timestamp: Date.now(),\r\n                      sessionId: 'debug-session',\r\n                      runId: 'fix-ai-output',\r\n                      hypothesisId: 'WAIT_TIMEOUT',\r\n                    }),\r\n                  }).catch(() => {}); */\r\n                  // #endregion\r\n                  resolve();\r\n                }\r\n              }, 2500); // 2500ms\r\n            });\r\n          };\r\n\r\n          await waitForGenerationToStop();\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: '',\r\n              data: {\r\n                eventName: event.name,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-ai-output',\r\n              hypothesisId: 'WAIT_STOP_DONE',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          // \r\n          const waitForGenerationToComplete = (): Promise<void> => {\r\n            return new Promise(resolve => {\r\n              // resolve\r\n              if (typeof builtin === 'undefined' || !builtin.duringGenerating || !builtin.duringGenerating()) {\r\n                resolve();\r\n                return;\r\n              }\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:event_triggered',\r\n                  message: '',\r\n                  data: {\r\n                    eventName: event.name,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-ai-output',\r\n                  hypothesisId: 'WAIT_NATURAL_END',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n\r\n              let timeoutHandle: ReturnType<typeof setTimeout> | null = null;\r\n\r\n              //  GENERATION_ENDED \r\n              const eventReturn = eventOnce(tavern_events.GENERATION_ENDED, () => {\r\n                if (timeoutHandle) {\r\n                  clearTimeout(timeoutHandle);\r\n                  timeoutHandle = null;\r\n                }\r\n                // 500ms\r\n                setTimeout(() => {\r\n                  // #region agent log\r\n                  //  CORS \r\n                  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                      location: 'core.ts:event_triggered',\r\n                      message: '',\r\n                      data: {\r\n                        eventName: event.name,\r\n                        duringGenerating:\r\n                          typeof builtin !== 'undefined' && builtin.duringGenerating\r\n                            ? builtin.duringGenerating()\r\n                            : 'unknown',\r\n                      },\r\n                      timestamp: Date.now(),\r\n                      sessionId: 'debug-session',\r\n                      runId: 'fix-ai-output',\r\n                      hypothesisId: 'NATURAL_END',\r\n                    }),\r\n                  }).catch(() => {}); */\r\n                  // #endregion\r\n                  resolve();\r\n                }, 500);\r\n              });\r\n\r\n              // 10\r\n              timeoutHandle = setTimeout(() => {\r\n                eventReturn.stop();\r\n                timeoutHandle = null;\r\n                // #region agent log\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:event_triggered',\r\n                    message: '10',\r\n                    data: {\r\n                      eventName: event.name,\r\n                      duringGenerating:\r\n                        typeof builtin !== 'undefined' && builtin.duringGenerating\r\n                          ? builtin.duringGenerating()\r\n                          : 'unknown',\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'fix-ai-output',\r\n                    hypothesisId: 'NATURAL_END_TIMEOUT',\r\n                  }),\r\n                }).catch(() => {}); */\r\n                // #endregion\r\n                resolve(); // resolve\r\n              }, 10000);\r\n            });\r\n          };\r\n\r\n          await waitForGenerationToComplete();\r\n\r\n          // 3\r\n          let forceStopAttempts = 0;\r\n          while (\r\n            typeof builtin !== 'undefined' &&\r\n            builtin.duringGenerating &&\r\n            builtin.duringGenerating() &&\r\n            forceStopAttempts < 3\r\n          ) {\r\n            forceStopAttempts++;\r\n            console.warn(`[]   (${forceStopAttempts}): ${event.name}`);\r\n            await stopAllGeneration();\r\n            // 500ms\r\n            await new Promise(resolve => setTimeout(resolve, 500));\r\n          }\r\n\r\n          // \r\n          if (typeof builtin !== 'undefined' && builtin.duringGenerating && builtin.duringGenerating()) {\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:event_triggered',\r\n                message: 'AI',\r\n                data: {\r\n                  eventName: event.name,\r\n                  duringGenerating: builtin.duringGenerating(),\r\n                  forceStopAttempts,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-ai-output',\r\n                hypothesisId: 'FORCE_STOP_FAILED',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            console.warn(`[]  AI: ${event.name}`);\r\n            // AI\r\n          }\r\n\r\n          // 300ms\r\n          await new Promise(resolve => setTimeout(resolve, 300));\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: 'AI',\r\n              data: {\r\n                eventName: event.name,\r\n                eventId: event.id,\r\n                eventMessageId: eventMessageId,\r\n                beforeTriggerDuringGenerating:\r\n                  typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-ai-output',\r\n              hypothesisId: 'BEFORE_TRIGGER',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          // AI\r\n          // \r\n          const eventName = event.name;\r\n          const eventId = event.id;\r\n          lastTriggerTime = Date.now();\r\n          lastTriggerEventName = event.name;\r\n          generationTracking.length = 0; // \r\n\r\n          //  triggerSlash \r\n          let messagesBeforeTrigger: Array<{ message_id: number; role: string; messageLength: number }> = [];\r\n          let lastAssistantMessage: { message_id: number; message: string; messageLength: number } | null = null;\r\n          try {\r\n            const allMessages = getChatMessages(-1);\r\n            messagesBeforeTrigger = allMessages.map(m => ({\r\n              message_id: m.message_id || 0,\r\n              role: m.role || 'unknown',\r\n              messageLength: (m.message || '').length,\r\n            }));\r\n\r\n            // \r\n            const assistantMessages = allMessages.filter(m => m.role === 'assistant');\r\n            if (assistantMessages.length > 0) {\r\n              const lastAssistant = assistantMessages[assistantMessages.length - 1];\r\n              lastAssistantMessage = {\r\n                message_id: lastAssistant.message_id || 0,\r\n                message: lastAssistant.message || '',\r\n                messageLength: (lastAssistant.message || '').length,\r\n              };\r\n            }\r\n          } catch (error) {\r\n            console.warn('[]  triggerSlash :', error);\r\n          }\r\n\r\n          // \r\n          // \r\n          const lastAssistantMessageId = lastAssistantMessage?.message_id || null;\r\n          const lastAssistantMessageLength = lastAssistantMessage?.messageLength || 0;\r\n          const lastAssistantMessagePreview = lastAssistantMessage?.message?.substring(0, 100) || '';\r\n          const potentiallyIncompleteMessage =\r\n            lastAssistantMessageId !== null &&\r\n            (lastAssistantMessageLength < 100 || // \r\n              lastAssistantMessagePreview.includes('<thinking>') || // \r\n              lastAssistantMessagePreview.includes('...')); // \r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: ' triggerSlash(/trigger)',\r\n              data: {\r\n                eventName: event.name,\r\n                eventId: event.id,\r\n                eventMessageId: eventMessageId,\r\n                triggerTime: lastTriggerTime,\r\n                beforeTriggerDuringGenerating:\r\n                  typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n                messagesBeforeTrigger: messagesBeforeTrigger.length,\r\n                messageIdsBeforeTrigger: messagesBeforeTrigger.map(m => m.message_id),\r\n                lastAssistantMessageId,\r\n                lastAssistantMessageLength,\r\n                lastAssistantMessagePreview,\r\n                potentiallyIncompleteMessage,\r\n                // \r\n                warning: potentiallyIncompleteMessage\r\n                  ? ''\r\n                  : null,\r\n              },\r\n              timestamp: lastTriggerTime,\r\n              sessionId: 'debug-session',\r\n              runId: 'track-streaming-gen',\r\n              hypothesisId: 'BEFORE_TRIGGER_SLASH',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          await triggerSlash('/trigger');\r\n\r\n          // #region agent log\r\n          const afterTriggerTime = Date.now();\r\n\r\n          //  triggerSlash \r\n          let messagesAfterTrigger: Array<{ message_id: number; role: string; messageLength: number }> = [];\r\n          try {\r\n            // \r\n            await new Promise(resolve => setTimeout(resolve, 100));\r\n            const allMessages = getChatMessages(-1);\r\n            messagesAfterTrigger = allMessages.map(m => ({\r\n              message_id: m.message_id || 0,\r\n              role: m.role || 'unknown',\r\n              messageLength: (m.message || '').length,\r\n            }));\r\n          } catch (error) {\r\n            console.warn('[]  triggerSlash :', error);\r\n          }\r\n\r\n          const newMessages = messagesAfterTrigger.filter(\r\n            m => !messagesBeforeTrigger.some(b => b.message_id === m.message_id),\r\n          );\r\n\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: 'triggerSlash(/trigger) ',\r\n              data: {\r\n                eventName: event.name,\r\n                eventId: event.id,\r\n                eventMessageId: eventMessageId,\r\n                triggerTime: lastTriggerTime,\r\n                afterTriggerTime,\r\n                timeSinceTrigger: afterTriggerTime - lastTriggerTime!,\r\n                generationsTriggered: generationTracking.length,\r\n                afterTriggerDuringGenerating:\r\n                  typeof builtin !== 'undefined' && builtin.duringGenerating ? builtin.duringGenerating() : 'unknown',\r\n                messagesBeforeCount: messagesBeforeTrigger.length,\r\n                messagesAfterCount: messagesAfterTrigger.length,\r\n                newMessagesCount: newMessages.length,\r\n                newMessageIds: newMessages.map(m => m.message_id),\r\n                newAssistantMessages: newMessages.filter(m => m.role === 'assistant'),\r\n                // \r\n                immediatelyCreatedAssistantMessages: newMessages.filter(\r\n                  m =>\r\n                    m.role === 'assistant' &&\r\n                    messagesBeforeTrigger.length > 0 &&\r\n                    m.message_id > Math.max(...messagesBeforeTrigger.map(b => b.message_id)),\r\n                ),\r\n              },\r\n              timestamp: afterTriggerTime,\r\n              sessionId: 'debug-session',\r\n              runId: 'track-streaming-gen',\r\n              hypothesisId: 'AFTER_TRIGGER_SLASH',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          console.info(`[]  AI: ${event.name}`);\r\n\r\n          // AI\r\n          const generationEndHandler = eventOnce(tavern_events.GENERATION_ENDED, (message_id: number) => {\r\n            const endTime = Date.now();\r\n            waitingForEventResponse = false;\r\n            console.debug(`[] AI: ${eventName}`);\r\n\r\n            // \r\n            const relatedMessages = aiMessageTracking.filter(\r\n              m => m.triggerTime === lastTriggerTime && m.eventName === lastTriggerEventName,\r\n            );\r\n\r\n            //  ID \r\n            const messageIdMatched = relatedMessages.some(m => m.message_id === message_id);\r\n\r\n            //  message_id  CHARACTER_MESSAGE_RENDERED \r\n            let messageEndContent: string | null = null;\r\n            let messageEndLength = 0;\r\n            try {\r\n              const messageEnd = getChatMessages(message_id, { role: 'assistant' });\r\n              if (messageEnd && messageEnd.length > 0 && messageEnd[0].message) {\r\n                messageEndContent = messageEnd[0].message;\r\n                messageEndLength = messageEndContent.length;\r\n              }\r\n            } catch (error) {\r\n              // \r\n            }\r\n\r\n            //  message_id 5 \r\n            let message5Content: string | null = null;\r\n            let message5Length = 0;\r\n            let message5Preview: string | null = null;\r\n            try {\r\n              const message5 = getChatMessages(5, { role: 'assistant' });\r\n              if (message5 && message5.length > 0 && message5[0].message) {\r\n                message5Content = message5[0].message;\r\n                message5Length = message5Content.length;\r\n                message5Preview = message5Content.substring(0, 300);\r\n              }\r\n            } catch (error) {\r\n              // \r\n            }\r\n\r\n            //  message_id 5  message_id 5\r\n            // \r\n            const message5ContainsEventContent = message5Content && eventName && message5Content.includes(eventName);\r\n            // \r\n            const message5ContainsSystemEvent =\r\n              message5Content &&\r\n              (message5Content.includes('[]') ||\r\n                (message5Content.includes('') && message5Content.includes('')));\r\n            //  message_id 6  message_id 5  message_id 5\r\n            const contentUpdatedToMessage5 =\r\n              !messageEndContent && (message5ContainsEventContent || message5ContainsSystemEvent);\r\n\r\n            // \r\n            let allAssistantMessages: Array<{ message_id: number; messageLength: number; timestamp?: number }> = [];\r\n            try {\r\n              const allMessages = getChatMessages(-1, { role: 'assistant' });\r\n              allAssistantMessages = allMessages.map(m => ({\r\n                message_id: m.message_id || 0,\r\n                messageLength: (m.message || '').length,\r\n              }));\r\n              //  aiMessageTracking \r\n              allAssistantMessages = allAssistantMessages.map(msg => {\r\n                const tracked = aiMessageTracking.find(t => t.message_id === msg.message_id);\r\n                return { ...msg, timestamp: tracked?.timestamp };\r\n              });\r\n            } catch (error) {\r\n              // \r\n            }\r\n\r\n            // #region agent log -  GENERATION_ENDED \r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'core.ts:event_triggered:GENERATION_ENDED',\r\n                message: 'GENERATION_ENDED ',\r\n                data: {\r\n                  eventName: eventName,\r\n                  eventId: eventId,\r\n                  eventMessageId: eventMessageId,\r\n                  generationEndMessageId: message_id,\r\n                  triggerTime: lastTriggerTime,\r\n                  endTime,\r\n                  timeSinceTrigger: lastTriggerTime ? endTime - lastTriggerTime : null,\r\n                  generationsTracked: generationTracking.length,\r\n                  generationIds: generationTracking.map(g => ({ id: g.generation_id, type: g.type, source: g.source })),\r\n                  relatedMessagesCount: relatedMessages.length,\r\n                  relatedMessageIds: relatedMessages.map(m => m.message_id),\r\n                  totalCharactersInRelatedMessages: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0),\r\n                  messageIdMatched,\r\n                  //  ID  message_id \r\n                  messageEndExists: messageEndContent !== null,\r\n                  messageEndLength,\r\n                  messageEndPreview: messageEndContent ? messageEndContent.substring(0, 200) : null,\r\n                  //  message_id 5 \r\n                  message5Exists: message5Content !== null,\r\n                  message5Length,\r\n                  message5Preview,\r\n                  message5ContainsEventContent,\r\n                  message5ContainsSystemEvent,\r\n                  //  message_id 6  message_id 5  message_id 5\r\n                  contentUpdatedToMessage5,\r\n                  allAssistantMessagesCount: allAssistantMessages.length,\r\n                  allAssistantMessageIds: allAssistantMessages.map(m => m.message_id),\r\n                  assistantMessagesAfterTriggerTime: allAssistantMessages.filter(\r\n                    m => !m.timestamp || (lastTriggerTime && m.timestamp >= lastTriggerTime),\r\n                  ),\r\n                  //  ID \r\n                  potentialMessageSplit: relatedMessages.length > 0 && !messageIdMatched,\r\n                  allTrackedMessages: aiMessageTracking.map(m => ({\r\n                    id: m.message_id,\r\n                    triggerTime: m.triggerTime,\r\n                    eventName: m.eventName,\r\n                    length: m.messageLength,\r\n                    timestamp: m.timestamp,\r\n                  })),\r\n                  // \r\n                  nearbyMessages: aiMessageTracking\r\n                    .filter(m => Math.abs(m.timestamp - endTime) < 5000)\r\n                    .map(m => ({\r\n                      id: m.message_id,\r\n                      length: m.messageLength,\r\n                      timeDiff: Math.abs(m.timestamp - endTime),\r\n                      triggerTime: m.triggerTime,\r\n                      eventName: m.eventName,\r\n                    })),\r\n                },\r\n                timestamp: endTime,\r\n                sessionId: 'debug-session',\r\n                runId: 'track-streaming-gen',\r\n                hypothesisId: 'GEN_ENDED_TRACK',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n\r\n            //  message_id 5 relatedMessages\r\n            if (contentUpdatedToMessage5) {\r\n              //  message_id5 message_id6\r\n              const actualMessageId = 5;\r\n\r\n              console.warn(\r\n                `[]   message_id ${actualMessageId} message_id ${message_id} message_id ${actualMessageId} `,\r\n                {\r\n                  expectedMessageId: message_id,\r\n                  actualMessageId,\r\n                  message5Length,\r\n                  message5ContainsEventContent,\r\n                  message5ContainsSystemEvent,\r\n                  relatedMessagesCount: relatedMessages.length,\r\n                },\r\n              );\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:event_triggered:GENERATION_ENDED',\r\n                  message:\r\n                    '  message_id 5 message_id 6 message_id',\r\n                  data: {\r\n                    eventName: eventName,\r\n                    expectedMessageId: message_id,\r\n                    actualMessageId,\r\n                    trackedMessageIds: relatedMessages.map(m => m.message_id),\r\n                    message5Exists: message5Content !== null,\r\n                    message5Length,\r\n                    message5Preview,\r\n                    message5ContainsEventContent,\r\n                    message5ContainsSystemEvent,\r\n                    contentUpdatedToMessage5: true,\r\n                    allTrackedMessages: aiMessageTracking.map(m => ({\r\n                      id: m.message_id,\r\n                      triggerTime: m.triggerTime,\r\n                      eventName: m.eventName,\r\n                      length: m.messageLength,\r\n                      preview: m.messagePreview.substring(0, 100),\r\n                      timestamp: m.timestamp,\r\n                    })),\r\n                    triggerTime: lastTriggerTime,\r\n                    eventMessageId: eventMessageId,\r\n                    // \r\n                    rootCause:\r\n                      ' message_id 5 GENERATION_ENDED  message_id 6 ',\r\n                    //  message_id  message_id\r\n                    optimization: ' message_id 5  ID ',\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'track-streaming-gen',\r\n                  hypothesisId: 'CONTENT_UPDATED_TO_EXISTING_MESSAGE',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n\r\n              //  message_id \r\n              //  message_id  GENERATION_ENDED  message_id\r\n              //  message_id \r\n            } else if (relatedMessages.length > 0 && !messageIdMatched) {\r\n              //  ID  contentUpdatedToMessage5 \r\n              console.warn(\r\n                `[]   ID GENERATION_ENDED  message_id (${message_id})  CHARACTER_MESSAGE_RENDERED  ID `,\r\n                {\r\n                  generationEndMessageId: message_id,\r\n                  trackedMessageIds: relatedMessages.map(m => m.message_id),\r\n                  allTrackedMessages: aiMessageTracking.map(m => ({\r\n                    id: m.message_id,\r\n                    triggerTime: m.triggerTime,\r\n                    eventName: m.eventName,\r\n                    length: m.messageLength,\r\n                  })),\r\n                },\r\n              );\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:event_triggered:GENERATION_ENDED',\r\n                  message: '  ID ',\r\n                  data: {\r\n                    eventName: eventName,\r\n                    generationEndMessageId: message_id,\r\n                    trackedMessageIds: relatedMessages.map(m => m.message_id),\r\n                    allTrackedMessages: aiMessageTracking.map(m => ({\r\n                      id: m.message_id,\r\n                      triggerTime: m.triggerTime,\r\n                      eventName: m.eventName,\r\n                      length: m.messageLength,\r\n                      preview: m.messagePreview.substring(0, 100),\r\n                      timestamp: m.timestamp,\r\n                    })),\r\n                    triggerTime: lastTriggerTime,\r\n                    eventMessageId: eventMessageId,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'track-streaming-gen',\r\n                  hypothesisId: 'MESSAGE_ID_MISMATCH',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n            } else if (!contentUpdatedToMessage5 && relatedMessages.length > 1) {\r\n              // \r\n              // \r\n              console.warn(\r\n                `[]   \"${lastTriggerEventName}\"  ${relatedMessages.length} `,\r\n                {\r\n                  eventName: lastTriggerEventName,\r\n                  triggerTime: lastTriggerTime,\r\n                  generationEndMessageId: message_id,\r\n                  relatedMessageIds: relatedMessages.map(m => m.message_id),\r\n                  totalLength: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0),\r\n                },\r\n              );\r\n\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'core.ts:event_triggered:GENERATION_ENDED',\r\n                  message: ' ',\r\n                  data: {\r\n                    eventName: lastTriggerEventName,\r\n                    triggerTime: lastTriggerTime,\r\n                    generationEndMessageId: message_id,\r\n                    messageCount: relatedMessages.length,\r\n                    messages: relatedMessages.map(m => ({\r\n                      message_id: m.message_id,\r\n                      messageLength: m.messageLength,\r\n                      timestamp: m.timestamp,\r\n                      timeSinceTrigger: lastTriggerTime ? m.timestamp - lastTriggerTime : null,\r\n                      preview: m.messagePreview,\r\n                    })),\r\n                    totalLength: relatedMessages.reduce((sum, m) => sum + m.messageLength, 0),\r\n                    eventMessageId: eventMessageId,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'track-streaming-gen',\r\n                  hypothesisId: 'MESSAGE_SPLIT_DETECTED_IN_GEN_ENDED',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n            }\r\n\r\n            // AI\r\n            try {\r\n              const eventSystem = DS_EVENT.getModule('eventSystem') as {\r\n                saveStateToChatVars?: () => void;\r\n                saveEventInterruptSnapshot?: () => void;\r\n                confirmDayAdvancement?: (pendingDays: number) => void;\r\n              };\r\n\r\n              // \r\n              const eventWithPending = event as { pendingDayAdvancement?: number };\r\n              if (eventSystem && eventWithPending.pendingDayAdvancement !== undefined) {\r\n                // AI\r\n                if (eventSystem.confirmDayAdvancement) {\r\n                  eventSystem.confirmDayAdvancement(eventWithPending.pendingDayAdvancement);\r\n                }\r\n              }\r\n\r\n              if (eventSystem && eventSystem.saveStateToChatVars) {\r\n                // \r\n                eventSystem.saveStateToChatVars();\r\n                // \r\n                // \"\"\r\n                if (eventSystem.saveEventInterruptSnapshot) {\r\n                  eventSystem.saveEventInterruptSnapshot();\r\n                }\r\n                console.debug('[] AI');\r\n\r\n                // #region agent log\r\n                //  CORS \r\n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    location: 'core.ts:event_triggered',\r\n                    message: 'AI',\r\n                    data: {\r\n                      eventName: event.name,\r\n                    },\r\n                    timestamp: Date.now(),\r\n                    sessionId: 'debug-session',\r\n                    runId: 'fix-snapshot-timing',\r\n                    hypothesisId: 'SAVE_SNAPSHOT_ON_REPLY_END',\r\n                  }),\r\n                }).catch(() => {}); */\r\n                // #endregion\r\n              }\r\n            } catch (error) {\r\n              console.warn('[] AI:', error);\r\n            }\r\n          });\r\n\r\n          // \r\n          const generationStoppedHandler = eventOnce(tavern_events.GENERATION_STOPPED, () => {\r\n            // \r\n            try {\r\n              const messages = getChatMessages(eventMessageId, { role: 'user' });\r\n              if (!messages || messages.length === 0) {\r\n                // \r\n                // \r\n                const eventSystem = DS_EVENT.getModule('eventSystem') as {\r\n                  rollbackToInterruptSnapshot?: () => boolean;\r\n                };\r\n                if (eventSystem && eventSystem.rollbackToInterruptSnapshot) {\r\n                  const rollbackSuccess = eventSystem.rollbackToInterruptSnapshot();\r\n                  if (rollbackSuccess) {\r\n                    console.info(`[]  `);\r\n                    // #region agent log\r\n                    //  CORS \r\n                    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                      method: 'POST',\r\n                      headers: { 'Content-Type': 'application/json' },\r\n                      body: JSON.stringify({\r\n                        location: 'core.ts:event_triggered',\r\n                        message: '',\r\n                        data: {\r\n                          eventName: event.name,\r\n                          eventMessageId,\r\n                        },\r\n                        timestamp: Date.now(),\r\n                        sessionId: 'debug-session',\r\n                        runId: 'add-rollback',\r\n                        hypothesisId: 'ROLLBACK_ON_DELETE',\r\n                      }),\r\n                    }).catch(() => {}); */\r\n                    // #endregion\r\n                  }\r\n                }\r\n              }\r\n            } catch (error) {\r\n              console.warn('[] :', error);\r\n            }\r\n\r\n            waitingForEventResponse = false;\r\n            generationEndHandler.stop();\r\n          });\r\n\r\n          // 30AI\r\n          setTimeout(() => {\r\n            if (waitingForEventResponse) {\r\n              waitingForEventResponse = false;\r\n              generationStoppedHandler.stop();\r\n              console.warn(`[]  30: ${eventName}`);\r\n            }\r\n          }, 30000);\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: 'AI',\r\n              data: { eventName: event.name },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-ai-output',\r\n              hypothesisId: 'C',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        } catch (error) {\r\n          console.error(`[]  AI:`, error);\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'core.ts:event_triggered',\r\n              message: 'AI',\r\n              data: {\r\n                error: error instanceof Error ? error.message : String(error),\r\n                eventName: event.name,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-ai-output',\r\n              hypothesisId: 'D',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        }\r\n      } catch (error) {\r\n        console.error('[] AI:', error);\r\n      }\r\n    });\r\n\r\n    console.info('[] AI');\r\n  }\r\n});\r\n\r\nconsole.info('[] ');\r\nconsole.info('[]   - : ' + new Date().toLocaleTimeString());\r\n\r\n// \r\nconst systemCheck = {\r\n  exists: typeof window.detentionSystem !== 'undefined',\r\n  type: typeof window.detentionSystem,\r\n  value: window.detentionSystem ? 'object' : 'undefined',\r\n  hasPing: window.detentionSystem && typeof (window.detentionSystem as DetentionSystem).ping === 'function',\r\n  pingResult:\r\n    window.detentionSystem && typeof (window.detentionSystem as DetentionSystem).ping === 'function'\r\n      ? (window.detentionSystem as DetentionSystem).ping()\r\n      : 'N/A',\r\n  hasInitializeState:\r\n    window.detentionSystem &&\r\n    typeof (window.detentionSystem as DetentionSystem & { initializeState?: unknown }).initializeState === 'function',\r\n  hasModules: window.detentionSystem && 'modules' in (window.detentionSystem as DetentionSystem),\r\n  modulesCount:\r\n    window.detentionSystem && 'modules' in (window.detentionSystem as DetentionSystem)\r\n      ? Object.keys((window.detentionSystem as DetentionSystem).modules).length\r\n      : 0,\r\n  isIframe: window.parent !== window,\r\n  hasParent: !!window.parent,\r\n  parentHasDetentionSystem:\r\n    window.parent && window.parent !== window\r\n      ? typeof (window.parent as typeof window.parent & { detentionSystem?: DetentionSystem }).detentionSystem !==\r\n        'undefined'\r\n      : 'N/A',\r\n  parentHasDS: window.parent && window.parent !== window ? typeof (window.parent as any).DS !== 'undefined' : 'N/A',\r\n};\r\n\r\nconsole.info('[]  window.detentionSystem:', systemCheck);\r\n\r\n// #region agent log\r\n//  CORS \r\n/* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n  method: 'POST',\r\n  headers: { 'Content-Type': 'application/json' },\r\n  body: JSON.stringify({\r\n    location: 'core.ts:',\r\n    message: '',\r\n    data: systemCheck,\r\n    timestamp: Date.now(),\r\n    sessionId: 'debug-session',\r\n    runId: 'fix-init-failure',\r\n    hypothesisId: 'FINAL_CHECK',\r\n  }),\r\n}).catch(() => {}); */\r\n// #endregion\r\n","export {};\r\n\r\n/**\r\n * \r\n *  registerModule \r\n */\r\n\r\ntype EventPriority = 1 | 2 | 3 | 4 | 5;\r\n\r\ntype Stage =\r\n  | 'detention'\r\n  | 'approval'\r\n  | 'investigation'\r\n  | 'prosecution'\r\n  | 'trial1'\r\n  | 'firstVerdict'\r\n  | 'appeal'\r\n  | 'trial2'\r\n  | 'finalVerdict'\r\n  | 'transfer'\r\n  | 'execution'\r\n  | 'deathReview'\r\n  | 'end';\r\n\r\ninterface EventBus {\r\n  on(event: string, callback: (data?: unknown) => void): void;\r\n  emit(event: string, data?: unknown): void;\r\n}\r\n\r\ninterface EventSystemExports {\r\n  generateRandomEvent?: (context?: unknown) => EventRecord | null;\r\n  advanceDay?: (days?: number) => unknown;\r\n  getCurrentDay?: () => number;\r\n  getCurrentStage?: () => unknown;\r\n  checkCellTransfer?: () => boolean;\r\n  setCaseComplexity?: (complexity: 'simple' | 'normal' | 'complex' | 'very_complex') => void;\r\n  rollbackToStage?: (stage: Stage, reason?: string) => boolean;\r\n  advanceToStage?: (stage: Stage, reason?: string) => boolean;\r\n  setDeathPenalty?: (flag: boolean) => void;\r\n  getEventStatistics?: () => unknown;\r\n  exportTimeline?: () => unknown;\r\n  importTimeline?: (data: unknown) => boolean;\r\n  rollbackToInterruptSnapshot?: () => boolean;\r\n}\r\n\r\ninterface DetentionSystem extends EventSystemExports {\r\n  version: string;\r\n  initialized: boolean;\r\n  modules: Record<string, unknown>;\r\n  config: Record<string, unknown>;\r\n  state: Record<string, unknown>;\r\n  events: EventBus;\r\n  CacheManager: unknown;\r\n  EventEmitter: unknown;\r\n  ping(): boolean;\r\n  checkTokenBudget(): unknown;\r\n  updateTokenUsage(tokens: number): unknown;\r\n  compressContent(content: unknown, quality?: number | null): string;\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n  handleError(error: unknown, context?: string): void;\r\n  detectEnvironment(): unknown;\r\n  initialize(): void;\r\n}\r\n\r\ninterface ProtagonistState {\r\n  health: number;\r\n  mental: number;\r\n  strength?: number;\r\n  intelligence?: number;\r\n}\r\n\r\ninterface Timeline {\r\n  arrestDay: number;\r\n  approvalDay: number | null;\r\n  prosecutionDay: number | null;\r\n  firstTrialDay: number | null;\r\n  firstVerdictDay: number | null;\r\n  secondTrialDay: number | null;\r\n  finalVerdictDay: number | null;\r\n  transferDay: number | null;\r\n  executionDay: number | null;\r\n}\r\n\r\ninterface EventRecord {\r\n  id: string;\r\n  name: string;\r\n  type?: string;\r\n  category?: string;\r\n  description?: string;\r\n  priority?: EventPriority;\r\n  day?: number;\r\n  stage?: Stage;\r\n  isEnding?: boolean;\r\n  endingType?: 'prison' | 'death';\r\n  aiControlled?: boolean;\r\n  text?: string;\r\n  from?: string;\r\n  to?: string;\r\n  reason?: string;\r\n}\r\n\r\ndeclare global {\r\n  interface Window {\r\n    chat?: Array<{ mes?: string }>;\r\n  }\r\n}\r\n\r\ninterface EventSystemImpl {\r\n  currentDay: number;\r\n  lastEventDay: number;\r\n  eventHistory: EventRecord[];\r\n  legalTimeline: Timeline;\r\n  currentStage: Stage;\r\n  cellType: string;\r\n  caseComplexity: 'simple' | 'normal' | 'complex' | 'very_complex';\r\n  complexityMultiplier: number;\r\n  eventCounters: Record<string, number>;\r\n  isDeathPenalty: boolean;\r\n  lastStageChangeDay: number;\r\n  assignedOfficers: { police: string[]; prosecutor: string | null };\r\n  getCurrentDayInternal(this: EventSystemImpl): number;\r\n  readonly PRIORITY: {\r\n    readonly LEGAL: 1;\r\n    readonly PROCEDURAL: 2;\r\n    readonly CONDITION: 3;\r\n    readonly RANDOM: 4;\r\n    readonly DAILY: 5;\r\n  };\r\n  legalEvents: Record<string, unknown>;\r\n  conditionEvents: Array<any>;\r\n  randomEvents: Record<string, Array<{ id: string; name: string; weight: number }>>;\r\n  innerMonologues: Array<{ id: string; text: string; weight: number }>;\r\n  initialize(this: EventSystemImpl, startDay?: number): void;\r\n  setCaseComplexity(this: EventSystemImpl, complexity: 'simple' | 'normal' | 'complex' | 'very_complex'): void;\r\n  checkComplexityAdjustment(this: EventSystemImpl): void;\r\n  rollbackToStage(this: EventSystemImpl, targetStage: Stage, reason?: string): boolean;\r\n  advanceToStage(this: EventSystemImpl, targetStage: Stage, reason?: string): boolean;\r\n  handleUserRollback(this: EventSystemImpl, input: string): boolean;\r\n  advanceDay(\r\n    this: EventSystemImpl,\r\n    days?: number,\r\n  ): {\r\n    interrupted: boolean;\r\n    currentDay: number;\r\n    tempCurrentDay?: number;\r\n    pendingDays?: number;\r\n    event?: EventRecord;\r\n  };\r\n  checkDayEvents(this: EventSystemImpl): EventRecord;\r\n  checkLegalEvent(this: EventSystemImpl): EventRecord | null;\r\n  checkConditionEvent(this: EventSystemImpl): EventRecord | null;\r\n  generateRandomEvent(this: EventSystemImpl): EventRecord | null;\r\n  generateInnerMonologue(this: EventSystemImpl): EventRecord | null;\r\n  weightedRandom(this: EventSystemImpl, count: number, weights: number[]): number;\r\n  getProtagonistState(this: EventSystemImpl): ProtagonistState;\r\n  getRecentContext(this: EventSystemImpl): string;\r\n  checkCellTransfer(this: EventSystemImpl): boolean;\r\n  setDeathPenalty(this: EventSystemImpl, isDeathPenalty: boolean): void;\r\n  getCurrentStageInfo(this: EventSystemImpl): unknown;\r\n  getEventStatistics(this: EventSystemImpl): unknown;\r\n  exportTimeline(this: EventSystemImpl): unknown;\r\n  importTimeline(this: EventSystemImpl, data: any): boolean;\r\n  saveStateToChatVars(this: EventSystemImpl): void;\r\n  saveEventInterruptSnapshot(this: EventSystemImpl): void;\r\n  rollbackToInterruptSnapshot(this: EventSystemImpl): boolean;\r\n  confirmDayAdvancement(this: EventSystemImpl, pendingDays: number): void;\r\n}\r\n\r\nconsole.info('[] ...');\r\n\r\n//  jQuery ready \r\n$(() => {\r\n  const DS_RAW = window.detentionSystem as (DetentionSystem & EventSystemExports) | undefined;\r\n\r\n  // \r\n  let saveStateTimer: ReturnType<typeof setTimeout> | null = null;\r\n  if (!DS_RAW) {\r\n    console.error('[] ');\r\n    console.error('[]  core.ts ');\r\n    return;\r\n  }\r\n\r\n  // DS \r\n  const DS = DS_RAW as DetentionSystem & EventSystemExports;\r\n\r\n  // ==========  ==========\r\n  /**\r\n   * \r\n   * @returns \r\n   */\r\n  function getCurrentDayFromMemoryEnhancement(fallback: number = 0): number {\r\n    try {\r\n      //  statusPanel \r\n      const statusPanel = DS.getModule('statusPanel') as {\r\n        getState?: () => { days?: number; day?: number };\r\n      };\r\n\r\n      if (statusPanel && statusPanel.getState) {\r\n        const state = statusPanel.getState();\r\n        if (state && (state.days !== undefined || state.day !== undefined)) {\r\n          const dayFromMemory = state.days ?? state.day ?? fallback;\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:getCurrentDayFromMemoryEnhancement',\r\n              message: '',\r\n              data: {\r\n                dayFromMemory,\r\n                fallback,\r\n                hasStatusPanel: !!statusPanel,\r\n                stateHasDays: state.days !== undefined,\r\n                stateHasDay: state.day !== undefined,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-day-from-memory',\r\n              hypothesisId: 'GET_DAY_FROM_MEMORY',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          return dayFromMemory;\r\n        }\r\n      }\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:getCurrentDayFromMemoryEnhancement',\r\n          message: '',\r\n          data: {\r\n            fallback,\r\n            hasStatusPanel: !!statusPanel,\r\n            hasGetState: !!(statusPanel && statusPanel.getState),\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-day-from-memory',\r\n          hypothesisId: 'GET_DAY_FALLBACK',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n      return fallback;\r\n    } catch (error) {\r\n      console.warn('[] :', error);\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:getCurrentDayFromMemoryEnhancement',\r\n          message: '',\r\n          data: {\r\n            error: error instanceof Error ? error.message : String(error),\r\n            fallback,\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-day-from-memory',\r\n          hypothesisId: 'GET_DAY_ERROR',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n      return fallback;\r\n    }\r\n  }\r\n\r\n  // ----------------  ----------------\r\n  const EventSystem: EventSystemImpl = {\r\n    currentDay: 0, // \r\n\r\n    /**\r\n     * \r\n     * @returns \r\n     */\r\n    getCurrentDayInternal(): number {\r\n      return getCurrentDayFromMemoryEnhancement(this.currentDay);\r\n    },\r\n\r\n    lastEventDay: 0,\r\n    eventHistory: [] as EventRecord[],\r\n    legalTimeline: {\r\n      arrestDay: 0,\r\n      approvalDay: null,\r\n      prosecutionDay: null,\r\n      firstTrialDay: null,\r\n      firstVerdictDay: null,\r\n      secondTrialDay: null,\r\n      finalVerdictDay: null,\r\n      transferDay: null,\r\n      executionDay: null,\r\n    } as Timeline,\r\n    currentStage: 'detention' as Stage,\r\n    cellType: 'transition',\r\n\r\n    // \r\n    caseComplexity: 'normal' as 'simple' | 'normal' | 'complex' | 'very_complex',\r\n    complexityMultiplier: 1.0,\r\n\r\n    // ID\r\n    eventCounters: {\r\n      interrogation: 0,\r\n      prosecutor_interrogation: 0,\r\n      lawyer_visit: 0,\r\n      family_visit: 0,\r\n      medical_visit: 0,\r\n      scene_identification: 0,\r\n    } as Record<string, number>,\r\n\r\n    // \r\n    isDeathPenalty: false,\r\n\r\n    // \r\n    lastStageChangeDay: 0,\r\n\r\n    // \r\n    assignedOfficers: {\r\n      police: [] as string[],\r\n      prosecutor: null as string | null,\r\n    },\r\n\r\n    // \r\n    // LEGAL: 1 - \r\n    // PROCEDURAL: 2 - \r\n    // CONDITION: 3 - \r\n    // RANDOM: 4 - \r\n    // DAILY: 5 - \r\n    PRIORITY: {\r\n      LEGAL: 1,\r\n      PROCEDURAL: 2,\r\n      CONDITION: 3,\r\n      RANDOM: 4,\r\n      DAILY: 5,\r\n    } as const,\r\n\r\n    // \r\n    legalEvents: {\r\n      approval: {\r\n        name: '',\r\n        minDay: 30,\r\n        maxDay: 37,\r\n        stage: 'approval',\r\n        description: '',\r\n        nextStage: 'investigation',\r\n      },\r\n      investigation: {\r\n        name: '',\r\n        duration: [60, 210],\r\n        stage: 'investigation',\r\n        description: '',\r\n        nextStage: 'prosecution',\r\n      },\r\n      prosecution: {\r\n        name: '',\r\n        duration: [30, 45],\r\n        stage: 'prosecution',\r\n        description: '',\r\n        nextStage: 'trial1',\r\n      },\r\n      firstTrial: {\r\n        name: '',\r\n        duration: [30, 45],\r\n        stage: 'trial1',\r\n        description: '',\r\n        nextStage: 'firstVerdict',\r\n      },\r\n      firstVerdict: {\r\n        name: '',\r\n        duration: [7, 30],\r\n        stage: 'firstVerdict',\r\n        description: '',\r\n        nextStage: 'appeal',\r\n      },\r\n      appeal: {\r\n        name: '',\r\n        duration: [10, 10],\r\n        stage: 'appeal',\r\n        description: '10',\r\n        nextStage: 'trial2',\r\n      },\r\n      secondTrial: {\r\n        name: '',\r\n        duration: [60, 90],\r\n        stage: 'trial2',\r\n        description: '',\r\n        nextStage: 'finalVerdict',\r\n      },\r\n      finalVerdict: {\r\n        name: '',\r\n        duration: [7, 14],\r\n        stage: 'finalVerdict',\r\n        description: '',\r\n        nextStage: 'transfer',\r\n      },\r\n      transfer: {\r\n        name: '',\r\n        duration: [30, 90],\r\n        stage: 'transfer',\r\n        description: '',\r\n        nextStage: 'end',\r\n      },\r\n      deathReview: {\r\n        name: '',\r\n        duration: [180, 720],\r\n        stage: 'deathReview',\r\n        description: '',\r\n        nextStage: 'execution',\r\n      },\r\n      execution: {\r\n        name: '',\r\n        duration: [1, 7],\r\n        stage: 'execution',\r\n        description: '',\r\n        nextStage: 'end',\r\n      },\r\n    },\r\n\r\n    // \r\n    conditionEvents: [\r\n      {\r\n        id: 'mental_breakdown',\r\n        name: '',\r\n        condition: (state: ProtagonistState) => state.mental < 20,\r\n        weight: 100,\r\n        description: '',\r\n        checkAlways: true,\r\n      },\r\n      {\r\n        id: 'health_crisis',\r\n        name: '',\r\n        condition: (state: ProtagonistState) => state.health < 30,\r\n        weight: 100,\r\n        description: '',\r\n        checkAlways: true,\r\n      },\r\n      {\r\n        id: 'major_twist',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (system.currentDay !== system.lastStageChangeDay) return false;\r\n          return Math.random() < 0.15;\r\n        },\r\n        weight: 100,\r\n        description: '',\r\n        stageChangeOnly: true,\r\n      },\r\n      {\r\n        id: 'evidence_reversal',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (system.currentDay !== system.lastStageChangeDay) return false;\r\n          return Math.random() < 0.1;\r\n        },\r\n        weight: 100,\r\n        description: '',\r\n        stageChangeOnly: true,\r\n      },\r\n      {\r\n        id: 'prosecutor_interrogation',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          // 30-37100%+2\r\n          // arrestDayapprovalDaynull30-37\r\n          if (\r\n            system.legalTimeline.arrestDay > 0 &&\r\n            system.legalTimeline.approvalDay === null &&\r\n            system.eventCounters.prosecutor_interrogation === 0\r\n          ) {\r\n            const daysInCustody = system.currentDay - system.legalTimeline.arrestDay;\r\n            const minDays = Math.floor(30 * system.complexityMultiplier);\r\n            const maxDays = Math.floor(37 * system.complexityMultiplier);\r\n\r\n            // 30-37100%\r\n            if (daysInCustody >= minDays && daysInCustody <= maxDays) {\r\n              return true;\r\n            }\r\n          }\r\n          return false;\r\n        },\r\n        weight: 100,\r\n        description: '+2',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'interrogation',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          // 10\r\n          if (system.currentDay <= 10 && system.eventCounters.interrogation === 0) {\r\n            const remainingDays = 10 - system.currentDay + 1;\r\n            const requiredTriggers = 1; // 1\r\n\r\n            // \r\n            if (remainingDays === requiredTriggers) {\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'event_system.ts:interrogation_condition',\r\n                  message: '10',\r\n                  data: {\r\n                    currentDay: system.currentDay,\r\n                    remainingDays,\r\n                    requiredTriggers,\r\n                    interrogationCount: system.eventCounters.interrogation,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'guarantee-interrogation',\r\n                  hypothesisId: 'A',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n              return true;\r\n            }\r\n\r\n            // 10\r\n            // \r\n            const forcedProbability = requiredTriggers / remainingDays; // \r\n            const shouldTrigger = Math.random() < forcedProbability;\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:interrogation_condition',\r\n                message: '10',\r\n                data: {\r\n                  currentDay: system.currentDay,\r\n                  remainingDays,\r\n                  forcedProbability,\r\n                  shouldTrigger,\r\n                  interrogationCount: system.eventCounters.interrogation,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'guarantee-interrogation',\r\n                hypothesisId: 'B',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n\r\n            if (shouldTrigger) {\r\n              return true;\r\n            }\r\n          }\r\n\r\n          //  investigation \r\n          if (system.currentStage !== 'investigation') return false;\r\n\r\n          const daysSinceApproval = system.legalTimeline.approvalDay\r\n            ? system.currentDay - system.legalTimeline.approvalDay\r\n            : 0;\r\n\r\n          let baseProbability = 0.15;\r\n\r\n          if (daysSinceApproval < 30) {\r\n            baseProbability = 0.25;\r\n          } else if (daysSinceApproval < 60) {\r\n            baseProbability = 0.15;\r\n          } else {\r\n            baseProbability = 0.08;\r\n          }\r\n\r\n          const decayFactor = Math.pow(0.7, system.eventCounters.interrogation);\r\n          const finalProbability = baseProbability * decayFactor;\r\n\r\n          return Math.random() < finalProbability;\r\n        },\r\n        weight: 100,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'lawyer_visit',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          //  pretrial  convicted \r\n          if (system.cellType === 'transition') {\r\n            return false;\r\n          }\r\n\r\n          // \r\n          if (!system.eventCounters.interrogation || system.eventCounters.interrogation === 0) {\r\n            return false;\r\n          }\r\n\r\n          let baseProbability = 0.03;\r\n\r\n          const daysInCustody = system.currentDay - system.legalTimeline.arrestDay;\r\n          if (daysInCustody <= 14) {\r\n            baseProbability = 0.15;\r\n          }\r\n\r\n          if (system.legalTimeline.firstTrialDay) {\r\n            const daysToTrial = system.legalTimeline.firstTrialDay - system.currentDay;\r\n            if (daysToTrial > 0 && daysToTrial <= 7) {\r\n              baseProbability = 0.3;\r\n            }\r\n          }\r\n\r\n          if (system.legalTimeline.secondTrialDay) {\r\n            const daysToTrial2 = system.legalTimeline.secondTrialDay - system.currentDay;\r\n            if (daysToTrial2 > 0 && daysToTrial2 <= 7) {\r\n              baseProbability = 0.25;\r\n            }\r\n          }\r\n\r\n          return Math.random() < baseProbability;\r\n        },\r\n        weight: 90,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'family_visit',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          // \r\n          if (!system.legalTimeline.firstVerdictDay) {\r\n            return false;\r\n          }\r\n\r\n          let baseProbability = 0.05;\r\n\r\n          if (system.isDeathPenalty) {\r\n            baseProbability = 0.1;\r\n          }\r\n\r\n          const lastVisit = system.eventHistory\r\n            .filter(e => e.id === 'family_visit')\r\n            .sort((a, b) => (b.day ?? 0) - (a.day ?? 0))[0];\r\n\r\n          if (lastVisit && system.currentDay - (lastVisit.day ?? 0) < 30) {\r\n            return false;\r\n          }\r\n\r\n          return Math.random() < baseProbability;\r\n        },\r\n        weight: 85,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'medical_visit',\r\n        name: '',\r\n        condition: (state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (state.health >= 25) return false;\r\n\r\n          let probability = 0;\r\n          if (state.health < 10) {\r\n            probability = 0.4;\r\n          } else if (state.health < 15) {\r\n            probability = 0.25;\r\n          } else if (state.health < 20) {\r\n            probability = 0.15;\r\n          } else {\r\n            probability = 0.08;\r\n          }\r\n\r\n          const lastMedical = system.eventHistory\r\n            .filter(e => e.id === 'medical_visit')\r\n            .sort((a, b) => (b.day ?? 0) - (a.day ?? 0))[0];\r\n\r\n          if (lastMedical && system.currentDay - (lastMedical.day ?? 0) < 7) {\r\n            return false;\r\n          }\r\n\r\n          return Math.random() < probability;\r\n        },\r\n        weight: 95,\r\n        description: '',\r\n        category: 'procedural',\r\n      },\r\n      {\r\n        id: 'scene_identification',\r\n        name: '',\r\n        condition: (_state: ProtagonistState, system: typeof EventSystem) => {\r\n          if (system.currentStage !== 'investigation') return false;\r\n          if (system.eventCounters.scene_identification > 0) return false;\r\n\r\n          const daysSinceApproval = system.legalTimeline.approvalDay\r\n            ? system.currentDay - system.legalTimeline.approvalDay\r\n            : 0;\r\n\r\n          if (daysSinceApproval < 15 || daysSinceApproval > 120) {\r\n            return false;\r\n          }\r\n\r\n          const baseProbability = 0.08;\r\n\r\n          const recentContext = system.getRecentContext ? system.getRecentContext() : '';\r\n          const keywords = ['', '', '', '', ''];\r\n          const hasKeyword = keywords.some(kw => recentContext.includes(kw));\r\n\r\n          const finalProbability = hasKeyword ? baseProbability * 3 : baseProbability;\r\n\r\n          return Math.random() < finalProbability;\r\n        },\r\n        weight: 80,\r\n        description: '',\r\n        category: 'procedural',\r\n        aiControlled: true,\r\n      },\r\n    ],\r\n\r\n    // \r\n    randomEvents: {\r\n      violence: [\r\n        { id: 'newcomer_bullying', name: '', weight: 30 },\r\n        { id: 'bed_dispute', name: '', weight: 25 },\r\n        { id: 'food_robbery', name: '', weight: 20 },\r\n        { id: 'faction_conflict', name: '', weight: 15 },\r\n        { id: 'revenge', name: '', weight: 10 },\r\n      ],\r\n      medical: [\r\n        { id: 'epidemic', name: '', weight: 15 },\r\n        { id: 'mental_illness', name: '', weight: 25 },\r\n        { id: 'chronic_disease', name: '', weight: 20 },\r\n        { id: 'injury', name: '', weight: 20 },\r\n        { id: 'gynecological', name: '', weight: 10 },\r\n        { id: 'malnutrition', name: '', weight: 10 },\r\n      ],\r\n      emotional: [\r\n        { id: 'deep_friendship', name: '', weight: 20 },\r\n        { id: 'betrayal', name: '', weight: 15 },\r\n        { id: 'motherly_bond', name: '', weight: 15 },\r\n        { id: 'jealousy', name: '', weight: 20 },\r\n        { id: 'secret_sharing', name: '', weight: 15 },\r\n        { id: 'collective_exclusion', name: '', weight: 10 },\r\n        { id: 'romance', name: '', weight: 5 },\r\n      ],\r\n      accident: [\r\n        { id: 'facility_failure', name: '', weight: 25 },\r\n        { id: 'safety_incident', name: '', weight: 20 },\r\n        { id: 'external_news', name: '', weight: 30 },\r\n        { id: 'extreme_weather', name: '', weight: 15 },\r\n        { id: 'management_change', name: '', weight: 10 },\r\n      ],\r\n    },\r\n\r\n    // \r\n    innerMonologues: [\r\n      { id: 'worry_about_family', text: '...', weight: 20 },\r\n      { id: 'regret_past', text: '...', weight: 20 },\r\n      { id: 'fear_future', text: '...', weight: 18 },\r\n      { id: 'miss_freedom', text: '...', weight: 15 },\r\n      { id: 'self_reflection', text: '...', weight: 12 },\r\n      { id: 'hope_for_leniency', text: '...', weight: 10 },\r\n      { id: 'worry_about_children', text: '...', weight: 15 },\r\n      { id: 'fear_of_inmates', text: '...', weight: 12 },\r\n      { id: 'loneliness', text: '...', weight: 15 },\r\n      { id: 'time_perception', text: '...', weight: 10 },\r\n      { id: 'dream_of_past', text: '...', weight: 12 },\r\n      { id: 'worry_about_health', text: '...', weight: 10 },\r\n      { id: 'guilt', text: '...', weight: 8 },\r\n      { id: 'anger', text: '...', weight: 8 },\r\n      { id: 'acceptance', text: '...', weight: 7 },\r\n      { id: 'hope_for_appeal', text: '...', weight: 8 },\r\n      { id: 'fear_of_death', text: '...', weight: 5 },\r\n      { id: 'nostalgia', text: '...', weight: 10 },\r\n    ],\r\n\r\n    // \r\n    initialize(startDay = 0) {\r\n      // \r\n      try {\r\n        // ID saveChat \r\n        const currentChatId =\r\n          typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n        if (!currentChatId) {\r\n          console.debug('[] ');\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:initialize',\r\n              message: '',\r\n              data: {\r\n                hasChatId: false,\r\n                startDay,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-chat-error',\r\n              hypothesisId: 'INIT_LOAD_SKIPPED',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          // \r\n          this.currentDay = startDay;\r\n          this.legalTimeline.arrestDay = startDay;\r\n          this.currentStage = 'detention';\r\n          this.cellType = 'transition';\r\n          this.caseComplexity = 'normal';\r\n          this.complexityMultiplier = 1.0;\r\n          this.isDeathPenalty = false;\r\n          this.lastStageChangeDay = startDay;\r\n          this.lastEventDay = startDay;\r\n\r\n          for (const key of Object.keys(this.eventCounters)) {\r\n            this.eventCounters[key] = 0;\r\n          }\r\n\r\n          // \r\n          this.assignedOfficers = {\r\n            police: [],\r\n            prosecutor: null,\r\n          };\r\n\r\n          console.info('[] ');\r\n          console.info(`[] : ${this.currentDay}`);\r\n          return;\r\n        }\r\n\r\n        // \r\n        let chatVars: Record<string, any> | null = null;\r\n        try {\r\n          chatVars = getVariables({ type: 'chat' });\r\n          // \r\n          if (!chatVars || typeof chatVars !== 'object') {\r\n            throw new Error('');\r\n          }\r\n        } catch (getVarsError) {\r\n          console.debug('[] :', getVarsError);\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:initialize',\r\n              message: '',\r\n              data: {\r\n                error: getVarsError instanceof Error ? getVarsError.message : String(getVarsError),\r\n                startDay,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-chat-error',\r\n              hypothesisId: 'GET_CHAT_VARS_ERROR',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          // \r\n          this.currentDay = startDay;\r\n          this.legalTimeline.arrestDay = startDay;\r\n          this.currentStage = 'detention';\r\n          this.cellType = 'transition';\r\n          this.caseComplexity = 'normal';\r\n          this.complexityMultiplier = 1.0;\r\n          this.isDeathPenalty = false;\r\n          this.lastStageChangeDay = startDay;\r\n          this.lastEventDay = startDay;\r\n\r\n          for (const key of Object.keys(this.eventCounters)) {\r\n            this.eventCounters[key] = 0;\r\n          }\r\n\r\n          console.info('[] ');\r\n          console.info(`[] : ${this.currentDay}`);\r\n          return;\r\n        }\r\n\r\n        if (chatVars && typeof chatVars === 'object') {\r\n          const savedData = (chatVars as Record<string, unknown>).detentionSystemState as\r\n            | {\r\n                currentDay?: number;\r\n                currentStage?: string;\r\n                cellType?: string;\r\n                legalTimeline?: Timeline;\r\n                caseComplexity?: string;\r\n                isDeathPenalty?: boolean;\r\n                eventCounters?: Record<string, number>;\r\n                eventHistory?: EventRecord[];\r\n                lastStageChangeDay?: number;\r\n                assignedOfficers?: { police?: string | string[] | null; prosecutor?: string | null };\r\n              }\r\n            | undefined;\r\n\r\n          if (savedData && typeof savedData === 'object') {\r\n            console.info('[] ');\r\n            this.currentDay = savedData.currentDay ?? startDay;\r\n            this.currentStage = (savedData.currentStage as Stage) ?? 'detention';\r\n            this.cellType = savedData.cellType ?? 'transition';\r\n            this.caseComplexity =\r\n              (savedData.caseComplexity as 'simple' | 'normal' | 'complex' | 'very_complex') ?? 'normal';\r\n            this.isDeathPenalty = Boolean(savedData.isDeathPenalty);\r\n            this.lastStageChangeDay = savedData.lastStageChangeDay ?? startDay;\r\n            this.lastEventDay = this.currentDay;\r\n\r\n            if (savedData.legalTimeline && typeof savedData.legalTimeline === 'object') {\r\n              this.legalTimeline = { ...this.legalTimeline, ...savedData.legalTimeline };\r\n            } else {\r\n              this.legalTimeline.arrestDay = this.currentDay;\r\n            }\r\n\r\n            if (savedData.eventCounters && typeof savedData.eventCounters === 'object') {\r\n              this.eventCounters = { ...this.eventCounters, ...savedData.eventCounters };\r\n            } else {\r\n              for (const key of Object.keys(this.eventCounters)) {\r\n                this.eventCounters[key] = 0;\r\n              }\r\n            }\r\n\r\n            if (Array.isArray(savedData.eventHistory)) {\r\n              this.eventHistory = [...savedData.eventHistory];\r\n            }\r\n\r\n            if (savedData.assignedOfficers && typeof savedData.assignedOfficers === 'object') {\r\n              // policenull\r\n              const savedPolice = savedData.assignedOfficers.police;\r\n              let policeArray: string[] = [];\r\n              if (Array.isArray(savedPolice)) {\r\n                policeArray = savedPolice;\r\n              } else if (typeof savedPolice === 'string' && savedPolice) {\r\n                policeArray = [savedPolice];\r\n              }\r\n\r\n              this.assignedOfficers = {\r\n                police: policeArray,\r\n                prosecutor: savedData.assignedOfficers.prosecutor ?? null,\r\n              };\r\n            } else {\r\n              this.assignedOfficers = {\r\n                police: [],\r\n                prosecutor: null,\r\n              };\r\n            }\r\n\r\n            console.info(`[] : ${this.currentDay}`);\r\n          } else {\r\n            // \r\n            this.currentDay = startDay;\r\n            this.legalTimeline.arrestDay = startDay;\r\n            this.currentStage = 'detention';\r\n            this.cellType = 'transition';\r\n            this.caseComplexity = 'normal';\r\n            this.complexityMultiplier = 1.0;\r\n            this.isDeathPenalty = false;\r\n            this.lastStageChangeDay = startDay;\r\n            this.lastEventDay = startDay;\r\n\r\n            for (const key of Object.keys(this.eventCounters)) {\r\n              this.eventCounters[key] = 0;\r\n            }\r\n          }\r\n        } else {\r\n          // \r\n          this.currentDay = startDay;\r\n          this.legalTimeline.arrestDay = startDay;\r\n          this.currentStage = 'detention';\r\n          this.cellType = 'transition';\r\n          this.caseComplexity = 'normal';\r\n          this.complexityMultiplier = 1.0;\r\n          this.isDeathPenalty = false;\r\n          this.lastStageChangeDay = startDay;\r\n          this.lastEventDay = startDay;\r\n\r\n          for (const key of Object.keys(this.eventCounters)) {\r\n            this.eventCounters[key] = 0;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn('[] :', error);\r\n        // \r\n        this.currentDay = startDay;\r\n        this.legalTimeline.arrestDay = startDay;\r\n        this.currentStage = 'detention';\r\n        this.cellType = 'transition';\r\n        this.caseComplexity = 'normal';\r\n        this.complexityMultiplier = 1.0;\r\n        this.isDeathPenalty = false;\r\n        this.lastStageChangeDay = startDay;\r\n        this.lastEventDay = startDay;\r\n\r\n        for (const key of Object.keys(this.eventCounters)) {\r\n          this.eventCounters[key] = 0;\r\n        }\r\n      }\r\n\r\n      console.info('[] ');\r\n      console.info(`[] : ${this.currentDay}`);\r\n\r\n      // \r\n      // \r\n      setTimeout(() => {\r\n        try {\r\n          // ID\r\n          const currentChatId =\r\n            typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n          if (currentChatId) {\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:initialize',\r\n                message: '',\r\n                data: {\r\n                  currentChatId,\r\n                  currentDay: this.currentDay,\r\n                  hasChatId: !!currentChatId,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-save-conflict',\r\n                hypothesisId: 'INIT_SAVE_DELAYED',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            this.saveStateToChatVars();\r\n          } else {\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:initialize',\r\n                message: 'ID',\r\n                data: {\r\n                  currentDay: this.currentDay,\r\n                  hasChatId: false,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-save-conflict',\r\n                hypothesisId: 'INIT_SAVE_SKIPPED',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            console.debug('[] ID');\r\n          }\r\n        } catch (error) {\r\n          console.warn('[] :', error);\r\n        }\r\n      }, 2000); // 2\r\n\r\n      DS.events.emit('event_system_initialized', {\r\n        day: this.currentDay,\r\n        stage: this.currentStage,\r\n      });\r\n    },\r\n\r\n    // \r\n    saveStateToChatVars() {\r\n      // \r\n      if (saveStateTimer) {\r\n        clearTimeout(saveStateTimer);\r\n        saveStateTimer = null;\r\n      }\r\n\r\n      // 500ms\r\n      // \r\n      saveStateTimer = setTimeout(() => {\r\n        try {\r\n          // ID saveChat \r\n          const currentChatId =\r\n            typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n          if (!currentChatId) {\r\n            console.debug('[] ');\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:saveStateToChatVars',\r\n                message: '',\r\n                data: {\r\n                  hasChatId: false,\r\n                  currentDay: this.currentDay,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-save-chat-error',\r\n                hypothesisId: 'NO_CHAT_SKIP',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            saveStateTimer = null;\r\n            return;\r\n          }\r\n\r\n          const stateData = {\r\n            currentDay: this.currentDay,\r\n            currentStage: this.currentStage,\r\n            cellType: this.cellType,\r\n            legalTimeline: { ...this.legalTimeline },\r\n            caseComplexity: this.caseComplexity,\r\n            isDeathPenalty: this.isDeathPenalty,\r\n            eventCounters: { ...this.eventCounters },\r\n            eventHistory: [...this.eventHistory],\r\n            lastStageChangeDay: this.lastStageChangeDay,\r\n            assignedOfficers: { ...this.assignedOfficers },\r\n          };\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveStateToChatVars',\r\n              message: '',\r\n              data: {\r\n                stateDataSize: JSON.stringify(stateData).length,\r\n                currentDay: this.currentDay,\r\n                currentStage: this.currentStage,\r\n                eventHistoryLength: this.eventHistory.length,\r\n                currentChatId,\r\n                hasChatId: !!currentChatId,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-conflict',\r\n              hypothesisId: 'SAVE_STATE_START',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          //  eventHistory\r\n          const stateDataStr = JSON.stringify(stateData);\r\n          if (stateDataStr.length > 100000) {\r\n            // 50\r\n            console.warn('[] ');\r\n            const truncatedStateData = {\r\n              ...stateData,\r\n              eventHistory: this.eventHistory.slice(-50),\r\n            };\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:saveStateToChatVars',\r\n                message: '',\r\n                data: {\r\n                  originalSize: stateDataStr.length,\r\n                  truncatedSize: JSON.stringify(truncatedStateData).length,\r\n                  originalHistoryLength: this.eventHistory.length,\r\n                  truncatedHistoryLength: truncatedStateData.eventHistory.length,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-save-conflict',\r\n                hypothesisId: 'DATA_TOO_LARGE',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            stateData.eventHistory = truncatedStateData.eventHistory;\r\n          }\r\n\r\n          // \r\n          try {\r\n            const testChatVars = getVariables({ type: 'chat' });\r\n            if (!testChatVars || typeof testChatVars !== 'object') {\r\n              console.debug('[] ');\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'event_system.ts:saveStateToChatVars',\r\n                  message: '',\r\n                  data: {\r\n                    hasChatId: !!currentChatId,\r\n                    hasChatVars: !!testChatVars,\r\n                    chatVarsType: typeof testChatVars,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-save-chat-error',\r\n                  hypothesisId: 'NO_CHAT_VARS',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n              saveStateTimer = null;\r\n              return;\r\n            }\r\n          } catch (testError) {\r\n            console.debug('[] :', testError);\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:saveStateToChatVars',\r\n                message: '',\r\n                data: {\r\n                  hasChatId: !!currentChatId,\r\n                  error: testError instanceof Error ? testError.message : String(testError),\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-save-chat-error',\r\n                hypothesisId: 'TEST_CHAT_VARS_ERROR',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            saveStateTimer = null;\r\n            return;\r\n          }\r\n\r\n          // \r\n          try {\r\n            const testChatVars = getVariables({ type: 'chat' });\r\n            if (!testChatVars || typeof testChatVars !== 'object') {\r\n              console.debug('[] ');\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'event_system.ts:saveStateToChatVars',\r\n                  message: '',\r\n                  data: {\r\n                    hasChatId: !!currentChatId,\r\n                    hasChatVars: !!testChatVars,\r\n                    chatVarsType: typeof testChatVars,\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-save-chat-error',\r\n                  hypothesisId: 'NO_CHAT_VARS',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n              saveStateTimer = null;\r\n              return;\r\n            }\r\n          } catch (testError) {\r\n            console.debug('[] :', testError);\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:saveStateToChatVars',\r\n                message: '',\r\n                data: {\r\n                  hasChatId: !!currentChatId,\r\n                  error: testError instanceof Error ? testError.message : String(testError),\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-save-chat-error',\r\n                hypothesisId: 'TEST_CHAT_VARS_ERROR',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            saveStateTimer = null;\r\n            return;\r\n          }\r\n\r\n          //  updateVariablesWith  replaceVariables\r\n          // \r\n          updateVariablesWith(\r\n            variables => {\r\n              return { ...variables, detentionSystemState: stateData };\r\n            },\r\n            { type: 'chat' },\r\n          );\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveStateToChatVars',\r\n              message: ' (updateVariablesWith)',\r\n              data: {\r\n                success: true,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-conflict',\r\n              hypothesisId: 'SAVE_STATE_SUCCESS',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          console.debug('[]   ()');\r\n        } catch (error) {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveStateToChatVars',\r\n              message: ' (updateVariablesWith)',\r\n              data: {\r\n                error: error instanceof Error ? error.message : String(error),\r\n                errorType: error instanceof Error ? error.constructor.name : typeof error,\r\n                errorStack: error instanceof Error ? error.stack : undefined,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-conflict',\r\n              hypothesisId: 'SAVE_STATE_ERROR',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          console.warn('[]  (updateVariablesWith):', error);\r\n          //  updateVariablesWith  replaceVariables\r\n          // \r\n        }\r\n        saveStateTimer = null;\r\n      }, 500); // 500ms\r\n    },\r\n\r\n    setCaseComplexity(complexity: 'simple' | 'normal' | 'complex' | 'very_complex') {\r\n      const validComplexities: Record<string, number> = {\r\n        simple: 0.8,\r\n        normal: 1.0,\r\n        complex: 1.3,\r\n        very_complex: 1.6,\r\n      };\r\n\r\n      if (complexity in validComplexities) {\r\n        this.caseComplexity = complexity;\r\n        this.complexityMultiplier = validComplexities[complexity];\r\n\r\n        console.info(`[] : ${complexity} (: ${this.complexityMultiplier})`);\r\n\r\n        DS.events.emit('complexity_changed', {\r\n          complexity: this.caseComplexity,\r\n          multiplier: this.complexityMultiplier,\r\n        });\r\n      } else {\r\n        console.warn(`[] : ${complexity}`);\r\n      }\r\n    },\r\n\r\n    checkComplexityAdjustment() {\r\n      if (this.currentDay % 30 !== 0) return;\r\n\r\n      DS.events.emit('request_complexity_assessment', {\r\n        day: this.currentDay,\r\n        stage: this.currentStage,\r\n        eventHistory: this.eventHistory,\r\n      });\r\n    },\r\n\r\n    rollbackToStage(targetStage: Stage, reason = '') {\r\n      console.info(`[] : ${this.currentStage} -> ${targetStage}`);\r\n      console.info(`[] : ${reason}`);\r\n\r\n      const stageOrder: Stage[] = [\r\n        'detention',\r\n        'approval',\r\n        'investigation',\r\n        'prosecution',\r\n        'trial1',\r\n        'firstVerdict',\r\n        'appeal',\r\n        'trial2',\r\n        'finalVerdict',\r\n        'transfer',\r\n        'execution',\r\n      ];\r\n\r\n      const targetIndex = stageOrder.indexOf(targetStage);\r\n      const currentIndex = stageOrder.indexOf(this.currentStage);\r\n\r\n      if (targetIndex === -1 || targetIndex >= currentIndex) {\r\n        console.warn('[] ');\r\n        return false;\r\n      }\r\n\r\n      const timelineKeys: Partial<Record<Stage, keyof Timeline>> = {\r\n        approval: 'approvalDay',\r\n        investigation: 'approvalDay',\r\n        prosecution: 'prosecutionDay',\r\n        trial1: 'firstTrialDay',\r\n        firstVerdict: 'firstVerdictDay',\r\n        appeal: 'firstVerdictDay',\r\n        trial2: 'secondTrialDay',\r\n        finalVerdict: 'finalVerdictDay',\r\n        transfer: 'transferDay',\r\n        execution: 'executionDay',\r\n      };\r\n\r\n      for (let i = targetIndex + 1; i < stageOrder.length; i++) {\r\n        const stage = stageOrder[i];\r\n        const key = timelineKeys[stage];\r\n        if (key && this.legalTimeline[key]) {\r\n          this.legalTimeline[key] = null as never;\r\n        }\r\n      }\r\n\r\n      this.currentStage = targetStage;\r\n\r\n      if (targetIndex <= stageOrder.indexOf('investigation')) {\r\n        this.cellType = 'pretrial';\r\n      }\r\n\r\n      this.eventHistory.push({\r\n        id: 'procedure_rollback',\r\n        name: '',\r\n        type: 'legal',\r\n        day: this.currentDay,\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n      });\r\n\r\n      DS.events.emit('procedure_rollback', {\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n        day: this.currentDay,\r\n      });\r\n\r\n      return true;\r\n    },\r\n\r\n    // \r\n    advanceToStage(targetStage: Stage, reason = '') {\r\n      console.info(`[] : ${this.currentStage} -> ${targetStage}`);\r\n      console.info(`[] : ${reason}`);\r\n\r\n      const stageOrder: Stage[] = [\r\n        'detention',\r\n        'approval',\r\n        'investigation',\r\n        'prosecution',\r\n        'trial1',\r\n        'firstVerdict',\r\n        'appeal',\r\n        'trial2',\r\n        'finalVerdict',\r\n        'transfer',\r\n        'execution',\r\n      ];\r\n\r\n      const targetIndex = stageOrder.indexOf(targetStage);\r\n      const currentIndex = stageOrder.indexOf(this.currentStage);\r\n\r\n      if (targetIndex === -1) {\r\n        console.warn(`[] : ${targetStage}`);\r\n        return false;\r\n      }\r\n\r\n      if (targetIndex <= currentIndex) {\r\n        console.warn(`[]  ${targetStage}  ${this.currentStage} `);\r\n        return false;\r\n      }\r\n\r\n      // \r\n      const timelineKeys: Partial<Record<Stage, keyof Timeline>> = {\r\n        approval: 'approvalDay',\r\n        investigation: 'approvalDay',\r\n        prosecution: 'prosecutionDay',\r\n        trial1: 'firstTrialDay',\r\n        firstVerdict: 'firstVerdictDay',\r\n        appeal: 'firstVerdictDay',\r\n        trial2: 'secondTrialDay',\r\n        finalVerdict: 'finalVerdictDay',\r\n        transfer: 'transferDay',\r\n        execution: 'executionDay',\r\n      };\r\n\r\n      // \r\n      for (let i = currentIndex + 1; i <= targetIndex; i++) {\r\n        const stage = stageOrder[i];\r\n        const key = timelineKeys[stage];\r\n        if (key && !this.legalTimeline[key]) {\r\n          // \r\n          (this.legalTimeline as any)[key] = this.currentDay;\r\n        }\r\n      }\r\n\r\n      // \r\n      this.currentStage = targetStage;\r\n      this.lastStageChangeDay = this.currentDay;\r\n\r\n      // \r\n      // \r\n      if (targetIndex >= stageOrder.indexOf('investigation') && targetIndex < stageOrder.indexOf('firstVerdict')) {\r\n        this.cellType = 'pretrial';\r\n      }\r\n      // \r\n      if (targetIndex >= stageOrder.indexOf('firstVerdict')) {\r\n        this.cellType = 'convicted';\r\n      }\r\n\r\n      // \r\n      if (targetStage === 'execution') {\r\n        this.isDeathPenalty = true;\r\n        // \r\n        this.legalTimeline.executionDay = this.currentDay;\r\n      }\r\n\r\n      // \r\n      this.eventHistory.push({\r\n        id: 'procedure_advance',\r\n        name: '',\r\n        type: 'legal',\r\n        day: this.currentDay,\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n      });\r\n\r\n      // \r\n      this.saveStateToChatVars();\r\n\r\n      // \r\n      DS.events.emit('procedure_advance', {\r\n        from: stageOrder[currentIndex],\r\n        to: targetStage,\r\n        reason,\r\n        day: this.currentDay,\r\n      });\r\n\r\n      console.info(`[]  : ${targetStage} (${this.currentDay})`);\r\n\r\n      return true;\r\n    },\r\n\r\n    handleUserRollback(input: string) {\r\n      const rollbackPatterns = [\r\n        { pattern: /.*?.*?(|||)/, stage: null as Stage | null },\r\n        { pattern: /.*?(|)/, stage: null as Stage | null },\r\n        { pattern: /.*?(|)/, stage: null as Stage | null },\r\n      ];\r\n\r\n      for (const rule of rollbackPatterns) {\r\n        const match = input.match(rule.pattern);\r\n        if (match) {\r\n          let targetStage: Stage | null = null;\r\n\r\n          if (match[1].includes('')) {\r\n            targetStage = 'investigation';\r\n          } else if (match[1].includes('')) {\r\n            targetStage = 'prosecution';\r\n          } else if (match[1].includes('')) {\r\n            targetStage = 'trial1';\r\n          } else if (match[1].includes('')) {\r\n            targetStage = 'trial2';\r\n          }\r\n\r\n          if (targetStage) {\r\n            return this.rollbackToStage(targetStage, '');\r\n          }\r\n        }\r\n      }\r\n\r\n      return false;\r\n    },\r\n\r\n    advanceDay(days = 1) {\r\n      const events: EventRecord[] = [];\r\n      // \r\n      const startDay = this.getCurrentDayInternal();\r\n\r\n      // currentDay\r\n      // AIconfirmDayAdvancement\r\n      // \r\n      let tempCurrentDay = this.getCurrentDayInternal();\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:advanceDay',\r\n          message: '',\r\n          data: { days, daysType: typeof days, startDay: this.currentDay, tempCurrentDay },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-day-calculation',\r\n          hypothesisId: 'A',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      // days>=1\r\n      const daysToAdvance = Math.max(1, Math.floor(days));\r\n\r\n      // LEGAL, PROCEDURAL, CONDITION\r\n      for (let i = 0; i < daysToAdvance; i++) {\r\n        tempCurrentDay++;\r\n        //  this.currentDay\r\n        // AI confirmDayAdvancement \r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:advanceDay',\r\n            message: 'N',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n              tempCurrentDay,\r\n              dayIndex: i,\r\n              daysRemaining: daysToAdvance - i - 1,\r\n              willCheckDay0: tempCurrentDay === 0,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-day0-events',\r\n            hypothesisId: 'HYP-B',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // currentDay\r\n        const originalCurrentDay = this.currentDay;\r\n        this.currentDay = tempCurrentDay;\r\n        this.lastEventDay = tempCurrentDay;\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:advanceDay',\r\n            message: ' - ',\r\n            data: {\r\n              originalCurrentDay,\r\n              tempCurrentDay,\r\n              currentDayBeforeCheck: this.currentDay,\r\n              willSkipDay0: tempCurrentDay === 0,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-day0-events',\r\n            hypothesisId: 'HYP-C',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        this.checkComplexityAdjustment();\r\n\r\n        const dayEvent = this.checkDayEvents();\r\n\r\n        // originalCurrentDayAI\r\n        this.currentDay = originalCurrentDay;\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:advanceDay',\r\n            message: '',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n              tempCurrentDay,\r\n              originalCurrentDay,\r\n              hasEvent: !!dayEvent,\r\n              eventName: dayEvent?.name,\r\n              eventId: dayEvent?.id,\r\n              eventPriority: dayEvent?.priority,\r\n              eventDay: dayEvent?.day,\r\n              isDay0Event: tempCurrentDay === 0 && !!dayEvent,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-day0-events',\r\n            hypothesisId: 'HYP-D',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // 0\r\n        if (tempCurrentDay === 0 && dayEvent && dayEvent.id !== 'no_event') {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:advanceDay',\r\n              message: '0',\r\n              data: {\r\n                eventId: dayEvent.id,\r\n                eventName: dayEvent.name,\r\n                tempCurrentDay,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-day0-events',\r\n              hypothesisId: 'HYP-E',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          continue; // 0\r\n        }\r\n\r\n        if (dayEvent) {\r\n          events.push(dayEvent);\r\n\r\n          this.eventHistory.push({\r\n            ...dayEvent,\r\n            day: tempCurrentDay,\r\n          });\r\n\r\n          if (Object.prototype.hasOwnProperty.call(this.eventCounters, dayEvent.id)) {\r\n            this.eventCounters[dayEvent.id] = (this.eventCounters[dayEvent.id] || 0) + 1;\r\n          }\r\n\r\n          // \r\n          // LEGAL: 1, PROCEDURAL: 2, CONDITION: 3, RANDOM: 4DAILY: 5\r\n          const eventPriority = dayEvent.priority ?? this.PRIORITY.DAILY;\r\n          const shouldInterrupt = eventPriority <= this.PRIORITY.RANDOM;\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:advanceDay',\r\n              message: '',\r\n              data: {\r\n                currentDay: this.currentDay,\r\n                tempCurrentDay,\r\n                eventName: dayEvent.name,\r\n                eventId: dayEvent.id,\r\n                eventPriority,\r\n                PRIORITY_RANDOM: this.PRIORITY.RANDOM,\r\n                shouldInterrupt,\r\n                daysRemaining: daysToAdvance - i - 1,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-interruption-v2',\r\n              hypothesisId: 'D',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          // LEGAL: 1, PROCEDURAL: 2, CONDITION: 3, RANDOM: 4\r\n          // DAILY: 5\r\n          if (shouldInterrupt) {\r\n            console.info(\r\n              `[] ${tempCurrentDay}: ${dayEvent.name} (: ${eventPriority})`,\r\n            );\r\n\r\n            // currentDay\r\n            // AIconfirmDayAdvancement\r\n            // \r\n            const pendingDays = tempCurrentDay - startDay;\r\n\r\n            // currentDay\r\n            this.saveStateToChatVars();\r\n\r\n            // accumulatedEvents\r\n            // \r\n            const eventData = {\r\n              ...dayEvent,\r\n              day: tempCurrentDay, // \r\n              pendingDayAdvancement: pendingDays, // \r\n              startDay, // \r\n            };\r\n            DS.events.emit('event_triggered', eventData);\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:advanceDay',\r\n                message: '',\r\n                data: {\r\n                  currentDay: this.currentDay,\r\n                  tempCurrentDay,\r\n                  startDay,\r\n                  pendingDays,\r\n                  eventName: dayEvent.name,\r\n                  eventPriority,\r\n                  accumulatedEventsCount: events.length,\r\n                  daysSkipped: i + 1,\r\n                  daysRemaining: daysToAdvance - i - 1,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-day-calculation',\r\n                hypothesisId: 'E',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n\r\n            const result = {\r\n              interrupted: true,\r\n              currentDay: this.currentDay, // currentDay\r\n              tempCurrentDay, // \r\n              pendingDays, // \r\n              event: { ...dayEvent, day: tempCurrentDay },\r\n            };\r\n\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:advanceDay',\r\n                message: '',\r\n                data: { currentDay: this.currentDay, eventName: dayEvent.name, result },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-interruption-v2',\r\n                hypothesisId: 'E',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n\r\n            return result;\r\n          } else {\r\n            // DAILY: 5\r\n            // RANDOMDAILY\r\n            console.debug(\r\n              `[] ${tempCurrentDay}: ${dayEvent.name} (: ${eventPriority})`,\r\n            );\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:advanceDay',\r\n                message: '',\r\n                data: {\r\n                  currentDay: this.currentDay,\r\n                  tempCurrentDay,\r\n                  eventName: dayEvent.name,\r\n                  eventPriority,\r\n                  daysRemaining: daysToAdvance - i - 1,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'simplify-date-system',\r\n                hypothesisId: 'F',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n          }\r\n        } else {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:advanceDay',\r\n              message: '',\r\n              data: {\r\n                currentDay: this.currentDay,\r\n                tempCurrentDay,\r\n                daysRemaining: daysToAdvance - i - 1,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'simplify-date-system',\r\n              hypothesisId: 'G',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        }\r\n      }\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:advanceDay',\r\n          message: '',\r\n          data: {\r\n            currentDay: this.currentDay,\r\n            daysAdvanced: daysToAdvance,\r\n            startDay,\r\n            eventsCount: events.length,\r\n            hasInterruptedEvent: events.some(e => (e.priority ?? this.PRIORITY.DAILY) <= this.PRIORITY.CONDITION),\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'simplify-date-system',\r\n          hypothesisId: 'H',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      // LEGAL, PROCEDURAL, CONDITION, RANDOM\r\n      const interruptedEvent = events.find(e => {\r\n        const priority = e.priority ?? this.PRIORITY.DAILY;\r\n        return priority <= this.PRIORITY.RANDOM;\r\n      });\r\n\r\n      // currentDay\r\n      this.saveStateToChatVars();\r\n\r\n      // \r\n      const pendingDays = tempCurrentDay - startDay;\r\n\r\n      // \r\n      if (interruptedEvent) {\r\n        return {\r\n          interrupted: true,\r\n          currentDay: this.currentDay, // currentDay\r\n          tempCurrentDay, // \r\n          pendingDays, // \r\n          event: { ...interruptedEvent, day: tempCurrentDay },\r\n        };\r\n      }\r\n\r\n      // \r\n      // AIconfirmDayAdvancement\r\n      return {\r\n        interrupted: false,\r\n        currentDay: this.currentDay, // currentDay\r\n        tempCurrentDay, // \r\n        pendingDays, // \r\n      };\r\n    },\r\n\r\n    checkDayEvents(): EventRecord {\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:checkDayEvents',\r\n          message: ' - ',\r\n          data: {\r\n            currentDay: this.currentDay,\r\n            shouldSkipDay0: this.currentDay === 0,\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'fix-day0-events',\r\n          hypothesisId: 'HYP-A',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      // 0\r\n      if (this.currentDay === 0) {\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:checkDayEvents',\r\n            message: '0',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-day0-events',\r\n            hypothesisId: 'HYP-A',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n        return {\r\n          id: 'no_event',\r\n          name: '',\r\n          type: 'daily',\r\n          description: '0',\r\n          priority: this.PRIORITY.DAILY,\r\n          day: 0,\r\n        };\r\n      }\r\n\r\n      // \r\n      const currentDate = new Date();\r\n      const month = currentDate.getMonth() + 1;\r\n      const day = currentDate.getDate();\r\n\r\n      // 1. \r\n      const cellTransferResult = this.checkCellTransfer();\r\n      if (cellTransferResult) {\r\n        //  LEGAL\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:checkDayEvents',\r\n            message: '',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n              cellType: this.cellType,\r\n              priority: this.PRIORITY.LEGAL,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-cell-transfer',\r\n            hypothesisId: 'CELL_TRANSFER',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // \r\n        const cellTypeNames: Record<string, string> = {\r\n          transition: '',\r\n          pretrial: '',\r\n          convicted: '',\r\n        };\r\n        const fromCellName = cellTypeNames['transition'] || '';\r\n        const toCellName = cellTypeNames[this.cellType] || '';\r\n\r\n        return {\r\n          id: 'cell_transfer',\r\n          name: '',\r\n          type: 'legal',\r\n          description: `${fromCellName}${toCellName}`,\r\n          priority: this.PRIORITY.LEGAL,\r\n          day: this.currentDay,\r\n          from: 'transition',\r\n          to: this.cellType,\r\n          reason: '',\r\n          text: `${month}${day}`,\r\n        };\r\n      }\r\n\r\n      // 2. \r\n      const legalEvent = this.checkLegalEvent();\r\n      if (legalEvent) {\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:checkDayEvents',\r\n            message: '',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n              eventId: legalEvent.id,\r\n              eventName: legalEvent.name,\r\n              priority: this.PRIORITY.LEGAL,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-interruption',\r\n            hypothesisId: 'C',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n        return {\r\n          ...legalEvent,\r\n          priority: this.PRIORITY.LEGAL,\r\n          day: this.currentDay,\r\n          text: `${month}${day}${legalEvent.name}`,\r\n        };\r\n      }\r\n\r\n      // 3. \r\n      const conditionEvent = this.checkConditionEvent();\r\n      if (conditionEvent) {\r\n        // \r\n        const isProcedural =\r\n          conditionEvent.id === 'interrogation' ||\r\n          conditionEvent.id === 'lawyer_visit' ||\r\n          conditionEvent.id === 'family_visit' ||\r\n          conditionEvent.id === 'prosecutor_interrogation';\r\n\r\n        const eventPriority = isProcedural ? this.PRIORITY.PROCEDURAL : this.PRIORITY.CONDITION;\r\n\r\n        // \r\n        if (conditionEvent.id === 'interrogation' || conditionEvent.id === 'prosecutor_interrogation') {\r\n          const policeNames = ['', '', '', '', '', '', '', ''];\r\n          const prosecutorNames = ['', '', '', '', '', ''];\r\n\r\n          // 30-371+2\r\n          if (conditionEvent.id === 'prosecutor_interrogation') {\r\n            // 22\r\n            if (this.assignedOfficers.police.length < 2) {\r\n              const usedNames = new Set(this.assignedOfficers.police);\r\n              while (this.assignedOfficers.police.length < 2) {\r\n                const availableNames = policeNames.filter(name => !usedNames.has(name));\r\n                if (availableNames.length === 0) break;\r\n                const selectedName = availableNames[Math.floor(Math.random() * availableNames.length)];\r\n                this.assignedOfficers.police.push(selectedName);\r\n                usedNames.add(selectedName);\r\n              }\r\n              console.info(`[] : ${this.assignedOfficers.police.join('')}`);\r\n            }\r\n\r\n            // \r\n            if (!this.assignedOfficers.prosecutor) {\r\n              this.assignedOfficers.prosecutor = prosecutorNames[Math.floor(Math.random() * prosecutorNames.length)];\r\n              console.info(`[] : ${this.assignedOfficers.prosecutor}`);\r\n            }\r\n\r\n            // +2\r\n            conditionEvent.description = `${this.assignedOfficers.prosecutor}${this.assignedOfficers.police.join('')}`;\r\n          }\r\n          // \r\n          else if (conditionEvent.id === 'interrogation') {\r\n            // 2\r\n            if (this.assignedOfficers.police.length < 2) {\r\n              const usedNames = new Set(this.assignedOfficers.police);\r\n              while (this.assignedOfficers.police.length < 2) {\r\n                const availableNames = policeNames.filter(name => !usedNames.has(name));\r\n                if (availableNames.length === 0) break;\r\n                const selectedName = availableNames[Math.floor(Math.random() * availableNames.length)];\r\n                this.assignedOfficers.police.push(selectedName);\r\n                usedNames.add(selectedName);\r\n              }\r\n              console.info(`[] : ${this.assignedOfficers.police.join('')}`);\r\n            }\r\n\r\n            // 50%\r\n            const hasApproval = this.legalTimeline.approvalDay !== null;\r\n            const beforeFirstTrial =\r\n              !this.legalTimeline.firstTrialDay || this.currentDay < this.legalTimeline.firstTrialDay;\r\n            const isInvestigationOrProsecution =\r\n              this.currentStage === 'investigation' || this.currentStage === 'prosecution';\r\n\r\n            if (hasApproval && beforeFirstTrial && isInvestigationOrProsecution && Math.random() < 0.5) {\r\n              // \r\n              if (!this.assignedOfficers.prosecutor) {\r\n                this.assignedOfficers.prosecutor = prosecutorNames[Math.floor(Math.random() * prosecutorNames.length)];\r\n                console.info(`[] : ${this.assignedOfficers.prosecutor}`);\r\n              }\r\n              // 2+\r\n              conditionEvent.description = `${this.assignedOfficers.police.join('')}${this.assignedOfficers.prosecutor}`;\r\n            } else {\r\n              // 2\r\n              conditionEvent.description = `${this.assignedOfficers.police.join('')}`;\r\n            }\r\n          }\r\n        }\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:checkDayEvents',\r\n            message: '',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n              eventId: conditionEvent.id,\r\n              eventName: conditionEvent.name,\r\n              isProcedural,\r\n              priority: eventPriority,\r\n              assignedPolice: this.assignedOfficers.police,\r\n              assignedProsecutor: this.assignedOfficers.prosecutor,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-interruption',\r\n            hypothesisId: 'C',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // LEGALPROCEDURALCONDITION\r\n        const shouldInterrupt = eventPriority <= this.PRIORITY.CONDITION;\r\n\r\n        return {\r\n          ...conditionEvent,\r\n          priority: eventPriority,\r\n          day: this.currentDay,\r\n          text: shouldInterrupt\r\n            ? `${month}${day}${conditionEvent.name}`\r\n            : undefined,\r\n        };\r\n      }\r\n\r\n      // 4. 05%\r\n      if (this.currentDay > 0 && this.cellType !== 'transition' && Math.random() < 0.05) {\r\n        const randomEvent = this.generateRandomEvent();\r\n        if (randomEvent) {\r\n          return {\r\n            ...randomEvent,\r\n            priority: this.PRIORITY.RANDOM,\r\n            day: this.currentDay,\r\n            text: `${month}${day}${randomEvent.name}`,\r\n          };\r\n        }\r\n      }\r\n\r\n      // 5. \r\n      if (Math.random() < 0.15) {\r\n        const monologue = this.generateInnerMonologue();\r\n        if (monologue) {\r\n          return {\r\n            ...monologue,\r\n            priority: this.PRIORITY.DAILY,\r\n            day: this.currentDay,\r\n          };\r\n        }\r\n      }\r\n\r\n      // 6. \r\n      return {\r\n        id: 'daily_routine',\r\n        name: '',\r\n        type: 'daily',\r\n        priority: this.PRIORITY.DAILY,\r\n        day: this.currentDay,\r\n        description: '',\r\n      };\r\n    },\r\n\r\n    checkLegalEvent(): EventRecord | null {\r\n      const daysInCustody = this.currentDay - this.legalTimeline.arrestDay;\r\n      const stageBefore = this.currentStage;\r\n\r\n      if (!this.legalTimeline.approvalDay) {\r\n        const minDays = Math.floor(30 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(37 * this.complexityMultiplier);\r\n\r\n        if (daysInCustody >= minDays && daysInCustody <= maxDays) {\r\n          if (Math.random() < 0.3) {\r\n            this.legalTimeline.approvalDay = this.currentDay;\r\n            this.currentStage = 'investigation';\r\n            this.lastStageChangeDay = this.currentDay;\r\n            return {\r\n              id: 'approval',\r\n              name: '',\r\n              type: 'legal',\r\n              stage: 'approval',\r\n              description: '',\r\n              from: stageBefore,\r\n              to: 'investigation',\r\n            };\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.approvalDay && !this.legalTimeline.prosecutionDay) {\r\n        const daysSinceApproval = this.currentDay - this.legalTimeline.approvalDay;\r\n        const minDays = Math.floor(60 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(210 * this.complexityMultiplier);\r\n\r\n        if (daysSinceApproval >= minDays && daysSinceApproval <= maxDays && Math.random() < 0.02) {\r\n          this.legalTimeline.prosecutionDay = this.currentDay;\r\n          this.currentStage = 'prosecution';\r\n          this.lastStageChangeDay = this.currentDay;\r\n          return {\r\n            id: 'prosecution',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'prosecution',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'prosecution',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.prosecutionDay && !this.legalTimeline.firstTrialDay) {\r\n        const daysSinceProsecution = this.currentDay - this.legalTimeline.prosecutionDay;\r\n        const minDays = Math.floor(30 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(45 * this.complexityMultiplier);\r\n\r\n        if (daysSinceProsecution >= minDays && daysSinceProsecution <= maxDays && Math.random() < 0.05) {\r\n          this.legalTimeline.firstTrialDay = this.currentDay;\r\n          this.currentStage = 'trial1';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          if (this.cellType === 'transition') {\r\n            this.cellType = 'pretrial';\r\n            DS.events.emit('cell_transfer', {\r\n              from: 'transition',\r\n              to: 'pretrial',\r\n              reason: '',\r\n            });\r\n          }\r\n\r\n          return {\r\n            id: 'first_trial',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'trial1',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'trial1',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.firstTrialDay && !this.legalTimeline.firstVerdictDay) {\r\n        const daysSinceTrial = this.currentDay - this.legalTimeline.firstTrialDay;\r\n        const minDays = Math.floor(7 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(30 * this.complexityMultiplier);\r\n\r\n        if (daysSinceTrial >= minDays && daysSinceTrial <= maxDays && Math.random() < 0.1) {\r\n          this.legalTimeline.firstVerdictDay = this.currentDay;\r\n          this.currentStage = 'appeal';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          this.cellType = 'convicted';\r\n          DS.events.emit('cell_transfer', {\r\n            from: 'pretrial',\r\n            to: 'convicted',\r\n            reason: '',\r\n          });\r\n\r\n          return {\r\n            id: 'first_verdict',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'firstVerdict',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'appeal',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (\r\n        this.legalTimeline.firstVerdictDay &&\r\n        !this.legalTimeline.secondTrialDay &&\r\n        !this.legalTimeline.finalVerdictDay\r\n      ) {\r\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.firstVerdictDay;\r\n\r\n        if (daysSinceVerdict === 10) {\r\n          if (Math.random() < 0.7) {\r\n            this.legalTimeline.secondTrialDay = this.currentDay;\r\n            this.currentStage = 'trial2';\r\n            this.lastStageChangeDay = this.currentDay;\r\n\r\n            return {\r\n              id: 'appeal_filed',\r\n              name: '',\r\n              type: 'legal',\r\n              stage: 'appeal',\r\n              description: '',\r\n              from: stageBefore,\r\n              to: 'trial2',\r\n            };\r\n          } else {\r\n            this.legalTimeline.finalVerdictDay = this.currentDay;\r\n            this.currentStage = 'transfer';\r\n            this.lastStageChangeDay = this.currentDay;\r\n\r\n            return {\r\n              id: 'verdict_final',\r\n              name: '',\r\n              type: 'legal',\r\n              stage: 'finalVerdict',\r\n              description: '',\r\n              from: stageBefore,\r\n              to: 'transfer',\r\n            };\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.secondTrialDay && !this.legalTimeline.finalVerdictDay) {\r\n        const daysSinceAppeal = this.currentDay - this.legalTimeline.secondTrialDay;\r\n        const minDays = Math.floor(60 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(90 * this.complexityMultiplier);\r\n\r\n        if (daysSinceAppeal >= minDays && daysSinceAppeal <= maxDays && Math.random() < 0.03) {\r\n          this.legalTimeline.finalVerdictDay = this.currentDay;\r\n          this.currentStage = 'transfer';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          return {\r\n            id: 'final_verdict',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'finalVerdict',\r\n            description: '',\r\n            from: stageBefore,\r\n            to: 'transfer',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.finalVerdictDay && !this.legalTimeline.transferDay && !this.isDeathPenalty) {\r\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.finalVerdictDay;\r\n        const minDays = Math.floor(30 * this.complexityMultiplier);\r\n        const maxDays = Math.floor(90 * this.complexityMultiplier);\r\n\r\n        if (daysSinceVerdict >= minDays && daysSinceVerdict <= maxDays && Math.random() < 0.02) {\r\n          this.legalTimeline.transferDay = this.currentDay;\r\n          this.currentStage = 'end';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          return {\r\n            id: 'transfer_prison',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'transfer',\r\n            description: '',\r\n            isEnding: true,\r\n            endingType: 'prison',\r\n            from: stageBefore,\r\n            to: 'end',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.finalVerdictDay && this.isDeathPenalty && !this.legalTimeline.executionDay) {\r\n        const daysSinceVerdict = this.currentDay - this.legalTimeline.finalVerdictDay;\r\n        const minDays = 180;\r\n        const maxDays = 720;\r\n\r\n        if (daysSinceVerdict >= minDays && daysSinceVerdict <= maxDays && Math.random() < 0.005) {\r\n          this.legalTimeline.executionDay = this.currentDay + 7;\r\n          this.currentStage = 'execution';\r\n          this.lastStageChangeDay = this.currentDay;\r\n\r\n          return {\r\n            id: 'death_review_approved',\r\n            name: '',\r\n            type: 'legal',\r\n            stage: 'deathReview',\r\n            description: '7',\r\n            from: stageBefore,\r\n            to: 'execution',\r\n          };\r\n        }\r\n      }\r\n\r\n      if (this.legalTimeline.executionDay && this.currentDay >= this.legalTimeline.executionDay) {\r\n        this.currentStage = 'end';\r\n        this.lastStageChangeDay = this.currentDay;\r\n\r\n        return {\r\n          id: 'execution',\r\n          name: '',\r\n          type: 'legal',\r\n          stage: 'execution',\r\n          description: '',\r\n          isEnding: true,\r\n          endingType: 'death',\r\n          from: stageBefore,\r\n          to: 'end',\r\n        };\r\n      }\r\n\r\n      return null;\r\n    },\r\n\r\n    checkConditionEvent(): EventRecord | null {\r\n      const state = this.getProtagonistState();\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:checkConditionEvent',\r\n          message: '',\r\n          data: {\r\n            currentDay: this.currentDay,\r\n            stateHealth: state.health,\r\n            stateMental: state.mental,\r\n            stateStrength: state.strength,\r\n            stateIntelligence: state.intelligence,\r\n            conditionEventsCount: this.conditionEvents.length,\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'check-status-dependency',\r\n          hypothesisId: 'E',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      for (const event of this.conditionEvents) {\r\n        if (event.stageChangeOnly && this.currentDay !== this.lastStageChangeDay) {\r\n          continue;\r\n        }\r\n\r\n        if (event.checkAlways || !event.stageChangeOnly) {\r\n          const conditionResult = event.condition(state, this);\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:checkConditionEvent',\r\n              message: '',\r\n              data: {\r\n                eventId: event.id,\r\n                eventName: event.name,\r\n                conditionResult,\r\n                stateHealth: state.health,\r\n                stateMental: state.mental,\r\n                stateStrength: state.strength,\r\n                stateIntelligence: state.intelligence,\r\n                eventWeight: event.weight,\r\n                dependsOnStatusPanel: ['mental_breakdown', 'health_crisis', 'medical_visit'].includes(event.id),\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'check-status-dependency',\r\n              hypothesisId: 'F',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          if (conditionResult) {\r\n            const randomCheck = Math.random() * 100 < event.weight;\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:checkConditionEvent',\r\n                message: '',\r\n                data: {\r\n                  eventId: event.id,\r\n                  eventName: event.name,\r\n                  conditionResult,\r\n                  randomCheck,\r\n                  randomValue: Math.random() * 100,\r\n                  eventWeight: event.weight,\r\n                  willTrigger: randomCheck,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'check-status-dependency',\r\n                hypothesisId: 'G',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n\r\n            if (randomCheck) {\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'event_system.ts:checkConditionEvent',\r\n                  message: '',\r\n                  data: {\r\n                    eventId: event.id,\r\n                    eventName: event.name,\r\n                    stateHealth: state.health,\r\n                    stateMental: state.mental,\r\n                    dependsOnStatusPanel: ['mental_breakdown', 'health_crisis', 'medical_visit'].includes(event.id),\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'check-status-dependency',\r\n                  hypothesisId: 'H',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n\r\n              return {\r\n                id: event.id,\r\n                name: event.name,\r\n                type: event.category || 'condition',\r\n                description: event.description,\r\n                aiControlled: event.aiControlled || false,\r\n              };\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      return null;\r\n    },\r\n\r\n    generateRandomEvent(): EventRecord | null {\r\n      const types = ['violence', 'medical', 'emotional', 'accident'] as const;\r\n      const weights = [25, 30, 30, 15];\r\n\r\n      const typeIndex = this.weightedRandom(types.length, weights);\r\n      const eventType = types[typeIndex];\r\n      const eventList = this.randomEvents[eventType];\r\n\r\n      const eventWeights = eventList.map(e => e.weight);\r\n      const eventIndex = this.weightedRandom(eventList.length, eventWeights);\r\n      const event = eventList[eventIndex];\r\n\r\n      return {\r\n        id: event.id,\r\n        name: event.name,\r\n        type: eventType,\r\n        category: 'random',\r\n        description: `: ${event.name}`,\r\n      };\r\n    },\r\n\r\n    generateInnerMonologue(): EventRecord | null {\r\n      const weights = this.innerMonologues.map(m => m.weight);\r\n      const index = this.weightedRandom(this.innerMonologues.length, weights);\r\n      const monologue = this.innerMonologues[index];\r\n\r\n      return {\r\n        id: monologue.id,\r\n        name: '',\r\n        type: 'monologue',\r\n        category: 'daily',\r\n        description: monologue.text,\r\n        text: monologue.text,\r\n      };\r\n    },\r\n\r\n    weightedRandom(count: number, weights: number[]): number {\r\n      const totalWeight = weights.reduce((sum, w) => sum + w, 0);\r\n      let random = Math.random() * totalWeight;\r\n\r\n      for (let i = 0; i < count; i++) {\r\n        random -= weights[i];\r\n        if (random <= 0) {\r\n          return i;\r\n        }\r\n      }\r\n\r\n      return count - 1;\r\n    },\r\n\r\n    getProtagonistState(): ProtagonistState {\r\n      // \r\n      console.log('[] getProtagonistState: ');\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:getProtagonistState',\r\n          message: '',\r\n          data: {\r\n            hasDS: !!DS,\r\n            hasGetModule: typeof DS?.getModule === 'function',\r\n            codeVersion: 'memory-enhancement-integration-v1',\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'memory-enhancement-integration',\r\n          hypothesisId: 'A',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      //  getState()\r\n      //  >  >  > \r\n      const statusPanel = DS.getModule<{ getState?: () => ProtagonistState }>('statusPanel');\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:getProtagonistState',\r\n          message: '',\r\n          data: {\r\n            hasStatusPanel: !!statusPanel,\r\n            hasGetState: !!(statusPanel && statusPanel.getState),\r\n            statusPanelType: typeof statusPanel,\r\n            willUseFallback: !(statusPanel && statusPanel.getState),\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'memory-enhancement-integration',\r\n          hypothesisId: 'B',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      if (statusPanel && statusPanel.getState) {\r\n        const state = statusPanel.getState();\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:getProtagonistState',\r\n            message: '',\r\n            data: {\r\n              health: state.health,\r\n              mental: state.mental,\r\n              strength: state.strength,\r\n              intelligence: state.intelligence,\r\n              source: 'statusPanel (with memory enhancement integration)',\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'memory-enhancement-integration',\r\n            hypothesisId: 'C',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n        // \r\n        return state;\r\n      }\r\n\r\n      // \r\n      const fallbackState: ProtagonistState = {\r\n        health: 70,\r\n        mental: 65,\r\n        strength: 50,\r\n        intelligence: 55,\r\n        //  undefined ProtagonistState \r\n      };\r\n\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'event_system.ts:getProtagonistState',\r\n          message: '',\r\n          data: {\r\n            ...fallbackState,\r\n            source: 'fallback',\r\n            warning: '',\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'memory-enhancement-integration',\r\n          hypothesisId: 'D',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n\r\n      console.warn('[] ');\r\n      return fallbackState;\r\n    },\r\n\r\n    getRecentContext(): string {\r\n      if (Array.isArray(window.chat)) {\r\n        const recentMessages = window.chat.slice(-5);\r\n        return recentMessages.map(m => m.mes || '').join(' ');\r\n      }\r\n      return '';\r\n    },\r\n\r\n    checkCellTransfer() {\r\n      const daysInCustody = this.currentDay - this.legalTimeline.arrestDay;\r\n\r\n      // \r\n      if (this.cellType === 'transition' && daysInCustody >= 7 && daysInCustody <= 14) {\r\n        this.cellType = 'pretrial';\r\n        DS.events.emit('cell_transfer', {\r\n          from: 'transition',\r\n          to: 'pretrial',\r\n          reason: '',\r\n          day: this.currentDay,\r\n        });\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    },\r\n\r\n    setDeathPenalty(isDeathPenalty: boolean) {\r\n      this.isDeathPenalty = isDeathPenalty;\r\n      console.info(`[] : ${isDeathPenalty}`);\r\n\r\n      DS.events.emit('death_penalty_status_changed', {\r\n        isDeathPenalty: this.isDeathPenalty,\r\n        day: this.currentDay,\r\n      });\r\n    },\r\n\r\n    getCurrentStageInfo() {\r\n      // \r\n      const cellTypeNames: Record<string, string> = {\r\n        transition: '',\r\n        pretrial: '',\r\n        convicted: '',\r\n      };\r\n      const cellTypeChinese = cellTypeNames[this.cellType] || '';\r\n\r\n      return {\r\n        day: this.currentDay,\r\n        stage: this.currentStage,\r\n        cellType: cellTypeChinese,\r\n        cellTypeRaw: this.cellType, // \r\n        daysInCustody: this.currentDay - this.legalTimeline.arrestDay,\r\n        timeline: { ...this.legalTimeline },\r\n        complexity: this.caseComplexity,\r\n        complexityMultiplier: this.complexityMultiplier,\r\n        isDeathPenalty: this.isDeathPenalty,\r\n        eventCounters: { ...this.eventCounters },\r\n      };\r\n    },\r\n\r\n    getEventStatistics() {\r\n      const stats: {\r\n        totalEvents: number;\r\n        byType: Record<string, number>;\r\n        byPriority: Record<number, number>;\r\n        recentEvents: EventRecord[];\r\n      } = {\r\n        totalEvents: this.eventHistory.length,\r\n        byType: {},\r\n        byPriority: {},\r\n        recentEvents: this.eventHistory.slice(-10),\r\n      };\r\n\r\n      this.eventHistory.forEach((event: EventRecord) => {\r\n        const type = event.type || 'unknown';\r\n        stats.byType[type] = (stats.byType[type] || 0) + 1;\r\n\r\n        const priority = event.priority || 4;\r\n        stats.byPriority[priority] = (stats.byPriority[priority] || 0) + 1;\r\n      });\r\n\r\n      return stats;\r\n    },\r\n\r\n    exportTimeline() {\r\n      return {\r\n        currentDay: this.currentDay,\r\n        currentStage: this.currentStage,\r\n        cellType: this.cellType,\r\n        timeline: { ...this.legalTimeline },\r\n        complexity: this.caseComplexity,\r\n        isDeathPenalty: this.isDeathPenalty,\r\n        eventCounters: { ...this.eventCounters },\r\n        eventHistory: [...this.eventHistory],\r\n        lastStageChangeDay: this.lastStageChangeDay,\r\n      };\r\n    },\r\n\r\n    importTimeline(data: any) {\r\n      if (!data) return false;\r\n\r\n      try {\r\n        this.currentDay = data.currentDay || 0;\r\n        this.currentStage = (data.currentStage as Stage) || 'detention';\r\n        this.cellType = data.cellType || 'transition';\r\n        this.legalTimeline = (data.timeline as Timeline) || ({} as Timeline);\r\n        this.caseComplexity = data.complexity || 'normal';\r\n        this.isDeathPenalty = Boolean(data.isDeathPenalty);\r\n        this.eventCounters = data.eventCounters || {};\r\n        this.eventHistory = data.eventHistory || [];\r\n        this.lastStageChangeDay = data.lastStageChangeDay || 0;\r\n\r\n        console.info('[] ');\r\n        return true;\r\n      } catch (error) {\r\n        console.error('[] :', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    // \r\n    // advanceDay\"\"\r\n    // AIsaveStateToChatVars\r\n    saveEventInterruptSnapshot() {\r\n      try {\r\n        // ID saveChat \r\n        const currentChatId =\r\n          typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\r\n\r\n        if (!currentChatId) {\r\n          console.debug('[] ');\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveEventInterruptSnapshot',\r\n              message: '',\r\n              data: {\r\n                hasChatId: false,\r\n                currentDay: this.currentDay,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-chat-error',\r\n              hypothesisId: 'NO_CHAT_SKIP',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          return;\r\n        }\r\n\r\n        // \r\n        try {\r\n          const testChatVars = getVariables({ type: 'chat' });\r\n          if (!testChatVars || typeof testChatVars !== 'object') {\r\n            console.debug('[] ');\r\n            // #region agent log\r\n            //  CORS \r\n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                location: 'event_system.ts:saveEventInterruptSnapshot',\r\n                message: '',\r\n                data: {\r\n                  hasChatId: !!currentChatId,\r\n                  hasChatVars: !!testChatVars,\r\n                  chatVarsType: typeof testChatVars,\r\n                },\r\n                timestamp: Date.now(),\r\n                sessionId: 'debug-session',\r\n                runId: 'fix-save-chat-error',\r\n                hypothesisId: 'NO_CHAT_VARS',\r\n              }),\r\n            }).catch(() => {}); */\r\n            // #endregion\r\n            return;\r\n          }\r\n        } catch (testError) {\r\n          console.debug('[] :', testError);\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveEventInterruptSnapshot',\r\n              message: '',\r\n              data: {\r\n                hasChatId: !!currentChatId,\r\n                error: testError instanceof Error ? testError.message : String(testError),\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-chat-error',\r\n              hypothesisId: 'TEST_CHAT_VARS_ERROR',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          return;\r\n        }\r\n\r\n        // \r\n        // saveStateToChatVars\r\n        const snapshot = {\r\n          currentDay: this.currentDay,\r\n          currentStage: this.currentStage,\r\n          cellType: this.cellType,\r\n          legalTimeline: { ...this.legalTimeline },\r\n          caseComplexity: this.caseComplexity,\r\n          isDeathPenalty: this.isDeathPenalty,\r\n          eventCounters: { ...this.eventCounters },\r\n          eventHistory: [...this.eventHistory],\r\n          lastStageChangeDay: this.lastStageChangeDay,\r\n          snapshotTime: Date.now(),\r\n        };\r\n\r\n        //  updateVariablesWith  replaceVariables\r\n        try {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveEventInterruptSnapshot',\r\n              message: '',\r\n              data: {\r\n                snapshotSize: JSON.stringify(snapshot).length,\r\n                currentDay: this.currentDay,\r\n                currentChatId,\r\n                hasChatId: !!currentChatId,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-conflict',\r\n              hypothesisId: 'SAVE_SNAPSHOT_START',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          updateVariablesWith(\r\n            variables => {\r\n              return { ...variables, detentionSystemInterruptSnapshot: snapshot };\r\n            },\r\n            { type: 'chat' },\r\n          );\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveEventInterruptSnapshot',\r\n              message: ' (updateVariablesWith)',\r\n              data: {\r\n                success: true,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-conflict',\r\n              hypothesisId: 'SAVE_SNAPSHOT_SUCCESS',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        } catch (updateError) {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'event_system.ts:saveEventInterruptSnapshot',\r\n              message: ' (updateVariablesWith)',\r\n              data: {\r\n                error: updateError instanceof Error ? updateError.message : String(updateError),\r\n                errorType: updateError instanceof Error ? updateError.constructor.name : typeof updateError,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-save-conflict',\r\n              hypothesisId: 'SAVE_SNAPSHOT_ERROR',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          //  updateVariablesWith  replaceVariables\r\n          console.warn('[]  (updateVariablesWith):', updateError);\r\n        }\r\n\r\n        console.debug('[] ');\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:saveEventInterruptSnapshot',\r\n            message: '',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n              snapshotTime: snapshot.snapshotTime,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'add-rollback',\r\n            hypothesisId: 'SAVE_SNAPSHOT',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n      } catch (error) {\r\n        console.warn('[] :', error);\r\n      }\r\n    },\r\n\r\n    // \r\n    // AI\r\n    confirmDayAdvancement(pendingDays: number): void {\r\n      if (pendingDays > 0) {\r\n        // \r\n        const oldDay = this.getCurrentDayInternal();\r\n        const newDay = oldDay + pendingDays;\r\n\r\n        // \r\n        this.currentDay = newDay;\r\n        this.lastEventDay = newDay;\r\n\r\n        //  statusPanel \r\n        try {\r\n          const statusPanel = DS.getModule('statusPanel') as {\r\n            getState?: () => { days?: number; day?: number };\r\n            modifyValue?: (key: string, delta: number, reason?: string) => void;\r\n          };\r\n\r\n          if (statusPanel && statusPanel.modifyValue) {\r\n            // \r\n            statusPanel.modifyValue('days', pendingDays, `${pendingDays}`);\r\n            console.info(`[]  : ${oldDay} -> ${newDay} (${pendingDays})`);\r\n          } else {\r\n            console.warn('[]  statusPanel ');\r\n          }\r\n        } catch (error) {\r\n          console.warn('[]  :', error);\r\n        }\r\n\r\n        console.info(`[]  : ${oldDay} -> ${newDay} (${pendingDays})`);\r\n\r\n        // \r\n        this.saveStateToChatVars();\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:confirmDayAdvancement',\r\n            message: '',\r\n            data: {\r\n              oldDay,\r\n              newDay,\r\n              pendingDays,\r\n              currentDayFromMemory: this.getCurrentDayInternal(),\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-day-calculation',\r\n            hypothesisId: 'CONFIRM_DAY',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n      }\r\n    },\r\n\r\n    rollbackToInterruptSnapshot(): boolean {\r\n      try {\r\n        const chatVars = getVariables({ type: 'chat' });\r\n        const snapshot = (chatVars as Record<string, unknown>).detentionSystemInterruptSnapshot as\r\n          | {\r\n              currentDay?: number;\r\n              currentStage?: string;\r\n              cellType?: string;\r\n              legalTimeline?: Timeline;\r\n              caseComplexity?: string;\r\n              isDeathPenalty?: boolean;\r\n              eventCounters?: Record<string, number>;\r\n              eventHistory?: EventRecord[];\r\n              lastStageChangeDay?: number;\r\n            }\r\n          | undefined;\r\n\r\n        if (!snapshot || typeof snapshot !== 'object') {\r\n          console.warn('[] ');\r\n          return false;\r\n        }\r\n\r\n        console.info('[] ');\r\n\r\n        this.currentDay = snapshot.currentDay ?? this.currentDay;\r\n        this.currentStage = (snapshot.currentStage as Stage) ?? this.currentStage;\r\n        this.cellType = snapshot.cellType ?? this.cellType;\r\n        this.caseComplexity =\r\n          (snapshot.caseComplexity as 'simple' | 'normal' | 'complex' | 'very_complex') ?? this.caseComplexity;\r\n        this.isDeathPenalty = Boolean(snapshot.isDeathPenalty);\r\n        this.lastStageChangeDay = snapshot.lastStageChangeDay ?? this.lastStageChangeDay;\r\n\r\n        if (snapshot.legalTimeline && typeof snapshot.legalTimeline === 'object') {\r\n          this.legalTimeline = { ...this.legalTimeline, ...snapshot.legalTimeline };\r\n        }\r\n\r\n        if (snapshot.eventCounters && typeof snapshot.eventCounters === 'object') {\r\n          this.eventCounters = { ...this.eventCounters, ...snapshot.eventCounters };\r\n        }\r\n\r\n        if (Array.isArray(snapshot.eventHistory)) {\r\n          this.eventHistory = [...snapshot.eventHistory];\r\n        }\r\n\r\n        // \r\n        this.saveStateToChatVars();\r\n\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'event_system.ts:rollbackToInterruptSnapshot',\r\n            message: '',\r\n            data: {\r\n              currentDay: this.currentDay,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'add-rollback',\r\n            hypothesisId: 'ROLLBACK_SUCCESS',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        return true;\r\n      } catch (error) {\r\n        console.error('[] :', error);\r\n        return false;\r\n      }\r\n    },\r\n  };\r\n\r\n  // \r\n  DS.generateRandomEvent = (_context?: unknown) => EventSystem.generateRandomEvent();\r\n  DS.advanceDay = (days?: number) => {\r\n    // #region agent log\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'event_system.ts:DS.advanceDay',\r\n        message: 'DS.advanceDay',\r\n        data: {\r\n          days,\r\n          hasEventSystem: !!EventSystem,\r\n          eventSystemType: typeof EventSystem,\r\n          advanceDayType: typeof EventSystem.advanceDay,\r\n        },\r\n        timestamp: Date.now(),\r\n        sessionId: 'debug-session',\r\n        runId: 'fix-undefined-return',\r\n        hypothesisId: 'A',\r\n      }),\r\n    }).catch(() => {}); */\r\n    // #endregion\r\n    const result = EventSystem.advanceDay(days);\r\n    // #region agent log\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'event_system.ts:DS.advanceDay',\r\n        message: 'DS.advanceDay',\r\n        data: {\r\n          resultType: typeof result,\r\n          hasResult: !!result,\r\n          resultKeys: result ? Object.keys(result) : [],\r\n          interrupted: result?.interrupted,\r\n          currentDay: result?.currentDay,\r\n        },\r\n        timestamp: Date.now(),\r\n        sessionId: 'debug-session',\r\n        runId: 'fix-undefined-return',\r\n        hypothesisId: 'B',\r\n      }),\r\n    }).catch(() => {}); */\r\n    // #endregion\r\n    return result;\r\n  };\r\n  // \r\n  DS.getCurrentDay = () => getCurrentDayFromMemoryEnhancement(EventSystem.currentDay);\r\n  DS.getCurrentStage = () => EventSystem.getCurrentStageInfo();\r\n  DS.checkCellTransfer = () => EventSystem.checkCellTransfer();\r\n  DS.setCaseComplexity = (complexity: 'simple' | 'normal' | 'complex' | 'very_complex') =>\r\n    EventSystem.setCaseComplexity(complexity);\r\n  DS.rollbackToStage = (stage: Stage, reason?: string) => EventSystem.rollbackToStage(stage, reason);\r\n  DS.advanceToStage = (stage: Stage, reason?: string) => EventSystem.advanceToStage(stage, reason);\r\n  DS.setDeathPenalty = (isDeathPenalty: boolean) => EventSystem.setDeathPenalty(isDeathPenalty);\r\n  DS.getEventStatistics = () => EventSystem.getEventStatistics();\r\n  DS.exportTimeline = () => EventSystem.exportTimeline();\r\n  DS.importTimeline = (data: unknown) => EventSystem.importTimeline(data);\r\n  DS.rollbackToInterruptSnapshot = () => EventSystem.rollbackToInterruptSnapshot();\r\n\r\n  DS.registerModule('eventSystem', EventSystem);\r\n\r\n  // iframe \r\n  try {\r\n    if (window.parent && window.parent !== window) {\r\n      (window.parent as any).detentionSystem = DS;\r\n      console.info('[]  ');\r\n    }\r\n  } catch (e) {\r\n    // \r\n  }\r\n\r\n  // \r\n  DS.events.on('user_input', (data?: unknown) => {\r\n    const text =\r\n      typeof (data as { text?: unknown } | undefined)?.text === 'string' ? (data as { text?: string }).text : undefined;\r\n    if (text) {\r\n      EventSystem.handleUserRollback(text);\r\n    }\r\n  });\r\n\r\n  // \r\n  DS.events.on('initialized', () => {\r\n    try {\r\n      EventSystem.initialize(0);\r\n    } catch (error) {\r\n      console.error('[] :', error);\r\n    }\r\n  });\r\n\r\n  console.info('[]  v3.4.0');\r\n});\r\n","export {};\r\n\r\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\r\ndeclare const $: JQueryStaticLike;\r\n\r\n/**\r\n * NPC  NPC////\r\n *  registerModule \r\n */\r\n\r\ntype NPCGender = 'female' | 'male';\r\ntype NPCStatus = 'active' | 'removed';\r\ntype NPCRelationship = {\r\n  toProtagonist: number;\r\n  faction: string | null;\r\n  allies: string[];\r\n  enemies: string[];\r\n  influence: number;\r\n};\r\ntype NPCTraits = {\r\n  aggression: number;\r\n  sociability: number;\r\n  intelligence: number;\r\n  emotional: number;\r\n  dominance: number;\r\n  kindness: number;\r\n};\r\ntype NPCPersonality = { traits: NPCTraits; tags: string[] };\r\ntype NPCAppearance = {\r\n  height: number;\r\n  weight: number;\r\n  hair: string;\r\n  eyes: string;\r\n  skin: string;\r\n  features: string;\r\n};\r\ntype NPCBackground = {\r\n  education: string;\r\n  maritalStatus: string;\r\n  hasChildren: boolean;\r\n  childrenCount: number;\r\n  hometown: string;\r\n  priorConvictions: number;\r\n};\r\n\r\ntype NPCBase = {\r\n  id: string;\r\n  name: string;\r\n  gender: NPCGender;\r\n  age: number;\r\n  crime: string;\r\n  sentence: number;\r\n  appearance: NPCAppearance;\r\n  personality: NPCPersonality;\r\n  background: NPCBackground;\r\n  relationship: NPCRelationship;\r\n  cellType: string;\r\n  daysInCustody: number;\r\n  status: NPCStatus;\r\n  createdAt: number;\r\n};\r\n\r\ntype NPCPolice = {\r\n  role: 'police';\r\n  rank: string;\r\n  attitude: number;\r\n};\r\n\r\ntype NPCLawyer = {\r\n  role: 'lawyer';\r\n  type: string;\r\n  experience: number;\r\n  successRate: number;\r\n};\r\n\r\ntype NPCDoctor = {\r\n  role: 'doctor';\r\n  specialty: string;\r\n  experience: number;\r\n};\r\n\r\ntype NPCFamily = {\r\n  role: 'family';\r\n  relation: string;\r\n  supportLevel: number;\r\n};\r\n\r\ntype NPCSpecial = NPCPolice | NPCLawyer | NPCDoctor | NPCFamily;\r\ntype NPC = NPCBase & Partial<NPCSpecial>;\r\n\r\ntype EventTriggeredPayload = { id?: string };\r\ntype CellTransferPayload = { to?: string };\r\n\r\ninterface EventSystemModule {\r\n  getCurrentStageInfo?: () => { cellType?: string };\r\n}\r\n\r\ninterface DetentionSystem {\r\n  events: { on(event: string, callback: (data?: unknown) => void): void; emit(event: string, data?: unknown): void };\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n}\r\n\r\ntype ProtagonistOptions = {\r\n  crimeType?: 'economic' | 'property' | 'violent' | 'drug' | 'social' | 'other' | string;\r\n  crimeName?: string; // \r\n  ageRange?: [number, number]; // [min, max]\r\n  education?: 'high' | 'medium' | 'low' | 'custom'; // high: , medium: /, low: \r\n  profession?: string[]; //  ['', '', '']\r\n  excludeCrimes?: string[]; //  ['']\r\n  background?: {\r\n    isIntellectual?: boolean; // \r\n    isAcademic?: boolean; // \r\n    isBusiness?: boolean; // \r\n  };\r\n};\r\n\r\ntype ProtagonistInfo = {\r\n  name: string;\r\n  age: number;\r\n  crime: string;\r\n  sentence: number;\r\n  appearance: {\r\n    height: number;\r\n    weight: number;\r\n    hair: string;\r\n    skin: string;\r\n    features: string;\r\n    eyes: string;\r\n  };\r\n  background: {\r\n    education: string;\r\n    profession?: string;\r\n    maritalStatus: string;\r\n    hasChildren: boolean;\r\n    childrenCount: number;\r\n    hometown: string;\r\n  };\r\n  personality?: {\r\n    traits: {\r\n      intelligence: number;\r\n      sociability: number;\r\n      emotional: number;\r\n    };\r\n    tags: string[];\r\n  };\r\n};\r\n\r\ntype DetentionSystemWithNPC = DetentionSystem & {\r\n  generateNPC?: (count?: number, context?: Record<string, unknown>) => NPC[];\r\n  generateNPCForEvent?: (eventType: string) => NPC | { police: NPC; witnesses: NPC[] };\r\n  generateProtagonist?: (options?: ProtagonistOptions) => ProtagonistInfo;\r\n  getCurrentCellNPCs?: () => NPC[];\r\n  setCurrentCellNPCs?: (npcs: NPC[]) => void;\r\n  addNPCToCell?: (npc: NPC) => void;\r\n  removeNPCFromCell?: (npcId: string) => NPC | null;\r\n  findNPC?: (npcId: string) => NPC | undefined;\r\n  updateNPCRelationship?: (npcId: string, delta: number) => void;\r\n  exportNPCData?: () => { database: NPC[]; currentCell: NPC[] };\r\n  importNPCData?: (data: { database?: NPC[]; currentCell?: NPC[] } | undefined) => boolean;\r\n};\r\n\r\ndeclare global {\r\n  interface DetentionSystem {\r\n    generateNPC?: (count?: number, context?: Record<string, unknown>) => NPC[];\r\n    generateNPCForEvent?: (eventType: string) => NPC | { police: NPC; witnesses: NPC[] };\r\n    generateProtagonist?: (options?: ProtagonistOptions) => ProtagonistInfo;\r\n    getCurrentCellNPCs?: () => NPC[];\r\n    setCurrentCellNPCs?: (npcs: NPC[]) => void;\r\n    addNPCToCell?: (npc: NPC) => void;\r\n    removeNPCFromCell?: (npcId: string) => NPC | null;\r\n    findNPC?: (npcId: string) => NPC | undefined;\r\n    updateNPCRelationship?: (npcId: string, delta: number) => void;\r\n    exportNPCData?: () => { database: NPC[]; currentCell: NPC[] };\r\n    importNPCData?: (data: { database?: NPC[]; currentCell?: NPC[] } | undefined) => boolean;\r\n  }\r\n}\r\n\r\n// #region agent log - HYP-A: \r\ntry {\r\n  //  CORS \r\n  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({\r\n      location: 'npc_system.ts:',\r\n      message: 'NPC',\r\n      data: {\r\n        windowExists: typeof window !== 'undefined',\r\n        windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\r\n        windowDetentionSystemType: typeof window.detentionSystem,\r\n        hasPing:\r\n          typeof window.detentionSystem !== 'undefined' && typeof (window.detentionSystem as any).ping === 'function',\r\n        pingResult:\r\n          typeof window.detentionSystem !== 'undefined' && typeof (window.detentionSystem as any).ping === 'function'\r\n            ? (window.detentionSystem as any).ping()\r\n            : 'N/A',\r\n        isIframe: typeof window !== 'undefined' && window.parent !== window,\r\n        currentUrl: typeof window !== 'undefined' && window.location ? window.location.href : 'N/A',\r\n      },\r\n      timestamp: Date.now(),\r\n      sessionId: 'debug-session',\r\n      runId: 'npc-load-debug',\r\n      hypothesisId: 'A',\r\n    }),\r\n  }).catch(() => {}); */\r\n} catch (e) {\r\n  console.error('[NPC] :', e);\r\n}\r\n// #endregion\r\n\r\nconsole.info('[NPC] ...');\r\n\r\n// ========== DS==========\r\nconst NameGenerator = {\r\n  surnames: {\r\n    tier1: {\r\n      names: ['', '', '', '', '', '', '', '', '', ''],\r\n      weight: 35,\r\n    },\r\n    tier2: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 30,\r\n    },\r\n    tier3: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 20,\r\n    },\r\n    tier4: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 10,\r\n    },\r\n    tier5: {\r\n      names: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      weight: 5,\r\n    },\r\n  },\r\n  givenNames: {\r\n    vintage: {\r\n      single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 25,\r\n    },\r\n    classic: {\r\n      single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 35,\r\n    },\r\n    modern: {\r\n      single: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 30,\r\n    },\r\n    contemporary: {\r\n      single: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\r\n      double: [\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n        ['', ''],\r\n      ],\r\n      weight: 10,\r\n    },\r\n  },\r\n  badNames: [\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n  ],\r\n  badChars: ['', '', '', '', '', '', '', '', '', '', '', ''],\r\n\r\n  generate(birthYear: number): string {\r\n    let attempts = 0;\r\n    const maxAttempts = 50;\r\n    while (attempts < maxAttempts) {\r\n      attempts++;\r\n      const surname = this.selectSurname();\r\n      const givenName = this.selectGivenName(birthYear);\r\n      const fullName = surname + givenName;\r\n      if (this.isValidName(fullName)) return fullName;\r\n    }\r\n    return '' + this.givenNames.classic.single[0];\r\n  },\r\n\r\n  selectSurname(): string {\r\n    const tiers = Object.values(this.surnames);\r\n    const totalWeight = tiers.reduce((sum, tier) => sum + tier.weight, 0);\r\n    let random = Math.random() * totalWeight;\r\n    for (const tier of tiers) {\r\n      random -= tier.weight;\r\n      if (random <= 0) {\r\n        return tier.names[Math.floor(Math.random() * tier.names.length)];\r\n      }\r\n    }\r\n    return this.surnames.tier1.names[0];\r\n  },\r\n\r\n  selectGivenName(birthYear: number): string {\r\n    const currentYear = new Date().getFullYear();\r\n    const age = currentYear - birthYear;\r\n    const style = age >= 50 ? 'vintage' : age >= 35 ? 'classic' : age >= 20 ? 'modern' : 'contemporary';\r\n    const styleData = this.givenNames[style as keyof typeof this.givenNames];\r\n    const useDouble = Math.random() < 0.6;\r\n    if (useDouble && styleData.double.length > 0) {\r\n      const pair = styleData.double[Math.floor(Math.random() * styleData.double.length)];\r\n      return pair[0] + pair[1];\r\n    }\r\n    return styleData.single[Math.floor(Math.random() * styleData.single.length)];\r\n  },\r\n\r\n  isValidName(name: string): boolean {\r\n    if (this.badNames.includes(name)) return false;\r\n    return !this.badChars.some(char => name.includes(char));\r\n  },\r\n};\r\n\r\n// ========== DS==========\r\nconst CrimeGenerator = {\r\n  characterBookCrimes: [\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n    '',\r\n  ],\r\n  crimes: {\r\n    violent: {\r\n      names: ['', '', '', '', '', ''],\r\n      weight: 12,\r\n      sentenceRange: [3, 20] as [number, number],\r\n    },\r\n    property: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 35,\r\n      sentenceRange: [1, 15] as [number, number],\r\n    },\r\n    drug: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 20,\r\n      sentenceRange: [3, 15] as [number, number],\r\n    },\r\n    economic: {\r\n      names: ['', '', '', '', '', '', ''],\r\n      weight: 15,\r\n      sentenceRange: [2, 10] as [number, number],\r\n    },\r\n    social: {\r\n      names: [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ],\r\n      weight: 13,\r\n      sentenceRange: [1, 7] as [number, number],\r\n    },\r\n    other: {\r\n      names: ['', '', '', '', '', ''],\r\n      weight: 5,\r\n      sentenceRange: [1, 5] as [number, number],\r\n    },\r\n  },\r\n\r\n  generate(): { crime: string; sentence: number; category: { sentenceRange: [number, number] } } {\r\n    if (Math.random() < 0.3) {\r\n      const crime = this.characterBookCrimes[Math.floor(Math.random() * this.characterBookCrimes.length)];\r\n      const category = this.findCategoryByCrime(crime);\r\n      const sentence = this.generateSentence(category ? category.sentenceRange : [1, 10]);\r\n      return { crime, sentence, category: category || this.crimes.property };\r\n    }\r\n\r\n    const categories = Object.values(this.crimes);\r\n    const totalWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);\r\n    let random = Math.random() * totalWeight;\r\n    for (const category of categories) {\r\n      random -= category.weight;\r\n      if (random <= 0) {\r\n        const crime = category.names[Math.floor(Math.random() * category.names.length)];\r\n        const sentence = this.generateSentence(category.sentenceRange);\r\n        return { crime, sentence, category };\r\n      }\r\n    }\r\n\r\n    return { crime: '', sentence: 3, category: this.crimes.property };\r\n  },\r\n\r\n  findCategoryByCrime(crimeName: string) {\r\n    for (const key of Object.keys(this.crimes)) {\r\n      const category = this.crimes[key as keyof typeof this.crimes];\r\n      if (category.names.includes(crimeName)) return category;\r\n    }\r\n    return null;\r\n  },\r\n\r\n  generateSentence(range: [number, number]): number {\r\n    const [min, max] = range;\r\n    return Math.floor(Math.random() * (max - min + 1)) + min;\r\n  },\r\n};\r\n\r\n//  jQuery ready \r\n$(() => {\r\n  const DS_RAW = window.detentionSystem as DetentionSystemWithNPC | undefined;\r\n\r\n  if (!DS_RAW) {\r\n    console.error(' [NPC] ');\r\n    console.error('[NPC] window.detentionSystem:', typeof window.detentionSystem);\r\n    console.error('[NPC] window.__DETENTION_SYSTEM_LOADED__:', (window as any).__DETENTION_SYSTEM_LOADED__);\r\n    console.error(\r\n      '[NPC] window.__DETENTION_SYSTEM_CORE_LOADED__:',\r\n      (window as any).__DETENTION_SYSTEM_CORE_LOADED__,\r\n    );\r\n    // #region agent log - HYP-B: \r\n    try {\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'npc_system.ts:',\r\n          message: 'NPC',\r\n          data: {\r\n            windowType: typeof window,\r\n            detentionSystemType: typeof window.detentionSystem,\r\n            modulesLoaded:\r\n              typeof window.detentionSystem !== 'undefined' && (window.detentionSystem as any).modules\r\n                ? Object.keys((window.detentionSystem as any).modules)\r\n                : [],\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'npc-load-debug',\r\n          hypothesisId: 'B',\r\n        }),\r\n      }).catch(() => {}); */\r\n    } catch (e) {\r\n      console.error('[NPC] :', e);\r\n    }\r\n    // #endregion\r\n    return;\r\n  }\r\n\r\n  // DS \r\n  const DS = DS_RAW as DetentionSystemWithNPC;\r\n\r\n  console.info(' [NPC] ...');\r\n  // \r\n  (window as any).__NPC_SYSTEM_LOADING__ = true;\r\n  // #region agent log - HYP-C: \r\n  try {\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'npc_system.ts:',\r\n        message: 'NPC',\r\n        data: {\r\n          hasGenerateNPC: typeof DS.generateNPC === 'function',\r\n          hasGenerateNPCForEvent: typeof DS.generateNPCForEvent === 'function',\r\n          hasGetCurrentCellNPCs: typeof DS.getCurrentCellNPCs === 'function',\r\n          hasModules: 'modules' in DS,\r\n          modulesCount: 'modules' in DS ? Object.keys(DS.modules).length : 0,\r\n          moduleNames: 'modules' in DS ? Object.keys(DS.modules) : [],\r\n        },\r\n        timestamp: Date.now(),\r\n        sessionId: 'debug-session',\r\n        runId: 'npc-load-debug',\r\n        hypothesisId: 'C',\r\n      }),\r\n    }).catch(() => {}); */\r\n  } catch (e) {\r\n    console.error('[NPC] :', e);\r\n  }\r\n  // #endregion\r\n\r\n  // ========== NPC ==========\r\n  const NPCGenerator = {\r\n    npcDatabase: [] as NPC[],\r\n    currentCellNPCs: [] as NPC[],\r\n\r\n    generate(count = 1, context: Record<string, unknown> = {}): NPC[] {\r\n      const npcs: NPC[] = [];\r\n      for (let i = 0; i < count; i++) {\r\n        const npc = this.generateSingle(context);\r\n        npcs.push(npc);\r\n        this.npcDatabase.push(npc);\r\n      }\r\n      return npcs;\r\n    },\r\n\r\n    generateSingle(context: Record<string, unknown> = {}): NPC {\r\n      const eventSystem = DS.getModule<EventSystemModule>('eventSystem');\r\n      const stageInfo = eventSystem?.getCurrentStageInfo ? eventSystem.getCurrentStageInfo() : {};\r\n\r\n      const age = this.generateAge();\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const crimeData = CrimeGenerator.generate();\r\n      const appearance = this.generateAppearance(age);\r\n      const personality = this.generatePersonality();\r\n      const background = this.generateBackground(age, crimeData);\r\n      const relationship = this.generateRelationship();\r\n\r\n      const cellType =\r\n        typeof stageInfo?.cellType === 'string' ? stageInfo.cellType : (context.cellType as string) || 'transition';\r\n      this.adjustByCellType(personality, relationship, cellType);\r\n\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: 'female',\r\n        age,\r\n        crime: crimeData.crime,\r\n        sentence: crimeData.sentence,\r\n        appearance,\r\n        personality,\r\n        background,\r\n        relationship,\r\n        cellType,\r\n        daysInCustody: Math.floor(Math.random() * 365) + 30,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateAge(): number {\r\n      const random = Math.random();\r\n      if (random < 0.05) return Math.floor(Math.random() * 3) + 18;\r\n      if (random < 0.25) return Math.floor(Math.random() * 10) + 21;\r\n      if (random < 0.55) return Math.floor(Math.random() * 10) + 31;\r\n      if (random < 0.8) return Math.floor(Math.random() * 10) + 41;\r\n      if (random < 0.95) return Math.floor(Math.random() * 10) + 51;\r\n      return Math.floor(Math.random() * 15) + 61;\r\n    },\r\n\r\n    generateAppearance(age: number): NPCAppearance {\r\n      const heights = [150, 155, 160, 165, 170, 175];\r\n      const weights = [45, 50, 55, 60, 65, 70, 75];\r\n      const height = heights[Math.floor(Math.random() * heights.length)];\r\n      const weight = weights[Math.floor(Math.random() * weights.length)];\r\n      const hairStyles =\r\n        age > 50\r\n          ? ['', '', '', '']\r\n          : ['', '', '', '', '', '', ''];\r\n      const skinTones = ['', '', '', '', ''];\r\n      const features = ['', '', '', '', '', '', ''];\r\n      return {\r\n        height,\r\n        weight,\r\n        hair: hairStyles[Math.floor(Math.random() * hairStyles.length)],\r\n        eyes: '',\r\n        skin: skinTones[Math.floor(Math.random() * skinTones.length)],\r\n        features: features[Math.floor(Math.random() * features.length)],\r\n      };\r\n    },\r\n\r\n    generatePersonality(): NPCPersonality {\r\n      const traits: NPCTraits = {\r\n        aggression: Math.floor(Math.random() * 100),\r\n        sociability: Math.floor(Math.random() * 100),\r\n        intelligence: Math.floor(Math.random() * 100),\r\n        emotional: Math.floor(Math.random() * 100),\r\n        dominance: Math.floor(Math.random() * 100),\r\n        kindness: Math.floor(Math.random() * 100),\r\n      };\r\n      const tags: string[] = [];\r\n      if (traits.aggression > 70) tags.push('');\r\n      if (traits.sociability > 70) tags.push('');\r\n      if (traits.intelligence > 70) tags.push('');\r\n      if (traits.emotional > 70) tags.push('');\r\n      if (traits.dominance > 70) tags.push('');\r\n      if (traits.kindness > 70) tags.push('');\r\n      if (traits.aggression < 30) tags.push('');\r\n      if (traits.sociability < 30) tags.push('');\r\n      if (traits.emotional < 30) tags.push('');\r\n      if (traits.dominance < 30) tags.push('');\r\n      return { traits, tags };\r\n    },\r\n\r\n    generateBackground(\r\n      age: number,\r\n      _crimeData: { crime: string; sentence: number; category: { sentenceRange: [number, number] } },\r\n    ): NPCBackground {\r\n      const educations = ['', '', '', '', '', '', ''];\r\n      const educationWeights = [10, 25, 30, 15, 10, 8, 2];\r\n      const educationIndex = this.weightedRandom(educations.length, educationWeights);\r\n      const maritalStatuses = ['', '', '', ''];\r\n      const maritalWeights = age < 25 ? [80, 15, 5, 0] : age < 40 ? [20, 60, 15, 5] : [10, 50, 30, 10];\r\n      const maritalIndex = this.weightedRandom(maritalStatuses.length, maritalWeights);\r\n      const hasChildren = maritalStatuses[maritalIndex] !== '' && Math.random() < 0.7;\r\n      const childrenCount = hasChildren ? Math.floor(Math.random() * 3) + 1 : 0;\r\n      return {\r\n        education: educations[educationIndex],\r\n        maritalStatus: maritalStatuses[maritalIndex],\r\n        hasChildren,\r\n        childrenCount,\r\n        hometown: this.generateHometown(),\r\n        priorConvictions: Math.random() < 0.3 ? Math.floor(Math.random() * 3) + 1 : 0,\r\n      };\r\n    },\r\n\r\n    generateHometown(): string {\r\n      const provinces = [\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n        '',\r\n      ];\r\n      return provinces[Math.floor(Math.random() * provinces.length)];\r\n    },\r\n\r\n    generateRelationship(): NPCRelationship {\r\n      return {\r\n        toProtagonist: 50,\r\n        faction: null,\r\n        allies: [],\r\n        enemies: [],\r\n        influence: Math.floor(Math.random() * 100),\r\n      };\r\n    },\r\n\r\n    adjustByCellType(personality: NPCPersonality, relationship: NPCRelationship, cellType: string) {\r\n      if (cellType === 'transition') {\r\n        personality.traits.emotional += 10;\r\n        relationship.influence -= 20;\r\n      } else if (cellType === 'pretrial') {\r\n        personality.traits.emotional += 15;\r\n        personality.traits.aggression += 5;\r\n      } else if (cellType === 'convicted') {\r\n        personality.traits.emotional -= 10;\r\n        personality.traits.aggression += 10;\r\n        relationship.influence += 10;\r\n      }\r\n      (Object.keys(personality.traits) as Array<keyof NPCTraits>).forEach(key => {\r\n        personality.traits[key] = Math.max(0, Math.min(100, personality.traits[key]));\r\n      });\r\n      relationship.influence = Math.max(0, Math.min(100, relationship.influence));\r\n    },\r\n\r\n    weightedRandom(count: number, weights: number[]): number {\r\n      const totalWeight = weights.reduce((sum, w) => sum + w, 0);\r\n      let random = Math.random() * totalWeight;\r\n      for (let i = 0; i < count; i++) {\r\n        random -= weights[i];\r\n        if (random <= 0) return i;\r\n      }\r\n      return count - 1;\r\n    },\r\n\r\n    generateId(): string {\r\n      return 'npc_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);\r\n    },\r\n\r\n    generateForEvent(eventType: string): NPC | { police: NPC; witnesses: NPC[] } {\r\n      if (eventType === 'interrogation') return this.generatePolice();\r\n      if (eventType === 'lawyer_visit') return this.generateLawyer();\r\n      if (eventType === 'family_visit') return this.generateFamily();\r\n      if (eventType === 'medical_visit') return this.generateDoctor();\r\n      if (eventType === 'scene_identification') {\r\n        return { police: this.generatePolice(), witnesses: this.generate(2, { type: 'witness' }) };\r\n      }\r\n      return this.generateSingle({ eventType });\r\n    },\r\n\r\n    generatePolice(): NPC {\r\n      const age = Math.floor(Math.random() * 20) + 25;\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const ranks = ['', '', '', ''];\r\n      const rank = ranks[Math.floor(Math.random() * ranks.length)];\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: 'female',\r\n        age,\r\n        role: 'police',\r\n        rank,\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 30) + 40,\r\n            sociability: Math.floor(Math.random() * 40) + 30,\r\n            intelligence: Math.floor(Math.random() * 30) + 50,\r\n            emotional: Math.floor(Math.random() * 40) + 20,\r\n            dominance: Math.floor(Math.random() * 30) + 60,\r\n            kindness: Math.floor(Math.random() * 60) + 20,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        attitude: Math.floor(Math.random() * 40) + 30,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'staff',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateLawyer(): NPC {\r\n      const age = Math.floor(Math.random() * 25) + 28;\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const isFemale = Math.random() < 0.8;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const types = ['', '', ''];\r\n      const typeWeights = [50, 40, 10];\r\n      const typeIndex = this.weightedRandom(types.length, typeWeights);\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: isFemale ? 'female' : 'male',\r\n        age,\r\n        role: 'lawyer',\r\n        type: types[typeIndex],\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 20) + 20,\r\n            sociability: Math.floor(Math.random() * 30) + 60,\r\n            intelligence: Math.floor(Math.random() * 20) + 70,\r\n            emotional: Math.floor(Math.random() * 40) + 30,\r\n            dominance: Math.floor(Math.random() * 40) + 40,\r\n            kindness: Math.floor(Math.random() * 40) + 40,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        experience: Math.floor(Math.random() * 20) + 5,\r\n        successRate: Math.floor(Math.random() * 40) + 40,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'external',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateFamily(): NPC {\r\n      const relationships = ['', '', '', '', '', '', '', ''];\r\n      const weights = [30, 20, 15, 10, 10, 10, 3, 2];\r\n      const relationIndex = this.weightedRandom(relationships.length, weights);\r\n      const relation = relationships[relationIndex];\r\n      let age = 40;\r\n      let isFemale = true;\r\n      if (relation === '') {\r\n        age = Math.floor(Math.random() * 20) + 45;\r\n        isFemale = true;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 20) + 45;\r\n        isFemale = false;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 30) + 25;\r\n        isFemale = false;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 30) + 25;\r\n        isFemale = true;\r\n      } else if (relation === '' || relation === '') {\r\n        age = Math.floor(Math.random() * 30) + 20;\r\n        isFemale = true;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 15) + 5;\r\n        isFemale = true;\r\n      } else if (relation === '') {\r\n        age = Math.floor(Math.random() * 15) + 5;\r\n        isFemale = false;\r\n      }\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: isFemale ? 'female' : 'male',\r\n        age,\r\n        role: 'family',\r\n        relation,\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 30) + 10,\r\n            sociability: Math.floor(Math.random() * 50) + 30,\r\n            intelligence: Math.floor(Math.random() * 60) + 30,\r\n            emotional: Math.floor(Math.random() * 50) + 40,\r\n            dominance: Math.floor(Math.random() * 50) + 20,\r\n            kindness: Math.floor(Math.random() * 30) + 60,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        supportLevel: Math.floor(Math.random() * 40) + 60,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'external',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    generateDoctor(): NPC {\r\n      const age = Math.floor(Math.random() * 25) + 30;\r\n      const birthYear = new Date().getFullYear() - age;\r\n      const name = NameGenerator.generate(birthYear);\r\n      const specialties = ['', '', '', '', ''];\r\n      const specialty = specialties[Math.floor(Math.random() * specialties.length)];\r\n      const npc: NPC = {\r\n        id: this.generateId(),\r\n        name,\r\n        gender: 'female',\r\n        age,\r\n        role: 'doctor',\r\n        specialty,\r\n        appearance: this.generateAppearance(age),\r\n        personality: {\r\n          traits: {\r\n            aggression: Math.floor(Math.random() * 20) + 10,\r\n            sociability: Math.floor(Math.random() * 40) + 40,\r\n            intelligence: Math.floor(Math.random() * 20) + 70,\r\n            emotional: Math.floor(Math.random() * 40) + 30,\r\n            dominance: Math.floor(Math.random() * 40) + 40,\r\n            kindness: Math.floor(Math.random() * 30) + 60,\r\n          },\r\n          tags: ['', ''],\r\n        },\r\n        experience: Math.floor(Math.random() * 25) + 5,\r\n        crime: '',\r\n        sentence: 0,\r\n        background: this.generateBackground(age, { crime: '', sentence: 0, category: { sentenceRange: [0, 0] } }),\r\n        relationship: this.generateRelationship(),\r\n        cellType: 'external',\r\n        daysInCustody: 0,\r\n        status: 'active',\r\n        createdAt: Date.now(),\r\n      };\r\n      return npc;\r\n    },\r\n\r\n    /**\r\n     * \r\n     * @param options \r\n     * @returns \r\n     */\r\n    generateProtagonist(options: ProtagonistOptions = {}): ProtagonistInfo {\r\n      // #region agent log - HYP-PROTAGONIST: \r\n      try {\r\n        fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'npc_system.ts:generateProtagonist',\r\n            message: '',\r\n            data: {\r\n              options: options,\r\n              hasOptions: !!options,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'protagonist-generation',\r\n            hypothesisId: 'PROTAGONIST_START',\r\n          }),\r\n        }).catch(() => {});\r\n      } catch (e) {}\r\n      // #endregion\r\n\r\n      // 1. \r\n      let age: number;\r\n      if (options.ageRange && options.ageRange.length === 2) {\r\n        const [min, max] = options.ageRange;\r\n        age = Math.floor(Math.random() * (max - min + 1)) + min;\r\n      } else if (options.background?.isIntellectual || options.background?.isBusiness) {\r\n        // 35-45\r\n        age = Math.floor(Math.random() * 11) + 35;\r\n      } else {\r\n        // 28-42\r\n        age = Math.floor(Math.random() * 15) + 28;\r\n      }\r\n      const birthYear = new Date().getFullYear() - age;\r\n\r\n      // 2. \r\n      const name = NameGenerator.generate(birthYear);\r\n\r\n      // 3. \r\n      let crimeData: { crime: string; sentence: number; category: { sentenceRange: [number, number] } };\r\n      if (options.crimeName) {\r\n        // \r\n        const category = CrimeGenerator.findCategoryByCrime(options.crimeName);\r\n        const sentenceRange = category ? category.sentenceRange : [2, 10];\r\n        crimeData = {\r\n          crime: options.crimeName,\r\n          sentence: CrimeGenerator.generateSentence(sentenceRange),\r\n          category: category || CrimeGenerator.crimes.economic,\r\n        };\r\n      } else if (options.crimeType) {\r\n        // \r\n        const categoryKey = options.crimeType as keyof typeof CrimeGenerator.crimes;\r\n        if (CrimeGenerator.crimes[categoryKey]) {\r\n          const category = CrimeGenerator.crimes[categoryKey];\r\n          const crime = category.names[Math.floor(Math.random() * category.names.length)];\r\n          // \r\n          let filteredCrimes = category.names;\r\n          if (options.excludeCrimes && options.excludeCrimes.length > 0) {\r\n            filteredCrimes = category.names.filter(c => !options.excludeCrimes!.includes(c));\r\n          }\r\n          if (filteredCrimes.length === 0) {\r\n            filteredCrimes = category.names; // \r\n          }\r\n          const selectedCrime = filteredCrimes[Math.floor(Math.random() * filteredCrimes.length)];\r\n          crimeData = {\r\n            crime: selectedCrime,\r\n            sentence: CrimeGenerator.generateSentence(category.sentenceRange),\r\n            category: category,\r\n          };\r\n        } else {\r\n          // \r\n          const category = CrimeGenerator.crimes.economic;\r\n          const filteredCrimes = options.excludeCrimes\r\n            ? category.names.filter(c => !options.excludeCrimes!.includes(c))\r\n            : category.names;\r\n          const selectedCrime =\r\n            filteredCrimes.length > 0\r\n              ? filteredCrimes[Math.floor(Math.random() * filteredCrimes.length)]\r\n              : category.names[0];\r\n          crimeData = {\r\n            crime: selectedCrime,\r\n            sentence: CrimeGenerator.generateSentence(category.sentenceRange),\r\n            category: category,\r\n          };\r\n        }\r\n      } else if (options.background?.isIntellectual || options.background?.isBusiness) {\r\n        // \r\n        const category = CrimeGenerator.crimes.economic;\r\n        const filteredCrimes = options.excludeCrimes\r\n          ? category.names.filter(c => !options.excludeCrimes!.includes(c))\r\n          : category.names;\r\n        const selectedCrime =\r\n          filteredCrimes.length > 0\r\n            ? filteredCrimes[Math.floor(Math.random() * filteredCrimes.length)]\r\n            : category.names[0];\r\n        crimeData = {\r\n          crime: selectedCrime,\r\n          sentence: CrimeGenerator.generateSentence(category.sentenceRange),\r\n          category: category,\r\n        };\r\n      } else {\r\n        // \r\n        crimeData = CrimeGenerator.generate();\r\n        // \r\n        if (options.excludeCrimes && options.excludeCrimes.includes(crimeData.crime)) {\r\n          // \r\n          let attempts = 0;\r\n          while (attempts < 10 && options.excludeCrimes.includes(crimeData.crime)) {\r\n            crimeData = CrimeGenerator.generate();\r\n            attempts++;\r\n          }\r\n        }\r\n      }\r\n\r\n      // 4. \r\n      const appearance = this.generateAppearance(age);\r\n\r\n      // 5. \r\n      let education: string;\r\n      if (options.education === 'high') {\r\n        const highEducations = ['', '', '', ''];\r\n        education = highEducations[Math.floor(Math.random() * highEducations.length)];\r\n      } else if (options.education === 'medium') {\r\n        const mediumEducations = ['', '', ''];\r\n        education = mediumEducations[Math.floor(Math.random() * mediumEducations.length)];\r\n      } else if (options.education === 'low') {\r\n        const lowEducations = ['', '', ''];\r\n        education = lowEducations[Math.floor(Math.random() * lowEducations.length)];\r\n      } else if (options.background?.isIntellectual) {\r\n        // \r\n        const highEducations = ['', '', '', ''];\r\n        education = highEducations[Math.floor(Math.random() * highEducations.length)];\r\n      } else if (options.background?.isBusiness) {\r\n        // \r\n        const businessEducations = ['', '', '', 'MBA'];\r\n        education = businessEducations[Math.floor(Math.random() * businessEducations.length)];\r\n      } else {\r\n        // \r\n        if (age < 30) {\r\n          const educations = ['', '', '', ''];\r\n          const weights = [20, 30, 40, 10];\r\n          education = educations[this.weightedRandom(educations.length, weights)];\r\n        } else {\r\n          const educations = ['', '', '', '', '', ''];\r\n          const weights = [15, 25, 35, 10, 10, 5];\r\n          education = educations[this.weightedRandom(educations.length, weights)];\r\n        }\r\n      }\r\n\r\n      // 6. \r\n      let profession: string | undefined;\r\n      if (options.profession && options.profession.length > 0) {\r\n        profession = options.profession[Math.floor(Math.random() * options.profession.length)];\r\n      } else if (options.background?.isBusiness) {\r\n        const businessProfessions = ['', '', '', '', ''];\r\n        profession = businessProfessions[Math.floor(Math.random() * businessProfessions.length)];\r\n      } else if (options.background?.isIntellectual && !options.background?.isAcademic) {\r\n        // \r\n        const intellectualProfessions = ['', '', '', '', ''];\r\n        profession = intellectualProfessions[Math.floor(Math.random() * intellectualProfessions.length)];\r\n      } else if (options.background?.isAcademic) {\r\n        const academicProfessions = ['', '', '', '', ''];\r\n        profession = academicProfessions[Math.floor(Math.random() * academicProfessions.length)];\r\n      }\r\n\r\n      // 7. \r\n      const maritalStatuses = age < 30 ? ['', ''] : age < 40 ? ['', '', ''] : ['', ''];\r\n      const maritalWeights =\r\n        age < 30\r\n          ? [40, 60]\r\n          : age < 40\r\n            ? [60, 25, 15]\r\n            : education === '' || education === ''\r\n              ? [70, 30]\r\n              : [65, 35];\r\n      const maritalIndex = this.weightedRandom(maritalStatuses.length, maritalWeights);\r\n      const maritalStatus = maritalStatuses[maritalIndex];\r\n\r\n      // 8. \r\n      const hasChildren = maritalStatus !== '' && age > 28 && Math.random() < 0.7;\r\n      const childrenCount = hasChildren ? (age < 35 ? 1 : Math.floor(Math.random() * 2) + 1) : 0;\r\n\r\n      // 9. \r\n      const hometown = this.generateHometown();\r\n\r\n      // 10. \r\n      const personality: ProtagonistInfo['personality'] = {\r\n        traits: {\r\n          intelligence: options.background?.isIntellectual\r\n            ? Math.floor(Math.random() * 15) + 80\r\n            : options.background?.isBusiness\r\n              ? Math.floor(Math.random() * 20) + 70\r\n              : Math.floor(Math.random() * 30) + 60,\r\n          sociability: options.background?.isBusiness\r\n            ? Math.floor(Math.random() * 25) + 60\r\n            : Math.floor(Math.random() * 40) + 40,\r\n          emotional: Math.floor(Math.random() * 40) + 30,\r\n        },\r\n        tags: [],\r\n      };\r\n\r\n      // \r\n      if (options.background?.isIntellectual) {\r\n        personality.tags.push('', '');\r\n        if (!options.background.isAcademic) {\r\n          personality.tags.push('');\r\n        }\r\n      }\r\n      if (options.background?.isBusiness) {\r\n        personality.tags.push('', '');\r\n      }\r\n      if (personality.traits.intelligence >= 75) {\r\n        personality.tags.push('');\r\n      }\r\n      if (personality.traits.sociability >= 60) {\r\n        personality.tags.push('');\r\n      }\r\n\r\n      // #region agent log - HYP-PROTAGONIST: \r\n      try {\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'npc_system.ts:generateProtagonist',\r\n            message: '',\r\n            data: {\r\n              name: name,\r\n              age: age,\r\n              crime: crimeData.crime,\r\n              sentence: crimeData.sentence,\r\n              education: education,\r\n              profession: profession,\r\n              personalityTags: personality.tags,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'protagonist-generation',\r\n            hypothesisId: 'PROTAGONIST_COMPLETE',\r\n          }),\r\n        }).catch(() => {}); */\r\n      } catch (e) {}\r\n      // #endregion\r\n\r\n      return {\r\n        name,\r\n        age,\r\n        crime: crimeData.crime,\r\n        sentence: crimeData.sentence,\r\n        appearance: {\r\n          height: appearance.height,\r\n          weight: appearance.weight,\r\n          hair: appearance.hair,\r\n          skin: appearance.skin,\r\n          features: appearance.features,\r\n          eyes: appearance.eyes,\r\n        },\r\n        background: {\r\n          education,\r\n          profession,\r\n          maritalStatus,\r\n          hasChildren,\r\n          childrenCount,\r\n          hometown,\r\n        },\r\n        personality,\r\n      };\r\n    },\r\n\r\n    getCurrentCellNPCs(): NPC[] {\r\n      return this.currentCellNPCs;\r\n    },\r\n\r\n    setCurrentCellNPCs(npcs: NPC[]) {\r\n      this.currentCellNPCs = npcs;\r\n      DS.events.emit('cell_npcs_changed', { npcs });\r\n    },\r\n\r\n    addNPCToCell(npc: NPC) {\r\n      this.currentCellNPCs.push(npc);\r\n      DS.events.emit('npc_joined_cell', { npc });\r\n    },\r\n\r\n    removeNPCFromCell(npcId: string): NPC | null {\r\n      const index = this.currentCellNPCs.findIndex(n => n.id === npcId);\r\n      if (index !== -1) {\r\n        const npc = this.currentCellNPCs.splice(index, 1)[0];\r\n        DS.events.emit('npc_left_cell', { npc });\r\n        return npc;\r\n      }\r\n      return null;\r\n    },\r\n\r\n    findNPCById(npcId: string): NPC | undefined {\r\n      return this.npcDatabase.find(n => n.id === npcId) || this.currentCellNPCs.find(n => n.id === npcId);\r\n    },\r\n\r\n    updateRelationship(npcId: string, delta: number) {\r\n      const npc = this.findNPCById(npcId);\r\n      if (npc && npc.relationship) {\r\n        npc.relationship.toProtagonist = Math.max(0, Math.min(100, npc.relationship.toProtagonist + delta));\r\n        DS.events.emit('relationship_changed', {\r\n          npcId,\r\n          npcName: npc.name,\r\n          value: npc.relationship.toProtagonist,\r\n          delta,\r\n        });\r\n      }\r\n    },\r\n\r\n    exportData() {\r\n      return {\r\n        database: this.npcDatabase,\r\n        currentCell: this.currentCellNPCs,\r\n      };\r\n    },\r\n\r\n    importData(data: { database?: NPC[]; currentCell?: NPC[] } | undefined): boolean {\r\n      if (!data) return false;\r\n      try {\r\n        this.npcDatabase = data.database || [];\r\n        this.currentCellNPCs = data.currentCell || [];\r\n        console.info('[NPC] ');\r\n        return true;\r\n      } catch (error) {\r\n        console.error('[NPC] :', error);\r\n        return false;\r\n      }\r\n    },\r\n\r\n    clearData() {\r\n      this.npcDatabase = [];\r\n      this.currentCellNPCs = [];\r\n      console.info('[NPC] ');\r\n    },\r\n  };\r\n\r\n  // ==========  ==========\r\n  DS.generateNPC = (count?: number, context?: Record<string, unknown>) => NPCGenerator.generate(count, context ?? {});\r\n  DS.generateNPCForEvent = (eventType: string) => NPCGenerator.generateForEvent(eventType);\r\n  DS.generateProtagonist = (options?: ProtagonistOptions) => NPCGenerator.generateProtagonist(options);\r\n  DS.getCurrentCellNPCs = () => NPCGenerator.getCurrentCellNPCs();\r\n  DS.setCurrentCellNPCs = (npcs: NPC[]) => NPCGenerator.setCurrentCellNPCs(npcs);\r\n  DS.addNPCToCell = (npc: NPC) => NPCGenerator.addNPCToCell(npc);\r\n  DS.removeNPCFromCell = (npcId: string) => NPCGenerator.removeNPCFromCell(npcId);\r\n  DS.findNPC = (npcId: string) => NPCGenerator.findNPCById(npcId);\r\n  DS.updateNPCRelationship = (npcId: string, delta: number) => NPCGenerator.updateRelationship(npcId, delta);\r\n  DS.exportNPCData = () => NPCGenerator.exportData();\r\n  DS.importNPCData = (data?: { database?: NPC[]; currentCell?: NPC[] }) => NPCGenerator.importData(data);\r\n\r\n  DS.registerModule('npcSystem', NPCGenerator);\r\n\r\n  // #region agent log - HYP-D: \r\n  try {\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'npc_system.ts:',\r\n        message: 'NPC',\r\n        data: {\r\n          registeredModule: DS.getModule('npcSystem') ? '' : '',\r\n          hasGenerateNPC: typeof DS.generateNPC === 'function',\r\n          hasGenerateNPCForEvent: typeof DS.generateNPCForEvent === 'function',\r\n          hasGetCurrentCellNPCs: typeof DS.getCurrentCellNPCs === 'function',\r\n          modulesCount: Object.keys(DS.modules).length,\r\n          moduleNames: Object.keys(DS.modules),\r\n        },\r\n        timestamp: Date.now(),\r\n        sessionId: 'debug-session',\r\n        runId: 'npc-load-debug',\r\n        hypothesisId: 'D',\r\n      }),\r\n    }).catch(() => {}); */\r\n  } catch (e) {\r\n    console.error('[NPC] :', e);\r\n  }\r\n  // #endregion\r\n\r\n  // iframe \r\n  try {\r\n    if (window.parent && window.parent !== window) {\r\n      // #region agent log - HYP-E: \r\n      try {\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'npc_system.ts:',\r\n            message: 'NPC',\r\n            data: {\r\n              parentExists: !!window.parent,\r\n              parentIsDifferent: window.parent !== window,\r\n              parentHasDetentionSystem: typeof (window.parent as any).detentionSystem !== 'undefined',\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'npc-load-debug',\r\n            hypothesisId: 'E',\r\n          }),\r\n        }).catch(() => {}); */\r\n      } catch (e) {\r\n        console.error('[NPC] :', e);\r\n      }\r\n      // #endregion\r\n\r\n      //  DS \r\n      const parentWindow = window.parent as typeof window.parent & { detentionSystem?: DetentionSystem };\r\n      parentWindow.detentionSystem = DS;\r\n      //  DS \r\n      if (parentWindow.detentionSystem) {\r\n        parentWindow.detentionSystem.generateNPC = DS.generateNPC;\r\n        parentWindow.detentionSystem.generateNPCForEvent = DS.generateNPCForEvent;\r\n        parentWindow.detentionSystem.generateProtagonist = DS.generateProtagonist;\r\n        parentWindow.detentionSystem.getCurrentCellNPCs = DS.getCurrentCellNPCs;\r\n        parentWindow.detentionSystem.setCurrentCellNPCs = DS.setCurrentCellNPCs;\r\n        parentWindow.detentionSystem.addNPCToCell = DS.addNPCToCell;\r\n        parentWindow.detentionSystem.removeNPCFromCell = DS.removeNPCFromCell;\r\n        parentWindow.detentionSystem.findNPC = DS.findNPC;\r\n        parentWindow.detentionSystem.updateNPCRelationship = DS.updateNPCRelationship;\r\n        parentWindow.detentionSystem.exportNPCData = DS.exportNPCData;\r\n        parentWindow.detentionSystem.importNPCData = DS.importNPCData;\r\n        parentWindow.detentionSystem.generateProtagonist = DS.generateProtagonist;\r\n      }\r\n      console.info('[NPC]  NPC');\r\n\r\n      // \r\n      const parentDS = (window.parent as any).detentionSystem;\r\n      if (parentDS) {\r\n        const verification = {\r\n          hasGenerateNPC: typeof parentDS.generateNPC === 'function',\r\n          hasGenerateNPCForEvent: typeof parentDS.generateNPCForEvent === 'function',\r\n          hasGenerateProtagonist: typeof parentDS.generateProtagonist === 'function',\r\n          hasGetCurrentCellNPCs: typeof parentDS.getCurrentCellNPCs === 'function',\r\n          hasSetCurrentCellNPCs: typeof parentDS.setCurrentCellNPCs === 'function',\r\n          modulesCount: parentDS.modules ? Object.keys(parentDS.modules).length : 0,\r\n          hasNPCSystemModule: !!(\r\n            parentDS.getModule &&\r\n            typeof parentDS.getModule === 'function' &&\r\n            parentDS.getModule('npcSystem')\r\n          ),\r\n        };\r\n        //  info error\r\n        if (verification.hasGenerateNPC && verification.hasNPCSystemModule) {\r\n          console.info('[NPC]  :', verification);\r\n        } else {\r\n          console.error('[NPC]  ', verification);\r\n        }\r\n      } else {\r\n        console.error('[NPC]   detentionSystem ');\r\n      }\r\n\r\n      // #region agent log - HYP-F: \r\n      try {\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'npc_system.ts:',\r\n            message: 'NPC',\r\n            data: {\r\n              parentHasDetentionSystem: typeof (window.parent as any).detentionSystem !== 'undefined',\r\n              parentHasGenerateNPC: typeof (window.parent as any).detentionSystem?.generateNPC === 'function',\r\n              parentHasGenerateProtagonist:\r\n                typeof (window.parent as any).detentionSystem?.generateProtagonist === 'function',\r\n              parentHasGenerateNPCForEvent:\r\n                typeof (window.parent as any).detentionSystem?.generateNPCForEvent === 'function',\r\n              iframeHasGenerateProtagonist: typeof DS.generateProtagonist === 'function',\r\n              parentModulesCount: (window.parent as any).detentionSystem?.modules\r\n                ? Object.keys((window.parent as any).detentionSystem.modules).length\r\n                : 0,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'npc-load-debug',\r\n            hypothesisId: 'F',\r\n          }),\r\n        }).catch(() => {}); */\r\n      } catch (e) {\r\n        console.error('[NPC] :', e);\r\n      }\r\n      // #endregion\r\n    }\r\n  } catch (e) {\r\n    // #region agent log - HYP-G: \r\n    try {\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'npc_system.ts:',\r\n          message: 'NPC',\r\n          data: {\r\n            error: e instanceof Error ? e.message : String(e),\r\n            errorType: typeof e,\r\n          },\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'npc-load-debug',\r\n          hypothesisId: 'G',\r\n        }),\r\n      }).catch(() => {}); */\r\n    } catch (logError) {\r\n      console.error('[NPC] :', logError);\r\n    }\r\n    // #endregion\r\n    console.warn('[NPC] :', e);\r\n  }\r\n\r\n  // ==========  ==========\r\n  DS.events.on('event_triggered', (event?: unknown) => {\r\n    const eventId =\r\n      typeof (event as EventTriggeredPayload | undefined)?.id === 'string'\r\n        ? (event as EventTriggeredPayload).id\r\n        : undefined;\r\n    if (!eventId) return;\r\n    if (['interrogation', 'lawyer_visit', 'family_visit', 'medical_visit', 'scene_identification'].includes(eventId)) {\r\n      const npc = NPCGenerator.generateForEvent(eventId);\r\n      DS.events.emit('event_npc_generated', { event, npc });\r\n    }\r\n  });\r\n\r\n  // ==========  ==========\r\n  DS.events.on('cell_transfer', (data?: unknown) => {\r\n    const to = (data as CellTransferPayload | undefined)?.to;\r\n    const newCellType = typeof to === 'string' ? to : 'transition';\r\n    const npcCount = Math.floor(Math.random() * 5) + 3;\r\n    const newNPCs = NPCGenerator.generate(npcCount, { cellType: newCellType });\r\n    NPCGenerator.setCurrentCellNPCs(newNPCs);\r\n    console.info(`[NPC] ${npcCount}NPC`);\r\n  });\r\n\r\n  console.info(' [NPC]  - ');\r\n  (window as any).__NPC_SYSTEM_LOADED__ = true;\r\n  (window as any).__NPC_SYSTEM_LOADED_TIMESTAMP__ = Date.now();\r\n});\r\n","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","/**\n *  - \n * HTML\n * : 3.5.6 ()\n */\n// ==========  ==========\nconst CONFIG = {\n    updateInterval: 500,\n    animationDuration: 300,\n    trendWindow: 5,\n    slowChangeThreshold: 1.0,\n    regressionRate: 0.005,\n    healthBaseline: 70,\n    mentalBaseline: 65,\n    parseRetryAttempts: 3,\n    parseRetryDelay: 100,\n    debugMode: true,\n};\nconst TREND_SYMBOLS = {\n    up: '',\n    down: '',\n    stable: '',\n};\nlet state = {\n    name: '',\n    age: 0,\n    crime: '',\n    health: 75,\n    mental: 70,\n    strength: 65,\n    intelligence: 70,\n    appearance: {\n        height: 0,\n        weight: 0,\n        hair: '',\n        condition: '',\n    },\n    clothing: {\n        top: '',\n        bottom: '',\n        underwear: '',\n        underpants: '',\n        socks: '',\n        shoes: '',\n        restraints: '',\n        cleanliness: '',\n    },\n    currentTask: '',\n    currentThought: '',\n    biggestWorry: '',\n    days: 0,\n    stage: '',\n    cellType: '',\n    changes: {\n        health: [],\n        mental: [],\n        strength: [],\n        intelligence: [],\n    },\n    accumulated: {\n        health: 0,\n        mental: 0,\n        strength: 0,\n        intelligence: 0,\n    },\n    lastUpdate: Date.now(),\n    stats: {\n        totalUpdates: 0,\n        successfulParses: 0,\n        failedParses: 0,\n        lastParseTime: 0,\n    },\n};\nconst skipDisplayUpdate = false;\nlet isUpdating = false;\nlet mutationObserver = null;\nlet updateLoopInterval = null;\n// ==========  ==========\nfunction debugLog(...args) {\n    if (CONFIG.debugMode) {\n        console.log('[]', ...args);\n    }\n}\nfunction formatDuration(ms) {\n    const seconds = Math.floor(ms / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const hours = Math.floor(minutes / 60);\n    const days = Math.floor(hours / 24);\n    if (days > 0)\n        return `${days}${hours % 24}`;\n    if (hours > 0)\n        return `${hours}${minutes % 60}`;\n    if (minutes > 0)\n        return `${minutes}${seconds % 60}`;\n    return `${seconds}`;\n}\n// ==========  ==========\nfunction recordChange(key, delta) {\n    if (!state.changes[key]) {\n        state.changes[key] = [];\n    }\n    state.changes[key].push({\n        value: delta,\n        timestamp: Date.now(),\n    });\n    if (state.changes[key].length > CONFIG.trendWindow) {\n        state.changes[key].shift();\n    }\n    debugLog(`: ${key} ${delta > 0 ? '+' : ''}${delta}`);\n}\nfunction calculateTrend(key) {\n    if (!state.changes[key] || state.changes[key].length === 0) {\n        return 'stable';\n    }\n    const sum = state.changes[key].reduce((acc, change) => acc + change.value, 0);\n    if (sum > 2)\n        return 'up';\n    if (sum < -2)\n        return 'down';\n    return 'stable';\n}\nfunction applyRegression() {\n    const healthDelta = (CONFIG.healthBaseline - state.health) * CONFIG.regressionRate;\n    if (Math.abs(healthDelta) > 0.01) {\n        state.accumulated.health += healthDelta;\n        if (Math.abs(state.accumulated.health) >= CONFIG.slowChangeThreshold) {\n            const change = Math.floor(state.accumulated.health);\n            state.health += change;\n            state.accumulated.health -= change;\n            recordChange('health', change);\n            debugLog(`: ${change}`);\n        }\n    }\n    const mentalDelta = (CONFIG.mentalBaseline - state.mental) * CONFIG.regressionRate;\n    if (Math.abs(mentalDelta) > 0.01) {\n        state.accumulated.mental += mentalDelta;\n        if (Math.abs(state.accumulated.mental) >= CONFIG.slowChangeThreshold) {\n            const change = Math.floor(state.accumulated.mental);\n            state.mental += change;\n            state.accumulated.mental -= change;\n            recordChange('mental', change);\n            debugLog(`: ${change}`);\n        }\n    }\n}\n// ==========  ==========\n/**\n * \n * @param stateData \n */\nfunction syncStateToMemoryEnhancement(stateData) {\n    // \n    try {\n        const currentChatId = typeof SillyTavern !== 'undefined' && SillyTavern.getCurrentChatId ? SillyTavern.getCurrentChatId() : null;\n        if (!currentChatId) {\n            // #region agent log\n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:syncStateToMemoryEnhancement',\n                message: '',\n                data: {\n                  hasChatId: false,\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-session',\n                runId: 'fix-save-chat-error',\n                hypothesisId: 'NO_CHAT_SKIP_SYNC',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n            console.debug('[] ');\n            return;\n        }\n        // \n        try {\n            const testChatVars = getVariables({ type: 'chat' });\n            if (!testChatVars || typeof testChatVars !== 'object') {\n                // #region agent log\n                //  CORS \n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                  method: 'POST',\n                  headers: { 'Content-Type': 'application/json' },\n                  body: JSON.stringify({\n                    location: 'status_panel.ts:syncStateToMemoryEnhancement',\n                    message: '',\n                    data: {\n                      hasChatId: !!currentChatId,\n                      hasChatVars: !!testChatVars,\n                    },\n                    timestamp: Date.now(),\n                    sessionId: 'debug-session',\n                    runId: 'fix-save-chat-error',\n                    hypothesisId: 'NO_CHAT_VARS_SKIP_SYNC',\n                  }),\n                }).catch(() => {}); */\n                // #endregion\n                console.debug('[] ');\n                return;\n            }\n        }\n        catch (testError) {\n            // #region agent log\n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:syncStateToMemoryEnhancement',\n                message: '',\n                data: {\n                  hasChatId: !!currentChatId,\n                  error: testError instanceof Error ? testError.message : String(testError),\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-session',\n                runId: 'fix-save-chat-error',\n                hypothesisId: 'TEST_CHAT_VARS_ERROR_SKIP_SYNC',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n            console.debug('[] :', testError);\n            return;\n        }\n    }\n    catch (checkError) {\n        // #region agent log\n        //  CORS \n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'status_panel.ts:syncStateToMemoryEnhancement',\n            message: '',\n            data: {\n              error: checkError instanceof Error ? checkError.message : String(checkError),\n            },\n            timestamp: Date.now(),\n            sessionId: 'debug-session',\n            runId: 'fix-save-chat-error',\n            hypothesisId: 'CHECK_CHAT_ERROR_SKIP_SYNC',\n          }),\n        }).catch(() => {}); */\n        // #endregion\n        console.debug('[] :', checkError);\n        return;\n    }\n    const plugin = detectMemoryEnhancementPlugin();\n    if (!plugin) {\n        return;\n    }\n    try {\n        //  updateState \n        if (typeof plugin.updateState === 'function') {\n            plugin.updateState(stateData);\n        }\n        //  setState \n        else if (typeof plugin.setState === 'function') {\n            plugin.setState(stateData);\n        }\n        // HTML\n    }\n    catch (error) {\n        console.warn('[] :', error);\n        // #region agent log\n        //  CORS \n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'status_panel.ts:syncStateToMemoryEnhancement',\n            message: '',\n            data: {\n              error: error instanceof Error ? error.message : String(error),\n              errorType: error instanceof Error ? error.constructor.name : typeof error,\n            },\n            timestamp: Date.now(),\n            sessionId: 'debug-session',\n            runId: 'fix-save-chat-error',\n            hypothesisId: 'SYNC_TO_PLUGIN_ERROR',\n          }),\n        }).catch(() => {}); */\n        // #endregion\n    }\n}\nfunction updateState(data) {\n    if (isUpdating) {\n        console.warn('[] ');\n        return;\n    }\n    isUpdating = true;\n    try {\n        debugLog(':', data);\n        state.stats.totalUpdates++;\n        if (data.name !== undefined)\n            state.name = data.name;\n        if (data.age !== undefined)\n            state.age = data.age;\n        if (data.crime !== undefined)\n            state.crime = data.crime;\n        if (data.health !== undefined) {\n            const delta = data.health - state.health;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.health = data.health;\n                recordChange('health', delta);\n                debugLog(`: ${state.health} (: ${delta})`);\n            }\n            else {\n                state.accumulated.health += delta;\n                debugLog(`: ${state.accumulated.health}`);\n                if (Math.abs(state.accumulated.health) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.health);\n                    state.health += change;\n                    state.accumulated.health -= change;\n                    recordChange('health', change);\n                    debugLog(`: ${state.health} (: ${change})`);\n                }\n            }\n        }\n        if (data.mental !== undefined) {\n            const delta = data.mental - state.mental;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.mental = data.mental;\n                recordChange('mental', delta);\n                debugLog(`: ${state.mental} (: ${delta})`);\n            }\n            else {\n                state.accumulated.mental += delta;\n                debugLog(`: ${state.accumulated.mental}`);\n                if (Math.abs(state.accumulated.mental) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.mental);\n                    state.mental += change;\n                    state.accumulated.mental -= change;\n                    recordChange('mental', change);\n                    debugLog(`: ${state.mental} (: ${change})`);\n                }\n            }\n        }\n        if (data.strength !== undefined) {\n            const delta = data.strength - state.strength;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.strength = data.strength;\n                recordChange('strength', delta);\n                debugLog(`: ${state.strength} (: ${delta})`);\n            }\n            else {\n                state.accumulated.strength += delta;\n                debugLog(`: ${state.accumulated.strength}`);\n                if (Math.abs(state.accumulated.strength) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.strength);\n                    state.strength += change;\n                    state.accumulated.strength -= change;\n                    recordChange('strength', change);\n                    debugLog(`: ${state.strength} (: ${change})`);\n                }\n            }\n        }\n        if (data.intelligence !== undefined) {\n            const delta = data.intelligence - state.intelligence;\n            if (Math.abs(delta) >= CONFIG.slowChangeThreshold) {\n                state.intelligence = data.intelligence;\n                recordChange('intelligence', delta);\n                debugLog(`: ${state.intelligence} (: ${delta})`);\n            }\n            else {\n                state.accumulated.intelligence += delta;\n                debugLog(`: ${state.accumulated.intelligence}`);\n                if (Math.abs(state.accumulated.intelligence) >= CONFIG.slowChangeThreshold) {\n                    const change = Math.floor(state.accumulated.intelligence);\n                    state.intelligence += change;\n                    state.accumulated.intelligence -= change;\n                    recordChange('intelligence', change);\n                    debugLog(`: ${state.intelligence} (: ${change})`);\n                }\n            }\n        }\n        if (data.appearance) {\n            if (data.appearance.height !== undefined)\n                state.appearance.height = data.appearance.height;\n            if (data.appearance.weight !== undefined)\n                state.appearance.weight = data.appearance.weight;\n            if (data.appearance.hair !== undefined)\n                state.appearance.hair = data.appearance.hair;\n            if (data.appearance.condition !== undefined)\n                state.appearance.condition = data.appearance.condition;\n        }\n        if (data.clothing) {\n            // #region agent log\n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:407',\n                message: 'updateStateclothing',\n                data: {\n                  top: data.clothing.top || 'null',\n                  bottom: data.clothing.bottom || 'null',\n                  topLength: data.clothing.top?.length || 0,\n                  bottomLength: data.clothing.bottom?.length || 0,\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-session',\n                runId: 'run1',\n                hypothesisId: 'A',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n            if (data.clothing.top !== undefined)\n                state.clothing.top = data.clothing.top;\n            if (data.clothing.bottom !== undefined)\n                state.clothing.bottom = data.clothing.bottom;\n            if (data.clothing.underwear !== undefined)\n                state.clothing.underwear = data.clothing.underwear;\n            if (data.clothing.underpants !== undefined)\n                state.clothing.underpants = data.clothing.underpants;\n            if (data.clothing.socks !== undefined)\n                state.clothing.socks = data.clothing.socks;\n            if (data.clothing.shoes !== undefined)\n                state.clothing.shoes = data.clothing.shoes;\n            if (data.clothing.restraints !== undefined)\n                state.clothing.restraints = data.clothing.restraints;\n            if (data.clothing.cleanliness !== undefined)\n                state.clothing.cleanliness = data.clothing.cleanliness;\n            // #region agent log\n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:416',\n                message: 'updateStateclothing',\n                data: {\n                  top: state.clothing.top || 'null',\n                  bottom: state.clothing.bottom || 'null',\n                  topLength: state.clothing.top?.length || 0,\n                  bottomLength: state.clothing.bottom?.length || 0,\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-session',\n                runId: 'run1',\n                hypothesisId: 'E',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n        }\n        if (data.currentTask !== undefined)\n            state.currentTask = data.currentTask;\n        if (data.currentThought !== undefined)\n            state.currentThought = data.currentThought;\n        if (data.biggestWorry !== undefined)\n            state.biggestWorry = data.biggestWorry;\n        if (data.days !== undefined)\n            state.days = data.days;\n        if (data.stage !== undefined)\n            state.stage = data.stage;\n        if (data.cellType !== undefined)\n            state.cellType = data.cellType;\n        state.lastUpdate = Date.now();\n        debugLog('');\n        // \n        const currentState = {\n            name: state.name,\n            age: state.age,\n            crime: state.crime,\n            health: state.health,\n            mental: state.mental,\n            strength: state.strength,\n            intelligence: state.intelligence,\n            appearance: { ...state.appearance },\n            clothing: { ...state.clothing },\n            currentTask: state.currentTask,\n            currentThought: state.currentThought,\n            biggestWorry: state.biggestWorry,\n            days: state.days,\n            stage: state.stage,\n            cellType: state.cellType,\n        };\n        syncStateToMemoryEnhancement(currentState);\n        updateDisplay();\n    }\n    catch (error) {\n        console.error('[] :', error);\n    }\n    finally {\n        isUpdating = false;\n    }\n}\n// ========== HTML ==========\nfunction parseCommentNode(node) {\n    if (!node || node.nodeType !== Node.COMMENT_NODE) {\n        return;\n    }\n    try {\n        let content = node.nodeValue || node.textContent || '';\n        content = content.trim();\n        if (!content) {\n            return;\n        }\n        debugLog(':', content.substring(0, 100) + (content.length > 100 ? '...' : ''));\n        if (content.startsWith('STATUS_UPDATE:')) {\n            const jsonStr = content.substring('STATUS_UPDATE:'.length).trim();\n            debugLog('JSON:', jsonStr.substring(0, 100) + (jsonStr.length > 100 ? '...' : ''));\n            parseStatusUpdate(jsonStr);\n        }\n    }\n    catch (error) {\n        console.error('[] :', error);\n    }\n}\nfunction parseStatusUpdate(jsonStr, attempt = 1) {\n    try {\n        jsonStr = jsonStr.trim();\n        jsonStr = jsonStr.replace(/,(\\s*[}\\]])/g, '$1');\n        jsonStr = jsonStr.replace(/[\\n\\r\\t]/g, '');\n        debugLog(`JSON (${attempt}):`, jsonStr.substring(0, 200) + (jsonStr.length > 200 ? '...' : ''));\n        const data = JSON.parse(jsonStr);\n        console.log('[]  :', data);\n        state.stats.successfulParses++;\n        state.stats.lastParseTime = Date.now();\n        updateState(data);\n        const DS = window.detentionSystem;\n        if (DS && DS.events) {\n            DS.events.emit('statusUpdated', data);\n        }\n        return true;\n    }\n    catch (error) {\n        const errorMessage = error instanceof Error ? error.message : String(error);\n        console.error(`[]   ( ${attempt}/${CONFIG.parseRetryAttempts}):`, errorMessage);\n        console.error('[] JSON:', jsonStr);\n        state.stats.failedParses++;\n        if (attempt < CONFIG.parseRetryAttempts) {\n            console.log(`[]  ${CONFIG.parseRetryDelay}ms ...`);\n            setTimeout(() => {\n                parseStatusUpdate(jsonStr, attempt + 1);\n            }, CONFIG.parseRetryDelay);\n            return false;\n        }\n        else {\n            console.error('[]  ');\n            const DS = window.detentionSystem;\n            if (DS && DS.events) {\n                DS.events.emit('parseError', {\n                    jsonStr,\n                    error: errorMessage,\n                    attempts: attempt,\n                });\n            }\n            return false;\n        }\n    }\n}\nfunction checkForStatusUpdate(element) {\n    if (!element || element.nodeType !== Node.ELEMENT_NODE) {\n        return;\n    }\n    try {\n        const walker = document.createTreeWalker(element, NodeFilter.SHOW_COMMENT);\n        let node;\n        let count = 0;\n        while ((node = walker.nextNode())) {\n            count++;\n            parseCommentNode(node);\n        }\n        if (count > 0) {\n            debugLog(`TreeWalker  ${count} `);\n        }\n    }\n    catch (error) {\n        console.error('[] TreeWalker :', error);\n    }\n}\n// ========== UI ==========\nfunction updateElement(id, value) {\n    const element = document.getElementById(id);\n    if (element && element.textContent !== value) {\n        element.textContent = value;\n        element.classList.remove('updated');\n        setTimeout(() => {\n            element.classList.add('updated');\n        }, 10);\n        setTimeout(() => {\n            element.classList.remove('updated');\n        }, 500);\n    }\n}\nfunction updateStat(key, value) {\n    value = Math.max(0, Math.min(100, value));\n    const valueElement = document.getElementById(`${key}-value`);\n    if (valueElement) {\n        valueElement.textContent = Math.round(value).toString();\n    }\n    const barElement = document.getElementById(`${key}-bar`);\n    if (barElement) {\n        barElement.style.width = `${value}%`;\n        const statBar = barElement.closest('.stat-bar');\n        if (statBar) {\n            statBar.classList.remove('changed');\n            setTimeout(() => {\n                statBar.classList.add('changed');\n            }, 10);\n            setTimeout(() => {\n                statBar.classList.remove('changed');\n            }, 500);\n        }\n    }\n    const trend = calculateTrend(key);\n    const trendElement = document.getElementById(`${key}-trend`);\n    if (trendElement) {\n        trendElement.textContent = TREND_SYMBOLS[trend];\n        trendElement.style.color = trend === 'up' ? '#43e97b' : trend === 'down' ? '#f5576c' : '#999';\n    }\n}\nfunction updateDisplay() {\n    // \n    // \n    if (skipDisplayUpdate)\n        return;\n    // UI\n    try {\n        const memoryState = getStateFromMemoryEnhancement();\n        if (memoryState) {\n            debugLog('[] ');\n        }\n    }\n    catch (error) {\n        console.error('[] :', error);\n    }\n}\nfunction addStyles() {\n    if (document.getElementById('detention-status-styles')) {\n        return;\n    }\n    const style = document.createElement('style');\n    style.id = 'detention-status-styles';\n    style.textContent = `\r\n    #detention-status-panel {\r\n      position: fixed;\r\n      top: 20px;\r\n      right: 20px;\r\n      width: 320px;\r\n      max-height: 90vh;\r\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n      border-radius: 12px;\r\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\r\n      z-index: 10000;\r\n      font-family: 'Microsoft YaHei', 'SimHei', sans-serif;\r\n      overflow: hidden;\r\n      backdrop-filter: blur(10px);\r\n    }\r\n\r\n    .status-header {\r\n      background: rgba(0, 0, 0, 0.2);\r\n      padding: 12px 16px;\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\r\n    }\r\n\r\n    .status-header h3 {\r\n      margin: 0;\r\n      color: #fff;\r\n      font-size: 16px;\r\n      font-weight: 600;\r\n    }\r\n\r\n    .status-header-buttons {\r\n      display: flex;\r\n      gap: 8px;\r\n    }\r\n\r\n    .status-toggle, .status-debug-btn {\r\n      background: rgba(255, 255, 255, 0.2);\r\n      border: none;\r\n      color: #fff;\r\n      width: 28px;\r\n      height: 28px;\r\n      border-radius: 6px;\r\n      cursor: pointer;\r\n      font-size: 16px;\r\n      line-height: 1;\r\n      transition: all 0.3s;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n    }\r\n\r\n    .status-toggle:hover, .status-debug-btn:hover {\r\n      background: rgba(255, 255, 255, 0.3);\r\n      transform: scale(1.1);\r\n    }\r\n\r\n    .status-content {\r\n      max-height: calc(90vh - 60px);\r\n      overflow-y: auto;\r\n      padding: 16px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar {\r\n      width: 6px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar-track {\r\n      background: rgba(0, 0, 0, 0.1);\r\n      border-radius: 3px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar-thumb {\r\n      background: rgba(255, 255, 255, 0.3);\r\n      border-radius: 3px;\r\n    }\r\n\r\n    .status-content::-webkit-scrollbar-thumb:hover {\r\n      background: rgba(255, 255, 255, 0.5);\r\n    }\r\n\r\n    .status-section {\r\n      background: rgba(255, 255, 255, 0.95);\r\n      border-radius: 8px;\r\n      padding: 12px;\r\n      margin-bottom: 12px;\r\n    }\r\n\r\n    .status-section:last-child {\r\n      margin-bottom: 0;\r\n    }\r\n\r\n    .status-section h4 {\r\n      margin: 0 0 10px 0;\r\n      color: #667eea;\r\n      font-size: 14px;\r\n      font-weight: 600;\r\n      border-bottom: 2px solid #667eea;\r\n      padding-bottom: 6px;\r\n    }\r\n\r\n    .status-item {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 6px 0;\r\n      border-bottom: 1px solid rgba(0, 0, 0, 0.05);\r\n    }\r\n\r\n    .status-item:last-child {\r\n      border-bottom: none;\r\n    }\r\n\r\n    .status-item.full-width {\r\n      flex-direction: column;\r\n      align-items: flex-start;\r\n    }\r\n\r\n    .status-item.full-width .value {\r\n      width: 100%;\r\n      margin-top: 4px;\r\n      padding: 6px;\r\n      background: rgba(102, 126, 234, 0.1);\r\n      border-radius: 4px;\r\n    }\r\n\r\n    .status-item .label {\r\n      color: #666;\r\n      font-size: 13px;\r\n      font-weight: 500;\r\n    }\r\n\r\n    .status-item .value {\r\n      color: #333;\r\n      font-size: 13px;\r\n      font-weight: 600;\r\n      text-align: right;\r\n    }\r\n\r\n    .stat-bar {\r\n      margin-bottom: 12px;\r\n    }\r\n\r\n    .stat-bar:last-child {\r\n      margin-bottom: 0;\r\n    }\r\n\r\n    .stat-label {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      margin-bottom: 6px;\r\n      font-size: 13px;\r\n      font-weight: 600;\r\n      color: #333;\r\n    }\r\n\r\n    .stat-value {\r\n      color: #667eea;\r\n      font-size: 14px;\r\n    }\r\n\r\n    .stat-trend {\r\n      font-size: 16px;\r\n      margin-left: 4px;\r\n    }\r\n\r\n    .stat-progress {\r\n      height: 8px;\r\n      background: rgba(0, 0, 0, 0.1);\r\n      border-radius: 4px;\r\n      overflow: hidden;\r\n    }\r\n\r\n    .stat-fill {\r\n      height: 100%;\r\n      transition: width 0.3s ease, background-color 0.3s ease;\r\n      border-radius: 4px;\r\n    }\r\n\r\n    .stat-fill.health {\r\n      background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);\r\n    }\r\n\r\n    .stat-fill.mental {\r\n      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);\r\n    }\r\n\r\n    .stat-fill.strength {\r\n      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);\r\n    }\r\n\r\n    .stat-fill.intelligence {\r\n      background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);\r\n    }\r\n\r\n    .debug-buttons {\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 8px;\r\n      margin-top: 12px;\r\n    }\r\n\r\n    .debug-btn {\r\n      background: #667eea;\r\n      color: white;\r\n      border: none;\r\n      padding: 8px 12px;\r\n      border-radius: 6px;\r\n      cursor: pointer;\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      transition: all 0.3s;\r\n    }\r\n\r\n    .debug-btn:hover {\r\n      background: #764ba2;\r\n      transform: translateY(-2px);\r\n      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\r\n    }\r\n\r\n    @keyframes pulse {\r\n      0%, 100% { transform: scale(1); }\r\n      50% { transform: scale(1.05); }\r\n    }\r\n\r\n    .stat-bar.changed {\r\n      animation: pulse 0.5s ease;\r\n    }\r\n\r\n    @keyframes fadeIn {\r\n      from { opacity: 0; transform: translateY(-10px); }\r\n      to { opacity: 1; transform: translateY(0); }\r\n    }\r\n\r\n    .status-item.updated {\r\n      animation: fadeIn 0.3s ease;\r\n    }\r\n\r\n    @media (max-width: 768px) {\r\n      #detention-status-panel {\r\n        width: 280px;\r\n        top: 10px;\r\n        right: 10px;\r\n      }\r\n    }\r\n  `;\n    document.head.appendChild(style);\n}\nfunction createStatusPanel() {\n    // \n    // UI\n    const memoryEnhancement = detectMemoryEnhancementPlugin();\n    if (memoryEnhancement) {\n        console.log('[] ');\n    }\n    else {\n        console.log('[] ');\n    }\n}\nfunction updateDebugInfo() {\n    updateElement('debug-total-updates', state.stats.totalUpdates.toString());\n    updateElement('debug-success-parses', state.stats.successfulParses.toString());\n    updateElement('debug-failed-parses', state.stats.failedParses.toString());\n    const lastUpdate = state.stats.lastParseTime > 0 ? new Date(state.stats.lastParseTime).toLocaleTimeString('zh-CN') : '';\n    updateElement('debug-last-update', lastUpdate);\n    const observerStatus = mutationObserver ? '' : '';\n    updateElement('debug-observer-status', observerStatus);\n}\n// ==========  ==========\nfunction startCommentListener() {\n    if (mutationObserver) {\n        mutationObserver.disconnect();\n    }\n    console.log('[] HTML...');\n    mutationObserver = new MutationObserver(mutations => {\n        for (const mutation of mutations) {\n            if (mutation.type === 'childList') {\n                for (const node of mutation.addedNodes) {\n                    if (node.nodeType === Node.COMMENT_NODE) {\n                        parseCommentNode(node);\n                    }\n                    else if (node.nodeType === Node.ELEMENT_NODE) {\n                        checkForStatusUpdate(node);\n                    }\n                }\n            }\n            if (mutation.type === 'characterData') {\n                if (mutation.target.nodeType === Node.COMMENT_NODE) {\n                    parseCommentNode(mutation.target);\n                }\n            }\n        }\n    });\n    mutationObserver.observe(document.body, {\n        childList: true,\n        subtree: true,\n        characterData: true,\n        characterDataOldValue: false,\n    });\n    console.log('[] ...');\n    setTimeout(() => {\n        checkForStatusUpdate(document.body);\n    }, 1000);\n    console.log('[] HTML');\n}\nfunction stopCommentListener() {\n    if (mutationObserver) {\n        mutationObserver.disconnect();\n        mutationObserver = null;\n        console.log('[] HTML');\n    }\n}\nfunction startUpdateLoop() {\n    // \n    // \n    debugLog('');\n}\nfunction stopUpdateLoop() {\n    // \n    if (updateLoopInterval) {\n        clearInterval(updateLoopInterval);\n        updateLoopInterval = null;\n    }\n}\n// ==========  ==========\n/**\n * \n * @returns  null\n */\nfunction detectMemoryEnhancementPlugin() {\n    // #region agent log - HYP-E: \n    //  CORS \n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        location: 'status_panel.ts:1225',\n        message: '',\n        data: {\n          hasWindow: typeof window !== 'undefined',\n          hasStMemoryEnhancement: !!(window as any).stMemoryEnhancement,\n          hasMemoryEnhancement: !!(window as any).MemoryEnhancement,\n          hasMemoryEnhancementLower: !!(window as any).memoryEnhancement,\n          hasMemoryEnhancementPlugin: !!(window as any).MemoryEnhancementPlugin,\n          hasMemoryEnhancementPluginLower: !!(window as any).memoryEnhancementPlugin,\n          stMemoryEnhancementType: typeof (window as any).stMemoryEnhancement,\n          memoryEnhancementType: typeof (window as any).MemoryEnhancement,\n          memoryEnhancementLowerType: typeof (window as any).memoryEnhancement,\n        },\n        timestamp: Date.now(),\n        sessionId: 'debug-status-panel',\n        runId: 'run1',\n        hypothesisId: 'E',\n      }),\n    }).catch(() => {}); */\n    // #endregion\n    try {\n        //  stMemoryEnhancement\n        const memoryEnhancement = window.stMemoryEnhancement ||\n            window.MemoryEnhancement ||\n            window.memoryEnhancement ||\n            window.MemoryEnhancementPlugin ||\n            window.memoryEnhancementPlugin;\n        // #region agent log - HYP-E: \n        //  CORS \n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'status_panel.ts:1234',\n            message: '',\n            data: {\n              hasPlugin: !!memoryEnhancement,\n              pluginType: typeof memoryEnhancement,\n              pluginKeys: memoryEnhancement ? Object.keys(memoryEnhancement).slice(0, 10) : [],\n            },\n            timestamp: Date.now(),\n            sessionId: 'debug-status-panel',\n            runId: 'run1',\n            hypothesisId: 'E',\n          }),\n        }).catch(() => {}); */\n        // #endregion\n        //  ext_getAllTables  ext_exportAllTablesAsJson\n        if (memoryEnhancement &&\n            (typeof memoryEnhancement.ext_getAllTables === 'function' ||\n                typeof memoryEnhancement.ext_exportAllTablesAsJson === 'function')) {\n            // #region agent log - HYP-E: \n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:1235',\n                message: '',\n                data: {\n                  success: true,\n                  hasExtGetAllTables: typeof memoryEnhancement.ext_getAllTables === 'function',\n                  hasExtExportAllTablesAsJson: typeof memoryEnhancement.ext_exportAllTablesAsJson === 'function',\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-status-panel',\n                runId: 'run1',\n                hypothesisId: 'E',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n            return memoryEnhancement;\n        }\n        // #region agent log - HYP-E: \n        //  CORS \n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'status_panel.ts:1237',\n            message: '',\n            data: {\n              hasPlugin: !!memoryEnhancement,\n              hasExtGetAllTables: !!(memoryEnhancement && typeof memoryEnhancement.ext_getAllTables === 'function'),\n              hasExtExportAllTablesAsJson: !!(\n                memoryEnhancement && typeof memoryEnhancement.ext_exportAllTablesAsJson === 'function'\n              ),\n            },\n            timestamp: Date.now(),\n            sessionId: 'debug-status-panel',\n            runId: 'run1',\n            hypothesisId: 'E',\n          }),\n        }).catch(() => {}); */\n        // #endregion\n        return null;\n    }\n    catch (error) {\n        console.warn('[] :', error);\n        // #region agent log - HYP-E: \n        //  CORS \n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'status_panel.ts:1239',\n            message: '',\n            data: {\n              error: error instanceof Error ? error.message : String(error),\n              errorStack: error instanceof Error ? error.stack : undefined,\n            },\n            timestamp: Date.now(),\n            sessionId: 'debug-status-panel',\n            runId: 'run1',\n            hypothesisId: 'E',\n          }),\n        }).catch(() => {}); */\n        // #endregion\n        return null;\n    }\n}\n/**\n * \n * @returns  null\n */\nfunction getStateFromMemoryEnhancement() {\n    const plugin = detectMemoryEnhancementPlugin();\n    if (!plugin) {\n        return null;\n    }\n    try {\n        // \n        let memoryState = null;\n        //  getState \n        //  ext_exportAllTablesAsJson\n        if (!memoryState) {\n            // #region agent log - HYP-E: \n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                message: '',\n                data: {\n                  hasExtGetAllTables: typeof plugin.ext_getAllTables === 'function',\n                  hasExtExportAllTablesAsJson: typeof plugin.ext_exportAllTablesAsJson === 'function',\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-status-panel',\n                runId: 'run1',\n                hypothesisId: 'E',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n            // \n            // \n            try {\n                const chatVars = getVariables({ type: 'chat' });\n                const messageVars = getVariables({ type: 'message', message_id: 'latest' });\n                // \n                const possiblePaths = [\n                    'state',\n                    'status',\n                    'character',\n                    'protagonist',\n                    'player',\n                    'main',\n                    'current',\n                    'stat_data',\n                    'memory',\n                    'memoryEnhancement',\n                    'stMemoryEnhancement',\n                ];\n                for (const path of possiblePaths) {\n                    // \n                    if (chatVars && typeof chatVars === 'object' && path in chatVars) {\n                        const candidate = chatVars[path];\n                        if (candidate && typeof candidate === 'object' && ('health' in candidate || 'mental' in candidate)) {\n                            memoryState = candidate;\n                            // #region agent log - HYP-E: \n                            //  CORS \n                            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                              method: 'POST',\n                              headers: { 'Content-Type': 'application/json' },\n                              body: JSON.stringify({\n                                location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                                message: '',\n                                data: {\n                                  path: `chat.${path}`,\n                                  hasHealth: 'health' in candidate,\n                                  hasMental: 'mental' in candidate,\n                                },\n                                timestamp: Date.now(),\n                                sessionId: 'debug-status-panel',\n                                runId: 'run1',\n                                hypothesisId: 'E',\n                              }),\n                            }).catch(() => {}); */\n                            // #endregion\n                            break;\n                        }\n                    }\n                    // \n                    if (messageVars && typeof messageVars === 'object' && path in messageVars) {\n                        const candidate = messageVars[path];\n                        if (candidate && typeof candidate === 'object' && ('health' in candidate || 'mental' in candidate)) {\n                            memoryState = candidate;\n                            // #region agent log - HYP-E: \n                            //  CORS \n                            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                              method: 'POST',\n                              headers: { 'Content-Type': 'application/json' },\n                              body: JSON.stringify({\n                                location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                                message: '',\n                                data: {\n                                  path: `message.${path}`,\n                                  hasHealth: 'health' in candidate,\n                                  hasMental: 'mental' in candidate,\n                                },\n                                timestamp: Date.now(),\n                                sessionId: 'debug-status-panel',\n                                runId: 'run1',\n                                hypothesisId: 'E',\n                              }),\n                            }).catch(() => {}); */\n                            // #endregion\n                            break;\n                        }\n                    }\n                }\n                // \n                if (!memoryState) {\n                    const searchInVars = (vars, prefix = '') => {\n                        if (!vars || typeof vars !== 'object')\n                            return null;\n                        if (Array.isArray(vars)) {\n                            for (let i = 0; i < vars.length; i++) {\n                                const result = searchInVars(vars[i], `${prefix}[${i}]`);\n                                if (result)\n                                    return result;\n                            }\n                            return null;\n                        }\n                        if ('health' in vars && 'mental' in vars) {\n                            return vars;\n                        }\n                        for (const [key, value] of Object.entries(vars)) {\n                            const result = searchInVars(value, prefix ? `${prefix}.${key}` : key);\n                            if (result)\n                                return result;\n                        }\n                        return null;\n                    };\n                    const foundInChat = searchInVars(chatVars);\n                    if (foundInChat) {\n                        memoryState = foundInChat;\n                        // #region agent log - HYP-E: \n                        //  CORS \n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                          method: 'POST',\n                          headers: { 'Content-Type': 'application/json' },\n                          body: JSON.stringify({\n                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                            message: '',\n                            data: {\n                              hasHealth: 'health' in foundInChat,\n                              hasMental: 'mental' in foundInChat,\n                            },\n                            timestamp: Date.now(),\n                            sessionId: 'debug-status-panel',\n                            runId: 'run1',\n                            hypothesisId: 'E',\n                          }),\n                        }).catch(() => {}); */\n                        // #endregion\n                    }\n                    else {\n                        const foundInMessage = searchInVars(messageVars);\n                        if (foundInMessage) {\n                            memoryState = foundInMessage;\n                            // #region agent log - HYP-E: \n                            //  CORS \n                            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                              method: 'POST',\n                              headers: { 'Content-Type': 'application/json' },\n                              body: JSON.stringify({\n                                location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                                message: '',\n                                data: {\n                                  hasHealth: 'health' in foundInMessage,\n                                  hasMental: 'mental' in foundInMessage,\n                                },\n                                timestamp: Date.now(),\n                                sessionId: 'debug-status-panel',\n                                runId: 'run1',\n                                hypothesisId: 'E',\n                              }),\n                            }).catch(() => {}); */\n                            // #endregion\n                        }\n                    }\n                }\n            }\n            catch (error) {\n                console.warn('[] :', error);\n                // #region agent log - HYP-E: \n                //  CORS \n                /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                  method: 'POST',\n                  headers: { 'Content-Type': 'application/json' },\n                  body: JSON.stringify({\n                    location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                    message: '',\n                    data: {\n                      error: error instanceof Error ? error.message : String(error),\n                    },\n                    timestamp: Date.now(),\n                    sessionId: 'debug-status-panel',\n                    runId: 'run1',\n                    hypothesisId: 'E',\n                  }),\n                }).catch(() => {}); */\n                // #endregion\n            }\n            //  ext_exportAllTablesAsJson\n            //  ext_exportAllTablesAsJson  ext_getAllTables\n            if (!memoryState) {\n                //  ext_exportAllTablesAsJson\n                if (typeof plugin.ext_exportAllTablesAsJson === 'function') {\n                    try {\n                        // #region agent log - HYP-E:  ext_exportAllTablesAsJson \n                        //  CORS \n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                          method: 'POST',\n                          headers: { 'Content-Type': 'application/json' },\n                          body: JSON.stringify({\n                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                            message: ' ext_exportAllTablesAsJson ',\n                            data: {\n                              hasExtExportAllTablesAsJson: true,\n                            },\n                            timestamp: Date.now(),\n                            sessionId: 'debug-status-panel',\n                            runId: 'run1',\n                            hypothesisId: 'E',\n                          }),\n                        }).catch(() => {}); */\n                        // #endregion\n                        const jsonData = plugin.ext_exportAllTablesAsJson();\n                        // #region agent log - HYP-E: ext_exportAllTablesAsJson \n                        //  CORS \n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                          method: 'POST',\n                          headers: { 'Content-Type': 'application/json' },\n                          body: JSON.stringify({\n                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                            message: 'ext_exportAllTablesAsJson ',\n                            data: {\n                              isObject: typeof jsonData === 'object' && jsonData !== null,\n                              tableCount: typeof jsonData === 'object' && jsonData !== null ? Object.keys(jsonData).length : 0,\n                              tableUids: typeof jsonData === 'object' && jsonData !== null ? Object.keys(jsonData).slice(0, 5) : [],\n                            },\n                            timestamp: Date.now(),\n                            sessionId: 'debug-status-panel',\n                            runId: 'run1',\n                            hypothesisId: 'E',\n                          }),\n                        }).catch(() => {}); */\n                        // #endregion\n                        // ext_exportAllTablesAsJson : {uid: {uid, name, content: Array<Array<string>>}, ...}\n                        if (jsonData && typeof jsonData === 'object' && !Array.isArray(jsonData)) {\n                            const tables = Object.values(jsonData);\n                            // \n                            const possibleTableNames = [\n                                'state',\n                                'status',\n                                'character',\n                                'protagonist',\n                                'player',\n                                'main',\n                                'current',\n                                '',\n                                '',\n                                '',\n                                '',\n                            ];\n                            let targetTable = null;\n                            for (const table of tables) {\n                                if (table &&\n                                    typeof table === 'object' &&\n                                    'name' in table &&\n                                    typeof table.name === 'string' &&\n                                    possibleTableNames.some(name => table.name.toLowerCase().includes(name.toLowerCase()))) {\n                                    targetTable = table;\n                                    break;\n                                }\n                            }\n                            //  health  mental \n                            if (!targetTable) {\n                                for (const table of tables) {\n                                    if (table &&\n                                        typeof table === 'object' &&\n                                        'content' in table &&\n                                        Array.isArray(table.content) &&\n                                        table.content.length >= 2) {\n                                        const header = table.content[0];\n                                        if (Array.isArray(header) &&\n                                            (header.some((h) => h && h.toLowerCase().includes('health')) ||\n                                                header.some((h) => h && h.toLowerCase().includes('mental')) ||\n                                                header.some((h) => h && h.toLowerCase().includes('')) ||\n                                                header.some((h) => h && h.toLowerCase().includes('')))) {\n                                            targetTable = table;\n                                            break;\n                                        }\n                                    }\n                                }\n                            }\n                            // \n                            if (targetTable && Array.isArray(targetTable.content) && targetTable.content.length >= 2) {\n                                const header = targetTable.content[0];\n                                const firstDataRow = targetTable.content[1];\n                                if (Array.isArray(header) && Array.isArray(firstDataRow)) {\n                                    const stateObj = {};\n                                    header.forEach((colName, index) => {\n                                        if (colName && firstDataRow[index] !== undefined) {\n                                            const normalizedName = colName.toLowerCase().trim();\n                                            const value = firstDataRow[index];\n                                            const numValue = typeof value === 'string' ? parseFloat(value) : value;\n                                            const finalValue = !isNaN(numValue) && numValue !== null ? numValue : value;\n                                            if (normalizedName.includes('health') || normalizedName.includes('')) {\n                                                stateObj.health = finalValue;\n                                            }\n                                            else if (normalizedName.includes('mental') || normalizedName.includes('')) {\n                                                stateObj.mental = finalValue;\n                                            }\n                                            else if (normalizedName.includes('strength') || normalizedName.includes('')) {\n                                                stateObj.strength = finalValue;\n                                            }\n                                            else if (normalizedName.includes('intelligence') || normalizedName.includes('')) {\n                                                stateObj.intelligence = finalValue;\n                                            }\n                                            stateObj[colName] = finalValue;\n                                        }\n                                    });\n                                    if ('health' in stateObj || 'mental' in stateObj) {\n                                        memoryState = stateObj;\n                                        // #region agent log - HYP-E:  JSON \n                                        //  CORS \n                                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                                          method: 'POST',\n                                          headers: { 'Content-Type': 'application/json' },\n                                          body: JSON.stringify({\n                                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                                            message: ' JSON ',\n                                            data: {\n                                              tableName: targetTable.name || 'unknown',\n                                              hasHealth: 'health' in stateObj,\n                                              hasMental: 'mental' in stateObj,\n                                            },\n                                            timestamp: Date.now(),\n                                            sessionId: 'debug-status-panel',\n                                            runId: 'run1',\n                                            hypothesisId: 'E',\n                                          }),\n                                        }).catch(() => {}); */\n                                        // #endregion\n                                    }\n                                }\n                            }\n                        }\n                    }\n                    catch (jsonError) {\n                        console.warn('[] ext_exportAllTablesAsJson  ext_getAllTables:', jsonError);\n                        // #region agent log - HYP-E: ext_exportAllTablesAsJson  ext_getAllTables\n                        //  CORS \n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                          method: 'POST',\n                          headers: { 'Content-Type': 'application/json' },\n                          body: JSON.stringify({\n                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                            message: 'ext_exportAllTablesAsJson  ext_getAllTables',\n                            data: {\n                              error: jsonError instanceof Error ? jsonError.message : String(jsonError),\n                            },\n                            timestamp: Date.now(),\n                            sessionId: 'debug-status-panel',\n                            runId: 'run1',\n                            hypothesisId: 'E',\n                          }),\n                        }).catch(() => {}); */\n                        // #endregion\n                    }\n                }\n                //  ext_exportAllTablesAsJson  ext_getAllTables\n                if (!memoryState && typeof plugin.ext_getAllTables === 'function') {\n                    try {\n                        // #region agent log - HYP-E:  ext_getAllTables \n                        //  CORS \n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                          method: 'POST',\n                          headers: { 'Content-Type': 'application/json' },\n                          body: JSON.stringify({\n                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                            message: ' ext_getAllTables ',\n                            data: {\n                              hasExtGetAllTables: true,\n                            },\n                            timestamp: Date.now(),\n                            sessionId: 'debug-status-panel',\n                            runId: 'run1',\n                            hypothesisId: 'E',\n                          }),\n                        }).catch(() => {}); */\n                        // #endregion\n                        const allTables = plugin.ext_getAllTables();\n                        // #region agent log - HYP-E: ext_getAllTables \n                        //  CORS \n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                          method: 'POST',\n                          headers: { 'Content-Type': 'application/json' },\n                          body: JSON.stringify({\n                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                            message: 'ext_getAllTables ',\n                            data: {\n                              isArray: Array.isArray(allTables),\n                              length: Array.isArray(allTables) ? allTables.length : 0,\n                              tableNames: Array.isArray(allTables) ? allTables.map((t: any) => t?.name).filter(Boolean) : [],\n                            },\n                            timestamp: Date.now(),\n                            sessionId: 'debug-status-panel',\n                            runId: 'run1',\n                            hypothesisId: 'E',\n                          }),\n                        }).catch(() => {}); */\n                        // #endregion\n                        // ext_getAllTables : [{name: string, data: Array<Array<string>>}, ...]\n                        // data \n                        if (Array.isArray(allTables) && allTables.length > 0) {\n                            // \n                            const possibleTableNames = [\n                                'state',\n                                'status',\n                                'character',\n                                'protagonist',\n                                'player',\n                                'main',\n                                'current',\n                                '',\n                                '',\n                                '',\n                                '',\n                            ];\n                            let targetTable = null;\n                            for (const table of allTables) {\n                                if (table &&\n                                    table.name &&\n                                    possibleTableNames.some(name => table.name.toLowerCase().includes(name.toLowerCase()))) {\n                                    targetTable = table;\n                                    break;\n                                }\n                            }\n                            //  health  mental \n                            if (!targetTable) {\n                                for (const table of allTables) {\n                                    if (!table || !Array.isArray(table.data) || table.data.length < 2)\n                                        continue;\n                                    const header = table.data[0]; // \n                                    if (Array.isArray(header) &&\n                                        (header.some((h) => h && h.toLowerCase().includes('health')) ||\n                                            header.some((h) => h && h.toLowerCase().includes('mental')) ||\n                                            header.some((h) => h && h.toLowerCase().includes('')) ||\n                                            header.some((h) => h && h.toLowerCase().includes('')))) {\n                                        targetTable = table;\n                                        break;\n                                    }\n                                }\n                            }\n                            // \n                            if (targetTable && Array.isArray(targetTable.data) && targetTable.data.length >= 2) {\n                                const header = targetTable.data[0];\n                                const firstDataRow = targetTable.data[1]; // \n                                if (Array.isArray(header) && Array.isArray(firstDataRow)) {\n                                    const stateObj = {};\n                                    header.forEach((colName, index) => {\n                                        if (colName && firstDataRow[index] !== undefined) {\n                                            // \n                                            const normalizedName = colName.toLowerCase().trim();\n                                            const value = firstDataRow[index];\n                                            // \n                                            const numValue = typeof value === 'string' ? parseFloat(value) : value;\n                                            const finalValue = !isNaN(numValue) && numValue !== null ? numValue : value;\n                                            // \n                                            if (normalizedName.includes('health') || normalizedName.includes('')) {\n                                                stateObj.health = finalValue;\n                                            }\n                                            else if (normalizedName.includes('mental') || normalizedName.includes('')) {\n                                                stateObj.mental = finalValue;\n                                            }\n                                            else if (normalizedName.includes('strength') || normalizedName.includes('')) {\n                                                stateObj.strength = finalValue;\n                                            }\n                                            else if (normalizedName.includes('intelligence') || normalizedName.includes('')) {\n                                                stateObj.intelligence = finalValue;\n                                            }\n                                            // \n                                            stateObj[colName] = finalValue;\n                                        }\n                                    });\n                                    //  health  mental\n                                    if ('health' in stateObj || 'mental' in stateObj) {\n                                        memoryState = stateObj;\n                                        // #region agent log - HYP-E: \n                                        //  CORS \n                                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                                          method: 'POST',\n                                          headers: { 'Content-Type': 'application/json' },\n                                          body: JSON.stringify({\n                                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                                            message: '',\n                                            data: {\n                                              tableName: targetTable.name,\n                                              hasHealth: 'health' in stateObj,\n                                              hasMental: 'mental' in stateObj,\n                                              stateKeys: Object.keys(stateObj).slice(0, 10),\n                                            },\n                                            timestamp: Date.now(),\n                                            sessionId: 'debug-status-panel',\n                                            runId: 'run1',\n                                            hypothesisId: 'E',\n                                          }),\n                                        }).catch(() => {}); */\n                                        // #endregion\n                                    }\n                                }\n                            }\n                        }\n                    }\n                    catch (extError) {\n                        // ext_getAllTables  table.getBody is not a function\n                        console.warn('[] ext_getAllTables :', extError);\n                        // #region agent log - HYP-E: ext_getAllTables \n                        //  CORS \n                        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n                          method: 'POST',\n                          headers: { 'Content-Type': 'application/json' },\n                          body: JSON.stringify({\n                            location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                            message: 'ext_getAllTables ',\n                            data: {\n                              error: extError instanceof Error ? extError.message : String(extError),\n                            },\n                            timestamp: Date.now(),\n                            sessionId: 'debug-status-panel',\n                            runId: 'run1',\n                            hypothesisId: 'E',\n                          }),\n                        }).catch(() => {}); */\n                        // #endregion\n                    }\n                }\n            }\n        } //  if (!memoryState) - \n        if (!memoryState || typeof memoryState !== 'object') {\n            // #region agent log - HYP-E: \n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                message: '',\n                data: {\n                  hasExtGetAllTables: typeof plugin.ext_getAllTables === 'function',\n                  hasExtExportAllTablesAsJson: typeof plugin.ext_exportAllTablesAsJson === 'function',\n                  memoryStateType: typeof memoryState,\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-status-panel',\n                runId: 'run1',\n                hypothesisId: 'E',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n            return null;\n        }\n        // \n        if (memoryState.health === undefined && memoryState.mental === undefined) {\n            // #region agent log - HYP-E: \n            //  CORS \n            /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                location: 'status_panel.ts:getStateFromMemoryEnhancement',\n                message: ' health  mental',\n                data: {\n                  memoryStateKeys: Object.keys(memoryState).slice(0, 20),\n                },\n                timestamp: Date.now(),\n                sessionId: 'debug-status-panel',\n                runId: 'run1',\n                hypothesisId: 'E',\n              }),\n            }).catch(() => {}); */\n            // #endregion\n            return null;\n        }\n        // \n        const fullState = {\n            name: memoryState.name ?? state.name ?? undefined,\n            age: memoryState.age ?? state.age ?? undefined,\n            crime: memoryState.crime ?? state.crime ?? undefined,\n            health: memoryState.health ?? state.health ?? 70,\n            mental: memoryState.mental ?? state.mental ?? 65,\n            strength: memoryState.strength ?? state.strength ?? 50,\n            intelligence: memoryState.intelligence ?? state.intelligence ?? 55,\n            appearance: memoryState.appearance\n                ? {\n                    height: memoryState.appearance.height ?? state.appearance.height,\n                    weight: memoryState.appearance.weight ?? state.appearance.weight,\n                    hair: memoryState.appearance.hair ?? state.appearance.hair,\n                    condition: memoryState.appearance.condition ?? state.appearance.condition,\n                }\n                : { ...state.appearance },\n            clothing: memoryState.clothing\n                ? {\n                    top: memoryState.clothing.top ?? state.clothing.top,\n                    bottom: memoryState.clothing.bottom ?? state.clothing.bottom,\n                    underwear: memoryState.clothing.underwear ?? state.clothing.underwear,\n                    underpants: memoryState.clothing.underpants ?? state.clothing.underpants,\n                    socks: memoryState.clothing.socks ?? state.clothing.socks,\n                    shoes: memoryState.clothing.shoes ?? state.clothing.shoes,\n                    restraints: memoryState.clothing.restraints ?? state.clothing.restraints,\n                    cleanliness: memoryState.clothing.cleanliness ?? state.clothing.cleanliness,\n                }\n                : { ...state.clothing },\n            currentTask: memoryState.currentTask ?? state.currentTask ?? undefined,\n            currentThought: memoryState.currentThought ?? state.currentThought ?? undefined,\n            biggestWorry: memoryState.biggestWorry ?? state.biggestWorry ?? undefined,\n            days: memoryState.days ?? memoryState.day ?? state.days ?? 0,\n            stage: memoryState.stage ?? state.stage ?? undefined,\n            cellType: memoryState.cellType ?? memoryState.cell_type ?? state.cellType ?? undefined,\n        };\n        return fullState;\n    }\n    catch (error) {\n        console.warn('[] :', error);\n        return null;\n    }\n}\n// ========== API ==========\nconst StatusPanel = {\n    version: '3.5.6',\n    state,\n    initialize() {\n        console.log('[]  v3.5.6 ()');\n        // UI\n        createStatusPanel(); // UI\n        startCommentListener(); // HTML\n        const DS = window.detentionSystem;\n        if (DS && DS.events) {\n            DS.events.on('stateChanged', (data) => {\n                debugLog(':', data);\n                if (data && typeof data === 'object') {\n                    updateState(data);\n                }\n            });\n            DS.events.on('dayAdvanced', (data) => {\n                debugLog(':', data);\n                if (data && typeof data === 'object') {\n                    const d = data;\n                    if (d.days !== undefined)\n                        state.days = d.days;\n                    if (d.stage !== undefined)\n                        state.stage = d.stage;\n                    if (d.cellType !== undefined)\n                        state.cellType = d.cellType;\n                    updateDisplay();\n                }\n            });\n        }\n        console.log('[] ');\n        console.log('[] :', CONFIG.debugMode ? '' : '');\n    },\n    destroy() {\n        console.log('[] ...');\n        stopCommentListener();\n        stopUpdateLoop();\n        // UI\n        // \n        const DS = window.detentionSystem;\n        if (DS && DS.events) {\n            DS.events.off('stateChanged', () => { });\n            DS.events.off('dayAdvanced', () => { });\n        }\n        console.log('[] ');\n    },\n    getState() {\n        // \n        const memoryState = getStateFromMemoryEnhancement();\n        if (memoryState) {\n            debugLog('[] ');\n            return memoryState;\n        }\n        // \n        debugLog('[] ');\n        // #region agent log\n        //  CORS \n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            location: 'status_panel.ts:1262',\n            message: 'getStateclothing',\n            data: {\n              top: state.clothing.top || 'null',\n              bottom: state.clothing.bottom || 'null',\n              topLength: state.clothing.top?.length || 0,\n              bottomLength: state.clothing.bottom?.length || 0,\n              allClothing: JSON.stringify(state.clothing),\n            },\n            timestamp: Date.now(),\n            sessionId: 'debug-session',\n            runId: 'run1',\n            hypothesisId: 'E',\n          }),\n        }).catch(() => {}); */\n        // #endregion\n        const internalState = {\n            name: state.name,\n            age: state.age,\n            crime: state.crime,\n            health: state.health,\n            mental: state.mental,\n            strength: state.strength,\n            intelligence: state.intelligence,\n            appearance: { ...state.appearance },\n            clothing: { ...state.clothing },\n            currentTask: state.currentTask,\n            currentThought: state.currentThought,\n            biggestWorry: state.biggestWorry,\n            days: state.days,\n            stage: state.stage,\n            cellType: state.cellType,\n        };\n        return internalState;\n    },\n    modifyValue(key, delta, reason = '') {\n        if (state[key] === undefined) {\n            console.error(`[] : ${key}`);\n            return;\n        }\n        const oldValue = state[key];\n        const newValue = Math.max(0, Math.min(100, oldValue + delta));\n        if (newValue !== oldValue) {\n            state[key] = newValue;\n            recordChange(key, delta);\n            console.log(`[] ${key} : ${oldValue}  ${newValue} (${delta > 0 ? '+' : ''}${delta}) ${reason ? `: ${reason}` : ''}`);\n            const DS = window.detentionSystem;\n            if (DS && DS.events) {\n                DS.events.emit('valueChanged', {\n                    key,\n                    oldValue,\n                    newValue,\n                    delta,\n                    reason,\n                });\n            }\n            // \n            syncStateToMemoryEnhancement(StatusPanel.getState());\n            updateDisplay();\n        }\n    },\n    getTrendAnalysis() {\n        return {\n            health: {\n                value: state.health,\n                trend: calculateTrend('health'),\n                changes: state.changes.health || [],\n            },\n            mental: {\n                value: state.mental,\n                trend: calculateTrend('mental'),\n                changes: state.changes.mental || [],\n            },\n            strength: {\n                value: state.strength,\n                trend: calculateTrend('strength'),\n                changes: state.changes.strength || [],\n            },\n            intelligence: {\n                value: state.intelligence,\n                trend: calculateTrend('intelligence'),\n                changes: state.changes.intelligence || [],\n            },\n        };\n    },\n    getCurrentStage() {\n        return {\n            days: state.days,\n            stage: state.stage,\n            cellType: state.cellType,\n        };\n    },\n    parseStatusUpdate,\n    reset() {\n        state = {\n            name: '',\n            age: 0,\n            crime: '',\n            health: 75,\n            mental: 70,\n            strength: 65,\n            intelligence: 70,\n            appearance: {\n                height: 0,\n                weight: 0,\n                hair: '',\n                condition: '',\n            },\n            clothing: {\n                top: '',\n                bottom: '',\n                underwear: '',\n                underpants: '',\n                socks: '',\n                shoes: '',\n                restraints: '',\n                cleanliness: '',\n            },\n            currentTask: '',\n            currentThought: '',\n            biggestWorry: '',\n            days: 0,\n            stage: '',\n            cellType: '',\n            changes: {\n                health: [],\n                mental: [],\n                strength: [],\n                intelligence: [],\n            },\n            accumulated: {\n                health: 0,\n                mental: 0,\n                strength: 0,\n                intelligence: 0,\n            },\n            lastUpdate: Date.now(),\n            stats: {\n                totalUpdates: 0,\n                successfulParses: 0,\n                failedParses: 0,\n                lastParseTime: 0,\n            },\n        };\n        updateDisplay();\n        console.log('[] ');\n    },\n    exportData() {\n        return {\n            version: '3.5.6',\n            timestamp: Date.now(),\n            state: JSON.parse(JSON.stringify(state)),\n        };\n    },\n    importData(data) {\n        if (!data || !data.state) {\n            console.error('[] ');\n            return false;\n        }\n        try {\n            if (data.version && data.version !== '3.5.6') {\n                console.warn(`[] : ${data.version} vs 3.5.6`);\n            }\n            state = data.state;\n            if (!state.changes) {\n                state.changes = {\n                    health: [],\n                    mental: [],\n                    strength: [],\n                    intelligence: [],\n                };\n            }\n            if (!state.accumulated) {\n                state.accumulated = {\n                    health: 0,\n                    mental: 0,\n                    strength: 0,\n                    intelligence: 0,\n                };\n            }\n            if (!state.stats) {\n                state.stats = {\n                    totalUpdates: 0,\n                    successfulParses: 0,\n                    failedParses: 0,\n                    lastParseTime: 0,\n                };\n            }\n            state.lastUpdate = Date.now();\n            updateDisplay();\n            console.log('[] ');\n            return true;\n        }\n        catch (error) {\n            console.error('[] :', error);\n            return false;\n        }\n    },\n};\n// ==========  ==========\nfunction scanAllComments() {\n    console.log('[] ...');\n    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_COMMENT);\n    const comments = [];\n    let node;\n    while ((node = walker.nextNode())) {\n        const content = (node.nodeValue || node.textContent || '').trim();\n        comments.push({\n            content: content.substring(0, 100) + (content.length > 100 ? '...' : ''),\n            fullContent: content,\n            isStatusUpdate: content.startsWith('STATUS_UPDATE:'),\n            length: content.length,\n        });\n        if (content.startsWith('STATUS_UPDATE:')) {\n            console.log('[]  :', content.substring(0, 100));\n            parseCommentNode(node);\n        }\n    }\n    console.log(`[]  ${comments.length} `);\n    console.log('[] :', comments.filter(c => c.isStatusUpdate).length);\n    console.table(comments);\n    return comments;\n}\nfunction getDiagnostics() {\n    const diagnostics = {\n        version: '3.5.6',\n        timestamp: new Date().toLocaleString('zh-CN'),\n        observer: {\n            active: mutationObserver !== null,\n            status: mutationObserver ? '' : '',\n        },\n        state: {\n            lastUpdate: new Date(state.lastUpdate).toLocaleString('zh-CN'),\n            timeSinceUpdate: Date.now() - state.lastUpdate,\n            timeSinceUpdateFormatted: formatDuration(Date.now() - state.lastUpdate),\n        },\n        stats: {\n            totalUpdates: state.stats.totalUpdates,\n            successfulParses: state.stats.successfulParses,\n            failedParses: state.stats.failedParses,\n            successRate: state.stats.totalUpdates > 0\n                ? `${((state.stats.successfulParses / state.stats.totalUpdates) * 100).toFixed(2)}%`\n                : 'N/A',\n            lastParseTime: state.stats.lastParseTime > 0 ? new Date(state.stats.lastParseTime).toLocaleString('zh-CN') : '',\n        },\n        currentState: StatusPanel.getState(),\n        config: CONFIG,\n    };\n    console.log('[] ');\n    console.log('[] :', diagnostics.version);\n    console.log('[] :', diagnostics.timestamp);\n    console.log('[] :', diagnostics.observer.status);\n    console.log('[] :', diagnostics.state.lastUpdate);\n    console.log('[] :', diagnostics.state.timeSinceUpdateFormatted);\n    console.log('[] :', diagnostics.stats);\n    console.log('[] :', diagnostics.currentState);\n    return diagnostics;\n}\n//  StatusPanel \nStatusPanel.debug = {\n    scanAllComments,\n    getDiagnostics,\n    parseCommentNode,\n    checkForStatusUpdate,\n};\n// ==========  ==========\n$(() => {\n    console.info('[]  v3.5.6 ()');\n    const DS = window.detentionSystem;\n    if (!DS) {\n        console.error('[] ');\n        return;\n    }\n    // \n    DS.getState = () => StatusPanel.getState();\n    DS.modifyValue = (key, delta, reason) => StatusPanel.modifyValue(key, delta, reason);\n    DS.getTrendAnalysis = () => StatusPanel.getTrendAnalysis();\n    DS.getCurrentStage = () => StatusPanel.getCurrentStage();\n    DS.parseStatusUpdate = (jsonStr) => StatusPanel.parseStatusUpdate(jsonStr);\n    // \n    DS.registerModule('statusPanel', StatusPanel);\n    //  window \n    window.detentionSystem.statusPanel = StatusPanel;\n    // iframe \n    try {\n        if (window.parent && window.parent !== window) {\n            window.parent.detentionSystem = DS;\n            console.info('[]  ');\n        }\n    }\n    catch (e) {\n        // \n    }\n    // \n    DS.events.on('initialized', () => {\n        console.info('[] ');\n        setTimeout(() => {\n            try {\n                StatusPanel.initialize();\n                console.info('[]  ');\n            }\n            catch (error) {\n                console.error('[]  :', error);\n            }\n        }, 500);\n    });\n    // \n    if (DS.initialized) {\n        setTimeout(() => {\n            try {\n                StatusPanel.initialize();\n                console.info('[]  ');\n            }\n            catch (error) {\n                console.error('[]  :', error);\n            }\n        }, 500);\n    }\n    console.info('[]  v3.5.6 ()');\n});\n// \n$(window).on('pagehide', () => {\n    console.log('[] ...');\n    stopCommentListener();\n    stopUpdateLoop();\n});\nexport {};\n","export {};\r\n\r\ntype JQueryStaticLike = typeof globalThis extends { $: infer T } ? T : (selector: any) => any;\r\ndeclare const $: JQueryStaticLike;\r\n\r\n/**\r\n * \r\n *  API name\r\n */\r\n\r\ninterface WorldbookConfig {\r\n  name: string; // \r\n  displayName: string; // \r\n  priority: number; // \r\n  keywords: string[]; // \r\n  autoLoad: boolean; // \r\n  description?: string; // \r\n  position?: 'before_char' | 'after_char'; // \r\n  depth?: number; // \r\n  fallbackEntries?: unknown[]; // \r\n}\r\n\r\ninterface LoadedWorldbook {\r\n  name: string;\r\n  displayName: string;\r\n  entries: unknown[];\r\n  fallback: boolean;\r\n  error?: string;\r\n  loadedAt: number;\r\n}\r\n\r\ninterface WorldbookStatus {\r\n  initialized: boolean;\r\n  fallbackMode: boolean;\r\n  characterWorldbook: string | null;\r\n  loaded: Array<{\r\n    name: string;\r\n    displayName: string;\r\n    entries: number;\r\n    fallback: boolean;\r\n    error?: string;\r\n    loadedAt: string;\r\n  }>;\r\n  loading: Array<{\r\n    name: string;\r\n    displayName: string;\r\n  }>;\r\n  available: Array<{\r\n    name: string;\r\n    displayName: string;\r\n    autoLoad: boolean;\r\n  }>;\r\n}\r\n\r\ninterface EventBus {\r\n  on(event: string, callback: (data?: unknown) => void): void;\r\n  emit(event: string, data?: unknown): void;\r\n}\r\n\r\ninterface DetentionSystem {\r\n  version: string;\r\n  initialized: boolean;\r\n  modules: Record<string, unknown>;\r\n  config: Record<string, unknown>;\r\n  state: Record<string, unknown>;\r\n  events: EventBus;\r\n  CacheManager: unknown;\r\n  EventEmitter: unknown;\r\n  ping(): boolean;\r\n  registerModule(name: string, module: unknown): void;\r\n  getModule<T = unknown>(name: string): T | undefined;\r\n  handleError(error: unknown, context?: string): void;\r\n}\r\n\r\n// \r\nconst WORLDBOOKS: Record<string, WorldbookConfig> = {\r\n  detention_rules: {\r\n    name: 'detention_rules',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 10,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: true,\r\n    position: 'before_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  internal_basic_procedures: {\r\n    name: 'internal_basic_procedures',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 9,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'after_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  internal_basic_legal: {\r\n    name: 'internal_basic_legal',\r\n    displayName: '',\r\n    description:\r\n      '//',\r\n    priority: 8,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'before_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  legal_knowledge: {\r\n    name: 'legal_knowledge',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 7,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'after_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  environment_descriptions: {\r\n    name: 'environment_descriptions',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 6,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'before_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n  narrative_enhancements: {\r\n    name: 'narrative_enhancements',\r\n    displayName: '',\r\n    description: '',\r\n    priority: 5,\r\n    keywords: [\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n      '',\r\n    ],\r\n    autoLoad: false,\r\n    position: 'after_char',\r\n    depth: 4,\r\n    fallbackEntries: [],\r\n  },\r\n};\r\n\r\ninterface WorldbookLoaderImpl {\r\n  loaded: Map<string, LoadedWorldbook>;\r\n  loading: Map<string, Promise<LoadedWorldbook>>;\r\n  initialized: boolean;\r\n  fallbackMode: boolean;\r\n  characterWorldbookId: string | null;\r\n  failedBooks?: Set<string>; // \r\n\r\n  findCharacterWorldbook(): Promise<string | null>;\r\n  loadWorldbook(bookName: string): Promise<LoadedWorldbook>;\r\n  _loadWorldbookInternal(bookName: string, config: WorldbookConfig): Promise<LoadedWorldbook>;\r\n  predictiveCache(context: string): Promise<void>;\r\n  getRelevantEntries(context: string, maxEntries?: number): unknown[];\r\n  dynamicLoad(userInput: string): Promise<void>;\r\n  getStatus(): WorldbookStatus;\r\n  unloadWorldbook(bookName: string): Promise<void>;\r\n  reloadWorldbook(bookName: string): Promise<LoadedWorldbook>;\r\n  initialize(): Promise<void>;\r\n  shutdown(): void;\r\n}\r\n\r\nconsole.info('[] v5.1.0 ...');\r\n\r\n/**\r\n * \r\n */\r\nfunction safeGetWorldbookNames(): string[] {\r\n  // #region agent log\r\n  fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({\r\n      location: 'worldbook_loader.ts:safeGetWorldbookNames',\r\n      message: '',\r\n      data: {\r\n        hasGlobalFn: typeof (window as any).getWorldbookNames !== 'undefined',\r\n        hasTavernHelper: typeof window !== 'undefined' && !!(window as any).TavernHelper,\r\n        hasTavernHelperFn:\r\n          typeof window !== 'undefined' &&\r\n          !!(window as any).TavernHelper &&\r\n          typeof (window as any).TavernHelper.getWorldbookNames === 'function',\r\n      },\r\n      timestamp: Date.now(),\r\n      sessionId: 'debug-session',\r\n      runId: 'initial',\r\n      hypothesisId: 'A',\r\n    }),\r\n  }).catch(() => {});\r\n  // #endregion\r\n\r\n  // A: \r\n  if (typeof (window as any).getWorldbookNames !== 'undefined') {\r\n    // #region agent log\r\n    //  CORS \r\n    /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        location: 'worldbook_loader.ts:safeGetWorldbookNames',\r\n        message: '',\r\n        data: {},\r\n        timestamp: Date.now(),\r\n        sessionId: 'debug-session',\r\n        runId: 'initial',\r\n        hypothesisId: 'A',\r\n      }),\r\n    }).catch(() => {}); */\r\n    // #endregion\r\n    return (window as any).getWorldbookNames();\r\n  }\r\n\r\n  // B:  window.TavernHelper \r\n  if (typeof window !== 'undefined' && (window as any).TavernHelper) {\r\n    const helper = (window as any).TavernHelper;\r\n    if (typeof helper.getWorldbookNames === 'function') {\r\n      // #region agent log\r\n      //  CORS \r\n      /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          location: 'worldbook_loader.ts:safeGetWorldbookNames',\r\n          message: 'TavernHelper',\r\n          data: {},\r\n          timestamp: Date.now(),\r\n          sessionId: 'debug-session',\r\n          runId: 'initial',\r\n          hypothesisId: 'B',\r\n        }),\r\n      }).catch(() => {}); */\r\n      // #endregion\r\n      return helper.getWorldbookNames();\r\n    }\r\n  }\r\n\r\n  // #region agent log\r\n  //  CORS \r\n  /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({\r\n      location: 'worldbook_loader.ts:safeGetWorldbookNames',\r\n      message: '',\r\n      data: {\r\n        windowType: typeof window,\r\n        tavernHelperType: typeof window !== 'undefined' ? typeof (window as any).TavernHelper : 'N/A',\r\n      },\r\n      timestamp: Date.now(),\r\n      sessionId: 'debug-session',\r\n      runId: 'initial',\r\n      hypothesisId: 'C',\r\n    }),\r\n  }).catch(() => {}); */\r\n  // #endregion\r\n\r\n  throw new Error(\r\n    'getWorldbookNames ' +\r\n      ' Tavern Helper ' +\r\n      ' getWorldbookNames  window.TavernHelper ',\r\n  );\r\n}\r\n\r\n//  jQuery ready \r\n$(() => {\r\n  const DS_RAW = window.detentionSystem as DetentionSystem | undefined;\r\n  if (!DS_RAW) {\r\n    console.error('[] ');\r\n    console.error('[]  core.ts ');\r\n    return;\r\n  }\r\n\r\n  // DS \r\n  const DS = DS_RAW as DetentionSystem;\r\n\r\n  // \r\n  (DS as DetentionSystem & { characterId?: string }).characterId = 'detention_center';\r\n  console.info('[]  ');\r\n\r\n  // ==========  ==========\r\n  const WorldbookLoader: WorldbookLoaderImpl = {\r\n    loaded: new Map(),\r\n    loading: new Map(),\r\n    initialized: false,\r\n    fallbackMode: false,\r\n    characterWorldbookId: null,\r\n    // \r\n    failedBooks: new Set<string>(),\r\n\r\n    /**\r\n     * \r\n     */\r\n    async findCharacterWorldbook(): Promise<string | null> {\r\n      console.info('[] ...');\r\n\r\n      try {\r\n        const charWorldbooks = getCharWorldbookNames('current');\r\n        if (charWorldbooks.primary) {\r\n          console.info(`[]  : ${charWorldbooks.primary}`);\r\n          this.characterWorldbookId = charWorldbooks.primary;\r\n          return charWorldbooks.primary;\r\n        }\r\n\r\n        if (charWorldbooks.additional.length > 0) {\r\n          console.info(`[]  : ${charWorldbooks.additional[0]}`);\r\n          this.characterWorldbookId = charWorldbooks.additional[0];\r\n          return charWorldbooks.additional[0];\r\n        }\r\n\r\n        console.warn('[]  ');\r\n        return null;\r\n      } catch (error) {\r\n        console.error('[] :', error);\r\n        return null;\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async loadWorldbook(bookName: string): Promise<LoadedWorldbook> {\r\n      const config = WORLDBOOKS[bookName];\r\n      if (!config) {\r\n        throw new Error(`: ${bookName}`);\r\n      }\r\n\r\n      // \r\n      if (this.failedBooks?.has(bookName)) {\r\n        console.warn(`[]  ${config.displayName} `);\r\n        throw new Error(` \"${bookName}\" `);\r\n      }\r\n\r\n      // \r\n      if (this.loaded.has(bookName)) {\r\n        console.info(`[] ${config.displayName} `);\r\n        return this.loaded.get(bookName)!;\r\n      }\r\n\r\n      // \r\n      if (this.loading.has(bookName)) {\r\n        console.info(`[] ${config.displayName} ...`);\r\n        return await this.loading.get(bookName)!;\r\n      }\r\n\r\n      //  Promise\r\n      const loadPromise = this._loadWorldbookInternal(bookName, config);\r\n      this.loading.set(bookName, loadPromise);\r\n\r\n      try {\r\n        const result = await loadPromise;\r\n        this.loaded.set(bookName, result);\r\n        // \r\n        if (this.failedBooks?.has(bookName)) {\r\n          this.failedBooks.delete(bookName);\r\n          console.info(`[]  ${config.displayName} `);\r\n        }\r\n        return result;\r\n      } catch (error) {\r\n        //  _loadWorldbookInternal \r\n        throw error;\r\n      } finally {\r\n        this.loading.delete(bookName);\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async _loadWorldbookInternal(bookName: string, config: WorldbookConfig): Promise<LoadedWorldbook> {\r\n      console.info(`[] : ${config.displayName} (${bookName})`);\r\n\r\n      try {\r\n        // \r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n            message: 'safeGetWorldbookNames',\r\n            data: { bookName, displayName: config.displayName },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'initial',\r\n            hypothesisId: 'A',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n        const allWorldbookNames = safeGetWorldbookNames();\r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n            message: 'safeGetWorldbookNames',\r\n            data: { count: allWorldbookNames.length, names: allWorldbookNames.slice(0, 5) },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'initial',\r\n            hypothesisId: 'A',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        // displayName\r\n        let targetWorldbookName: string | null = null;\r\n\r\n        // 1.  displayName- \r\n        const exactDisplayMatch = allWorldbookNames.find(name => name === config.displayName);\r\n        if (exactDisplayMatch) {\r\n          targetWorldbookName = exactDisplayMatch;\r\n          console.info(`[]  : \"${config.displayName}\"`);\r\n        } else if (allWorldbookNames.includes(config.name)) {\r\n          // 2.  name\r\n          targetWorldbookName = config.name;\r\n          console.info(`[]  : \"${config.name}\"`);\r\n        } else {\r\n          // 3.  displayName  name\r\n          const fuzzyMatch = allWorldbookNames.find(\r\n            name =>\r\n              name.includes(config.displayName) ||\r\n              config.displayName.includes(name) ||\r\n              name.includes(config.name) ||\r\n              config.name.includes(name),\r\n          );\r\n          if (fuzzyMatch) {\r\n            targetWorldbookName = fuzzyMatch;\r\n            console.info(`[]  : \"${fuzzyMatch}\"`);\r\n          }\r\n        }\r\n\r\n        if (!targetWorldbookName) {\r\n          const availableBooks = allWorldbookNames.join(', ');\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n              message: '',\r\n              data: {\r\n                bookName,\r\n                displayName: config.displayName,\r\n                availableBooks: allWorldbookNames,\r\n                searchingFor: config.name,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-getworldbook',\r\n              hypothesisId: 'E',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          throw new Error(\r\n            `: ${config.displayName} (${bookName})\\n` +\r\n              `: ${availableBooks}\\n` +\r\n              `:  displayName  name `,\r\n          );\r\n        }\r\n\r\n        // \r\n        // #region agent log\r\n        //  CORS \r\n        /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n            message: 'getWorldbook',\r\n            data: {\r\n              targetWorldbookName,\r\n              bookName,\r\n              displayName: config.displayName,\r\n              allAvailableBooks: allWorldbookNames,\r\n            },\r\n            timestamp: Date.now(),\r\n            sessionId: 'debug-session',\r\n            runId: 'fix-getworldbook',\r\n            hypothesisId: 'A',\r\n          }),\r\n        }).catch(() => {}); */\r\n        // #endregion\r\n\r\n        let entries;\r\n        let worldbookData: unknown;\r\n        try {\r\n          worldbookData = await getWorldbook(targetWorldbookName);\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n              message: 'getWorldbook - ',\r\n              data: {\r\n                worldbookDataType: typeof worldbookData,\r\n                worldbookDataIsArray: Array.isArray(worldbookData),\r\n                worldbookDataIsObject: worldbookData && typeof worldbookData === 'object',\r\n                worldbookDataKeys:\r\n                  worldbookData && typeof worldbookData === 'object' ? Object.keys(worldbookData as object) : null,\r\n                worldbookDataHasEntriesProperty:\r\n                  worldbookData &&\r\n                  typeof worldbookData === 'object' &&\r\n                  !Array.isArray(worldbookData) &&\r\n                  'entries' in (worldbookData as object),\r\n                worldbookDataEntriesType:\r\n                  worldbookData &&\r\n                  typeof worldbookData === 'object' &&\r\n                  !Array.isArray(worldbookData) &&\r\n                  'entries' in (worldbookData as object)\r\n                    ? typeof (worldbookData as { entries?: unknown }).entries\r\n                    : null,\r\n                worldbookDataEntriesIsArray:\r\n                  worldbookData &&\r\n                  typeof worldbookData === 'object' &&\r\n                  !Array.isArray(worldbookData) &&\r\n                  'entries' in (worldbookData as object)\r\n                    ? Array.isArray((worldbookData as { entries?: unknown }).entries)\r\n                    : null,\r\n                targetWorldbookName,\r\n                bookName,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-entries-undefined',\r\n              hypothesisId: 'A',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          // getWorldbook  entries \r\n          //   entries Array.prototype.entries \r\n          if (Array.isArray(worldbookData)) {\r\n            // getWorldbook \r\n            entries = worldbookData;\r\n          } else if (\r\n            worldbookData &&\r\n            typeof worldbookData === 'object' &&\r\n            !Array.isArray(worldbookData) &&\r\n            'entries' in worldbookData &&\r\n            Array.isArray((worldbookData as { entries?: unknown }).entries)\r\n          ) {\r\n            // getWorldbook  entries \r\n            entries = (worldbookData as { entries: unknown[] }).entries;\r\n          } else {\r\n            // \r\n            entries = Array.isArray(worldbookData) ? worldbookData : [];\r\n          }\r\n\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n              message: 'getWorldbook - ',\r\n              data: {\r\n                entriesType: typeof entries,\r\n                entriesIsArray: Array.isArray(entries),\r\n                entriesLength: entries?.length,\r\n                entriesIsUndefined: entries === undefined,\r\n                entriesIsNull: entries === null,\r\n                entriesValue:\r\n                  entries === undefined || entries === null\r\n                    ? null\r\n                    : Array.isArray(entries)\r\n                      ? `Array(${entries.length})`\r\n                      : String(entries),\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-entries-undefined',\r\n              hypothesisId: 'B',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n        } catch (getWorldbookError) {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n              message: 'getWorldbook',\r\n              data: {\r\n                error: getWorldbookError instanceof Error ? getWorldbookError.message : String(getWorldbookError),\r\n                errorStack: getWorldbookError instanceof Error ? getWorldbookError.stack : undefined,\r\n                targetWorldbookName,\r\n                bookName,\r\n                displayName: config.displayName,\r\n                allAvailableBooks: allWorldbookNames,\r\n                errorType: typeof getWorldbookError,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-getworldbook',\r\n              hypothesisId: 'B',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n\r\n          // \r\n          const errorMessage =\r\n            getWorldbookError instanceof Error ? getWorldbookError.message : String(getWorldbookError);\r\n          console.warn(\r\n            `[]  ${config.displayName}  (: ${targetWorldbookName}):`,\r\n            errorMessage,\r\n          );\r\n\r\n          //  map \r\n          const isDataFormatError =\r\n            errorMessage.includes('map') ||\r\n            errorMessage.includes('undefined') ||\r\n            errorMessage.includes('Cannot read properties');\r\n\r\n          if (isDataFormatError) {\r\n            console.warn(\r\n              `[]   \"${targetWorldbookName}\" `,\r\n            );\r\n            console.warn(`[]  : ${errorMessage}`);\r\n            console.warn(\r\n              `[]  : 1)  \"${targetWorldbookName}\"  2)  3) `,\r\n            );\r\n\r\n            // \r\n            if (this.failedBooks) {\r\n              this.failedBooks.add(bookName);\r\n              console.warn(`[]   \"${bookName}\" `);\r\n              // #region agent log\r\n              //  CORS \r\n              /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                  location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n                  message: '',\r\n                  data: {\r\n                    bookName,\r\n                    displayName: config.displayName,\r\n                    targetWorldbookName,\r\n                    errorMessage,\r\n                    isDataFormatError,\r\n                    failedBooksSize: this.failedBooks.size,\r\n                    failedBooksArray: Array.from(this.failedBooks),\r\n                  },\r\n                  timestamp: Date.now(),\r\n                  sessionId: 'debug-session',\r\n                  runId: 'fix-getworldbook',\r\n                  hypothesisId: 'E',\r\n                }),\r\n              }).catch(() => {}); */\r\n              // #endregion\r\n            }\r\n          }\r\n\r\n          // \r\n          const detailedError = new Error(\r\n            `: ${errorMessage}\\n` +\r\n              `: ${targetWorldbookName}\\n` +\r\n              `: ${bookName} (${config.displayName})\\n` +\r\n              `: ${isDataFormatError ? '' : ''}\\n` +\r\n              `: ${isDataFormatError ? '' : ''}`,\r\n          );\r\n          throw detailedError;\r\n        }\r\n\r\n        // \r\n        if (entries === undefined || entries === null) {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n              message: 'entriesnullundefined',\r\n              data: {\r\n                entriesType: typeof entries,\r\n                entriesValue: entries,\r\n                worldbookDataType: typeof worldbookData,\r\n                worldbookDataValue: worldbookData,\r\n                targetWorldbookName,\r\n                bookName,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-entries-undefined',\r\n              hypothesisId: 'C',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          throw new Error(\r\n            ` \"${targetWorldbookName}\"  (undefined/null)\\n` +\r\n              `: ${typeof worldbookData}\\n` +\r\n              `:  entries `,\r\n          );\r\n        }\r\n\r\n        if (!Array.isArray(entries)) {\r\n          // #region agent log\r\n          //  CORS \r\n          /* fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              location: 'worldbook_loader.ts:_loadWorldbookInternal',\r\n              message: 'entries',\r\n              data: {\r\n                entriesType: typeof entries,\r\n                entriesConstructor:\r\n                  entries && typeof entries === 'object' && 'constructor' in entries\r\n                    ? (entries as any).constructor?.name\r\n                    : undefined,\r\n                entriesValue: entries,\r\n                worldbookDataType: typeof worldbookData,\r\n                worldbookDataKeys:\r\n                  worldbookData && typeof worldbookData === 'object' ? Object.keys(worldbookData as object) : null,\r\n                targetWorldbookName,\r\n                bookName,\r\n              },\r\n              timestamp: Date.now(),\r\n              sessionId: 'debug-session',\r\n              runId: 'fix-entries-undefined',\r\n              hypothesisId: 'D',\r\n            }),\r\n          }).catch(() => {}); */\r\n          // #endregion\r\n          throw new Error(\r\n            ` \"${targetWorldbookName}\"  (: ${typeof entries})\\n` +\r\n              `: ${typeof worldbookData}\\n` +\r\n              `: getWorldbook  entries  entries `,\r\n          );\r\n        }\r\n\r\n        if (entries.length === 0) {\r\n          throw new Error('');\r\n        }\r\n\r\n        // \r\n        const charWorldbooks = getCharWorldbookNames('current');\r\n        if (!charWorldbooks.additional.includes(targetWorldbookName)) {\r\n          await rebindCharWorldbooks('current', {\r\n            primary: charWorldbooks.primary,\r\n            additional: [...charWorldbooks.additional, targetWorldbookName],\r\n          });\r\n          console.info(`[]  : ${targetWorldbookName}`);\r\n        }\r\n\r\n        console.info(`[]  ${config.displayName}  (${entries.length} )`);\r\n\r\n        return {\r\n          name: bookName,\r\n          displayName: config.displayName,\r\n          entries: entries,\r\n          fallback: false,\r\n          loadedAt: Date.now(),\r\n        };\r\n      } catch (error) {\r\n        const errorMessage = error instanceof Error ? error.message : String(error);\r\n        console.warn(`[]  ${config.displayName} :`, errorMessage);\r\n\r\n        // \r\n        if (config.fallbackEntries && config.fallbackEntries.length > 0) {\r\n          console.info(`[]  ${config.displayName}  (${config.fallbackEntries.length} )`);\r\n          this.fallbackMode = true;\r\n\r\n          return {\r\n            name: bookName,\r\n            displayName: config.displayName,\r\n            entries: config.fallbackEntries,\r\n            fallback: true,\r\n            error: errorMessage,\r\n            loadedAt: Date.now(),\r\n          };\r\n        }\r\n\r\n        throw error;\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async predictiveCache(context: string): Promise<void> {\r\n      if (!context || typeof context !== 'string') {\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      const predictions: Array<{ bookName: string; score: number; priority: number; weightedScore: number }> = [];\r\n\r\n      for (const bookName in WORLDBOOKS) {\r\n        const config = WORLDBOOKS[bookName];\r\n\r\n        if (this.loaded.has(bookName)) {\r\n          continue;\r\n        }\r\n\r\n        let matchScore = 0;\r\n        let weightedScore = 0;\r\n\r\n        // \r\n        for (const keyword of config.keywords) {\r\n          if (context.includes(keyword)) {\r\n            matchScore++;\r\n            // \r\n            const keywordWeight = keyword.length >= 3 ? 2 : 1;\r\n            weightedScore += keywordWeight;\r\n\r\n            // \r\n            if (config.description && config.description.includes(keyword)) {\r\n              weightedScore += 1;\r\n            }\r\n          }\r\n        }\r\n\r\n        // \r\n        if (config.description) {\r\n          const descKeywords = config.description.match(/[\\u4e00-\\u9fa5]{2,}/g) || [];\r\n          for (const descKw of descKeywords) {\r\n            if (context.includes(descKw) && descKw.length >= 2) {\r\n              weightedScore += 0.5;\r\n            }\r\n          }\r\n        }\r\n\r\n        if (matchScore > 0) {\r\n          //  =  * 10 + \r\n          const finalScore = config.priority * 10 + weightedScore;\r\n\r\n          predictions.push({\r\n            bookName,\r\n            score: matchScore,\r\n            priority: config.priority,\r\n            weightedScore: finalScore,\r\n          });\r\n        }\r\n      }\r\n\r\n      // \r\n      predictions.sort((a, b) => {\r\n        if (Math.abs(b.weightedScore - a.weightedScore) > 1) {\r\n          return b.weightedScore - a.weightedScore;\r\n        }\r\n        if (b.priority !== a.priority) {\r\n          return b.priority - a.priority;\r\n        }\r\n        return b.score - a.score;\r\n      });\r\n\r\n      console.info(`[]  ${predictions.length} `);\r\n\r\n      // 1>10\r\n      const toLoad = predictions.filter(p => p.weightedScore > 10).slice(0, 3);\r\n\r\n      if (toLoad.length === 0) {\r\n        console.info('[] ');\r\n        return;\r\n      }\r\n\r\n      for (const pred of toLoad) {\r\n        // \r\n        if (this.failedBooks?.has(pred.bookName)) {\r\n          console.debug(`[] : ${WORLDBOOKS[pred.bookName].displayName}`);\r\n          continue;\r\n        }\r\n\r\n        console.info(\r\n          `[] : ${WORLDBOOKS[pred.bookName].displayName} ` +\r\n            `(: ${pred.score}, : ${pred.weightedScore.toFixed(1)})`,\r\n        );\r\n\r\n        try {\r\n          await this.loadWorldbook(pred.bookName);\r\n        } catch (error) {\r\n          const errorMessage = error instanceof Error ? error.message : String(error);\r\n          console.warn(`[] : ${pred.bookName}`, errorMessage);\r\n          //  loadWorldbook \r\n        }\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    getRelevantEntries(context: string, maxEntries: number = 5): unknown[] {\r\n      if (!context || typeof context !== 'string') {\r\n        return [];\r\n      }\r\n\r\n      const allEntries: Array<{ entry: unknown; bookName: string; bookDisplayName: string; priority: number }> = [];\r\n\r\n      this.loaded.forEach((bookData, bookName) => {\r\n        if (bookData.entries && Array.isArray(bookData.entries)) {\r\n          for (const entry of bookData.entries) {\r\n            allEntries.push({\r\n              entry,\r\n              bookName: bookName,\r\n              bookDisplayName: bookData.displayName,\r\n              priority: WORLDBOOKS[bookName]?.priority || 0,\r\n            });\r\n          }\r\n        }\r\n      });\r\n\r\n      const scoredEntries = allEntries.map(item => {\r\n        let score = 0;\r\n        const entry = item.entry as {\r\n          keys?: string[];\r\n          key?: string[];\r\n          constant?: boolean;\r\n          name?: string;\r\n          content?: string;\r\n        };\r\n        const keys = entry.keys || entry.key || [];\r\n\r\n        // \r\n        for (const key of keys) {\r\n          if (context.includes(key)) {\r\n            const keyWeight = key.length >= 3 ? 15 : 10;\r\n            score += keyWeight;\r\n\r\n            // \r\n            if (entry.name && entry.name.includes(key)) {\r\n              score += 5;\r\n            }\r\n          }\r\n        }\r\n\r\n        // \r\n        if (entry.name && context.includes(entry.name)) {\r\n          score += 20;\r\n        }\r\n\r\n        // \r\n        if (entry.content) {\r\n          const contentMatch = entry.content.substring(0, 100);\r\n          if (context.includes(contentMatch.substring(0, 10))) {\r\n            score += 3;\r\n          }\r\n        }\r\n\r\n        // \r\n        score += item.priority || 0;\r\n\r\n        // \r\n        if (entry.constant) {\r\n          score += 30;\r\n        }\r\n\r\n        return {\r\n          entry: item.entry,\r\n          score,\r\n          bookName: item.bookName,\r\n          bookDisplayName: item.bookDisplayName,\r\n        };\r\n      });\r\n\r\n      // \r\n      scoredEntries.sort((a, b) => {\r\n        if (Math.abs(b.score - a.score) > 5) {\r\n          return b.score - a.score;\r\n        }\r\n        // \r\n        const aPriority = WORLDBOOKS[a.bookName]?.priority || 0;\r\n        const bPriority = WORLDBOOKS[b.bookName]?.priority || 0;\r\n        return bPriority - aPriority;\r\n      });\r\n\r\n      const relevant = scoredEntries\r\n        .filter(item => item.score > 0)\r\n        .slice(0, maxEntries)\r\n        .map(item => item.entry);\r\n\r\n      if (relevant.length > 0) {\r\n        console.info(\r\n          `[]  ${relevant.length}  ` +\r\n            `(: ${scoredEntries[0]?.score || 0}, : ${scoredEntries[0]?.bookDisplayName || ''})`,\r\n        );\r\n      }\r\n\r\n      return relevant;\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async dynamicLoad(userInput: string): Promise<void> {\r\n      if (!userInput || typeof userInput !== 'string' || userInput.length < 3) {\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      const triggers: Array<{\r\n        bookName: string;\r\n        keyword: string;\r\n        priority: number;\r\n        matchCount: number;\r\n        score: number;\r\n      }> = [];\r\n\r\n      for (const bookName in WORLDBOOKS) {\r\n        const config = WORLDBOOKS[bookName];\r\n\r\n        if (this.loaded.has(bookName)) {\r\n          continue;\r\n        }\r\n\r\n        let matchCount = 0;\r\n        let bestKeyword = '';\r\n        let maxKeywordLength = 0;\r\n\r\n        // \r\n        for (const keyword of config.keywords) {\r\n          if (userInput.includes(keyword)) {\r\n            matchCount++;\r\n            if (keyword.length > maxKeywordLength) {\r\n              maxKeywordLength = keyword.length;\r\n              bestKeyword = keyword;\r\n            }\r\n          }\r\n        }\r\n\r\n        // \r\n        if (matchCount > 0) {\r\n          //  =  * 10 +  * 2 + \r\n          const score = config.priority * 10 + matchCount * 2 + maxKeywordLength;\r\n\r\n          triggers.push({\r\n            bookName,\r\n            keyword: bestKeyword,\r\n            priority: config.priority,\r\n            matchCount,\r\n            score,\r\n          });\r\n        }\r\n      }\r\n\r\n      if (triggers.length === 0) {\r\n        console.info('[] ');\r\n        return;\r\n      }\r\n\r\n      // \r\n      triggers.sort((a, b) => {\r\n        if (Math.abs(b.score - a.score) > 2) {\r\n          return b.score - a.score;\r\n        }\r\n        return b.priority - a.priority;\r\n      });\r\n\r\n      console.info(`[]  ${triggers.length} `);\r\n\r\n      // 3\r\n      const toLoad = triggers.slice(0, 3);\r\n\r\n      for (const trigger of toLoad) {\r\n        console.info(\r\n          `[] : ${WORLDBOOKS[trigger.bookName].displayName} ` +\r\n            `(: ${trigger.keyword}, : ${trigger.matchCount}, : ${trigger.score})`,\r\n        );\r\n\r\n        try {\r\n          await this.loadWorldbook(trigger.bookName);\r\n        } catch (error) {\r\n          console.warn(`[] : ${trigger.bookName}`, error);\r\n        }\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    getStatus(): WorldbookStatus {\r\n      const status: WorldbookStatus = {\r\n        initialized: this.initialized,\r\n        fallbackMode: this.fallbackMode,\r\n        characterWorldbook: this.characterWorldbookId,\r\n        loaded: [],\r\n        loading: [],\r\n        available: [],\r\n      };\r\n\r\n      this.loaded.forEach((data, name) => {\r\n        status.loaded.push({\r\n          name: name,\r\n          displayName: data.displayName,\r\n          entries: data.entries.length,\r\n          fallback: data.fallback,\r\n          error: data.error,\r\n          loadedAt: new Date(data.loadedAt).toLocaleTimeString(),\r\n        });\r\n      });\r\n\r\n      this.loading.forEach((_promise, name) => {\r\n        status.loading.push({\r\n          name: name,\r\n          displayName: WORLDBOOKS[name]?.displayName || name,\r\n        });\r\n      });\r\n\r\n      for (const bookName in WORLDBOOKS) {\r\n        if (!this.loaded.has(bookName) && !this.loading.has(bookName)) {\r\n          status.available.push({\r\n            name: bookName,\r\n            displayName: WORLDBOOKS[bookName].displayName,\r\n            autoLoad: WORLDBOOKS[bookName].autoLoad,\r\n          });\r\n        }\r\n      }\r\n\r\n      return status;\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async unloadWorldbook(bookName: string): Promise<void> {\r\n      if (!this.loaded.has(bookName)) {\r\n        console.warn(`[] ${bookName} `);\r\n        return;\r\n      }\r\n\r\n      console.info(`[] : ${WORLDBOOKS[bookName]?.displayName || bookName}`);\r\n\r\n      // \r\n      const charWorldbooks = getCharWorldbookNames('current');\r\n      const loadedData = this.loaded.get(bookName);\r\n      if (loadedData) {\r\n        // \r\n        const allWorldbookNames = safeGetWorldbookNames();\r\n        const targetName = allWorldbookNames.find(name => name === bookName || name.includes(bookName));\r\n\r\n        if (targetName) {\r\n          const newAdditional = charWorldbooks.additional.filter(name => name !== targetName);\r\n          await rebindCharWorldbooks('current', {\r\n            primary: charWorldbooks.primary,\r\n            additional: newAdditional,\r\n          });\r\n        }\r\n      }\r\n\r\n      this.loaded.delete(bookName);\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async reloadWorldbook(bookName: string): Promise<LoadedWorldbook> {\r\n      console.info(`[] : ${WORLDBOOKS[bookName]?.displayName || bookName}`);\r\n      await this.unloadWorldbook(bookName);\r\n      return await this.loadWorldbook(bookName);\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    async initialize(): Promise<void> {\r\n      if (this.initialized) {\r\n        console.info('[] ');\r\n        return;\r\n      }\r\n\r\n      console.info('[] ...');\r\n\r\n      await this.findCharacterWorldbook();\r\n\r\n      // \r\n      let retries = 0;\r\n      let availableWorldbooks: string[] = [];\r\n      while (retries < 40) {\r\n        try {\r\n          availableWorldbooks = safeGetWorldbookNames();\r\n          if (availableWorldbooks.length > 0) {\r\n            console.info(`[]   (${availableWorldbooks.length} )`);\r\n            console.info(`[] : ${availableWorldbooks.join(', ')}`);\r\n            break;\r\n          }\r\n        } catch (error) {\r\n          // \r\n        }\r\n\r\n        console.info(`[] ... (${retries + 1}/40)`);\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n        retries++;\r\n      }\r\n\r\n      // \r\n      console.info('[] :');\r\n      for (const bookName in WORLDBOOKS) {\r\n        const config = WORLDBOOKS[bookName];\r\n        const isAvailable = availableWorldbooks.some(\r\n          name => name === config.displayName || name === config.name || name.includes(config.displayName),\r\n        );\r\n        console.info(\r\n          `  - ${config.displayName} (${bookName}): ` +\r\n            `=${config.priority}, ` +\r\n            `=${config.autoLoad ? '' : ''}, ` +\r\n            `=${isAvailable ? '' : ''}`,\r\n        );\r\n      }\r\n\r\n      // \r\n      const autoLoadBooks: string[] = [];\r\n      for (const bookName in WORLDBOOKS) {\r\n        if (WORLDBOOKS[bookName].autoLoad) {\r\n          autoLoadBooks.push(bookName);\r\n        }\r\n      }\r\n\r\n      console.info(`[]  ${autoLoadBooks.length} `);\r\n\r\n      for (const bookName of autoLoadBooks) {\r\n        try {\r\n          await this.loadWorldbook(bookName);\r\n        } catch (err) {\r\n          console.warn(`[] : ${bookName}`, err);\r\n        }\r\n      }\r\n\r\n      this.initialized = true;\r\n\r\n      const status = this.getStatus();\r\n      console.info('[]  ');\r\n      console.table(status.loaded);\r\n\r\n      // \r\n      if (this.fallbackMode) {\r\n        console.warn('[]  ');\r\n        console.warn('[]  ');\r\n        console.warn('[]  ');\r\n\r\n        const fallbackBooks = status.loaded.filter(b => b.fallback);\r\n        console.table(fallbackBooks);\r\n\r\n        // 3\r\n        setTimeout(() => {\r\n          console.info('[] ...');\r\n          this.shutdown();\r\n        }, 3000);\r\n      } else {\r\n        console.info('[]  ');\r\n      }\r\n    },\r\n\r\n    /**\r\n     * \r\n     */\r\n    shutdown(): void {\r\n      console.info('[] ...');\r\n\r\n      // \r\n      this.loaded.clear();\r\n      this.loading.clear();\r\n\r\n      // \r\n      delete (DS as DetentionSystem & { loadWorldbook?: unknown }).loadWorldbook;\r\n      delete (DS as DetentionSystem & { unloadWorldbook?: unknown }).unloadWorldbook;\r\n      delete (DS as DetentionSystem & { reloadWorldbook?: unknown }).reloadWorldbook;\r\n      delete (DS as DetentionSystem & { predictiveCache?: unknown }).predictiveCache;\r\n      delete (DS as DetentionSystem & { getRelevantEntries?: unknown }).getRelevantEntries;\r\n      delete (DS as DetentionSystem & { getWorldbookStatus?: unknown }).getWorldbookStatus;\r\n      delete (DS as DetentionSystem & { dynamicLoad?: unknown }).dynamicLoad;\r\n\r\n      this.initialized = false;\r\n      this.fallbackMode = false;\r\n\r\n      console.info('[]  ');\r\n      console.info('[] ');\r\n    },\r\n  };\r\n\r\n  // ==========  ==========\r\n  (\r\n    DS as DetentionSystem & {\r\n      loadWorldbook?: (bookName: string) => Promise<LoadedWorldbook>;\r\n      unloadWorldbook?: (bookName: string) => Promise<void>;\r\n      reloadWorldbook?: (bookName: string) => Promise<LoadedWorldbook>;\r\n      predictiveCache?: (context: string) => Promise<void>;\r\n      dynamicLoad?: (userInput: string) => Promise<void>;\r\n      getRelevantEntries?: (context: string, max?: number) => unknown[];\r\n      getWorldbookStatus?: () => WorldbookStatus;\r\n    }\r\n  ).loadWorldbook = (bookName: string) => WorldbookLoader.loadWorldbook(bookName);\r\n  (DS as DetentionSystem & { unloadWorldbook?: (bookName: string) => Promise<void> }).unloadWorldbook = (\r\n    bookName: string,\r\n  ) => WorldbookLoader.unloadWorldbook(bookName);\r\n  (DS as DetentionSystem & { reloadWorldbook?: (bookName: string) => Promise<LoadedWorldbook> }).reloadWorldbook = (\r\n    bookName: string,\r\n  ) => WorldbookLoader.reloadWorldbook(bookName);\r\n  (DS as DetentionSystem & { predictiveCache?: (context: string) => Promise<void> }).predictiveCache = (\r\n    context: string,\r\n  ) => WorldbookLoader.predictiveCache(context);\r\n  (DS as DetentionSystem & { dynamicLoad?: (userInput: string) => Promise<void> }).dynamicLoad = (userInput: string) =>\r\n    WorldbookLoader.dynamicLoad(userInput);\r\n  (DS as DetentionSystem & { getRelevantEntries?: (context: string, max?: number) => unknown[] }).getRelevantEntries = (\r\n    context: string,\r\n    max?: number,\r\n  ) => WorldbookLoader.getRelevantEntries(context, max);\r\n  (DS as DetentionSystem & { getWorldbookStatus?: () => WorldbookStatus }).getWorldbookStatus = () =>\r\n    WorldbookLoader.getStatus();\r\n\r\n  DS.registerModule('worldbook', WorldbookLoader);\r\n\r\n  // iframe \r\n  try {\r\n    if (window.parent && window.parent !== window) {\r\n      (window.parent as any).detentionSystem = DS;\r\n      console.info('[]  ');\r\n    }\r\n  } catch (e) {\r\n    // \r\n  }\r\n\r\n  console.info('[]  ');\r\n\r\n  // ==========  ==========\r\n  DS.events.on('event_triggered', (eventData?: unknown) => {\r\n    const event = eventData as { id?: string; description?: string } | undefined;\r\n    if (event?.description) {\r\n      WorldbookLoader.predictiveCache(event.description).catch(err => {\r\n        console.warn('[] :', err);\r\n      });\r\n    }\r\n  });\r\n\r\n  // ==========  ==========\r\n  DS.events.on('user_input', (data?: unknown) => {\r\n    const input = data as { text?: string } | undefined;\r\n    if (input?.text && input.text.length > 5) {\r\n      WorldbookLoader.dynamicLoad(input.text).catch(err => {\r\n        console.warn('[] :', err);\r\n      });\r\n    }\r\n  });\r\n\r\n  // ==========  ==========\r\n  $(() => {\r\n    console.info('[] ...');\r\n\r\n    // 2\r\n    setTimeout(async () => {\r\n      console.info('[] ...');\r\n\r\n      try {\r\n        await WorldbookLoader.initialize();\r\n        console.info('[]  ');\r\n      } catch (error) {\r\n        console.error('[]  :', error);\r\n        console.info('[]  : window.initWorldbookLoader()');\r\n      }\r\n    }, 2000);\r\n  });\r\n\r\n  // ==========  ==========\r\n  (window as typeof window & { initWorldbookLoader?: () => Promise<WorldbookStatus> }).initWorldbookLoader =\r\n    async function () {\r\n      console.info('[] ...');\r\n\r\n      if (WorldbookLoader.initialized) {\r\n        console.info('[] ');\r\n        return WorldbookLoader.getStatus();\r\n      }\r\n\r\n      try {\r\n        await WorldbookLoader.initialize();\r\n        console.info('[]  ');\r\n        return WorldbookLoader.getStatus();\r\n      } catch (error) {\r\n        console.error('[]  :', error);\r\n        throw error;\r\n      }\r\n    };\r\n\r\n  console.info('[]  ');\r\n  console.info('[]  : window.initWorldbookLoader()');\r\n});\r\n","/**\n *  - \n * NPC\n *\n * \n * 1.  (core.ts) - \n * 2.  (status_panel.ts) - HTML\n * 3.  (event_system.ts) - \n * 4. NPC (npc_system.ts) - NPC\n * 5.  (worldbook_loader.ts) - \n */\n\n// #region agent log - HYP-A: \n//  CORS \ntry {\n  const isLocalDev =\n    typeof window !== 'undefined' &&\n    window.location &&\n    (window.location.hostname === 'localhost' ||\n      window.location.hostname === '127.0.0.1' ||\n      window.location.hostname.startsWith('192.168.') ||\n      window.location.hostname.startsWith('10.') ||\n      window.location.hostname.startsWith('172.'));\n\n  if (isLocalDev) {\n    fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        location: 'index.ts:',\n        message: '',\n        data: {\n          windowExists: typeof window !== 'undefined',\n          windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\n          windowDetentionSystemType: typeof window.detentionSystem,\n          userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'N/A',\n          isIframe: typeof window !== 'undefined' && window.parent !== window,\n          currentUrl: typeof window !== 'undefined' && window.location ? window.location.href : 'N/A',\n        },\n        timestamp: Date.now(),\n        sessionId: 'debug-session',\n        runId: 'script-load-debug',\n        hypothesisId: 'A',\n      }),\n    }).catch(() => {\n      // \n    });\n  }\n} catch (e) {\n  // \n}\n// #endregion\n\n// \nconsole.info(' [] ');\n// \n(window as any).__DETENTION_SYSTEM_LOADED__ = true;\n(window as any).__DETENTION_SYSTEM_LOADED_TIMESTAMP__ = Date.now();\nconsole.log('[DEBUG-HYP-A] index.ts:13 - ', {\n  timestamp: Date.now(),\n  windowExists: typeof window !== 'undefined',\n  windowDetentionSystem: typeof window.detentionSystem,\n  location: 'index.ts:13',\n  hypothesisId: 'A',\n});\nconsole.info('[] ...');\nconsole.info('[] ');\n\n// #region agent log - HYP-B: \n//  CORS \ntry {\n  const isLocalDev =\n    typeof window !== 'undefined' &&\n    window.location &&\n    (window.location.hostname === 'localhost' ||\n      window.location.hostname === '127.0.0.1' ||\n      window.location.hostname.startsWith('192.168.') ||\n      window.location.hostname.startsWith('10.') ||\n      window.location.hostname.startsWith('172.'));\n\n  if (isLocalDev) {\n    fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        location: 'index.ts:',\n        message: '',\n        data: {\n          windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\n        },\n        timestamp: Date.now(),\n        sessionId: 'debug-session',\n        runId: 'script-load-debug',\n        hypothesisId: 'B',\n      }),\n    }).catch(() => {});\n  }\n} catch (e) {\n  // \n}\n// #endregion\n\n// \nimport './core';\nimport './event_system';\nimport './npc_system';\nimport './status_panel';\nimport './worldbook_loader';\n\n// #region agent log - HYP-C: \n//  CORS \nsetTimeout(() => {\n  try {\n    const isLocalDev =\n      typeof window !== 'undefined' &&\n      window.location &&\n      (window.location.hostname === 'localhost' ||\n        window.location.hostname === '127.0.0.1' ||\n        window.location.hostname.startsWith('192.168.') ||\n        window.location.hostname.startsWith('10.') ||\n        window.location.hostname.startsWith('172.'));\n\n    if (isLocalDev) {\n      fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          location: 'index.ts:',\n          message: 'window.detentionSystem',\n          data: {\n            windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\n            windowDetentionSystemType: typeof window.detentionSystem,\n            hasPing:\n              typeof window.detentionSystem !== 'undefined' &&\n              typeof (window.detentionSystem as any).ping === 'function',\n            pingResult:\n              typeof window.detentionSystem !== 'undefined' &&\n              typeof (window.detentionSystem as any).ping === 'function'\n                ? (window.detentionSystem as any).ping()\n                : 'N/A',\n            version:\n              typeof window.detentionSystem !== 'undefined' && (window.detentionSystem as any).version\n                ? (window.detentionSystem as any).version\n                : 'N/A',\n          },\n          timestamp: Date.now(),\n          sessionId: 'debug-session',\n          runId: 'script-load-debug',\n          hypothesisId: 'C',\n        }),\n      }).catch(() => {});\n    }\n  } catch (e) {\n    // \n  }\n}, 100);\n// #endregion\n\nconsole.log('[DEBUG-HYP-A] index.ts:22 - ', {\n  timestamp: Date.now(),\n  windowDetentionSystemExists: typeof window.detentionSystem !== 'undefined',\n  windowDetentionSystemType: typeof window.detentionSystem,\n  windowDetentionSystemValue: window.detentionSystem ? 'object' : 'undefined',\n  location: 'index.ts:22',\n  hypothesisId: 'A',\n});\nconsole.info('[] ');\nconsole.log(' [] ');\nconsole.log(' window.detentionSystem:', typeof window.detentionSystem !== 'undefined' ? ' ' : ' ');\n"],"names":["console","info","EventEmitter","events","Map","on","event","callback","this","has","set","get","push","off","callbacks","index","indexOf","splice","emit","data","forEach","cb","error","once","wrapper","cacheStore","cacheCleanupTimer","bootstrapDetentionSystem","log","timestamp","Date","now","location","hypothesisId","CacheManager","key","value","ttl","expiry","item","delete","clear","cleanup","entries","eventsType","cacheManagerType","system","version","initialized","modules","config","tokenBudget","fallbackBudget","compressionQuality","cacheExpiry","healthCheckInterval","healthCheckTimeout","state","mode","tokenUsed","lastHealthCheck","errors","ping","checkTokenBudget","total","used","percentage","status","toFixed","remaining","updateTokenUsage","tokens","budget","warn","compressContent","content","quality","text","JSON","stringify","actualQuality","compressed","replace","trim","originalSize","length","compressedSize","ratio","registerModule","name","module","window","parent","detentionSystem","DS","e","getModule","handleError","context","normalized","Error","normalizeError","errorInfo","message","stack","shift","detectEnvironment","env","isSillyTavern","hasHelper","helperVersion","hasDataTable","SillyTavern","$","getTavernVersion","getTavernHelperVersion","windowWithTable","insertRow","updateRow","initialize","initializeState","systemType","systemExists","hasVersion","hasModules","hasEvents","systemVersion","windowExists","windowDetentionSystemExists","existingType","hostname","startsWith","resultType","resultExists","__DETENTION_SYSTEM_CORE_LOADED__","__DETENTION_SYSTEM_VERSION__","debug","String","errorStack","undefined","jQueryExists","jQueryType","exists","setInterval","ensureCacheCleanup","setTimeout","clearInterval","skipMessageId","skipCommandMessages","Set","eventMakeFirst","tavern_events","USER_MESSAGE_RENDERED","async","message_id","userMessage","getChatMessages","role","userInput","messageData","isSystemEventMessage","isSystemByContent","includes","waitingForEventResponse","stopAllGeneration","skipDayPattern","match","setChatMessages","is_hidden","refresh","add","eventOn","GENERATE_BEFORE_COMBINE_PROMPTS","size","messages","lastUserMessage","lastTriggerTime","lastTriggerEventName","generationTracking","iframe_events","GENERATION_STARTED","generation_id","type","triggerTime","eventName","source","stopGenerationById","then","success","options","dry_run","aiMessageTracking","CHARACTER_MESSAGE_RENDERED","aiMessage","messageText","some","m","messageLength","messagePreview","substring","relatedMessages","filter","timeGaps","sort","a","b","map","i","arr","gap","messageIds","lengths","totalLength","reduce","sum","recentMessages","Math","abs","id","timeDiff","MESSAGE_SENT","find","Number","protagonistPattern","DS_PROTAGONIST","npcSystem","generateProtagonist","crimeType","excludeCrimes","background","isIntellectual","isAcademic","isBusiness","ageRange","education","protagonistData","getCurrentChatId","protagonistInfo","age","crime","appearance","height","weight","hair","skin","features","personality","replaceVariables","protagonist","protagonist_name","protagonist_age","protagonist_crime","skipDayMatch","DS_CHECK","advanceDay","daysToSkip","numStr","parsed","parseInt","isNaN","chineseDigits","result","rest","slice","endsWith","prefix","shiIndex","before","after","parseNumber","waitForGenerationToStop","Promise","resolve","resolved","eventReturn","stop","eventOnce","GENERATION_ENDED","clearTimeout","timeout","builtin","duringGenerating","finalCheckCount","stopError","existingMessage","hideError","worldbookLoader","loadWorldbook","all","catch","err","loadError","interrupted","eventDay","day","tempCurrentDay","currentDay","pendingDays","eventSystem","confirmDayAdvancement","finalDay","createChatMessages","createError","DS_EMIT","DS_EVENT","eventData","eventPriority","priority","eventText","description","npcInfoText","eventId","generateNPCForEvent","eventNPC","npc","rank","relation","sceneData","policeDesc","police","witnesses","w","join","npcError","eventSystemModule","targetCellType","to","cellType","generateNPC","setCurrentCellNPCs","npcCount","floor","random","newNPCs","Array","isArray","cellBoss","max","relationship","influence","otherNPCs","cellBossName","Boolean","cellNPCError","eventCategory","category","getCurrentCellNPCs","cellNPCs","initialNPCCount","initialNPCs","npcNames","min","createPromise","eventMessageId","getLastMessageId","generationStartedReturn","generationEndedReceived","generationStartedCount","waitForGenerationToComplete","timeoutHandle","forceStopAttempts","messagesBeforeTrigger","lastAssistantMessage","allMessages","assistantMessages","lastAssistant","lastAssistantMessageId","lastAssistantMessageLength","lastAssistantMessagePreview","triggerSlash","messagesAfterTrigger","generationEndHandler","messageIdMatched","messageEndContent","messageEndLength","messageEnd","message5Content","message5Length","message5Preview","message5","message5ContainsEventContent","message5ContainsSystemEvent","contentUpdatedToMessage5","allAssistantMessages","msg","tracked","t","actualMessageId","expectedMessageId","relatedMessagesCount","generationEndMessageId","trackedMessageIds","allTrackedMessages","relatedMessageIds","eventWithPending","pendingDayAdvancement","saveStateToChatVars","saveEventInterruptSnapshot","generationStoppedHandler","GENERATION_STOPPED","rollbackToInterruptSnapshot","toLocaleTimeString","systemCheck","hasPing","pingResult","hasInitializeState","modulesCount","Object","keys","isIframe","hasParent","parentHasDetentionSystem","parentHasDS","DS_RAW","saveStateTimer","getCurrentDayFromMemoryEnhancement","fallback","statusPanel","getState","days","EventSystem","getCurrentDayInternal","lastEventDay","eventHistory","legalTimeline","arrestDay","approvalDay","prosecutionDay","firstTrialDay","firstVerdictDay","secondTrialDay","finalVerdictDay","transferDay","executionDay","currentStage","caseComplexity","complexityMultiplier","eventCounters","interrogation","prosecutor_interrogation","lawyer_visit","family_visit","medical_visit","scene_identification","isDeathPenalty","lastStageChangeDay","assignedOfficers","prosecutor","PRIORITY","LEGAL","PROCEDURAL","CONDITION","RANDOM","DAILY","legalEvents","approval","minDay","maxDay","stage","nextStage","investigation","duration","prosecution","firstTrial","firstVerdict","appeal","secondTrial","finalVerdict","transfer","deathReview","execution","conditionEvents","condition","mental","checkAlways","health","_state","stageChangeOnly","daysInCustody","minDays","maxDays","remainingDays","requiredTriggers","forcedProbability","daysSinceApproval","baseProbability","finalProbability","pow","daysToTrial","daysToTrial2","lastVisit","probability","lastMedical","recentContext","getRecentContext","kw","aiControlled","randomEvents","violence","medical","emotional","accident","innerMonologues","startDay","chatVars","getVariables","getVarsError","savedData","detentionSystemState","savedPolice","policeArray","stateData","truncatedStateData","testChatVars","testError","updateVariablesWith","variables","setCaseComplexity","complexity","validComplexities","simple","normal","complex","very_complex","multiplier","checkComplexityAdjustment","rollbackToStage","targetStage","reason","stageOrder","targetIndex","currentIndex","timelineKeys","trial1","trial2","from","advanceToStage","handleUserRollback","input","rollbackPatterns","pattern","rule","daysToAdvance","originalCurrentDay","dayEvent","checkDayEvents","prototype","hasOwnProperty","call","interruptedEvent","currentDate","month","getMonth","getDate","checkCellTransfer","cellTypeNames","transition","pretrial","convicted","legalEvent","checkLegalEvent","conditionEvent","checkConditionEvent","policeNames","prosecutorNames","usedNames","availableNames","selectedName","hasApproval","beforeFirstTrial","isInvestigationOrProsecution","shouldInterrupt","randomEvent","generateRandomEvent","monologue","generateInnerMonologue","stageBefore","daysSinceProsecution","daysSinceTrial","daysSinceAppeal","daysSinceVerdict","isEnding","endingType","getProtagonistState","types","eventType","weightedRandom","eventList","eventWeights","weights","count","totalWeight","strength","intelligence","chat","mes","setDeathPenalty","getCurrentStageInfo","cellTypeChinese","cellTypeRaw","timeline","getEventStatistics","stats","totalEvents","byType","byPriority","recentEvents","exportTimeline","importTimeline","snapshot","snapshotTime","detentionSystemInterruptSnapshot","updateError","oldDay","newDay","modifyValue","_context","getCurrentDay","getCurrentStage","NameGenerator","surnames","tier1","names","tier2","tier3","tier4","tier5","givenNames","vintage","single","double","classic","modern","contemporary","badNames","badChars","generate","birthYear","attempts","fullName","selectSurname","selectGivenName","isValidName","tiers","values","tier","getFullYear","style","styleData","pair","char","CrimeGenerator","characterBookCrimes","crimes","violent","sentenceRange","property","drug","economic","social","other","findCategoryByCrime","sentence","generateSentence","categories","cat","crimeName","range","__DETENTION_SYSTEM_LOADED__","__NPC_SYSTEM_LOADING__","NPCGenerator","npcDatabase","currentCellNPCs","npcs","generateSingle","stageInfo","generateAge","crimeData","generateAppearance","generatePersonality","generateBackground","generateRelationship","adjustByCellType","generateId","gender","createdAt","heights","hairStyles","skinTones","eyes","traits","aggression","sociability","dominance","kindness","tags","_crimeData","educations","educationIndex","maritalStatuses","maritalWeights","maritalIndex","hasChildren","childrenCount","maritalStatus","hometown","generateHometown","priorConvictions","provinces","toProtagonist","faction","allies","enemies","toString","generateForEvent","generatePolice","generateLawyer","generateFamily","generateDoctor","ranks","attitude","isFemale","typeIndex","experience","successRate","relationships","supportLevel","specialties","specialty","fetch","method","headers","body","hasOptions","sessionId","runId","categoryKey","filteredCrimes","c","profession","highEducations","mediumEducations","lowEducations","businessEducations","businessProfessions","intellectualProfessions","academicProfessions","addNPCToCell","removeNPCFromCell","npcId","findIndex","n","findNPCById","updateRelationship","delta","npcName","exportData","database","currentCell","importData","clearData","findNPC","updateNPCRelationship","exportNPCData","importNPCData","parentWindow","parentDS","verification","hasGenerateNPC","hasGenerateNPCForEvent","hasGenerateProtagonist","hasGetCurrentCellNPCs","hasSetCurrentCellNPCs","hasNPCSystemModule","newCellType","__NPC_SYSTEM_LOADED__","__NPC_SYSTEM_LOADED_TIMESTAMP__","Vue","CONFIG","updateInterval","animationDuration","trendWindow","slowChangeThreshold","regressionRate","healthBaseline","mentalBaseline","parseRetryAttempts","parseRetryDelay","debugMode","clothing","top","bottom","underwear","underpants","socks","shoes","restraints","cleanliness","currentTask","currentThought","biggestWorry","changes","accumulated","lastUpdate","totalUpdates","successfulParses","failedParses","lastParseTime","isUpdating","mutationObserver","updateLoopInterval","debugLog","args","formatDuration","ms","seconds","minutes","hours","recordChange","calculateTrend","acc","change","syncStateToMemoryEnhancement","checkError","plugin","detectMemoryEnhancementPlugin","updateState","setState","updateDisplay","parseCommentNode","node","nodeType","Node","COMMENT_NODE","nodeValue","textContent","jsonStr","parseStatusUpdate","attempt","parse","errorMessage","checkForStatusUpdate","element","ELEMENT_NODE","walker","document","createTreeWalker","NodeFilter","SHOW_COMMENT","nextNode","getStateFromMemoryEnhancement","stopCommentListener","disconnect","stopUpdateLoop","memoryEnhancement","stMemoryEnhancement","MemoryEnhancement","MemoryEnhancementPlugin","memoryEnhancementPlugin","ext_getAllTables","ext_exportAllTablesAsJson","memoryState","messageVars","possiblePaths","path","candidate","searchInVars","vars","foundInChat","foundInMessage","jsonData","tables","possibleTableNames","targetTable","table","toLowerCase","header","h","firstDataRow","stateObj","colName","normalizedName","numValue","parseFloat","finalValue","jsonError","allTables","extError","cell_type","StatusPanel","MutationObserver","mutations","mutation","addedNodes","target","observe","childList","subtree","characterData","characterDataOldValue","d","destroy","oldValue","newValue","getTrendAnalysis","trend","reset","scanAllComments","comments","fullContent","isStatusUpdate","getDiagnostics","diagnostics","toLocaleString","observer","active","timeSinceUpdate","timeSinceUpdateFormatted","currentState","WORLDBOOKS","detention_rules","displayName","keywords","autoLoad","position","depth","fallbackEntries","internal_basic_procedures","internal_basic_legal","legal_knowledge","environment_descriptions","narrative_enhancements","safeGetWorldbookNames","hasGlobalFn","getWorldbookNames","hasTavernHelper","TavernHelper","hasTavernHelperFn","helper","characterId","WorldbookLoader","loaded","loading","fallbackMode","characterWorldbookId","failedBooks","findCharacterWorldbook","charWorldbooks","getCharWorldbookNames","primary","additional","bookName","loadPromise","_loadWorldbookInternal","allWorldbookNames","targetWorldbookName","exactDisplayMatch","fuzzyMatch","availableBooks","worldbookData","getWorldbook","getWorldbookError","isDataFormatError","rebindCharWorldbooks","loadedAt","predictiveCache","predictions","matchScore","weightedScore","keyword","descKeywords","descKw","finalScore","score","toLoad","p","pred","getRelevantEntries","maxEntries","allEntries","bookData","entry","bookDisplayName","scoredEntries","contentMatch","constant","aPriority","relevant","dynamicLoad","triggers","matchCount","bestKeyword","maxKeywordLength","trigger","getStatus","characterWorldbook","available","_promise","unloadWorldbook","targetName","newAdditional","reloadWorldbook","retries","availableWorldbooks","isAvailable","autoLoadBooks","fallbackBooks","shutdown","getWorldbookStatus","initWorldbookLoader","windowDetentionSystemType","userAgent","navigator","currentUrl","href","__DETENTION_SYSTEM_LOADED_TIMESTAMP__","windowDetentionSystem","windowDetentionSystemValue"],"ignoreList":[],"sourceRoot":""}