# 角色书格式转换 - 快速指南

## 转换步骤

### 1. 准备文件

将您的角色卡 JSON 文件准备好，确保包含 `character_book` 字段。

### 2. 运行转换脚本

```bash
python convert_character_book.py <输入文件> <输出文件>
```

**示例**:
```bash
# 转换您的角色卡
python convert_character_book.py character_card.json converted_character_card.json
```

### 3. 验证转换结果

转换完成后，检查输出文件：
- 所有条目都有 `uid` 字段（从 0 开始）
- 所有条目都有完整的 `strategy` 对象
- 所有条目都有完整的 `position` 对象
- `position.type` 不是 `"at_depth"` 时，不包含 `role` 和 `depth`

### 4. 导入到 SillyTavern

1. 打开 SillyTavern
2. 导入转换后的角色卡 JSON
3. 检查世界书是否能正常加载
4. 测试条目激活功能

## 转换前后对比

### 转换前（旧格式）

```json
{
    "keys": ["系统状态", "脚本检测"],
    "content": "...",
    "enabled": true,
    "insertion_order": 100,
    "name": "系统状态",
    "priority": 100,
    "constant": true,
    "position": "after_char"
}
```

### 转换后（新格式）

```json
{
    "uid": 0,
    "name": "系统状态",
    "enabled": true,
    "strategy": {
        "type": "constant",
        "keys": ["系统状态", "脚本检测"],
        "keys_secondary": { "logic": "and_any", "keys": [] },
        "scan_depth": "same_as_global"
    },
    "position": {
        "type": "after_character_definition",
        "order": 100
    },
    "content": "...",
    "probability": 100,
    "recursion": {
        "prevent_incoming": false,
        "prevent_outgoing": false,
        "delay_until": null
    },
    "effect": {
        "sticky": null,
        "cooldown": null,
        "delay": null
    }
}
```

## 关键转换规则

| 旧格式字段 | 新格式字段 | 说明 |
|-----------|-----------|------|
| `constant: true` | `strategy.type: "constant"` | 蓝灯条目 |
| `constant: false` | `strategy.type: "selective"` | 绿灯条目 |
| `keys` (顶层) | `strategy.keys` | 关键词数组 |
| `position: "after_char"` | `position.type: "after_character_definition"` | 位置类型 |
| `insertion_order` | `position.order` | 插入顺序 |
| `priority` | `probability` | 激活概率 |
| - | `uid` | 自动生成（从 0 开始） |
| - | `strategy.keys_secondary` | 默认值 |
| - | `recursion` | 默认值 |
| - | `effect` | 默认值 |

## 注意事项

⚠️ **重要**: 
- 转换前请**务必备份**原始文件
- `position.type` 不是 `"at_depth"` 时，不应包含 `role` 和 `depth` 字段
- 转换后请在 SillyTavern 中测试功能是否正常

## 常见问题

**Q: 转换后条目无法激活？**
- 检查 `strategy.type` 是否正确
- 检查 `probability` 是否设置为 100（如果需要总是激活）

**Q: 位置不正确？**
- 检查 `position.type` 是否正确映射
- 检查 `position.order` 是否合理

**Q: 脚本报错？**
- 确保输入文件是有效的 JSON
- 确保包含 `character_book` 字段

## 完整文档

更多详细信息，请查看 `角色书格式转换说明.md`
