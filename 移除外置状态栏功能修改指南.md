# 移除外置状态栏功能修改指南

## 概述

如果您要移除所有外置状态栏功能，改为使用内置状态栏（MVU状态栏或记忆增强插件），需要修改角色卡的以下部分：

---

## 📋 需要修改的部分

### 1. **system_prompt** - 移除外置状态栏相关说明

#### 修改位置1：模块检测机制说明

**原内容**（第64-71行）：
```markdown
### 模块检测机制（新增）
系统会检测以下核心模块的加载状态：
1. **核心系统 (core)**：基础框架，必需
2. **事件系统 (eventSystem)**：法律流程、事件触发
3. **状态栏 (statusPanel)**：状态追踪、趋势分析  ⬅️ 需要移除
4. **NPC系统 (npcSystem)**：NPC生成、关系管理
5. **知识库加载器 (worldbook)**：动态知识库加载
```

**修改为**：
```markdown
### 模块检测机制（新增）
系统会检测以下核心模块的加载状态：
1. **核心系统 (core)**：基础框架，必需
2. **事件系统 (eventSystem)**：法律流程、事件触发
3. **NPC系统 (npcSystem)**：NPC生成、关系管理
4. **知识库加载器 (worldbook)**：动态知识库加载

**注意**：状态栏功能已改为使用内置状态栏（MVU状态栏或记忆增强插件），不再依赖外置脚本的状态栏模块。
```

#### 修改位置2：模块检测代码

**原内容**（第112-155行）：
```javascript
let 模块状态 = {
  core: false,
  eventSystem: false,
  statusPanel: false,  // ⬅️ 需要移除
  npcSystem: false,
  worldbook: false
};

// ... 检测代码 ...

// 检测状态栏
const statusPanel = DS.getModule('statusPanel');
if (statusPanel && typeof DS.getState === 'function') {
  模块状态.statusPanel = true;
} else {
  缺失模块列表.push('状态栏(statusPanel)');
}
```

**修改为**：
```javascript
let 模块状态 = {
  core: false,
  eventSystem: false,
  // statusPanel: false,  // ⬅️ 已移除，不再检测外置状态栏
  npcSystem: false,
  worldbook: false
};

// ... 检测代码 ...

// 不再检测状态栏模块，改为检测记忆增强插件
let 记忆增强插件状态 = false;
try {
  const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
  if (memoryEnhancement && typeof memoryEnhancement.getState === 'function') {
    记忆增强插件状态 = true;
  }
} catch (error) {
  console.warn('记忆增强插件检测失败:', error);
}
```

#### 修改位置3：状态获取逻辑

**原内容**（第188-204行）：
```javascript
// 3. 根据运行模式使用相应功能
if (DS && 运行模式 !== '降级模式(基础功能)') {
  // 获取当前状态
  const state = DS.getState?.() || null;  // ⬅️ 需要修改
  const stageInfo = DS.getCurrentStage?.() || null;
  const currentDay = DS.getCurrentDay?.() || 0;
  const eventResult = DS.advanceDay?.(0) || null;
  const trend = DS.getTrendAnalysis?.() || null;  // ⬅️ 需要修改
}
```

**修改为**：
```javascript
// 3. 根据运行模式使用相应功能
if (DS && 运行模式 !== '降级模式(基础功能)') {
  // 优先从记忆增强插件获取状态
  let state = null;
  let 状态来源 = '默认值';

  if (记忆增强插件状态) {
    try {
      const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
      const memoryState = memoryEnhancement.getState();
      if (memoryState && (memoryState.health !== undefined || memoryState.mental !== undefined)) {
        state = memoryState;
        状态来源 = '记忆增强插件';
      }
    } catch (error) {
      console.warn('从记忆增强插件获取状态失败:', error);
    }
  }

  // 如果记忆增强插件不可用，使用默认值
  if (!state) {
    state = {
      health: 70,
      mental: 65,
      strength: 50,
      intelligence: 55
    };
    状态来源 = '默认值';
  }

  const stageInfo = DS.getCurrentStage?.() || null;
  const currentDay = DS.getCurrentDay?.() || 0;
  const eventResult = DS.advanceDay?.(0) || null;
  // 不再使用趋势分析（外置状态栏功能）
}
```

#### 修改位置4：模块状态显示

**原内容**（第207-221行）：
```markdown
### 模块状态显示
在系统提示中必须显示：
```
━━━━━━━━━━━━━━━━━━━━━━
模块加载状态:
  核心系统: ✅/❌
  事件系统: ✅/❌
  状态栏: ✅/❌  ⬅️ 需要移除
  NPC系统: ✅/❌
  知识库加载器: ✅/❌

运行模式: [外置脚本(完整功能)/外置脚本(部分功能)/降级模式(基础功能)]
缺失模块: [如有缺失，列出模块名称]
━━━━━━━━━━━━━━━━━━━━━━
```
```

**修改为**：
```markdown
### 模块状态显示
在系统提示中必须显示：
```
━━━━━━━━━━━━━━━━━━━━━━
模块加载状态:
  核心系统: ✅/❌
  事件系统: ✅/❌
  NPC系统: ✅/❌
  知识库加载器: ✅/❌
  记忆增强插件: ✅/❌  ⬅️ 新增

运行模式: [外置脚本(完整功能)/外置脚本(部分功能)/降级模式(基础功能)]
缺失模块: [如有缺失，列出模块名称]
状态来源: [记忆增强插件/默认值]  ⬅️ 新增
━━━━━━━━━━━━━━━━━━━━━━
```
```

---

### 2. **post_history_prompt** - 修改状态检测和同步逻辑

#### 修改位置1：模块状态定义

**原内容**（第38-45行）：
```javascript
let 模块状态 = {
  core: false,
  eventSystem: false,
  statusPanel: false,  // ⬅️ 需要移除
  npcSystem: false,
  worldbook: false
};
```

**修改为**：
```javascript
let 模块状态 = {
  core: false,
  eventSystem: false,
  // statusPanel: false,  // ⬅️ 已移除，不再检测外置状态栏
  npcSystem: false,
  worldbook: false
};

// 新增：记忆增强插件状态
let 记忆增强插件状态 = false;
```

#### 修改位置2：状态栏模块检测

**原内容**（第76-82行）：
```javascript
// 检测状态栏
const statusPanel = DS.getModule('statusPanel');
if (statusPanel && typeof DS.getState === 'function') {
  模块状态.statusPanel = true;
} else {
  缺失模块列表.push('状态栏(statusPanel)');
}
```

**修改为**：
```javascript
// 不再检测状态栏模块，改为检测记忆增强插件
try {
  const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
  if (memoryEnhancement && typeof memoryEnhancement.getState === 'function') {
    记忆增强插件状态 = true;
  }
} catch (error) {
  console.warn('记忆增强插件检测失败:', error);
}
```

#### 修改位置3：状态同步逻辑

**原内容**（第119-132行）：
```javascript
// 根据模块状态使用相应功能
if (DS && 运行模式 !== '降级模式(基础功能)') {
  // 状态栏模块可用时
  if (模块状态.statusPanel) {
    const state = DS.getState();
    const stageInfo = DS.getCurrentStage();
    const trend = DS.getTrendAnalysis();
  } else {
    // 状态栏模块不可用，使用内置简化状态
    console.warn('状态栏模块未加载，使用内置简化状态');
  }
```

**修改为**：
```javascript
// 根据模块状态使用相应功能
if (DS && 运行模式 !== '降级模式(基础功能)') {
  // 优先从记忆增强插件获取状态
  let state = null;
  let 状态来源 = '默认值';

  if (记忆增强插件状态) {
    try {
      const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
      const memoryState = memoryEnhancement.getState();
      if (memoryState && (memoryState.health !== undefined || memoryState.mental !== undefined)) {
        state = memoryState;
        状态来源 = '记忆增强插件';
      }
    } catch (error) {
      console.warn('从记忆增强插件获取状态失败:', error);
    }
  }

  // 如果记忆增强插件不可用，使用默认值
  if (!state) {
    state = {
      health: 70,
      mental: 65,
      strength: 50,
      intelligence: 55
    };
    状态来源 = '默认值';
  }

  const stageInfo = DS.getCurrentStage?.() || null;
  // 不再使用趋势分析（外置状态栏功能）
```

#### 修改位置4：状态显示格式

**原内容**（第192-222行）：
```markdown
## 6. 状态显示（仅在系统提示中）

```
━━━━━━━━━━━━━━━━━━━━━━
模块加载状态:
  核心系统: [✅/❌]
  事件系统: [✅/❌]
  状态栏: [✅/❌]  ⬅️ 需要移除
  NPC系统: [✅/❌]
  知识库加载器: [✅/❌]

运行模式: [外置脚本(完整功能)/外置脚本(部分功能)/降级模式(基础功能)]
缺失模块: [如有缺失，列出模块名称，如：事件系统(eventSystem)、状态栏(statusPanel)]
```

**修改为**：
```markdown
## 6. 状态显示（仅在系统提示中）

```
━━━━━━━━━━━━━━━━━━━━━━
模块加载状态:
  核心系统: [✅/❌]
  事件系统: [✅/❌]
  NPC系统: [✅/❌]
  知识库加载器: [✅/❌]
  记忆增强插件: [✅/❌]  ⬅️ 新增

运行模式: [外置脚本(完整功能)/外置脚本(部分功能)/降级模式(基础功能)]
缺失模块: [如有缺失，列出模块名称，如：事件系统(eventSystem)、NPC系统(npcSystem)]
状态来源: [记忆增强插件/默认值]  ⬅️ 新增
```
```

---

### 3. **角色卡JSON** - 更新描述和配置

#### 修改位置1：description字段

**原内容**：
```json
"description": "中国女子看守所智能模拟系统v3.5.6。深度集成六大外置脚本：核心系统(core.js)、事件系统(event_system.js)、状态栏(status_panel.js)、NPC生成(npc_system.js)、知识库加载(worldbook_loader.js)、系统整合(integration.js)。支持动态状态追踪、缓慢变化机制、均值回归、预测性事件触发。完全适配SillyTavern 1.15.0和酒馆助手4.3.16，支持dataTable数据表格系统。新增剧情推进限制和详细描写要求。**已适配记忆增强插件，优先使用插件状态信息。**支持时间跳过功能。"
```

**修改为**：
```json
"description": "中国女子看守所智能模拟系统v3.5.6。深度集成五大外置脚本：核心系统(core.js)、事件系统(event_system.js)、NPC生成(npc_system.js)、知识库加载(worldbook_loader.js)、系统整合(integration.js)。**使用内置状态栏（MVU状态栏或记忆增强插件），不再依赖外置状态栏模块。**支持动态状态追踪、缓慢变化机制、均值回归、预测性事件触发。完全适配SillyTavern 1.15.0和酒馆助手4.3.16，支持dataTable数据表格系统。新增剧情推进限制和详细描写要求。**已适配记忆增强插件，优先使用插件状态信息。**支持时间跳过功能。"
```

#### 修改位置2：character_book条目

需要修改以下条目：

##### 条目1："系统状态"条目

**原内容**：
```markdown
3. **status_panel.js** - 状态栏系统
   - 实时状态显示
   - 健康/精神追踪
   - 缓慢变化机制
   - 均值回归系统
   - 趋势分析
   - 外貌/穿着管理
   - HTML注释解析
```

**修改为**：
```markdown
**注意**：状态栏功能已改为使用内置状态栏（MVU状态栏或记忆增强插件），不再依赖外置脚本的status_panel.js模块。内置状态栏会自动读取HTML注释中的状态更新。
```

##### 条目2："状态系统"条目

**原内容**：
```markdown
## 降级模式差异

### 外置模式
- 实时状态栏显示
- 自动趋势分析
- 精确的累积计算
- 完整的回归系统
- HTML注释自动解析

### 降级模式
- 文本描述状态
- 简化的变化计算
- 基础的回归机制
- 手动趋势判断
```

**修改为**：
```markdown
## 状态栏模式差异

### 记忆增强插件模式（最优）
- 实时状态栏显示
- 自动状态同步
- 精确的状态追踪
- 完整的趋势分析
- 自动HTML注释解析

### 内置状态栏模式（次优）
- 实时状态栏显示（MVU状态栏）
- 基础的状态追踪
- 自动HTML注释解析

### 降级模式（基础）
- 文本描述状态
- 简化的变化计算
- 基础的回归机制
- 手动趋势判断
```

---

## ✅ 修改清单

### system_prompt 修改
- [ ] 移除模块检测机制中的"状态栏 (statusPanel)"说明
- [ ] 移除模块状态定义中的`statusPanel: false`
- [ ] 移除状态栏模块检测代码
- [ ] 修改状态获取逻辑，改为使用记忆增强插件
- [ ] 更新模块状态显示格式，移除"状态栏"，添加"记忆增强插件"和"状态来源"

### post_history_prompt 修改
- [ ] 移除模块状态定义中的`statusPanel: false`
- [ ] 移除状态栏模块检测代码
- [ ] 添加记忆增强插件检测代码
- [ ] 修改状态同步逻辑，改为使用记忆增强插件
- [ ] 更新状态显示格式，移除"状态栏"，添加"记忆增强插件"和"状态来源"

### 角色卡JSON修改
- [ ] 更新`description`字段，移除"状态栏(status_panel.js)"，添加内置状态栏说明
- [ ] 修改"系统状态"条目，移除status_panel.js说明
- [ ] 修改"状态系统"条目，更新降级模式说明

---

## 🔍 验证步骤

修改完成后，请验证：

1. **记忆增强插件检测**：在浏览器控制台检查 `window.MemoryEnhancement` 是否存在
2. **状态获取**：确认系统能正确从记忆增强插件获取状态
3. **系统提示**：确认系统提示中不再显示"状态栏"模块，而是显示"记忆增强插件"状态
4. **状态更新**：确认 `<!--STATUS_UPDATE:...-->` 格式仍然正常工作
5. **回退机制**：确认在记忆增强插件不可用时能正确使用默认值

---

## 📝 注意事项

1. **兼容性**：确保修改后的角色卡在记忆增强插件不可用时仍能正常工作
2. **状态更新格式**：继续使用 `<!--STATUS_UPDATE:...-->` 格式更新状态，记忆增强插件会自动读取
3. **运行模式判断**：运行模式判断不再考虑状态栏模块，只考虑核心系统、事件系统、NPC系统、知识库加载器
4. **缺失模块列表**：不再在缺失模块列表中显示"状态栏(statusPanel)"

---

## 🎯 总结

主要修改点：
1. ✅ 移除所有外置状态栏模块的检测和使用
2. ✅ 改为使用记忆增强插件或默认值获取状态
3. ✅ 更新系统提示格式，移除"状态栏"模块显示
4. ✅ 更新角色卡描述，说明使用内置状态栏

这些修改将确保角色卡：
- 不再依赖外置脚本的状态栏模块
- 优先使用记忆增强插件获取状态
- 在插件不可用时使用默认值
- 在系统提示中清晰显示状态来源
