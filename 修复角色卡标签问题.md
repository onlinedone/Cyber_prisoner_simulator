# ä¿®å¤è§’è‰²å¡æ ‡ç­¾é—®é¢˜

## ğŸ” é”™è¯¯åˆ†æ

### é”™è¯¯ä¿¡æ¯
```
tags.js:777 Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'map')
    at handleTagImport (tags.js:777:39)
    at importTags (tags.js:748:36)
    at importCharactersTags (script.js:10176:19)
```

### é—®é¢˜åŸå› 

è¿™ä¸ªé”™è¯¯è¡¨æ˜ SillyTavern åœ¨å°è¯•å¯¼å…¥è§’è‰²å¡æ—¶ï¼ŒæœŸæœ›æ‰¾åˆ°ä¸€ä¸ªæ•°ç»„å­—æ®µï¼ˆå¾ˆå¯èƒ½æ˜¯ `tags`ï¼‰ï¼Œä½†è¯¥å­—æ®µæ˜¯ `undefined`ã€‚

**æ ¹æœ¬åŸå› **ï¼šè§’è‰²å¡JSONä¸­ç¼ºå°‘ `tags` å­—æ®µï¼Œæˆ–è€… `tags` å­—æ®µçš„å€¼ä¸æ˜¯æ•°ç»„ç±»å‹ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ·»åŠ  tags å­—æ®µï¼ˆæ¨èï¼‰

åœ¨è§’è‰²å¡çš„ `data` å¯¹è±¡ä¸­æ·»åŠ  `tags` å­—æ®µï¼š

```json
{
  "spec": "chara_card_v2",
  "spec_version": "2.0",
  "data": {
    "name": "èµ›åšåç‰¢æ¨¡æ‹Ÿå™¨",
    "tags": [],  // â† æ·»åŠ è¿™ä¸ªå­—æ®µ
    "description": "...",
    "personality": "...",
    "scenario": "...",
    "first_mes": "...",
    "mes_example": "...",
    "system_prompt": "...",
    "post_history_prompt": "...",
    "character_book": {
      // ...
    }
  }
}
```

### æ–¹æ¡ˆ2ï¼šç¡®ä¿ tags æ˜¯æ•°ç»„

å¦‚æœå·²ç»æœ‰ `tags` å­—æ®µï¼Œç¡®ä¿å®ƒæ˜¯æ•°ç»„ç±»å‹ï¼š

```json
{
  "data": {
    "tags": []  // ç©ºæ•°ç»„ä¹Ÿå¯ä»¥
    // æˆ–è€…
    "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"]  // æœ‰å†…å®¹çš„æ•°ç»„
  }
}
```

**æ³¨æ„**ï¼š`tags` å­—æ®µä¸èƒ½æ˜¯ `null`ï¼Œå¿…é¡»æ˜¯æ•°ç»„ï¼ˆå³ä½¿æ˜¯ç©ºæ•°ç»„ `[]`ï¼‰ã€‚

---

## ğŸ”§ å®Œæ•´çš„å¿…éœ€å­—æ®µæ¸…å•

æ ¹æ® SillyTavern v2 æ ¼å¼ï¼Œè§’è‰²å¡çš„ `data` å¯¹è±¡åº”è¯¥åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

### å¿…éœ€å­—æ®µ

```json
{
  "data": {
    "name": "è§’è‰²åç§°",                    // å¿…éœ€
    "description": "è§’è‰²æè¿°",             // å¿…éœ€
    "personality": "æ€§æ ¼æè¿°",             // å¿…éœ€
    "scenario": "åœºæ™¯æè¿°",                // å¿…éœ€
    "first_mes": "é¦–æ¬¡æ¶ˆæ¯",               // å¿…éœ€
    "mes_example": "ç¤ºä¾‹æ¶ˆæ¯",              // å¿…éœ€
    "system_prompt": "ç³»ç»Ÿæç¤ºè¯",          // å¯é€‰ä½†æ¨è
    "post_history_instructions": "åå†å²æŒ‡ä»¤", // å¯é€‰ä½†æ¨è
    "character_book": { ... },             // å¯é€‰ä½†æ¨è
    "tags": []                             // å¿…éœ€ï¼ˆå³ä½¿æ˜¯ç©ºæ•°ç»„ï¼‰
  }
}
```

### å¯é€‰å­—æ®µ

```json
{
  "data": {
    "creator_notes": "åˆ›å»ºè€…æ³¨é‡Š",         // å¯é€‰
    "creator": "åˆ›å»ºè€…åç§°",                // å¯é€‰
    "alternate_greetings": [],             // å¯é€‰
    "character_version": "ç‰ˆæœ¬å·",          // å¯é€‰
    "extensions": { ... }                  // å¯é€‰
  }
}
```

---

## ğŸ› ï¸ å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥å½“å‰JSON

æ£€æŸ¥æ‚¨çš„è§’è‰²å¡JSONä¸­æ˜¯å¦åŒ…å« `tags` å­—æ®µï¼š

```json
{
  "spec": "chara_card_v2",
  "spec_version": "2.0",
  "data": {
    // ... å…¶ä»–å­—æ®µ ...
    "tags": []  // â† æ£€æŸ¥è¿™ä¸ªå­—æ®µæ˜¯å¦å­˜åœ¨
  }
}
```

### æ­¥éª¤2ï¼šæ·»åŠ  tags å­—æ®µ

å¦‚æœç¼ºå°‘ `tags` å­—æ®µï¼Œåœ¨ `data` å¯¹è±¡ä¸­æ·»åŠ ï¼š

```json
{
  "data": {
    "name": "èµ›åšåç‰¢æ¨¡æ‹Ÿå™¨",
    "tags": [],  // â† æ·»åŠ è¿™ä¸€è¡Œ
    // ... å…¶ä»–å­—æ®µ ...
  }
}
```

### æ­¥éª¤3ï¼šéªŒè¯JSONæ ¼å¼

ä½¿ç”¨PythonéªŒè¯JSONæ ¼å¼ï¼š

```bash
python -c "import json; data = json.load(open('character_card.json', 'r', encoding='utf-8')); print('tagså­—æ®µ:', 'tags' in data.get('data', {})); print('tagsç±»å‹:', type(data.get('data', {}).get('tags')))"
```

### æ­¥éª¤4ï¼šé‡æ–°å¯¼å…¥

1. ä¿å­˜ä¿®æ”¹åçš„JSONæ–‡ä»¶
2. åœ¨ SillyTavern ä¸­é‡æ–°å¯¼å…¥è§’è‰²å¡
3. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯

---

## ğŸ“‹ å®Œæ•´çš„ä¿®å¤ç¤ºä¾‹

### ä¿®å¤å‰ï¼ˆç¼ºå°‘ tagsï¼‰

```json
{
  "spec": "chara_card_v2",
  "spec_version": "2.0",
  "data": {
    "name": "èµ›åšåç‰¢æ¨¡æ‹Ÿå™¨",
    "description": "...",
    "personality": "...",
    // ... å…¶ä»–å­—æ®µ ...
    "character_book": { ... }
    // âŒ ç¼ºå°‘ tags å­—æ®µ
  }
}
```

### ä¿®å¤åï¼ˆæ·»åŠ  tagsï¼‰

```json
{
  "spec": "chara_card_v2",
  "spec_version": "2.0",
  "data": {
    "name": "èµ›åšåç‰¢æ¨¡æ‹Ÿå™¨",
    "description": "...",
    "personality": "...",
    // ... å…¶ä»–å­—æ®µ ...
    "tags": [],  // âœ… æ·»åŠ  tags å­—æ®µï¼ˆç©ºæ•°ç»„ï¼‰
    "character_book": { ... }
  }
}
```

---

## ğŸ” å…¶ä»–å¯èƒ½çš„é—®é¢˜

### é—®é¢˜1ï¼šcharacter_book å­—æ®µé—®é¢˜

å¦‚æœè§’è‰²ä¹¦ä¹Ÿæ— æ³•åŠ è½½ï¼Œå¯èƒ½çš„åŸå› ï¼š

1. **character_book å­—æ®µå€¼ä¸º null**
   ```json
   "character_book": null  // âŒ é”™è¯¯
   ```
   åº”è¯¥æ”¹ä¸ºï¼š
   ```json
   "character_book": {     // âœ… æ­£ç¡®
     "name": "...",
     "entries": []
   }
   ```

2. **character_book.entries ä¸æ˜¯æ•°ç»„**
   ```json
   "entries": null  // âŒ é”™è¯¯
   ```
   åº”è¯¥æ”¹ä¸ºï¼š
   ```json
   "entries": []  // âœ… æ­£ç¡®ï¼ˆå³ä½¿æ˜¯ç©ºæ•°ç»„ï¼‰
   ```

### é—®é¢˜2ï¼šå…¶ä»–æ•°ç»„å­—æ®µ

æ£€æŸ¥ä»¥ä¸‹å­—æ®µæ˜¯å¦éƒ½æ˜¯æ•°ç»„ç±»å‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼š

- `tags`: å¿…é¡»æ˜¯æ•°ç»„ `[]`
- `alternate_greetings`: å¿…é¡»æ˜¯æ•°ç»„ `[]`
- `character_book.entries`: å¿…é¡»æ˜¯æ•°ç»„ `[]`

---

## âœ… éªŒè¯æ¸…å•

ä¿®å¤åï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] `data.tags` å­—æ®µå­˜åœ¨ä¸”æ˜¯æ•°ç»„ç±»å‹
- [ ] `data.tags` ä¸æ˜¯ `null` æˆ– `undefined`
- [ ] `data.character_book` å­˜åœ¨ï¼ˆå¦‚æœä½¿ç”¨è§’è‰²ä¹¦ï¼‰
- [ ] `data.character_book.entries` æ˜¯æ•°ç»„ç±»å‹
- [ ] JSONæ ¼å¼æœ‰æ•ˆï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
- [ ] æ–‡ä»¶ç¼–ç ä¸º UTF-8

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **æ·»åŠ  `tags` å­—æ®µ**åˆ°æ‚¨çš„è§’è‰²å¡JSON
2. **ä¿å­˜æ–‡ä»¶**ï¼ˆUTF-8ç¼–ç ï¼‰
3. **é‡æ–°å¯¼å…¥**è§’è‰²å¡åˆ° SillyTavern
4. **æ£€æŸ¥æ§åˆ¶å°**æ˜¯å¦è¿˜æœ‰é”™è¯¯

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ï¼š
- ä¿®æ”¹åçš„JSONç»“æ„ï¼ˆè‡³å°‘åŒ…å« `data` å¯¹è±¡ï¼‰
- æ–°çš„é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
