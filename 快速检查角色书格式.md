# 快速检查角色书格式

## 🔍 根据您提供的JSON分析

我已经检查了您提供的角色卡JSON，发现格式**基本正确**，但可能存在以下问题：

---

## ✅ 格式正确的部分

1. ✅ `character_book` 结构完整
2. ✅ 所有条目都有必需字段
3. ✅ `strategy` 对象格式正确
4. ✅ `position` 对象格式正确（没有多余的 `role` 和 `depth`）
5. ✅ `recursion` 和 `effect` 对象格式正确

---

## ⚠️ 可能的问题

### 问题1：content 字段中的特殊字符

**检查**：您的 `content` 字段中可能包含未转义的换行符或特殊字符。

**解决方案**：
- 确保所有换行符使用 `\n` 转义
- 确保所有引号使用 `\"` 转义
- 确保没有控制字符

### 问题2：JSON文件编码

**检查**：文件必须使用 UTF-8 编码保存。

**解决方案**：
- 使用支持UTF-8的编辑器（如VS Code、Notepad++）
- 确保保存时选择 UTF-8 编码

### 问题3：SillyTavern版本

**检查**：确保使用 SillyTavern 1.15.0 或更高版本。

---

## 🛠️ 立即检查步骤

### 步骤1：验证JSON格式

将您的JSON保存为文件（如 `character_card.json`），然后运行：

```bash
python 检查角色书格式.py character_card.json
```

或者使用在线JSON验证器：
- https://jsonlint.com/
- https://jsonformatter.org/

### 步骤2：检查SillyTavern控制台

1. 打开 SillyTavern
2. 按 F12 打开浏览器开发者工具
3. 切换到 Console 标签页
4. 尝试导入角色卡
5. 查看是否有错误信息

### 步骤3：检查常见错误

常见的错误信息包括：

- `"Invalid character book format"` - 格式错误
- `"Missing required field"` - 缺少必需字段
- `"Invalid entry format"` - 条目格式错误
- `"JSON parse error"` - JSON解析错误

---

## 🔧 快速修复建议

### 修复1：确保JSON有效

```bash
# 使用Python验证
python -c "import json; json.load(open('character_card.json', 'r', encoding='utf-8'))"
```

如果没有错误，说明JSON格式正确。

### 修复2：检查文件大小

如果角色书太大，可能导致加载失败：
- 检查文件大小
- 如果超过几MB，考虑减少内容

### 修复3：简化测试

创建一个最小化的角色书测试：

```json
{
  "spec": "chara_card_v2",
  "spec_version": "2.0",
  "data": {
    "name": "测试",
    "character_book": {
      "name": "测试",
      "entries": [
        {
          "uid": 0,
          "name": "测试",
          "enabled": true,
          "strategy": {
            "type": "constant",
            "keys": [],
            "keys_secondary": {"logic": "and_any", "keys": []},
            "scan_depth": "same_as_global"
          },
          "position": {
            "type": "after_character_definition",
            "order": 100
          },
          "content": "测试",
          "probability": 100,
          "recursion": {
            "prevent_incoming": false,
            "prevent_outgoing": false,
            "delay_until": null
          },
          "effect": {
            "sticky": null,
            "cooldown": null,
            "delay": null
          }
        }
      ]
    }
  }
}
```

如果这个能加载，说明格式没问题，可能是内容问题。

---

## 📋 需要您提供的信息

为了更准确地诊断问题，请提供：

1. **SillyTavern版本**：您使用的版本号
2. **错误信息**：控制台中的具体错误信息
3. **文件大小**：角色卡JSON文件的大小
4. **导入方式**：是通过文件导入还是复制粘贴？

---

## 💡 最可能的原因

根据经验，角色书无法加载最常见的原因是：

1. **JSON格式错误**（30%）
   - 未转义的字符
   - 尾随逗号
   - 无效的字符编码

2. **SillyTavern版本不匹配**（20%）
   - 使用旧版本
   - 格式要求不同

3. **文件过大**（20%）
   - 内容太多
   - token_budget 设置不合理

4. **特殊字符问题**（15%）
   - content 字段中的特殊字符
   - 未转义的引号或换行符

5. **其他问题**（15%）
   - 权限问题
   - 文件路径问题
   - 浏览器缓存问题

---

## 🎯 下一步行动

1. **运行检查脚本**：使用我创建的 `检查角色书格式.py` 脚本
2. **查看控制台**：检查 SillyTavern 控制台中的错误信息
3. **提供错误信息**：如果可能，请提供具体的错误信息，我可以更准确地帮助您

---

## 📝 检查脚本使用方法

```bash
# 基本用法
python 检查角色书格式.py character_card.json

# 脚本会检查：
# - JSON格式是否正确
# - 所有必需字段是否存在
# - 字段类型是否正确
# - 数值范围是否合理
# - 对象结构是否符合标准
```

脚本会输出详细的检查结果，包括：
- ✅ 通过的检查项
- ❌ 严重错误（必须修复）
- ⚠️ 警告（建议修复）
