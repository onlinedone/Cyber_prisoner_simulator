<template>
  <div class="status-card">
    <div class="overlay" @click="closePanel"></div>
    <div class="status-card-content">
      <div class="header">
        <h2>ğŸ“‹ åœ¨æŠ¼äººå‘˜çŠ¶æ€</h2>
        <div class="header-actions">
          <div class="round-info">
            <span class="round-label">ç¬¬</span>
            <span class="round-number">{{ store.data.å›åˆ.å½“å‰å›åˆ }}</span>
            <span class="round-label">å›åˆ</span>
          </div>
          <button class="close-btn" @click="closePanel" title="å…³é—­">Ã—</button>
        </div>
      </div>

      <div class="content">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="section">
          <h3 class="section-title">åŸºæœ¬ä¿¡æ¯</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">å§“å:</span>
              <span class="value">{{ store.data.çŠ¶æ€.å§“å }}</span>
            </div>
            <div class="info-item">
              <span class="label">å¹´é¾„:</span>
              <span class="value">{{ store.data.çŠ¶æ€.å¹´é¾„ }}å²</span>
            </div>
            <div class="info-item">
              <span class="label">ç½ªå:</span>
              <span class="value">{{ store.data.çŠ¶æ€.ç½ªå }}</span>
            </div>
            <div class="info-item">
              <span class="label">åœ¨æŠ¼å¤©æ•°:</span>
              <span class="value">{{ store.data.çŠ¶æ€.åœ¨æŠ¼å¤©æ•° }}å¤©</span>
            </div>
            <div class="info-item">
              <span class="label">å½“å‰é˜¶æ®µ:</span>
              <span class="value">{{ store.data.çŠ¶æ€.å½“å‰é˜¶æ®µ }}</span>
            </div>
            <div class="info-item">
              <span class="label">ç›‘å®¤ç±»å‹:</span>
              <span class="value">{{ store.data.çŠ¶æ€.ç›‘å®¤ç±»å‹ }}</span>
            </div>
          </div>
        </div>

        <!-- æ ¸å¿ƒçŠ¶æ€ -->
        <div class="section">
          <h3 class="section-title">æ ¸å¿ƒçŠ¶æ€</h3>
          <div class="stat-bars">
            <StatBar label="å¥åº·" :value="store.data.çŠ¶æ€.å¥åº·" color="#f5576c" />
            <StatBar label="ç²¾ç¥" :value="store.data.çŠ¶æ€.ç²¾ç¥" color="#00f2fe" />
            <StatBar label="åŠ›é‡" :value="store.data.çŠ¶æ€.åŠ›é‡" color="#38f9d7" />
            <StatBar label="æ™ºåŠ›" :value="store.data.çŠ¶æ€.æ™ºåŠ›" color="#fee140" />
          </div>
        </div>

        <!-- å¤–è²Œä¿¡æ¯ -->
        <div class="section">
          <h3 class="section-title">å¤–è²Œä¿¡æ¯</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">èº«é«˜:</span>
              <span class="value">{{ store.data.å¤–è²Œ.èº«é«˜ }}cm</span>
            </div>
            <div class="info-item">
              <span class="label">ä½“é‡:</span>
              <span class="value">{{ store.data.å¤–è²Œ.ä½“é‡ }}kg</span>
            </div>
            <div class="info-item">
              <span class="label">å‘å‹:</span>
              <span class="value">{{ store.data.å¤–è²Œ.å‘å‹ }}</span>
            </div>
            <div class="info-item full-width">
              <span class="label">èº«ä½“çŠ¶å†µ:</span>
              <span class="value">{{ store.data.å¤–è²Œ.èº«ä½“çŠ¶å†µ }}</span>
            </div>
          </div>
        </div>

        <!-- ç©¿ç€ä¿¡æ¯ -->
        <div class="section">
          <h3 class="section-title">ç©¿ç€ä¿¡æ¯</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">ä¸Šè¡£:</span>
              <span class="value" :data-clothing-top="store.data.ç©¿ç€.ä¸Šè¡£">{{ store.data.ç©¿ç€.ä¸Šè¡£ }}</span>
            </div>
            <div class="info-item">
              <span class="label">è£¤å­:</span>
              <span class="value" :data-clothing-bottom="store.data.ç©¿ç€.è£¤å­">{{ store.data.ç©¿ç€.è£¤å­ }}</span>
            </div>
            <div class="info-item">
              <span class="label">å†…è¡£:</span>
              <span class="value">{{ store.data.ç©¿ç€.å†…è¡£ }}</span>
            </div>
            <div class="info-item">
              <span class="label">å†…è£¤:</span>
              <span class="value">{{ store.data.ç©¿ç€.å†…è£¤ }}</span>
            </div>
            <div class="info-item">
              <span class="label">è¢œå­:</span>
              <span class="value">{{ store.data.ç©¿ç€.è¢œå­ }}</span>
            </div>
            <div class="info-item">
              <span class="label">é‹å­:</span>
              <span class="value">{{ store.data.ç©¿ç€.é‹å­ }}</span>
            </div>
            <div class="info-item">
              <span class="label">æˆ’å…·:</span>
              <span class="value">{{ store.data.ç©¿ç€.æˆ’å…· }}</span>
            </div>
            <div class="info-item">
              <span class="label">æ´å‡€åº¦:</span>
              <span class="value">{{ store.data.ç©¿ç€.æ´å‡€åº¦ }}</span>
            </div>
          </div>
        </div>

        <!-- å¿ƒç†çŠ¶æ€ -->
        <div class="section">
          <h3 class="section-title">å¿ƒç†çŠ¶æ€</h3>
          <div class="info-grid">
            <div class="info-item full-width">
              <span class="label">å½“å‰ä»»åŠ¡:</span>
              <span class="value">{{ store.data.å¿ƒç†.å½“å‰ä»»åŠ¡ }}</span>
            </div>
            <div class="info-item full-width">
              <span class="label">å†…å¿ƒæƒ³æ³•:</span>
              <span class="value">{{ store.data.å¿ƒç†.å†…å¿ƒæƒ³æ³• }}</span>
            </div>
            <div class="info-item full-width">
              <span class="label">æœ€å¤§æ‹…å¿§:</span>
              <span class="value">{{ store.data.å¿ƒç†.æœ€å¤§æ‹…å¿§ }}</span>
            </div>
          </div>
        </div>

        <!-- å›åˆæ§åˆ¶ -->
        <div class="section">
          <h3 class="section-title">å™äº‹èŠ‚å¥</h3>
          <div class="pace-control">
            <div class="pace-info">
              <span class="pace-label">å½“å‰èŠ‚å¥:</span>
              <span class="pace-value">{{ store.data.å›åˆ.å™äº‹èŠ‚å¥ }}</span>
              <span class="pace-detail">(æ¯æ¬¡æ¨è¿›{{ store.data.å›åˆ.èŠ‚å¥å€æ•° }}å¤©)</span>
            </div>
            <div class="pace-buttons">
              <button
                class="pace-btn"
                :class="{ active: store.data.å›åˆ.å™äº‹èŠ‚å¥ === 'æ…¢é€Ÿ' }"
                @click="setPace('æ…¢é€Ÿ', 0.25)"
              >
                æ…¢é€Ÿ (1/4å¤©)
              </button>
              <button
                class="pace-btn"
                :class="{ active: store.data.å›åˆ.å™äº‹èŠ‚å¥ === 'æ­£å¸¸' }"
                @click="setPace('æ­£å¸¸', 0.5)"
              >
                æ­£å¸¸ (åŠå¤©)
              </button>
              <button
                class="pace-btn"
                :class="{ active: store.data.å›åˆ.å™äº‹èŠ‚å¥ === 'å¿«é€Ÿ' }"
                @click="setPace('å¿«é€Ÿ', 1.0)"
              >
                å¿«é€Ÿ (1å¤©)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, watch } from 'vue';
import StatBar from './components/StatBar.vue';
import { useDataStore } from './store';

const store = useDataStore();

function setPace(pace: 'æ…¢é€Ÿ' | 'æ­£å¸¸' | 'å¿«é€Ÿ', multiplier: number) {
  store.data.å›åˆ.å™äº‹èŠ‚å¥ = pace;
  store.data.å›åˆ.èŠ‚å¥å€æ•° = multiplier;

  // åŒæ­¥åˆ°äº‹ä»¶ç³»ç»Ÿ
  const DS = window.detentionSystem;
  if (DS && DS.setPaceMultiplier) {
    DS.setPaceMultiplier(multiplier);
  }
}

function closePanel() {
  const appElement = document.getElementById('status-panel-app');
  if (appElement) {
    appElement.style.display = 'none';
  }
}

// ç›‘å¬storeå˜åŒ–ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
watch(
  () => store.data,
  () => {
    // #region agent log
    fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        location: 'App.vue:206',
        message: 'store.dataå˜åŒ–',
        data: {
          ä¸Šè¡£: store.data.ç©¿ç€.ä¸Šè¡£,
          è£¤å­: store.data.ç©¿ç€.è£¤å­,
          ä¸Šè¡£é•¿åº¦: store.data.ç©¿ç€.ä¸Šè¡£.length,
          è£¤å­é•¿åº¦: store.data.ç©¿ç€.è£¤å­.length,
        },
        timestamp: Date.now(),
        sessionId: 'debug-session',
        runId: 'run1',
        hypothesisId: 'C',
      }),
    }).catch(() => {});
    // #endregion
    // æ•°æ®æ›´æ–°æ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°ä¿¡æ¯
  },
  { deep: true },
);

onMounted(() => {
  // store ä¼šè‡ªåŠ¨ä»é…’é¦†å˜é‡åŒæ­¥ï¼ˆé€šè¿‡ defineMvuDataStore çš„ useIntervalFnï¼‰
  // è¿™é‡Œåªéœ€è¦ç¡®ä¿åˆå§‹åŒæ­¥å³å¯ï¼Œåç»­çš„åŒæ­¥ç”± index.ts ä¸­çš„ syncStatusToStore() å’Œäº‹ä»¶ç›‘å¬å¤„ç†
  // #region agent log
  fetch('http://127.0.0.1:7242/ingest/55a7313b-5b61-43ef-bdc3-1a322b93db66', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      location: 'App.vue:234',
      message: 'App.vue onMountedå®Œæˆ',
      data: { timestamp: Date.now() },
      timestamp: Date.now(),
      sessionId: 'debug-session',
      runId: 'run1',
      hypothesisId: 'D',
    }),
  }).catch(() => {});
  // #endregion
});
</script>

<style lang="scss" scoped>
.status-card {
  position: relative;
  width: 100%;
  max-width: 800px;
  max-height: 90vh;
  font-family: var(--font-archive);
  color: #333;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: -1;
  backdrop-filter: blur(4px);
}

.status-card-content {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.header {
  background: rgba(0, 0, 0, 0.2);
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);

  h2 {
    margin: 0;
    color: #fff;
    font-size: 18px;
    font-weight: 600;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .round-info {
    display: flex;
    align-items: center;
    gap: 4px;
    background: rgba(255, 255, 255, 0.2);
    padding: 6px 12px;
    border-radius: 8px;

    .round-label {
      color: #fff;
      font-size: 12px;
    }

    .round-number {
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      margin: 0 2px;
    }
  }

  .close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: #fff;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;

    &:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
  }
}

.content {
  max-height: calc(90vh - 80px);
  overflow-y: auto;
  padding: 16px;
  background: rgba(255, 255, 255, 0.95);
}

.section {
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

  &:last-child {
    margin-bottom: 0;
  }
}

.section-title {
  margin: 0 0 12px 0;
  color: #667eea;
  font-size: 14px;
  font-weight: 600;
  border-bottom: 2px solid #667eea;
  padding-bottom: 6px;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;

  .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);

    &:last-child {
      border-bottom: none;
    }

    &.full-width {
      grid-column: 1 / -1;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .label {
      color: #666;
      font-size: 13px;
      font-weight: 500;
    }

    .value {
      color: #333;
      font-size: 13px;
      font-weight: 600;
      text-align: right;
    }
  }
}

.stat-bars {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.pace-control {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.pace-info {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 6px;

  .pace-label {
    color: #666;
    font-size: 13px;
  }

  .pace-value {
    color: #667eea;
    font-size: 14px;
    font-weight: 600;
  }

  .pace-detail {
    color: #999;
    font-size: 12px;
  }
}

.pace-buttons {
  display: flex;
  gap: 8px;
}

.pace-btn {
  flex: 1;
  padding: 8px 12px;
  border: 2px solid #667eea;
  background: #fff;
  color: #667eea;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  transition: all 0.3s;

  &:hover {
    background: rgba(102, 126, 234, 0.1);
  }

  &.active {
    background: #667eea;
    color: #fff;
  }
}

.content::-webkit-scrollbar {
  width: 6px;
}

.content::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.1);
  border-radius: 3px;
}

.content::-webkit-scrollbar-thumb {
  background: rgba(102, 126, 234, 0.3);
  border-radius: 3px;
}

.content::-webkit-scrollbar-thumb:hover {
  background: rgba(102, 126, 234, 0.5);
}
</style>
