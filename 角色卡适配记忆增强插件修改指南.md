# 角色卡适配记忆增强插件修改指南

## 概述

根据代码分析，您的脚本已经集成了记忆增强插件的检测逻辑。现在需要修改角色卡，让AI知道如何使用记忆增强插件，并在系统提示中显示插件状态。

## 修改位置

需要修改两个主要部分：
1. **system_prompt** - 添加记忆增强插件的说明
2. **post_history_prompt** - 添加记忆增强插件的检测和使用逻辑

---

## 修改 1：system_prompt 部分

### 位置：在"外置脚本调用规范"章节之后添加新章节

在 `system_prompt` 的"外置脚本调用规范"章节（第62行）之后，添加以下内容：

```markdown
## 记忆增强插件集成 ⭐新增v3.5.6⭐

### 插件检测机制
系统会优先从记忆增强插件获取状态信息，如果插件不可用，则回退到状态栏模块。

### 检测逻辑
```javascript
// 检查记忆增强插件是否可用
const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
const extensionSettings = SillyTavern?.extensionSettings;
const memoryPluginSettings = extensionSettings?.['memory-enhancement'] || extensionSettings?.['MemoryEnhancement'];

// 如果插件可用，优先使用插件获取状态
if (memoryEnhancement && typeof memoryEnhancement.getState === 'function') {
  const memoryState = memoryEnhancement.getState();
  // 使用 memoryState.health, memoryState.mental 等
}
```

### 状态获取优先级
1. **记忆增强插件**（最高优先级）- 如果插件可用且有 `getState()` 方法
2. **状态栏模块**（次优先级）- 如果状态栏模块已加载
3. **聊天记录解析**（降级方案）- 从最近消息中解析状态信息
4. **默认值**（最后方案）- 使用预设的默认状态值

### 状态字段说明
记忆增强插件可能提供以下状态字段：
- `health`: 健康值 (0-100)
- `mental`: 精神值 (0-100)
- `strength`: 力量值 (0-100)
- `intelligence`: 智力值 (0-100)

### AI行为要求
1. **状态同步**：优先使用记忆增强插件提供的状态信息
2. **状态更新**：继续使用 `<!--STATUS_UPDATE:...-->` 格式更新状态
3. **兼容性**：确保在插件不可用时能正常回退到状态栏模块
4. **状态显示**：在系统提示中显示记忆增强插件的状态（可用/不可用）

### 系统提示格式更新
在系统提示的"模块加载状态"部分，添加记忆增强插件状态：

```
━━━━━━━━━━━━━━━━━━━━━━
模块加载状态:
  核心系统: ✅/❌
  事件系统: ✅/❌
  状态栏: ✅/❌
  NPC系统: ✅/❌
  知识库加载器: ✅/❌
  记忆增强插件: ✅/❌  ⭐新增⭐

运行模式: [外置脚本(完整功能)/外置脚本(部分功能)/降级模式(基础功能)]
缺失模块: [如有缺失，列出模块名称]
━━━━━━━━━━━━━━━━━━━━━━
```

---

## 修改 2：post_history_prompt 部分

### 位置：在"1. 脚本状态检查"章节中添加记忆增强插件检测

在 `post_history_prompt` 的"1. 脚本状态检查"章节中，在检测逻辑之后添加：

```javascript
// 检测记忆增强插件
let 记忆增强插件状态 = false;
let 记忆增强插件信息 = null;

try {
  const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
  const extensionSettings = typeof SillyTavern !== 'undefined' ? SillyTavern.extensionSettings : null;
  const memoryPluginSettings = extensionSettings?.['memory-enhancement'] || extensionSettings?.['MemoryEnhancement'];

  if (memoryEnhancement && typeof memoryEnhancement.getState === 'function') {
    记忆增强插件状态 = true;
    记忆增强插件信息 = {
      available: true,
      hasGetState: true,
      hasSettings: !!memoryPluginSettings
    };
  } else {
    记忆增强插件信息 = {
      available: false,
      hasGetState: false,
      hasSettings: !!memoryPluginSettings
    };
  }
} catch (error) {
  记忆增强插件信息 = {
    available: false,
    error: error instanceof Error ? error.message : String(error)
  };
}
```

### 位置：在"2. 状态同步"章节中修改状态获取逻辑

将原来的状态同步代码替换为：

```javascript
// 根据模块状态使用相应功能
if (DS && 运行模式 !== '降级模式(基础功能)') {
  // 优先尝试从记忆增强插件获取状态
  let stateFromMemory = null;

  if (记忆增强插件状态) {
    try {
      const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
      const memoryState = memoryEnhancement.getState();
      if (memoryState && (memoryState.health !== undefined || memoryState.mental !== undefined)) {
        stateFromMemory = {
          health: memoryState.health ?? 50,
          mental: memoryState.mental ?? 50,
          strength: memoryState.strength ?? 50,
          intelligence: memoryState.intelligence ?? 50,
          source: 'memoryEnhancement'
        };
      }
    } catch (error) {
      console.warn('从记忆增强插件获取状态失败:', error);
    }
  }

  // 如果记忆增强插件未提供状态，使用状态栏模块
  if (!stateFromMemory && 模块状态.statusPanel) {
    const state = DS.getState();
    const stageInfo = DS.getCurrentStage();
    const trend = DS.getTrendAnalysis();
  } else if (!stateFromMemory) {
    // 状态栏模块不可用，使用内置简化状态
    console.warn('状态栏模块未加载，使用内置简化状态');
  }

  // 事件系统模块可用时
  if (模块状态.eventSystem) {
    const currentDay = DS.getCurrentDay?.() || 0;
    const eventResult = DS.advanceDay?.(0) || null;
  } else {
    // 事件系统模块不可用，使用内置简化事件
    console.warn('事件系统模块未加载，使用内置简化事件');
  }

  // NPC系统模块可用时
  if (模块状态.npcSystem) {
    const npcs = DS.generateNPC?.(1) || [];
  } else {
    // NPC系统模块不可用，使用内置简化NPC
    console.warn('NPC系统模块未加载，使用内置简化NPC');
  }

  // 知识库加载器模块可用时
  if (模块状态.worldbook) {
    const worldbook = DS.loadWorldbook?.('detention_rules.json') || null;
  } else {
    // 知识库加载器模块不可用，使用内置知识库
    console.warn('知识库加载器模块未加载，使用内置知识库');
  }
} else {
  // 降级模式：使用内置简化功能
  console.warn('进入降级模式，使用内置简化功能');
}
```

### 位置：在"6. 状态显示"章节中更新显示格式

将系统提示格式更新为：

```
━━━━━━━━━━━━━━━━━━━━━━
模块加载状态:
  核心系统: [✅/❌]
  事件系统: [✅/❌]
  状态栏: [✅/❌]
  NPC系统: [✅/❌]
  知识库加载器: [✅/❌]
  记忆增强插件: [✅/❌]  ⭐新增⭐

运行模式: [外置脚本(完整功能)/外置脚本(部分功能)/降级模式(基础功能)]
缺失模块: [如有缺失，列出模块名称，如：事件系统(eventSystem)、状态栏(statusPanel)]
记忆增强插件状态: [可用/不可用]  ⭐新增⭐

日期信息:
  当前天数: 第X天
  在押天数: X天
  当前阶段: XXX
  监室类型: XXX

状态更新:
  健康: [趋势] (原因)
  精神: [趋势] (原因)
  状态来源: [记忆增强插件/状态栏模块/默认值]  ⭐新增⭐

事件系统:
  [如有事件触发，显示事件信息]

Token使用: XXXX/100000 (X.X%)
叙事模式: 详细描写已启用，节奏缓慢
━━━━━━━━━━━━━━━━━━━━━━
```

---

## 修改 3：角色卡 JSON 中的 description 字段

在角色卡的 `description` 字段中添加记忆增强插件支持说明：

```json
"description": "中国女子看守所智能模拟系统v3.5.6。深度集成六大外置脚本：核心系统(core.js)、事件系统(event_system.js)、状态栏(status_panel.js)、NPC生成(npc_system.js)、知识库加载(worldbook_loader.js)、系统整合(integration.js)。支持动态状态追踪、缓慢变化机制、均值回归、预测性事件触发。完全适配SillyTavern 1.15.0和酒馆助手4.3.16，支持dataTable数据表格系统。新增剧情推进限制和详细描写要求。**已适配记忆增强插件，优先使用插件状态信息。**"
```

---

## 修改 4：角色卡 JSON 中的 tags 字段

在 `tags` 数组中添加：

```json
"tags": [
  "看守所",
  "女子监区",
  "模拟器",
  "SillyTavern1.15.0",
  "外置脚本",
  "dataTable",
  "智能降级",
  "动态状态",
  "事件系统",
  "NPC生成",
  "详细描写",
  "缓慢推进",
  "HTML注释隐藏",
  "记忆增强插件"  // ⭐新增⭐
]
```

---

## 修改 5：角色卡 JSON 中的 extensions 字段

在 `extensions` 对象中添加记忆增强插件配置：

```json
"extensions": {
  "compatibility": {
    "sillytavern_version": "1.15.0",
    "release_hash": "ce71ca509",
    "helper_version": "4.3.16",
    "tested": true,
    "optimized": true,
    "last_test_date": "2025-03-26"
  },
  "external_script": {
    // ... 原有配置 ...
  },
  "datatable_config": {
    // ... 原有配置 ...
  },
  "memory_enhancement": {  // ⭐新增⭐
    "enabled": true,
    "priority": "highest",
    "fallback_to_status_panel": true,
    "state_fields": [
      "health",
      "mental",
      "strength",
      "intelligence"
    ],
    "detection_methods": [
      "window.MemoryEnhancement",
      "window.memoryEnhancement",
      "extensionSettings['memory-enhancement']",
      "extensionSettings['MemoryEnhancement']"
    ]
  }
}
```

---

## 完整修改清单

### system_prompt 修改
- [ ] 在"外置脚本调用规范"章节后添加"记忆增强插件集成"章节
- [ ] 更新系统提示格式，添加记忆增强插件状态显示

### post_history_prompt 修改
- [ ] 在"1. 脚本状态检查"中添加记忆增强插件检测代码
- [ ] 在"2. 状态同步"中修改状态获取逻辑，优先使用记忆增强插件
- [ ] 在"6. 状态显示"中更新显示格式，添加插件状态信息

### 角色卡 JSON 修改
- [ ] 更新 `description` 字段，添加记忆增强插件支持说明
- [ ] 更新 `tags` 数组，添加"记忆增强插件"标签
- [ ] 更新 `extensions` 对象，添加 `memory_enhancement` 配置

---

## 验证步骤

修改完成后，请验证：

1. **插件检测**：在浏览器控制台检查 `window.MemoryEnhancement` 是否存在
2. **状态获取**：确认系统能正确从记忆增强插件获取状态
3. **回退机制**：确认在插件不可用时能正确回退到状态栏模块
4. **系统提示**：确认系统提示中正确显示记忆增强插件状态
5. **状态更新**：确认 `<!--STATUS_UPDATE:...-->` 格式仍然正常工作

---

## 注意事项

1. **兼容性**：确保修改后的角色卡在记忆增强插件不可用时仍能正常工作
2. **优先级**：记忆增强插件 > 状态栏模块 > 聊天记录解析 > 默认值
3. **错误处理**：所有记忆增强插件相关操作都应包含 try-catch 错误处理
4. **状态同步**：继续使用 `<!--STATUS_UPDATE:...-->` 格式更新状态，插件会自动读取
5. **版本号**：建议将版本号更新为 v3.5.6，以反映记忆增强插件支持

---

## 快速修改模板

如果您需要快速修改，可以使用以下模板：

### system_prompt 添加内容（在第62行之后）

```markdown
## 记忆增强插件集成 ⭐新增v3.5.6⭐

### 插件检测机制
系统会优先从记忆增强插件获取状态信息，如果插件不可用，则回退到状态栏模块。

### 状态获取优先级
1. **记忆增强插件**（最高优先级）
2. **状态栏模块**（次优先级）
3. **聊天记录解析**（降级方案）
4. **默认值**（最后方案）

### AI行为要求
- 优先使用记忆增强插件提供的状态信息
- 继续使用 `<!--STATUS_UPDATE:...-->` 格式更新状态
- 在系统提示中显示记忆增强插件的状态（可用/不可用）
```

### post_history_prompt 添加内容（在第1节之后）

```javascript
// 检测记忆增强插件
let 记忆增强插件状态 = false;
try {
  const memoryEnhancement = window.MemoryEnhancement || window.memoryEnhancement;
  if (memoryEnhancement && typeof memoryEnhancement.getState === 'function') {
    记忆增强插件状态 = true;
  }
} catch (error) {}
```

---

## 总结

主要修改点：
1. ✅ 在 system_prompt 中添加记忆增强插件说明
2. ✅ 在 post_history_prompt 中添加插件检测和状态获取逻辑
3. ✅ 更新系统提示格式，显示插件状态
4. ✅ 更新角色卡 JSON 的 description、tags 和 extensions 字段

这些修改将确保角色卡能够：
- 正确检测记忆增强插件
- 优先使用插件提供的状态信息
- 在插件不可用时正确回退
- 在系统提示中清晰显示插件状态
