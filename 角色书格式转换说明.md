# 角色书格式转换说明

## 概述

本指南说明如何将旧格式的角色书（character_book）转换为 Tavern 1.15.0 标准格式。

## 格式差异

### 旧格式（简化格式）

```json
{
    "character_book": {
        "name": "看守所系统v3.5.6-降级模块",
        "entries": [
            {
                "keys": ["系统状态", "脚本检测"],
                "content": "...",
                "enabled": true,
                "insertion_order": 100,
                "case_sensitive": false,
                "name": "系统状态",
                "priority": 100,
                "constant": true,
                "position": "after_char"
            }
        ]
    }
}
```

### 新格式（Tavern 1.15.0 标准格式）

```json
{
    "character_book": {
        "name": "看守所系统v3.5.6-降级模块",
        "entries": [
            {
                "uid": 0,
                "name": "系统状态",
                "enabled": true,
                "strategy": {
                    "type": "constant",
                    "keys": ["系统状态", "脚本检测"],
                    "keys_secondary": {
                        "logic": "and_any",
                        "keys": []
                    },
                    "scan_depth": "same_as_global"
                },
                "position": {
                    "type": "after_character_definition",
                    "order": 100
                },
                "content": "...",
                "probability": 100,
                "recursion": {
                    "prevent_incoming": false,
                    "prevent_outgoing": false,
                    "delay_until": null
                },
                "effect": {
                    "sticky": null,
                    "cooldown": null,
                    "delay": null
                }
            }
        ]
    }
}
```

## 主要转换规则

### 1. 条目ID

- **旧格式**: 无 `id` 字段（或使用 `id`）
- **新格式**: 使用 `uid`，从 0 开始递增

### 2. 激活策略（strategy）

- **旧格式**: `constant` 布尔值 + 顶层 `keys` 数组
- **新格式**: `strategy` 对象，包含：
  - `type`: `"constant"` 或 `"selective"`（根据 `constant` 字段）
  - `keys`: 从顶层 `keys` 移入
  - `keys_secondary`: 默认值 `{ logic: "and_any", keys: [] }`
  - `scan_depth`: 默认值 `"same_as_global"`

### 3. 插入位置（position）

- **旧格式**: 字符串 `"after_char"` + `insertion_order` 数字
- **新格式**: `position` 对象，包含：
  - `type`: 转换后的位置类型（如 `"after_character_definition"`）
  - `order`: 从 `insertion_order` 移入
  - **注意**: `role` 和 `depth` 只在 `type` 为 `"at_depth"` 时需要

**位置字符串映射**:

- `"after_char"` → `"after_character_definition"`
- `"before_char"` → `"before_character_definition"`
- `"after_example"` → `"after_example_messages"`
- `"before_example"` → `"before_example_messages"`
- `"after_author"` → `"after_author_note"`
- `"before_author"` → `"before_author_note"`

### 4. 激活概率

- **旧格式**: `priority` 字段
- **新格式**: `probability` 字段（值相同，默认 100）

### 5. 递归和效果

- **旧格式**: 无
- **新格式**: 必须包含 `recursion` 和 `effect` 对象（使用默认值）

## 使用转换脚本

### 安装要求

- Python 3.6+
- 无需额外依赖（仅使用标准库）

### 使用方法

```bash
python convert_character_book.py <输入文件> <输出文件>
```

### 示例

```bash
# 转换角色书
python convert_character_book.py old_character_book.json new_character_book.json

# 如果输入文件包含完整的角色卡JSON
python convert_character_book.py character_card.json converted_character_card.json
```

### 脚本功能

1. **自动转换所有条目**: 批量处理所有 `entries` 中的条目
2. **保留扩展字段**: 保留 `extensions` 和其他顶层字段
3. **生成唯一ID**: 自动为每个条目生成 `uid`（从 0 开始）
4. **格式验证**: 确保输出符合标准格式

## 转换后的验证

转换完成后，请检查：

- [ ] 所有条目都有 `uid` 字段
- [ ] 所有条目都有 `name` 字段
- [ ] 所有条目都有完整的 `strategy` 对象
- [ ] 所有条目都有完整的 `position` 对象
- [ ] 所有条目都有 `probability` 字段
- [ ] 所有条目都有 `recursion` 和 `effect` 对象
- [ ] `position.type` 不是 `"at_depth"` 时，不包含 `role` 和 `depth` 字段

## 注意事项

### 1. position 字段的 role 和 depth

根据世界书审核报告，当 `position.type` 不是 `"at_depth"` 时，**不应该包含 `role` 和 `depth` 字段**，否则可能导致 SillyTavern 解析错误。

本脚本会自动处理这个问题，只在需要时添加这些字段。

### 2. constant 条目的 keys

即使 `constant=true`（蓝灯条目），脚本仍会保留 `keys` 数组。这是为了兼容性，如果不需要可以手动清空。

### 3. 备份原始文件

**重要**: 转换前请务必备份原始文件！

```bash
cp old_character_book.json old_character_book.json.backup
```

### 4. 测试转换结果

转换后，建议：

1. 在 SillyTavern 中导入转换后的角色卡
2. 检查世界书是否能正常加载
3. 测试条目是否能正常激活
4. 验证功能是否正常

## 常见问题

### Q: 转换后条目无法激活？

A: 检查：

1. `strategy.type` 是否正确（`constant` 或 `selective`）
2. `strategy.keys` 是否包含正确的关键词
3. `probability` 是否设置为 100（如果需要总是激活）

### Q: 位置不正确？

A: 检查：

1. `position.type` 是否正确映射
2. `position.order` 是否合理（数字越小越靠前）
3. 如果使用 `at_depth`，确保包含 `role` 和 `depth`

### Q: 转换脚本报错？

A: 检查：

1. 输入文件是否为有效的 JSON
2. 是否包含 `character_book` 字段
3. 每个条目是否包含必需的字段（至少 `name` 和 `content`）

## 手动转换示例

如果不想使用脚本，可以参考以下手动转换步骤：

1. **添加 uid**: 为每个条目添加 `uid`（从 0 开始）
2. **创建 strategy 对象**:

   ```json
   "strategy": {
       "type": "constant",  // 或 "selective"
       "keys": [...],       // 从顶层 keys 移入
       "keys_secondary": { "logic": "and_any", "keys": [] },
       "scan_depth": "same_as_global"
   }
   ```

3. **创建 position 对象**:

   ```json
   "position": {
       "type": "after_character_definition",
       "order": 100
   }
   ```

4. **重命名 priority**: `priority` → `probability`
5. **添加 recursion 和 effect**:

   ```json
   "recursion": {
       "prevent_incoming": false,
       "prevent_outgoing": false,
       "delay_until": null
   },
   "effect": {
       "sticky": null,
       "cooldown": null,
       "delay": null
   }
   ```

6. **删除旧字段**: 删除 `constant`, `insertion_order`, `case_sensitive` 等旧字段

## 总结

转换脚本会自动处理所有格式转换，您只需要：

1. 备份原始文件
2. 运行转换脚本
3. 验证转换结果
4. 在 SillyTavern 中测试

如有问题，请检查本文档的"常见问题"部分或查看脚本的错误信息。
