# 主角生成代码修复说明

## 问题分析

您提供的代码存在以下问题：

### 1. ❌ **不应自动生成主角**
- 主角生成应该由**用户通过消息触发**，而不是在加载时自动执行
- 自动生成会导致每次加载角色卡都生成新的主角，无法保留已生成的主角信息

### 2. ❌ **使用了错误的API**
- `setVariables` 不存在，应该使用 `replaceVariables`
- 正确的调用方式：`replaceVariables(variables, { type: 'chat' })`

### 3. ❌ **自动初始化日期不合适**
- 不应该自动将日期重置为0
- 应该保持当前的游戏进度

## 正确的实现方式

### 主角生成流程

主角生成已经由**外置脚本（`core.ts`）自动处理**，无需在角色卡中手动实现：

1. **用户发送消息**：用户发送包含"生成主角"、"创建主角"等关键词的消息
2. **外置脚本监听**：`core.ts` 的 `MESSAGE_SENT` 事件监听器检测到关键词
3. **自动生成主角**：调用 `DS.generateProtagonist()` 生成主角信息
4. **保存到变量**：使用 `replaceVariables()` 保存到聊天变量
5. **隐藏用户消息**：隐藏用户的生成主角指令，防止AI重复响应

### 代码位置说明

- ✅ **`system_prompt_v3.5.5.txt`**：只包含说明性文字，不包含执行代码
- ✅ **`core.ts`**：监听用户消息，自动处理主角生成（已完成）
- ✅ **角色卡初始化代码**：只检测模块和初始化状态，**不包含主角生成**

## 修复后的代码

参考文件：`导入到酒馆/正确的初始化代码.js`

### 关键修改

1. **移除主角生成代码**：
   ```javascript
   // ❌ 删除这部分
   // 生成主角信息
   let protagonist = null;
   if (DS && 模块状态.npcSystem && typeof DS.generateProtagonist === 'function') {
     protagonist = DS.generateProtagonist({...});
   }
   ```

2. **移除错误的变量保存代码**：
   ```javascript
   // ❌ 删除这部分
   if (typeof setVariables === 'function') {
     setVariables({...}, 'chat');
   }
   ```

3. **保留模块检测和状态初始化**：
   ```javascript
   // ✅ 保留这部分
   // 检测外置脚本和记忆增强插件
   // 检测各个模块
   // 初始化状态（如果记忆增强插件可用）
   ```

## 使用方法

### 如果需要自动初始化主角（不推荐）

如果您确实需要在加载时自动生成主角（例如新游戏开始），应该：

1. **在外置脚本中添加初始化逻辑**：在 `core.ts` 中添加检查逻辑
   ```typescript
   // 检查是否已有主角信息
   const protagonistName = getVariables({ type: 'chat' })?.protagonist_name;
   if (!protagonistName && DS && npcSystem) {
     // 自动生成主角
     const protagonist = DS.generateProtagonist({...});
     replaceVariables({...}, { type: 'chat' });
   }
   ```

2. **不要在角色卡中自动生成**：避免在 `system_prompt` 或角色卡的其他字段中自动生成

### 推荐的用户流程

1. 用户导入角色卡
2. 用户发送第一条消息："请为我生成一个主角，要求是高级知识分子、经济犯罪、非学术腐败"
3. 外置脚本自动检测关键词，生成主角并保存
4. AI使用生成的主角信息进行叙事

## 验证步骤

1. 检查 `core.ts` 中的主角生成逻辑是否正常工作
2. 确认 `replaceVariables` 调用是否正确
3. 测试用户发送"生成主角"消息是否能正确触发生成
4. 确认生成的主角信息是否正确保存到聊天变量

## 相关文件

- ✅ `src/赛博坐牢模拟器增强脚本/脚本/core.ts`：主角生成的主要实现（第1096-1300行）
- ✅ `src/赛博坐牢模拟器增强脚本/脚本/npc_system.ts`：`generateProtagonist` 函数实现
- ✅ `导入到酒馆/system_prompt_v3.5.5.txt`：系统提示词（已清理，只包含说明）
- ✅ `导入到酒馆/正确的初始化代码.js`：修复后的初始化代码示例
