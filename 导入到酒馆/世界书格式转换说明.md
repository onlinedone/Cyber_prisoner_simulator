# 世界书格式转换说明

## 问题诊断

`internal_basic_procedures` (生活细节库) 世界书加载失败，原因是**条目数据格式不兼容**。

### 当前格式（旧格式/简化格式）

您的条目使用的是简化格式，缺少 Tavern Helper 需要的完整结构：

```json
{
    "id": 0,
    "keys": ["入所", "搜身", ...],
    "content": "...",
    "enabled": true,
    "priority": 370,
    "comment": "入所搜身流程",
    "insertion_order": 100,
    "case_sensitive": false
}
```

### 期望格式（标准格式）

Tavern Helper 需要完整的 `WorldbookEntry` 格式：

```json
{
    "uid": 0,
    "name": "入所搜身流程",
    "enabled": true,
    "strategy": {
        "type": "selective",
        "keys": ["入所", "搜身", "入监", "刚进来"],
        "keys_secondary": {
            "logic": "and_any",
            "keys": []
        },
        "scan_depth": "same_as_global"
    },
    "position": {
        "type": "after_character_definition",
        "role": "system",
        "depth": 4,
        "order": 100
    },
    "content": "...",
    "probability": 100,
    "recursion": {
        "prevent_incoming": false,
        "prevent_outgoing": false,
        "delay_until": null
    },
    "effect": {
        "sticky": null,
        "cooldown": null,
        "delay": null
    }
}
```

## 转换方案

### 方案 1: 手动修复（推荐）

在酒馆中打开 `生活细节库` 世界书，手动修复每个条目：

1. **添加 `name` 字段**：将 `comment` 的值复制到 `name`
2. **将 `id` 改为 `uid`**
3. **创建 `strategy` 对象**：
   - `type`: 设为 `"selective"`（因为有关键词）
   - `keys`: 将顶层的 `keys` 移到这里
   - `keys_secondary`: 设为空数组
   - `scan_depth`: 设为 `"same_as_global"`
4. **创建 `position` 对象**：
   - `type`: 根据您的配置设为 `"after_character_definition"`（因为 extensions.position 是 "after_char"）
   - `role`: 设为 `"system"`
   - `depth`: 设为 `4`（根据您的配置）
   - `order`: 将 `insertion_order` 的值移到这里
5. **将 `priority` 改为 `probability`**：设为 `100`（或保持原值）
6. **添加 `recursion` 和 `effect` 对象**：使用默认值

### 方案 2: 使用脚本转换

如果您有访问世界书原始数据的能力，可以编写脚本将旧格式转换为新格式。

### 方案 3: 重新创建世界书

如果条目不多，可以考虑重新创建世界书，使用正确的格式。

## 快速修复检查清单

对于每个条目，确保：

- [ ] `uid` 字段存在（不是 `id`）
- [ ] `name` 字段存在（不是 `comment`）
- [ ] `strategy` 对象存在，包含：
  - [ ] `type`: `"selective"` 或 `"constant"`
  - [ ] `keys`: 数组形式的关键词
  - [ ] `keys_secondary`: 对象（可以空）
  - [ ] `scan_depth`: 字符串或数字
- [ ] `position` 对象存在，包含：
  - [ ] `type`: 位置类型字符串
  - [ ] `role`: `"system"`、`"user"` 或 `"assistant"`
  - [ ] `depth`: 数字
  - [ ] `order`: 数字
- [ ] `probability` 字段存在（不是 `priority`）
- [ ] `recursion` 对象存在
- [ ] `effect` 对象存在

## 注意事项

1. **备份数据**：修复前请备份世界书数据
2. **逐步测试**：修复几个条目后先测试，确认格式正确
3. **检查所有条目**：确保所有条目都符合新格式
4. **保存并重载**：修复后保存世界书，重新加载脚本测试

## 验证修复

修复后，运行测试脚本，`internal_basic_procedures` 应该能够正常加载。

## 为什么会出现这个问题？

可能是：
1. 世界书是用旧版本工具创建的
2. 从其他系统导入时格式未转换
3. 手动编辑时使用了简化格式

无论如何，现在需要将其转换为 Tavern Helper 兼容的标准格式。
