# 403 Forbidden 错误解决方案

## 问题描述

在执行世界书创建脚本时遇到 `403 Forbidden` 错误，这通常是认证或权限问题。

## 原因分析

403 错误通常由以下原因导致：

1. **CSRF token 缺失或无效**
   - SillyTavern 使用 CSRF token 防止跨站请求伪造
   - 如果 token 缺失、过期或无效，服务器会返回 403

2. **未登录或会话过期**
   - 如果未登录 SillyTavern，服务器会拒绝请求
   - 如果会话过期，需要重新登录

3. **权限不足**
   - 某些服务器可能启用了权限控制
   - 当前用户可能没有创建世界书的权限

4. **服务器认证配置**
   - 服务器可能启用了额外的认证机制
   - 可能需要特殊的请求头或认证信息

## 解决方案

### 方案 1：使用快速诊断脚本（推荐第一步）

先运行诊断脚本，检查 API 状态：

1. 在控制台执行：`导入到酒馆/快速诊断脚本.js`
2. 查看诊断结果，了解：
   - CSRF token 是否可用
   - getRequestHeaders 函数是否可用
   - API 端点是否可访问
   - 认证状态

### 方案 2：手动获取并添加 CSRF token

如果脚本无法自动获取 token，可以手动获取：

```javascript
// 1. 获取 CSRF token
const tokenResponse = await fetch('/csrf-token');
const tokenData = await tokenResponse.json();
const csrfToken = tokenData.token;
console.log('CSRF Token:', csrfToken);

// 2. 修改脚本中的 headers，添加 token
headers['X-CSRF-Token'] = csrfToken;
```

### 方案 3：使用导入 API（推荐）

导入 API 使用文件上传方式，可能更容易通过认证：

1. 使用脚本：`导入到酒馆/使用导入API创建世界书.js`
2. 这个脚本使用 `/api/worldinfo/import` 端点
3. 使用 FormData 上传文件，可能不需要额外的认证

### 方案 4：手动在酒馆中导入（最可靠）

如果所有 API 方法都失败，可以手动导入：

1. **在酒馆中打开世界书管理器**
   - 点击侧边栏的"世界书"或"World Info"按钮
   - 或者使用快捷键（如果配置了）

2. **导入世界书**
   - 点击"导入"或"Import"按钮
   - 选择 `internal_basic_procedures.json` 文件
   - 等待导入完成

3. **验证导入结果**
   - 检查世界书是否出现在列表中
   - 打开世界书，确认条目是否正确

4. **重命名世界书（如果需要）**
   - 如果导入后的名称不是 "生活细节库"
   - 在世界书管理器中重命名为 "生活细节库"

### 方案 5：直接修改服务器文件（高级用户）

如果以上方法都失败，可以直接修改服务器上的文件：

1. **找到世界书存储目录**
   - 通常在 `SillyTavern-release/data/worlds/` 目录下
   - 或根据服务器配置的 `worlds` 目录

2. **转换 JSON 格式**
   - 将 `entries` 数组转换为对象格式：
   ```javascript
   // 转换代码
   const jsonData = require('./internal_basic_procedures.json');
   const entriesObject = {};
   for (const entry of jsonData.entries) {
     entriesObject[entry.uid] = entry;
   }
   const worldbookData = {
     entries: entriesObject,
     extensions: jsonData.extensions,
     description: jsonData.description,
   };
   // 保存为 internal_basic_procedures.json
   ```

3. **复制文件到服务器**
   - 将转换后的 JSON 文件复制到 `worlds` 目录
   - 文件名应该是：`internal_basic_procedures.json` 或 `生活细节库.json`
   - 确保文件名与 JSON 中的 `name` 字段匹配

4. **重启服务器（如果需要）**
   - 某些配置可能需要重启服务器
   - 刷新浏览器页面

## 调试步骤

### 步骤 1: 检查网络请求

1. 打开浏览器开发者工具
2. 切换到 **Network（网络）** 标签
3. 执行脚本
4. 查找对 `/api/worldinfo/edit` 的请求
5. 查看：
   - **请求头（Request Headers）**：检查是否包含 `X-CSRF-Token`
   - **状态码（Status Code）**：确认是否为 403
   - **响应（Response）**：查看服务器返回的错误信息

### 步骤 2: 检查 CSRF token

在控制台执行：

```javascript
// 尝试获取 CSRF token
fetch('/csrf-token')
  .then(r => r.json())
  .then(d => {
    console.log('CSRF Token:', d.token);
    console.log('Token 长度:', d.token?.length);
  })
  .catch(e => console.error('获取失败:', e));
```

如果返回错误或 `undefined`，说明：
- 服务器可能未启用认证（应该可以正常使用 API）
- 或者服务器配置有问题

### 步骤 3: 检查认证状态

在控制台执行：

```javascript
// 检查 getRequestHeaders 函数
if (typeof getRequestHeaders === 'function') {
  const headers = getRequestHeaders();
  console.log('请求头:', headers);
  console.log('CSRF Token:', headers['X-CSRF-Token'] || headers['x-csrf-token']);
} else {
  console.log('getRequestHeaders 函数不可用');
}
```

### 步骤 4: 测试 API 端点

在控制台执行：

```javascript
// 测试 /api/worldinfo/list
fetch('/api/worldinfo/list', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    // 如果有 token，添加: 'X-CSRF-Token': token
  },
  body: JSON.stringify({}),
})
.then(r => {
  console.log('状态码:', r.status);
  return r.json();
})
.then(d => console.log('世界书列表:', d))
.catch(e => console.error('请求失败:', e));
```

如果这个请求也返回 403，说明认证问题更普遍。

## 常见问题

### Q1: 刷新页面后仍然 403？

**A:** 
1. 检查是否真正登录了
2. 检查浏览器 Cookie 是否被清除
3. 尝试重新登录
4. 检查服务器日志，查看具体错误

### Q2: CSRF token 获取成功但仍然 403？

**A:** 
1. 检查 token 是否正确添加到请求头
2. 检查请求头格式是否正确（大小写敏感）
3. 检查服务器是否接受该 token
4. 尝试重新获取 token 后立即使用

### Q3: 所有 API 都返回 403？

**A:** 
1. 可能是服务器启用了严格的认证策略
2. 检查服务器配置，确认认证要求
3. 考虑使用手动导入方式
4. 或者直接修改服务器文件（如果有权限）

### Q4: 使用导入 API 也失败？

**A:** 
1. 检查文件格式是否正确
2. 检查文件大小是否超出限制
3. 尝试手动在酒馆中导入（最可靠的方法）
4. 或者使用方案 5：直接修改服务器文件

## 最佳实践

1. **优先使用诊断脚本**：先了解问题，再选择解决方案
2. **尝试备用方案**：如果一个方法失败，尝试其他方法
3. **手动导入最可靠**：如果所有自动方法都失败，手动导入是最可靠的方式
4. **检查服务器日志**：如果有权限，查看服务器日志了解详细错误

## 总结

遇到 403 错误时：

1. ✅ **先运行诊断脚本**，了解问题
2. ✅ **尝试使用导入 API**（可能更容易通过认证）
3. ✅ **如果都失败，手动导入**（最可靠）
4. ✅ **最后选择直接修改服务器文件**（需要权限）
