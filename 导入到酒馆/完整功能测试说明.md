# 完整功能测试脚本使用说明

## 概述

`完整功能测试脚本.js` 是一个全面的测试工具，用于验证赛博坐牢模拟器增强脚本的以下功能：

1. **世界书调取** - 测试加载不同的知识库
2. **预测性加载** - 测试基于上下文的智能预测加载
3. **回合推进** - 测试时间推进机制
4. **事件打断推进** - 测试高优先级事件是否打断回合推进
5. **监室转移** - 测试监室转移机制和NPC重新生成

## 使用方法

### 步骤 1: 确保系统已加载

1. 确保 `pnpm watch` 正在运行（如果使用实时监听）
2. 确保 HTTP 服务器正在运行（如 `python cors_server.py`）
3. 在酒馆中加载脚本

### 步骤 2: 运行测试

1. 在酒馆网页中按 `F12` 打开开发者工具
2. 切换到 `Console`（控制台）标签
3. 复制 `完整功能测试脚本.js` 的全部内容
4. 粘贴到控制台并按 `Enter` 执行

### 步骤 3: 查看结果

测试脚本会自动执行所有测试，并在控制台输出详细的测试结果。

## 测试内容详解

### 1. 世界书调取测试

- **测试内容**: 加载以下世界书
  - 核心规则库 (`detention_rules`)
  - 生活细节库 (`internal_basic_procedures`)
  - 法律细节库 (`internal_basic_legal`)
  - 环境描写库 (`environment_descriptions`)
- **验证点**:
  - 世界书是否能成功加载
  - 返回结果格式是否正确
  - 世界书状态是否正确更新
  - 加载耗时是否合理

### 2. 预测性加载测试

- **测试内容**: 使用不同的上下文触发预测性加载
  - 包含审讯和会见关键词的上下文
  - 包含监规关键词的上下文
  - 包含日常生活关键词的上下文
  - 包含法律流程关键词的上下文
- **验证点**:
  - 是否能根据上下文识别关键词
  - 是否能触发相应的世界书加载
  - 加载的世界书是否与上下文相关

### 3. 回合推进测试

- **测试内容**: 推进多个回合，观察时间推进
- **验证点**:
  - 回合数是否正确递增
  - 天数是否按节奏倍数推进
  - 回合推进是否正常工作
  - 是否有事件被触发

### 4. 事件打断推进测试

- **测试内容**: 推进多个回合，观察高优先级事件是否打断推进
- **验证点**:
  - 高优先级事件是否能打断回合推进
  - 事件监听器是否正常工作
  - 事件信息是否正确传递
  - `round_interrupted` 事件是否正确触发

### 5. 监室转移测试

- **测试内容**: 测试监室转移机制
- **验证点**:
  - 监室转移条件是否满足
  - 转移事件是否正确触发
  - 监室类型是否正确更新
  - NPC 是否在转移后重新生成

## 测试结果解读

### 输出格式

每个测试都会显示：
- ✅ 成功标记
- ❌ 失败标记
- 详细的测试信息（如加载的世界书数量、事件信息等）

### 结果汇总

测试结束后会显示：
- 每个测试的通过/总数
- 总体通过率
- 系统运行状态评估

### 结果评估

- **100% 通过**: 🎉 所有测试通过，系统运行完美
- **≥80% 通过**: ✅ 大部分测试通过，系统运行正常
- **<80% 通过**: ⚠️ 部分测试未通过，需要检查系统状态

## 常见问题

### Q: 测试脚本报错 "未找到核心系统"

**A**: 请确保：
1. 脚本已在酒馆中正确加载
2. 等待脚本完全初始化（通常需要几秒钟）
3. 尝试刷新页面后重新运行测试

### Q: 某些测试一直失败

**A**: 可能的原因：
1. 相关模块未正确加载（检查模块检测脚本）
2. 世界书文件不存在或路径不正确
3. 事件系统未正确初始化

### Q: 监室转移测试未触发

**A**: 监室转移有概率限制（20%），测试脚本会尝试多次。如果仍未触发：
1. 检查当前天数是否在 7-14 天范围内
2. 检查当前监室类型是否为 `transition`
3. 可以手动调整天数后重试

### Q: 预测性加载测试未加载世界书

**A**: 预测性加载需要：
1. 上下文包含足够的关键词匹配
2. 匹配评分超过阈值（>10）
3. 世界书尚未加载

## 注意事项

1. **测试耗时**: 完整测试可能需要 1-2 分钟
2. **系统状态**: 测试会修改系统状态（推进回合、加载世界书等），建议在测试环境运行
3. **并发问题**: 不要同时运行多个测试脚本
4. **调试日志**: 测试脚本会输出大量日志，有助于排查问题

## 故障排查

如果测试失败，请：

1. **检查模块加载**: 运行模块检测脚本，确认所有模块已加载
2. **查看控制台错误**: 检查是否有 JavaScript 错误
3. **检查世界书**: 确认世界书文件存在且格式正确
4. **检查事件系统**: 确认事件系统已正确初始化
5. **查看调试日志**: 检查 `.cursor/debug.log` 文件中的调试信息

## 支持

如遇到问题，请提供：
- 测试结果输出
- 控制台错误信息
- 模块检测结果
- 系统版本信息
