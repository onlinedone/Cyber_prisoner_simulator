# 方案2：使用酒馆助手 API 直接创建世界书 - 实施说明

## 概述

方案2通过使用酒馆助手的 `createOrReplaceWorldbook` 或 `replaceWorldbook` API，直接从 JSON 文件读取数据并创建世界书，绕过酒馆的导入功能，避免格式转换问题。

## 实施步骤

### 方法 1：使用文件选择器（推荐）

这是最简单的方法，适合在浏览器中直接执行。

#### 步骤：

1. **打开酒馆页面**
   - 在浏览器中打开您的 SillyTavern 实例

2. **打开开发者工具**
   - 按 `F12` 打开开发者工具
   - 切换到 **Console（控制台）** 标签

3. **执行脚本**
   - 打开文件：`导入到酒馆/直接创建世界书-从JSON文件.js`
   - 复制整个文件内容
   - 粘贴到控制台并按 `Enter` 执行

4. **选择 JSON 文件**
   - 会弹出一个文件选择对话框
   - 选择 `internal_basic_procedures.json` 文件
   - 点击"打开"

5. **等待完成**
   - 脚本会自动：
     - 读取 JSON 文件
     - 验证数据格式
     - 创建或替换世界书
     - 验证创建结果
   - 控制台会显示详细的执行日志

### 方法 2：从 URL 加载 JSON（适合在线部署）

如果您将 JSON 文件部署到服务器上，可以使用这个方法。

#### 代码示例：

```javascript
(async function createWorldbookFromURL() {
  try {
    // 替换为您的 JSON 文件 URL
    const jsonUrl = 'https://your-domain.com/path/to/internal_basic_procedures.json';

    // 从 URL 加载 JSON
    const response = await fetch(jsonUrl);
    const jsonData = await response.json();

    // 提取数据
    const worldbookName = jsonData.name || '生活细节库';
    const entries = jsonData.entries;

    // 创建或替换世界书
    if (getWorldbookNames().includes(worldbookName)) {
      await replaceWorldbook(worldbookName, entries, { render: 'immediate' });
      console.log(`✓ 已替换世界书 "${worldbookName}"`);
    } else {
      await createOrReplaceWorldbook(worldbookName, entries, { render: 'immediate' });
      console.log(`✓ 已创建世界书 "${worldbookName}"`);
    }

    // 验证
    const created = await getWorldbook(worldbookName);
    console.log(`✓ 验证成功: ${created.length} 个条目`);
  } catch (error) {
    console.error('✗ 失败:', error);
  }
})();
```

### 方法 3：嵌入到脚本中（适合自动化）

如果您需要在脚本中自动执行，可以将 JSON 数据直接嵌入到脚本中。

#### 参考文件：
- `导入到酒馆/直接创建世界书-生活细节库.js`（包含完整的数据）

## 注意事项

### 1. 前置条件

- ✅ **酒馆助手已安装并运行**
  - 确保 `getWorldbookNames`, `createOrReplaceWorldbook`, `replaceWorldbook`, `getWorldbook` 等 API 可用
  - 可以在控制台输入 `typeof getWorldbookNames` 检查，应该返回 `"function"`

### 2. JSON 文件格式

确保您的 JSON 文件符合以下结构：

```json
{
  "name": "生活细节库",
  "description": "...",
  "entries": [
    {
      "uid": 0,
      "name": "条目名称",
      "enabled": true,
      "strategy": { ... },
      "position": { ... },
      "content": "...",
      "probability": 100,
      "recursion": { ... },
      "effect": { ... }
    },
    ...
  ]
}
```

### 3. 世界书名称

- 脚本会使用 JSON 文件中的 `name` 字段作为世界书名称
- 如果 JSON 中没有 `name` 字段，默认使用 `"生活细节库"`
- **重要**：确保世界书名称与 `worldbook_loader.ts` 中的配置匹配：
  - `WORLDBOOKS.internal_basic_procedures.displayName = '生活细节库'`

### 4. 数据验证

脚本会自动验证：
- ✅ JSON 文件是否包含 `entries` 数组
- ✅ 条目是否包含必需字段（`uid`, `name`, `strategy`, `position`）
- ✅ 创建后的世界书是否可以正常读取

### 5. 错误处理

如果遇到错误，检查：

1. **API 不可用**
   ```
   Error: 酒馆助手 API 不可用
   ```
   - 检查酒馆助手是否正确安装
   - 刷新页面重试

2. **JSON 格式错误**
   ```
   Error: JSON 文件格式不正确
   ```
   - 检查 JSON 文件语法
   - 使用 JSON 验证工具验证格式

3. **条目格式错误**
   ```
   Error: 没有找到有效条目
   ```
   - 检查条目是否包含必需字段
   - 参考 `@types/function/worldbook.d.ts` 中的 `WorldbookEntry` 类型定义

## 验证步骤

创建完成后，执行以下命令验证：

```javascript
// 检查世界书是否存在
getWorldbookNames().includes('生活细节库')

// 获取世界书内容
const worldbook = await getWorldbook('生活细节库');
console.log('条目数量:', worldbook.length);
console.log('条目列表:', worldbook.map(e => e.name));
```

## 常见问题

### Q1: 脚本执行后没有反应？

**A:** 检查控制台是否有错误信息。确保：
- 文件选择对话框已弹出
- 已正确选择 JSON 文件
- 浏览器允许文件访问权限

### Q2: 显示"酒馆助手 API 不可用"？

**A:**
1. 检查酒馆助手是否已正确安装
2. 刷新页面重试
3. 在控制台执行 `typeof getWorldbookNames` 检查 API 是否可用

### Q3: 创建成功但加载器仍然报错？

**A:**
1. 检查世界书名称是否完全匹配（区分大小写）
2. 刷新页面，让加载器重新初始化
3. 在控制台手动执行：`window.initWorldbookLoader()`

### Q4: 条目格式验证失败？

**A:**
1. 检查每个条目是否包含以下必需字段：
   - `uid`（数字）
   - `name`（字符串）
   - `strategy`（对象）
   - `position`（对象）
   - `content`（字符串）
2. 参考 `@types/function/worldbook.d.ts` 中的类型定义

## 下一步

创建成功后：

1. **刷新页面**：让世界书加载器重新初始化
2. **检查日志**：查看控制台中的 `[知识库加载器]` 日志
3. **验证加载**：确认 `生活细节库` 出现在已加载列表中
4. **测试功能**：尝试触发相关关键词，验证条目是否正确激活

## 技术支持

如果遇到问题：

1. 检查控制台错误信息
2. 查看浏览器 Network 标签，检查 API 请求是否成功
3. 参考 `@types/function/worldbook.d.ts` 中的 API 文档
4. 检查酒馆助手的日志和文档
