# 调试 window.detentionSystem undefined 问题

## 问题描述

在浏览器控制台输入 `window.detentionSystem` 返回 `undefined`。

## 可能的原因

根据脚本助手作者的建议，问题可能是：

1. **jQuery 加载时机**：脚本在 jQuery 加载之前执行
2. **模块作用域**：ES6 模块可能有独立的作用域
3. **脚本加载顺序**：webpack 打包后的执行顺序问题

## 已实施的修复

### 1. 双重创建机制

```typescript
// 在脚本加载时立即创建
if (!window.detentionSystem) {
  window.detentionSystem = bootstrapDetentionSystem();
  console.info('[核心系统] 核心系统对象已创建（脚本加载时）');
}

// 在 jQuery ready 时再次确保创建
$(() => {
  if (!window.detentionSystem) {
    console.warn('[核心系统] 警告：在 jQuery ready 时未找到核心系统，重新创建');
    window.detentionSystem = bootstrapDetentionSystem();
    console.info('[核心系统] 核心系统对象已创建（jQuery ready 时）');
  }
  // ...
});
```

### 2. 添加详细调试日志

现在会输出：
- 脚本加载时的创建状态
- jQuery ready 时的检查状态
- 核心系统的详细信息

## 调试步骤

### 步骤 1：检查控制台日志

刷新页面后，在浏览器控制台（F12）中查找以下日志：

```
[核心系统] 开始加载...
[核心系统] 核心系统对象已创建（脚本加载时）
[核心系统] window.detentionSystem 类型: object
[核心系统] 脚本加载完成
[核心系统] 检查 window.detentionSystem: {exists: true, type: "object", value: "object"}
[核心系统] 酒馆页面已加载（jQuery ready）
[核心系统] 当前核心系统状态: {exists: true, version: "3.2.0", initialized: false}
```

### 步骤 2：检查 window.detentionSystem

在控制台输入：

```javascript
// 检查是否存在
typeof window.detentionSystem

// 应该返回 "object"，不是 "undefined"

// 检查详细信息
window.detentionSystem

// 应该返回一个对象，包含：
// - version: "3.2.0"
// - initialized: true/false
// - modules: {...}
// - events: EventEmitter
```

### 步骤 3：如果仍然是 undefined

检查以下内容：

1. **脚本是否加载**：
   ```javascript
   // 检查是否有核心系统相关的日志
   // 如果没有，说明脚本可能没有加载
   ```

2. **jQuery 是否可用**：
   ```javascript
   typeof $
   // 应该返回 "function"
   ```

3. **脚本链接是否正确**：
   - 检查脚本链接是否指向最新版本
   - 检查网络请求是否成功（Network 标签）

## 临时解决方案

如果问题仍然存在，可以尝试：

### 方案 1：延迟检查

在控制台中手动创建：

```javascript
// 等待 jQuery 加载
setTimeout(() => {
  if (!window.detentionSystem) {
    console.warn('手动创建核心系统');
    // 这里需要重新加载脚本
    location.reload();
  }
}, 2000);
```

### 方案 2：检查脚本加载

在 Network 标签中检查：
1. 脚本文件是否成功加载（状态码 200）
2. 响应内容是否是 JavaScript 代码
3. 是否有 CORS 错误

### 方案 3：使用最新提交哈希

更新脚本链接为最新版本：

```javascript
import 'https://cdn.jsdelivr.net/gh/onlinedone/Cyber_prisoner_simulator@最新提交哈希/dist/赛博坐牢模拟器增强脚本/index.js'
```

## 预期行为

修复后，应该看到：

1. ✅ 脚本加载时立即创建核心系统
2. ✅ jQuery ready 时再次检查并确保存在
3. ✅ 控制台输出详细的调试信息
4. ✅ `window.detentionSystem` 返回对象

## 如果问题仍然存在

请提供以下信息：

1. **完整的控制台日志**（从页面加载开始）
2. **Network 标签中的脚本请求**（状态码、响应内容）
3. **浏览器版本和操作系统**
4. **SillyTavern 版本**

这些信息有助于进一步诊断问题。
