# 实时监听配置指南

## 概述

当运行 `pnpm watch` 时，开发服务器会：
1. 监听文件变化并自动重新编译
2. 在端口 **6621** 启动 Socket.IO 服务器
3. 编译完成后自动发送更新事件

## 配置步骤

### 1. 确认开发服务器运行状态

运行 `pnpm watch` 后，你应该在终端看到：

```
[tavern_helper] 已启动酒馆监听服务
```

如果看到这行消息，说明 Socket.IO 服务器已成功启动。

### 2. 在酒馆中使用本地文件路径

由于你的酒馆部署在本地（`http://127.0.0.1:8000/`），需要将脚本路径改为本地文件路径。

#### 方法 1：使用 file:// 协议（推荐用于本地开发）

在酒馆助手的脚本导入中，使用本地文件路径：

```javascript
// 注意：路径需要使用绝对路径或相对于项目根目录的路径
import 'file:///C:/Users/38331/Downloads/tavern_helper_template-main/dist/赛博坐牢模拟器增强脚本/脚本/index.js'
```

或者使用相对路径（需要在酒馆中配置）：

```javascript
// 需要在酒馆助手中配置本地文件路径映射
import './dist/赛博坐牢模拟器增强脚本/脚本/index.js'
```

#### 方法 2：配置本地 HTTP 服务器（推荐）

为了支持 Socket.IO 实时更新，建议使用本地 HTTP 服务器来提供文件：

**使用 Python 启动简单 HTTP 服务器：**

```bash
# 在项目根目录（tavern_helper_template-main）运行
# Python 3
python -m http.server 8080

# 或者 Python 2
python -m SimpleHTTPServer 8080
```

然后在酒馆中使用：

```javascript
import 'http://127.0.0.1:8080/dist/赛博坐牢模拟器增强脚本/脚本/index.js'
```

**使用 Node.js http-server：**

```bash
# 安装（如果还没安装）
npm install -g http-server

# 在项目根目录运行
http-server -p 8080 -c-1
```

### 3. 在酒馆助手中启用实时更新

酒馆助手（Tavern Helper）应该内置了 Socket.IO 客户端功能。确保：

1. **酒馆助手插件已安装并启用**
2. **在酒馆助手设置中启用"实时更新"功能**

如果酒馆助手支持，它会自动连接到 `http://127.0.0.1:6621` 的 Socket.IO 服务器。

### 4. 验证连接

#### 检查 Socket.IO 服务器连接

打开浏览器开发者工具（F12），在控制台中检查：

```javascript
// 检查 Socket.IO 连接状态
// 如果酒馆助手已连接，你应该在开发服务器终端看到：
// [tavern_helper] 成功连接到酒馆网页 'socket_id', 初始化推送...
```

#### 检查编译输出

修改任意源文件（如 `src/赛博坐牢模拟器增强脚本/脚本/core.ts`），保存后：

1. **开发服务器终端**应该显示：
   ```
   [tavern_helper] 检测到完成编译, 推送更新事件...
   ```

2. **浏览器控制台**（如果连接成功）应该看到脚本自动重新加载

### 5. 如果实时更新不工作

#### 方案 A：手动刷新页面

如果 Socket.IO 连接有问题，可以手动刷新酒馆页面来加载最新编译的文件。

#### 方案 B：检查端口和防火墙

确保：
- 端口 6621 没有被其他程序占用
- 防火墙允许本地回环连接（localhost/127.0.0.1）

#### 方案 C：查看开发服务器日志

在运行 `pnpm watch` 的终端中，查看是否有连接日志：

```
[tavern_helper] 成功连接到酒馆网页 'xxx', 初始化推送...
```

如果没有看到连接日志，说明酒馆网页还没有连接到 Socket.IO 服务器。

## 完整工作流程

1. **启动开发服务器**
   ```bash
   pnpm watch
   ```
   
   确认看到：`[tavern_helper] 已启动酒馆监听服务`

2. **启动本地 HTTP 服务器**（如果使用方法 2）
   ```bash
   python -m http.server 8080
   ```

3. **在酒馆中配置脚本路径**
   - 使用 `http://127.0.0.1:8080/dist/...` 或本地文件路径

4. **修改源代码**
   - 编辑 `src/` 目录下的文件
   - 保存文件

5. **自动更新**
   - webpack 自动编译
   - Socket.IO 服务器发送更新事件
   - 酒馆自动刷新脚本（如果连接正常）

## 故障排查

### 问题：Socket.IO 服务器没有启动

**解决：** 确认 `pnpm watch` 正在运行，且没有报错。

### 问题：酒馆无法加载本地文件

**解决：**
- 使用 HTTP 服务器而不是 file:// 协议
- 检查文件路径是否正确
- 确认 dist 目录中已有编译后的文件

### 问题：修改后没有自动更新

**解决：**
1. 检查开发服务器是否检测到文件变化
2. 检查编译是否成功完成
3. 检查 Socket.IO 连接是否建立
4. 手动刷新浏览器页面

## 注意事项

1. **文件路径**：确保使用正确的文件路径，区分 Windows 和 Unix 路径格式
2. **端口冲突**：如果 6621 或 8080 端口被占用，可以修改配置
3. **缓存问题**：浏览器可能缓存旧文件，可以在开发者工具中禁用缓存或使用硬刷新（Ctrl+Shift+R）
4. **跨域问题**：如果使用 HTTP 服务器，确保 CORS 设置正确（Socket.IO 服务器已配置 CORS 允许所有来源）
