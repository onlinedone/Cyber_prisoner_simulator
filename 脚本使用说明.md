# 转换脚本使用说明

## 使用方法

### 方法 1: 命令行参数（推荐）

```bash
# 提供输入和输出文件
python convert_character_book.py input.json output.json

# 只提供输入文件，输出文件会自动生成（添加 converted_ 前缀）
python convert_character_book.py input.json
```

### 方法 2: 直接双击运行（Windows）

1. 双击 `convert_character_book.py` 文件
2. 按提示输入文件路径
3. 转换完成后按回车键退出

## 功能特点

✅ **自动生成输出文件名**: 如果只提供输入文件，会自动生成输出文件名（添加 `converted_` 前缀）

✅ **保留所有字段**: 保留 `extensions` 和其他顶层字段

✅ **格式验证**: 确保输出符合 Tavern 1.15.0 标准格式

✅ **错误处理**: 提供详细的错误信息

✅ **Windows 友好**: 在 Windows 上双击运行时，窗口不会立即关闭

## 示例

```bash
# 转换角色卡文件
python convert_character_book.py character_card.json converted_character_card.json

# 自动生成输出文件名
python convert_character_book.py character_card.json
# 输出: converted_character_card.json
```

## 转换内容

脚本会自动转换：

- ✅ `constant` → `strategy.type`
- ✅ `keys` → `strategy.keys`
- ✅ `position` (字符串) → `position` (对象)
- ✅ `insertion_order` → `position.order`
- ✅ `priority` → `probability`
- ✅ 自动生成 `uid`
- ✅ 添加 `strategy.keys_secondary`
- ✅ 添加 `recursion` 和 `effect` 对象

## 注意事项

⚠️ **重要**: 
- 转换前请**务必备份**原始文件
- 确保输入文件是有效的 JSON 格式
- 确保输入文件包含 `character_book` 字段

## 问题排查

### 问题: 转换了0个条目

**可能原因**:
1. 输入文件中没有 `character_book` 字段
2. `character_book.entries` 数组为空
3. `character_book.entries` 不是数组类型

**解决方法**:
1. 检查输入文件是否包含 `character_book` 字段
2. 检查 `character_book.entries` 是否存在且不为空
3. 查看脚本输出的诊断信息，了解文件结构

**示例错误信息**:
```
错误: 'entries' 数组为空
  请确保角色书包含至少一个条目
```

### 问题: 找不到 character_book 字段

**错误信息**:
```
错误: 输入文件中没有找到 'character_book' 字段
  顶层键: ['name', 'description']
  请确保输入文件是角色卡 JSON 格式，包含 'character_book' 字段
```

**解决方法**:
- 确保输入文件是完整的角色卡 JSON 文件
- 检查 JSON 结构，确保顶层包含 `character_book` 对象

### 问题: 运行后没有反应

**可能原因**:
1. 没有传递参数，且不是交互式环境
2. 文件路径错误
3. JSON 格式错误

**解决方法**:
1. 使用命令行参数: `python convert_character_book.py input.json output.json`
2. 检查文件路径是否正确
3. 检查 JSON 文件格式是否正确

### 问题: 找不到文件

**解决方法**:
- 使用完整路径: `python convert_character_book.py "C:\path\to\file.json" output.json`
- 或先切换到文件所在目录

### 问题: JSON 解析失败

**解决方法**:
- 使用 JSON 验证工具检查文件格式
- 确保文件是有效的 JSON 格式
- 检查文件编码是否为 UTF-8

## 输出示例

转换成功后，会显示：

```
============================================================
转换完成！
============================================================
  - 转换了 12 个条目
  - 输出文件: converted_character_card.json
============================================================
```
